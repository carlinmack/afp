<div id="Auxiliary">
<div class="head">
<h1>Theory Auxiliary</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Auxiliary Lemmas›</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Auxiliary
  <span class="keyword2"><span class="keyword">imports</span></span>
    <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Multiset.html">HOL-Library.Multiset</a>"</span>
    <span class="quoted">"<a href="../../nested_multisets_ordinals/theories/#Signed_Multiset">Nested_Multisets_Ordinals.Signed_Multiset</a>"</span>
    <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Linear_Temporal_Logic_on_Streams.html">HOL-Library.Linear_Temporal_Logic_on_Streams</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹General›</span></span>

<span class="keyword1" id="Auxiliary-sum_list_hd_tl"><span class="command">lemma</span></span> sum_list_hd_tl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">xs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">_</span> <span class="main">::</span> group_add<span class="main">)</span> list"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> sum_list <span class="main">(</span>tl <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">-</span> hd <span class="free">xs</span><span class="main">)</span> <span class="main">+</span> sum_list <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Auxiliary-finite_distinct_bounded"><span class="command">lemma</span></span> finite_distinct_bounded<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span> <span class="main">⟹</span> finite <span class="main">{</span><span class="bound">xs</span><span class="main">.</span> distinct <span class="bound">xs</span> <span class="main">∧</span> set <span class="bound">xs</span> <span class="main">⊆</span> <span class="free">A</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">⋃</span></span><span class="bound"><span class="bound">n</span></span> <span class="main"><span class="main">∈</span></span> <span class="main"><span class="main">{</span></span><span class="main"><span class="main">0</span></span> <span class="main"><span class="main">..</span></span> card <span class="free"><span class="free">A</span></span><span class="main"><span class="main">}</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">{</span></span><span class="bound"><span class="bound">xs</span></span><span class="main"><span class="main">.</span></span>  length <span class="bound"><span class="bound">xs</span></span> <span class="main"><span class="main">=</span></span> <span class="bound"><span class="bound">n</span></span> <span class="main"><span class="main">∧</span></span> distinct <span class="bound"><span class="bound">xs</span></span> <span class="main"><span class="main">∧</span></span> set <span class="bound"><span class="bound">xs</span></span> <span class="main"><span class="main">⊆</span></span> <span class="free"><span class="free">A</span></span><span class="main"><span class="main">}</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span> <span class="main">(</span><span class="operator">metis</span> card_mono distinct_card<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Sums›</span></span>

<span class="keyword1" id="Auxiliary-Sum_eq_pick_changed_elem"><span class="command">lemma</span></span> Sum_eq_pick_changed_elem<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">M</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">∈</span> <span class="free">M</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">m</span> <span class="main">=</span> <span class="free">g</span> <span class="free">m</span> <span class="main">+</span> <span class="free">Δ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">≠</span> <span class="free">m</span> <span class="main">∧</span> <span class="bound">n</span> <span class="main">∈</span> <span class="free">M</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">n</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">M</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">M</span><span class="main">.</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="main">+</span> <span class="free">Δ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">M</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> empty
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">=</span><span class="skolem">m</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> insert <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="free">f</span> <span class="skolem">F</span> <span class="main">=</span> sum <span class="free">g</span> <span class="skolem">F</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">with</span></span> insert True <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add.commute add.left_commute<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> insert <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add.assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Auxiliary-sum_pos_ex_elem_pos"><span class="command">lemma</span></span> sum_pos_ex_elem_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">0</span><span class="main">::</span>int<span class="main">)</span> <span class="main">&lt;</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">∈</span><span class="free">M</span><span class="main">.</span> <span class="free">f</span> <span class="bound">m</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">m</span><span class="main">∈</span><span class="free">M</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="bound">m</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> not_le sum_nonpos<span class="main">)</span>

<span class="keyword1" id="Auxiliary-sum_if_distrib_add"><span class="command">lemma</span></span> sum_if_distrib_add<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">a</span><span class="main">=</span><span class="free">b</span> <span class="keyword1">then</span> <span class="free">X</span> <span class="free">b</span> <span class="main">+</span> <span class="free">Y</span> <span class="bound">a</span> <span class="keyword1">else</span> <span class="free">X</span> <span class="bound">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="free">X</span> <span class="bound">a</span><span class="main">)</span> <span class="main">+</span> <span class="free">Y</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Sum_eq_pick_changed_elem<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Partial Orders›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> order<span class="main">)</span> order_finite_set_exists_foundation<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>   <span class="free">t</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">M</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s</span><span class="main">∈</span><span class="free">M</span><span class="main">.</span> <span class="bound">s</span> <span class="main">≤</span> <span class="free">t</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">u</span><span class="main">∈</span><span class="free">M</span><span class="main">.</span> <span class="main">¬</span> <span class="bound">u</span> <span class="main">&lt;</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dual_order.strict_iff_order finite_has_minimal2<span class="main">)</span>

<span class="keyword1" id="Auxiliary-order_finite_set_obtain_foundation"><span class="command">lemma</span></span> order_finite_set_obtain_foundation<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>   <span class="free">t</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">::</span> order"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">M</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">s</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="free">M</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≤</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">u</span><span class="main">∈</span><span class="free">M</span><span class="main">.</span> <span class="main">¬</span> <span class="bound">u</span> <span class="main">&lt;</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms order_finite_set_exists_foundation <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Multisets›</span></span>

<span class="keyword1" id="Auxiliary-finite_nonzero_count"><span class="command">lemma</span></span> finite_nonzero_count<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">t</span><span class="main">.</span> count <span class="free">M</span> <span class="bound">t</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> count <span class="keyword1"><span class="command">unfolding</span></span> multiset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Auxiliary-finite_count"><span class="command">lemma</span></span> finite_count<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">t</span><span class="main">.</span> count <span class="free">M</span> <span class="bound">t</span> <span class="main">&gt;</span> <span class="free">i</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ finite_nonzero_count<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">M</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> set_mset_def<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Signed Multisets›</span></span>

<span class="keyword1" id="Auxiliary-zcount_zmset_of_nonneg"><span class="command">lemma</span></span> zcount_zmset_of_nonneg<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> zcount <span class="main">(</span>zmset_of <span class="free">M</span><span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Auxiliary-finite_zcount_pos"><span class="command">lemma</span></span> finite_zcount_pos<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">t</span><span class="main">.</span> zcount <span class="free">M</span> <span class="bound">t</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> M
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ finite_Un<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">THEN</span> iffD2<span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">OF</span> conjI<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> finite_nonzero_count finite_nonzero_count<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"fst <span class="skolem"><span class="skolem">M</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"snd <span class="skolem"><span class="skolem">M</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> set_mset_def fst_conv snd_conv <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Auxiliary-finite_zcount_neg"><span class="command">lemma</span></span> finite_zcount_neg<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">t</span><span class="main">.</span> zcount <span class="free">M</span> <span class="bound">t</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> M
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ finite_Un<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">THEN</span> iffD2<span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">OF</span> conjI<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> finite_nonzero_count finite_nonzero_count<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"fst <span class="skolem"><span class="skolem">M</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"snd <span class="skolem"><span class="skolem">M</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> set_mset_def fst_conv snd_conv <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Auxiliary-pos_zcount_in_zmset"><span class="command">lemma</span></span> pos_zcount_in_zmset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">x</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zcount_inI<span class="main">)</span>

<span class="keyword1" id="Auxiliary-zmset_elem_nonneg"><span class="command">lemma</span></span> zmset_elem_nonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">M</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">M</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">≤</span> zcount <span class="free">M</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> order.order_iff_strict zcount_eq_zero_iff<span class="main">)</span>

<span class="keyword1" id="Auxiliary-zero_le_sum_single"><span class="command">lemma</span></span> zero_le_sum_single<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> zcount <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">M</span><span class="main">.</span> <span class="main">{#</span><span class="free">f</span> <span class="bound">x</span><span class="keyword1">#}<span class="hidden">⇩</span><sub>z</sub></span><span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">M</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> infinite_finite_induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Auxiliary-mem_zmset_of"><span class="command">lemma</span></span> mem_zmset_of<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> zmset_of <span class="free">M</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">∈#</span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_zmset_def<span class="main">)</span>

<span class="keyword1" id="Auxiliary-mset_neg_minus"><span class="command">lemma</span></span> mset_neg_minus<span class="main">:</span> <span class="quoted"><span class="quoted">"mset_neg <span class="main">(</span>abs_zmultiset <span class="main">(</span><span class="free">Mp</span><span class="main">,</span><span class="free">Mn</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">Mn</span><span class="main">-</span><span class="free">Mp</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mset_neg.abs_eq<span class="main">)</span>

<span class="keyword1" id="Auxiliary-mset_pos_minus"><span class="command">lemma</span></span> mset_pos_minus<span class="main">:</span> <span class="quoted"><span class="quoted">"mset_pos <span class="main">(</span>abs_zmultiset <span class="main">(</span><span class="free">Mp</span><span class="main">,</span><span class="free">Mn</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">Mp</span><span class="main">-</span><span class="free">Mn</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mset_pos.abs_eq<span class="main">)</span>

<span class="keyword1" id="Auxiliary-mset_neg_sum_set"><span class="command">lemma</span></span> mset_neg_sum_set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">m</span><span class="main">.</span> <span class="bound">m</span> <span class="main">∈</span> <span class="free">M</span> <span class="main">⟹</span> mset_neg <span class="main">(</span><span class="free">f</span> <span class="bound">m</span><span class="main">)</span> <span class="main">=</span> <span class="main">{#}</span><span class="main">)</span> <span class="main">⟹</span> mset_neg <span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">∈</span><span class="free">M</span><span class="main">.</span> <span class="free">f</span> <span class="bound">m</span><span class="main">)</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">M</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> infinite_finite_induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Auxiliary-mset_neg_empty_iff"><span class="command">lemma</span></span> mset_neg_empty_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"mset_neg <span class="free">M</span> <span class="main">=</span> <span class="main">{#}</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> zcount <span class="free">M</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.commute add.right_neutral mset_pos_as_neg zcount_zmset_of_nonneg zmset_of_empty<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> zmultiset.abs_induct<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> y
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">y</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> mset_neg_minus<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Diff_eq_empty_iff_mset mset_subset_eqI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Auxiliary-mset_neg_zcount_nonneg"><span class="command">lemma</span></span> mset_neg_zcount_nonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"mset_neg <span class="free">M</span> <span class="main">=</span> <span class="main">{#}</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">≤</span> zcount <span class="free">M</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> mset_neg_empty_iff<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1" id="Auxiliary-in_zmset_conv_pos_neg_disj"><span class="command">lemma</span></span> in_zmset_conv_pos_neg_disj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">M</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">∈#</span> mset_pos <span class="free">M</span> <span class="main">∨</span> <span class="free">x</span> <span class="main">∈#</span> mset_neg <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> count_mset_pos in_diff_zcount mem_zmset_of mset_pos_neg_partition nat_code<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> not_in_iff zcount_ne_zero_iff<span class="main">)</span>

<span class="keyword1" id="Auxiliary-in_zmset_notin_mset_pos"><span class="command">lemma</span></span> in_zmset_notin_mset_pos<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">M</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∉#</span> mset_pos <span class="free">M</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈#</span> mset_neg <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_zmset_conv_pos_neg_disj<span class="main">)</span>

<span class="keyword1" id="Auxiliary-in_zmset_notin_mset_neg"><span class="command">lemma</span></span> in_zmset_notin_mset_neg<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">M</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∉#</span> mset_neg <span class="free">M</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈#</span> mset_pos <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_zmset_conv_pos_neg_disj<span class="main">)</span>

<span class="keyword1" id="Auxiliary-in_mset_pos_in_zmset"><span class="command">lemma</span></span> in_mset_pos_in_zmset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈#</span> mset_pos <span class="free">M</span> <span class="main">⟹</span> <span class="free">x</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> iffD2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> in_zmset_conv_pos_neg_disj<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Auxiliary-in_mset_neg_in_zmset"><span class="command">lemma</span></span> in_mset_neg_in_zmset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈#</span> mset_neg <span class="free">M</span> <span class="main">⟹</span> <span class="free">x</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> iffD2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> in_zmset_conv_pos_neg_disj<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Auxiliary-set_zmset_eq_set_mset_union"><span class="command">lemma</span></span> set_zmset_eq_set_mset_union<span class="main">:</span> <span class="quoted"><span class="quoted">"set_zmset <span class="free">M</span> <span class="main">=</span> set_mset <span class="main">(</span>mset_pos <span class="free">M</span><span class="main">)</span> <span class="main">∪</span> set_mset <span class="main">(</span>mset_neg <span class="free">M</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> in_mset_pos_in_zmset in_mset_neg_in_zmset<span class="main">)</span>

<span class="keyword1" id="Auxiliary-member_mset_pos_iff_zcount"><span class="command">lemma</span></span> member_mset_pos_iff_zcount<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈#</span> mset_pos <span class="free">M</span> <span class="main">⟷</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> not_in_iff pos_zcount_in_zmset <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Auxiliary-member_mset_neg_iff_zcount"><span class="command">lemma</span></span> member_mset_neg_iff_zcount<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈#</span> mset_neg <span class="free">M</span> <span class="main">⟷</span> zcount <span class="free">M</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> member_mset_pos_iff_zcount mset_pos_uminus neg_le_0_iff_le not_le zcount_uminus<span class="main">)</span>

<span class="keyword1" id="Auxiliary-mset_pos_mset_neg_disjoint"><span class="command">lemma</span></span> mset_pos_mset_neg_disjoint<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"set_mset <span class="main">(</span>mset_pos <span class="free">Δ</span><span class="main">)</span> <span class="main">∩</span> set_mset <span class="main">(</span>mset_neg <span class="free">Δ</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> member_mset_pos_iff_zcount member_mset_neg_iff_zcount<span class="main">)</span>

<span class="keyword1" id="Auxiliary-zcount_sum"><span class="command">lemma</span></span> zcount_sum<span class="main">:</span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span><span class="main">∑</span><span class="bound">M</span><span class="main">∈</span><span class="free">MM</span><span class="main">.</span> <span class="free">f</span> <span class="bound">M</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">M</span><span class="main">∈</span><span class="free">MM</span><span class="main">.</span> zcount <span class="main">(</span><span class="free">f</span> <span class="bound">M</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">MM</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> infinite_finite_induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Auxiliary-zcount_filter_invariant"><span class="command">lemma</span></span> zcount_filter_invariant<span class="main">:</span> <span class="quoted"><span class="quoted">"zcount <span class="main">{#</span> <span class="bound">t'</span><span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span><span class="free">M</span><span class="main">.</span> <span class="bound">t'</span><span class="main">=</span><span class="free">t</span> <span class="main">#}</span> <span class="free">t</span> <span class="main">=</span> zcount <span class="free">M</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Auxiliary-in_filter_zmset_in_zmset"><span class="command">lemma</span></span> in_filter_zmset_in_zmset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> filter_zmset <span class="free">P</span> <span class="free">M</span> <span class="main">⟹</span> <span class="free">x</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> count_filter_zmset zcount_ne_zero_iff<span class="main">)</span>

<span class="keyword1" id="Auxiliary-pos_filter_zmset_pos_zmset"><span class="command">lemma</span></span> pos_filter_zmset_pos_zmset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>filter_zmset <span class="free">P</span> <span class="free">M</span><span class="main">)</span> <span class="free">x</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> count_filter_zmset less_irrefl<span class="main">)</span>

<span class="keyword1" id="Auxiliary-neg_filter_zmset_neg_zmset"><span class="command">lemma</span></span> neg_filter_zmset_neg_zmset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&gt;</span> zcount <span class="main">(</span>filter_zmset <span class="free">P</span> <span class="free">M</span><span class="main">)</span> <span class="free">x</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&gt;</span> zcount <span class="free">M</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> count_filter_zmset less_irrefl<span class="main">)</span>


<span class="keyword1"><span class="command">lift_definition</span></span> update_zmultiset <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'t</span> zmultiset <span class="main">⇒</span> <span class="tfree">'t</span> <span class="main">⇒</span> int <span class="main">⇒</span> <span class="tfree">'t</span> zmultiset"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span><span class="bound">B</span><span class="main">)</span> <span class="bound">T</span> <span class="bound">D</span><span class="main">.</span><span class="main">(</span><span class="keyword1">if</span> <span class="bound">D</span><span class="main">&gt;</span><span class="main">0</span> <span class="keyword1">then</span> <span class="main">(</span><span class="bound">A</span> <span class="main">+</span> replicate_mset <span class="main">(</span>nat <span class="bound">D</span><span class="main">)</span> <span class="bound">T</span><span class="main">,</span> <span class="bound">B</span><span class="main">)</span>
                    <span class="keyword1">else</span> <span class="main">(</span><span class="bound">A</span><span class="main">,</span><span class="bound">B</span> <span class="main">+</span> replicate_mset <span class="main">(</span>nat <span class="main">(</span><span class="main">-</span><span class="bound">D</span><span class="main">)</span><span class="main">)</span> <span class="bound">T</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> equiv_zmset_def if_split<span class="main">)</span>

<span class="keyword1" id="Auxiliary-zcount_update_zmultiset"><span class="command">lemma</span></span> zcount_update_zmultiset<span class="main">:</span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>update_zmultiset <span class="free">M</span> <span class="free">t</span> <span class="free">n</span><span class="main">)</span> <span class="free">t'</span> <span class="main">=</span> zcount <span class="free">M</span> <span class="free">t'</span> <span class="main">+</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">t</span> <span class="main">=</span> <span class="free">t'</span> <span class="keyword1">then</span> <span class="free">n</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> order<span class="main">)</span> order_zmset_exists_foundation<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>   <span class="free">t</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">≤</span> <span class="free">t</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="bound">s</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">u</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="bound">u</span> <span class="main">⟶</span> <span class="main">¬</span> <span class="bound">u</span> <span class="main">&lt;</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="bound">t</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> <span class="var">?M</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s</span><span class="main">∈</span><span class="var">?M</span><span class="main">.</span> <span class="bound">s</span> <span class="main">≤</span> <span class="free">t</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">u</span><span class="main">∈</span><span class="var">?M</span><span class="main">.</span> <span class="main">¬</span> <span class="bound">u</span> <span class="main">&lt;</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">drule</span> order_finite_set_exists_foundation<span class="main"><span class="main">[</span></span><span class="operator">rotated</span> 1<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> order<span class="main">)</span> order_zmset_exists_foundation'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>   <span class="free">t</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">≤</span> <span class="free">t</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="bound">s</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">u</span></span><span class="main">&lt;</span><span class="bound">s</span><span class="main">.</span> zcount <span class="free">M</span> <span class="bound">u</span> <span class="main">≤</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms order_zmset_exists_foundation
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> le_less_linear<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> order<span class="main">)</span> order_zmset_exists_foundation_neg<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>   <span class="free">t</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"zcount <span class="free">M</span> <span class="free">t</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">≤</span> <span class="free">t</span> <span class="main">∧</span> zcount <span class="free">M</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">u</span><span class="main">.</span> zcount <span class="free">M</span> <span class="bound">u</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">⟶</span> <span class="main">¬</span> <span class="bound">u</span> <span class="main">&lt;</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">t</span><span class="main">.</span> zcount <span class="free">M</span> <span class="bound">t</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> <span class="var">?M</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s</span><span class="main">∈</span><span class="var">?M</span><span class="main">.</span> <span class="bound">s</span> <span class="main">≤</span> <span class="free">t</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">u</span><span class="main">∈</span><span class="var">?M</span><span class="main">.</span> <span class="main">¬</span> <span class="bound">u</span> <span class="main">&lt;</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">drule</span> order_finite_set_exists_foundation<span class="main"><span class="main">[</span></span><span class="operator">rotated</span> 1<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> order<span class="main">)</span> order_zmset_exists_foundation_neg'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>   <span class="free">t</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"zcount <span class="free">M</span> <span class="free">t</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">≤</span> <span class="free">t</span> <span class="main">∧</span> zcount <span class="free">M</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">u</span></span><span class="main">&lt;</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> zcount <span class="free">M</span> <span class="bound">u</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms order_zmset_exists_foundation_neg
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> le_less_linear<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> order<span class="main">)</span> elem_order_zmset_exists_foundation<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s</span><span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span><span class="free">M</span><span class="main">.</span> <span class="bound">s</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">u</span><span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span><span class="free">M</span><span class="main">.</span> <span class="main">¬</span> <span class="bound">u</span> <span class="main">&lt;</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> order_finite_set_exists_foundation<span class="main"><span class="main">[</span></span><span class="operator">OF</span> finite_set_zmset<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Image of a Signed Multiset›</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> image_zmset <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> zmultiset <span class="main">⇒</span> <span class="tfree">'b</span> zmultiset"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">f</span> <span class="main">(</span><span class="bound">M</span><span class="main">,</span> <span class="bound">N</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>image_mset <span class="bound">f</span> <span class="bound">M</span><span class="main">,</span> image_mset <span class="bound">f</span> <span class="bound">N</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> equiv_zmset_def <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> image_mset_union<span class="main">)</span>

<span class="keyword1"><span class="command">syntax</span></span> <span class="main">(</span>ASCII<span class="main">)</span>
  <span class="quoted">"_comprehension_zmset"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span> zmultiset <span class="main">⇒</span> <span class="tfree">'a</span> zmultiset"</span></span>  <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span><span class="keyword1">{#</span>_<span class="keyword3">/</span><span class="keyword1">.</span> _ <span class="keyword1">:#z</span> _<span class="keyword1">#}</span><span class="keyword3">)</span>"</span><span class="main">)</span>
<span class="keyword1"><span class="command">syntax</span></span>
  <span class="quoted">"_comprehension_zmset"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span> zmultiset <span class="main">⇒</span> <span class="tfree">'a</span> zmultiset"</span></span>  <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span><span class="keyword1">{#</span>_<span class="keyword3">/</span><span class="keyword1">.</span> _ <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> _<span class="keyword1">#}</span><span class="keyword3">)</span>"</span><span class="main">)</span>
<span class="keyword1"><span class="command">translations</span></span>
  <span class="quoted">"<span class="main">{#</span><span class="free">e</span><span class="main">.</span> <span class="free">x</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">M</span><span class="main">#}</span>"</span> <span class="main">⇌</span> <span class="quoted">"<span class="keyword1">CONST</span> image_zmset <span class="main">(</span><span class="main">λ</span><span class="free">x</span><span class="main">.</span> <span class="free">e</span><span class="main">)</span> <span class="free">M</span>"</span>

<span class="keyword1" id="Auxiliary-image_zmset_empty"><span class="command">lemma</span></span> image_zmset_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"image_zmset <span class="free">f</span> <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span> <span class="main">=</span> <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> equiv_zmset_def<span class="main">)</span>

<span class="keyword1" id="Auxiliary-image_zmset_single"><span class="command">lemma</span></span> image_zmset_single<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"image_zmset <span class="free">f</span> <span class="main">{#</span><span class="free">x</span><span class="keyword1">#}<span class="hidden">⇩</span><sub>z</sub></span> <span class="main">=</span> <span class="main">{#</span><span class="free">f</span> <span class="free">x</span><span class="keyword1">#}<span class="hidden">⇩</span><sub>z</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> equiv_zmset_def<span class="main">)</span>

<span class="keyword1" id="Auxiliary-image_zmset_union"><span class="command">lemma</span></span> image_zmset_union<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"image_zmset <span class="free">f</span> <span class="main">(</span><span class="free">M</span> <span class="main">+</span> <span class="free">N</span><span class="main">)</span> <span class="main">=</span> image_zmset <span class="free">f</span> <span class="free">M</span> <span class="main">+</span> image_zmset <span class="free">f</span> <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> equiv_zmset_def<span class="main">)</span>

<span class="keyword1" id="Auxiliary-image_zmset_Diff"><span class="command">lemma</span></span> image_zmset_Diff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"image_zmset <span class="free">f</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> image_zmset <span class="free">f</span> <span class="free">A</span> <span class="main">-</span> image_zmset <span class="free">f</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"image_zmset <span class="free">f</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">B</span> <span class="main">+</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> image_zmset <span class="free">f</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">B</span><span class="main">)</span> <span class="main">+</span> image_zmset <span class="free">f</span> <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> image_zmset_union <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Auxiliary-mset_neg_image_zmset"><span class="command">lemma</span></span> mset_neg_image_zmset<span class="main">:</span> <span class="quoted"><span class="quoted">"mset_neg <span class="free">M</span> <span class="main">=</span> <span class="main">{#}</span> <span class="main">⟹</span> mset_neg <span class="main">(</span>image_zmset <span class="free">f</span> <span class="free">M</span><span class="main">)</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> multiset_eq_iff count_empty
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_mset_subseteq_mono mset_subset_eqI mset_subset_eq_count<span class="main">)</span>

<span class="keyword1" id="Auxiliary-nonneg_zcount_image_zmset"><span class="command">lemma</span></span> nonneg_zcount_image_zmset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> zcount <span class="free">M</span> <span class="bound">t</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">≤</span> zcount <span class="main">(</span>image_zmset <span class="free">f</span> <span class="free">M</span><span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> mset_neg_empty_iff mset_neg_image_zmset<span class="main">)</span>

<span class="keyword1" id="Auxiliary-image_zmset_add_zmset"><span class="command">lemma</span></span> image_zmset_add_zmset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"image_zmset <span class="free">f</span> <span class="main">(</span>add_zmset <span class="free">t</span> <span class="free">M</span><span class="main">)</span> <span class="main">=</span> add_zmset <span class="main">(</span><span class="free">f</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span>image_zmset <span class="free">f</span> <span class="free">M</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> equiv_zmset_def<span class="main">)</span>

<span class="keyword1" id="Auxiliary-pos_zcount_image_zmset"><span class="command">lemma</span></span> pos_zcount_image_zmset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> zcount <span class="free">M</span> <span class="bound">t</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="free">t</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>image_zmset <span class="free">f</span> <span class="free">M</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> M t f
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">M</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> Mp Mn
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> count_diff count_image_mset_ge_count image_mset_Diff less_le_trans subseteq_mset_def zero_less_diff<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Auxiliary-set_zmset_transfer"><span class="command">lemma</span></span> set_zmset_transfer<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>rel_fun <span class="main">(</span>pcr_zmultiset <span class="main">(=)</span><span class="main">)</span> <span class="main">(</span>rel_set <span class="main">(=)</span><span class="main">)</span><span class="main">)</span>
   <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">Mp</span><span class="main">,</span> <span class="bound">Mn</span><span class="main">)</span><span class="main">.</span> set_mset <span class="bound">Mp</span> <span class="main">∪</span> set_mset <span class="bound">Mn</span> <span class="main">-</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> count <span class="bound">Mp</span> <span class="bound">x</span> <span class="main">=</span> count <span class="bound">Mn</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span> set_zmset"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel_fun_def pcr_zmultiset_def cr_zmultiset_def
      rel_set_eq multiset.rel_eq set_zmset_def zcount.abs_eq count_eq_zero_iff<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
      <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> zcount_ne_zero_iff<span class="main">)</span>

<span class="keyword1" id="Auxiliary-zcount_image_zmset"><span class="command">lemma</span></span> zcount_image_zmset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>image_zmset <span class="free">f</span> <span class="free">M</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">y</span> <span class="main">∈</span> <span class="free">f</span> <span class="main">-`</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∩</span> set_zmset <span class="free">M</span><span class="main">.</span> zcount <span class="free">M</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">transfer</span> <span class="quasi_keyword">fixing</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> M
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">M</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">clarify</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> Mp Mn
      <span class="keyword1"><span class="command">unfolding</span></span> count_image_mset int_sum
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">f</span> <span class="main">-`</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∩</span> set_mset <span class="skolem">Mp</span><span class="main">.</span> int <span class="main">(</span>count <span class="skolem">Mp</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
        <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">f</span> <span class="main">-`</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∩</span> <span class="main">(</span>set_mset <span class="skolem">Mp</span> <span class="main">∪</span> set_mset <span class="skolem">Mn</span><span class="main">)</span><span class="main">.</span> int <span class="main">(</span>count <span class="skolem">Mp</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S1</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.same_carrier<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> C<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free"><span class="free">f</span></span></span> <span class="main"><span class="main"><span class="main">-`</span></span></span> <span class="main"><span class="main"><span class="main">{</span></span></span><span class="free"><span class="free"><span class="free">x</span></span></span><span class="main"><span class="main"><span class="main">}</span></span></span> <span class="main"><span class="main"><span class="main">∩</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span>set_mset <span class="skolem"><span class="skolem"><span class="skolem">Mp</span></span></span> <span class="main"><span class="main"><span class="main">∪</span></span></span> set_mset <span class="skolem"><span class="skolem"><span class="skolem">Mn</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> count_eq_zero_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">f</span> <span class="main">-`</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∩</span> set_mset <span class="skolem">Mn</span><span class="main">.</span> int <span class="main">(</span>count <span class="skolem">Mn</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
        <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">f</span> <span class="main">-`</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∩</span> <span class="main">(</span>set_mset <span class="skolem">Mp</span> <span class="main">∪</span> set_mset <span class="skolem">Mn</span><span class="main">)</span><span class="main">.</span> int <span class="main">(</span>count <span class="skolem">Mn</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S2</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.same_carrier<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> C<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free"><span class="free">f</span></span></span> <span class="main"><span class="main"><span class="main">-`</span></span></span> <span class="main"><span class="main"><span class="main">{</span></span></span><span class="free"><span class="free"><span class="free">x</span></span></span><span class="main"><span class="main"><span class="main">}</span></span></span> <span class="main"><span class="main"><span class="main">∩</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span>set_mset <span class="skolem"><span class="skolem"><span class="skolem">Mp</span></span></span> <span class="main"><span class="main"><span class="main">∪</span></span></span> set_mset <span class="skolem"><span class="skolem"><span class="skolem">Mn</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> count_eq_zero_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">f</span> <span class="main">-`</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∩</span> <span class="main">(</span>set_mset <span class="skolem">Mp</span> <span class="main">∪</span> set_mset <span class="skolem">Mn</span> <span class="main">-</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> count <span class="skolem">Mp</span> <span class="bound">x</span> <span class="main">=</span> count <span class="skolem">Mn</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span><span class="main">.</span> int <span class="main">(</span>count <span class="skolem">Mp</span> <span class="bound">x</span><span class="main">)</span> <span class="main">-</span> int <span class="main">(</span>count <span class="skolem">Mn</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>
        <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">f</span> <span class="main">-`</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∩</span> <span class="main">(</span>set_mset <span class="skolem">Mp</span> <span class="main">∪</span> set_mset <span class="skolem">Mn</span><span class="main">)</span><span class="main">.</span> int <span class="main">(</span>count <span class="skolem">Mp</span> <span class="bound">x</span><span class="main">)</span> <span class="main">-</span> int <span class="main">(</span>count <span class="skolem">Mn</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.same_carrier<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> C<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free"><span class="free">f</span></span></span> <span class="main"><span class="main"><span class="main">-`</span></span></span> <span class="main"><span class="main"><span class="main">{</span></span></span><span class="free"><span class="free"><span class="free">x</span></span></span><span class="main"><span class="main"><span class="main">}</span></span></span> <span class="main"><span class="main"><span class="main">∩</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span>set_mset <span class="skolem"><span class="skolem"><span class="skolem">Mp</span></span></span> <span class="main"><span class="main"><span class="main">∪</span></span></span> set_mset <span class="skolem"><span class="skolem"><span class="skolem">Mn</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S1</span> <span class="main">-</span> <span class="var">?S2</span> <span class="main">=</span> <span class="var">?S</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sum_subtractf<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Auxiliary-zmset_empty_image_zmset_empty"><span class="command">lemma</span></span> zmset_empty_image_zmset_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> zcount <span class="free">M</span> <span class="bound">t</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">⟹</span> zcount <span class="main">(</span>image_zmset <span class="free">f</span> <span class="free">M</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zcount_image_zmset<span class="main">)</span>

<span class="keyword1" id="Auxiliary-in_image_zmset_in_zmset"><span class="command">lemma</span></span> in_image_zmset_in_zmset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> image_zmset <span class="free">f</span> <span class="free">M</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1" id="Auxiliary-zcount_image_zmset_zero"><span class="command">lemma</span></span> zcount_image_zmset_zero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">m</span><span class="main">.</span> <span class="bound">m</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">M</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">m</span> <span class="main">≠</span> <span class="free">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">x</span> <span class="keyword1">∉#<span class="hidden">⇩</span><sub>z</sub></span> image_zmset <span class="free">f</span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> set_zmset_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zcount_image_zmset<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> Int_emptyI sum.empty vimage_singleton_eq<span class="main">)</span>

<span class="keyword1" id="Auxiliary-image_zmset_pre"><span class="command">lemma</span></span> image_zmset_pre<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> image_zmset <span class="free">f</span> <span class="free">M</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">m</span><span class="main">.</span> <span class="bound">m</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">M</span> <span class="main">∧</span> <span class="free">f</span> <span class="bound">m</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> image_zmset <span class="free">f</span> <span class="free">M</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∄</span><span class="bound">m</span><span class="main">.</span> <span class="bound">m</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">M</span> <span class="main">∧</span> <span class="free">f</span> <span class="bound">m</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">M</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="free">f</span> <span class="skolem">m</span> <span class="main">=</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">m</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>image_zmset <span class="free">f</span> <span class="free">M</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> t zcount_image_zmset_zero<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> t <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> zcount_ne_zero_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Auxiliary-pos_image_zmset_obtain_pre"><span class="command">lemma</span></span> pos_image_zmset_obtain_pre<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> zcount <span class="free">M</span> <span class="bound">t</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>image_zmset <span class="free">f</span> <span class="free">M</span><span class="main">)</span> <span class="free">t</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">m</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="bound">m</span> <span class="main">∧</span> <span class="free">f</span> <span class="bound">m</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> nonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> zcount <span class="free">M</span> <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>image_zmset <span class="free">f</span> <span class="free">M</span><span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> image_zmset <span class="free">f</span> <span class="free">M</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pos_zcount_in_zmset<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">M</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> image_zmset_pre<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> nonneg <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> zmset_elem_nonneg<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> x <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Streams›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">relates</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> stream <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">relates</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">(</span>shd <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">(</span>shd <span class="main">(</span>stl <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Auxiliary-relatesD"><span class="command">lemma</span></span> relatesD<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"relates <span class="free">P</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="main">(</span>shd <span class="main">(</span>stl <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> relates_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Auxiliary-alw_relatesD"><span class="command">lemma</span></span> alw_relatesD<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>relates <span class="free">P</span><span class="main">)</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="main">(</span>shd <span class="main">(</span>stl <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Auxiliary-relatesI"><span class="command">lemma</span></span> relatesI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="main">(</span>shd <span class="main">(</span>stl <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> relates <span class="free">P</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> relates_def<span class="main">)</span>

<span class="keyword1" id="Auxiliary-alw_holds_smap_conv_comp"><span class="command">lemma</span></span> alw_holds_smap_conv_comp<span class="main">:</span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>holds <span class="free">P</span><span class="main">)</span> <span class="main">(</span>smap <span class="free">f</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> alw <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="free">P</span> <span class="keyword1">o</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span>shd <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Auxiliary-alw_relates"><span class="command">lemma</span></span> alw_relates<span class="main">:</span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>relates <span class="free">P</span><span class="main">)</span> <span class="free">s</span> <span class="main">⟷</span> <span class="free">P</span> <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="main">(</span>shd <span class="main">(</span>stl <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> alw <span class="main">(</span>relates <span class="free">P</span><span class="main">)</span> <span class="main">(</span>stl <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> relates_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> alwD<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> relates_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Notation›</span></span>

<span class="keyword1"><span class="command">no_notation</span></span> AND  <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">aand</span>"</span> 60<span class="main">)</span>
<span class="keyword1"><span class="command">no_notation</span></span> OR   <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">or</span>"</span> 60<span class="main">)</span>
<span class="keyword1"><span class="command">no_notation</span></span> IMPL <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">imp</span>"</span> 60<span class="main">)</span>

<span class="keyword1"><span class="command">notation</span></span> AND  <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">aand</span>"</span> 70<span class="main">)</span>
<span class="keyword1"><span class="command">notation</span></span> OR   <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">or</span>"</span> 65<span class="main">)</span>
<span class="keyword1"><span class="command">notation</span></span> IMPL <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">imp</span>"</span> 60<span class="main">)</span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span></pre>
</div><div id="Exchange_Abadi">
<div class="head">
<h1>Theory Exchange_Abadi</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Clocks Protocol\label{sec:clocks}›</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Exchange_Abadi
  <span class="keyword2"><span class="keyword">imports</span></span>
    <a href="#Auxiliary">Auxiliary</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'t</span> count_vec <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'t</span> multiset"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'t</span> delta_vec <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'t</span> zmultiset"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">vacant_upto</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'t</span> delta_vec <span class="main">⇒</span> <span class="tfree">'t</span> <span class="main">::</span> order <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">vacant_upto</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟶</span> zcount <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">s</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">nonpos_upto</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'t</span> delta_vec <span class="main">⇒</span> <span class="tfree">'t</span> <span class="main">::</span> order <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nonpos_upto</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟶</span> zcount <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">s</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">supported_strong</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'t</span> delta_vec <span class="main">⇒</span> <span class="tfree">'t</span> <span class="main">::</span> order <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">supported_strong</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∧</span> zcount <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∧</span> nonpos_upto <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">s</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">supported</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'t</span> delta_vec <span class="main">⇒</span> <span class="tfree">'t</span> <span class="main">::</span> order <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">supported</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∧</span> zcount <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">upright</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'t</span> <span class="main">::</span> order delta_vec <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">upright</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">.</span> zcount <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">t</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟶</span> supported <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">t</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Exchange_Abadi-upright_alt"><span class="command">lemma</span></span> upright_alt<span class="main">:</span>  <span class="quoted"><span class="quoted">"upright <span class="free">a</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">.</span> zcount <span class="free">a</span> <span class="bound">t</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟶</span> supported_strong <span class="free">a</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> upright_def supported_def supported_strong_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span> <span class="main">(</span><span class="operator">meson</span> order.strict_trans2 order.strict_trans1 order_zmset_exists_foundation'<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">beta_upright</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'t</span> <span class="main">::</span> order delta_vec <span class="main">⇒</span> <span class="tfree">'t</span> <span class="main">::</span> order delta_vec <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">beta_upright</span> <span class="free"><span class="bound"><span class="entity">va</span></span></span> <span class="free"><span class="bound"><span class="entity">vb</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">.</span> zcount <span class="free"><span class="bound"><span class="entity">va</span></span></span> <span class="bound">t</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="bound">t</span> <span class="main">∧</span> <span class="main">(</span>zcount <span class="free"><span class="bound"><span class="entity">va</span></span></span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∨</span> zcount <span class="free"><span class="bound"><span class="entity">vb</span></span></span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Exchange_Abadi-beta_upright_alt"><span class="command">lemma</span></span> beta_upright_alt<span class="main">:</span>
  <span class="quoted"><span class="quoted">"beta_upright <span class="free">va</span> <span class="free">vb</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">.</span> zcount <span class="free">va</span> <span class="bound">t</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="bound">t</span> <span class="main">∧</span> <span class="main">(</span>zcount <span class="free">va</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∨</span> zcount <span class="free">vb</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> nonpos_upto <span class="free">va</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> beta_upright_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> order_zmset_exists_foundation<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> le_less_linear less_le_trans order.strict_trans1<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">(* count_vec: nrec, the occupancy vector
   ('p ⇒ delta_vec): temp, the local change in the occupancy vector due to ops performed at given processor
   ('p ⇒ 'p ⇒ delta_vec list): msg, queue of updates from one processor to another
   ('p ⇒ delta_vec): glob, given processors (delayed) view of the occupancy vector *)</span>
<span class="keyword1"><span class="command">record</span></span> <span class="main">(</span><span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">)</span> configuration <span class="main">=</span>
  c_records <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'t</span> delta_vec"</span></span>
  c_temp <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'p</span> <span class="main">⇒</span> <span class="tfree">'t</span> delta_vec"</span></span>
  c_msg <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'p</span> <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> <span class="tfree">'t</span> delta_vec list"</span></span>
  c_glob <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'p</span> <span class="main">⇒</span> <span class="tfree">'t</span> delta_vec"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">)</span> computation <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">)</span> configuration stream"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">init_config</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span> <span class="main">::</span> finite<span class="main">,</span> <span class="tfree">'t</span> <span class="main">::</span> order<span class="main">)</span> configuration <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">init_config</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span>
     <span class="main">(</span><span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span> c_temp <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">p</span> <span class="main">=</span> <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">p1</span> <span class="bound">p2</span><span class="main">.</span> c_msg <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">p1</span> <span class="bound">p2</span> <span class="main">=</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span> c_glob <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">p</span> <span class="main">=</span> c_records <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> zcount <span class="main">(</span>c_records <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">next_performop'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'t</span> <span class="main">::</span> order<span class="main">)</span> configuration <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">)</span> configuration <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> <span class="tfree">'t</span> count_vec <span class="main">⇒</span> <span class="tfree">'t</span> count_vec <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">next_performop'</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">let</span> <span class="bound">Δ</span> <span class="main">=</span> zmset_of <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">-</span> zmset_of <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="keyword1">in</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">.</span> int <span class="main">(</span>count <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">t</span><span class="main">)</span> <span class="main">≤</span> zcount <span class="main">(</span>c_records <span class="free"><span class="bound"><span class="entity">c0</span></span></span><span class="main">)</span> <span class="bound">t</span><span class="main">)</span>
    <span class="main">∧</span> upright <span class="bound">Δ</span>
    <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span><span class="main">⦇</span>c_records <span class="main">:=</span> c_records <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="main">+</span> <span class="bound">Δ</span><span class="main">,</span>
              c_temp <span class="main">:=</span> <span class="main">(</span>c_temp <span class="free"><span class="bound"><span class="entity">c0</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">:=</span> c_temp <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">+</span> <span class="bound">Δ</span><span class="main">)</span><span class="main">⦈</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">next_performop</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">next_performop</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∃</span><span class="bound">p</span> <span class="main">(</span><span class="bound">c</span> <span class="main">::</span> <span class="tfree">'t</span> <span class="main">::</span> order count_vec<span class="main">)</span> <span class="main">(</span><span class="bound">r</span><span class="main">::</span><span class="tfree">'t</span> count_vec<span class="main">)</span><span class="main">.</span> next_performop' <span class="main">(</span>shd <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">(</span>shd <span class="main">(</span>stl <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span> <span class="bound">p</span> <span class="bound">c</span> <span class="bound">r</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">next_sendupd'</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">next_sendupd'</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">tt</span></span></span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">let</span> <span class="bound">γ</span> <span class="main">=</span> <span class="main">{#</span><span class="bound">t</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> c_temp <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">tt</span></span></span><span class="main">#}</span> <span class="keyword1">in</span>
      <span class="bound">γ</span> <span class="main">≠</span> <span class="main">0</span>
    <span class="main">∧</span> upright <span class="main">(</span>c_temp <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">-</span> <span class="bound">γ</span><span class="main">)</span>
    <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span><span class="main">⦇</span>c_msg <span class="main">:=</span> <span class="main">(</span>c_msg <span class="free"><span class="bound"><span class="entity">c0</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">:=</span> <span class="main">λ</span><span class="bound">q</span><span class="main">.</span> c_msg <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">q</span> <span class="main">@</span> <span class="main">[</span><span class="bound">γ</span><span class="main">]</span><span class="main">)</span><span class="main">,</span>
              c_temp <span class="main">:=</span> <span class="main">(</span>c_temp <span class="free"><span class="bound"><span class="entity">c0</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">:=</span> c_temp <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">-</span> <span class="bound">γ</span><span class="main">)</span><span class="main">⦈</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">next_sendupd</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">next_sendupd</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∃</span><span class="bound">p</span> <span class="bound">tt</span><span class="main">.</span> next_sendupd' <span class="main">(</span>shd <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">(</span>shd <span class="main">(</span>stl <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span> <span class="bound">p</span> <span class="bound">tt</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">next_recvupd'</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">next_recvupd'</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span>
   <span class="main">(</span>c_msg <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">≠</span> <span class="main">[]</span>
    <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span><span class="main">⦇</span>c_msg <span class="main">:=</span> <span class="main">(</span>c_msg <span class="free"><span class="bound"><span class="entity">c0</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">:=</span> <span class="main">(</span>c_msg <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">:=</span> tl <span class="main">(</span>c_msg <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
              c_glob <span class="main">:=</span> <span class="main">(</span>c_glob <span class="free"><span class="bound"><span class="entity">c0</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">:=</span> c_glob <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">+</span> hd <span class="main">(</span>c_msg <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">next_recvupd</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">next_recvupd</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∃</span><span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> next_recvupd' <span class="main">(</span>shd <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">(</span>shd <span class="main">(</span>stl <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted">"<span class="entity">next</span>"</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">next</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span>next_performop <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∨</span> next_sendupd <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∨</span> next_recvupd <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∨</span> <span class="main">(</span>shd <span class="main">(</span>stl <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> shd <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">spec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span> <span class="main">::</span> finite<span class="main">,</span> <span class="tfree">'t</span> <span class="main">::</span> order<span class="main">)</span> computation <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">spec</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span>holds init_config <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∧</span> alw next <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">GlobVacantUpto</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">GlobVacantUpto</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> vacant_upto <span class="main">(</span>c_glob <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">NrecVacantUpto</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">NrecVacantUpto</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> vacant_upto <span class="main">(</span>c_records <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="comment1">(* This is the main safety property (safe) *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">SafeGlobVacantUptoImpliesStickyNrec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span> <span class="main">::</span> finite<span class="main">,</span> <span class="tfree">'t</span> <span class="main">::</span> order<span class="main">)</span> computation <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">SafeGlobVacantUptoImpliesStickyNrec</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">let</span> <span class="bound">c</span> <span class="main">=</span> shd <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">in</span> <span class="main">∀</span><span class="bound">t</span> <span class="bound">q</span><span class="main">.</span> GlobVacantUpto <span class="bound">c</span> <span class="bound">q</span> <span class="bound">t</span> <span class="main">⟶</span> alw <span class="main">(</span>holds <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> NrecVacantUpto <span class="bound">c</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">(* This is safe2 *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">SafeStickyNrecVacantUpto</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span> <span class="main">::</span> finite<span class="main">,</span> <span class="tfree">'t</span> <span class="main">::</span> order<span class="main">)</span> computation <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">SafeStickyNrecVacantUpto</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">let</span> <span class="bound">c</span> <span class="main">=</span> shd <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">in</span> <span class="main">∀</span><span class="bound">t</span><span class="main">.</span> NrecVacantUpto <span class="bound">c</span> <span class="bound">t</span> <span class="main">⟶</span> alw <span class="main">(</span>holds <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> NrecVacantUpto <span class="bound">c</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">(* This is inv1 *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">InvGlobVacantUptoImpliesNrec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span> <span class="main">::</span> finite<span class="main">,</span> <span class="tfree">'t</span> <span class="main">::</span> order<span class="main">)</span> configuration <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">InvGlobVacantUptoImpliesNrec</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span>
     <span class="main">(</span><span class="main">∀</span><span class="bound">t</span> <span class="bound">q</span><span class="main">.</span> vacant_upto <span class="main">(</span>c_glob <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">q</span><span class="main">)</span> <span class="bound">t</span> <span class="main">⟶</span> vacant_upto <span class="main">(</span>c_records <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="bound">t</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">InvTempUpright</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">InvTempUpright</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span> upright <span class="main">(</span>c_temp <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Exchange_Abadi-init_InvTempUpright"><span class="command">lemma</span></span> init_InvTempUpright<span class="main">:</span> <span class="quoted"><span class="quoted">"init_config <span class="free">c</span> <span class="main">⟹</span> InvTempUpright <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> InvTempUpright_def init_config_def upright_def<span class="main">)</span>

<span class="keyword1" id="Exchange_Abadi-upright_obtain_support"><span class="command">lemma</span></span> upright_obtain_support<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"upright <span class="free">a</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"zcount <span class="free">a</span> <span class="free">t</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">s</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">&lt;</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"zcount <span class="free">a</span> <span class="free">s</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"nonpos_upto <span class="free">a</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> upright_alt supported_strong_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">atomize_elim</span>
  <span class="keyword1"><span class="command">using</span></span> order.strict_implies_order <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Exchange_Abadi-upright_vec_add"><span class="command">lemma</span></span> upright_vec_add<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"upright <span class="free">v1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"upright <span class="free">v2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"upright <span class="main">(</span><span class="free">v1</span> <span class="main">+</span> <span class="free">v2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?v0</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">v1</span> <span class="main">+</span> <span class="free">v2</span>"</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span>
    <span class="keyword3"><span class="command">assume</span></span> upr1<span class="main">:</span> <span class="quoted"><span class="quoted">"upright <span class="free">v1</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> upr2<span class="main">:</span> <span class="quoted"><span class="quoted">"upright <span class="free">v2</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> zcnt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="var">?v0</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">va</span> <span class="skolem">vb</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> zmultiset"</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span>
      <span class="keyword3"><span class="command">assume</span></span> upra<span class="main">:</span> <span class="quoted"><span class="quoted">"upright <span class="skolem">va</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> uprb<span class="main">:</span> <span class="quoted"><span class="quoted">"upright <span class="skolem">vb</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> zcnt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="skolem">va</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> upra zcnt <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"zcount <span class="skolem">va</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"nonpos_upto <span class="skolem">va</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> upright_obtain_support <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">with</span></span> uprb <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supported_strong <span class="main">(</span><span class="skolem">va</span><span class="main">+</span><span class="skolem">vb</span><span class="main">)</span> <span class="skolem">t</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">≤</span> <span class="skolem">x</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="skolem">vb</span> <span class="bound">s</span>"</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> upright_alt supported_strong_def<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">meson</span> add_nonpos_neg less_imp_le order.strict_trans2 order.trans add_nonpos_nonpos<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> supported_strong_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">with</span></span> upr1 upr2 zcnt <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supported_strong <span class="var">?v0</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> supported_strong_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">v1</span> <span class="skolem">t</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">v2</span> <span class="skolem">t</span>"</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> add.commute<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> upright_alt<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Exchange_Abadi-next_InvTempUpright"><span class="command">lemma</span></span> next_InvTempUpright<span class="main">:</span> <span class="quoted"><span class="quoted">"holds InvTempUpright <span class="free">s</span> <span class="main">⟹</span> next <span class="free">s</span> <span class="main">⟹</span> nxt <span class="main">(</span>holds InvTempUpright<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> next_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> InvTempUpright_def next_performop'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def upright_vec_add<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> InvTempUpright_def next_sendupd'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def upright_vec_add<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> InvTempUpright_def next_recvupd'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> upright_vec_add<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Exchange_Abadi-alw_InvTempUpright"><span class="command">lemma</span></span> alw_InvTempUpright<span class="main">:</span> <span class="quoted"><span class="quoted">"spec <span class="free">s</span> <span class="main">⟹</span> alw <span class="main">(</span>holds InvTempUpright<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> alw_invar<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spec_def init_InvTempUpright<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> alw_iff_sdrop next_InvTempUpright spec_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">IncomingInfo</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">IncomingInfo</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> <span class="main">(</span>sum_list <span class="main">(</span>drop <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span>c_msg <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> c_temp <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">InvIncomingInfoUpright</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">InvIncomingInfoUpright</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> upright <span class="main">(</span>IncomingInfo <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">k</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Exchange_Abadi-upright_0"><span class="command">lemma</span></span> upright_0<span class="main">:</span> <span class="quoted"><span class="quoted">"upright <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> upright_def<span class="main">)</span>

<span class="keyword1" id="Exchange_Abadi-init_InvIncomingInfoUpright"><span class="command">lemma</span></span> init_InvIncomingInfoUpright<span class="main">:</span> <span class="quoted"><span class="quoted">"init_config <span class="free">c</span> <span class="main">⟹</span> InvIncomingInfoUpright <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> upright_0 upright_vec_add init_config_def InvIncomingInfoUpright_def IncomingInfo_def<span class="main">)</span>

<span class="keyword1" id="Exchange_Abadi-next_InvIncomingInfoUpright"><span class="command">lemma</span></span> next_InvIncomingInfoUpright<span class="main">:</span> <span class="quoted"><span class="quoted">"holds InvIncomingInfoUpright <span class="free">s</span> <span class="main">⟹</span> next <span class="free">s</span> <span class="main">⟹</span> nxt <span class="main">(</span>holds InvIncomingInfoUpright<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> next_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add.assoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> upright_vec_add next_performop'_def Let_def InvIncomingInfoUpright_def IncomingInfo_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> next_sendupd'_def Let_def InvIncomingInfoUpright_def IncomingInfo_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> p tt k q
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≤</span> length <span class="main">(</span>c_msg <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span>"</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> next_recvupd'_def Let_def InvIncomingInfoUpright_def IncomingInfo_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> drop_Suc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Exchange_Abadi-alw_InvIncomingInfoUpright"><span class="command">lemma</span></span> alw_InvIncomingInfoUpright<span class="main">:</span> <span class="quoted"><span class="quoted">"spec <span class="free">s</span> <span class="main">⟹</span> alw <span class="main">(</span>holds InvIncomingInfoUpright<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> alw_iff_sdrop alw_invar holds.elims<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> holds.elims<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> init_InvIncomingInfoUpright next_InvIncomingInfoUpright spec_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">GlobalIncomingInfo</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span> <span class="main">::</span> finite<span class="main">,</span> <span class="tfree">'t</span><span class="main">)</span> configuration <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> <span class="tfree">'t</span> delta_vec"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">GlobalIncomingInfo</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">p'</span> <span class="main">∈</span> UNIV<span class="main">.</span> IncomingInfo <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">p'</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="bound">p'</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">(* (GlobalIncomingInfo c 0 q q) sums up all info incoming at q *)</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">GlobalIncomingInfoAt</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">GlobalIncomingInfoAt</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">≡</span> GlobalIncomingInfo <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">InvGlobalRecordCount</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">InvGlobalRecordCount</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">q</span><span class="main">.</span> c_records <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> GlobalIncomingInfoAt <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">q</span> <span class="main">+</span> c_glob <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">q</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Exchange_Abadi-init_InvGlobalRecordCount"><span class="command">lemma</span></span> init_InvGlobalRecordCount<span class="main">:</span> <span class="quoted"><span class="quoted">"holds init_config <span class="free">s</span> <span class="main">⟹</span> holds InvGlobalRecordCount <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> InvGlobalRecordCount_def init_config_def GlobalIncomingInfo_def IncomingInfo_def<span class="main">)</span>

<span class="keyword1" id="Exchange_Abadi-if_eq_same"><span class="command">lemma</span></span> if_eq_same<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">if</span> <span class="free">a</span> <span class="main">=</span> <span class="free">b</span> <span class="keyword1">then</span> <span class="free">f</span> <span class="free">b</span> <span class="keyword1">else</span> <span class="free">f</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Exchange_Abadi-next_InvGlobalRecordCount"><span class="command">lemma</span></span> next_InvGlobalRecordCount<span class="main">:</span> <span class="quoted"><span class="quoted">"holds InvGlobalRecordCount <span class="free">s</span> <span class="main">⟹</span> next <span class="free">s</span> <span class="main">⟹</span> nxt <span class="main">(</span>holds InvGlobalRecordCount<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> InvGlobalRecordCount_def init_config_def GlobalIncomingInfo_def IncomingInfo_def next_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next_performop'_def Let_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> p c q r
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum.distrib<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> sum_if_distrib_add<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.assoc<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next_sendupd'_def Let_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> p tt q
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> if_distrib<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> if_distrib<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted">sum_list</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> sum_list_append<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum.distrib<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> sum_if_distrib_add<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> diff_conv_add_uminus<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> sum_if_distrib_add<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sum_if_distrib_add<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next_recvupd'_def Let_def fun_upd_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> p q q'
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> if_distrib<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> if_distrib<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted">sum_list</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> sum_list_hd_tl<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> add.commute<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum.distrib<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> sum_if_distrib_add<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.assoc<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> if_eq_same<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">(* This is inv2 in the short paper *)</span>
<span class="keyword1" id="Exchange_Abadi-alw_InvGlobalRecordCount"><span class="command">lemma</span></span> alw_InvGlobalRecordCount<span class="main">:</span> <span class="quoted"><span class="quoted">"spec <span class="free">s</span> <span class="main">⟹</span> alw <span class="main">(</span>holds InvGlobalRecordCount<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> alw_iff_sdrop alw_invar init_InvGlobalRecordCount next_InvGlobalRecordCount spec_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">InvGlobalIncomingInfoUpright</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">InvGlobalIncomingInfoUpright</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> upright <span class="main">(</span>GlobalIncomingInfo <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">k</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Exchange_Abadi-upright_sum_upright"><span class="command">lemma</span></span> upright_sum_upright<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">x</span><span class="main">.</span> upright <span class="main">(</span><span class="free">A</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> upright <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> <span class="free">A</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">X</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> upright_0 upright_vec_add<span class="main">)</span>

<span class="keyword1" id="Exchange_Abadi-InvIncomingInfoUpright_imp_InvGlobalIncomingInfoUpright"><span class="command">lemma</span></span> InvIncomingInfoUpright_imp_InvGlobalIncomingInfoUpright<span class="main">:</span> <span class="quoted"><span class="quoted">"holds InvIncomingInfoUpright <span class="free">s</span> <span class="main">⟹</span> holds InvGlobalIncomingInfoUpright <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> InvIncomingInfoUpright_def InvGlobalIncomingInfoUpright_def GlobalIncomingInfo_def upright_sum_upright<span class="main">)</span>

<span class="comment1">(* This is inv6 in the short paper *)</span>
<span class="keyword1" id="Exchange_Abadi-alw_InvGlobalIncomingInfoUpright"><span class="command">lemma</span></span> alw_InvGlobalIncomingInfoUpright<span class="main">:</span> <span class="quoted"><span class="quoted">"spec <span class="free">s</span> <span class="main">⟹</span> alw <span class="main">(</span>holds InvGlobalIncomingInfoUpright<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> InvIncomingInfoUpright_imp_InvGlobalIncomingInfoUpright alw_InvIncomingInfoUpright alw_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">nrec_pos</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nrec_pos</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">t</span><span class="main">.</span> zcount <span class="main">(</span>c_records <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="bound">t</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>

<span class="keyword1" id="Exchange_Abadi-init_nrec_pos"><span class="command">lemma</span></span> init_nrec_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"holds init_config <span class="free">s</span> <span class="main">⟹</span> holds nrec_pos <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> init_config_def<span class="main">)</span>

<span class="keyword1" id="Exchange_Abadi-next_nrec_pos"><span class="command">lemma</span></span> next_nrec_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"holds nrec_pos <span class="free">s</span> <span class="main">⟹</span> next <span class="free">s</span> <span class="main">⟹</span> nxt <span class="main">(</span>holds nrec_pos<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> next_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> t
    <span class="keyword1"><span class="command">unfolding</span></span> next_performop'_def Let_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> p c r
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_diff_eq add.commute add_increasing<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> t
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next_sendupd'_def Let_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> t
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next_recvupd'_def Let_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Exchange_Abadi-alw_nrec_pos"><span class="command">lemma</span></span> alw_nrec_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"spec <span class="free">s</span> <span class="main">⟹</span> alw <span class="main">(</span>holds nrec_pos<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> alw_iff_sdrop alw_invar init_nrec_pos next_nrec_pos spec_def<span class="main">)</span>

<span class="keyword1" id="Exchange_Abadi-next_performop_vacant"><span class="command">lemma</span></span> next_performop_vacant<span class="main">:</span>
  <span class="quoted"><span class="quoted">"vacant_upto <span class="main">(</span>c_records <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="free">t</span> <span class="main">⟹</span> next_performop <span class="free">s</span> <span class="main">⟹</span> vacant_upto <span class="main">(</span>c_records <span class="main">(</span>shd <span class="main">(</span>stl <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> next_performop'_def Let_def vacant_upto_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> p c u r
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> upright_def supported_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> gr_implies_not_zero of_nat_le_0_iff order.strict_implies_order order_trans zero_less_iff_neq_zero<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Exchange_Abadi-next_sendupd_vacant"><span class="command">lemma</span></span> next_sendupd_vacant<span class="main">:</span>
  <span class="quoted"><span class="quoted">"vacant_upto <span class="main">(</span>c_records <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="free">t</span> <span class="main">⟹</span> next_sendupd <span class="free">s</span> <span class="main">⟹</span> vacant_upto <span class="main">(</span>c_records <span class="main">(</span>shd <span class="main">(</span>stl <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next_sendupd'_def Let_def<span class="main">)</span>

<span class="keyword1" id="Exchange_Abadi-next_recvupd_vacant"><span class="command">lemma</span></span> next_recvupd_vacant<span class="main">:</span>
  <span class="quoted"><span class="quoted">"vacant_upto <span class="main">(</span>c_records <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="free">t</span> <span class="main">⟹</span> next_recvupd <span class="free">s</span> <span class="main">⟹</span> vacant_upto <span class="main">(</span>c_records <span class="main">(</span>shd <span class="main">(</span>stl <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next_recvupd'_def Let_def<span class="main">)</span>

<span class="keyword1" id="Exchange_Abadi-spec_imp_SafeStickyNrecVacantUpto_aux"><span class="command">lemma</span></span> spec_imp_SafeStickyNrecVacantUpto_aux<span class="main">:</span> <span class="quoted"><span class="quoted">"alw next <span class="free">s</span> <span class="main">⟹</span> alw SafeStickyNrecVacantUpto <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s
    <span class="keyword1"><span class="command">unfolding</span></span> spec_def next_def SafeStickyNrecVacantUpto_def Let_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">s</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> t
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> alw.coinduct<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> alw.cases<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next_performop_vacant next_sendupd_vacant next_recvupd_vacant<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Exchange_Abadi-spec_imp_SafeStickyNrecVacantUpto"><span class="command">lemma</span></span> spec_imp_SafeStickyNrecVacantUpto<span class="main">:</span> <span class="quoted"><span class="quoted">"spec <span class="free">s</span> <span class="main">⟹</span> alw SafeStickyNrecVacantUpto <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> spec_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> spec_imp_SafeStickyNrecVacantUpto_aux<span class="main">)</span>

<span class="keyword1" id="Exchange_Abadi-invs_imp_InvGlobVacantUptoImpliesNrec"><span class="command">lemma</span></span> invs_imp_InvGlobVacantUptoImpliesNrec<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"holds InvGlobalIncomingInfoUpright <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"holds InvGlobalRecordCount <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"holds nrec_pos <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"holds InvGlobVacantUptoImpliesNrec <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> InvGlobVacantUptoImpliesNrec_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vacant_upto_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> t q u
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">assume</span></span> globvut<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">sa</span></span><span class="main">≤</span><span class="skolem">t</span><span class="main">.</span> zcount <span class="main">(</span>c_glob <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="skolem">q</span><span class="main">)</span> <span class="bound">sa</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> uleqt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">≤</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> c_records <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_records <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">u</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> order.not_eq_order_implies_strict<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>2<span class="main">)</span> globvut uleqt <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>GlobalIncomingInfoAt <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="skolem">q</span><span class="main">)</span> <span class="skolem">u</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> InvGlobalRecordCount_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">q</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> InvGlobalIncomingInfoUpright_def<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"upright <span class="main">(</span>GlobalIncomingInfoAt <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="skolem">q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> * <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">≤</span> <span class="skolem">u</span>"</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>GlobalIncomingInfoAt <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="skolem">q</span><span class="main">)</span> <span class="skolem">v</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> order.strict_iff_order upright_def supported_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>c_records <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">v</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> InvGlobalRecordCount_def add.right_neutral order.trans globvut holds.elims<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> uleqt zcount_union<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
      <span class="keyword1"><span class="command">using</span></span> atLeastatMost_empty <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Exchange_Abadi-spec_imp_inv1"><span class="command">lemma</span></span> spec_imp_inv1<span class="main">:</span> <span class="quoted"><span class="quoted">"spec <span class="free">s</span> <span class="main">⟹</span> alw <span class="main">(</span>holds InvGlobVacantUptoImpliesNrec<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> alw_iff_sdrop invs_imp_InvGlobVacantUptoImpliesNrec alw_InvGlobalIncomingInfoUpright alw_InvGlobalRecordCount alw_nrec_pos<span class="main">)</span>

<span class="keyword1" id="Exchange_Abadi-safe2_inv1_imp_safe"><span class="command">lemma</span></span> safe2_inv1_imp_safe<span class="main">:</span> <span class="quoted"><span class="quoted">"SafeStickyNrecVacantUpto <span class="free">s</span> <span class="main">⟹</span> holds InvGlobVacantUptoImpliesNrec <span class="free">s</span> <span class="main">⟹</span> SafeGlobVacantUptoImpliesStickyNrec <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> InvGlobVacantUptoImpliesNrec_def SafeStickyNrecVacantUpto_def SafeGlobVacantUptoImpliesStickyNrec_def<span class="main">)</span>

<span class="keyword1" id="Exchange_Abadi-spec_imp_safe"><span class="command">lemma</span></span> spec_imp_safe<span class="main">:</span> <span class="quoted"><span class="quoted">"spec <span class="free">s</span> <span class="main">⟹</span> alw SafeGlobVacantUptoImpliesStickyNrec <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> alw_iff_sdrop safe2_inv1_imp_safe spec_imp_SafeStickyNrecVacantUpto spec_imp_inv1<span class="main">)</span>



<span class="comment1">(* Second safety property from here on (glob stays vacant) *)</span>

<span class="keyword1" id="Exchange_Abadi-beta_upright_0"><span class="command">lemma</span></span> beta_upright_0<span class="main">:</span> <span class="quoted"><span class="quoted">"beta_upright <span class="main">0</span> <span class="free">vb</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> beta_upright_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">PositiveImplies</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">PositiveImplies</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">.</span> zcount <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="bound">t</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟶</span> zcount <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="bound">t</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Exchange_Abadi-betaupright_PositiveImplies"><span class="command">lemma</span></span> betaupright_PositiveImplies<span class="main">:</span> <span class="quoted"><span class="quoted">"upright <span class="main">(</span><span class="free">va</span> <span class="main">+</span> <span class="free">vb</span><span class="main">)</span> <span class="main">⟹</span> PositiveImplies <span class="free">va</span> <span class="main">(</span><span class="free">va</span> <span class="main">+</span> <span class="free">vb</span><span class="main">)</span> <span class="main">⟹</span> beta_upright <span class="free">va</span> <span class="free">vb</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> beta_upright_def PositiveImplies_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> t
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> upright_obtain_support<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">t</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">s</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_less_zeroD<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Exchange_Abadi-betaupright_obtain_support"><span class="command">lemma</span></span> betaupright_obtain_support<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"beta_upright <span class="free">va</span> <span class="free">vb</span>"</span></span>
    <span class="quoted"><span class="quoted">"zcount <span class="free">va</span> <span class="free">t</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">s</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">&lt;</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"zcount <span class="free">va</span> <span class="free">s</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∨</span> zcount <span class="free">vb</span> <span class="free">s</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"nonpos_upto <span class="free">va</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> beta_upright_alt<span class="main">)</span>

<span class="keyword1" id="Exchange_Abadi-betaupright_upright_vut"><span class="command">lemma</span></span> betaupright_upright_vut<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"beta_upright <span class="free">va</span> <span class="free">vb</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"upright <span class="free">vb</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"vacant_upto <span class="main">(</span><span class="free">va</span> <span class="main">+</span> <span class="free">vb</span><span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"vacant_upto <span class="free">va</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span>
    <span class="keyword3"><span class="command">assume</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≤</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"zcount <span class="free">va</span> <span class="skolem">s</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"zcount <span class="free">va</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∨</span> zcount <span class="free">vb</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"nonpos_upto <span class="free">va</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> betaupright_obtain_support <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"zcount <span class="free">va</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> s x<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> vacant_upto_def
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> upright_obtain_support<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">vb</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">x</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> add_less_same_cancel2 order.trans order.strict_implies_order<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> add_less_same_cancel1 add_neg_neg order.order_iff_strict order.trans less_irrefl<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> assms s x <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"zcount <span class="free">va</span> <span class="skolem">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> add.left_neutral order.order_iff_strict order.trans vacant_upto_def zcount_union<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> s x <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> r <span class="main">=</span> this
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> vacant_upto_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> r add_cancel_right_left order.order_iff_strict order.trans le_less_linear less_add_same_cancel2 upright_obtain_support<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Exchange_Abadi-beta_upright_add"><span class="command">lemma</span></span> beta_upright_add<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"upright <span class="free">vb</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"upright <span class="free">vc</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"beta_upright <span class="free">va</span> <span class="free">vb</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"beta_upright <span class="free">va</span> <span class="main">(</span><span class="free">vb</span> <span class="main">+</span> <span class="free">vc</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">va</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">s</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> <span class="main">(</span>zcount <span class="free">va</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∨</span> zcount <span class="free">vb</span> <span class="bound">s</span> <span class="main">+</span> zcount <span class="free">vc</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> <span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">u</span></span> <span class="main">≤</span> <span class="bound">s</span><span class="main">.</span> zcount <span class="free">va</span> <span class="bound">u</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">va</span> <span class="skolem">t</span>›</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">t</span> <span class="main">∧</span> <span class="main">(</span>zcount <span class="free">va</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∨</span> zcount <span class="free">vb</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> nonpos_upto <span class="free">va</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> betaupright_obtain_support <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> zcount <span class="free">va</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assm <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">with</span></span> x <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zcount <span class="free">vb</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> assm x <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> zcount <span class="free">vb</span> <span class="skolem">x</span> <span class="main">+</span> zcount <span class="free">vc</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> not_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹zcount <span class="free">vb</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zcount <span class="free">vc</span> <span class="skolem">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">&lt;</span> <span class="skolem">x</span> <span class="main">∧</span> zcount <span class="free">vc</span> <span class="skolem">y</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∧</span> nonpos_upto <span class="free">vc</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> upright_obtain_support <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> x <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">&lt;</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> order.strict_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> assm x y <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> zcount <span class="free">vb</span> <span class="skolem">y</span> <span class="main">+</span> zcount <span class="free">vc</span> <span class="skolem">y</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> order.strict_implies_order order.strict_trans1 not_less<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> y <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zcount <span class="free">vb</span> <span class="skolem">y</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">&lt;</span> <span class="skolem">y</span> <span class="main">∧</span> zcount <span class="free">vb</span> <span class="skolem">z</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> upright_def supported_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">&lt;</span> <span class="skolem">t</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">&lt;</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> order.strict_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> x y z <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> zcount <span class="free">vb</span> <span class="skolem">z</span> <span class="main">+</span> zcount <span class="free">vc</span> <span class="skolem">z</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assm less_imp_le not_less order.strict_trans order.strict_trans1<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> z <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zcount <span class="free">vc</span> <span class="skolem">z</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">with</span></span> y z <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
      <span class="keyword1"><span class="command">using</span></span> order.strict_implies_order not_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> beta_upright_def zcount_union <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">InfoAt</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">InfoAt</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">0</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">&lt;</span> length <span class="main">(</span>c_msg <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">(</span>c_msg <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">InvInfoAtBetaUpright</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">InvInfoAtBetaUpright</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> beta_upright <span class="main">(</span>InfoAt <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">k</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">)</span> <span class="main">(</span>IncomingInfo <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span><span class="bound">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Exchange_Abadi-init_InvInfoAtBetaUpright"><span class="command">lemma</span></span> init_InvInfoAtBetaUpright<span class="main">:</span> <span class="quoted"><span class="quoted">"init_config <span class="free">c</span> <span class="main">⟹</span> InvInfoAtBetaUpright <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> init_config_def InvInfoAtBetaUpright_def beta_upright_def IncomingInfo_def InfoAt_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Exchange_Abadi-next_inv"><span class="command">lemma</span></span> next_inv<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> next_performop next_sendupd next_recvupd stutter<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"next <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"next_performop <span class="free">s</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"next_sendupd <span class="free">s</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"next_recvupd <span class="free">s</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"shd <span class="main">(</span>stl <span class="free">s</span><span class="main">)</span> <span class="main">=</span> shd <span class="free">s</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> next_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>


<span class="keyword1" id="Exchange_Abadi-next_InvInfoAtBetaUpright"><span class="command">lemma</span></span> next_InvInfoAtBetaUpright<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"next <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>     a2<span class="main">:</span> <span class="quoted"><span class="quoted">"InvInfoAtBetaUpright <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>     a3<span class="main">:</span> <span class="quoted"><span class="quoted">"InvIncomingInfoUpright <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>     a4<span class="main">:</span> <span class="quoted"><span class="quoted">"InvTempUpright <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"InvInfoAtBetaUpright <span class="main">(</span>shd <span class="main">(</span>stl <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> next_inv<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> next_performop
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> next_performop'_def Let_def InvInfoAtBetaUpright_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> p c r k' p' q'
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span><span class="main">=</span><span class="skolem">p'</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Δ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"zmset_of <span class="skolem">r</span> <span class="main">-</span> zmset_of <span class="skolem">c</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> upright_Δ<span class="main">:</span> <span class="quoted"><span class="quoted">"upright <span class="var">?Δ</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> conf<span class="main">:</span> <span class="quoted"><span class="quoted">"shd <span class="main">(</span>stl <span class="free">s</span><span class="main">)</span> <span class="main">=</span> shd <span class="free">s</span><span class="main">⦇</span>c_records <span class="main">:=</span> c_records <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>zmset_of <span class="skolem">r</span> <span class="main">-</span> zmset_of <span class="skolem">c</span><span class="main">)</span><span class="main">,</span>
        c_temp <span class="main">:=</span> <span class="main">(</span>c_temp <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">(</span><span class="skolem">p</span> <span class="main">:=</span> c_temp <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">+</span> <span class="main">(</span>zmset_of <span class="skolem">r</span> <span class="main">-</span> zmset_of <span class="skolem">c</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span>"</span></span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> iid<span class="main">:</span> <span class="quoted"><span class="quoted">"IncomingInfo <span class="main">(</span>shd <span class="main">(</span>stl <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">k'</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">p'</span> <span class="skolem">q'</span> <span class="main">=</span> IncomingInfo <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="skolem">k'</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">p'</span> <span class="skolem">q'</span> <span class="main">+</span> <span class="var">?Δ</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> IncomingInfo_def conf<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> a2 <span class="keyword1"><span class="command">have</span></span> bu<span class="main">:</span> <span class="quoted"><span class="quoted">"beta_upright <span class="main">(</span>InfoAt <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="skolem">k'</span> <span class="skolem">p'</span> <span class="skolem">q'</span><span class="main">)</span> <span class="main">(</span>IncomingInfo <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="skolem">k'</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">p'</span> <span class="skolem">q'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> InvInfoAtBetaUpright_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> iid
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> beta_upright_add<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">meson</span> InvIncomingInfoUpright_def a3<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> upright_Δ<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> bu <span class="keyword1"><span class="command">unfolding</span></span> conf InfoAt_def
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Δ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"zmset_of <span class="skolem">r</span> <span class="main">-</span> zmset_of <span class="skolem">c</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> conf<span class="main">:</span> <span class="quoted"><span class="quoted">"shd <span class="main">(</span>stl <span class="free">s</span><span class="main">)</span> <span class="main">=</span> shd <span class="free">s</span><span class="main">⦇</span>c_records <span class="main">:=</span> c_records <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>zmset_of <span class="skolem">r</span> <span class="main">-</span> zmset_of <span class="skolem">c</span><span class="main">)</span><span class="main">,</span>
        c_temp <span class="main">:=</span> <span class="main">(</span>c_temp <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">(</span><span class="skolem">p</span> <span class="main">:=</span> c_temp <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">+</span> <span class="main">(</span>zmset_of <span class="skolem">r</span> <span class="main">-</span> zmset_of <span class="skolem">c</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> a2 <span class="keyword1"><span class="command">have</span></span> bu<span class="main">:</span> <span class="quoted"><span class="quoted">"beta_upright <span class="main">(</span>InfoAt <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="skolem">k</span> <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">(</span>IncomingInfo <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span> <span class="skolem">p</span> <span class="skolem">q</span>
        <span class="keyword1"><span class="command">using</span></span> InvInfoAtBetaUpright_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ii<span class="main">:</span> <span class="quoted"><span class="quoted">"IncomingInfo <span class="main">(</span>shd <span class="main">(</span>stl <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">k'</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">p'</span> <span class="skolem">q'</span> <span class="main">=</span> IncomingInfo <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="skolem">k'</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">p'</span> <span class="skolem">q'</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> IncomingInfo_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> conf<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> bu<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">k'</span></span> <span class="quoted"><span class="skolem">p'</span></span> <span class="quoted"><span class="skolem">q'</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> conf InfoAt_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> next_sendupd
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> next_sendupd'_def Let_def InvInfoAtBetaUpright_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> p tt k' p' q'
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span><span class="main">=</span><span class="skolem">p'</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?γ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="bound">t</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> c_temp <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="skolem">p</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="skolem">tt</span><span class="main">#}</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> conf<span class="main">:</span> <span class="quoted"><span class="quoted">"shd <span class="main">(</span>stl <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span><span class="main">⦇</span>c_msg <span class="main">:=</span> <span class="main">(</span>c_msg <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">(</span><span class="skolem">p</span> <span class="main">:=</span> <span class="main">λ</span><span class="bound">q</span><span class="main">.</span> c_msg <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="skolem">p</span> <span class="bound">q</span> <span class="main">@</span> <span class="main">[</span><span class="var">?γ</span><span class="main">]</span><span class="main">)</span><span class="main">,</span>
              c_temp <span class="main">:=</span> <span class="main">(</span>c_temp <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">(</span><span class="skolem">p</span> <span class="main">:=</span> c_temp <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">-</span> <span class="var">?γ</span><span class="main">)</span><span class="main">⦈</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> a2 <span class="keyword1"><span class="command">have</span></span> buia<span class="main">:</span> <span class="quoted"><span class="quoted">"beta_upright <span class="main">(</span>InfoAt <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="skolem">k'</span> <span class="skolem">p'</span> <span class="skolem">q'</span><span class="main">)</span> <span class="main">(</span>IncomingInfo <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="skolem">k'</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">p'</span> <span class="skolem">q'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> InvInfoAtBetaUpright_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">from</span></span> a4 <span class="keyword1"><span class="command">have</span></span> tu<span class="main">:</span> <span class="quoted"><span class="quoted">"upright <span class="main">(</span>c_temp <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> InvTempUpright_def<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">k'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> linorder_cases<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> y <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"length <span class="main"><span class="main">(</span></span>c_msg <span class="main"><span class="main">(</span></span>shd <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span> <span class="skolem"><span class="skolem">p'</span></span> <span class="skolem"><span class="skolem">q'</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> greater
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"InfoAt <span class="main">(</span>shd <span class="main">(</span>stl <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">k'</span> <span class="skolem">p'</span> <span class="skolem">q'</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> conf InfoAt_def<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> beta_upright_0<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> equal
        <span class="keyword1"><span class="command">with</span></span> True conf <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"InfoAt <span class="main">(</span>shd <span class="main">(</span>stl <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">k'</span> <span class="skolem">p'</span> <span class="skolem">q'</span> <span class="main">=</span> <span class="var">?γ</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> InfoAt_def<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> pi<span class="main">:</span> <span class="quoted"><span class="quoted">"PositiveImplies <span class="main">(</span>InfoAt <span class="main">(</span>shd <span class="main">(</span>stl <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">k'</span> <span class="skolem">p'</span> <span class="skolem">q'</span><span class="main">)</span> <span class="main">(</span>c_temp <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PositiveImplies_def<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> conf <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"c_temp <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">=</span> c_temp <span class="main">(</span>shd <span class="main">(</span>stl <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">+</span> <span class="var">?γ</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">with</span></span> equal True conf tu pi <span class="keyword1"><span class="command">have</span></span> butemp<span class="main">:</span> <span class="quoted"><span class="quoted">"beta_upright <span class="main">(</span>InfoAt <span class="main">(</span>shd <span class="main">(</span>stl <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">k'</span> <span class="skolem">p'</span> <span class="skolem">q'</span><span class="main">)</span> <span class="main">(</span>c_temp <span class="main">(</span>shd <span class="main">(</span>stl <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> betaupright_PositiveImplies<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> InfoAt_def<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command">with</span></span> True equal conf <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"IncomingInfo <span class="main">(</span>shd <span class="main">(</span>stl <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">k'</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">p'</span> <span class="skolem">q'</span> <span class="main">=</span> c_temp <span class="main">(</span>shd <span class="main">(</span>stl <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">p</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> IncomingInfo_def<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> butemp <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> less
        <span class="keyword1"><span class="command">with</span></span> conf <span class="keyword1"><span class="command">have</span></span> unch_ia<span class="main">:</span> <span class="quoted"><span class="quoted">"InfoAt <span class="main">(</span>shd <span class="main">(</span>stl <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">k'</span> <span class="skolem">p'</span> <span class="skolem">q'</span> <span class="main">=</span> InfoAt <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="skolem">k'</span> <span class="skolem">p'</span> <span class="skolem">q'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_append InfoAt_def<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> conf less <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"IncomingInfo <span class="main">(</span>shd <span class="main">(</span>stl <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">k'</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">p'</span> <span class="skolem">q'</span> <span class="main">=</span> IncomingInfo <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="skolem">k'</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">p'</span> <span class="skolem">q'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> IncomingInfo_def<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> buia unch_ia <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?γ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="bound">t</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> c_temp <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="skolem">p</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="skolem">tt</span><span class="main">#}</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> conf<span class="main">:</span> <span class="quoted"><span class="quoted">"shd <span class="main">(</span>stl <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span><span class="main">⦇</span>c_msg <span class="main">:=</span> <span class="main">(</span>c_msg <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">(</span><span class="skolem">p</span> <span class="main">:=</span> <span class="main">λ</span><span class="bound">q</span><span class="main">.</span> c_msg <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="skolem">p</span> <span class="bound">q</span> <span class="main">@</span> <span class="main">[</span><span class="var">?γ</span><span class="main">]</span><span class="main">)</span><span class="main">,</span>
              c_temp <span class="main">:=</span> <span class="main">(</span>c_temp <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">(</span><span class="skolem">p</span> <span class="main">:=</span> c_temp <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">-</span> <span class="var">?γ</span><span class="main">)</span><span class="main">⦈</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> a2 <span class="keyword1"><span class="command">have</span></span> buia<span class="main">:</span> <span class="quoted"><span class="quoted">"beta_upright <span class="main">(</span>InfoAt <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="skolem">k'</span> <span class="skolem">p'</span> <span class="skolem">q'</span><span class="main">)</span> <span class="main">(</span>IncomingInfo <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="skolem">k'</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">p'</span> <span class="skolem">q'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> InvInfoAtBetaUpright_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> conf <span class="keyword1"><span class="command">have</span></span> unchia<span class="main">:</span> <span class="quoted"><span class="quoted">"InfoAt <span class="main">(</span>shd <span class="main">(</span>stl <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">k'</span> <span class="skolem">p'</span> <span class="skolem">q'</span> <span class="main">=</span> InfoAt <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="skolem">k'</span> <span class="skolem">p'</span> <span class="skolem">q'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> InfoAt_def<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> False conf <span class="keyword1"><span class="command">have</span></span> unchii<span class="main">:</span> <span class="quoted"><span class="quoted">"IncomingInfo <span class="main">(</span>shd <span class="main">(</span>stl <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">k'</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">p'</span> <span class="skolem">q'</span> <span class="main">=</span> IncomingInfo <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="skolem">k'</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">p'</span> <span class="skolem">q'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> IncomingInfo_def<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> unchia unchii buia <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> next_recvupd
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> next_recvupd'_def Let_def InvInfoAtBetaUpright_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> p q k' p' q'
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="skolem">p'</span> <span class="main">∧</span> <span class="skolem">q</span> <span class="main">=</span> <span class="skolem">q'</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> conf<span class="main">:</span> <span class="quoted"><span class="quoted">"shd <span class="main">(</span>stl <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span><span class="main">⦇</span>c_msg <span class="main">:=</span> <span class="main">(</span>c_msg <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">(</span><span class="skolem">p</span> <span class="main">:=</span> <span class="main">(</span>c_msg <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span><span class="main">(</span><span class="skolem">q</span> <span class="main">:=</span> tl <span class="main">(</span>c_msg <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
              c_glob <span class="main">:=</span> <span class="main">(</span>c_glob <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">(</span><span class="skolem">q</span> <span class="main">:=</span> c_glob <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="skolem">q</span> <span class="main">+</span> hd <span class="main">(</span>c_msg <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span>"</span></span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">with</span></span> conf <span class="keyword1"><span class="command">have</span></span> iisuc<span class="main">:</span> <span class="quoted"><span class="quoted">"IncomingInfo <span class="main">(</span>shd <span class="main">(</span>stl <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">k'</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">p'</span> <span class="skolem">q'</span> <span class="main">=</span> IncomingInfo <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="skolem">k'</span><span class="main">+</span><span class="numeral">2</span><span class="main">)</span> <span class="skolem">p'</span> <span class="skolem">q'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> drop_Suc IncomingInfo_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> True conf <span class="keyword1"><span class="command">have</span></span> iasuc<span class="main">:</span> <span class="quoted"><span class="quoted">"InfoAt <span class="main">(</span>shd <span class="main">(</span>stl <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">k'</span> <span class="skolem">p'</span> <span class="skolem">q'</span> <span class="main">=</span> InfoAt <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="skolem">k'</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">p'</span> <span class="skolem">q'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_diff_conv nth_tl InfoAt_def<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> a2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"beta_upright <span class="main">(</span>InfoAt <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="skolem">k'</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">p'</span> <span class="skolem">q'</span><span class="main">)</span> <span class="main">(</span>IncomingInfo <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="skolem">k'</span><span class="main">+</span><span class="numeral">2</span><span class="main">)</span> <span class="skolem">p'</span> <span class="skolem">q'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> InvInfoAtBetaUpright_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">with</span></span> iisuc iasuc <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> conf<span class="main">:</span> <span class="quoted"><span class="quoted">"shd <span class="main">(</span>stl <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span><span class="main">⦇</span>c_msg <span class="main">:=</span> <span class="main">(</span>c_msg <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">(</span><span class="skolem">p</span> <span class="main">:=</span> <span class="main">(</span>c_msg <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span><span class="main">(</span><span class="skolem">q</span> <span class="main">:=</span> tl <span class="main">(</span>c_msg <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
              c_glob <span class="main">:=</span> <span class="main">(</span>c_glob <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">(</span><span class="skolem">q</span> <span class="main">:=</span> c_glob <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="skolem">q</span> <span class="main">+</span> hd <span class="main">(</span>c_msg <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> a2 <span class="keyword1"><span class="command">have</span></span> buia<span class="main">:</span> <span class="quoted"><span class="quoted">"beta_upright <span class="main">(</span>InfoAt <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="skolem">k'</span> <span class="skolem">p'</span> <span class="skolem">q'</span><span class="main">)</span> <span class="main">(</span>IncomingInfo <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="skolem">k'</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">p'</span> <span class="skolem">q'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> InvInfoAtBetaUpright_def<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> conf <span class="keyword1"><span class="command">have</span></span> unchii<span class="main">:</span> <span class="quoted"><span class="quoted">"IncomingInfo <span class="main">(</span>shd <span class="main">(</span>stl <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">k'</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">p'</span> <span class="skolem">q'</span> <span class="main">=</span> IncomingInfo <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="skolem">k'</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">p'</span> <span class="skolem">q'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> IncomingInfo_def<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> False conf <span class="keyword1"><span class="command">have</span></span> unchia<span class="main">:</span> <span class="quoted"><span class="quoted">"InfoAt <span class="main">(</span>shd <span class="main">(</span>stl <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">k'</span> <span class="skolem">p'</span> <span class="skolem">q'</span> <span class="main">=</span> InfoAt <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="skolem">k'</span> <span class="skolem">p'</span> <span class="skolem">q'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> InfoAt_def<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> unchii unchia buia <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Exchange_Abadi-alw_InvInfoAtBetaUpright_aux"><span class="command">lemma</span></span> alw_InvInfoAtBetaUpright_aux<span class="main">:</span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>holds InvTempUpright<span class="main">)</span> <span class="free">s</span> <span class="main">⟹</span> alw <span class="main">(</span>holds InvIncomingInfoUpright<span class="main">)</span> <span class="free">s</span> <span class="main">⟹</span> holds InvInfoAtBetaUpright <span class="free">s</span> <span class="main">⟹</span> alw next <span class="free">s</span> <span class="main">⟹</span> alw <span class="main">(</span>holds InvInfoAtBetaUpright<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> alw.coinduct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> next_InvInfoAtBetaUpright<span class="main">)</span>

<span class="keyword1" id="Exchange_Abadi-alw_InvInfoAtBetaUpright"><span class="command">lemma</span></span> alw_InvInfoAtBetaUpright<span class="main">:</span> <span class="quoted"><span class="quoted">"spec <span class="free">s</span> <span class="main">⟹</span> alw <span class="main">(</span>holds InvInfoAtBetaUpright<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alw_InvTempUpright alw_InvIncomingInfoUpright alw_InvInfoAtBetaUpright_aux init_InvInfoAtBetaUpright spec_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">InvGlobalInfoAtBetaUpright</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">InvGlobalInfoAtBetaUpright</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> beta_upright <span class="main">(</span>InfoAt <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">k</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">)</span> <span class="main">(</span>GlobalIncomingInfo <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span><span class="bound">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Exchange_Abadi-finite_induct_select"><span class="command">lemma</span></span> finite_induct_select <span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> empty select<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">{}</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> select<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">T</span><span class="main">.</span> finite <span class="bound">T</span> <span class="main">⟹</span> <span class="bound">T</span> <span class="main">⊂</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">T</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">s</span><span class="main">∈</span><span class="free">S</span> <span class="main">-</span> <span class="bound">T</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>insert <span class="bound">s</span> <span class="bound">T</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">S</span> <span class="main">∧</span> finite <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">S</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct_select<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> empty select<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Exchange_Abadi-predicate_sum_decompose"><span class="command">lemma</span></span> predicate_sum_decompose<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">::</span> ab_group_add<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∈</span><span class="free">X</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">Z</span><span class="main">.</span> <span class="free">B</span> <span class="main">(</span>sum <span class="free">f</span> <span class="bound">Z</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">Z</span><span class="main">.</span> <span class="free">A</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">B</span> <span class="main">(</span>sum <span class="free">f</span> <span class="bound">Z</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="main">+</span> sum <span class="free">f</span> <span class="bound">Z</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">Z</span><span class="main">.</span> <span class="free">B</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">(</span>sum <span class="free">f</span> <span class="bound">Z</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="main">+</span> sum <span class="free">f</span> <span class="bound">Z</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>3<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">X</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct_select<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> sum.insert_remove<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> T
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="skolem">T</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> psubset_imp_ex_mem<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> z
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> bexI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">z</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">z</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">T</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">THEN</span> spec<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">{</span></span><span class="skolem"><span class="skolem">z</span></span><span class="main"><span class="main">}</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> bspec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">x</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">,</span>5<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Exchange_Abadi-invs_imp_InvGlobalInfoAtBetaUpright"><span class="command">lemma</span></span> invs_imp_InvGlobalInfoAtBetaUpright<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"holds InvInfoAtBetaUpright <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"holds InvGlobalIncomingInfoUpright <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"holds InvIncomingInfoUpright <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"holds InvGlobalInfoAtBetaUpright <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> uii<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> upright <span class="main">(</span>IncomingInfo <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="bound">k</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> InvIncomingInfoUpright_def<span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> ugii<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> upright <span class="main">(</span>GlobalIncomingInfo <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="bound">k</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> InvGlobalIncomingInfoUpright_def<span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> buia<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> beta_upright <span class="main">(</span>InfoAt <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="bound">k</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">)</span> <span class="main">(</span>IncomingInfo <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> InvInfoAtBetaUpright_def<span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> uii ugii buia <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> beta_upright <span class="main">(</span>InfoAt <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="bound">k</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">)</span> <span class="main">(</span>GlobalIncomingInfo <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> GlobalIncomingInfo_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> k p q
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> predicate_sum_decompose<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">UNIV</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">p</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">v</span></span><span class="main"><span class="main">.</span></span> beta_upright <span class="main"><span class="main">(</span></span>InfoAt <span class="main"><span class="main">(</span></span>shd <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">q</span></span><span class="main"><span class="main">)</span></span> <span class="bound"><span class="bound">v</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">p'</span></span><span class="main"><span class="main">.</span></span> IncomingInfo <span class="main"><span class="main">(</span></span>shd <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span><span class="keyword1"><span class="keyword1">if</span></span> <span class="bound"><span class="bound">p'</span></span> <span class="main"><span class="main">=</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword1"><span class="keyword1">then</span></span> Suc <span class="skolem"><span class="skolem">k</span></span> <span class="keyword1"><span class="keyword1">else</span></span> <span class="main"><span class="main">0</span></span><span class="main"><span class="main">)</span></span> <span class="bound"><span class="bound">p'</span></span> <span class="skolem"><span class="skolem">q</span></span>"</span></span></span> <span class="quoted"><span class="quoted">upright</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> upright_sum_upright<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> p' X
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> beta_upright_add<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> p' X
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> add.commute<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> beta_upright_add<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> upright_sum_upright<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> InvGlobalInfoAtBetaUpright_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Exchange_Abadi-alw_InvGlobalInfoAtBetaUpright"><span class="command">lemma</span></span> alw_InvGlobalInfoAtBetaUpright<span class="main">:</span> <span class="quoted"><span class="quoted">"spec <span class="free">s</span> <span class="main">⟹</span> alw <span class="main">(</span>holds InvGlobalInfoAtBetaUpright<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> alw_InvGlobalIncomingInfoUpright alw_InvIncomingInfoUpright alw_InvInfoAtBetaUpright alw_iff_sdrop invs_imp_InvGlobalInfoAtBetaUpright<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">SafeStickyGlobVacantUpto</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span> <span class="main">::</span> finite<span class="main">,</span> <span class="tfree">'t</span> <span class="main">::</span> order<span class="main">)</span> computation <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">SafeStickyGlobVacantUpto</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">q</span> <span class="bound">t</span><span class="main">.</span> GlobVacantUpto <span class="main">(</span>shd <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="bound">q</span> <span class="bound">t</span> <span class="main">⟶</span> alw <span class="main">(</span>holds <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> GlobVacantUpto <span class="bound">c</span> <span class="bound">q</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Exchange_Abadi-gvut1"><span class="command">lemma</span></span> gvut1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"GlobVacantUpto <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="free">q</span> <span class="free">t</span> <span class="main">⟹</span> next_performop <span class="free">s</span> <span class="main">⟹</span> GlobVacantUpto <span class="main">(</span>shd <span class="main">(</span>stl <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="free">q</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next_performop'_def Let_def vacant_upto_def upright_def<span class="main">)</span>

<span class="keyword1" id="Exchange_Abadi-gvut2"><span class="command">lemma</span></span> gvut2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"GlobVacantUpto <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="free">q</span> <span class="free">t</span> <span class="main">⟹</span> next_sendupd <span class="free">s</span> <span class="main">⟹</span> GlobVacantUpto <span class="main">(</span>shd <span class="main">(</span>stl <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="free">q</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next_sendupd'_def Let_def<span class="main">)</span>

<span class="keyword1" id="Exchange_Abadi-gvut3"><span class="command">lemma</span></span> gvut3<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    gvu<span class="main">:</span> <span class="quoted"><span class="quoted">"GlobVacantUpto <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="free">q</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    igvuin<span class="main">:</span> <span class="quoted"><span class="quoted">"InvGlobVacantUptoImpliesNrec <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    igrc<span class="main">:</span> <span class="quoted"><span class="quoted">"InvGlobalRecordCount <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    igiiu<span class="main">:</span> <span class="quoted"><span class="quoted">"InvGlobalIncomingInfoUpright <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    igiabu<span class="main">:</span> <span class="quoted"><span class="quoted">"InvGlobalInfoAtBetaUpright <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted">"next"</span><span class="main">:</span> <span class="quoted"><span class="quoted">"next_recvupd <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"GlobVacantUpto <span class="main">(</span>shd <span class="main">(</span>stl <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="free">q</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?GII0</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"GlobalIncomingInfo <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="main">0</span> <span class="skolem">p</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?GII1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"GlobalIncomingInfo <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="main">1</span> <span class="skolem">p</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?κ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"hd <span class="main">(</span>c_msg <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="skolem">p</span> <span class="free">q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> igiiu <span class="keyword1"><span class="command">have</span></span> uGII1<span class="main">:</span> <span class="quoted"><span class="quoted">"upright <span class="var">?GII1</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> InvGlobalIncomingInfoUpright_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">assume</span></span> globk<span class="main">:</span> <span class="quoted"><span class="quoted">"c_glob <span class="main">(</span>shd <span class="main">(</span>stl <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="free">q</span> <span class="main">=</span> c_glob <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="free">q</span> <span class="main">+</span> <span class="var">?κ</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"c_msg <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="skolem">p</span> <span class="free">q</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> sumGIIsk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?GII0</span> <span class="main">=</span> <span class="var">?GII1</span> <span class="main">+</span> <span class="var">?κ</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> GlobalIncomingInfo_def IncomingInfo_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sum.remove <span class="dynamic"><span class="dynamic">ac_simps</span></span> neq_Nil_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> nonempty <span class="keyword1"><span class="command">have</span></span> IA0k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?κ</span> <span class="main">=</span> InfoAt <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="main">0</span> <span class="skolem">p</span> <span class="free">q</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> InfoAt_def hd_conv_nth<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> igiabu nonempty <span class="keyword1"><span class="command">have</span></span> bukGII1<span class="main">:</span> <span class="quoted"><span class="quoted">"beta_upright <span class="var">?κ</span> <span class="var">?GII1</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">note</span></span> igiabu
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"beta_upright <span class="main">(</span>InfoAt <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="main">0</span> <span class="skolem">p</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span>GlobalIncomingInfo <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="main">1</span> <span class="skolem">p</span> <span class="free">q</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> InvGlobalInfoAtBetaUpright_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> IA0k <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">from</span></span> igvuin gvu <span class="keyword1"><span class="command">have</span></span> nvu<span class="main">:</span> <span class="quoted"><span class="quoted">"NrecVacantUpto <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="free">t</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> InvGlobVacantUptoImpliesNrec_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> igrc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"c_records <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="main">=</span> c_glob <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="free">q</span> <span class="main">+</span> <span class="var">?GII0</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> GlobalIncomingInfo_def IncomingInfo_def InvGlobalRecordCount_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.commute<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> gvu nvu <span class="keyword1"><span class="command">have</span></span> vuGII0<span class="main">:</span> <span class="quoted"><span class="quoted">"vacant_upto <span class="var">?GII0</span> <span class="free">t</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vacant_upto_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> bukGII1 uGII1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vacant_upto <span class="var">?κ</span> <span class="free">t</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> betaupright_upright_vut<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?κ</span></span></span></span></span></span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?GII1</span></span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> vuGII0 add.commute sumGIIsk<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> gvu <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"GlobVacantUpto <span class="main">(</span>shd <span class="main">(</span>stl <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="free">q</span> <span class="free">t</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> globk vacant_upto_def<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> next_recvupd'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Exchange_Abadi-spec_imp_SafeStickyGlobVacantUpto_aux"><span class="command">lemma</span></span> spec_imp_SafeStickyGlobVacantUpto_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"alw <span class="main">(</span>holds <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> InvGlobVacantUptoImpliesNrec <span class="bound">c</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"alw <span class="main">(</span>holds <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> InvGlobalRecordCount <span class="bound">c</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"alw <span class="main">(</span>holds <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> InvGlobalIncomingInfoUpright <span class="bound">c</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"alw <span class="main">(</span>holds <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> InvGlobalInfoAtBetaUpright <span class="bound">c</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"alw next <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"alw SafeStickyGlobVacantUpto <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s
    <span class="keyword1"><span class="command">unfolding</span></span> spec_def next_def SafeStickyGlobVacantUpto_def Let_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">s</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q t
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> alw.coinduct<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">sb</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> configuration stream"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>holds InvGlobVacantUptoImpliesNrec<span class="main">)</span> <span class="skolem">sb</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> a2<span class="main">:</span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>holds InvGlobalRecordCount<span class="main">)</span> <span class="skolem">sb</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> a3<span class="main">:</span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>holds InvGlobalIncomingInfoUpright<span class="main">)</span> <span class="skolem">sb</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> a4<span class="main">:</span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>holds InvGlobalInfoAtBetaUpright<span class="main">)</span> <span class="skolem">sb</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> a5<span class="main">:</span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> next_performop <span class="bound">s</span> <span class="main">∨</span> next_sendupd <span class="bound">s</span> <span class="main">∨</span> next_recvupd <span class="bound">s</span> <span class="main">∨</span> shd <span class="main">(</span>stl <span class="bound">s</span><span class="main">)</span> <span class="main">=</span> shd <span class="bound">s</span><span class="main">)</span> <span class="skolem">sb</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> a6<span class="main">:</span> <span class="quoted"><span class="quoted">"GlobVacantUpto <span class="main">(</span>shd <span class="skolem">sb</span><span class="main">)</span> <span class="skolem">q</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"next_performop <span class="skolem">sb</span> <span class="main">∨</span> next_sendupd <span class="skolem">sb</span> <span class="main">∨</span> next_recvupd <span class="skolem">sb</span> <span class="main">∨</span> shd <span class="main">(</span>stl <span class="skolem">sb</span><span class="main">)</span> <span class="main">=</span> shd <span class="skolem">sb</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> a5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"GlobVacantUpto <span class="main">(</span>shd <span class="main">(</span>stl <span class="skolem">sb</span><span class="main">)</span><span class="main">)</span> <span class="skolem">q</span> <span class="skolem">t</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> a6 a4 a3 a2 a1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> alwD gvut1 gvut2 gvut3 holds.elims<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>holds InvGlobalRecordCount<span class="main">)</span> <span class="main">(</span>stl <span class="skolem">sb</span><span class="main">)</span> <span class="main">∧</span> alw <span class="main">(</span>holds InvGlobalIncomingInfoUpright<span class="main">)</span> <span class="main">(</span>stl <span class="skolem">sb</span><span class="main">)</span> <span class="main">∧</span> alw <span class="main">(</span>holds InvGlobalInfoAtBetaUpright<span class="main">)</span> <span class="main">(</span>stl <span class="skolem">sb</span><span class="main">)</span> <span class="main">∧</span> alw <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> next_performop <span class="bound">s</span> <span class="main">∨</span> next_sendupd <span class="bound">s</span> <span class="main">∨</span> next_recvupd <span class="bound">s</span> <span class="main">∨</span> shd <span class="main">(</span>stl <span class="bound">s</span><span class="main">)</span> <span class="main">=</span> shd <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>stl <span class="skolem">sb</span><span class="main">)</span> <span class="main">∧</span> GlobVacantUpto <span class="main">(</span>shd <span class="main">(</span>stl <span class="skolem">sb</span><span class="main">)</span><span class="main">)</span> <span class="skolem">q</span> <span class="skolem">t</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> a5 a4 a3 a2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Exchange_Abadi-spec_imp_SafeStickyGlobVacantUpto"><span class="command">lemma</span></span> spec_imp_SafeStickyGlobVacantUpto<span class="main">:</span> <span class="quoted"><span class="quoted">"spec <span class="free">s</span> <span class="main">⟹</span> alw SafeStickyGlobVacantUpto <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> spec_imp_SafeStickyGlobVacantUpto_aux<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spec_imp_inv1<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alw_InvGlobalRecordCount<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alw_InvGlobalIncomingInfoUpright<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alw_InvGlobalInfoAtBetaUpright<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spec_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">SafeGlobMono</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">SafeGlobMono</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="bound">t</span><span class="main">.</span> GlobVacantUpto <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="bound">p</span> <span class="bound">t</span> <span class="main">⟶</span> GlobVacantUpto <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="bound">p</span> <span class="bound">t</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Exchange_Abadi-alw_SafeGlobMono"><span class="command">lemma</span></span> alw_SafeGlobMono<span class="main">:</span> <span class="quoted"><span class="quoted">"spec <span class="free">s</span> <span class="main">⟹</span> alw <span class="main">(</span>relates SafeGlobMono<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> spec_imp_SafeStickyGlobVacantUpto<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> alw_mono<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> SafeStickyGlobVacantUpto_def SafeGlobMono_def relates_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="Exchange">
<div class="head">
<h1>Theory Exchange</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Exchange Protocol\label{sec:exchange}›</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Exchange
  <span class="keyword2"><span class="keyword">imports</span></span>
    <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/While_Combinator.html">HOL-Library.While_Combinator</a>"</span>
    <a href="#Auxiliary">Auxiliary</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Specification›</span></span>

<span class="keyword1"><span class="command">record</span></span> <span class="main">(</span><span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">)</span> configuration <span class="main">=</span>
  c_temp <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'p</span> <span class="main">⇒</span> <span class="tfree">'t</span> zmultiset"</span></span>
  c_msg <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'p</span> <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> <span class="tfree">'t</span> zmultiset list"</span></span>
  c_glob <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'p</span> <span class="main">⇒</span> <span class="tfree">'t</span> zmultiset"</span></span>
  c_caps <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'p</span> <span class="main">⇒</span> <span class="tfree">'t</span> zmultiset"</span></span>
  c_data_msg <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span> <span class="main">×</span> <span class="tfree">'t</span><span class="main">)</span> multiset"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
Description of the configuration:
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"c_msg <span class="free"><span class="free">c</span></span> <span class="free"><span class="free">p</span></span> <span class="free"><span class="free">q</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> global, all progress messages currently in-flight from p to q
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"c_data_msg <span class="free"><span class="free">c</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> global, capabilities carried by in-flight data messages
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"c_temp <span class="free"><span class="free">c</span></span> <span class="free"><span class="free">p</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> local, aggregated progress updates of worker p that haven't been sent yet
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"c_glob <span class="free"><span class="free">c</span></span> <span class="free"><span class="free">p</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> local, worker p's conservative approximation of all capabilities in the system
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"c_caps <span class="free"><span class="free">c</span></span> <span class="free"><span class="free">p</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> local, worker p's capabilities

global = state of the whole system to which no worker has access
local = state that is kept locally by each worker and which it can access
›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">)</span> computation <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">)</span> configuration stream"</span></span>

<span class="keyword1"><span class="command">context</span></span> order <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">timestamps</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">≡</span> <span class="main">{#</span> <span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">t</span><span class="main">)</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">#}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">vacant_upto</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> zmultiset <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">vacant_upto</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟶</span> zcount <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">s</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">nonpos_upto</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> zmultiset <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nonpos_upto</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟶</span> zcount <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">s</span> <span class="main">≤</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">supported</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> zmultiset <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">supported</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∃</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∧</span> zcount <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">supported_strong</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> zmultiset <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">supported_strong</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∃</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∧</span> zcount <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∧</span> nonpos_upto <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">s</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">justified</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">justified</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="bound">t</span> <span class="main">⟶</span> supported <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="bound">t</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="bound">t'</span><span class="main">)</span> <span class="main">∨</span> zcount <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="bound">t</span> <span class="main">&lt;</span> zcount <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="bound">t</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Exchange-justified_alt"><span class="command">lemma</span></span> justified_alt<span class="main">:</span>
  <span class="quoted"><span class="quoted">"justified <span class="free">C</span> <span class="free">M</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="bound">t</span> <span class="main">⟶</span> supported_strong <span class="free">M</span> <span class="bound">t</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="bound">t'</span><span class="main">)</span> <span class="main">∨</span> zcount <span class="free">M</span> <span class="bound">t</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> justified_def supported_def supported_strong_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> order_zmset_exists_foundation'<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> t s
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">s</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">meson</span> le_less_trans less_le_trans nonpos_upto_def<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> order.strict_trans2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> order.order_iff_strict <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">justified_with</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">justified_with</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="bound">t</span> <span class="main">⟶</span>
       <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">s</span></span><span class="main">&lt;</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span>zcount <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∨</span> zcount <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span>
       <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">s</span></span><span class="main">&lt;</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="bound">s</span><span class="main">)</span> <span class="main">∨</span>
       zcount <span class="main">(</span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">+</span><span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">)</span> <span class="bound">t</span> <span class="main">&lt;</span> zcount <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="bound">t</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Exchange-justified_with_alt"><span class="command">lemma</span></span> justified_with_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"justified_with <span class="free">C</span> <span class="free">M</span> <span class="free">N</span> <span class="main">=</span>
  <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="bound">t</span> <span class="main">⟶</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">s</span></span><span class="main">&lt;</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span>zcount <span class="free">M</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∨</span> zcount <span class="free">N</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">s'</span></span><span class="main">&lt;</span><span class="bound">s</span><span class="main">.</span> zcount <span class="free">M</span> <span class="bound">s'</span> <span class="main">≤</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">s</span></span><span class="main">&lt;</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∨</span>
    zcount <span class="main">(</span><span class="free">M</span><span class="main">+</span><span class="free">N</span><span class="main">)</span> <span class="bound">t</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> justified_with_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> order_zmset_exists_foundation'<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> t s
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">s</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
    <span class="keyword1"><span class="command">using</span></span> order.strict_trans order.strict_trans2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> add_less_zeroD order.order_iff_strict not_less_iff_gr_or_eq order_class.order.strict_trans<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">PositiveImplies</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">PositiveImplies</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">t</span><span class="main">.</span> zcount <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="bound">t</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟶</span> zcount <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="bound">t</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>

<span class="comment1">― ‹A worker can mint capabilities greater or equal to any owned capability›</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">minting_self</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">minting_self</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">∈#</span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">t'</span></span><span class="main">≤</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="bound">t'</span><span class="main">)</span>"</span></span>

<span class="comment1">― ‹Sending messages mints a capability at a strictly greater pointstamp›</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">minting_msg</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">minting_msg</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">t</span><span class="main">)</span><span class="main">∈#</span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="bound">t'</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">records</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">records</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">p</span><span class="main">∈</span>UNIV<span class="main">.</span> c_caps <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">p</span><span class="main">)</span> <span class="main">+</span> timestamps <span class="main">(</span>zmset_of <span class="main">(</span>c_data_msg <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">InfoAt</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">InfoAt</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">0</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">&lt;</span> length <span class="main">(</span>c_msg <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">(</span>c_msg <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">else</span> <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">IncomingInfo</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> configuration <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> <span class="tfree">'a</span> zmultiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">IncomingInfo</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">≡</span> sum_list <span class="main">(</span>drop <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span>c_msg <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> c_temp <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">GlobalIncomingInfo</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span> <span class="main">::</span> finite<span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> configuration <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> <span class="tfree">'a</span> zmultiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">GlobalIncomingInfo</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">≡</span> <span class="main">∑</span><span class="bound">p'</span> <span class="main">∈</span> UNIV<span class="main">.</span> IncomingInfo <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">p'</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="bound">p'</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span>"</span></span>

<span class="comment1">(* (GlobalIncomingInfo c 0 q q) sums up all info incoming at q *)</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">GlobalIncomingInfoAt</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">GlobalIncomingInfoAt</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">≡</span> GlobalIncomingInfo <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">init_config</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span> <span class="main">::</span> finite<span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> configuration <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">init_config</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≡</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span> c_temp <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">p</span> <span class="main">=</span> <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">p1</span> <span class="bound">p2</span><span class="main">.</span> c_msg <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">p1</span> <span class="bound">p2</span> <span class="main">=</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∧</span>
      <span class="comment1">― ‹Capabilities have non-negative multiplicities›</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> zcount <span class="main">(</span>c_caps <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">p</span><span class="main">)</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span>
      <span class="comment1">― ‹The pointstamps in glob are exactly those in <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">records</span><span class="antiquote">}</span></span>›</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span> c_glob <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">p</span> <span class="main">=</span> records <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">∧</span>
      <span class="comment1">― ‹All capabilities are being tracked›</span>
      c_data_msg <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">{#}</span>"</span></span>

<span class="comment1">(* Processor receives a capability, i.e. in timely: receives a data message *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">next_recvcap'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span> <span class="main">::</span> finite<span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> configuration <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> configuration <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">next_recvcap'</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span>
      <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">∈#</span> c_data_msg <span class="free"><span class="bound"><span class="entity">c0</span></span></span>
    <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span><span class="main">⦇</span>c_caps <span class="main">:=</span> <span class="main">(</span>c_caps <span class="free"><span class="bound"><span class="entity">c0</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">:=</span> c_caps <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">+</span> <span class="main">{#</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="keyword1">#}<span class="hidden">⇩</span><sub>z</sub></span><span class="main">)</span><span class="main">,</span>
              c_data_msg <span class="main">:=</span> c_data_msg <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="main">-</span> <span class="main">{#</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">#}</span><span class="main">⦈</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">next_recvcap</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">next_recvcap</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">p</span> <span class="bound">t</span><span class="main">.</span> next_recvcap' <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="bound">p</span> <span class="bound">t</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
Can minting of capabilities be described as a refinement of the Abadi model?
Short answer: No, not in general.
Long answer:
Could slightly modify Abadi model, such that a capability always comes with a multiplicity $2^64$ (or
similar, could be parametrized over arbitrarily large constant). In that case minting new
capabilities can be described as an upright change, dropping one of the capabilities, to make the
change upright. This only works as long as no capability is required more than the constant number
of times.
Issues:
- Not fully general, due to the arbitrary constant
- Not clear whether refinement proofs would be easier than simply altering the model to support the operations
›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Rationale for the condition on <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"c_caps <span class="free"><span class="free">c0</span></span> <span class="free"><span class="free">p</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>:
In Abadi, the operation <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">next_performop'</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> has the premise <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">∀</span></span><span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">.</span></span> int <span class="main"><span class="main">(</span></span>count <span class="free"><span class="free">Δneg</span></span> <span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">≤</span></span> zcount <span class="main"><span class="main">(</span></span>records <span class="free"><span class="free">c0</span></span><span class="main"><span class="main">)</span></span> <span class="bound"><span class="bound">t</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
(records corresponds to the global field <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">nrec</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> in that model)
which means the processor performing the transition must verify that this condition is met.
Since <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"records <span class="free"><span class="free">c</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is "global" state, which no processor can know, an implementation of
this protocol has to include some other protocol or reasoning for when it is safe to do this
transition.

Naively using a processor's <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"c_glob <span class="free"><span class="free">c</span></span> <span class="free"><span class="free">p</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to approximate <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"records <span class="free"><span class="free">c</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and justify
transitions can cause a race condition, where a processor drops a pointstamp, e.g.,
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">Δneg</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">{#</span></span><span class="free"><span class="free">t</span></span><span class="main"><span class="main">#}</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, after which <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main"><span class="main">(</span></span>records <span class="free"><span class="free">c</span></span><span class="main"><span class="main">)</span></span> <span class="free"><span class="free">t</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">0</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> but other processors might still
use the pointstamp to justify the creation of pointstamps that violate the safety property.

Instead we model ownership of pointstamps, calling "owned pointstamps" <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator">❙</span></span>‹capabilities›</span></span>, which are
tracked in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"c_caps <span class="free"><span class="free">c</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. In place of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">nrec</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> we define <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"records <span class="free"><span class="free">c</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, which is the sum of
all capabilities, as well as <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"c_data_msg <span class="free"><span class="free">c</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, which contains the capabilities carried by data
messages. Since <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">∀</span></span><span class="bound"><span class="bound">p</span></span> <span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">.</span></span> zcount <span class="main"><span class="main">(</span></span>c_caps <span class="free"><span class="free">c</span></span> <span class="bound"><span class="bound">p</span></span><span class="main"><span class="main">)</span></span> <span class="bound"><span class="bound">t</span></span> <span class="main"><span class="main">≤</span></span> zcount <span class="main"><span class="main">(</span></span>records <span class="free"><span class="free">c</span></span><span class="main"><span class="main">)</span></span> <span class="bound"><span class="bound">t</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, our condition
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">∀</span></span><span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">.</span></span> int <span class="main"><span class="main">(</span></span>count <span class="free"><span class="free">Δneg</span></span> <span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">≤</span></span> zcount <span class="main"><span class="main">(</span></span>c_caps <span class="free"><span class="free">c0</span></span> <span class="free"><span class="free">p</span></span><span class="main"><span class="main">)</span></span> <span class="bound"><span class="bound">t</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> implies the one on <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">nrec</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> in Abadi's model.
›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Conditions in performop:

The performop transition takes three msets of pointstamps, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Δneg</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Δmint_msg</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Δmint_self</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Δneg</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> contains dropped capabilities (a subset of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">c_caps</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>)
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Δmint_msg</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> contains pairs <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="free"><span class="free">p</span></span><span class="main"><span class="main">,</span></span><span class="free"><span class="free">t</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, where a data message is sent (i.e. capability added to the pool), creating a capability at t, owned by p
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Δmint_self</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> contains pointstamps minted and owned by worker <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">p</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>

<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Δneg</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> in combination with <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Δmint_msg</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> also allows any upright updates to be made as in the Abadi model,
meaning this definition allows strictly more behaviors.

The <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">Δmint_msg</span></span> <span class="main"><span class="main">≠</span></span> <span class="main"><span class="main">{#}</span></span> <span class="main"><span class="main">∨</span></span> zmset_of <span class="free"><span class="free">Δmint_self</span></span> <span class="main"><span class="main">-</span></span> zmset_of <span class="free"><span class="free">Δneg</span></span> <span class="main"><span class="main">≠</span></span> <span class="keyword1"><span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> condition ensures that
no-ops aren't possible. However, it's still possible that the combined <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Δ</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is empty. E.g. a processor
has capabilities 1 and 2, uses cap 1 to send a message, minting capability 2. Simultaneously it
drops a capability 2 (for unrelated reasons), cancelling out the overall change but shifting a
capability to the pool, possibly with a different owner than itself.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">next_performop'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span><span class="main">::</span>finite<span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> configuration <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> configuration <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> <span class="tfree">'a</span> multiset <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'p</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> multiset <span class="main">⇒</span> <span class="tfree">'a</span> multiset <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">next_performop'</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">Δneg</span></span></span> <span class="free"><span class="bound"><span class="entity">Δmint_msg</span></span></span> <span class="free"><span class="bound"><span class="entity">Δmint_self</span></span></span> <span class="main">=</span>
    <span class="comment1">― ‹<span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">Δpos</span></span><span class="antiquote">}</span></span> contains all positive changes, <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">Δ</span></span><span class="antiquote">}</span></span> the combined positive and negative changes›</span>
   <span class="main">(</span><span class="keyword1">let</span> <span class="bound">Δpos</span> <span class="main">=</span> timestamps <span class="main">(</span>zmset_of <span class="free"><span class="bound"><span class="entity">Δmint_msg</span></span></span><span class="main">)</span> <span class="main">+</span> zmset_of <span class="free"><span class="bound"><span class="entity">Δmint_self</span></span></span><span class="main">;</span>
        <span class="bound">Δ</span> <span class="main">=</span> <span class="bound">Δpos</span> <span class="main">-</span> zmset_of <span class="free"><span class="bound"><span class="entity">Δneg</span></span></span>
    <span class="keyword1">in</span>
      <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Δmint_msg</span></span></span> <span class="main">≠</span> <span class="main">{#}</span> <span class="main">∨</span> zmset_of <span class="free"><span class="bound"><span class="entity">Δmint_self</span></span></span> <span class="main">-</span> zmset_of <span class="free"><span class="bound"><span class="entity">Δneg</span></span></span> <span class="main">≠</span> <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span><span class="main">)</span>
    <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">.</span> int <span class="main">(</span>count <span class="free"><span class="bound"><span class="entity">Δneg</span></span></span> <span class="bound">t</span><span class="main">)</span> <span class="main">≤</span> zcount <span class="main">(</span>c_caps <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="bound">t</span><span class="main">)</span>
    <span class="comment1">― ‹Pointstamps added in <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">Δmint_self</span></span><span class="antiquote">}</span></span> are minted at p›</span>
    <span class="main">∧</span> minting_self <span class="main">(</span>c_caps <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Δmint_self</span></span></span>
    <span class="comment1">― ‹Pointstamps added in <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">Δmint_msg</span></span><span class="antiquote">}</span></span> correspond to sent data messages›</span>
    <span class="main">∧</span> minting_msg <span class="main">(</span>c_caps <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Δmint_msg</span></span></span>
    <span class="comment1">― ‹Worker immediately knows about dropped and minted capabilities›</span>
    <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span><span class="main">⦇</span>c_caps <span class="main">:=</span> <span class="main">(</span>c_caps <span class="free"><span class="bound"><span class="entity">c0</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">:=</span> c_caps <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">+</span> zmset_of <span class="free"><span class="bound"><span class="entity">Δmint_self</span></span></span> <span class="main">-</span> zmset_of <span class="free"><span class="bound"><span class="entity">Δneg</span></span></span><span class="main">)</span><span class="main">,</span>
    <span class="comment1">― ‹Sending a data message creates a capability, once that message arrives. This is modelled as
        a pool of capabilities that may (will) appear at processors at some point.›</span>
              c_data_msg <span class="main">:=</span> c_data_msg <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">Δmint_msg</span></span></span><span class="main">,</span>
              c_temp <span class="main">:=</span> <span class="main">(</span>c_temp <span class="free"><span class="bound"><span class="entity">c0</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">:=</span> c_temp <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">+</span> <span class="bound">Δ</span><span class="main">)</span><span class="main">⦈</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">next_performop</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">next_performop</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∃</span><span class="bound">p</span> <span class="bound">Δneg</span> <span class="bound">Δmint_msg</span> <span class="bound">Δmint_self</span><span class="main">.</span> next_performop' <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="bound">p</span> <span class="bound">Δneg</span> <span class="bound">Δmint_msg</span> <span class="bound">Δmint_self</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">next_sendupd'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span><span class="main">::</span>finite<span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> configuration <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> configuration <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">next_sendupd'</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">tt</span></span></span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">let</span> <span class="bound">γ</span> <span class="main">=</span> <span class="main">{#</span><span class="bound">t</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> c_temp <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">tt</span></span></span><span class="main">#}</span> <span class="keyword1">in</span>
      <span class="bound">γ</span> <span class="main">≠</span> <span class="main">0</span>
    <span class="main">∧</span> justified <span class="main">(</span>c_caps <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">(</span>c_temp <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">-</span> <span class="bound">γ</span><span class="main">)</span>
    <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span><span class="main">⦇</span>c_msg <span class="main">:=</span> <span class="main">(</span>c_msg <span class="free"><span class="bound"><span class="entity">c0</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">:=</span> <span class="main">λ</span><span class="bound">q</span><span class="main">.</span> c_msg <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">q</span> <span class="main">@</span> <span class="main">[</span><span class="bound">γ</span><span class="main">]</span><span class="main">)</span><span class="main">,</span>
              c_temp <span class="main">:=</span> <span class="main">(</span>c_temp <span class="free"><span class="bound"><span class="entity">c0</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">:=</span> c_temp <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">-</span> <span class="bound">γ</span><span class="main">)</span><span class="main">⦈</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">next_sendupd</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">next_sendupd</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∃</span><span class="bound">p</span> <span class="bound">tt</span><span class="main">.</span> next_sendupd' <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="bound">p</span> <span class="bound">tt</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">next_recvupd'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span><span class="main">::</span>finite<span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> configuration <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> configuration <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">next_recvupd'</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">≡</span>
      c_msg <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">≠</span> <span class="main">[]</span>
    <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span><span class="main">⦇</span>c_msg <span class="main">:=</span> <span class="main">(</span>c_msg <span class="free"><span class="bound"><span class="entity">c0</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">:=</span> <span class="main">(</span>c_msg <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">:=</span> tl <span class="main">(</span>c_msg <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
              c_glob <span class="main">:=</span> <span class="main">(</span>c_glob <span class="free"><span class="bound"><span class="entity">c0</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">:=</span> c_glob <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">+</span> hd <span class="main">(</span>c_msg <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">next_recvupd</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">next_recvupd</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∃</span><span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> next_recvupd' <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="bound">p</span> <span class="bound">q</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted">"<span class="entity">next'</span>"</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">next'</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">=</span> <span class="main">(</span>next_performop <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">∨</span> next_sendupd <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">∨</span> next_recvupd <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">∨</span> next_recvcap <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted">"<span class="entity">next</span>"</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">next</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> next' <span class="main">(</span>shd <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">(</span>shd <span class="main">(</span>stl <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">spec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span> <span class="main">::</span> finite<span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> computation <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">spec</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> holds init_config <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∧</span> alw next <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">GlobVacantUpto</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">GlobVacantUpto</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> vacant_upto <span class="main">(</span>c_glob <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">GlobNonposUpto</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">GlobNonposUpto</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> nonpos_upto <span class="main">(</span>c_glob <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">RecordsVacantUpto</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">RecordsVacantUpto</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> vacant_upto <span class="main">(</span>records <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">SafeGlobVacantUptoImpliesStickyNrec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span> <span class="main">::</span> finite<span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> computation <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">SafeGlobVacantUptoImpliesStickyNrec</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">let</span> <span class="bound">c</span> <span class="main">=</span> shd <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">in</span> <span class="main">∀</span><span class="bound">t</span> <span class="bound">q</span><span class="main">.</span> GlobVacantUpto <span class="bound">c</span> <span class="bound">q</span> <span class="bound">t</span> <span class="main">⟶</span> alw <span class="main">(</span>holds <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> RecordsVacantUpto <span class="bound">c</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Auxiliary Lemmas›</span></span>

<span class="keyword1" id="Exchange-finite_induct_select"><span class="command">lemma</span></span> finite_induct_select <span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> empty select<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">{}</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> select<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">T</span><span class="main">.</span> finite <span class="bound">T</span> <span class="main">⟹</span> <span class="bound">T</span> <span class="main">⊂</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">T</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">s</span><span class="main">∈</span><span class="free">S</span> <span class="main">-</span> <span class="bound">T</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>insert <span class="bound">s</span> <span class="bound">T</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">S</span> <span class="main">∧</span> finite <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">S</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct_select<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> empty select<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Exchange-finite_induct_decompose_sum"><span class="command">lemma</span></span> finite_induct_decompose_sum<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'c</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">::</span> comm_monoid_add<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∈</span><span class="free">X</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">Z</span><span class="main">.</span> <span class="free">B</span> <span class="main">(</span>sum <span class="free">f</span> <span class="bound">Z</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">Z</span><span class="main">.</span> <span class="free">A</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">B</span> <span class="main">(</span>sum <span class="free">f</span> <span class="bound">Z</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="main">+</span> sum <span class="free">f</span> <span class="bound">Z</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">Z</span><span class="main">.</span> <span class="free">B</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">(</span>sum <span class="free">f</span> <span class="bound">Z</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="main">+</span> sum <span class="free">f</span> <span class="bound">Z</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>3<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">X</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct_select<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum.insert_remove<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> T
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="skolem">T</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> psubset_imp_ex_mem<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> z
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> bexI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">z</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">z</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">T</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">THEN</span> spec<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">{</span></span><span class="skolem"><span class="skolem">z</span></span><span class="main"><span class="main">}</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> bspec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">x</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> assms<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Exchange-minting_msg_add_records"><span class="command">lemma</span></span> minting_msg_add_records<span class="main">:</span> <span class="quoted"><span class="quoted">"minting_msg <span class="free">C1</span> <span class="free">M</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> zcount <span class="free">C2</span> <span class="bound">t</span> <span class="main">⟹</span> minting_msg <span class="main">(</span><span class="free">C1</span><span class="main">+</span><span class="free">C2</span><span class="main">)</span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> minting_msg_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> add_strict_increasing <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bspec<span class="main">)</span>

<span class="keyword1" id="Exchange-add_less"><span class="command">lemma</span></span> add_less<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">::</span>int<span class="main">)</span> <span class="main">&lt;</span> <span class="free">c</span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">≤</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">+</span> <span class="free">b</span> <span class="main">&lt;</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>

<span class="keyword1" id="Exchange-disj3_split"><span class="command">lemma</span></span> disj3_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">∨</span> <span class="free">Q</span> <span class="main">∨</span> <span class="free">R</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">P</span> <span class="main">⟹</span> <span class="free">thesis</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">¬</span> <span class="free">P</span> <span class="main">∧</span> <span class="free">Q</span> <span class="main">⟹</span> <span class="free">thesis</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">¬</span> <span class="free">P</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="free">Q</span> <span class="main">⟹</span> <span class="free">R</span> <span class="main">⟹</span> <span class="free">thesis</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">thesis</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Exchange-filter_zmset_conclude_predicate"><span class="command">lemma</span></span> filter_zmset_conclude_predicate<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">{#</span> <span class="bound">x</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">M</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">#}</span> <span class="free">x</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1" id="Exchange-alw_holds2"><span class="command">lemma</span></span> alw_holds2<span class="main">:</span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>holds <span class="free">P</span><span class="main">)</span> <span class="free">ss</span> <span class="main">=</span> <span class="main">(</span><span class="free">P</span> <span class="main">(</span>shd <span class="free">ss</span><span class="main">)</span> <span class="main">∧</span> alw <span class="main">(</span>holds <span class="free">P</span><span class="main">)</span> <span class="main">(</span>stl <span class="free">ss</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> alw.simps holds.elims<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> holds.elims<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="Exchange-zmset_of_remove1_mset"><span class="command">lemma</span></span> zmset_of_remove1_mset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈#</span> <span class="free">M</span> <span class="main">⟹</span> zmset_of <span class="main">(</span>remove1_mset <span class="free">x</span> <span class="free">M</span><span class="main">)</span> <span class="main">=</span> zmset_of <span class="free">M</span> <span class="main">-</span> <span class="main">{#</span><span class="free">x</span><span class="keyword1">#}<span class="hidden">⇩</span><sub>z</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">M</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Exchange-timestamps_zmset_of_pair_image"><span class="command">lemma</span></span> timestamps_zmset_of_pair_image<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"timestamps <span class="main">(</span>zmset_of <span class="main">{#</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈#</span> <span class="free">M</span> <span class="main">#}</span><span class="main">)</span> <span class="main">=</span> zmset_of <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">M</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Exchange-timestamps_image_zmset_fst"><span class="command">lemma</span></span> timestamps_image_zmset_fst<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"timestamps <span class="main">{#</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">M</span> <span class="main">#}</span> <span class="main">=</span> timestamps <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> equiv_zmset_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> case_prod_unfold image_mset_cong prod.collapse prod.inject<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Exchange-lift_invariant_to_spec"><span class="command">lemma</span></span> lift_invariant_to_spec<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">c</span><span class="main">.</span> init_config <span class="bound">c</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">c</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> holds <span class="free">P</span> <span class="bound">s</span> <span class="main">⟹</span> next <span class="bound">s</span> <span class="main">⟹</span> nxt <span class="main">(</span>holds <span class="free">P</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"spec <span class="free">s</span> <span class="main">⟹</span> alw <span class="main">(</span>holds <span class="free">P</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> spec_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> conjE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">sa</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> configuration stream"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"init_config <span class="main">(</span>shd <span class="skolem">sa</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> a2<span class="main">:</span> <span class="quoted"><span class="quoted">"alw next <span class="skolem">sa</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> alw <span class="main">(</span>holds <span class="free">P</span><span class="main">)</span> <span class="main">(</span>stl <span class="skolem">sa</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> alw <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> holds <span class="free">P</span> <span class="bound">s</span> <span class="main">⟶</span> nxt <span class="main">(</span>holds <span class="free">P</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span> <span class="skolem">sa</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> a1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> alw.cases alw_invar assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> holds.elims<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"init_config <span class="main">(</span>shd <span class="main">(</span>stl <span class="skolem">sa</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> a2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> alw_iff_sdrop assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Exchange-timestamps_sum_distrib"><span class="command">lemma</span></span> timestamps_sum_distrib<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">p</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> timestamps <span class="main">(</span><span class="free">f</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> timestamps <span class="main">(</span><span class="main">∑</span><span class="bound">p</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">A</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> infinite_finite_induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Exchange-timestamps_zmset_of"><span class="command">lemma</span></span> timestamps_zmset_of<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"timestamps <span class="main">(</span>zmset_of <span class="free">M</span><span class="main">)</span> <span class="main">=</span> zmset_of <span class="main">{#</span> <span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">t</span><span class="main">)</span> <span class="main">∈#</span> <span class="free">M</span> <span class="main">#}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">M</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Exchange-vacant_upto_add"><span class="command">lemma</span></span> vacant_upto_add<span class="main">:</span> <span class="quoted"><span class="quoted">"vacant_upto <span class="free">a</span> <span class="free">t</span> <span class="main">⟹</span> vacant_upto <span class="free">b</span> <span class="free">t</span> <span class="main">⟹</span> vacant_upto <span class="main">(</span><span class="free">a</span><span class="main">+</span><span class="free">b</span><span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vacant_upto_def<span class="main">)</span>

<span class="keyword1" id="Exchange-nonpos_upto_add"><span class="command">lemma</span></span> nonpos_upto_add<span class="main">:</span> <span class="quoted"><span class="quoted">"nonpos_upto <span class="free">a</span> <span class="free">t</span> <span class="main">⟹</span> nonpos_upto <span class="free">b</span> <span class="free">t</span> <span class="main">⟹</span> nonpos_upto <span class="main">(</span><span class="free">a</span><span class="main">+</span><span class="free">b</span><span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> add_nonpos_nonpos <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nonpos_upto_def<span class="main">)</span>

<span class="keyword1" id="Exchange-nonzero_lt_gtD"><span class="command">lemma</span></span> nonzero_lt_gtD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">n</span><span class="main">::</span><span class="main">_</span><span class="main">::</span>linorder<span class="main">)</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">∨</span> <span class="free">n</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Exchange-zero_lt_diff"><span class="command">lemma</span></span> zero_lt_diff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">0</span><span class="main">::</span>int<span class="main">)</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="main">-</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Exchange-zero_lt_add_disj"><span class="command">lemma</span></span> zero_lt_add_disj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">a</span><span class="main">::</span>int<span class="main">)</span> <span class="main">+</span> <span class="free">b</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">a</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">b</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="main">∨</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Transition lemmas›</span></span>

<span class="keyword1" id="Exchange-next_performopD"><span class="command">lemma</span></span> next_performopD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"next_performop' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="free">Δneg</span> <span class="free">Δmint_msg</span> <span class="free">Δmint_self</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">Δmint_msg</span> <span class="main">≠</span> <span class="main">{#}</span> <span class="main">∨</span> zmset_of <span class="free">Δmint_self</span> <span class="main">-</span> zmset_of <span class="free">Δneg</span> <span class="main">≠</span> <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">.</span> int <span class="main">(</span>count <span class="free">Δneg</span> <span class="bound">t</span><span class="main">)</span> <span class="main">≤</span> zcount <span class="main">(</span>c_caps <span class="free">c0</span> <span class="free">p</span><span class="main">)</span> <span class="bound">t</span>"</span></span>
    <span class="quoted"><span class="quoted">"minting_self <span class="main">(</span>c_caps <span class="free">c0</span> <span class="free">p</span><span class="main">)</span> <span class="free">Δmint_self</span>"</span></span>
    <span class="quoted"><span class="quoted">"minting_msg <span class="main">(</span>c_caps <span class="free">c0</span> <span class="free">p</span><span class="main">)</span> <span class="free">Δmint_msg</span>"</span></span>
    <span class="quoted"><span class="quoted">"c_temp <span class="free">c1</span> <span class="main">=</span> <span class="main">(</span>c_temp <span class="free">c0</span><span class="main">)</span><span class="main">(</span><span class="free">p</span> <span class="main">:=</span> c_temp <span class="free">c0</span> <span class="free">p</span> <span class="main">+</span> <span class="main">(</span>timestamps <span class="main">(</span>zmset_of <span class="free">Δmint_msg</span><span class="main">)</span> <span class="main">+</span> zmset_of <span class="free">Δmint_self</span> <span class="main">-</span> zmset_of <span class="free">Δneg</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"c_msg <span class="free">c1</span>  <span class="main">=</span> c_msg <span class="free">c0</span>"</span></span>
    <span class="quoted"><span class="quoted">"c_glob <span class="free">c1</span> <span class="main">=</span> c_glob <span class="free">c0</span>"</span></span>
    <span class="quoted"><span class="quoted">"c_data_msg <span class="free">c1</span> <span class="main">=</span> c_data_msg <span class="free">c0</span> <span class="main">+</span> <span class="free">Δmint_msg</span>"</span></span>
    <span class="quoted"><span class="quoted">"c_caps <span class="free">c1</span> <span class="main">=</span> <span class="main">(</span>c_caps <span class="free">c0</span><span class="main">)</span><span class="main">(</span><span class="free">p</span> <span class="main">:=</span> c_caps <span class="free">c0</span> <span class="free">p</span> <span class="main">+</span> <span class="main">(</span>zmset_of <span class="free">Δmint_self</span> <span class="main">-</span> zmset_of <span class="free">Δneg</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next_performop'_def Let_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>

<span class="keyword1" id="Exchange-next_performop_complexD"><span class="command">lemma</span></span> next_performop_complexD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"next_performop' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="free">Δneg</span> <span class="free">Δmint_msg</span> <span class="free">Δmint_self</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"records <span class="free">c1</span> <span class="main">=</span> records <span class="free">c0</span> <span class="main">+</span> <span class="main">(</span>timestamps <span class="main">(</span>zmset_of <span class="free">Δmint_msg</span><span class="main">)</span> <span class="main">+</span> zmset_of <span class="free">Δmint_self</span> <span class="main">-</span> zmset_of <span class="free">Δneg</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"GlobalIncomingInfoAt <span class="free">c1</span> <span class="free">q</span> <span class="main">=</span> GlobalIncomingInfoAt <span class="free">c0</span> <span class="free">q</span> <span class="main">+</span> <span class="main">(</span>timestamps <span class="main">(</span>zmset_of <span class="free">Δmint_msg</span><span class="main">)</span> <span class="main">+</span> zmset_of <span class="free">Δmint_self</span> <span class="main">-</span> zmset_of <span class="free">Δneg</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"IncomingInfo <span class="free">c1</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">p'</span> <span class="main">=</span> <span class="free">p</span>
      <span class="keyword1">then</span> IncomingInfo <span class="free">c0</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q</span> <span class="main">+</span> <span class="main">(</span>timestamps <span class="main">(</span>zmset_of <span class="free">Δmint_msg</span><span class="main">)</span> <span class="main">+</span> zmset_of <span class="free">Δmint_self</span> <span class="main">-</span> zmset_of <span class="free">Δneg</span><span class="main">)</span>
      <span class="keyword1">else</span> IncomingInfo <span class="free">c0</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="free">t</span><span class="main">.</span> zcount <span class="main">(</span>c_caps <span class="free">c0</span> <span class="free">p</span><span class="main">)</span> <span class="bound">t'</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> zcount <span class="main">(</span>timestamps <span class="main">(</span>zmset_of <span class="free">Δmint_msg</span><span class="main">)</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="quoted"><span class="quoted">"InfoAt <span class="free">c1</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q</span> <span class="main">=</span> InfoAt <span class="free">c0</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Δ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"timestamps <span class="main">(</span>zmset_of <span class="free">Δmint_msg</span><span class="main">)</span> <span class="main">+</span> zmset_of <span class="free">Δmint_self</span> <span class="main">-</span> zmset_of <span class="free">Δneg</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> change <span class="main">=</span> next_performopD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span></span></span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"records <span class="free">c1</span> <span class="main">=</span> records <span class="free">c0</span> <span class="main">+</span> <span class="var">?Δ</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> records_def change
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> add_diff_eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> sum_if_distrib_add<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> zmset_of_plus<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"IncomingInfo <span class="free">c1</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">p'</span> <span class="main">=</span> <span class="free">p</span>
      <span class="keyword1">then</span> IncomingInfo <span class="free">c0</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q</span> <span class="main">+</span> <span class="main">(</span>timestamps <span class="main">(</span>zmset_of <span class="free">Δmint_msg</span><span class="main">)</span> <span class="main">+</span> zmset_of <span class="free">Δmint_self</span> <span class="main">-</span> zmset_of <span class="free">Δneg</span><span class="main">)</span>
      <span class="keyword1">else</span> IncomingInfo <span class="free">c0</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> IncomingInfo_def change
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"GlobalIncomingInfoAt <span class="free">c1</span> <span class="skolem">q</span> <span class="main">=</span> GlobalIncomingInfoAt <span class="free">c0</span> <span class="skolem">q</span> <span class="main">+</span> <span class="var">?Δ</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">q</span>
    <span class="keyword1"><span class="command">unfolding</span></span> GlobalIncomingInfo_def IncomingInfo_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Sum_eq_pick_changed_elem<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> m <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">p</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> change <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> zcount <span class="main">(</span>c_caps <span class="free">c0</span> <span class="free">p</span><span class="main">)</span> <span class="bound">t'</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> zcount <span class="main">(</span>timestamps <span class="main">(</span>zmset_of <span class="free">Δmint_msg</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> image_zmset_pre change<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> minting_msg_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"InfoAt <span class="free">c1</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q</span> <span class="main">=</span> InfoAt <span class="free">c0</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> InfoAt_def change <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Exchange-next_sendupdD"><span class="command">lemma</span></span> next_sendupdD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"next_sendupd' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="free">tt</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="bound">t</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> c_temp <span class="free">c0</span> <span class="free">p</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free">tt</span><span class="main">#}</span> <span class="main">≠</span> <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span>"</span></span>
    <span class="quoted"><span class="quoted">"justified <span class="main">(</span>c_caps <span class="free">c0</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span>c_temp <span class="free">c0</span> <span class="free">p</span> <span class="main">-</span> <span class="main">{#</span><span class="bound">t</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> c_temp <span class="free">c0</span> <span class="free">p</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free">tt</span><span class="main">#}</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"c_temp <span class="free">c1</span> <span class="free">p'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">p'</span> <span class="main">=</span> <span class="free">p</span> <span class="keyword1">then</span> c_temp <span class="free">c0</span> <span class="free">p</span> <span class="main">-</span> <span class="main">{#</span><span class="bound">t</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> c_temp <span class="free">c0</span> <span class="free">p</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free">tt</span><span class="main">#}</span> <span class="keyword1">else</span> c_temp <span class="free">c0</span> <span class="free">p'</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"c_msg <span class="free">c1</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p'</span> <span class="bound">q</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">p'</span> <span class="main">=</span> <span class="free">p</span> <span class="keyword1">then</span> c_msg <span class="free">c0</span> <span class="free">p</span> <span class="bound">q</span> <span class="main">@</span> <span class="main">[</span><span class="main">{#</span><span class="bound">t</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> c_temp <span class="free">c0</span> <span class="free">p</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free">tt</span><span class="main">#}</span><span class="main">]</span> <span class="keyword1">else</span> c_msg <span class="free">c0</span> <span class="bound">p'</span> <span class="bound">q</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"c_glob <span class="free">c1</span> <span class="main">=</span> c_glob <span class="free">c0</span>"</span></span>
    <span class="quoted"><span class="quoted">"c_caps <span class="free">c1</span> <span class="main">=</span> c_caps <span class="free">c0</span>"</span></span>
    <span class="quoted"><span class="quoted">"c_data_msg <span class="free">c1</span> <span class="main">=</span> c_data_msg <span class="free">c0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next_sendupd'_def Let_def fun_eq_iff<span class="main">)</span>

<span class="keyword1" id="Exchange-next_sendupd_complexD"><span class="command">lemma</span></span> next_sendupd_complexD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"next_sendupd' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="free">tt</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"records <span class="free">c1</span> <span class="main">=</span> records <span class="free">c0</span>"</span></span>
    <span class="quoted"><span class="quoted">"IncomingInfo <span class="free">c1</span> <span class="main">0</span> <span class="main">=</span> IncomingInfo <span class="free">c0</span> <span class="main">0</span>"</span></span>
    <span class="quoted"><span class="quoted">"IncomingInfo <span class="free">c1</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">p'</span> <span class="main">=</span> <span class="free">p</span> <span class="main">∧</span> length <span class="main">(</span>c_msg <span class="free">c0</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">k</span>
                               <span class="keyword1">then</span> IncomingInfo <span class="free">c0</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q</span> <span class="main">-</span> <span class="main">{#</span><span class="bound">t</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> c_temp <span class="free">c0</span> <span class="free">p'</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free">tt</span><span class="main">#}</span>
                               <span class="keyword1">else</span> IncomingInfo <span class="free">c0</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> length <span class="main">(</span>c_msg <span class="free">c0</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="main">⟹</span> IncomingInfo <span class="free">c1</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q</span> <span class="main">=</span> IncomingInfo <span class="free">c0</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q</span>"</span></span>
    <span class="quoted"><span class="quoted">"length <span class="main">(</span>c_msg <span class="free">c0</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">k</span> <span class="main">⟹</span>
     IncomingInfo <span class="free">c1</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">p'</span> <span class="main">=</span> <span class="free">p</span>
                               <span class="keyword1">then</span> IncomingInfo <span class="free">c0</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q</span> <span class="main">-</span> <span class="main">{#</span><span class="bound">t</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> c_temp <span class="free">c0</span> <span class="free">p'</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free">tt</span><span class="main">#}</span>
                               <span class="keyword1">else</span> IncomingInfo <span class="free">c0</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"GlobalIncomingInfoAt <span class="free">c1</span> <span class="free">q</span> <span class="main">=</span> GlobalIncomingInfoAt <span class="free">c0</span> <span class="free">q</span>"</span></span>
    <span class="quoted"><span class="quoted">"InfoAt <span class="free">c1</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">p'</span> <span class="main">=</span> <span class="free">p</span> <span class="main">∧</span> <span class="free">k</span> <span class="main">=</span> length <span class="main">(</span>c_msg <span class="free">c0</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">{#</span><span class="bound">t</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> c_temp <span class="free">c0</span> <span class="free">p'</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free">tt</span><span class="main">#}</span> <span class="keyword1">else</span> InfoAt <span class="free">c0</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> change <span class="main">=</span> next_sendupdD<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"records <span class="free">c1</span> <span class="main">=</span> records <span class="free">c0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> records_def change<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> ii<span class="main">:</span> <span class="quoted"><span class="quoted">"IncomingInfo <span class="free">c1</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">p'</span> <span class="main">=</span> <span class="free">p</span> <span class="main">∧</span> length <span class="main">(</span>c_msg <span class="free">c0</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">k</span>
                                      <span class="keyword1">then</span> IncomingInfo <span class="free">c0</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q</span> <span class="main">-</span> <span class="main">{#</span><span class="bound">t</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> c_temp <span class="free">c0</span> <span class="free">p'</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free">tt</span><span class="main">#}</span>
                                      <span class="keyword1">else</span> IncomingInfo <span class="free">c0</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> IncomingInfo_def change<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> length <span class="main">(</span>c_msg <span class="free">c0</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="main">⟹</span> IncomingInfo <span class="free">c1</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q</span> <span class="main">=</span> IncomingInfo <span class="free">c0</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> ii <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>c_msg <span class="free">c0</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">k</span> <span class="main">⟹</span>
     IncomingInfo <span class="free">c1</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">p'</span> <span class="main">=</span> <span class="free">p</span>
                               <span class="keyword1">then</span> IncomingInfo <span class="free">c0</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q</span> <span class="main">-</span> <span class="main">{#</span><span class="bound">t</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> c_temp <span class="free">c0</span> <span class="free">p'</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free">tt</span><span class="main">#}</span>
                               <span class="keyword1">else</span> IncomingInfo <span class="free">c0</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"IncomingInfo <span class="free">c1</span> <span class="main">0</span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="main">=</span> IncomingInfo <span class="free">c0</span> <span class="main">0</span> <span class="skolem">p</span> <span class="skolem">q</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span> <span class="skolem">q</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> IncomingInfo_def change<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"IncomingInfo <span class="free">c1</span> <span class="main">0</span> <span class="main">=</span> IncomingInfo <span class="free">c0</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"GlobalIncomingInfoAt <span class="free">c1</span> <span class="free">q</span> <span class="main">=</span> GlobalIncomingInfoAt <span class="free">c0</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> GlobalIncomingInfo_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"InfoAt <span class="free">c1</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">p'</span> <span class="main">=</span> <span class="free">p</span> <span class="main">∧</span> <span class="free">k</span> <span class="main">=</span> length <span class="main">(</span>c_msg <span class="free">c0</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">{#</span><span class="bound">t</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> c_temp <span class="free">c0</span> <span class="free">p'</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free">tt</span><span class="main">#}</span> <span class="keyword1">else</span> InfoAt <span class="free">c0</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> InfoAt_def change
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Exchange-next_recvupdD"><span class="command">lemma</span></span> next_recvupdD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"next_recvupd' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"c_msg <span class="free">c0</span> <span class="free">p</span> <span class="free">q</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
    <span class="quoted"><span class="quoted">"c_temp <span class="free">c1</span> <span class="main">=</span> c_temp <span class="free">c0</span>"</span></span>
    <span class="quoted"><span class="quoted">"c_msg <span class="free">c1</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p'</span> <span class="bound">q'</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">p'</span> <span class="main">=</span> <span class="free">p</span> <span class="main">∧</span> <span class="bound">q'</span> <span class="main">=</span> <span class="free">q</span> <span class="keyword1">then</span> tl <span class="main">(</span>c_msg <span class="free">c0</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="keyword1">else</span> c_msg <span class="free">c0</span> <span class="bound">p'</span> <span class="bound">q'</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"c_glob <span class="free">c1</span> <span class="main">=</span> <span class="main">(</span>c_glob <span class="free">c0</span><span class="main">)</span><span class="main">(</span><span class="free">q</span> <span class="main">:=</span> c_glob <span class="free">c0</span> <span class="free">q</span> <span class="main">+</span> hd <span class="main">(</span>c_msg <span class="free">c0</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"c_caps <span class="free">c1</span> <span class="main">=</span> c_caps <span class="free">c0</span>"</span></span>
    <span class="quoted"><span class="quoted">"c_data_msg <span class="free">c1</span> <span class="main">=</span> c_data_msg <span class="free">c0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next_recvupd'_def fun_eq_iff<span class="main">)</span>

<span class="keyword1" id="Exchange-next_recvupd_complexD"><span class="command">lemma</span></span> next_recvupd_complexD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"next_recvupd' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"records <span class="free">c1</span> <span class="main">=</span> records <span class="free">c0</span>"</span></span>
    <span class="quoted"><span class="quoted">"IncomingInfo <span class="free">c1</span> <span class="main">0</span> <span class="free">p'</span> <span class="free">q'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">p'</span> <span class="main">=</span> <span class="free">p</span> <span class="main">∧</span> <span class="free">q'</span> <span class="main">=</span> <span class="free">q</span> <span class="keyword1">then</span> IncomingInfo <span class="free">c0</span> <span class="main">0</span> <span class="free">p'</span> <span class="free">q'</span> <span class="main">-</span> hd <span class="main">(</span>c_msg <span class="free">c0</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="keyword1">else</span> IncomingInfo <span class="free">c0</span> <span class="main">0</span> <span class="free">p'</span> <span class="free">q'</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"IncomingInfo <span class="free">c1</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">p'</span> <span class="main">=</span> <span class="free">p</span> <span class="main">∧</span> <span class="free">q'</span> <span class="main">=</span> <span class="free">q</span>
                                <span class="keyword1">then</span> IncomingInfo <span class="free">c0</span> <span class="main">(</span><span class="free">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">p'</span> <span class="free">q'</span>
                                <span class="keyword1">else</span> IncomingInfo <span class="free">c0</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q'</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"GlobalIncomingInfoAt <span class="free">c1</span> <span class="free">q'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">q'</span> <span class="main">=</span> <span class="free">q</span> <span class="keyword1">then</span> GlobalIncomingInfoAt <span class="free">c0</span> <span class="free">q'</span> <span class="main">-</span> hd <span class="main">(</span>c_msg <span class="free">c0</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="keyword1">else</span> GlobalIncomingInfoAt <span class="free">c0</span> <span class="free">q'</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"InfoAt <span class="free">c1</span> <span class="free">k</span> <span class="free">p</span> <span class="free">q</span> <span class="main">=</span> InfoAt <span class="free">c0</span> <span class="main">(</span><span class="free">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
    <span class="quoted"><span class="quoted">"InfoAt <span class="free">c1</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">p'</span> <span class="main">=</span> <span class="free">p</span> <span class="main">∧</span> <span class="free">q'</span> <span class="main">=</span> <span class="free">q</span> <span class="keyword1">then</span> InfoAt <span class="free">c0</span> <span class="main">(</span><span class="free">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">p</span> <span class="free">q</span> <span class="keyword1">else</span> InfoAt <span class="free">c0</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> change <span class="main">=</span> next_recvupdD<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"records <span class="free">c1</span> <span class="main">=</span> records <span class="free">c0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> records_def change<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> ii<span class="main">:</span> <span class="quoted"><span class="quoted">"IncomingInfo <span class="free">c1</span> <span class="main">0</span> <span class="skolem">p'</span> <span class="skolem">q'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">p'</span> <span class="main">=</span> <span class="free">p</span> <span class="main">∧</span> <span class="skolem">q'</span> <span class="main">=</span> <span class="free">q</span> <span class="keyword1">then</span> IncomingInfo <span class="free">c0</span> <span class="main">0</span> <span class="skolem">p'</span> <span class="skolem">q'</span> <span class="main">-</span> hd <span class="main">(</span>c_msg <span class="free">c0</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="keyword1">else</span> IncomingInfo <span class="free">c0</span> <span class="main">0</span> <span class="skolem">p'</span> <span class="skolem">q'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p'</span> <span class="skolem">q'</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> IncomingInfo_def change <span class="dynamic"><span class="dynamic">algebra_simps</span></span> sum_list_hd_tl<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"IncomingInfo <span class="free">c1</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">p'</span> <span class="main">=</span> <span class="free">p</span> <span class="main">∧</span> <span class="free">q'</span> <span class="main">=</span> <span class="free">q</span>
                                   <span class="keyword1">then</span> IncomingInfo <span class="free">c0</span> <span class="main">(</span><span class="free">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">p'</span> <span class="free">q'</span>
                                   <span class="keyword1">else</span> IncomingInfo <span class="free">c0</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>  IncomingInfo_def change <span class="dynamic"><span class="dynamic">algebra_simps</span></span> sum_list_hd_tl drop_Suc<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"GlobalIncomingInfoAt <span class="free">c1</span> <span class="free">q'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">q'</span> <span class="main">=</span> <span class="free">q</span> <span class="keyword1">then</span> GlobalIncomingInfoAt <span class="free">c0</span> <span class="free">q'</span> <span class="main">-</span> hd <span class="main">(</span>c_msg <span class="free">c0</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="keyword1">else</span> GlobalIncomingInfoAt <span class="free">c0</span> <span class="free">q'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> GlobalIncomingInfo_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">q'</span><span class="main">=</span><span class="free">q</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> diff_conv_add_uminus<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> Sum_eq_pick_changed_elem<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> m <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">p</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ii<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"InfoAt <span class="free">c1</span> <span class="free">k</span> <span class="free">p</span> <span class="free">q</span> <span class="main">=</span> InfoAt <span class="free">c0</span> <span class="main">(</span><span class="free">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> InfoAt_def change
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_tl<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"InfoAt <span class="free">c1</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">p'</span> <span class="main">=</span> <span class="free">p</span> <span class="main">∧</span> <span class="free">q'</span> <span class="main">=</span> <span class="free">q</span> <span class="keyword1">then</span> InfoAt <span class="free">c0</span> <span class="main">(</span><span class="free">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">p</span> <span class="free">q</span> <span class="keyword1">else</span> InfoAt <span class="free">c0</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> InfoAt_def change
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_tl<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Exchange-next_recvcapD"><span class="command">lemma</span></span> next_recvcapD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"next_recvcap' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span><span class="main">,</span><span class="free">t</span><span class="main">)</span> <span class="main">∈#</span> c_data_msg <span class="free">c0</span>"</span></span>
    <span class="quoted"><span class="quoted">"c_temp <span class="free">c1</span> <span class="main">=</span> c_temp <span class="free">c0</span>"</span></span>
    <span class="quoted"><span class="quoted">"c_msg <span class="free">c1</span> <span class="main">=</span> c_msg <span class="free">c0</span>"</span></span>
    <span class="quoted"><span class="quoted">"c_glob <span class="free">c1</span> <span class="main">=</span> c_glob <span class="free">c0</span>"</span></span>
    <span class="quoted"><span class="quoted">"c_caps <span class="free">c1</span> <span class="main">=</span> <span class="main">(</span>c_caps <span class="free">c0</span><span class="main">)</span><span class="main">(</span><span class="free">p</span> <span class="main">:=</span> c_caps <span class="free">c0</span> <span class="free">p</span> <span class="main">+</span> <span class="main">{#</span><span class="free">t</span><span class="keyword1">#}<span class="hidden">⇩</span><sub>z</sub></span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"c_data_msg <span class="free">c1</span> <span class="main">=</span> c_data_msg <span class="free">c0</span> <span class="main">-</span> <span class="main">{#</span><span class="main">(</span><span class="free">p</span><span class="main">,</span><span class="free">t</span><span class="main">)</span><span class="main">#}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next_recvcap'_def<span class="main">)</span>

<span class="keyword1" id="Exchange-next_recvcap_complexD"><span class="command">lemma</span></span> next_recvcap_complexD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"next_recvcap' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"records <span class="free">c1</span> <span class="main">=</span> records <span class="free">c0</span>"</span></span>
    <span class="quoted"><span class="quoted">"IncomingInfo <span class="free">c1</span> <span class="main">=</span> IncomingInfo <span class="free">c0</span>"</span></span>
    <span class="quoted"><span class="quoted">"GlobalIncomingInfo <span class="free">c1</span> <span class="main">=</span> GlobalIncomingInfo <span class="free">c0</span>"</span></span>
    <span class="quoted"><span class="quoted">"InfoAt <span class="free">c1</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q</span> <span class="main">=</span> InfoAt <span class="free">c0</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> change <span class="main">=</span> next_recvcapD<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"records <span class="free">c1</span> <span class="main">=</span> records <span class="free">c0</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> records_def change fun_upd_apply
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> sum_if_distrib_add<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> change<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zmset_of_remove1_mset <span class="dynamic"><span class="dynamic">algebra_simps</span></span> records_def change<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"IncomingInfo <span class="free">c1</span> <span class="main">=</span> IncomingInfo <span class="free">c0</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> IncomingInfo_def change <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"GlobalIncomingInfo <span class="free">c1</span> <span class="main">=</span> GlobalIncomingInfo <span class="free">c0</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> GlobalIncomingInfo_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"InfoAt <span class="free">c1</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q</span> <span class="main">=</span> InfoAt <span class="free">c0</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> InfoAt_def change <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Exchange-ex_next_recvupd"><span class="command">lemma</span></span> ex_next_recvupd<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"c_msg <span class="free">c0</span> <span class="free">p</span> <span class="free">q</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">c1</span><span class="main">.</span> next_recvupd' <span class="free">c0</span> <span class="bound">c1</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> next_recvupd'_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span>
      exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free"><span class="free">c0</span></span></span><span class="main"><span class="main"><span class="main">⦇</span></span></span>c_msg <span class="main"><span class="main"><span class="main">:=</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span><span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">p'</span></span></span> <span class="bound"><span class="bound"><span class="bound">q'</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="keyword1"><span class="keyword1"><span class="keyword1">if</span></span></span> <span class="bound"><span class="bound"><span class="bound">p'</span></span></span> <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="free"><span class="free"><span class="free">p</span></span></span> <span class="main"><span class="main"><span class="main">∧</span></span></span> <span class="bound"><span class="bound"><span class="bound">q'</span></span></span> <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="free"><span class="free"><span class="free">q</span></span></span> <span class="keyword1"><span class="keyword1"><span class="keyword1">then</span></span></span> tl <span class="main"><span class="main"><span class="main">(</span></span></span>c_msg <span class="free"><span class="free"><span class="free">c0</span></span></span> <span class="free"><span class="free"><span class="free">p</span></span></span> <span class="free"><span class="free"><span class="free">q</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span> <span class="keyword1"><span class="keyword1"><span class="keyword1">else</span></span></span> c_msg <span class="free"><span class="free"><span class="free">c0</span></span></span> <span class="bound"><span class="bound"><span class="bound">p'</span></span></span> <span class="bound"><span class="bound"><span class="bound">q'</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span>
                   c_glob <span class="main"><span class="main"><span class="main">:=</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span><span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">q'</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="keyword1"><span class="keyword1"><span class="keyword1">if</span></span></span> <span class="bound"><span class="bound"><span class="bound">q'</span></span></span> <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="free"><span class="free"><span class="free">q</span></span></span> <span class="keyword1"><span class="keyword1"><span class="keyword1">then</span></span></span> c_glob <span class="free"><span class="free"><span class="free">c0</span></span></span> <span class="free"><span class="free"><span class="free">q</span></span></span> <span class="main"><span class="main"><span class="main">+</span></span></span> hd <span class="main"><span class="main"><span class="main">(</span></span></span>c_msg <span class="free"><span class="free"><span class="free">c0</span></span></span> <span class="free"><span class="free"><span class="free">p</span></span></span> <span class="free"><span class="free"><span class="free">q</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span> <span class="keyword1"><span class="keyword1"><span class="keyword1">else</span></span></span> c_glob <span class="free"><span class="free"><span class="free">c0</span></span></span> <span class="bound"><span class="bound"><span class="bound">q'</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">⦈</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Facts about <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">justified</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>'ness›</span></span>

<span class="keyword1" id="Exchange-justified_empty"><span class="command">lemma</span></span> justified_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"justified <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span> <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> justified_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹It's sufficient to show justified for least pointstamps in M.›</span></span>
<span class="keyword1" id="Exchange-justified_leastI"><span class="command">lemma</span></span> justified_leastI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="bound">t</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="bound">t</span><span class="main">.</span> zcount <span class="free">M</span> <span class="bound">t'</span> <span class="main">≤</span> <span class="main">0</span><span class="main">)</span> <span class="main">⟶</span> supported_strong <span class="free">M</span> <span class="bound">t</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="bound">t'</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span>zcount <span class="free">M</span> <span class="bound">t</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"justified <span class="free">C</span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> justified_alt supported_strong_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> order_zmset_exists_foundation<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> t' s
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> supported_strong_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ccontr<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> disj3_split<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI1<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> order.strict_trans2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI2<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> disjI1<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> order.strict_trans2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nonpos_upto_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> le_less_linear linear le_imp_less_or_eq preorder_class.le_less_trans<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Exchange-justified_add"><span class="command">lemma</span></span> justified_add<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"justified <span class="free">C1</span> <span class="free">M1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"justified <span class="free">C2</span> <span class="free">M2</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> zcount <span class="free">C1</span> <span class="bound">t</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> zcount <span class="free">C2</span> <span class="bound">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"justified <span class="main">(</span><span class="free">C1</span><span class="main">+</span><span class="free">C2</span><span class="main">)</span> <span class="main">(</span><span class="free">M1</span><span class="main">+</span><span class="free">M2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> justified_leastI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> t
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M1</span> <span class="skolem">t</span>"</span></span><span class="main">)</span> <span class="comment1">(* symmetric cases *)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> justified_alt supported_strong_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> disj3_split<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> order_zmset_exists_foundation_neg<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s s' <span class="comment1">(* anything less than s' is 0 in M1 *)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span><span class="free">M1</span> <span class="main">+</span> <span class="free">M2</span><span class="main">)</span> <span class="skolem">s'</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI1<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">s'</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nonpos_upto_def supported_strong_def<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> not_less<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M2</span> <span class="skolem">s'</span>"</span></span><span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="comment1">(* trivial contradiction *)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> justified_alt supported_strong_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> disj3_split<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI1<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s''
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">s''</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nonpos_upto_def supported_strong_def add_nonpos_neg<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI2<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> disjI1<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s''
                  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_nonneg_pos <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">s''</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.right_neutral add_strict_increasing2 assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> less_add_same_cancel1 order.strict_trans1 pos_add_strict zcount_union<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.commute add_mono_thms_linordered_field<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> add_0 zcount_union<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"supported_strong <span class="free">M2</span> <span class="skolem">t</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI1<span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> justified_alt<span class="main">]</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> supported_strong_def<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> supported_strong_def<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span>
          <span class="keyword1"><span class="command">unfolding</span></span> not_ex
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">s</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> add_nonpos_neg<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> order.strict_trans1 less_imp_le not_le not_less_iff_gr_or_eq order_class.order.strict_trans2 supported_strong_def<span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nonpos_upto_def<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">C2</span> <span class="bound">t'</span>"</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_cancel_left_left assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> order_class.order.not_eq_order_implies_strict zcount_union<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> disjI2<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
            <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> justified_alt<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> add.commute add_cancel_left_right add_mono_thms_linordered_field<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> add_strict_increasing2 assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> nonzero_lt_gtD<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M2</span> <span class="skolem">t</span>"</span></span><span class="main">)</span> <span class="comment1">(* symmetric case *)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> justified_alt supported_strong_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> disj3_split<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> order_zmset_exists_foundation_neg<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s s' <span class="comment1">(* anything less than s' is 0 in M1 *)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span><span class="free">M1</span> <span class="main">+</span> <span class="free">M2</span><span class="main">)</span> <span class="skolem">s'</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI1<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">s'</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nonpos_upto_def supported_strong_def<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> not_less<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M1</span> <span class="skolem">s'</span>"</span></span><span class="main">)</span>
               <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="comment1">(* trivial contradiction *)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> justified_alt supported_strong_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> disj3_split<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI1<span class="main">)</span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE<span class="main">)</span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s''
                    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">s''</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nonpos_upto_def supported_strong_def add_neg_nonpos<span class="main">)</span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI2<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> disjI1<span class="main">)</span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s''
                    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_pos_nonneg <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">s''</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI2<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> disjI1<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">s'</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main">)</span>
                  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> add_pos_nonneg<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_mono_thms_linordered_field<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> add_0 zcount_union<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"supported_strong <span class="free">M1</span> <span class="skolem">t</span>"</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI1<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> supported_strong_def<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nonpos_upto_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">s</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> justified_alt nonpos_upto_def supported_strong_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span>
                assms<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> less_add_same_cancel1 order.strict_trans2 less_imp_le not_less order_class.order.not_eq_order_implies_strict order_class.order.strict_implies_order<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">C1</span> <span class="bound">t'</span>"</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.commute add_cancel_left_left assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> order_class.order.not_eq_order_implies_strict zcount_union<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> disjI2<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> add.commute add_strict_increasing2 assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> not_le sublist_order.add_less zcount_union<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Exchange-justified_sum"><span class="command">lemma</span></span> justified_sum<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">∈</span><span class="free">P</span><span class="main">.</span> justified <span class="main">(</span><span class="free">f</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">∈</span><span class="free">P</span><span class="main">.</span> <span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> zcount <span class="main">(</span><span class="free">f</span> <span class="bound">p</span><span class="main">)</span> <span class="bound">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"justified <span class="main">(</span><span class="main">∑</span><span class="bound">p</span><span class="main">∈</span><span class="free">P</span><span class="main">.</span> <span class="free">f</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="main">∑</span><span class="bound">p</span><span class="main">∈</span><span class="free">P</span><span class="main">.</span> <span class="free">g</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">P</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> infinite_finite_induct<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> justified_add sum_nonneg <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zcount_sum<span class="main">)</span>

<span class="keyword1" id="Exchange-justified_add_records"><span class="command">lemma</span></span> justified_add_records<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"justified <span class="free">C</span> <span class="free">M</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> zcount <span class="free">C'</span> <span class="bound">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"justified <span class="main">(</span><span class="free">C</span><span class="main">+</span><span class="free">C'</span><span class="main">)</span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> justified_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> add_pos_nonneg<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> add.commute add_strict_increasing2 assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Exchange-justified_add_zmset_records"><span class="command">lemma</span></span> justified_add_zmset_records<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"justified <span class="free">C</span> <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"justified <span class="main">(</span>add_zmset <span class="free">t</span> <span class="free">C</span><span class="main">)</span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> add_zmset_add_single<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> justified_add_records<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Exchange-justified_diff"><span class="command">lemma</span></span> justified_diff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"justified <span class="free">C</span> <span class="free">M</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> zcount <span class="free">C</span> <span class="bound">t</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">.</span> count <span class="free">Δ</span> <span class="bound">t</span> <span class="main">≤</span> zcount <span class="free">C</span> <span class="bound">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"justified <span class="main">(</span><span class="free">C</span> <span class="main">-</span> zmset_of <span class="free">Δ</span><span class="main">)</span> <span class="main">(</span><span class="free">M</span> <span class="main">-</span> zmset_of <span class="free">Δ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> justified_leastI allI impI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span>
  <span class="keyword3"><span class="command">assume</span></span> least<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> zcount <span class="main">(</span><span class="free">M</span> <span class="main">-</span> zmset_of <span class="free">Δ</span><span class="main">)</span> <span class="bound">t'</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span><span class="free">M</span> <span class="main">-</span> zmset_of <span class="free">Δ</span><span class="main">)</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> Mt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> justified_alt<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> Mt<span class="main">]</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"supported_strong <span class="free">M</span> <span class="skolem">t</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="bound">t'</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"zcount <span class="free">M</span> <span class="skolem">t</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"supported_strong <span class="main">(</span><span class="free">M</span> <span class="main">-</span> zmset_of <span class="free">Δ</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span><span class="free">C</span> <span class="main">-</span> zmset_of <span class="free">Δ</span><span class="main">)</span> <span class="bound">t'</span><span class="main">)</span> <span class="main">∨</span> zcount <span class="main">(</span><span class="free">M</span> <span class="main">-</span> zmset_of <span class="free">Δ</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">&lt;</span> zcount <span class="main">(</span><span class="free">C</span> <span class="main">-</span> zmset_of <span class="free">Δ</span><span class="main">)</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> supported_strong_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> disjI1 exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">s</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nonpos_upto_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">&lt;</span> <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">s'</span></span><span class="main">&lt;</span><span class="skolem">s</span><span class="main">.</span> zcount <span class="free">C</span> <span class="bound">s'</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">atomize_elim</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> order_zmset_exists_foundation'<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> t' s
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">s</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s'
          <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">s'</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">consider</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span><span class="free">C</span> <span class="main">-</span> zmset_of <span class="free">Δ</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="main">|</span>
      <span class="quoted"><span class="quoted">"zcount <span class="main">(</span><span class="free">C</span> <span class="main">-</span> zmset_of <span class="free">Δ</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span><span class="free">M</span> <span class="main">-</span> zmset_of <span class="free">Δ</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="main">|</span>
      <span class="quoted"><span class="quoted">"zcount <span class="main">(</span><span class="free">C</span> <span class="main">-</span> zmset_of <span class="free">Δ</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span><span class="free">M</span> <span class="main">-</span> zmset_of <span class="free">Δ</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span>
      <span class="quoted"><span class="quoted">"zcount <span class="main">(</span><span class="free">C</span> <span class="main">-</span> zmset_of <span class="free">Δ</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span><span class="free">M</span> <span class="main">-</span> zmset_of <span class="free">Δ</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">case</span></span> 1
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> s <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> s least <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nonpos_upto_def supported_strong_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 3
      <span class="keyword1"><span class="command">note</span></span> case3 <span class="main">=</span> 3
      <span class="keyword1"><span class="command">with</span></span> s<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> Ms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_less<span class="main">)</span>
      <span class="keyword1"><span class="command">note</span></span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> justified_alt<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> Ms<span class="main">]</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"supported_strong <span class="free">M</span> <span class="skolem">s</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="skolem">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="bound">t'</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"zcount <span class="free">M</span> <span class="skolem">s</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> not_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
        <span class="keyword3"><span class="command">case</span></span> 1
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> supported_strong_def
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s'
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> disjI1 exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">s'</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">using</span></span> s<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">s'</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nonpos_upto_def<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> s<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> 3
        <span class="keyword1"><span class="command">from</span></span> case3 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zcount <span class="free">C</span> <span class="skolem">s</span> <span class="main">=</span> zcount <span class="free">M</span> <span class="skolem">s</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> 3 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 4
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> least s<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 3
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Exchange-justified_add_msg_delta"><span class="command">lemma</span></span> justified_add_msg_delta<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"justified <span class="free">C</span> <span class="free">M</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"minting_msg <span class="free">C</span> <span class="free">Δ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> zcount <span class="free">C</span> <span class="bound">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"justified <span class="free">C</span> <span class="main">(</span><span class="free">M</span> <span class="main">+</span> timestamps <span class="main">(</span>zmset_of <span class="free">Δ</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI justified_leastI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span>
  <span class="keyword3"><span class="command">assume</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span><span class="free">M</span> <span class="main">+</span> timestamps <span class="main">(</span>zmset_of <span class="free">Δ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> least<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> zcount <span class="main">(</span><span class="free">M</span> <span class="main">+</span> timestamps <span class="main">(</span>zmset_of <span class="free">Δ</span><span class="main">)</span><span class="main">)</span> <span class="bound">t'</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> Δt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>timestamps <span class="main">(</span>zmset_of <span class="free">Δ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">⟹</span> supported_strong <span class="main">(</span><span class="free">M</span> <span class="main">+</span> timestamps <span class="main">(</span>zmset_of <span class="free">Δ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="bound">t'</span><span class="main">)</span> <span class="main">∨</span> zcount <span class="main">(</span><span class="free">M</span> <span class="main">+</span> timestamps <span class="main">(</span>zmset_of <span class="free">Δ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> pos_image_zmset_obtain_pre<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> minting_msg_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> Δt<span class="main">:</span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>timestamps <span class="main">(</span>zmset_of <span class="free">Δ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> t <span class="keyword1"><span class="command">have</span></span> Mt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">note</span></span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> justified_alt<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> Mt<span class="main">]</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">consider</span></span>
      <span class="quoted"><span class="quoted">"supported_strong <span class="free">M</span> <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> zcount <span class="free">C</span> <span class="bound">t'</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"zcount <span class="free">M</span> <span class="skolem">t</span> <span class="main">≥</span> zcount <span class="free">C</span> <span class="skolem">t</span>"</span></span> <span class="main">|</span>
      <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="bound">t'</span>"</span></span> <span class="main">|</span>
      <span class="quoted"><span class="quoted">"zcount <span class="free">M</span> <span class="skolem">t</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> not_less assms<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> order_class.order.not_eq_order_implies_strict<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supported_strong <span class="main">(</span><span class="free">M</span> <span class="main">+</span> timestamps <span class="main">(</span>zmset_of <span class="free">Δ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="bound">t'</span><span class="main">)</span> <span class="main">∨</span> zcount <span class="main">(</span><span class="free">M</span> <span class="main">+</span> timestamps <span class="main">(</span>zmset_of <span class="free">Δ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">case</span></span> 1
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">&lt;</span> <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"zcount <span class="free">M</span> <span class="skolem">s</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">s'</span></span><span class="main">&lt;</span><span class="skolem">s</span><span class="main">.</span> zcount <span class="free">M</span> <span class="bound">s'</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> supported_strong_def
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">atomize_elim</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> order_zmset_exists_foundation_neg'<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s s'
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">s'</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nonpos_upto_def order_class.antisym<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">s'</span></span><span class="main">≤</span><span class="skolem">s</span><span class="main">.</span> zcount <span class="main">(</span>timestamps <span class="main">(</span>zmset_of <span class="free">Δ</span><span class="main">)</span><span class="main">)</span> <span class="bound">s'</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s'
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> pos_image_zmset_obtain_pre<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> minting_msg_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> supported_strong_def<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> disjI1 exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">s</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">unfolding</span></span> not_less
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> le_less_linear least eq_refl order.strict_trans1 nonpos_upto_def supported_strong_def sublist_order.add_less zcount_union<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 3
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> Δt <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"supported_strong <span class="main">(</span><span class="free">M</span> <span class="main">+</span> timestamps <span class="main">(</span>zmset_of <span class="free">Δ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="bound">t'</span><span class="main">)</span> <span class="main">∨</span> zcount <span class="main">(</span><span class="free">M</span> <span class="main">+</span> timestamps <span class="main">(</span>zmset_of <span class="free">Δ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>timestamps <span class="main">(</span>zmset_of <span class="free">Δ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">≤</span> <span class="main">0</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Δt<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Exchange-justified_add_same"><span class="command">lemma</span></span> justified_add_same<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"justified <span class="free">C</span> <span class="free">M</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"minting_self <span class="free">C</span> <span class="free">Δ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> zcount <span class="free">C</span> <span class="bound">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"justified <span class="main">(</span><span class="free">C</span> <span class="main">+</span> zmset_of <span class="free">Δ</span><span class="main">)</span> <span class="main">(</span><span class="free">M</span> <span class="main">+</span> zmset_of <span class="free">Δ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI justified_leastI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span>
  <span class="keyword3"><span class="command">assume</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span><span class="free">M</span> <span class="main">+</span> zmset_of <span class="free">Δ</span><span class="main">)</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> least<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> zcount <span class="main">(</span><span class="free">M</span> <span class="main">+</span> zmset_of <span class="free">Δ</span><span class="main">)</span> <span class="bound">t'</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> t <span class="keyword1"><span class="command">consider</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="skolem">t</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>zmset_of <span class="free">Δ</span><span class="main">)</span> <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"zcount <span class="free">M</span> <span class="skolem">t</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_less count_inI<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"supported_strong <span class="main">(</span><span class="free">M</span> <span class="main">+</span> zmset_of <span class="free">Δ</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span><span class="free">C</span> <span class="main">+</span> zmset_of <span class="free">Δ</span><span class="main">)</span> <span class="bound">t'</span><span class="main">)</span> <span class="main">∨</span> zcount <span class="main">(</span><span class="free">M</span> <span class="main">+</span> zmset_of <span class="free">Δ</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">&lt;</span> zcount <span class="main">(</span><span class="free">C</span> <span class="main">+</span> zmset_of <span class="free">Δ</span><span class="main">)</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">note</span></span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> justified_alt<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> 1<span class="main">]</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">consider</span></span>
      <span class="quoted"><span class="quoted">"supported_strong <span class="free">M</span> <span class="skolem">t</span>"</span></span> <span class="main">|</span>
      <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="bound">t'</span>"</span></span> <span class="main">|</span>
      <span class="quoted"><span class="quoted">"zcount <span class="free">M</span> <span class="skolem">t</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">case</span></span> 1
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> supported_strong_def
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> t'
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">s</span></span><span class="main">≤</span><span class="skolem">t'</span><span class="main">.</span> zcount <span class="main">(</span>zmset_of <span class="free">Δ</span><span class="main">)</span> <span class="bound">s</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> minting_self_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">meson</span> add_pos_nonneg order.ordering_axioms of_nat_0_le_iff ordering.strict_trans1<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> disjI1 exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">t'</span></span></span></span><span class="main"><span class="main">]</span></span> conjI<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> add_cancel_right_left add_mono_thms_linordered_field<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> count_eq_zero_iff order.order_iff_strict of_nat_eq_0_iff<span class="main">)</span>
            <span class="keyword1"><span class="command">using</span></span> least nonpos_upto_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 3
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword">where</span></span> t'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">≤</span> <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="skolem">t'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> minting_self_def<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span><span class="main">=</span><span class="skolem">t</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI2<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> disjI1<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> order.not_eq_order_implies_strict <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Facts about <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">justified_with</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>'ness›</span></span>

<span class="keyword1" id="Exchange-justified_with_add_records"><span class="command">lemma</span></span> justified_with_add_records<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"justified_with <span class="free">C1</span> <span class="free">M</span> <span class="free">N</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> zcount <span class="free">C2</span> <span class="bound">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"justified_with <span class="main">(</span><span class="free">C1</span><span class="main">+</span><span class="free">C2</span><span class="main">)</span> <span class="free">M</span> <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> justified_with_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> t
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> justified_with_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI2<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> disjI1<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> disjI2<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Exchange-justified_with_leastI"><span class="command">lemma</span></span> justified_with_leastI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="bound">t</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="bound">t</span><span class="main">.</span> zcount <span class="free">M</span> <span class="bound">t'</span> <span class="main">≤</span> <span class="main">0</span><span class="main">)</span> <span class="main">⟶</span>
       <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">s</span></span><span class="main">&lt;</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span>zcount <span class="free">M</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∨</span> zcount <span class="free">N</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">s'</span></span><span class="main">&lt;</span><span class="bound">s</span><span class="main">.</span> zcount <span class="free">M</span> <span class="bound">s'</span> <span class="main">≤</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span>
       <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">s</span></span><span class="main">&lt;</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∨</span>
       zcount <span class="main">(</span><span class="free">M</span><span class="main">+</span><span class="free">N</span><span class="main">)</span> <span class="bound">t</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"justified_with <span class="free">C</span> <span class="free">M</span> <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> justified_with_alt
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span>
  <span class="keyword3"><span class="command">assume</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> t <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword">where</span></span> t'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">≤</span> <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="skolem">t'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">s</span></span><span class="main">&lt;</span><span class="skolem">t'</span><span class="main">.</span> zcount <span class="free">M</span> <span class="bound">s</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span> <span class="main">(</span><span class="operator">drule</span> order_zmset_exists_foundation'<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> assms<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> t'<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">with</span></span> t'<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">consider</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">s</span></span><span class="main">&lt;</span><span class="skolem">t'</span><span class="main">.</span> <span class="main">(</span>zcount <span class="free">M</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∨</span> zcount <span class="free">N</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">s'</span></span><span class="main">&lt;</span><span class="bound">s</span><span class="main">.</span> zcount <span class="free">M</span> <span class="bound">s'</span> <span class="main">≤</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">s</span></span><span class="main">&lt;</span><span class="skolem">t'</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="bound">s</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"zcount <span class="main">(</span><span class="free">M</span><span class="main">+</span><span class="free">N</span><span class="main">)</span> <span class="skolem">t'</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="skolem">t'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> not_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">s</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> <span class="main">(</span>zcount <span class="free">M</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∨</span> zcount <span class="free">N</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">s'</span></span><span class="main">&lt;</span><span class="bound">s</span><span class="main">.</span> zcount <span class="free">M</span> <span class="bound">s'</span> <span class="main">≤</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">s</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∨</span> zcount <span class="main">(</span><span class="free">M</span><span class="main">+</span><span class="free">N</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> order.strict_trans2 t'<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> order.strict_trans2 t'<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 3
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">consider</span></span>
      <span class="quoted"><span class="quoted">"zcount <span class="main">(</span><span class="free">M</span><span class="main">+</span><span class="free">N</span><span class="main">)</span> <span class="skolem">t'</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="main">|</span>
      <span class="quoted"><span class="quoted">"zcount <span class="free">C</span> <span class="skolem">t'</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">case</span></span> 1
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zcount <span class="free">N</span> <span class="skolem">t'</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> t'<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> t'<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span><span class="main">=</span><span class="skolem">t</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
          <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
          <span class="keyword1"><span class="command">using</span></span> t'<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">t'</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span><span class="main">=</span><span class="skolem">t</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> disjI2<span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI2<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI1<span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> order.not_eq_order_implies_strict t'<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Exchange-justified_with_add"><span class="command">lemma</span></span> justified_with_add<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"justified_with <span class="free">C1</span> <span class="free">M</span> <span class="free">N1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"justified <span class="free">C1</span> <span class="free">N1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"justified <span class="free">C2</span> <span class="free">N2</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> zcount <span class="free">C1</span> <span class="bound">t</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> zcount <span class="free">C2</span> <span class="bound">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"justified_with <span class="main">(</span><span class="free">C1</span><span class="main">+</span><span class="free">C2</span><span class="main">)</span> <span class="free">M</span> <span class="main">(</span><span class="free">N1</span><span class="main">+</span><span class="free">N2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> justified_with_leastI allI impI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span>
  <span class="keyword3"><span class="command">assume</span></span> count_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> least<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> zcount <span class="free">M</span> <span class="bound">t'</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> justified_with_alt<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> count_t<span class="main">]</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">consider</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">s</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> zcount <span class="free">M</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">s'</span></span><span class="main">&lt;</span><span class="bound">s</span><span class="main">.</span> zcount <span class="free">M</span> <span class="bound">s'</span> <span class="main">≤</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">s</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> zcount <span class="free">N1</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">s'</span></span><span class="main">&lt;</span><span class="bound">s</span><span class="main">.</span> zcount <span class="free">M</span> <span class="bound">s'</span> <span class="main">≤</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">s</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">C1</span> <span class="bound">s</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"zcount <span class="main">(</span><span class="free">M</span> <span class="main">+</span> <span class="free">N1</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">&lt;</span> zcount <span class="free">C1</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">s</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> <span class="main">(</span>zcount <span class="free">M</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∨</span> zcount <span class="main">(</span><span class="free">N1</span> <span class="main">+</span> <span class="free">N2</span><span class="main">)</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">s'</span></span><span class="main">&lt;</span><span class="bound">s</span><span class="main">.</span> zcount <span class="free">M</span> <span class="bound">s'</span> <span class="main">≤</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span>
         <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">s</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span><span class="free">C1</span> <span class="main">+</span> <span class="free">C2</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∨</span> zcount <span class="main">(</span><span class="free">M</span> <span class="main">+</span> <span class="main">(</span><span class="free">N1</span> <span class="main">+</span> <span class="free">N2</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">&lt;</span> zcount <span class="main">(</span><span class="free">C1</span> <span class="main">+</span> <span class="free">C2</span><span class="main">)</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">&lt;</span> <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"zcount <span class="free">N1</span> <span class="skolem">s</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">s'</span></span><span class="main">&lt;</span><span class="skolem">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> zcount <span class="free">N1</span> <span class="bound">s'</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">atomize_elim</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> order_zmset_exists_foundation_neg'<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> order.strict_trans order.strict_trans1 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">consider</span></span>
      <span class="quoted"><span class="quoted">"zcount <span class="main">(</span><span class="free">N1</span> <span class="main">+</span> <span class="free">N2</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="main">|</span>
      <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">N2</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span><span class="free">N1</span> <span class="main">+</span> <span class="free">N2</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">case</span></span> 1
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> least order.strict_trans s<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
      <span class="keyword1"><span class="command">note</span></span> assms<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> justified_alt<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> 2<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">consider</span></span>
        <span class="quoted"><span class="quoted">"supported_strong <span class="free">N2</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="skolem">s</span><span class="main">.</span> zcount <span class="free">C2</span> <span class="bound">t'</span> <span class="main">≤</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"zcount <span class="free">N2</span> <span class="skolem">s</span> <span class="main">≥</span> zcount <span class="free">C2</span> <span class="skolem">s</span>"</span></span> <span class="main">|</span>
        <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="skolem">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">C2</span> <span class="bound">t'</span>"</span></span> <span class="main">|</span>
        <span class="quoted"><span class="quoted">"zcount <span class="free">N2</span> <span class="skolem">s</span> <span class="main">&lt;</span> zcount <span class="free">C2</span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> not_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
        <span class="keyword3"><span class="command">case</span></span> 1
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="keyword2"><span class="keyword">where</span></span> s'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s'</span> <span class="main">&lt;</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"zcount <span class="free">N2</span> <span class="skolem">s'</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"nonpos_upto <span class="free">N2</span> <span class="skolem">s'</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> supported_strong_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">from</span></span> s'<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> nonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> zcount <span class="main">(</span><span class="free">N1</span><span class="main">+</span><span class="free">N2</span><span class="main">)</span> <span class="skolem">s'</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">N1</span> <span class="skolem">s'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span><span class="free">N1</span> <span class="main">+</span> <span class="free">N2</span><span class="main">)</span> <span class="skolem">s'</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
            <span class="keyword1"><span class="command">using</span></span> least order.strict_trans s'<span class="main">(</span>1<span class="main">)</span> s<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> disjI1<span class="main">)</span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> not_less
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> nonneg<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> justified_alt supported_strong_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> disjE exE conjE<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> u
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> order.ordering_axioms order_class.order.irrefl order_class.order.strict_trans2 ordering.strict_trans s'<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> s<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> u
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> 1<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> add_cancel_left_right assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> less_trans order_class.antisym s'<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> s<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> zcount_union<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> 1<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> add_cancel_left_right assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> less_trans not_le order_class.antisym order_class.order.strict_trans2 s'<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> s<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> s<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> zcount_union<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s'
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI2<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI1<span class="main">)</span>
            <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">s'</span></span><span class="main">]</span> s<span class="main">(</span>1<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">s'</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> 3
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> 2<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> add_cancel_left_right add_strict_increasing2 assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> not_le order_class.order.irrefl order_class.order.strict_trans2 pos_add_strict s<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> zcount_union<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 3
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>5<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI2<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI1<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> order_class.order.strict_trans2 subset_zmset.le_add_same_cancel1 subseteq_zmset_def zcount_empty<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 4
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span><span class="free">M</span> <span class="main">+</span> <span class="main">(</span><span class="free">N1</span> <span class="main">+</span> <span class="free">N2</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">&lt;</span> zcount <span class="main">(</span><span class="free">C1</span> <span class="main">+</span> <span class="free">C2</span><span class="main">)</span> <span class="skolem">t</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> N2t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">N2</span> <span class="skolem">t</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 4 assms<span class="main">(</span>5<span class="main">)</span><span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">unfolding</span></span> not_less zcount_union
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> justified_alt supported_strong_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> N2t<span class="main">]</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE disjE<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">N1</span> <span class="skolem">s</span>"</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> justified_alt supported_strong_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE disjE<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s'
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI1<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">s'</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
               <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> add_cancel_right_right add_neg_neg order.strict_implies_order nonpos_upto_def order_class.order.not_eq_order_implies_strict zcount_union<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">meson</span> least less_trans<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s'
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_pos_nonneg assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> less_trans zcount_union<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_le not_less<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> add_cancel_right_right add_neg_neg assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> least less_trans not_less order_class.order.not_eq_order_implies_strict pos_add_strict<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> disjI1 exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">s</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> disjI2 conjI<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">using</span></span> least <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.comm_neutral add_mono_thms_linordered_field<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> zcount_union<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
          <span class="keyword1"><span class="command">using</span></span> 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Exchange-justified_with_sum'"><span class="command">lemma</span></span> justified_with_sum'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span><span class="main">≠</span><span class="main">{}</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> justified_with <span class="main">(</span><span class="free">C</span> <span class="bound">x</span><span class="main">)</span> <span class="free">M</span> <span class="main">(</span><span class="free">N</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> justified <span class="main">(</span><span class="free">C</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">N</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> <span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> zcount <span class="main">(</span><span class="free">C</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"justified_with <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> <span class="free">C</span> <span class="bound">x</span><span class="main">)</span> <span class="free">M</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> <span class="free">N</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">X</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> empty
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span><span class="main">=</span><span class="main">{}</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">using</span></span> insert<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> sum.insert_remove<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> insert<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">using</span></span> insert<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> justified_with_add<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> insert<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">using</span></span> insert<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> justified_sum<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> insert<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">using</span></span> insert<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">using</span></span> insert<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> allI<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> zcount_sum
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sum_nonneg<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> insert<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Exchange-justified_with_sum"><span class="command">lemma</span></span> justified_with_sum<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span><span class="main">≠</span><span class="main">{}</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"justified_with <span class="main">(</span><span class="free">C</span> <span class="free">x</span><span class="main">)</span> <span class="free">M</span> <span class="main">(</span><span class="free">N</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> justified <span class="main">(</span><span class="free">C</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">N</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> <span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> zcount <span class="main">(</span><span class="free">C</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"justified_with <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> <span class="free">C</span> <span class="bound">x</span><span class="main">)</span> <span class="free">M</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> <span class="free">N</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">X</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> empty
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">y</span> <span class="skolem">F</span><span class="main">)</span>
  <span class="keyword1"><span class="command">thm</span></span> insert
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span><span class="main">=</span><span class="main">{}</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">using</span></span> insert <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> sum.insert_remove<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> insert<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">using</span></span> insert<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span><span class="main">=</span><span class="free">x</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> justified_with_add<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> insert<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">using</span></span> insert<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> justified_sum<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> insert<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">using</span></span> insert<span class="main">(</span>8<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">using</span></span> insert<span class="main">(</span>8<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> allI<span class="main">)</span>
        <span class="keyword1"><span class="command">unfolding</span></span> zcount_sum
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sum_nonneg<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> insert<span class="main">(</span>8<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> add.commute<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> justified_with_add<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> insert<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">using</span></span> insert<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">using</span></span> insert<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">using</span></span> insert<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">using</span></span> insert<span class="main">(</span>8<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> justified_sum<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> insert<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">using</span></span> insert<span class="main">(</span>8<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">using</span></span> insert<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> allI<span class="main">)</span>
        <span class="keyword1"><span class="command">unfolding</span></span> zcount_sum
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sum_nonneg<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> insert<span class="main">(</span>8<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">using</span></span> insert<span class="main">(</span>8<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Exchange-justified_with_add_same"><span class="command">lemma</span></span> justified_with_add_same<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"justified_with <span class="free">C</span> <span class="free">M</span> <span class="free">N</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> zcount <span class="free">C</span> <span class="bound">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"justified_with <span class="main">(</span><span class="free">C</span> <span class="main">+</span> zmset_of <span class="free">Δ</span><span class="main">)</span> <span class="free">M</span> <span class="main">(</span><span class="free">N</span> <span class="main">+</span> zmset_of <span class="free">Δ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> justified_with_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span>
  <span class="keyword3"><span class="command">assume</span></span> Mt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> justified_with_alt<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> Mt<span class="main">]</span>
  <span class="keyword1"><span class="command">with</span></span> Mt <span class="keyword1"><span class="command">consider</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">s</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> zcount <span class="free">M</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">s'</span></span><span class="main">&lt;</span><span class="bound">s</span><span class="main">.</span> zcount <span class="free">M</span> <span class="bound">s'</span> <span class="main">≤</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">s</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> zcount <span class="free">N</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">s'</span></span><span class="main">&lt;</span><span class="bound">s</span><span class="main">.</span> zcount <span class="free">M</span> <span class="bound">s'</span> <span class="main">≤</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">s</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="bound">s</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"zcount <span class="main">(</span><span class="free">M</span> <span class="main">+</span> <span class="free">N</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> not_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">s</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> <span class="main">(</span>zcount <span class="free">M</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∨</span> zcount <span class="main">(</span><span class="free">N</span> <span class="main">+</span> zmset_of <span class="free">Δ</span><span class="main">)</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span>
         <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">s</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span><span class="free">C</span> <span class="main">+</span> zmset_of <span class="free">Δ</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∨</span> zcount <span class="main">(</span><span class="free">M</span> <span class="main">+</span> <span class="main">(</span><span class="free">N</span> <span class="main">+</span> zmset_of <span class="free">Δ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">&lt;</span> zcount <span class="main">(</span><span class="free">C</span> <span class="main">+</span> zmset_of <span class="free">Δ</span><span class="main">)</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_less_same_cancel2 assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> not_less preorder_class.le_less_trans zcount_union<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 3
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 4
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Exchange-justified_with_add_msg_delta"><span class="command">lemma</span></span> justified_with_add_msg_delta<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"justified_with <span class="free">C</span> <span class="free">M</span> <span class="free">N</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"minting_msg <span class="free">C</span> <span class="free">Δ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> zcount <span class="free">C</span> <span class="bound">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"justified_with <span class="free">C</span> <span class="free">M</span> <span class="main">(</span><span class="free">N</span> <span class="main">+</span> timestamps <span class="main">(</span>zmset_of <span class="free">Δ</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> justified_with_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span>
  <span class="keyword3"><span class="command">assume</span></span> Mt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> justified_with_alt<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> Mt<span class="main">]</span>
  <span class="keyword1"><span class="command">with</span></span> Mt <span class="keyword1"><span class="command">consider</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">s</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> zcount <span class="free">M</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">s'</span></span><span class="main">&lt;</span><span class="bound">s</span><span class="main">.</span> zcount <span class="free">M</span> <span class="bound">s'</span> <span class="main">≤</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">s</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> zcount <span class="free">N</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">s'</span></span><span class="main">&lt;</span><span class="bound">s</span><span class="main">.</span> zcount <span class="free">M</span> <span class="bound">s'</span> <span class="main">≤</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">s</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="bound">s</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"zcount <span class="main">(</span><span class="free">M</span> <span class="main">+</span> <span class="free">N</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> not_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">s</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> <span class="main">(</span>zcount <span class="free">M</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∨</span> zcount <span class="main">(</span><span class="free">N</span> <span class="main">+</span> timestamps <span class="main">(</span>zmset_of <span class="free">Δ</span><span class="main">)</span><span class="main">)</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span>
         <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">s</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∨</span> zcount <span class="main">(</span><span class="free">M</span> <span class="main">+</span> <span class="main">(</span><span class="free">N</span> <span class="main">+</span> timestamps <span class="main">(</span>zmset_of <span class="free">Δ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">&lt;</span> <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"zcount <span class="free">N</span> <span class="skolem">s</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">∈#</span><span class="free">Δ</span><span class="main">.</span> <span class="bound">s'</span> <span class="main">≤</span> <span class="skolem">s</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> minting_msg_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> order.strict_trans order.strict_trans1 s<span class="main">(</span>1<span class="main">)</span> not_less <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>timestamps <span class="main">(</span>zmset_of <span class="free">Δ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ccontr <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> pos_image_zmset_obtain_pre<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> plus_int_code<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> s<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span> zcount_union<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 3
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 4
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>timestamps <span class="main">(</span>zmset_of <span class="free">Δ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> pos_image_zmset_obtain_pre<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> minting_msg_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> not_less <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Exchange-justified_with_diff"><span class="command">lemma</span></span> justified_with_diff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"justified_with <span class="free">C</span> <span class="free">M</span> <span class="free">N</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> zcount <span class="free">C</span> <span class="bound">t</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">.</span> count <span class="free">Δ</span> <span class="bound">t</span> <span class="main">≤</span> zcount <span class="free">C</span> <span class="bound">t</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"justified <span class="free">C</span> <span class="free">N</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"justified_with <span class="main">(</span><span class="free">C</span> <span class="main">-</span> zmset_of <span class="free">Δ</span><span class="main">)</span> <span class="free">M</span> <span class="main">(</span><span class="free">N</span> <span class="main">-</span> zmset_of <span class="free">Δ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI justified_with_leastI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span>
  <span class="keyword3"><span class="command">assume</span></span> Mt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> least<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> zcount <span class="free">M</span> <span class="bound">t'</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> justified_with_alt<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> Mt<span class="main">]</span>
  <span class="keyword1"><span class="command">with</span></span> Mt <span class="keyword1"><span class="command">consider</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">s</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> zcount <span class="free">M</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">s'</span></span><span class="main">&lt;</span><span class="bound">s</span><span class="main">.</span> zcount <span class="free">M</span> <span class="bound">s'</span> <span class="main">≤</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">s</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> zcount <span class="free">N</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">s'</span></span><span class="main">&lt;</span><span class="bound">s</span><span class="main">.</span> zcount <span class="free">M</span> <span class="bound">s'</span> <span class="main">≤</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">s</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="bound">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">s</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> zcount <span class="free">M</span> <span class="bound">s</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">∨</span> <span class="main">¬</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">s'</span></span><span class="main">&lt;</span><span class="bound">s</span><span class="main">.</span> zcount <span class="free">M</span> <span class="bound">s'</span> <span class="main">≤</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">s</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> zcount <span class="free">N</span> <span class="bound">s</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">∨</span> <span class="main">¬</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">s'</span></span><span class="main">&lt;</span><span class="bound">s</span><span class="main">.</span> zcount <span class="free">M</span> <span class="bound">s'</span> <span class="main">≤</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span><span class="free">M</span> <span class="main">+</span> <span class="free">N</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">≥</span> zcount <span class="free">C</span> <span class="skolem">t</span>"</span></span>  <span class="main">|</span>
    <span class="quoted"><span class="quoted">"zcount <span class="main">(</span><span class="free">M</span> <span class="main">+</span> <span class="free">N</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> not_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">s</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> <span class="main">(</span>zcount <span class="free">M</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∨</span> zcount <span class="main">(</span><span class="free">N</span> <span class="main">-</span> zmset_of <span class="free">Δ</span><span class="main">)</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">s'</span></span><span class="main">&lt;</span><span class="bound">s</span><span class="main">.</span> zcount <span class="free">M</span> <span class="bound">s'</span> <span class="main">≤</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span>
         <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">s</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span><span class="free">C</span> <span class="main">-</span> zmset_of <span class="free">Δ</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∨</span> zcount <span class="main">(</span><span class="free">M</span> <span class="main">+</span> <span class="main">(</span><span class="free">N</span> <span class="main">-</span> zmset_of <span class="free">Δ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">&lt;</span> zcount <span class="main">(</span><span class="free">C</span> <span class="main">-</span> zmset_of <span class="free">Δ</span><span class="main">)</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> diff_add_cancel zcount_union zcount_zmset_of_nonneg <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 3
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">&lt;</span> <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">s'</span></span><span class="main">&lt;</span><span class="skolem">s</span><span class="main">.</span> zcount <span class="free">C</span> <span class="bound">s'</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">atomize_elim</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> order_zmset_exists_foundation'<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> t' s
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">s</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s'
          <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">s'</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">consider</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span><span class="free">C</span> <span class="main">-</span> zmset_of <span class="free">Δ</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="main">|</span>
      <span class="quoted"><span class="quoted">"zcount <span class="main">(</span><span class="free">C</span> <span class="main">-</span> zmset_of <span class="free">Δ</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span><span class="free">N</span> <span class="main">-</span> zmset_of <span class="free">Δ</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="main">|</span>
      <span class="quoted"><span class="quoted">"zcount <span class="main">(</span><span class="free">C</span> <span class="main">-</span> zmset_of <span class="free">Δ</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span><span class="free">N</span> <span class="main">-</span> zmset_of <span class="free">Δ</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span>
      <span class="quoted"><span class="quoted">"zcount <span class="main">(</span><span class="free">C</span> <span class="main">-</span> zmset_of <span class="free">Δ</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span><span class="free">N</span> <span class="main">-</span> zmset_of <span class="free">Δ</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">case</span></span> 1
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> s <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> s least <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nonpos_upto_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 3
      <span class="keyword1"><span class="command">note</span></span> case3 <span class="main">=</span> 3
      <span class="keyword1"><span class="command">with</span></span> s<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> Ns<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">N</span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ccontr <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_less<span class="main">)</span>
      <span class="keyword1"><span class="command">note</span></span> assms<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> justified_alt<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> Ns<span class="main">]</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"supported_strong <span class="free">N</span> <span class="skolem">s</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="skolem">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="bound">t'</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"zcount <span class="free">N</span> <span class="skolem">s</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> not_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
        <span class="keyword3"><span class="command">case</span></span> 1
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> supported_strong_def
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s'
            <span class="keyword1"><span class="command">using</span></span> s<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> least <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">s'</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nonpos_upto_def<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> s<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> 3
        <span class="keyword1"><span class="command">from</span></span> case3 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zcount <span class="free">C</span> <span class="skolem">s</span> <span class="main">=</span> zcount <span class="free">N</span> <span class="skolem">s</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> 3 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 4
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> Ns<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">N</span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">note</span></span> assms<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> justified_alt<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> Ns<span class="main">]</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"supported_strong <span class="free">N</span> <span class="skolem">s</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="skolem">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="bound">t'</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"zcount <span class="free">N</span> <span class="skolem">s</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> not_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
        <span class="keyword3"><span class="command">case</span></span> 1
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> supported_strong_def
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s'
            <span class="keyword1"><span class="command">using</span></span> s<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> least <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">s'</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nonpos_upto_def<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> s<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> 3
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zcount <span class="free">C</span> <span class="skolem">s</span> <span class="main">=</span> zcount <span class="free">N</span> <span class="skolem">s</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> 3 4<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> 3 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 4
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Exchange-PositiveImplies_justified_with"><span class="command">lemma</span></span> PositiveImplies_justified_with<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"justified <span class="free">C</span> <span class="main">(</span><span class="free">M</span><span class="main">+</span><span class="free">N</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"PositiveImplies <span class="free">M</span> <span class="main">(</span><span class="free">M</span><span class="main">+</span><span class="free">N</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"justified_with <span class="free">C</span> <span class="free">M</span> <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> justified_with_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> PositiveImplies_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> justified_alt supported_strong_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> t
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> disjI1<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">s</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> t
    <span class="keyword1"><span class="command">using</span></span> less_imp_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> t
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> disjI2 exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">t</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Exchange-justified_with_add_zmset"><span class="command">lemma</span></span> justified_with_add_zmset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"justified_with <span class="free">C</span> <span class="free">M</span> <span class="free">N</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"justified_with <span class="main">(</span>add_zmset <span class="free">c</span> <span class="free">C</span><span class="main">)</span> <span class="free">M</span> <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> add_zmset_add_single<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> justified_with_add_records<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Exchange-next_performop'_preserves_justified_with"><span class="command">lemma</span></span> next_performop'_preserves_justified_with<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"justified_with <span class="main">(</span>c_caps <span class="free">c0</span> <span class="free">p</span><span class="main">)</span> <span class="free">M</span> <span class="free">N</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"next_performop' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="free">Δneg</span> <span class="free">Δmint_msg</span> <span class="free">Δmint_self</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> zcount <span class="main">(</span>c_caps <span class="free">c0</span> <span class="free">p</span><span class="main">)</span> <span class="bound">t</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"justified <span class="main">(</span>c_caps <span class="free">c0</span> <span class="free">p</span><span class="main">)</span> <span class="free">N</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"justified_with <span class="main">(</span>c_caps <span class="free">c0</span> <span class="free">p</span> <span class="main">+</span> zmset_of <span class="free">Δmint_self</span> <span class="main">-</span> zmset_of <span class="free">Δneg</span><span class="main">)</span> <span class="free">M</span> <span class="main">(</span><span class="free">N</span> <span class="main">+</span> zmset_of <span class="free">Δmint_self</span> <span class="main">+</span> timestamps <span class="main">(</span>zmset_of <span class="free">Δmint_msg</span><span class="main">)</span> <span class="main">-</span> zmset_of <span class="free">Δneg</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> justified_with_diff<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> justified_with_add_msg_delta<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> justified_with_add_same<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> minting_msg_add_records<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> next_performopD<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">using</span></span> next_performopD<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.commute add_increasing<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> justified_add_msg_delta<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> justified_add_same<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">using</span></span> next_performopD<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> minting_msg_add_records<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> next_performopD<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.commute add_increasing<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Invariants›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹InvRecordCount›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹InvRecordCount states that for every processor, its local approximation <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"c_glob c q"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
and the sum of all incoming progress updates <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"GlobalIncomingInfoAt c q"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> together are equal
to the sum of all capabilities in the system.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">InvRecordCount</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">InvRecordCount</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">q</span><span class="main">.</span> records <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> GlobalIncomingInfoAt <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">q</span> <span class="main">+</span> c_glob <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">q</span>"</span></span>

<span class="keyword1" id="Exchange-init_config_implies_InvRecordCount"><span class="command">lemma</span></span> init_config_implies_InvRecordCount<span class="main">:</span> <span class="quoted"><span class="quoted">"init_config <span class="free">c</span> <span class="main">⟹</span> InvRecordCount <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> InvRecordCount_def init_config_def GlobalIncomingInfo_def IncomingInfo_def<span class="main">)</span>

<span class="keyword1" id="Exchange-performop_preserves_InvRecordCount"><span class="command">lemma</span></span> performop_preserves_InvRecordCount<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"InvRecordCount <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"next_performop' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="free">Δneg</span> <span class="free">Δmint_msg</span> <span class="free">Δmint_self</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"InvRecordCount <span class="free">c1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> change <span class="main">=</span> next_performopD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span></span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> complex_change <span class="main">=</span> next_performop_complexD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"InvRecordCount <span class="free">c1</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> InvRecordCount_def complex_change
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> InvRecordCount_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> change<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Exchange-sendupd_preserves_InvRecordCount"><span class="command">lemma</span></span> sendupd_preserves_InvRecordCount<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"InvRecordCount <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"next_sendupd' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="free">tt</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"InvRecordCount <span class="free">c1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> change <span class="main">=</span> next_sendupdD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> complex_change <span class="main">=</span> next_sendupd_complexD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"InvRecordCount <span class="free">c1</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> InvRecordCount_def complex_change change<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">assumption</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Exchange-recvupd_preserves_InvRecordCount"><span class="command">lemma</span></span> recvupd_preserves_InvRecordCount<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"InvRecordCount <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"next_recvupd' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"InvRecordCount <span class="free">c1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> change <span class="main">=</span> next_recvupdD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> complex_change <span class="main">=</span> next_recvupd_complexD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"InvRecordCount <span class="free">c1</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> InvRecordCount_def complex_change change<span class="main">(</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> InvRecordCount_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Exchange-recvcap_preserves_InvRecordCount"><span class="command">lemma</span></span> recvcap_preserves_InvRecordCount<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"InvRecordCount <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"next_recvcap' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"InvRecordCount <span class="free">c1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> change <span class="main">=</span> next_recvcapD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> complex_change <span class="main">=</span> next_recvcap_complexD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"InvRecordCount <span class="free">c1</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> InvRecordCount_def complex_change change<span class="main">(</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> InvRecordCount_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Exchange-next_preserves_InvRecordCount"><span class="command">lemma</span></span> next_preserves_InvRecordCount<span class="main">:</span> <span class="quoted"><span class="quoted">"InvRecordCount <span class="free">c0</span> <span class="main">⟹</span> next' <span class="free">c0</span> <span class="free">c1</span> <span class="main">⟹</span> InvRecordCount <span class="free">c1</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> next'_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">using</span></span> performop_preserves_InvRecordCount <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">using</span></span> sendupd_preserves_InvRecordCount <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">using</span></span> recvupd_preserves_InvRecordCount <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">using</span></span> recvcap_preserves_InvRecordCount <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Exchange-alw_InvRecordCount"><span class="command">lemma</span></span> alw_InvRecordCount<span class="main">:</span> <span class="quoted"><span class="quoted">"spec <span class="free">s</span> <span class="main">⟹</span> alw <span class="main">(</span>holds InvRecordCount<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lift_invariant_to_spec init_config_implies_InvRecordCount next_preserves_InvRecordCount
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> holds.elims<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> holds.elims<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> nxt.simps<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹InvCapsNonneg and InvRecordsNonneg›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹InvCapsNonneg states that elements in a processor's <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"c_caps c p"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> always have
non-negative cardinality. InvRecordsNonneg lifts this result to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"records c"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">InvCapsNonneg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span> <span class="main">::</span> finite<span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> configuration <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">InvCapsNonneg</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> zcount <span class="main">(</span>c_caps <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">p</span><span class="main">)</span> <span class="bound">t</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">InvRecordsNonneg</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">InvRecordsNonneg</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> zcount <span class="main">(</span>records <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="bound">t</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Exchange-init_config_implies_InvCapsNonneg"><span class="command">lemma</span></span> init_config_implies_InvCapsNonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"init_config <span class="free">c</span> <span class="main">⟹</span> InvCapsNonneg <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> init_config_def InvCapsNonneg_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Exchange-performop_preserves_InvCapsNonneg"><span class="command">lemma</span></span> performop_preserves_InvCapsNonneg<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"InvCapsNonneg <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"next_performop' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="free">Δ<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">Δ<span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>1</sub></span> <span class="free">Δ<span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"InvCapsNonneg <span class="free">c1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> InvCapsNonneg_def next_performop'_def Let_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span> <span class="main">(</span><span class="operator">metis</span> add.right_neutral add_mono_thms_linordered_semiring<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> of_nat_0_le_iff<span class="main">)</span>

<span class="keyword1" id="Exchange-sendupd_performs_InvCapsNonneg"><span class="command">lemma</span></span> sendupd_performs_InvCapsNonneg<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"InvCapsNonneg <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"next_sendupd' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="free">tt</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"InvCapsNonneg <span class="free">c1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> InvCapsNonneg_def next_sendupd'_def Let_def<span class="main">)</span>

<span class="keyword1" id="Exchange-recvupd_preserves_InvCapsNonneg"><span class="command">lemma</span></span> recvupd_preserves_InvCapsNonneg<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"InvCapsNonneg <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"next_recvupd' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"InvCapsNonneg <span class="free">c1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> InvCapsNonneg_def next_recvupd'_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Exchange-recvcap_preserves_InvCapsNonneg"><span class="command">lemma</span></span> recvcap_preserves_InvCapsNonneg<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"InvCapsNonneg <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"next_recvcap' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"InvCapsNonneg <span class="free">c1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> InvCapsNonneg_def next_recvcap'_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Exchange-next_preserves_InvCapsNonneg"><span class="command">lemma</span></span> next_preserves_InvCapsNonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"holds InvCapsNonneg <span class="free">s</span> <span class="main">⟹</span> next <span class="free">s</span> <span class="main">⟹</span> nxt <span class="main">(</span>holds InvCapsNonneg<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> next'_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">using</span></span> performop_preserves_InvCapsNonneg <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">using</span></span> sendupd_performs_InvCapsNonneg <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">using</span></span> recvupd_preserves_InvCapsNonneg <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">using</span></span> recvcap_preserves_InvCapsNonneg <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Exchange-alw_InvCapsNonneg"><span class="command">lemma</span></span> alw_InvCapsNonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"spec <span class="free">s</span> <span class="main">⟹</span> alw <span class="main">(</span>holds InvCapsNonneg<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lift_invariant_to_spec next_preserves_InvCapsNonneg init_config_implies_InvCapsNonneg
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Exchange-alw_InvRecordsNonneg"><span class="command">lemma</span></span> alw_InvRecordsNonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"spec <span class="free">s</span> <span class="main">⟹</span> alw <span class="main">(</span>holds InvRecordsNonneg<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> alw_mp<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> φ <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"holds InvCapsNonneg"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> alw_InvCapsNonneg <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> all_imp_alw<span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> InvCapsNonneg_def InvRecordsNonneg_def records_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> add_nonneg_nonneg sum_nonneg <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zcount_sum<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Resulting lemmas›</span></span>

<span class="keyword1" id="Exchange-pos_caps_pos_records"><span class="command">lemma</span></span> pos_caps_pos_records<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"InvCapsNonneg <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_caps <span class="free">c</span> <span class="free">p</span><span class="main">)</span> <span class="free">x</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>records <span class="free">c</span><span class="main">)</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_caps <span class="free">c</span> <span class="free">p</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span><span class="main">∑</span><span class="bound">p</span><span class="main">∈</span>UNIV<span class="main">.</span> c_caps <span class="free">c</span> <span class="bound">p</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> InvCapsNonneg_def<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum_pos2 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zcount_sum<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>records <span class="free">c</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> records_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹SafeRecordsMono›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The records in the system are monotonic, i.e. once <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"records c"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> contains no records up
to some timestamp t, then it will stay that way forever.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">SafeRecordsMono</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span> <span class="main">::</span> finite<span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> computation <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">SafeRecordsMono</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">.</span> RecordsVacantUpto <span class="main">(</span>shd <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="bound">t</span> <span class="main">⟶</span> alw <span class="main">(</span>holds <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> RecordsVacantUpto <span class="bound">c</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Exchange-performop_preserves_RecordsVacantUpto"><span class="command">lemma</span></span> performop_preserves_RecordsVacantUpto<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"RecordsVacantUpto <span class="free">c0</span> <span class="free">t</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"next_performop' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="free">Δneg</span> <span class="free">Δmint_msg</span> <span class="free">Δmint_self</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvRecordsNonneg <span class="free">c1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvCapsNonneg <span class="free">c0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"RecordsVacantUpto <span class="free">c1</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> InvRecordsNonneg <span class="main">=</span> assms<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Δpos</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"timestamps <span class="main">(</span>zmset_of <span class="free">Δmint_msg</span><span class="main">)</span> <span class="main">+</span> zmset_of <span class="free">Δmint_self</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Δ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?Δpos</span> <span class="main">-</span> zmset_of <span class="free">Δneg</span>"</span></span>
    <span class="keyword1"><span class="command">note</span></span> change <span class="main">=</span> next_performopD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span></span></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">note</span></span> complex_change <span class="main">=</span> next_performop_complexD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">assume</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≤</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>records <span class="free">c1</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> s_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>records <span class="free">c1</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> InvRecordsNonneg
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> order_class.order.not_eq_order_implies_strict InvRecordsNonneg_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> Δ_in_nrec<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="var">?Δ</span> <span class="skolem">t</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound"><span class="bound">t'</span></span><span class="main">≤</span><span class="skolem">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>records <span class="free">c0</span><span class="main">)</span> <span class="bound">t'</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> zcount_diff<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> zcount_union<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> zero_lt_diff<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> zero_lt_add_disj<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> pos_image_zmset_obtain_pre<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> change<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> minting_msg_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span> pos_caps_pos_records<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>4<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span> less_imp_le<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> change<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> minting_self_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span> pos_caps_pos_records<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>4<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">have</span></span> nrec0s<span class="main">:</span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>records <span class="free">c0</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> vacant_upto_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> s<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>records <span class="free">c1</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> complex_change
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> zcount_union<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> nrec0s<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> add_0<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> not_le
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> Δ_in_nrec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">s</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">meson</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> order_trans pos_zcount_in_zmset s<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> vacant_upto_def zcount_ne_zero_iff<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">with</span></span> s_pos <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> r <span class="main">=</span> this
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> next_performop'_def Let_def vacant_upto_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> r<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Exchange-next'_preserves_RecordsVacantUpto"><span class="command">lemma</span></span> next'_preserves_RecordsVacantUpto<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">c0</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span><span class="main">::</span>finite<span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> configuration"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"InvCapsNonneg <span class="free">c0</span> <span class="main">⟹</span> InvRecordsNonneg <span class="free">c1</span> <span class="main">⟹</span> RecordsVacantUpto <span class="free">c0</span> <span class="free">t</span> <span class="main">⟹</span> next' <span class="free">c0</span> <span class="free">c1</span> <span class="main">⟹</span> RecordsVacantUpto <span class="free">c1</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> next'_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> performop_preserves_RecordsVacantUpto<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next_sendupd'_def Let_def records_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next_recvupd'_def records_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> next_recvcap_complexD<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Exchange-alw_next_implies_alw_SafeRecordsMono"><span class="command">lemma</span></span> alw_next_implies_alw_SafeRecordsMono<span class="main">:</span>
  <span class="quoted"><span class="quoted">"alw next <span class="free">s</span> <span class="main">⟹</span> alw <span class="main">(</span>holds InvCapsNonneg<span class="main">)</span> <span class="free">s</span> <span class="main">⟹</span> alw <span class="main">(</span>holds InvRecordsNonneg<span class="main">)</span> <span class="free">s</span> <span class="main">⟹</span> alw SafeRecordsMono <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s
    <span class="keyword1"><span class="command">unfolding</span></span> spec_def next'_def SafeRecordsMono_def Let_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">s</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> t
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> alw.coinduct<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> alw.cases<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> next'_def next'_preserves_RecordsVacantUpto alw_holds2<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Exchange-alw_SafeRecordsMono"><span class="command">lemma</span></span> alw_SafeRecordsMono<span class="main">:</span> <span class="quoted"><span class="quoted">"spec <span class="free">s</span> <span class="main">⟹</span> alw SafeRecordsMono <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> alw_next_implies_alw_SafeRecordsMono alw_InvRecordsNonneg alw_InvCapsNonneg <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> spec_def<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹InvJustifiedII and InvJustifiedGII›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹These two invariants state that any net-positive change in the sum of incoming progress updates
is "justified" by one of several statements being true.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">InvJustifiedII</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">InvJustifiedII</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> justified <span class="main">(</span>c_caps <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span>IncomingInfo <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">k</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">InvJustifiedGII</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">InvJustifiedGII</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> justified <span class="main">(</span>records <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">(</span>GlobalIncomingInfo <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">k</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Given some zmset <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">M</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> justified wrt to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">caps</span></span> <span class="free"><span class="free">c0</span></span> <span class="free"><span class="free">p</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, after a performop <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">M</span></span> <span class="main"><span class="main">+</span></span> <span class="free"><span class="free">Δ</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is justified wrt to
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"c_caps <span class="free"><span class="free">c1</span></span> <span class="free"><span class="free">p</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. This lemma captures the identical argument used for preservation of InvTempJustified
and InvJustifiedII.›</span></span>
<span class="keyword1" id="Exchange-next_performop'_preserves_justified"><span class="command">lemma</span></span> next_performop'_preserves_justified<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"justified <span class="main">(</span>c_caps <span class="free">c0</span> <span class="free">p</span><span class="main">)</span> <span class="free">M</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"next_performop' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="free">Δneg</span> <span class="free">Δmint_msg</span> <span class="free">Δmint_self</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvCapsNonneg <span class="free">c0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"justified <span class="main">(</span>c_caps <span class="free">c1</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">M</span> <span class="main">+</span> <span class="main">(</span>timestamps <span class="main">(</span>zmset_of <span class="free">Δmint_msg</span><span class="main">)</span> <span class="main">+</span> zmset_of <span class="free">Δmint_self</span> <span class="main">-</span> zmset_of <span class="free">Δneg</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Δpos</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"timestamps <span class="main">(</span>zmset_of <span class="free">Δmint_msg</span><span class="main">)</span> <span class="main">+</span> zmset_of <span class="free">Δmint_self</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Δ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?Δpos</span> <span class="main">-</span> zmset_of <span class="free">Δneg</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">+</span> <span class="var">?Δ</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> change <span class="main">=</span> next_performopD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span></span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> complex_change <span class="main">=</span> next_performop_complexD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> inv0 <span class="main">=</span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> InvJustifiedII_def justified_alt<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="skolem">q</span> <span class="skolem">t</span>
    <span class="keyword3"><span class="command">assume</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="var">?M1</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> least<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> zcount <span class="var">?M1</span> <span class="bound">t'</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> t <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="skolem">t</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"zcount <span class="free">M</span> <span class="skolem">t</span> <span class="main">≤</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="var">?Δ</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> complex_change<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supported_strong <span class="var">?M1</span> <span class="skolem">t</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_caps <span class="free">c1</span> <span class="free">p</span><span class="main">)</span> <span class="bound">t'</span><span class="main">)</span> <span class="main">∨</span> zcount <span class="var">?M1</span> <span class="skolem">t</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_caps <span class="free">c1</span> <span class="free">p</span><span class="main">)</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">case</span></span> 1 <span class="comment1">― ‹<span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">M</span></span><span class="antiquote">}</span></span> was already positive at <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="skolem">t</span></span><span class="antiquote">}</span></span> in <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">c0</span></span><span class="antiquote">}</span></span>›</span>
      <span class="keyword1"><span class="command">note</span></span> Mcount <span class="main">=</span> 1
      <span class="keyword1"><span class="command">note</span></span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> InvJustifiedII_def justified_alt<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> Mcount<span class="main">]</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">consider</span></span>
        <span class="quoted"><span class="quoted">"supported_strong <span class="free">M</span> <span class="skolem">t</span>"</span></span> <span class="main">|</span>
        <span class="quoted"><span class="quoted">"<span class="main">¬</span> supported_strong <span class="free">M</span> <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_caps <span class="free">c0</span> <span class="free">p</span><span class="main">)</span> <span class="bound">t'</span>"</span></span> <span class="main">|</span>
        <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> zcount <span class="main">(</span>c_caps <span class="free">c0</span> <span class="free">p</span><span class="main">)</span> <span class="bound">t'</span> <span class="main">≤</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"zcount <span class="free">M</span> <span class="skolem">t</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_caps <span class="free">c0</span> <span class="free">p</span><span class="main">)</span> <span class="skolem">t</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
        <span class="keyword3"><span class="command">case</span></span> 1
        <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> nosupp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> supported_strong <span class="var">?M1</span> <span class="skolem">t</span>"</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> <span class="main">¬</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_caps <span class="free">c1</span> <span class="free">p</span><span class="main">)</span> <span class="bound">t'</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> nocaps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> zcount <span class="main">(</span>c_caps <span class="free">c1</span> <span class="free">p</span><span class="main">)</span> <span class="bound">t'</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> InvCapsNonneg_def assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> order_class.le_less performop_preserves_InvCapsNonneg <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
          <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">&lt;</span> <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"zcount <span class="free">M</span> <span class="skolem">s</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s'</span><span class="main">.</span> <span class="bound">s'</span> <span class="main">&lt;</span> <span class="skolem">s</span> <span class="main">⟹</span> zcount <span class="free">M</span> <span class="bound">s'</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> nonpos_upto_def supported_strong_def
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">atomize_elim</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> order_zmset_exists_foundation_neg<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> _ s
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">s</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
              <span class="keyword1"><span class="command">using</span></span> le_less_trans <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
              <span class="keyword1"><span class="command">using</span></span> less_imp_le order_trans order_class.order.not_eq_order_implies_strict <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command">have</span></span> count1s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> zcount <span class="var">?M1</span> <span class="skolem">s</span>"</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> not_le<span class="main">)</span>
            <span class="keyword1"><span class="command">using</span></span> nosupp<span class="main">[</span><span class="operator">unfolded</span> nonpos_upto_def supported_strong_def<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
            <span class="keyword1"><span class="command">using</span></span> least order.strict_trans2 s<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command">have</span></span> Δinc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="var">?Δ</span> <span class="skolem">s</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> complex_change<span class="main">(</span>3<span class="main">)</span> count1s s<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>timestamps <span class="main">(</span>zmset_of <span class="free">Δmint_msg</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> Δinc change<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span> nocaps<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> s<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
            <span class="keyword1"><span class="command">unfolding</span></span> change<span class="main">(</span>9<span class="main">)</span> fun_upd_same zcount_union zcount_diff
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">&lt;</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_caps <span class="free">c0</span> <span class="free">p</span><span class="main">)</span> <span class="skolem">u</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">u'</span></span><span class="main">&lt;</span><span class="skolem">u</span><span class="main">.</span> zcount <span class="main">(</span>c_caps <span class="free">c0</span> <span class="free">p</span><span class="main">)</span> <span class="bound">u'</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">atomize_elim</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> pos_image_zmset_obtain_pre<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> p'
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> change<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> minting_msg_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> order_zmset_exists_foundation<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s' u
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">u</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
                <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> InvCapsNonneg_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> le_less_trans order_class.order.not_eq_order_implies_strict<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command">have</span></span> count1u<span class="main">:</span> <span class="quoted"><span class="quoted">"zcount <span class="var">?M1</span> <span class="skolem">u</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> complex_change<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">u</span></span><span class="main">]</span> nocaps<span class="main">[</span><span class="operator">unfolded</span> change<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span> fun_upd_same<span class="main">]</span> order.strict_trans<span class="main">[</span><span class="operator">OF</span> u<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> s<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> s<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> u<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> u<span class="main">(</span>2<span class="main">)</span> u<span class="main">(</span>3<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nonpos_upto <span class="var">?M1</span> <span class="skolem">u</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> nonpos_upto_def
            <span class="keyword1"><span class="command">using</span></span> least order.strict_implies_order order.strict_trans1 s<span class="main">(</span>1<span class="main">)</span> u<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supported_strong <span class="var">?M1</span> <span class="skolem">t</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> count1u order.strict_trans s<span class="main">(</span>1<span class="main">)</span> u<span class="main">(</span>1<span class="main">)</span> supported_strong_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">with</span></span> nosupp <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> nosupp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> supported_strong <span class="var">?M1</span> <span class="skolem">t</span>"</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> <span class="main">¬</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_caps <span class="free">c1</span> <span class="free">p</span><span class="main">)</span> <span class="bound">t'</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> nocaps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> zcount <span class="main">(</span>c_caps <span class="free">c1</span> <span class="free">p</span><span class="main">)</span> <span class="bound">t'</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> InvCapsNonneg_def assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> order_class.le_less performop_preserves_InvCapsNonneg <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
          <span class="keyword1"><span class="command">from</span></span> 2<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">&lt;</span> <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_caps <span class="free">c0</span> <span class="free">p</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">s'</span></span><span class="main">&lt;</span><span class="skolem">s</span><span class="main">.</span> zcount <span class="main">(</span>c_caps <span class="free">c0</span> <span class="free">p</span><span class="main">)</span> <span class="bound">s'</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">atomize_elim</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> order_zmset_exists_foundation<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> _ s
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">s</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
              <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> InvCapsNonneg_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> order_class.order.not_eq_order_implies_strict<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command">have</span></span> Δcounts<span class="main">:</span>
            <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="skolem">t</span> <span class="main">⟹</span> count <span class="free">Δneg</span> <span class="bound">s</span> <span class="main">=</span> zcount <span class="main">(</span>c_caps <span class="free">c0</span> <span class="free">p</span><span class="main">)</span> <span class="bound">s</span>"</span></span>
            <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="skolem">t</span> <span class="main">⟹</span> count <span class="free">Δmint_self</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
            <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">s'</span><span class="main">.</span> <span class="bound">s'</span> <span class="main">≤</span> <span class="skolem">s</span> <span class="main">⟹</span> count <span class="free">Δmint_msg</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s'
              <span class="keyword1"><span class="command">using</span></span> change<span class="main">(</span>2<span class="main">)</span> nocaps s<span class="main">(</span>1<span class="main">)</span> order_class.order.not_eq_order_implies_strict
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> change<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s'
              <span class="keyword1"><span class="command">using</span></span> nocaps<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">s'</span></span><span class="main">]</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> change<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">s'</span><span class="main">.</span> <span class="bound">s'</span> <span class="main">&lt;</span> <span class="skolem">t</span> <span class="main">⟹</span> int <span class="main">(</span>count <span class="free">Δneg</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">=</span> zcount <span class="main">(</span>c_caps <span class="free">c0</span> <span class="free">p</span><span class="main">)</span> <span class="bound">s'</span>›</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> p s'
              <span class="keyword1"><span class="command">using</span></span> change<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> minting_msg_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span><span class="main">,</span><span class="skolem">s'</span><span class="main">)</span>"</span></span><span class="main">]</span> s<span class="main">(</span>3<span class="main">)</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ccontr<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command">have</span></span> caps_le_ii0<span class="main">:</span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>c_caps <span class="free">c0</span> <span class="free">p</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> zcount <span class="free">M</span> <span class="skolem">s</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
            <span class="keyword3"><span class="command">assume</span></span> nle<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> zcount <span class="main">(</span>c_caps <span class="free">c0</span> <span class="free">p</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> zcount <span class="free">M</span> <span class="skolem">s</span>"</span></span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zcount <span class="var">?M1</span> <span class="skolem">s</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> complex_change<span class="main">(</span>3<span class="main">)</span>
              <span class="keyword1"><span class="command">using</span></span> complex_change<span class="main">(</span>4<span class="main">)</span> nle s<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Δcounts<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> s<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
              <span class="keyword1"><span class="command">using</span></span> s<span class="main">(</span>1<span class="main">)</span> least
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nosupp<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> supported_strong_def<span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nonpos_upto_def<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">with</span></span> s<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> count0s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="skolem">s</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span>
            <span class="keyword1"><span class="command">using</span></span> inv0<span class="main">[</span><span class="operator">OF</span> count0s<span class="main">]</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> disj3_split<span class="main">)</span>
            <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>1<span class="main">)</span> order.strict_trans s<span class="main">(</span>1<span class="main">)</span> supported_strong_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">using</span></span> s<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
            <span class="keyword1"><span class="command">using</span></span> caps_le_ii0 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">linarith</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> 3
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="comment1">(* positive and negative changes to a least pointstamp are directly reflected in c_caps *)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> disjI2<span class="main">)</span>
          <span class="keyword1"><span class="command">unfolding</span></span> complex_change<span class="main">(</span>3<span class="main">)</span> change<span class="main">(</span>9<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> if_P zcount_union zcount_diff<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> complex_change<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">t</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> InvCapsNonneg_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> order_class.antisym<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span> <span class="comment1">― ‹Adding <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">Δ</span></span><span class="antiquote">}</span></span> made <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">M</span></span><span class="antiquote">}</span></span> positive at <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="skolem">t</span></span><span class="antiquote">}</span></span> in <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">c</span></span><span class="antiquote">}</span></span>1›</span>
      <span class="keyword3"><span class="command">case</span></span> 2
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> nosupp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> supported_strong <span class="var">?M1</span> <span class="skolem">t</span>"</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> <span class="main">¬</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_caps <span class="free">c1</span> <span class="free">p</span><span class="main">)</span> <span class="bound">t'</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> nocaps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> zcount <span class="main">(</span>c_caps <span class="free">c1</span> <span class="free">p</span><span class="main">)</span> <span class="bound">t'</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> InvCapsNonneg_def assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> order_class.le_less performop_preserves_InvCapsNonneg <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> zcount <span class="var">?M1</span> <span class="skolem">t</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_caps <span class="free">c1</span> <span class="free">p</span><span class="main">)</span> <span class="skolem">t</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> caps_le<span class="main">:</span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>c_caps <span class="free">c1</span> <span class="free">p</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">≤</span> zcount <span class="var">?M1</span> <span class="skolem">t</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
        <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"count <span class="free">Δneg</span> <span class="skolem">t</span> <span class="main">&lt;</span> zcount <span class="var">?Δpos</span> <span class="skolem">t</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> count <span class="free">Δmint_self</span> <span class="skolem">t</span> <span class="main">∨</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>timestamps <span class="main">(</span>zmset_of <span class="free">Δmint_msg</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> 2<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> add.commute add.left_neutral not_gr_zero of_nat_0 zero_lt_diff zcount_diff zcount_of_mset zcount_union zcount_zmset_of_nonneg<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≤</span> <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_caps <span class="free">c0</span> <span class="free">p</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">s'</span></span><span class="main">&lt;</span><span class="skolem">s</span><span class="main">.</span> zcount <span class="main">(</span>c_caps <span class="free">c0</span> <span class="free">p</span><span class="main">)</span> <span class="bound">s'</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">atomize_elim</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> change<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> minting_self_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> order_zmset_exists_foundation<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s' u
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">u</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
              <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> InvCapsNonneg_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> order.trans order_class.order.not_eq_order_implies_strict<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> pos_image_zmset_obtain_pre<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> p'
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> change<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> minting_msg_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> order_zmset_exists_foundation<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s' u
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">u</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
                <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> InvCapsNonneg_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> order.strict_trans1 less_imp_le order_class.order.not_eq_order_implies_strict<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command">have</span></span> Δcounts<span class="main">:</span>
          <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="skolem">t</span> <span class="main">⟹</span> count <span class="free">Δneg</span> <span class="bound">s</span> <span class="main">=</span> zcount <span class="main">(</span>c_caps <span class="free">c0</span> <span class="free">p</span><span class="main">)</span> <span class="bound">s</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="skolem">t</span> <span class="main">⟹</span> count <span class="free">Δmint_self</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">s'</span><span class="main">.</span> <span class="bound">s'</span> <span class="main">≤</span> <span class="skolem">s</span> <span class="main">⟹</span> count <span class="free">Δmint_msg</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s'
            <span class="keyword1"><span class="command">using</span></span> change<span class="main">(</span>2<span class="main">)</span> nocaps s<span class="main">(</span>1<span class="main">)</span> order_class.order.not_eq_order_implies_strict
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> change<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s'
            <span class="keyword1"><span class="command">using</span></span> nocaps<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">s'</span></span><span class="main">]</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> change<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">s'</span><span class="main">.</span> <span class="bound">s'</span> <span class="main">&lt;</span> <span class="skolem">t</span> <span class="main">⟹</span> int <span class="main">(</span>count <span class="free">Δneg</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">=</span> zcount <span class="main">(</span>c_caps <span class="free">c0</span> <span class="free">p</span><span class="main">)</span> <span class="bound">s'</span>›</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> p s'
            <span class="keyword1"><span class="command">using</span></span> change<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> minting_msg_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span><span class="main">,</span><span class="skolem">s'</span><span class="main">)</span>"</span></span><span class="main">]</span> s<span class="main">(</span>3<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ccontr<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> less<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">&lt;</span> <span class="skolem">t</span>"</span></span>
          <span class="keyword1"><span class="command">have</span></span> caps_le_ii0<span class="main">:</span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>c_caps <span class="free">c0</span> <span class="free">p</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> zcount <span class="free">M</span> <span class="skolem">s</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
            <span class="keyword3"><span class="command">assume</span></span> nle<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> zcount <span class="main">(</span>c_caps <span class="free">c0</span> <span class="free">p</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> zcount <span class="free">M</span> <span class="skolem">s</span>"</span></span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zcount <span class="var">?M1</span> <span class="skolem">s</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> complex_change<span class="main">(</span>3<span class="main">)</span>
              <span class="keyword1"><span class="command">using</span></span> complex_change<span class="main">(</span>4<span class="main">)</span> nle s<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Δcounts<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> less<span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
              <span class="keyword1"><span class="command">using</span></span> less least order.strict_trans2
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nosupp<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> supported_strong_def<span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nonpos_upto_def<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">with</span></span> s<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> count0s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="skolem">s</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span>
            <span class="keyword1"><span class="command">using</span></span> inv0<span class="main">[</span><span class="operator">OF</span> count0s<span class="main">]</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> disj3_split<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"supported_strong <span class="free">M</span> <span class="skolem">s</span>"</span></span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">&lt;</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"zcount <span class="free">M</span> <span class="skolem">u</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> supported_strong_def
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> zcount <span class="var">?M1</span> <span class="skolem">u</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> least nosupp<span class="main">[</span><span class="operator">unfolded</span> supported_strong_def nonpos_upto_def<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">u</span></span><span class="main">]</span> order.strict_trans<span class="main">[</span><span class="operator">OF</span> u<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> less<span class="main">]</span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="var">?Δpos</span> <span class="skolem">u</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> Δcounts<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">u</span></span><span class="main">]</span> s<span class="main">(</span>3<span class="main">)</span> u<span class="main">(</span>1<span class="main">)</span> u<span class="main">(</span>2<span class="main">)</span> less <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> count <span class="free">Δmint_self</span> <span class="skolem">u</span> <span class="main">∨</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>timestamps <span class="main">(</span>zmset_of <span class="free">Δmint_msg</span><span class="main">)</span><span class="main">)</span> <span class="skolem">u</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> gr0I <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u'</span> <span class="main">≤</span> <span class="skolem">u</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_caps <span class="free">c0</span> <span class="free">p</span><span class="main">)</span> <span class="skolem">u'</span>"</span></span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">atomize_elim</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> change<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> minting_self_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
                  <span class="keyword1"><span class="command">using</span></span> s<span class="main">(</span>1<span class="main">)</span> s<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> pos_image_zmset_obtain_pre<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
                   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> p'
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> change<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> minting_msg_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
                    <span class="keyword1"><span class="command">using</span></span> order.strict_iff_order <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
                <span class="keyword1"><span class="command">using</span></span> s<span class="main">(</span>3<span class="main">)</span> u<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">using</span></span> s<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
            <span class="keyword1"><span class="command">using</span></span> caps_le_ii0 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">linarith</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> <span class="skolem">t</span>"</span></span>
          <span class="keyword1"><span class="command">have</span></span> count0t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="skolem">t</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> eq caps_le change<span class="main">(</span>9<span class="main">)</span> complex_change<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> s<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span>
            <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>1<span class="main">)</span> count0t <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span>
          <span class="keyword1"><span class="command">using</span></span> order.not_eq_order_implies_strict s<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"justified <span class="main">(</span>c_caps <span class="free">c1</span> <span class="free">p</span><span class="main">)</span> <span class="var">?M1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> justified_leastI<span class="main">)</span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Exchange-InvJustifiedII_implies_InvJustifiedGII"><span class="command">lemma</span></span> InvJustifiedII_implies_InvJustifiedGII<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"InvJustifiedII <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvCapsNonneg <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"InvJustifiedGII <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">unfolding</span></span>
    InvJustifiedGII_def
    InvJustifiedII_def
    GlobalIncomingInfo_def
    records_def
    InvCapsNonneg_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> justified_add_records justified_sum<span class="main">)</span>

<span class="keyword1" id="Exchange-init_config_implies_InvJustifiedII"><span class="command">lemma</span></span> init_config_implies_InvJustifiedII<span class="main">:</span> <span class="quoted"><span class="quoted">"init_config <span class="free">c</span> <span class="main">⟹</span> InvJustifiedII <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> init_config_def InvJustifiedII_def justified_alt IncomingInfo_def<span class="main">)</span>

<span class="keyword1" id="Exchange-performop_preserves_InvJustifiedII"><span class="command">lemma</span></span> performop_preserves_InvJustifiedII<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"InvJustifiedII <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"next_performop' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="free">Δneg</span> <span class="free">Δmint_msg</span> <span class="free">Δmint_self</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvCapsNonneg <span class="free">c0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"InvJustifiedII <span class="free">c1</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> InvJustifiedII_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> k p' q
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span><span class="main">=</span><span class="free">p</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> next_performop_complexD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span><span class="main">]</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> if_P<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> next_performop'_preserves_justified<span class="main"><span class="main">[</span></span>
            <span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">unfolded</span> InvJustifiedII_def<span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">rule_format</span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">p</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">k</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">q</span></span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">,</span></span>
            <span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">,</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span>
        next_performopD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span></span></span></span><span class="main">]</span>
        next_performop_complexD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> InvJustifiedII_def<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Exchange-sendupd_preserves_InvJustifiedII"><span class="command">lemma</span></span> sendupd_preserves_InvJustifiedII<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"InvJustifiedII <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"next_sendupd' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="free">tt</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"InvJustifiedII <span class="free">c1</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> InvJustifiedII_def justified_alt supported_strong_def next_sendupdD<span class="main">(</span>6<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> allI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> k p' q t
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≤</span> length <span class="main">(</span>c_msg <span class="free">c0</span> <span class="free">p</span> <span class="skolem">q</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> next_sendupd_complexD<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">p'</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> InvJustifiedII_def justified_alt supported_strong_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> not_le<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2 3 4<span class="main"><span class="main">)</span></span> next_sendupd_complexD<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">p'</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span><span class="main">=</span><span class="free">p</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> if_P<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2 3<span class="main"><span class="main">)</span></span> if_P<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">unfolding</span></span> IncomingInfo_def
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> drop_all<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> drop_all<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> zcount_diff<span class="main">)</span>
          <span class="comment1">― ‹The justified condition ensures that anything remaining in temp satisfies this invariant›</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> next_sendupdD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> justified_alt supported_strong_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> InvJustifiedII_def justified_alt supported_strong_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Exchange-recvupd_preserves_InvJustifiedII"><span class="command">lemma</span></span> recvupd_preserves_InvJustifiedII<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"InvJustifiedII <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"next_recvupd' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"InvJustifiedII <span class="free">c1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span>
    InvJustifiedII_def
    next_recvupd_complexD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span><span class="main">]</span>
    next_recvupdD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Exchange-recvcap_preserves_InvJustifiedII"><span class="command">lemma</span></span> recvcap_preserves_InvJustifiedII<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"InvJustifiedII <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"next_recvcap' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"InvJustifiedII <span class="free">c1</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> InvJustifiedII_def justified_alt supported_strong_def next_recvcap_complexD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span><span class="main">]</span> next_recvcapD<span class="main">(</span>5<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> InvJustifiedII_def justified_alt supported_strong_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Exchange-next'_preserves_InvJustifiedII"><span class="command">lemma</span></span> next'_preserves_InvJustifiedII<span class="main">:</span>
  <span class="quoted"><span class="quoted">"InvCapsNonneg <span class="free">c0</span> <span class="main">⟹</span> InvJustifiedII <span class="free">c0</span> <span class="main">⟹</span> next' <span class="free">c0</span> <span class="free">c1</span> <span class="main">⟹</span> InvJustifiedII <span class="free">c1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>
    next'_def
    performop_preserves_InvJustifiedII
    recvcap_preserves_InvJustifiedII
    recvupd_preserves_InvJustifiedII
    sendupd_preserves_InvJustifiedII
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Exchange-alw_InvJustifiedII"><span class="command">lemma</span></span> alw_InvJustifiedII<span class="main">:</span> <span class="quoted"><span class="quoted">"spec <span class="free">s</span> <span class="main">⟹</span> alw <span class="main">(</span>holds InvJustifiedII<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> alw_InvCapsNonneg<span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> spec_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> conjE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> holds.simps<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> init_config_implies_InvJustifiedII<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> alw.coinduct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> alw_nxt<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command">using</span></span> next'_preserves_InvJustifiedII <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Exchange-alw_InvJustifiedGII"><span class="command">lemma</span></span> alw_InvJustifiedGII<span class="main">:</span> <span class="quoted"><span class="quoted">"spec <span class="free">s</span> <span class="main">⟹</span> alw <span class="main">(</span>holds InvJustifiedGII<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> alw_InvJustifiedII<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> alw_InvCapsNonneg<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alw_iff_sdrop InvJustifiedII_implies_InvJustifiedGII<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹InvTempJustified›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">InvTempJustified</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">InvTempJustified</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span> justified <span class="main">(</span>c_caps <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span>c_temp <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Exchange-init_config_implies_InvTempJustified"><span class="command">lemma</span></span> init_config_implies_InvTempJustified<span class="main">:</span> <span class="quoted"><span class="quoted">"init_config <span class="free">c</span> <span class="main">⟹</span> InvTempJustified <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> init_config_def InvTempJustified_def
  <span class="keyword1"><span class="command">using</span></span> justified_add_records<span class="main">[</span><span class="operator">OF</span> justified_empty<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Exchange-recvcap_preserves_InvTempJustified"><span class="command">lemma</span></span> recvcap_preserves_InvTempJustified<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"InvTempJustified <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"next_recvcap' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"InvTempJustified <span class="free">c1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> InvTempJustified_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span> assms<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> next_recvcapD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span><span class="main">]</span> InvTempJustified_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">frule</span> justified_add_records<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">{#</span></span></span><span class="free"><span class="free"><span class="free">t</span></span></span><span class="keyword1"><span class="keyword1"><span class="keyword1">#}<span class="hidden">⇩</span><sub>z</sub></span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Exchange-recvupd_preserves_InvTempJustified"><span class="command">lemma</span></span> recvupd_preserves_InvTempJustified<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"InvTempJustified <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"next_recvupd' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"InvTempJustified <span class="free">c1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> next_recvupdD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span><span class="main">]</span> InvTempJustified_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">assumption</span>

<span class="keyword1" id="Exchange-sendupd_preserves_InvTempJustified"><span class="command">lemma</span></span> sendupd_preserves_InvTempJustified<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"InvTempJustified <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"next_sendupd' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="free">tt</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"InvTempJustified <span class="free">c1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> next_sendupdD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span></span><span class="main">]</span> InvTempJustified_def
  <span class="keyword1"><span class="command">using</span></span> next_sendupdD<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Exchange-performop_preserves_InvTempJustified"><span class="command">lemma</span></span> performop_preserves_InvTempJustified<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"InvTempJustified <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"next_performop' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="free">Δneg</span> <span class="free">Δmint_msg</span> <span class="free">Δmint_self</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvCapsNonneg <span class="free">c0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"InvTempJustified <span class="free">c1</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> InvTempJustified_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> p'
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span><span class="main">=</span><span class="free">p</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> next_performopD<span class="main">(</span>5<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> fun_upd_apply
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> if_P<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> next_performop'_preserves_justified<span class="main"><span class="main">[</span></span>
            <span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">unfolded</span> InvTempJustified_def<span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">rule_format</span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">p</span></span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">,</span></span>
            <span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">,</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span>
        next_performopD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span></span></span></span><span class="main">]</span>
        next_performop_complexD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> InvTempJustified_def<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Exchange-next'_preserves_InvTempJustified"><span class="command">lemma</span></span> next'_preserves_InvTempJustified<span class="main">:</span>
  <span class="quoted"><span class="quoted">"InvCapsNonneg <span class="free">c0</span> <span class="main">⟹</span> InvTempJustified <span class="free">c0</span> <span class="main">⟹</span> next' <span class="free">c0</span> <span class="free">c1</span> <span class="main">⟹</span> InvTempJustified <span class="free">c1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>
    next'_def
    performop_preserves_InvTempJustified
    recvcap_preserves_InvTempJustified
    recvupd_preserves_InvTempJustified
    sendupd_preserves_InvTempJustified
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Exchange-alw_InvTempJustified"><span class="command">lemma</span></span> alw_InvTempJustified<span class="main">:</span> <span class="quoted"><span class="quoted">"spec <span class="free">s</span> <span class="main">⟹</span> alw <span class="main">(</span>holds InvTempJustified<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> alw_InvCapsNonneg<span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> spec_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> conjE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> holds.simps<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> init_config_implies_InvTempJustified<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> alw.coinduct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> alw_nxt<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command">using</span></span> next'_preserves_InvTempJustified <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹InvGlobNonposImpRecordsNonpos›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹InvGlobNonposImpRecordsNonpos states that each processor's <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"c_glob <span class="free"><span class="free">c</span></span> <span class="free"><span class="free">q</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is a conservative
approximation of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"records <span class="free"><span class="free">c</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">InvGlobNonposImpRecordsNonpos</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span> <span class="main">::</span> finite<span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> configuration <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">InvGlobNonposImpRecordsNonpos</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span> <span class="bound">q</span><span class="main">.</span> nonpos_upto <span class="main">(</span>c_glob <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">q</span><span class="main">)</span> <span class="bound">t</span> <span class="main">⟶</span> nonpos_upto <span class="main">(</span>records <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="bound">t</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">InvGlobVacantImpRecordsVacant</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span> <span class="main">::</span> finite<span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> configuration <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">InvGlobVacantImpRecordsVacant</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span> <span class="bound">q</span><span class="main">.</span> GlobVacantUpto <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">q</span> <span class="bound">t</span> <span class="main">⟶</span> RecordsVacantUpto <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">t</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Exchange-invs_imp_InvGlobNonposImpRecordsNonpos"><span class="command">lemma</span></span> invs_imp_InvGlobNonposImpRecordsNonpos<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"InvJustifiedGII <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvRecordCount <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvRecordsNonneg <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"InvGlobNonposImpRecordsNonpos <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> InvGlobNonposImpRecordsNonpos_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nonpos_upto_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> t q u
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?GII</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"GlobalIncomingInfoAt <span class="free">c</span> <span class="skolem">q</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> gvu<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">sa</span></span><span class="main">≤</span><span class="skolem">t</span><span class="main">.</span> zcount <span class="main">(</span>c_glob <span class="free">c</span> <span class="skolem">q</span><span class="main">)</span> <span class="bound">sa</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> uleqt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">≤</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> zcount <span class="main">(</span>records <span class="free">c</span><span class="main">)</span> <span class="skolem">u</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
      <span class="comment1">― ‹u is pointstamp that violates <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">InvGlobNonposImpRecordsNonpos</span><span class="antiquote">}</span></span>›</span>
    <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>records <span class="free">c</span><span class="main">)</span> <span class="skolem">u</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
        <span class="comment1">― ‹u' is the least pointstamp with positive <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">records</span><span class="antiquote">}</span></span>›</span>
    <span class="keyword1"><span class="command">with</span></span> uleqt <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="keyword2"><span class="keyword">where</span></span> u'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>records <span class="free">c</span><span class="main">)</span> <span class="skolem">u'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">u</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>records <span class="free">c</span><span class="main">)</span> <span class="bound">u</span> <span class="main">⟶</span> <span class="main">¬</span> <span class="bound">u</span> <span class="main">&lt;</span> <span class="skolem">u'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u'</span> <span class="main">≤</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> order_zmset_exists_foundation<span class="main">[</span><span class="operator">OF</span> u<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="comment1">― ‹from the <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">records</span><span class="antiquote">}</span></span> count we know that GII also has positive count›</span>
    <span class="keyword1"><span class="command">from</span></span> u'<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> gvu <span class="keyword1"><span class="command">have</span></span> pos_gii<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="var">?GII</span> <span class="skolem">u'</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> InvRecordCount_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_diff_cancel_left' diff_eq_eq less_add_same_cancel1 order_class.order.strict_trans1 zcount_diff<span class="main">)</span>
        <span class="comment1">― ‹Case distinction on which part of the partition GII's u is in›</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="comment1">― ‹Original proof from Abadi paper, change is justified by uprightness›</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"supported_strong <span class="var">?GII</span> <span class="skolem">u'</span>"</span></span>
        <span class="comment1">― ‹uprightness gives us a lesser pointstamp with negative count in GII..›</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">≤</span> <span class="skolem">u'</span>"</span></span> <span class="quoted"><span class="quoted">"zcount <span class="var">?GII</span> <span class="skolem">v</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> order.strict_implies_order supported_strong_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="comment1">― ‹..which is also negative in <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">records</span><span class="antiquote">}</span></span>..›</span>
      <span class="keyword1"><span class="command">with</span></span> u'<span class="main">(</span>3<span class="main">)</span> v<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>records <span class="free">c</span><span class="main">)</span> <span class="skolem">v</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> InvRecordCount_def add.commute gvu less_add_same_cancel2 order.trans not_le order_class.order.strict_trans2 zcount_union<span class="main">)</span>
          <span class="comment1">― ‹..contradicting InvNrecNonneg›</span>
      <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> InvRecordsNonneg_def
        <span class="keyword1"><span class="command">using</span></span> order_class.leD <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="comment1">― ‹Change is justified by strictly lesser pointstamp in <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">records</span><span class="antiquote">}</span></span>›</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="skolem">u'</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>records <span class="free">c</span><span class="main">)</span> <span class="bound">t'</span>"</span></span>
        <span class="comment1">― ‹v is a strictly lesser positive count in <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">records</span><span class="antiquote">}</span></span>..›</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">&lt;</span> <span class="skolem">u'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>records <span class="free">c</span><span class="main">)</span> <span class="skolem">v</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="comment1">― ‹..which contradicts the fact that we obtained <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="skolem">u'</span></span><span class="antiquote">}</span></span> as the least, positive pointstamp in <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">records</span><span class="antiquote">}</span></span>›</span>
      <span class="keyword1"><span class="command">with</span></span> u'<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="comment1">― ‹Change is justified by records›</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"zcount <span class="var">?GII</span> <span class="skolem">u'</span> <span class="main">&lt;</span> zcount <span class="main">(</span>records <span class="free">c</span><span class="main">)</span> <span class="skolem">u'</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_glob <span class="free">c</span> <span class="skolem">q</span><span class="main">)</span> <span class="skolem">u'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> InvRecordCount_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="skolem">q</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">using</span></span> gvu u'<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> pos_gii assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> InvJustifiedGII_def justified_alt<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> pos_gii<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹InvGlobVacantImpRecordsVacant is the one proved in the Abadi paper. We prove
InvGlobNonposImpRecordsNonpos, which implies this.›</span></span>
<span class="keyword1" id="Exchange-invs_imp_InvGlobVacantImpRecordsVacant"><span class="command">lemma</span></span> invs_imp_InvGlobVacantImpRecordsVacant<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"InvJustifiedGII <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvRecordCount <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvRecordsNonneg <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"InvGlobVacantImpRecordsVacant <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"GlobVacantUpto <span class="free">c</span> <span class="skolem">p</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"GlobNonposUpto <span class="free">c</span> <span class="skolem">p</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> nonpos_upto_def vacant_upto_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">note</span></span> invs_imp_InvGlobNonposImpRecordsNonpos<span class="main">[</span><span class="operator">OF</span> assms<span class="main">,</span> <span class="operator">unfolded</span> InvGlobNonposImpRecordsNonpos_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> this<span class="main">]</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"RecordsVacantUpto <span class="free">c</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> nonpos_upto_def vacant_upto_def InvRecordsNonneg_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> order_class.order.antisym<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> InvGlobVacantImpRecordsVacant_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Exchange-alw_InvGlobNonposImpRecordsNonpos"><span class="command">lemma</span></span> alw_InvGlobNonposImpRecordsNonpos<span class="main">:</span> <span class="quoted"><span class="quoted">"spec <span class="free">s</span> <span class="main">⟹</span> alw <span class="main">(</span>holds InvGlobNonposImpRecordsNonpos<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> alw_InvJustifiedGII<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> alw_InvRecordCount<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> alw_InvRecordsNonneg<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alw_iff_sdrop invs_imp_InvGlobNonposImpRecordsNonpos<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Exchange-alw_InvGlobVacantImpRecordsVacant"><span class="command">lemma</span></span> alw_InvGlobVacantImpRecordsVacant<span class="main">:</span> <span class="quoted"><span class="quoted">"spec <span class="free">s</span> <span class="main">⟹</span> alw <span class="main">(</span>holds InvGlobVacantImpRecordsVacant<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> alw_InvGlobNonposImpRecordsNonpos<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> alw_InvJustifiedGII<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> alw_InvRecordCount<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> alw_InvRecordsNonneg<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alw_iff_sdrop invs_imp_InvGlobVacantImpRecordsVacant<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹SafeGlobVacantUptoImpliesStickyNrec›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹This is the main safety property proved in the Abadi paper.›</span></span>

<span class="keyword1" id="Exchange-invs_imp_SafeGlobVacantUptoImpliesStickyNrec"><span class="command">lemma</span></span> invs_imp_SafeGlobVacantUptoImpliesStickyNrec<span class="main">:</span>
  <span class="quoted"><span class="quoted">"SafeRecordsMono <span class="free">s</span> <span class="main">⟹</span> holds InvGlobVacantImpRecordsVacant <span class="free">s</span> <span class="main">⟹</span> SafeGlobVacantUptoImpliesStickyNrec <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> InvGlobVacantImpRecordsVacant_def SafeRecordsMono_def SafeGlobVacantUptoImpliesStickyNrec_def<span class="main">)</span>

<span class="keyword1" id="Exchange-alw_SafeGlobVacantUptoImpliesStickyNrec"><span class="command">lemma</span></span> alw_SafeGlobVacantUptoImpliesStickyNrec<span class="main">:</span>
  <span class="quoted"><span class="quoted">"spec <span class="free">s</span> <span class="main">⟹</span> alw SafeGlobVacantUptoImpliesStickyNrec <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> alw_iff_sdrop invs_imp_SafeGlobVacantUptoImpliesStickyNrec alw_SafeRecordsMono alw_InvGlobVacantImpRecordsVacant<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹InvGlobNonposEqVacant›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The least pointstamps in glob are always positive, i.e. <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">nonpos_upto</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">vacant_upto</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> on glob
are equivalent.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">InvGlobNonposEqVacant</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">InvGlobNonposEqVacant</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">q</span> <span class="bound">t</span><span class="main">.</span> GlobVacantUpto <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">q</span> <span class="bound">t</span> <span class="main">=</span> GlobNonposUpto <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">q</span> <span class="bound">t</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Exchange-invs_imp_InvGlobNonposEqVacant"><span class="command">lemma</span></span> invs_imp_InvGlobNonposEqVacant<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"InvRecordCount <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvJustifiedGII <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvRecordsNonneg <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"InvGlobNonposEqVacant <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> safe <span class="main">=</span> invs_imp_InvGlobNonposImpRecordsNonpos<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>1<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">unfolded</span> InvGlobNonposImpRecordsNonpos_def nonpos_upto_def<span class="main">,</span> <span class="operator">THEN</span> spec2<span class="main">,</span> <span class="operator">THEN</span> mp<span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> nonneg <span class="main">=</span> assms<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> InvRecordsNonneg_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> count <span class="main">=</span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> InvRecordCount_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span> <span class="skolem">t</span>
    <span class="keyword3"><span class="command">assume</span></span> np<span class="main">:</span> <span class="quoted"><span class="quoted">"GlobNonposUpto <span class="free">c</span> <span class="skolem">q</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> nv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> GlobVacantUpto <span class="free">c</span> <span class="skolem">q</span> <span class="skolem">t</span>"</span></span>
      <span class="comment1">― ‹Obtain the least, negative pointstamp in glob›</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≤</span> <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>c_glob <span class="free">c</span> <span class="skolem">q</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">s'</span></span><span class="main">&lt;</span><span class="skolem">s</span><span class="main">.</span> zcount <span class="main">(</span>c_glob <span class="free">c</span> <span class="skolem">q</span><span class="main">)</span> <span class="bound">s'</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">atomize_elim</span>
      <span class="keyword1"><span class="command">using</span></span> nv<span class="main">[</span><span class="operator">unfolded</span> vacant_upto_def<span class="main">]</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> elem_order_zmset_exists_foundation<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> _ s
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">s</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">meson</span> order.ordering_axioms nonpos_upto_def np order_class.le_less ordering.trans zcount_ne_zero_iff<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="comment1">― ‹No records <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">s'</span> <span class="main">≤</span> <span class="skolem">s</span>"</span><span class="antiquote">}</span></span> can exist, since that would violate InvGlobNonposImpRecordsNonpos›</span>
    <span class="keyword1"><span class="command">have</span></span> norec<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s'</span> <span class="main">≤</span> <span class="skolem">s</span> <span class="main">⟹</span> zcount <span class="main">(</span>records <span class="free">c</span><span class="main">)</span> <span class="skolem">s'</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">s'</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> order.ordering_axioms nonneg nonpos_upto_def np order_class.antisym_conv ordering.trans s<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> safe<span class="main">)</span>
        <span class="comment1">― ‹Hence GII must be positive at <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="skolem">s</span></span><span class="antiquote">}</span></span>›</span>
    <span class="keyword1"><span class="command">have</span></span> gii<span class="main">:</span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>GlobalIncomingInfoAt <span class="free">c</span> <span class="skolem">q</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> count<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">q</span></span><span class="main">]</span> s<span class="main">(</span>2<span class="main">)</span> norec<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.commute less_add_same_cancel1 zcount_union<span class="main">)</span>
        <span class="comment1">― ‹which means it must be justified by one of these three disjuncts›</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">consider</span></span>
      <span class="quoted"><span class="quoted">"supported_strong <span class="main">(</span>GlobalIncomingInfoAt <span class="free">c</span> <span class="skolem">q</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="main">|</span>
      <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="skolem">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>records <span class="free">c</span><span class="main">)</span> <span class="bound">t'</span>"</span></span> <span class="main">|</span>
      <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>GlobalIncomingInfoAt <span class="free">c</span> <span class="skolem">q</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">&lt;</span> zcount <span class="main">(</span>records <span class="free">c</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> InvJustifiedGII_def justified_alt<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> gii<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">case</span></span> 1 <span class="comment1">― ‹<span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="skolem">s</span></span><span class="antiquote">}</span></span> can't be <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">supported_strong</span><span class="antiquote">}</span></span>, since either glob or records would have to be positive at the support›</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">using</span></span> norec count s<span class="main">(</span>3<span class="main">)</span>
        <span class="keyword1"><span class="command">unfolding</span></span> supported_strong_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> add.commute add.left_neutral less_le preorder_class.less_irrefl zcount_union<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2 <span class="comment1">― ‹no lesser capabilities exist›</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> norec s<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> order.order_iff_strict <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 3 <span class="comment1">― ‹no capabilities at <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="skolem">s</span></span><span class="antiquote">}</span></span> exist›</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> norec<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
        <span class="keyword1"><span class="command">using</span></span> gii <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> InvGlobNonposEqVacant_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> allI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nonpos_upto_def vacant_upto_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Exchange-alw_InvGlobNonposEqVacant"><span class="command">lemma</span></span> alw_InvGlobNonposEqVacant<span class="main">:</span> <span class="quoted"><span class="quoted">"spec <span class="free">s</span> <span class="main">⟹</span> alw <span class="main">(</span>holds InvGlobNonposEqVacant<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>
    alw_InvJustifiedGII
    alw_InvRecordCount
    alw_InvRecordsNonneg
    invs_imp_InvGlobNonposEqVacant
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> alw_iff_sdrop holds.elims<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> holds.elims<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹InvInfoJustifiedWithII and InvInfoJustifiedWithGII›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">InvInfoJustifiedWithII</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">InvInfoJustifiedWithII</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> justified_with <span class="main">(</span>c_caps <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span>InfoAt <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">k</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">)</span> <span class="main">(</span>IncomingInfo <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span><span class="bound">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">InvInfoJustifiedWithGII</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">InvInfoJustifiedWithGII</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> justified_with <span class="main">(</span>records <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">(</span>InfoAt <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">k</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">)</span> <span class="main">(</span>GlobalIncomingInfo <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span><span class="bound">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Exchange-init_config_implies_InvInfoJustifiedWithII"><span class="command">lemma</span></span> init_config_implies_InvInfoJustifiedWithII<span class="main">:</span> <span class="quoted"><span class="quoted">"init_config <span class="free">c</span> <span class="main">⟹</span> InvInfoJustifiedWithII <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> init_config_def InvInfoJustifiedWithII_def justified_with_def InfoAt_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹This proof relies heavily on the addition properties summarized in the lemma
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> "next_performop'_preserves_justified_with"<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>
<span class="keyword1" id="Exchange-performop_preserves_InvInfoJustifiedWithII"><span class="command">lemma</span></span> performop_preserves_InvInfoJustifiedWithII<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"InvInfoJustifiedWithII <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"next_performop' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p'</span> <span class="free">Δneg</span> <span class="free">Δmint_msg</span> <span class="free">Δmint_self</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvJustifiedII <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvCapsNonneg <span class="free">c0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"InvInfoJustifiedWithII <span class="free">c1</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> InvInfoJustifiedWithII_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> allI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> k p q
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">p'</span><span class="main">=</span><span class="skolem">p</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> next_performop_complexD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span><span class="main">]</span> next_performopD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span></span></span></span><span class="main">]</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> add_diff_eq if_P fun_upd_same<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> add.commute<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> add.assoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> next_performop'_preserves_justified_with<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> InvInfoJustifiedWithII_def<span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> InvCapsNonneg_def<span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> InvJustifiedII_def<span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> InvInfoJustifiedWithII_def justified_with_def<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_less justified_with_def next_performop_complexD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span><span class="main"><span class="main">]</span></span> next_performopD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Exchange-sendupd_preserves_InvInfoJustifiedWithII"><span class="command">lemma</span></span> sendupd_preserves_InvInfoJustifiedWithII<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"InvInfoJustifiedWithII <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"next_sendupd' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p'</span> <span class="free">tt</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvTempJustified <span class="free">c0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"InvInfoJustifiedWithII <span class="free">c1</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> InvInfoJustifiedWithII_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">p</span> <span class="skolem">q</span>
  <span class="keyword1"><span class="command">note</span></span> complex <span class="main">=</span> next_sendupd_complexD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> change <span class="main">=</span> next_sendupdD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">consider</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">p'</span> <span class="main">=</span> <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="main">(</span>c_msg <span class="free">c0</span> <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">p'</span> <span class="main">=</span> <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> length <span class="main">(</span>c_msg <span class="free">c0</span> <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">p'</span> <span class="main">=</span> <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&gt;</span> length <span class="main">(</span>c_msg <span class="free">c0</span> <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">p'</span> <span class="main">≠</span> <span class="skolem">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"justified_with <span class="main">(</span>c_caps <span class="free">c1</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">(</span>InfoAt <span class="free">c1</span> <span class="skolem">k</span> <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">(</span>IncomingInfo <span class="free">c1</span> <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> InvInfoJustifiedWithII_def Suc_eq_plus1 Suc_le_eq assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> change<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> complex<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">,</span></span>7<span class="main"><span class="main">)</span></span> order_class.less_le<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">have</span></span> temp0<span class="main">:</span> <span class="quoted"><span class="quoted">"c_temp <span class="free">c0</span> <span class="skolem">p</span> <span class="main">=</span> InfoAt <span class="free">c1</span> <span class="skolem">k</span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="main">+</span> c_temp <span class="free">c1</span> <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> complex change
      <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> pi<span class="main">:</span> <span class="quoted"><span class="quoted">"PositiveImplies <span class="main">(</span>InfoAt <span class="free">c1</span> <span class="skolem">k</span> <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">(</span>c_temp <span class="free">c0</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> PositiveImplies_def complex
      <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> InfoAt_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> iitemp<span class="main">:</span> <span class="quoted"><span class="quoted">"IncomingInfo <span class="free">c1</span> <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="main">=</span> c_temp <span class="free">c1</span> <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> IncomingInfo_def
      <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> change<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> PositiveImplies_justified_with<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> iitemp temp0<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> change
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> InvTempJustified_def<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> pi <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 3
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_cancel_right_left complex<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span> justified_with_leastI preorder_class.less_asym InfoAt_def zcount_union<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 4
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> complex change
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> InvInfoJustifiedWithII_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Exchange-recvupd_preserves_InvInfoJustifiedWithII"><span class="command">lemma</span></span> recvupd_preserves_InvInfoJustifiedWithII<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"InvInfoJustifiedWithII <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"next_recvupd' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"InvInfoJustifiedWithII <span class="free">c1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span>
    InvInfoJustifiedWithII_def
    next_recvupd_complexD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span><span class="main">]</span>
    next_recvupdD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Exchange-recvcap_preserves_InvInfoJustifiedWithII"><span class="command">lemma</span></span> recvcap_preserves_InvInfoJustifiedWithII<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"InvInfoJustifiedWithII <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"next_recvcap' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"InvInfoJustifiedWithII <span class="free">c1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span>
    InvInfoJustifiedWithII_def
    next_recvcap_complexD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span><span class="main">]</span>
    next_recvcapD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Exchange-invs_imp_InvInfoJustifiedWithGII"><span class="command">lemma</span></span> invs_imp_InvInfoJustifiedWithGII<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"InvInfoJustifiedWithII <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvJustifiedII <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvCapsNonneg <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"InvInfoJustifiedWithGII <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> InvInfoJustifiedWithGII_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> k p q
    <span class="keyword1"><span class="command">unfolding</span></span> GlobalIncomingInfo_def records_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> justified_with_add_records<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> justified_with_sum<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">p</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> InvInfoJustifiedWithII_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="skolem">k</span></span> <span class="quoted"><span class="skolem">q</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> InvJustifiedII_def<span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> InvCapsNonneg_def<span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Exchange-next'_preserves_InvInfoJustifiedWithII"><span class="command">lemma</span></span> next'_preserves_InvInfoJustifiedWithII<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"InvInfoJustifiedWithII <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"next' <span class="free">c0</span> <span class="free">c1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvCapsNonneg <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvJustifiedII <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvTempJustified <span class="free">c0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"InvInfoJustifiedWithII <span class="free">c1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> next'_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> disjE exE<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> performop_preserves_InvInfoJustifiedWithII<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> sendupd_preserves_InvInfoJustifiedWithII<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> recvupd_preserves_InvInfoJustifiedWithII<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> recvcap_preserves_InvInfoJustifiedWithII<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Exchange-alw_InvInfoJustifiedWithII"><span class="command">lemma</span></span> alw_InvInfoJustifiedWithII<span class="main">:</span> <span class="quoted"><span class="quoted">"spec <span class="free">s</span> <span class="main">⟹</span> alw <span class="main">(</span>holds InvInfoJustifiedWithII<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> alw_InvCapsNonneg<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> alw_InvJustifiedII<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> alw_InvTempJustified<span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> spec_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> conjE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> holds.simps<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> init_config_implies_InvInfoJustifiedWithII<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> alw.coinduct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>1 2 3<span class="main"><span class="main">)</span></span> alw_nxt<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command">using</span></span> next'_preserves_InvInfoJustifiedWithII
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Exchange-alw_InvInfoJustifiedWithGII"><span class="command">lemma</span></span> alw_InvInfoJustifiedWithGII<span class="main">:</span> <span class="quoted"><span class="quoted">"spec <span class="free">s</span> <span class="main">⟹</span> alw <span class="main">(</span>holds InvInfoJustifiedWithGII<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> alw_InvCapsNonneg alw_InvInfoJustifiedWithII alw_InvJustifiedII alw_iff_sdrop holds.elims<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span> invs_imp_InvInfoJustifiedWithGII<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹SafeGlobMono and InvMsgInGlob›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The records in glob are monotonic. This implies the corollary InvMsgInGlob; No incoming message
carries a timestamp change that would cause glob to regress.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">SafeGlobMono</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">SafeGlobMono</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="bound">t</span><span class="main">.</span> GlobVacantUpto <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="bound">p</span> <span class="bound">t</span> <span class="main">⟶</span> GlobVacantUpto <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="bound">p</span> <span class="bound">t</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">InvMsgInGlob</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">InvMsgInGlob</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="bound">q</span> <span class="bound">t</span><span class="main">.</span> c_msg <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">p</span> <span class="bound">q</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟶</span> <span class="bound">t</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> hd <span class="main">(</span>c_msg <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">p</span> <span class="bound">q</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">t'</span></span><span class="main">≤</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_glob <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">q</span><span class="main">)</span> <span class="bound">t'</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Exchange-not_InvMsgInGlob_imp_not_SafeGlobMono"><span class="command">lemma</span></span> not_InvMsgInGlob_imp_not_SafeGlobMono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> InvMsgInGlob <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvGlobNonposEqVacant <span class="free">c0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">c1</span><span class="main">.</span> next_recvupd <span class="free">c0</span> <span class="bound">c1</span> <span class="main">∧</span> <span class="main">¬</span> SafeGlobMono <span class="free">c0</span> <span class="bound">c1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> npeq0 <span class="main">=</span> assms<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> InvGlobNonposEqVacant_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="skolem"><span class="skolem">c1</span></span> <span class="keyword2"><span class="keyword">where</span></span> t<span class="main">:</span>
    <span class="quoted"><span class="quoted">"next_recvupd' <span class="free">c0</span> <span class="skolem">c1</span> <span class="skolem">p</span> <span class="skolem">q</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> hd <span class="main">(</span>c_msg <span class="free">c0</span> <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"GlobVacantUpto <span class="free">c0</span> <span class="skolem">q</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> InvMsgInGlob_def npeq0 nonpos_upto_def not_less <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ex_next_recvupd<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> nvu<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> GlobVacantUpto <span class="skolem">c1</span> <span class="skolem">q</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> vacant_upto_def next_recvupdD<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> t<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> t<span class="main">(</span>2<span class="main">)</span> t<span class="main">(</span>3<span class="main">)</span> vacant_upto_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> t<span class="main">(</span>3<span class="main">)</span> nvu <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> SafeGlobMono <span class="free">c0</span> <span class="skolem">c1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> SafeGlobMono_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> t<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Exchange-GII_eq_GIA"><span class="command">lemma</span></span> GII_eq_GIA<span class="main">:</span> <span class="quoted"><span class="quoted">"GlobalIncomingInfo <span class="free">c</span> <span class="main">1</span> <span class="free">p</span> <span class="free">q</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> c_msg <span class="free">c</span> <span class="free">p</span> <span class="free">q</span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> GlobalIncomingInfoAt <span class="free">c</span> <span class="free">q</span> <span class="keyword1">else</span> GlobalIncomingInfoAt <span class="free">c</span> <span class="free">q</span> <span class="main">-</span> hd <span class="main">(</span>c_msg <span class="free">c</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> GlobalIncomingInfo_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"c_msg <span class="free">c</span> <span class="free">p</span> <span class="free">q</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> IncomingInfo_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> diff_conv_add_uminus<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Sum_eq_pick_changed_elem<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> IncomingInfo_def drop_Suc sum_list_hd_tl <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Exchange-recvupd_preserves_GlobVacantUpto"><span class="command">lemma</span></span> recvupd_preserves_GlobVacantUpto<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"GlobVacantUpto <span class="free">c0</span> <span class="free">q</span> <span class="free">t</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"next_recvupd' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvInfoJustifiedWithGII <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvGlobNonposEqVacant <span class="free">c1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvGlobVacantImpRecordsVacant <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvRecordCount <span class="free">c0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"GlobVacantUpto <span class="free">c1</span> <span class="free">q</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> npeq1 <span class="main">=</span> assms<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> InvGlobNonposEqVacant_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> gvu0 <span class="main">=</span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> vacant_upto_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> nvu0 <span class="main">=</span> assms<span class="main">(</span>5<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> InvGlobVacantImpRecordsVacant_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> recordcount <span class="main">=</span> assms<span class="main">(</span>6<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> InvRecordCount_def zmultiset_eq_iff zcount_union<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> change <span class="main">=</span> next_recvupdD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?κ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"hd <span class="main">(</span>c_msg <span class="free">c0</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> change<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> iaκ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?κ</span> <span class="main">=</span> InfoAt <span class="free">c0</span> <span class="main">0</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> InfoAt_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hd_conv_nth<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> gvu1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> GlobVacantUpto <span class="free">c1</span> <span class="free">q</span> <span class="free">t</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword">where</span></span> t'<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">≤</span> <span class="free">t</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_glob <span class="free">c1</span> <span class="free">q</span><span class="main">)</span> <span class="skolem">t'</span>"</span></span>
    <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>c_glob <span class="free">c0</span> <span class="free">q</span><span class="main">)</span> <span class="skolem">t'</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">s</span></span><span class="main">&lt;</span><span class="skolem">t'</span><span class="main">.</span> zcount <span class="main">(</span>c_glob <span class="free">c1</span> <span class="free">q</span><span class="main">)</span> <span class="bound">s</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">atomize_elim</span>
    <span class="keyword1"><span class="command">using</span></span> gvu1
    <span class="keyword1"><span class="command">unfolding</span></span> npeq1 nonpos_upto_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_le<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> order_zmset_exists_foundation'<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s s'
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">s'</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> gvu0 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">from</span></span> t'<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> countκ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="var">?κ</span> <span class="skolem">t'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> change<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> assms<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> InvInfoJustifiedWithGII_def justified_with_alt<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> countκ<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> iaκ<span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">consider</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">s</span></span><span class="main">&lt;</span><span class="skolem">t'</span><span class="main">.</span> zcount <span class="main">(</span>InfoAt <span class="free">c0</span> <span class="main">0</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">s'</span></span><span class="main">&lt;</span><span class="bound">s</span><span class="main">.</span> zcount <span class="main">(</span>InfoAt <span class="free">c0</span> <span class="main">0</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="bound">s'</span> <span class="main">≤</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">s</span></span><span class="main">&lt;</span><span class="skolem">t'</span><span class="main">.</span> zcount <span class="main">(</span>GlobalIncomingInfo <span class="free">c0</span> <span class="main">1</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">s'</span></span><span class="main">&lt;</span><span class="bound">s</span><span class="main">.</span> zcount <span class="main">(</span>InfoAt <span class="free">c0</span> <span class="main">0</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="bound">s'</span> <span class="main">≤</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∄</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="skolem">t'</span> <span class="main">∧</span> zcount <span class="main">(</span>InfoAt <span class="free">c0</span> <span class="main">0</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">s'</span></span><span class="main">&lt;</span><span class="bound">s</span><span class="main">.</span> zcount <span class="main">(</span>InfoAt <span class="free">c0</span> <span class="main">0</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="bound">s'</span> <span class="main">≤</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">s</span></span><span class="main">&lt;</span><span class="skolem">t'</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>records <span class="free">c0</span><span class="main">)</span> <span class="bound">s</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>InfoAt <span class="free">c0</span> <span class="main">0</span> <span class="free">p</span> <span class="free">q</span> <span class="main">+</span> GlobalIncomingInfo <span class="free">c0</span> <span class="main">1</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="skolem">t'</span> <span class="main">&lt;</span> zcount <span class="main">(</span>records <span class="free">c0</span><span class="main">)</span> <span class="skolem">t'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">&lt;</span> <span class="skolem">t'</span>"</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>InfoAt <span class="free">c0</span> <span class="main">0</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">s'</span></span><span class="main">&lt;</span><span class="skolem">s</span><span class="main">.</span> zcount <span class="main">(</span>InfoAt <span class="free">c0</span> <span class="main">0</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="bound">s'</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> globs<span class="main">:</span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>c_glob <span class="free">c1</span> <span class="free">q</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> gvu0 iaκ t'<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> change<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>c_glob <span class="free">c1</span> <span class="free">q</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> globs <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">s'</span></span><span class="main">≤</span><span class="skolem">s</span><span class="main">.</span> zcount <span class="main">(</span>c_glob <span class="free">c1</span> <span class="free">q</span><span class="main">)</span> <span class="bound">s'</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> s<span class="main">(</span>1<span class="main">)</span> t'<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> globs <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> npeq1<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> nonpos_upto_def<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> vacant_upto_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">&lt;</span> <span class="skolem">t'</span>"</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>GlobalIncomingInfo <span class="free">c0</span> <span class="main">1</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">s'</span></span><span class="main">&lt;</span><span class="skolem">s</span><span class="main">.</span> zcount <span class="main">(</span>InfoAt <span class="free">c0</span> <span class="main">0</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="bound">s'</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> 2<span class="main">(</span>2<span class="main">)</span> s<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>InfoAt <span class="free">c0</span> <span class="main">0</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">have</span></span> rc<span class="main">:</span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>records <span class="free">c0</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> order.strict_implies_order order.strict_trans2 nvu0 s<span class="main">(</span>1<span class="main">)</span> t'<span class="main">(</span>1<span class="main">)</span> vacant_upto_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>6<span class="main">)</span> change<span class="main">(</span>1<span class="main">,</span>4<span class="main">)</span> s<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> rc t'<span class="main">(</span>4<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> GII_eq_GIA InvRecordCount_def fun_upd_same
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span> <span class="main">(</span><span class="operator">metis</span> add.commute add_mono_thms_linordered_field<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> not_le recordcount<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 3
    <span class="keyword1"><span class="command">with</span></span> nvu0 t'<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">unfolding</span></span> vacant_upto_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 4
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_glob <span class="free">c0</span> <span class="free">q</span><span class="main">)</span> <span class="skolem">t'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> change<span class="main">(</span>1<span class="main">)</span> iaκ t'<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> GII_eq_GIA
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> add.right_neutral preorder_class.less_irrefl recordcount<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> t'<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Exchange-recvupd_imp_SafeGlobMono"><span class="command">lemma</span></span> recvupd_imp_SafeGlobMono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"next_recvupd' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvInfoJustifiedWithGII <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvGlobNonposEqVacant <span class="free">c1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvGlobVacantImpRecordsVacant <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvRecordCount <span class="free">c0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"SafeGlobMono <span class="free">c0</span> <span class="free">c1</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> SafeGlobMono_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q' t
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span><span class="main">=</span><span class="free">q</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> recvupd_preserves_GlobVacantUpto<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> next_recvupdD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Exchange-next'_imp_SafeGlobMono"><span class="command">lemma</span></span> next'_imp_SafeGlobMono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"next' <span class="free">c0</span> <span class="free">c1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvInfoJustifiedWithGII <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvGlobNonposEqVacant <span class="free">c1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvGlobVacantImpRecordsVacant <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvRecordCount <span class="free">c0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"SafeGlobMono <span class="free">c0</span> <span class="free">c1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> next'_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> disjE exE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> SafeGlobMono_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> next_performopD<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> SafeGlobMono_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> next_sendupdD<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> recvupd_imp_SafeGlobMono<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> SafeGlobMono_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> next_recvcapD<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> SafeGlobMono_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Exchange-invs_imp_InvMsgInGlob"><span class="command">lemma</span></span> invs_imp_InvMsgInGlob<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">c0</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span><span class="main">::</span>finite<span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> configuration"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"InvInfoJustifiedWithGII <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvGlobNonposEqVacant <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvGlobVacantImpRecordsVacant <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvRecordCount <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvJustifiedII <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvCapsNonneg <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvRecordsNonneg <span class="free">c0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"InvMsgInGlob <span class="free">c0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> not_InvMsgInGlob_imp_not_SafeGlobMono<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> recvupd_imp_SafeGlobMono<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> invs_imp_InvGlobNonposEqVacant<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> recvupd_preserves_InvRecordCount<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> recvupd_preserves_InvJustifiedII<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> InvJustifiedII_implies_InvJustifiedGII<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> recvupd_preserves_InvCapsNonneg<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> InvRecordsNonneg_def next_recvupd_complexD<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Exchange-alw_SafeGlobMono"><span class="command">lemma</span></span> alw_SafeGlobMono<span class="main">:</span> <span class="quoted"><span class="quoted">"spec <span class="free">s</span> <span class="main">⟹</span> alw <span class="main">(</span>relates SafeGlobMono<span class="main">)</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> spec<span class="main">:</span> <span class="quoted"><span class="quoted">"spec <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"alw next <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>holds InvGlobNonposEqVacant<span class="main">)</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>holds InvGlobVacantImpRecordsVacant<span class="main">)</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>holds InvInfoJustifiedWithGII<span class="main">)</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>holds InvRecordCount<span class="main">)</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>relates SafeGlobMono<span class="main">)</span> <span class="free">s</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> relates_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> next'_imp_SafeGlobMono<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> next'_imp_SafeGlobMono<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> alw_holds2<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> alwD<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">with</span></span> spec <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> alw_InvGlobNonposEqVacant<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> alw_InvGlobVacantImpRecordsVacant<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> alw_InvInfoJustifiedWithGII<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> alw_InvRecordCount<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> spec_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Exchange-alw_InvMsgInGlob"><span class="command">lemma</span></span> alw_InvMsgInGlob<span class="main">:</span> <span class="quoted"><span class="quoted">"spec <span class="free">s</span> <span class="main">⟹</span> alw <span class="main">(</span>holds InvMsgInGlob<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> alw_InvInfoJustifiedWithGII<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> alw_InvGlobNonposEqVacant<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> alw_InvGlobVacantImpRecordsVacant<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> alw_InvRecordCount<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> alw_InvJustifiedII<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> alw_InvCapsNonneg<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> alw_InvRecordsNonneg<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alw_iff_sdrop invs_imp_InvMsgInGlob<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Exchange-SafeGlobMono_preserves_vacant"><span class="command">lemma</span></span> SafeGlobMono_preserves_vacant<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">t'</span></span><span class="main">≤</span><span class="free">t</span><span class="main">.</span> zcount <span class="main">(</span>c_glob <span class="free">c0</span> <span class="free">q</span><span class="main">)</span> <span class="bound">t'</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">c0</span> <span class="bound">c1</span><span class="main">.</span> SafeGlobMono <span class="bound">c0</span> <span class="bound">c1</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">c0</span> <span class="free">c1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">t'</span></span><span class="main">≤</span><span class="free">t</span><span class="main">.</span> zcount <span class="main">(</span>c_glob <span class="free">c1</span> <span class="free">q</span><span class="main">)</span> <span class="bound">t'</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rtranclp_induct<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> SafeGlobMono_def vacant_upto_def<span class="main">)</span>

<span class="keyword1" id="Exchange-rtranclp_all_imp_rel"><span class="command">lemma</span></span> rtranclp_all_imp_rel<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">x</span> <span class="free">y</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">r</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">⟶</span> <span class="free">r'</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="free">r'</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mono_rtranclp<span class="main">)</span>

<span class="keyword1" id="Exchange-rtranclp_rel_and_invar"><span class="command">lemma</span></span> rtranclp_rel_and_invar<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">x</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="free">x</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">a</span> <span class="main">∧</span> <span class="free">r</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">⟶</span> <span class="free">P</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rtranclp_induct<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> rtranclp.simps<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Exchange-rtranclp_invar_conclude_last"><span class="command">lemma</span></span> rtranclp_invar_conclude_last<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">x</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> rtranclp.cases <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Exchange-InvCapsNonneg_imp_InvRecordsNonneg"><span class="command">lemma</span></span> InvCapsNonneg_imp_InvRecordsNonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"InvCapsNonneg <span class="free">c</span> <span class="main">⟹</span> InvRecordsNonneg <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> InvCapsNonneg_def InvRecordsNonneg_def records_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zcount_sum <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum_nonneg add_nonneg_nonneg<span class="main">)</span>

<span class="keyword1" id="Exchange-invs_imp_msg_in_glob"><span class="command">lemma</span></span> invs_imp_msg_in_glob<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">c</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span><span class="main">::</span>finite<span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> configuration"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">∈</span> set <span class="main">(</span>c_msg <span class="free">c</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">M</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvGlobNonposEqVacant <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvJustifiedII <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvInfoJustifiedWithII <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvGlobVacantImpRecordsVacant <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvRecordCount <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvCapsNonneg <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvMsgInGlob <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">t'</span></span><span class="main">≤</span><span class="free">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_glob <span class="free">c</span> <span class="free">q</span><span class="main">)</span> <span class="bound">t'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">t'</span></span><span class="main">≤</span><span class="free">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_glob <span class="free">c</span> <span class="free">q</span><span class="main">)</span> <span class="bound">t'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> vacant<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">t'</span></span><span class="main">≤</span><span class="free">t</span><span class="main">.</span> zcount <span class="main">(</span>c_glob <span class="free">c</span> <span class="free">q</span><span class="main">)</span> <span class="bound">t'</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> InvGlobNonposEqVacant_def vacant_upto_def nonpos_upto_def<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?c1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>while_option <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> hd <span class="main">(</span>c_msg <span class="bound">c</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="main">≠</span> <span class="free">M</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> <span class="keyword1">SOME</span> <span class="bound">c'</span><span class="main">.</span> next_recvupd' <span class="bound">c</span> <span class="bound">c'</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> r<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">∈</span> set <span class="main">(</span>c_msg <span class="skolem">c</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="main">⟹</span> c_msg <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">c'</span><span class="main">.</span> next_recvupd' <span class="skolem">c</span> <span class="bound">c'</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="free">p</span> <span class="free">q</span> <span class="main">=</span> tl <span class="main">(</span>c_msg <span class="skolem">c</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">c</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> someI2_ex<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ex_next_recvupd<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next_recvupd'_def<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c1</span></span> <span class="keyword2"><span class="keyword">where</span></span> while_some<span class="main">:</span>
    <span class="quoted"><span class="quoted">"while_option <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> hd <span class="main">(</span>c_msg <span class="bound">c</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="main">≠</span> <span class="free">M</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> <span class="keyword1">SOME</span> <span class="bound">c'</span><span class="main">.</span> next_recvupd' <span class="bound">c</span> <span class="bound">c'</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="free">c</span> <span class="main">=</span> Some <span class="skolem">c1</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">atomize_elim</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> measure_while_option_Some<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">c</span></span><span class="main"><span class="main">.</span></span> <span class="free"><span class="free">M</span></span> <span class="main"><span class="main">∈</span></span> set <span class="main"><span class="main">(</span></span>c_msg <span class="bound"><span class="bound">c</span></span> <span class="free"><span class="free">p</span></span> <span class="free"><span class="free">q</span></span><span class="main"><span class="main">)</span></span>"</span></span></span>
          <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">c</span></span><span class="main"><span class="main">.</span></span> Min <span class="main"><span class="main">{</span></span><span class="bound"><span class="bound">i</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">i</span></span> <span class="main"><span class="main">&lt;</span></span> length <span class="main"><span class="main">(</span></span>c_msg <span class="bound"><span class="bound">c</span></span> <span class="free"><span class="free">p</span></span> <span class="free"><span class="free">q</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">∧</span></span> <span class="free"><span class="free">M</span></span> <span class="main"><span class="main">=</span></span> c_msg <span class="bound"><span class="bound">c</span></span> <span class="free"><span class="free">p</span></span> <span class="free"><span class="free">q</span></span> <span class="main"><span class="main">!</span></span> <span class="bound"><span class="bound">i</span></span><span class="main"><span class="main">}</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> list.exhaust_sel list.sel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> set_ConsD<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> Min_gr_iff<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth nth_tl<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> Min_less_iff<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth nth_tl<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth nth_tl<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> Suc_less_eq Suc_pred hd_conv_nth list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> not_gr_zero not_less_zero<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth nth_tl<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s x
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem"><span class="skolem">x</span></span></span><span class="main"><span class="main"><span class="main">-</span></span></span><span class="main"><span class="main"><span class="main">1</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_le_eq Suc_pred' diff_less diff_less_mono hd_conv_nth length_tl list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> not_gr_zero nth_tl zero_less_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">meson</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> in_set_conv_nth<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">have</span></span> c1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">c0</span> <span class="bound">c1</span><span class="main">.</span> next_recvupd' <span class="bound">c0</span> <span class="bound">c1</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">c</span> <span class="skolem">c1</span>"</span></span> <span class="quoted"><span class="quoted">"c_msg <span class="skolem">c1</span> <span class="free">p</span> <span class="free">q</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"hd <span class="main">(</span>c_msg <span class="skolem">c1</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> <span class="free">M</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjunct2<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> while_option_rule<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ while_some<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">d</span></span><span class="main"><span class="main">.</span></span> <span class="free"><span class="free">M</span></span> <span class="main"><span class="main">∈</span></span> set <span class="main"><span class="main">(</span></span>c_msg <span class="bound"><span class="bound">d</span></span> <span class="free"><span class="free">p</span></span> <span class="free"><span class="free">q</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">∧</span></span> <span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">c0</span></span> <span class="bound"><span class="bound">c1</span></span><span class="main"><span class="main">.</span></span> next_recvupd' <span class="bound"><span class="bound">c0</span></span> <span class="bound"><span class="bound">c1</span></span> <span class="free"><span class="free">p</span></span> <span class="free"><span class="free">q</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span></span> <span class="free"><span class="free">c</span></span> <span class="bound"><span class="bound">d</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> list.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list.sel<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> list.set_cases r<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rtrancl_into_rtrancl<span class="main"><span class="main">[</span></span><span class="operator">to_pred</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> someI2_ex<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ex_next_recvupd<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">using</span></span> while_option_rule<span class="main">[</span><span class="operator">OF</span> _ while_some<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">c</span><span class="main">.</span> <span class="free">M</span> <span class="main">∈</span> set <span class="main">(</span>c_msg <span class="bound">c</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> empty_iff hd_Cons_tl list.set<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> r set_ConsD<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">using</span></span> while_option_stop<span class="main">[</span><span class="operator">OF</span> while_some<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">have</span></span> invs_trancl<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">c0</span> <span class="bound">c1</span><span class="main">.</span> SafeGlobMono <span class="bound">c0</span> <span class="bound">c1</span> <span class="main">∧</span> InvJustifiedII <span class="bound">c1</span> <span class="main">∧</span> InvGlobNonposEqVacant <span class="bound">c1</span> <span class="main">∧</span> InvInfoJustifiedWithII <span class="bound">c1</span> <span class="main">∧</span> InvGlobVacantImpRecordsVacant <span class="bound">c1</span> <span class="main">∧</span> InvRecordCount <span class="bound">c1</span> <span class="main">∧</span> InvCapsNonneg <span class="bound">c1</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">c</span> <span class="skolem">c1</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> rtranclp_rel_and_invar<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> c1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3-8<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> a b
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> InvJustifiedII_implies_InvJustifiedGII<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> recvupd_preserves_InvJustifiedII<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> InvCapsNonneg_imp_InvRecordsNonneg<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> next_preserves_InvRecordCount<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">b</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next'_def<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> recvupd_preserves_InvCapsNonneg<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">b</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> InvJustifiedII_implies_InvJustifiedGII<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">b</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> InvCapsNonneg_imp_InvRecordsNonneg<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">b</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> invs_imp_InvGlobNonposEqVacant<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">b</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span> <span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> recvupd_preserves_InvInfoJustifiedWithII<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">b</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> invs_imp_InvInfoJustifiedWithGII<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span> <span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> invs_imp_InvInfoJustifiedWithGII<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">b</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span> <span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> next'_imp_SafeGlobMono<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next'_def<span class="main">)</span>
               <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span> <span class="main"><span class="keyword3">[</span></span>7<span class="main"><span class="keyword3">]</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> invs_imp_InvGlobVacantImpRecordsVacant<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> trancl_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">c0</span> <span class="bound">c1</span><span class="main">.</span> SafeGlobMono <span class="bound">c0</span> <span class="bound">c1</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">c</span> <span class="skolem">c1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> rtranclp_all_imp_rel<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> vacant_c1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">t'</span></span><span class="main">≤</span><span class="free">t</span><span class="main">.</span> zcount <span class="main">(</span>c_glob <span class="skolem">c1</span> <span class="free">q</span><span class="main">)</span> <span class="bound">t'</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> SafeGlobMono_preserves_vacant<span class="main"><span class="main">[</span></span><span class="operator">OF</span> vacant<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> InvMsgInGlob<span class="main">:</span> <span class="quoted"><span class="quoted">"InvMsgInGlob <span class="skolem">c1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rtranclp_invar_conclude_last<span class="main">[</span><span class="operator">OF</span> invs_trancl<span class="main">]</span> assms
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> invs_imp_InvMsgInGlob<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> invs_imp_InvInfoJustifiedWithGII InvCapsNonneg_imp_InvRecordsNonneg <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">t'</span></span><span class="main">≤</span><span class="free">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_glob <span class="skolem">c1</span> <span class="free">q</span><span class="main">)</span> <span class="bound">t'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> InvMsgInGlob<span class="main">[</span><span class="operator">unfolded</span> InvMsgInGlob_def<span class="main">]</span> c1<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">using</span></span> vacant_c1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Exchange-alw_msg_glob"><span class="command">lemma</span></span> alw_msg_glob<span class="main">:</span> <span class="quoted"><span class="quoted">"spec <span class="free">s</span> <span class="main">⟹</span>
  alw <span class="main">(</span>holds <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> <span class="main">∀</span><span class="bound">p</span> <span class="bound">q</span> <span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">M</span> <span class="main">∈</span> set <span class="main">(</span>c_msg <span class="bound">c</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">)</span><span class="main">.</span> <span class="bound">t</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="bound">M</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">t'</span></span><span class="main">≤</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_glob <span class="bound">c</span> <span class="bound">q</span><span class="main">)</span> <span class="bound">t'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> alw_InvGlobNonposEqVacant<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> alw_InvJustifiedII<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> alw_InvInfoJustifiedWithII<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> alw_InvGlobVacantImpRecordsVacant<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> alw_InvRecordCount<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> alw_InvCapsNonneg<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> alw_InvMsgInGlob<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> invs_imp_msg_in_glob<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command">using</span></span> holds.elims<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span></pre>
</div><div id="Antichain">
<div class="head">
<h1>Theory Antichain</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Antichains›</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Antichain
  <span class="keyword2"><span class="keyword">imports</span></span>
    <a href="#Auxiliary">Auxiliary</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">incomparable</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">incomparable</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">.</span> <span class="bound">x</span> <span class="main">≠</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="main">¬</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="bound">y</span> <span class="main">∧</span> <span class="main">¬</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="bound">x</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Antichain-incomparable_empty"><span class="command">lemma</span></span> incomparable_empty<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"incomparable <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> incomparable_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">typedef</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">overloaded</span></span><span class="main">)</span> <span class="tfree">'a</span> <span class="main">::</span> <span class="quoted">order</span> antichain <span class="main">=</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">A</span> <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">.</span> finite <span class="bound">A</span> <span class="main">∧</span> incomparable <span class="bound">A</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">morphisms</span></span> set_antichain antichain
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">setup_lifting</span></span> type_definition_antichain

<span class="keyword1"><span class="command">lift_definition</span></span> member_antichain <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> order <span class="main">⇒</span> <span class="tfree">'a</span> antichain <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span>_<span class="keyword3">/ </span><span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> _<span class="keyword3">)</span>"</span> <span class="main">[</span>51<span class="main">,</span> 51<span class="main">]</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"Set.member"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">not_member_antichain</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> order <span class="main">⇒</span> <span class="tfree">'a</span> antichain <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span>_<span class="keyword3">/ </span><span class="keyword1">∉<span class="hidden">⇩</span><sub>A</sub></span> _<span class="keyword3">)</span>"</span> <span class="main">[</span>51<span class="main">,</span> 51<span class="main">]</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1"><span class="free">∉<span class="hidden">⇩</span><sub>A</sub></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> <span class="main">¬</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> empty_antichain <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> order antichain"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">{}<span class="hidden">⇩</span><sub>A</sub></span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Antichain-mem_antichain_nonempty"><span class="command">lemma</span></span> mem_antichain_nonempty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">≠</span> <span class="keyword1">{}<span class="hidden">⇩</span><sub>A</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">minimal_antichain</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">.</span> <span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">y</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="bound">x</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Antichain-in_minimal_antichain"><span class="command">lemma</span></span> in_minimal_antichain<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> minimal_antichain <span class="free">A</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">y</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> minimal_antichain_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Antichain-in_antichain_minimal_antichain"><span class="command">lemma</span></span> in_antichain_minimal_antichain<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">M</span> <span class="main">⟹</span> <span class="free">x</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> antichain <span class="main">(</span>minimal_antichain <span class="free">M</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">∈</span> minimal_antichain <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> minimal_antichain_def member_antichain.rep_eq<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI iffI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> antichain_inverse<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> incomparable_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> antichain_inverse<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> incomparable_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> antichain_inverse<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> incomparable_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Antichain-incomparable_minimal_antichain"><span class="command">lemma</span></span> incomparable_minimal_antichain<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"incomparable <span class="main">(</span>minimal_antichain <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> incomparable_def minimal_antichain_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Antichain-finite_minimal_antichain"><span class="command">lemma</span></span> finite_minimal_antichain<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span> <span class="main">⟹</span> finite <span class="main">(</span>minimal_antichain <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> minimal_antichain_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Antichain-finite_set_antichain"><span class="command">lemma</span></span> finite_set_antichain<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>set_antichain <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="Antichain-minimal_antichain_subset"><span class="command">lemma</span></span> minimal_antichain_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"minimal_antichain <span class="free">A</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> minimal_antichain_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lift_definition</span></span> frontier <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'t</span> <span class="main">::</span> order zmultiset <span class="main">⇒</span> <span class="tfree">'t</span> antichain"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">M</span><span class="main">.</span> minimal_antichain <span class="main">{</span><span class="bound">t</span><span class="main">.</span> zcount <span class="bound">M</span> <span class="bound">t</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> minimal_antichain_subset finite_zcount_pos<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Antichain-member_frontier_pos_zmset"><span class="command">lemma</span></span> member_frontier_pos_zmset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="free">M</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> frontier_def in_minimal_antichain<span class="main">)</span>

<span class="keyword1" id="Antichain-frontier_comparable_False"><span class="command">lemma</span></span> frontier_comparable_False<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="free">M</span> <span class="main">⟹</span> <span class="free">y</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="free">M</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="free">y</span> <span class="main">⟹</span> False"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> minimal_antichain_def<span class="main">)</span>

<span class="keyword1" id="Antichain-minimal_antichain_idempotent"><span class="command">lemma</span></span> minimal_antichain_idempotent<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"minimal_antichain <span class="main">(</span>minimal_antichain <span class="free">A</span><span class="main">)</span> <span class="main">=</span> minimal_antichain <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> minimal_antichain_def<span class="main">)</span>

<span class="keyword1"><span class="command">instantiation</span></span> antichain <span class="main">::</span> <span class="main">(</span><span class="quoted">order</span><span class="main">)</span> <span class="quoted">minus</span> <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">minus_antichain</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> antichain <span class="main">⇒</span> <span class="tfree">'a</span> antichain <span class="main">⇒</span> <span class="tfree">'a</span> antichain"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(-)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> incomparable_def<span class="main">)</span>
<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> antichain <span class="main">::</span> <span class="main">(</span><span class="quoted">order</span><span class="main">)</span> <span class="quoted">plus</span> <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">plus_antichain</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> antichain <span class="main">⇒</span> <span class="tfree">'a</span> antichain <span class="main">⇒</span> <span class="tfree">'a</span> antichain"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">M</span> <span class="bound">N</span><span class="main">.</span> minimal_antichain <span class="main">(</span><span class="bound">M</span> <span class="main">∪</span> <span class="bound">N</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> incomparable_def minimal_antichain_def<span class="main">)</span>
<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Antichain-antichain_add_commute"><span class="command">lemma</span></span> antichain_add_commute<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> order antichain<span class="main">)</span> <span class="main">+</span> <span class="free">N</span> <span class="main">=</span> <span class="free">N</span> <span class="main">+</span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> incomparable_def sup_commute<span class="main">)</span>


<span class="keyword1"><span class="command">lift_definition</span></span> filter_antichain <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> order <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> antichain <span class="main">⇒</span> <span class="tfree">'a</span> antichain"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"Set.filter"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> incomparable_def<span class="main">)</span>

<span class="keyword1"><span class="command">syntax</span></span> <span class="main">(</span>ASCII<span class="main">)</span>
  <span class="quoted">"_ACCollect"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"pttrn <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> order antichain <span class="main">⇒</span> bool <span class="main">⇒</span> <span class="tfree">'a</span> antichain"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(1</span><span class="keyword1">{</span>_ <span class="keyword1">:<span class="hidden">⇩</span><sub>A</sub></span> _<span class="keyword1">.</span><span class="keyword3">/ </span>_<span class="keyword1">}</span><span class="keyword3">)</span>"</span><span class="main">)</span>
<span class="keyword1"><span class="command">syntax</span></span>
  <span class="quoted">"_ACCollect"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"pttrn <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> order antichain <span class="main">⇒</span> bool <span class="main">⇒</span> <span class="tfree">'a</span> antichain"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(1</span><span class="keyword1">{</span>_ <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> _<span class="keyword1">.</span><span class="keyword3">/ </span>_<span class="keyword1">}</span><span class="keyword3">)</span>"</span><span class="main">)</span>
<span class="keyword1"><span class="command">translations</span></span>
  <span class="quoted">"<span class="main">{</span><span class="free">x</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">M</span><span class="main">.</span> <span class="free">P</span><span class="main">}</span>"</span> <span class="main">==</span> <span class="quoted">"<span class="keyword1">CONST</span> filter_antichain <span class="main">(</span><span class="main">λ</span><span class="free">x</span><span class="main">.</span> <span class="free">P</span><span class="main">)</span> <span class="free">M</span>"</span>


<span class="keyword1"><span class="command">declare</span></span> empty_antichain.rep_eq<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1" id="Antichain-minimal_antichain_empty"><span class="command">lemma</span></span> minimal_antichain_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"minimal_antichain <span class="main">{}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> minimal_antichain_def<span class="main">)</span>

<span class="keyword1" id="Antichain-minimal_antichain_singleton"><span class="command">lemma</span></span> minimal_antichain_singleton<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"minimal_antichain <span class="main">{</span><span class="free">x</span><span class="main">::</span><span class="main">_</span> <span class="main">::</span>order<span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> minimal_antichain_def<span class="main">)</span>

<span class="keyword1" id="Antichain-minimal_antichain_nonempty"><span class="command">lemma</span></span> minimal_antichain_nonempty<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="free">A</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">t</span><span class="main">::</span><span class="main">_</span><span class="main">::</span>order<span class="main">)</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> minimal_antichain <span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> minimal_antichain_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> order_finite_set_exists_foundation<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">t</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Antichain-minimal_antichain_member"><span class="command">lemma</span></span> minimal_antichain_member<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="free">A</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">t</span><span class="main">::</span><span class="main">_</span><span class="main">::</span>order<span class="main">)</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="bound">t'</span> <span class="main">∈</span> minimal_antichain <span class="free">A</span> <span class="main">∧</span> <span class="bound">t'</span> <span class="main">≤</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> minimal_antichain_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> order_finite_set_exists_foundation<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">t</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Antichain-minimal_antichain_union"><span class="command">lemma</span></span> minimal_antichain_union<span class="main">:</span> <span class="quoted"><span class="quoted">"minimal_antichain <span class="main">(</span><span class="main">(</span><span class="free">A</span><span class="main">::</span><span class="main">(</span><span class="main">_</span> <span class="main">::</span> order<span class="main">)</span> set<span class="main">)</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span> <span class="main">⊆</span> minimal_antichain <span class="main">(</span>minimal_antichain <span class="free">A</span> <span class="main">∪</span> minimal_antichain <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> minimal_antichain_def<span class="main">)</span>

<span class="keyword1" id="Antichain-ac_Diff_iff"><span class="command">lemma</span></span> ac_Diff_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">A</span> <span class="main">-</span> <span class="free">B</span> <span class="main">⟷</span> <span class="free">c</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">A</span> <span class="main">∧</span> <span class="free">c</span> <span class="keyword1">∉<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1" id="Antichain-ac_DiffD2"><span class="command">lemma</span></span> ac_DiffD2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">A</span> <span class="main">-</span> <span class="free">B</span> <span class="main">⟹</span> <span class="free">c</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">B</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1" id="Antichain-ac_notin_Diff"><span class="command">lemma</span></span> ac_notin_Diff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">x</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">A</span> <span class="main">-</span> <span class="free">B</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="free">x</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">A</span> <span class="main">∨</span> <span class="free">x</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1" id="Antichain-ac_eq_iff"><span class="command">lemma</span></span> ac_eq_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="free">B</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">A</span> <span class="main">⟷</span> <span class="bound">x</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="Antichain-antichain_obtain_foundation"><span class="command">lemma</span></span> antichain_obtain_foundation<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>   <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">s</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">M</span> <span class="main">∧</span> <span class="free">s</span> <span class="main">≤</span> <span class="free">t</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">u</span><span class="main">.</span> <span class="bound">u</span><span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span><span class="free">M</span> <span class="main">⟶</span> <span class="main">¬</span> <span class="bound">u</span> <span class="main">&lt;</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> member_antichain.rep_eq
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">rule</span> order_finite_set_obtain_foundation<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"set_antichain <span class="free"><span class="free"><span class="free">M</span></span></span>"</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">t</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Antichain-set_antichain1"><span class="command">lemma</span></span> set_antichain1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set_antichain <span class="free">X</span> <span class="main">⟹</span> <span class="free">x</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1" id="Antichain-set_antichain2"><span class="command">lemma</span></span> set_antichain2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">X</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> set_antichain <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span></pre>
</div><div id="Graph">
<div class="head">
<h1>Theory Graph</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Multigraphs with Partially Ordered Weights›</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Graph
  <span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Sublist.html">HOL-Library.Sublist</a>"</span> <a href="#Antichain">Antichain</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">FROM</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">FROM</span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="bound">s</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">LBL</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">LBL</span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="bound">l</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">TO</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">TO</span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="bound">t</span>"</span></span>

<span class="keyword1"><span class="command">notation</span></span> subseq <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">≼</span>"</span> 50<span class="main">)</span>

<span class="keyword1"><span class="command">locale</span></span> graph <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">weights</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'vtx</span> <span class="main">::</span> finite <span class="main">⇒</span> <span class="tfree">'vtx</span> <span class="main">⇒</span> <span class="tfree">'lbl</span> <span class="main">::</span> <span class="main">{</span>order<span class="main">,</span> monoid_add<span class="main">}</span> antichain"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> zero_le<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">(</span><span class="free">s</span><span class="main">::</span><span class="tfree">'lbl</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> plus_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s1</span><span class="main">::</span><span class="tfree">'lbl</span><span class="main">)</span> <span class="main">≤</span> <span class="free">s2</span> <span class="main">⟹</span> <span class="free">s3</span> <span class="main">≤</span> <span class="free">s4</span> <span class="main">⟹</span> <span class="free">s1</span> <span class="main">+</span> <span class="free">s3</span> <span class="main">≤</span> <span class="free">s2</span> <span class="main">+</span> <span class="free">s4</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> summary_self<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">weights</span> <span class="free">loc</span> <span class="free">loc</span> <span class="main">=</span> <span class="keyword1">{}<span class="hidden">⇩</span><sub>A</sub></span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Graph-le_plus"><span class="command">lemma</span></span> le_plus<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">::</span><span class="tfree">'lbl</span><span class="main">)</span> <span class="main">≤</span> <span class="free">s</span> <span class="main">+</span> <span class="free">s'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s'</span><span class="main">::</span><span class="tfree">'lbl</span><span class="main">)</span> <span class="main">≤</span> <span class="free">s</span> <span class="main">+</span> <span class="free">s'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> plus_mono<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">s</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">s</span></span></span></span></span></span> <span class="quoted"><span class="main"><span class="quoted"><span class="main"><span class="quoted"><span class="main">0</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">s'</span></span></span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span> plus_mono<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="main"><span class="quoted"><span class="main"><span class="quoted"><span class="main">0</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">s</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">s'</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">s'</span></span></span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Paths›</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">path</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'vtx</span> <span class="main">⇒</span> <span class="tfree">'vtx</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'vtx</span> <span class="main">×</span> <span class="tfree">'lbl</span> <span class="main">×</span> <span class="tfree">'vtx</span><span class="main">)</span> list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  path0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span> <span class="main">⟹</span> <span class="free">path</span> <span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> path<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">path</span> <span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">lbl</span></span></span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">weights</span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span> <span class="free"><span class="bound"><span class="entity">l3</span></span></span> <span class="main">⟹</span> <span class="free">path</span> <span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="free"><span class="bound"><span class="entity">l3</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">l2</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">lbl</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">l3</span></span></span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> path0E<span class="main">:</span> <span class="quoted"><span class="quoted">"path <span class="free">l1</span> <span class="free">l2</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> path_AppendE<span class="main">:</span> <span class="quoted"><span class="quoted">"path <span class="free">l1</span> <span class="free">l3</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">l2</span><span class="main">,</span><span class="free">s</span><span class="main">,</span><span class="free">l2'</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Graph-path_trans"><span class="command">lemma</span></span> path_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"path <span class="free">l1</span> <span class="free">l2</span> <span class="free">xs</span> <span class="main">⟹</span> path <span class="free">l2</span> <span class="free">l3</span> <span class="free">ys</span> <span class="main">⟹</span> path <span class="free">l1</span> <span class="free">l3</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rotate_tac</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">induct</span> <span class="quoted"><span class="free">l2</span></span> <span class="quoted"><span class="free">l3</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> path.induct<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> path.path <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> append_assoc<span class="main">)</span>

<span class="keyword1" id="Graph-path_take_from"><span class="command">lemma</span></span> path_take_from<span class="main">:</span> <span class="quoted"><span class="quoted">"path <span class="free">l1</span> <span class="free">l2</span> <span class="free">xs</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> FROM <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="free">m</span><span class="main">)</span> <span class="main">=</span> <span class="free">l2'</span> <span class="main">⟹</span> path <span class="free">l1</span> <span class="free">l2'</span> <span class="main">(</span>take <span class="free">m</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l1</span></span> <span class="quoted"><span class="free">l2</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> path.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>path <span class="skolem">l1</span> <span class="skolem">l2</span> <span class="skolem">xs</span> <span class="skolem">lbl</span> <span class="skolem">l3</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> take_append<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">l2</span><span class="main">=</span><span class="free">l2'</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> linorder_not_less nth_append take_all<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> case_prod_conv less_Suc_eq nth_append nth_append_length<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Graph-path_take_to"><span class="command">lemma</span></span> path_take_to<span class="main">:</span> <span class="quoted"><span class="quoted">"path <span class="free">l1</span> <span class="free">l2</span> <span class="free">xs</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> TO <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="free">m</span><span class="main">)</span> <span class="main">=</span> <span class="free">l2'</span> <span class="main">⟹</span> path <span class="free">l1</span> <span class="free">l2'</span> <span class="main">(</span>take <span class="main">(</span><span class="free">m</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l1</span></span> <span class="quoted"><span class="free">l2</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> path.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>path <span class="skolem">l1</span> <span class="skolem">l2</span> <span class="skolem">xs</span> <span class="skolem">lbl</span> <span class="skolem">l3</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> case_prod_conv less_antisym nth_append_length path.path<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Graph-path_determines_loc"><span class="command">lemma</span></span> path_determines_loc<span class="main">:</span> <span class="quoted"><span class="quoted">"path <span class="free">l1</span> <span class="free">l2</span> <span class="free">xs</span> <span class="main">⟹</span> path <span class="free">l1</span> <span class="free">l3</span> <span class="free">xs</span> <span class="main">⟹</span> <span class="free">l2</span> <span class="main">=</span> <span class="free">l3</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l1</span></span> <span class="quoted"><span class="free">l2</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> path.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> path.cases<span class="main">)</span>

<span class="keyword1" id="Graph-path_first_loc"><span class="command">lemma</span></span> path_first_loc<span class="main">:</span> <span class="quoted"><span class="quoted">"path <span class="free">loc</span> <span class="free">loc'</span> <span class="free">xs</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> FROM <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="free">loc</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> path.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>path <span class="skolem">l1</span> <span class="skolem">l2</span> <span class="skolem">xs</span> <span class="skolem">lbl</span> <span class="skolem">l3</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> path0E <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Graph-path_to_eq_from"><span class="command">lemma</span></span> path_to_eq_from<span class="main">:</span> <span class="quoted"><span class="quoted">"path <span class="free">loc1</span> <span class="free">loc2</span> <span class="free">xs</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">+</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> FROM <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> TO <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> path.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>path <span class="skolem">l1</span> <span class="skolem">l2</span> <span class="skolem">xs</span> <span class="skolem">lbl</span> <span class="skolem">l3</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">+</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> add.commute drop_eq_Nil hd_drop_conv_nth id_take_nth_drop linorder_not_less path_determines_loc path_take_to plus_1_eq_Suc take_hd_drop<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Graph-path_singleton"><span class="command">lemma</span></span> path_singleton<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">weights</span> <span class="free">l1</span> <span class="free">l2</span> <span class="main">⟹</span> path <span class="free">l1</span> <span class="free">l2</span> <span class="main">[</span><span class="main">(</span><span class="free">l1</span><span class="main">,</span><span class="free">s</span><span class="main">,</span><span class="free">l2</span><span class="main">)</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> path.simps<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> path.intros<span class="main">)</span>

<span class="keyword1" id="Graph-path_appendE"><span class="command">lemma</span></span> path_appendE<span class="main">:</span> <span class="quoted"><span class="quoted">"path <span class="free">l1</span> <span class="free">l3</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">l2</span><span class="main">.</span> path <span class="bound">l2</span> <span class="free">l3</span> <span class="free">ys</span> <span class="main">∧</span> path <span class="free">l1</span> <span class="bound">l2</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l1</span></span> <span class="quoted"><span class="free">l3</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span><span class="main">@</span><span class="free">ys</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> path.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>path0 <span class="skolem">l1</span> <span class="skolem">l2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> path.intros<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>path <span class="skolem">l1</span> <span class="skolem">l2</span> <span class="skolem">xs</span> <span class="skolem">lbl</span> <span class="skolem">l3</span> <span class="skolem">xs'</span> <span class="skolem">ys'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> path<span class="main">(</span>1<span class="main">,</span>3-<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> append_eq_append_conv2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">xs</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">[</span></span><span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">l2</span></span><span class="main"><span class="main">,</span></span><span class="skolem"><span class="skolem">lbl</span></span><span class="main"><span class="main">,</span></span><span class="skolem"><span class="skolem">l3</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span>"</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">xs'</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">ys'</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE disjE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> us
      <span class="keyword1"><span class="command">using</span></span> path<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">xs'</span></span> <span class="quoted"><span class="skolem">us</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> path.intros<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> us
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">us</span><span class="main">=</span><span class="main">[]</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> path.intros <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Cons_eq_append_conv<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Graph-path_replace_prefix"><span class="command">lemma</span></span> path_replace_prefix<span class="main">:</span>
  <span class="quoted"><span class="quoted">"path <span class="free">l1</span> <span class="free">l3</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">zs</span><span class="main">)</span> <span class="main">⟹</span> path <span class="free">l1</span> <span class="free">l2</span> <span class="free">ys</span> <span class="main">⟹</span> path <span class="free">l1</span> <span class="free">l2</span> <span class="free">xs</span> <span class="main">⟹</span> path <span class="free">l1</span> <span class="free">l3</span> <span class="main">(</span><span class="free">ys</span> <span class="main">@</span> <span class="free">zs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> path_appendE<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> path_trans <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> path_determines_loc<span class="main">)</span>

<span class="keyword1" id="Graph-drop_subseq"><span class="command">lemma</span></span> drop_subseq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> length <span class="free">xs</span> <span class="main">⟹</span> drop <span class="free">n</span> <span class="free">xs</span> <span class="main">≼</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> suffix_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"take <span class="free">n</span> <span class="free">xs</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Graph-take_subseq"><span class="command">lemma</span></span> take_subseq<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="free">n</span> <span class="free">xs</span> <span class="main">≼</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Graph-map_take_subseq"><span class="command">lemma</span></span> map_take_subseq<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="free">f</span> <span class="main">(</span>take <span class="free">n</span> <span class="free">xs</span><span class="main">)</span> <span class="main">≼</span> map <span class="free">f</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subseq_map<span class="main"><span class="keyword3">,</span></span> <span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Graph-path_distinct"><span class="command">lemma</span></span> path_distinct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"path <span class="free">l1</span> <span class="free">l2</span> <span class="free">xs</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">xs'</span><span class="main">.</span> distinct <span class="bound">xs'</span> <span class="main">∧</span> path <span class="free">l1</span> <span class="free">l2</span> <span class="bound">xs'</span> <span class="main">∧</span> map LBL <span class="bound">xs'</span> <span class="main">≼</span> map LBL <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> path.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>path0 <span class="skolem">l1</span> <span class="skolem">l2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">[]</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> path.intros<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>path <span class="skolem">l1</span> <span class="skolem">l2</span> <span class="skolem">xs</span> <span class="skolem">lbl</span> <span class="skolem">l3</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> ih<span class="main">:</span> <span class="quoted"><span class="quoted">"path <span class="skolem">l1</span> <span class="skolem">l2</span> <span class="skolem">xs'</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">xs'</span>"</span></span> <span class="quoted"><span class="quoted">"map LBL <span class="skolem">xs'</span> <span class="main">≼</span> map LBL <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">l2</span><span class="main">,</span> <span class="skolem">lbl</span><span class="main">,</span> <span class="skolem">l3</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">xs'</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">&lt;</span> length <span class="skolem">xs'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs'</span> <span class="main">!</span> <span class="skolem">m</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">l2</span><span class="main">,</span> <span class="skolem">lbl</span><span class="main">,</span> <span class="skolem">l3</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> in_set_conv_nth <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> m ih <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"path <span class="skolem">l1</span> <span class="skolem">l2</span> <span class="main">(</span>take <span class="skolem">m</span> <span class="skolem">xs'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> path_take_from<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> m ih path <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"take <span class="skolem"><span class="skolem">m</span></span> <span class="skolem"><span class="skolem">xs'</span></span> <span class="main"><span class="main">@</span></span> <span class="main"><span class="main">[</span></span><span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">l2</span></span><span class="main"><span class="main">,</span></span> <span class="skolem"><span class="skolem">lbl</span></span><span class="main"><span class="main">,</span></span> <span class="skolem"><span class="skolem">l3</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> distinct_take take_Suc_conv_app_nth<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> path.intros<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> ih<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> subseq_order.order.trans take_map take_subseq<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> ih path<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs'</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">l2</span><span class="main">,</span> <span class="skolem">lbl</span><span class="main">,</span> <span class="skolem">l3</span><span class="main">)</span><span class="main">]</span>"</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> path.intros<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Graph-path_edge"><span class="command">lemma</span></span> path_edge<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l1'</span><span class="main">,</span> <span class="free">lbl</span><span class="main">,</span> <span class="free">l2'</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> path <span class="free">l1</span> <span class="free">l2</span> <span class="free">xs</span> <span class="main">⟹</span> <span class="free">lbl</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">weights</span> <span class="free">l1'</span> <span class="free">l2'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rotate_tac</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> path.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Path Weights›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">sum_weights</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'lbl</span> list <span class="main">⇒</span> <span class="tfree">'lbl</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sum_weights</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span> foldr <span class="main">(+)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">sum_path_weights</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span> sum_weights <span class="main">(</span>map LBL <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">path_weightp</span> <span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∃</span><span class="bound">xs</span><span class="main">.</span> path <span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span> <span class="bound">xs</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> sum_path_weights <span class="bound">xs</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Graph-sum_not_less_zero"><span class="command">lemma</span></span> sum_not_less_zero<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">dest</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">::</span><span class="tfree">'lbl</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">⟹</span> False"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_le_not_le<span class="main">)</span>

<span class="keyword1" id="Graph-sum_le_zero"><span class="command">lemma</span></span> sum_le_zero<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">::</span><span class="tfree">'lbl</span><span class="main">)</span> <span class="main">≤</span> <span class="main">0</span> <span class="main">⟷</span> <span class="free">s</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_iff<span class="main">)</span>

<span class="keyword1" id="Graph-sum_le_zeroD"><span class="command">lemma</span></span> sum_le_zeroD<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">::</span><span class="tfree">'lbl</span><span class="main">)</span> <span class="main">≤</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Graph-foldr_plus_mono"><span class="command">lemma</span></span> foldr_plus_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">n</span><span class="main">::</span><span class="tfree">'lbl</span><span class="main">)</span> <span class="main">≤</span> <span class="free">m</span> <span class="main">⟹</span> foldr <span class="main">(+)</span> <span class="free">xs</span> <span class="free">n</span> <span class="main">≤</span> foldr <span class="main">(+)</span> <span class="free">xs</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> plus_mono<span class="main">)</span>

<span class="keyword1" id="Graph-sum_weights_append"><span class="command">lemma</span></span> sum_weights_append<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sum_weights <span class="main">(</span><span class="free">ys</span> <span class="main">@</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> sum_weights <span class="free">ys</span> <span class="main">+</span> sum_weights <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add.assoc<span class="main">)</span>

<span class="keyword1" id="Graph-sum_summary_prepend_le"><span class="command">lemma</span></span> sum_summary_prepend_le<span class="main">:</span> <span class="quoted"><span class="quoted">"sum_path_weights <span class="free">ys</span> <span class="main">≤</span> sum_path_weights <span class="free">xs</span> <span class="main">⟹</span> sum_path_weights <span class="main">(</span><span class="free">zs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">≤</span> sum_path_weights <span class="main">(</span><span class="free">zs</span> <span class="main">@</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">zs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> plus_mono<span class="main">)</span>

<span class="keyword1" id="Graph-sum_summary_append_le"><span class="command">lemma</span></span> sum_summary_append_le<span class="main">:</span> <span class="quoted"><span class="quoted">"sum_path_weights <span class="free">ys</span> <span class="main">≤</span> sum_path_weights <span class="free">xs</span> <span class="main">⟹</span> sum_path_weights <span class="main">(</span><span class="free">ys</span> <span class="main">@</span> <span class="free">zs</span><span class="main">)</span> <span class="main">≤</span> sum_path_weights <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">zs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">zs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">zs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> plus_mono map_append order_refl sum_weights_append<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Graph-foldr_plus_zero_le"><span class="command">lemma</span></span> foldr_plus_zero_le<span class="main">:</span> <span class="quoted"><span class="quoted">"foldr <span class="main">(+)</span> <span class="free">xs</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span><span class="tfree">'lbl</span><span class="main">)</span> <span class="main">≤</span> foldr <span class="main">(+)</span> <span class="free">xs</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> plus_mono<span class="main">)</span>

<span class="keyword1" id="Graph-subseq_sum_weights_le"><span class="command">lemma</span></span> subseq_sum_weights_le<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≼</span> <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum_weights <span class="free">xs</span> <span class="main">≤</span> sum_weights <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_emb.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>list_emb_Nil <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>list_emb_Cons <span class="skolem">xs</span> <span class="skolem">ys</span> <span class="skolem">y</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> order_trans <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_plus<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>list_emb_Cons2 <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">xs</span> <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> order_trans <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> plus_mono<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Graph-subseq_sum_path_weights_le"><span class="command">lemma</span></span> subseq_sum_path_weights_le<span class="main">:</span>
  <span class="quoted"><span class="quoted">"map LBL <span class="free">xs</span> <span class="main">≼</span> map LBL <span class="free">ys</span> <span class="main">⟹</span> sum_path_weights <span class="free">xs</span> <span class="main">≤</span> sum_path_weights <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subseq_sum_weights_le<span class="main">)</span>

<span class="keyword1" id="Graph-sum_path_weights_take_le"><span class="command">lemma</span></span> sum_path_weights_take_le<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sum_path_weights <span class="main">(</span>take <span class="free">i</span> <span class="free">xs</span><span class="main">)</span> <span class="main">≤</span> sum_path_weights <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subseq_sum_path_weights_le<span class="main">)</span>

<span class="keyword1" id="Graph-sum_weights_append_singleton"><span class="command">lemma</span></span> sum_weights_append_singleton<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sum_weights <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> sum_weights <span class="free">xs</span> <span class="main">+</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.assoc<span class="main">)</span>

<span class="keyword1" id="Graph-sum_path_weights_append_singleton"><span class="command">lemma</span></span> sum_path_weights_append_singleton<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sum_path_weights <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">l</span><span class="main">,</span><span class="free">x</span><span class="main">,</span><span class="free">l'</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> sum_path_weights <span class="free">xs</span> <span class="main">+</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.assoc<span class="main">)</span>

<span class="keyword1" id="Graph-path_weightp_ex_path"><span class="command">lemma</span></span> path_weightp_ex_path<span class="main">:</span>
  <span class="quoted"><span class="quoted">"path_weightp <span class="free">l1</span> <span class="free">l2</span> <span class="free">s</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">xs</span><span class="main">.</span>
  <span class="main">(</span><span class="keyword1">let</span> <span class="bound">s'</span> <span class="main">=</span> sum_path_weights <span class="bound">xs</span> <span class="keyword1">in</span> <span class="bound">s'</span> <span class="main">≤</span> <span class="free">s</span> <span class="main">∧</span> path_weightp <span class="free">l1</span> <span class="free">l2</span> <span class="bound">s'</span> <span class="main">∧</span> distinct <span class="bound">xs</span> <span class="main">∧</span>
  <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">l1</span><span class="main">,</span><span class="bound">s</span><span class="main">,</span><span class="bound">l2</span><span class="main">)</span> <span class="main">∈</span> set <span class="bound">xs</span><span class="main">.</span> <span class="bound">s</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">weights</span> <span class="bound">l1</span> <span class="bound">l2</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> path_weightp_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exE conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> path_distinct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exE conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> xs xs'
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">xs'</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> path_edge <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> subseq_sum_path_weights_le<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Graph-finite_set_summaries"><span class="command">lemma</span></span> finite_set_summaries<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">l1</span><span class="main">,</span><span class="bound">l2</span><span class="main">)</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">l1</span><span class="main">,</span><span class="bound">s</span><span class="main">,</span><span class="bound">l2</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>Sigma UNIV <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">l1</span><span class="main">,</span><span class="bound">l2</span><span class="main">)</span><span class="main">.</span> set_antichain <span class="main">(</span><span class="free">weights</span> <span class="bound">l1</span> <span class="bound">l2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Graph-finite_summaries"><span class="command">lemma</span></span> finite_summaries<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">xs</span><span class="main">.</span> distinct <span class="bound">xs</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">l1</span><span class="main">,</span> <span class="bound">s</span><span class="main">,</span> <span class="bound">l2</span><span class="main">)</span> <span class="main">∈</span> set <span class="bound">xs</span><span class="main">.</span> <span class="bound">s</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">weights</span> <span class="bound">l1</span> <span class="bound">l2</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ finite_distinct_bounded<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">l1</span></span><span class="main"><span class="main">,</span></span><span class="bound"><span class="bound">l2</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span><span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">l1</span></span><span class="main"><span class="main">,</span></span><span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">,</span></span><span class="bound"><span class="bound">l2</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">`</span></span> <span class="main"><span class="main">(</span></span>Sigma UNIV <span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">l1</span></span><span class="main"><span class="main">,</span></span><span class="bound"><span class="bound">l2</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> set_antichain <span class="main"><span class="main">(</span></span><span class="free"><span class="free">weights</span></span> <span class="bound"><span class="bound">l1</span></span> <span class="bound"><span class="bound">l2</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> finite_set_summaries<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Graph-finite_minimal_antichain_path_weightp"><span class="command">lemma</span></span> finite_minimal_antichain_path_weightp<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="main">(</span>minimal_antichain <span class="main">{</span><span class="bound">x</span><span class="main">.</span> path_weightp <span class="free">l1</span> <span class="free">l2</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> finite_surj<span class="main"><span class="main">[</span></span><span class="operator">OF</span> finite_summaries<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">sum_path_weights</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> minimal_antichain_def image_iff <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> path_weightp_ex_path<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">(* antichain of summaries along cycles-less paths (cycle-less = no edge repeated) *)</span>
<span class="keyword1"><span class="command">lift_definition</span></span> path_weight <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'vtx</span> <span class="main">⇒</span> <span class="tfree">'vtx</span> <span class="main">⇒</span> <span class="tfree">'lbl</span> antichain"</span></span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">l1</span> <span class="bound">l2</span><span class="main">.</span> minimal_antichain <span class="main">{</span><span class="bound">x</span><span class="main">.</span> path_weightp <span class="bound">l1</span> <span class="bound">l2</span> <span class="bound">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> finite_minimal_antichain_path_weightp
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">reachable</span> <span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span> <span class="main">≡</span> path_weight <span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span> <span class="main">≠</span> <span class="keyword1">{}<span class="hidden">⇩</span><sub>A</sub></span>"</span></span>

<span class="keyword1" id="Graph-in_path_weight"><span class="command">lemma</span></span> in_path_weight<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> path_weight <span class="free">loc1</span> <span class="free">loc2</span> <span class="main">⟷</span> <span class="free">s</span> <span class="main">∈</span> minimal_antichain <span class="main">{</span><span class="bound">s</span><span class="main">.</span> path_weightp <span class="free">loc1</span> <span class="free">loc2</span> <span class="bound">s</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1" id="Graph-path_weight_refl"><span class="command">lemma</span></span> path_weight_refl<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> path_weight <span class="free">loc</span> <span class="free">loc</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"path <span class="free">loc</span> <span class="free">loc</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> path0<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">=</span> sum_path_weights <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"path_weightp <span class="free">loc</span> <span class="free">loc</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> path_weightp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_path_weight in_minimal_antichain<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Graph-zero_in_minimal_antichain"><span class="command">lemma</span></span> zero_in_minimal_antichain<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">0</span><span class="main">::</span><span class="tfree">'lbl</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">∈</span> minimal_antichain <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_minimal_antichain <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sum_not_less_zero<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">path_weightp_distinct</span> <span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∃</span><span class="bound">xs</span><span class="main">.</span> distinct <span class="bound">xs</span> <span class="main">∧</span> path <span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span> <span class="bound">xs</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> sum_path_weights <span class="bound">xs</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Graph-minimal_antichain_path_weightp_distinct"><span class="command">lemma</span></span> minimal_antichain_path_weightp_distinct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"minimal_antichain <span class="main">{</span><span class="bound">xs</span><span class="main">.</span> path_weightp <span class="free">l1</span> <span class="free">l2</span> <span class="bound">xs</span><span class="main">}</span> <span class="main">=</span> minimal_antichain <span class="main">{</span><span class="bound">xs</span><span class="main">.</span> path_weightp_distinct <span class="free">l1</span> <span class="free">l2</span> <span class="bound">xs</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> path_weightp_def path_weightp_distinct_def minimal_antichain_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> path_distinct order.strict_iff_order subseq_sum_path_weights_le<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> le_less_trans path_distinct subseq_sum_weights_le<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Graph-finite_path_weightp_distinct"><span class="command">lemma</span></span> finite_path_weightp_distinct<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">xs</span><span class="main">.</span> path_weightp_distinct <span class="free">l1</span> <span class="free">l2</span> <span class="bound">xs</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> path_weightp_distinct_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> B <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"sum_path_weights <span class="main"><span class="main">`</span></span> <span class="main"><span class="main">{</span></span><span class="bound"><span class="bound">xs</span></span><span class="main"><span class="main">.</span></span> distinct <span class="bound"><span class="bound">xs</span></span> <span class="main"><span class="main">∧</span></span> path <span class="free"><span class="free">l1</span></span> <span class="free"><span class="free">l2</span></span> <span class="bound"><span class="bound">xs</span></span><span class="main"><span class="main">}</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> finite_imageI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ finite_summaries<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> path_edge<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Graph-path_weightp_distinct_nonempty"><span class="command">lemma</span></span> path_weightp_distinct_nonempty<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">xs</span><span class="main">.</span> path_weightp <span class="free">l1</span> <span class="free">l2</span> <span class="bound">xs</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟷</span> <span class="main">{</span><span class="bound">xs</span><span class="main">.</span> path_weightp_distinct <span class="free">l1</span> <span class="free">l2</span> <span class="bound">xs</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> path_distinct <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> path_weightp_def path_weightp_distinct_def<span class="main">)</span>

<span class="keyword1" id="Graph-path_weightp_distinct_member"><span class="command">lemma</span></span> path_weightp_distinct_member<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> path_weightp <span class="free">l1</span> <span class="free">l2</span> <span class="bound">s</span><span class="main">}</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> path_weightp_distinct <span class="free">l1</span> <span class="free">l2</span> <span class="bound">s</span><span class="main">}</span> <span class="main">∧</span> <span class="bound">u</span> <span class="main">≤</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> path_weightp_def path_weightp_distinct_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> path_distinct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subseq_sum_path_weights_le<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Graph-minimal_antichain_path_weightp_member"><span class="command">lemma</span></span> minimal_antichain_path_weightp_member<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">xs</span><span class="main">.</span> path_weightp <span class="free">l1</span> <span class="free">l2</span> <span class="bound">xs</span><span class="main">}</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> minimal_antichain <span class="main">{</span><span class="bound">xs</span><span class="main">.</span> path_weightp <span class="free">l1</span> <span class="free">l2</span> <span class="bound">xs</span><span class="main">}</span> <span class="main">∧</span> <span class="bound">u</span> <span class="main">≤</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">xs</span><span class="main">.</span> path_weightp <span class="free">l1</span> <span class="free">l2</span> <span class="bound">xs</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> path_weightp_distinct <span class="free">l1</span> <span class="free">l2</span> <span class="bound">s</span><span class="main">}</span> <span class="main">∧</span> <span class="skolem">u</span> <span class="main">≤</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> path_weightp_distinct_member <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">xs</span><span class="main">.</span> path_weightp_distinct <span class="free">l1</span> <span class="free">l2</span> <span class="bound">xs</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">from</span></span> u finite <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> minimal_antichain <span class="main">{</span><span class="bound">xs</span><span class="main">.</span> path_weightp_distinct <span class="free">l1</span> <span class="free">l2</span> <span class="bound">xs</span><span class="main">}</span> <span class="main">∧</span> <span class="skolem">v</span> <span class="main">≤</span> <span class="skolem">u</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> minimal_antichain_member<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> u <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> minimal_antichain_path_weightp_distinct<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Graph-path_path_weight"><span class="command">lemma</span></span> path_path_weight<span class="main">:</span> <span class="quoted"><span class="quoted">"path <span class="free">l1</span> <span class="free">l2</span> <span class="free">xs</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> path_weight <span class="free">l1</span> <span class="free">l2</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≤</span> sum_path_weights <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"path <span class="free">l1</span> <span class="free">l2</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_path_weights <span class="free">xs</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> path_weightp <span class="free">l1</span> <span class="free">l2</span> <span class="bound">x</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> path_weightp_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> minimal_antichain <span class="main">{</span><span class="bound">x</span><span class="main">.</span> path_weightp <span class="free">l1</span> <span class="free">l2</span> <span class="bound">x</span><span class="main">}</span> <span class="main">∧</span> <span class="skolem">u</span> <span class="main">≤</span> sum_path_weights <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">atomize_elim</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> minimal_antichain_path_weightp_member<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Graph-path_weight_conv_path"><span class="command">lemma</span></span> path_weight_conv_path<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> path_weight <span class="free">l1</span> <span class="free">l2</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">xs</span><span class="main">.</span> path <span class="free">l1</span> <span class="free">l2</span> <span class="bound">xs</span> <span class="main">∧</span> <span class="free">s</span> <span class="main">=</span> sum_path_weights <span class="bound">xs</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">ys</span><span class="main">.</span> path <span class="free">l1</span> <span class="free">l2</span> <span class="bound">ys</span> <span class="main">⟶</span> <span class="main">¬</span> sum_path_weights <span class="bound">ys</span> <span class="main">&lt;</span> sum_path_weights <span class="bound">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_minimal_antichain path_weightp_def<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">optimal_path</span> <span class="free"><span class="bound"><span class="entity">loc1</span></span></span> <span class="free"><span class="bound"><span class="entity">loc2</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span> path <span class="free"><span class="bound"><span class="entity">loc1</span></span></span> <span class="free"><span class="bound"><span class="entity">loc2</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">∧</span>
   <span class="main">(</span><span class="main">∀</span><span class="bound">ys</span><span class="main">.</span> path <span class="free"><span class="bound"><span class="entity">loc1</span></span></span> <span class="free"><span class="bound"><span class="entity">loc2</span></span></span> <span class="bound">ys</span> <span class="main">⟶</span> <span class="main">¬</span> sum_path_weights <span class="bound">ys</span> <span class="main">&lt;</span> sum_path_weights <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Graph-path_weight_path"><span class="command">lemma</span></span> path_weight_path<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> path_weight <span class="free">loc1</span> <span class="free">loc2</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">⋀</span><span class="bound">xs</span><span class="main">.</span> optimal_path <span class="free">loc1</span> <span class="free">loc2</span> <span class="bound">xs</span> <span class="main">⟹</span> distinct <span class="bound">xs</span> <span class="main">⟹</span> sum_path_weights <span class="bound">xs</span> <span class="main">=</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">atomize_elim</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_minimal_antichain path_weightp_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> path_distinct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> loc1 loc2 xs xs'
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">xs'</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
    <span class="keyword1"><span class="command">using</span></span> order.strict_iff_order subseq_sum_path_weights_le <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">using</span></span> less_le subseq_sum_path_weights_le <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Graph-path_weight_elem_trans"><span class="command">lemma</span></span> path_weight_elem_trans<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> path_weight <span class="free">l1</span> <span class="free">l2</span> <span class="main">⟹</span> <span class="free">s'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> path_weight <span class="free">l2</span> <span class="free">l3</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> path_weight <span class="free">l1</span> <span class="free">l3</span> <span class="main">∧</span> <span class="bound">u</span> <span class="main">≤</span> <span class="free">s</span> <span class="main">+</span> <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> ps1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span>  <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> path_weight <span class="free">l1</span> <span class="free">l2</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> ps2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> path_weight <span class="free">l2</span> <span class="free">l3</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> ps1 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> path1<span class="main">:</span> <span class="quoted"><span class="quoted">"path <span class="free">l1</span> <span class="free">l2</span> <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">=</span> sum_path_weights <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> path_weight_path<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> ps2 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="keyword2"><span class="keyword">where</span></span> path2<span class="main">:</span> <span class="quoted"><span class="quoted">"path <span class="free">l2</span> <span class="free">l3</span> <span class="skolem">ys</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s'</span> <span class="main">=</span> sum_path_weights <span class="skolem">ys</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> path_weight_path<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> path1<span class="main">(</span>1<span class="main">)</span> path2<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"path <span class="free">l1</span> <span class="free">l3</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> path_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> path1<span class="main">(</span>2<span class="main">)</span> path2<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">+</span> <span class="free">s'</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> path_weightp <span class="free">l1</span> <span class="free">l3</span> <span class="bound">s</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> path_weightp_def sum_weights_append<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> path_weight <span class="free">l1</span> <span class="free">l3</span> <span class="main">∧</span> <span class="bound">u</span> <span class="main">≤</span> <span class="free">s</span> <span class="main">+</span> <span class="free">s'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> minimal_antichain_path_weightp_member<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span></pre>
</div><div id="Propagate">
<div class="head">
<h1>Theory Propagate</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Local Progress Propagation\label{sec:propagate}›</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Propagate
  <span class="keyword2"><span class="keyword">imports</span></span>
    <a href="#Graph">Graph</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Specification›</span></span>

<span class="keyword1"><span class="command">record</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">overloaded</span></span><span class="main">)</span> <span class="main">(</span><span class="tfree">'loc</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">)</span> configuration <span class="main">=</span>
  c_work <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'loc</span> <span class="main">⇒</span> <span class="tfree">'t</span> zmultiset"</span></span> <span class="comment1">(* worklists with not-yet-applied updates *)</span>
  c_pts  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'loc</span> <span class="main">⇒</span> <span class="tfree">'t</span> zmultiset"</span></span> <span class="comment1">(* tracked point-stamps *)</span>
  c_imp  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'loc</span> <span class="main">⇒</span> <span class="tfree">'t</span> zmultiset"</span></span> <span class="comment1">(* alive point-stamps ("implications") *)</span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'loc</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">)</span> computation <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'loc</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">)</span> configuration stream"</span></span>

<span class="keyword1"><span class="command">locale</span></span> dataflow_topology <span class="main">=</span> flow<span class="main">?</span><span class="main">:</span> graph <span class="quoted"><span class="free">summary</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">summary</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'loc</span> <span class="main">⇒</span> <span class="tfree">'loc</span> <span class="main">::</span> finite <span class="main">⇒</span> <span class="tfree">'sum</span> <span class="main">::</span> <span class="main">{</span>order<span class="main">,</span> monoid_add<span class="main">}</span> antichain"</span></span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">results_in</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'t</span> <span class="main">::</span> order <span class="main">⇒</span> <span class="tfree">'sum</span> <span class="main">⇒</span> <span class="tfree">'t</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> results_in_zero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">results_in</span> <span class="free">t</span> <span class="main">0</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> results_in_mono_raw<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t1</span> <span class="main">≤</span> <span class="free">t2</span> <span class="main">⟹</span> <span class="free">s1</span> <span class="main">≤</span> <span class="free">s2</span> <span class="main">⟹</span> <span class="free">results_in</span> <span class="free">t1</span> <span class="free">s1</span> <span class="main">≤</span> <span class="free">results_in</span> <span class="free">t2</span> <span class="free">s2</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> followed_by_summary<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">results_in</span> <span class="main">(</span><span class="free">results_in</span> <span class="free">t</span> <span class="free">s1</span><span class="main">)</span> <span class="free">s2</span> <span class="main">=</span> <span class="free">results_in</span> <span class="free">t</span> <span class="main">(</span><span class="free">s1</span> <span class="main">+</span> <span class="free">s2</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> no_zero_cycle<span class="main">:</span> <span class="quoted"><span class="quoted">"path <span class="free">loc</span> <span class="free">loc</span> <span class="free">xs</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">=</span> sum_path_weights <span class="free">xs</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">&lt;</span> <span class="free">results_in</span> <span class="free">t</span> <span class="free">s</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Propagate-results_in_mono"><span class="command">lemma</span></span> results_in_mono<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">t1</span> <span class="main">≤</span> <span class="free">t2</span> <span class="main">⟹</span> <span class="free">results_in</span> <span class="free">t1</span> <span class="free">s</span> <span class="main">≤</span> <span class="free">results_in</span> <span class="free">t2</span> <span class="free">s</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">s1</span> <span class="main">≤</span> <span class="free">s2</span> <span class="main">⟹</span> <span class="free">results_in</span> <span class="free">t</span> <span class="free">s1</span> <span class="main">≤</span> <span class="free">results_in</span> <span class="free">t</span> <span class="free">s2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> results_in_mono_raw <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">path_summary</span> <span class="main">≡</span> path_weight"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">followed_by</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'sum</span> <span class="main">⇒</span> <span class="tfree">'sum</span> <span class="main">⇒</span> <span class="tfree">'sum</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">followed_by</span> <span class="main">≡</span> plus"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">safe</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'loc</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">)</span> configuration <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">safe</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">loc1</span> <span class="bound">loc2</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">.</span> zcount <span class="main">(</span>c_pts <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">loc1</span><span class="main">)</span> <span class="bound">t</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">s</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> path_summary <span class="bound">loc1</span> <span class="bound">loc2</span>
                <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">t'</span></span><span class="main">≤</span><span class="free">results_in</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">t'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">loc2</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Implications are always non-negative.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">inv_implications_nonneg</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">inv_implications_nonneg</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">loc</span> <span class="bound">t</span><span class="main">.</span> zcount <span class="main">(</span>c_imp <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">loc</span><span class="main">)</span> <span class="bound">t</span> <span class="main">≥</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">unchanged</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">zmset_frontier</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">zmset_frontier</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">≡</span> zmset_of <span class="main">(</span>mset_set <span class="main">(</span>set_antichain <span class="main">(</span>frontier <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">init_config</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">init_config</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">loc</span><span class="main">.</span>
      c_imp <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">loc</span> <span class="main">=</span> <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span> <span class="main">∧</span>
      c_work <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">loc</span> <span class="main">=</span> zmset_frontier <span class="main">(</span>c_pts <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">loc</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">after_summary</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'t</span> zmultiset <span class="main">⇒</span> <span class="tfree">'sum</span> antichain <span class="main">⇒</span> <span class="tfree">'t</span> zmultiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">after_summary</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∑</span><span class="bound">s</span> <span class="main">∈</span> set_antichain <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">.</span> image_zmset <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">results_in</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">frontier_changes</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'t</span> zmultiset <span class="main">⇒</span> <span class="tfree">'t</span> zmultiset <span class="main">⇒</span> <span class="tfree">'t</span> zmultiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">frontier_changes</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">≡</span> zmset_frontier <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">-</span> zmset_frontier <span class="free"><span class="bound"><span class="entity">N</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">next_change_multiplicity'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'loc</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">)</span> configuration <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'loc</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">)</span> configuration <span class="main">⇒</span> <span class="tfree">'loc</span> <span class="main">⇒</span> <span class="tfree">'t</span> <span class="main">⇒</span> int <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">next_change_multiplicity'</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span>
    <span class="comment1">― ‹n is the non-zero change in pointstamps at loc for timestamp t›</span>
     <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span>
    <span class="comment1">― ‹change can only happen at timestamps not in advance of implication-frontier›</span>
     <span class="main">(</span><span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="bound">t'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="bound">t'</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">∧</span>
       <span class="comment1">― ‹at loc, t is added to pointstamps n times›</span>
     <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span><span class="main">⦇</span>c_pts <span class="main">:=</span> <span class="main">(</span>c_pts <span class="free"><span class="bound"><span class="entity">c0</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="main">:=</span> update_zmultiset <span class="main">(</span>c_pts <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">,</span>
       <span class="comment1">― ‹worklist at loc is adjusted by frontier changes›</span>
             c_work <span class="main">:=</span> <span class="main">(</span>c_work <span class="free"><span class="bound"><span class="entity">c0</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="main">:=</span> c_work <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="main">+</span>
                frontier_changes <span class="main">(</span>update_zmultiset <span class="main">(</span>c_pts <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">(</span>c_pts <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">next_change_multiplicity</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'loc</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">)</span> configuration <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'loc</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">)</span> configuration <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">next_change_multiplicity</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">loc</span> <span class="bound">t</span> <span class="bound">n</span><span class="main">.</span> next_change_multiplicity' <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="bound">loc</span> <span class="bound">t</span> <span class="bound">n</span>"</span></span>

<span class="keyword1" id="Propagate-cm_unchanged_worklist"><span class="command">lemma</span></span> cm_unchanged_worklist<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"next_change_multiplicity' <span class="free">c0</span> <span class="free">c1</span> <span class="free">loc</span> <span class="free">t</span> <span class="free">n</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="free">loc'</span> <span class="main">≠</span> <span class="free">loc</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"c_work <span class="free">c1</span> <span class="free">loc'</span> <span class="main">=</span> c_work <span class="free">c0</span> <span class="free">loc'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> next_change_multiplicity'_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">next_propagate'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'loc</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">)</span> configuration <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'loc</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">)</span> configuration <span class="main">⇒</span> <span class="tfree">'loc</span> <span class="main">⇒</span> <span class="tfree">'t</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">next_propagate'</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span>
    <span class="comment1">― ‹t is a least timestamp of all worklist entries›</span>
      <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> c_work <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">t'</span> <span class="bound">loc'</span><span class="main">.</span> <span class="bound">t'</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> c_work <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="bound">loc'</span> <span class="main">⟶</span> <span class="main">¬</span> <span class="bound">t'</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">∧</span>
      <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span><span class="main">⦇</span>c_imp <span class="main">:=</span> <span class="main">(</span>c_imp <span class="free"><span class="bound"><span class="entity">c0</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="main">:=</span> c_imp <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="main">+</span> <span class="main">{#</span><span class="bound">t'</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> c_work <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span><span class="main">.</span> <span class="bound">t'</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">#}</span><span class="main">)</span><span class="main">,</span>
              c_work <span class="main">:=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">loc'</span><span class="main">.</span>
                  <span class="comment1">― ‹worklist entries for t are removed from loc's worklist›</span>
                    <span class="keyword1">if</span> <span class="bound">loc'</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="keyword1">then</span> <span class="main">{#</span><span class="bound">t'</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> c_work <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="bound">loc'</span><span class="main">.</span> <span class="bound">t'</span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">#}</span>
                  <span class="comment1">― ‹worklists at other locations change by the loc's frontier change after adding summaries›</span>
                    <span class="keyword1">else</span> c_work <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="bound">loc'</span>
                           <span class="main">+</span> after_summary
                               <span class="main">(</span>frontier_changes <span class="main">(</span>c_imp <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="main">+</span> <span class="main">{#</span><span class="bound">t'</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> c_work <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span><span class="main">.</span> <span class="bound">t'</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">#}</span><span class="main">)</span> <span class="main">(</span>c_imp <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span><span class="main">)</span><span class="main">)</span>
                               <span class="main">(</span><span class="free">summary</span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="bound">loc'</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">next_propagate</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'loc</span><span class="main">,</span> <span class="tfree">'t</span> <span class="main">::</span> order<span class="main">)</span> configuration <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'loc</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">)</span> configuration <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">next_propagate</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">loc</span> <span class="bound">t</span><span class="main">.</span> next_propagate' <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="bound">loc</span> <span class="bound">t</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted">"<span class="entity">next'</span>"</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">next'</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">=</span> <span class="main">(</span>next_propagate <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">∨</span> next_change_multiplicity <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted">"<span class="entity">next</span>"</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">next</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> next' <span class="main">(</span>shd <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">(</span>shd <span class="main">(</span>stl <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">cm_valid</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">cm_valid</span> <span class="main">≡</span> nxt <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> next_change_multiplicity <span class="main">(</span>shd <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>shd <span class="main">(</span>stl <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">impl</span>
                <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> next_change_multiplicity <span class="main">(</span>shd <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>shd <span class="main">(</span>stl <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">or</span> nxt <span class="main">(</span>holds <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">l</span><span class="main">.</span> c_work <span class="bound">c</span> <span class="bound">l</span> <span class="main">=</span> <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">spec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'loc</span><span class="main">,</span> <span class="tfree">'t</span> <span class="main">::</span> order<span class="main">)</span> computation <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">spec</span> <span class="main">≡</span> holds init_config <span class="keyword1">aand</span> alw next"</span></span>

<span class="keyword1" id="Propagate-next'_inv"><span class="command">lemma</span></span> next'_inv<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> next_change_multiplicity next_propagate next_finish_init<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"next' <span class="free">c0</span> <span class="free">c1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">loc</span> <span class="bound">t</span> <span class="bound">n</span><span class="main">.</span> <span class="free">P</span> <span class="free">c0</span> <span class="main">⟹</span> next_change_multiplicity' <span class="free">c0</span> <span class="free">c1</span> <span class="bound">loc</span> <span class="bound">t</span> <span class="bound">n</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">c1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">loc</span> <span class="bound">t</span><span class="main">.</span> <span class="free">P</span> <span class="free">c0</span> <span class="main">⟹</span> next_propagate' <span class="free">c0</span> <span class="free">c1</span> <span class="bound">loc</span> <span class="bound">t</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">c1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">c1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> next'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Auxiliary›</span></span>

<span class="keyword1" id="Propagate-next_change_multiplicity'_unique"><span class="command">lemma</span></span> next_change_multiplicity'_unique<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="bound">t'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c</span> <span class="free">loc</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">t'</span> <span class="main">≤</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound">c'</span><span class="main">.</span> next_change_multiplicity' <span class="free">c</span> <span class="bound">c'</span> <span class="free">loc</span> <span class="free">t</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?pointstamps'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>c_pts <span class="free">c</span><span class="main">)</span><span class="main">(</span><span class="free">loc</span> <span class="main">:=</span> update_zmultiset <span class="main">(</span>c_pts <span class="free">c</span> <span class="free">loc</span><span class="main">)</span> <span class="free">t</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?worklist'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">loc'</span><span class="main">.</span> c_work <span class="free">c</span> <span class="bound">loc'</span> <span class="main">+</span> frontier_changes <span class="main">(</span><span class="var">?pointstamps'</span> <span class="bound">loc'</span><span class="main">)</span> <span class="main">(</span>c_pts <span class="free">c</span> <span class="bound">loc'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?c'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">c</span><span class="main">⦇</span>c_pts <span class="main">:=</span> <span class="var">?pointstamps'</span><span class="main">,</span> c_work <span class="main">:=</span> <span class="var">?worklist'</span><span class="main">⦈</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"next_change_multiplicity' <span class="free">c</span> <span class="var">?c'</span> <span class="free">loc</span> <span class="free">t</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next_change_multiplicity'_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> configuration.equality<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ex1I<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?c'</span></span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span>  <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next_change_multiplicity'_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> configuration.equality<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Propagate-frontier_change_zmset_frontier"><span class="command">lemma</span></span> frontier_change_zmset_frontier<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="free">M1</span> <span class="main">-</span> frontier <span class="free">M0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>zmset_frontier <span class="free">M1</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∧</span> zcount <span class="main">(</span>zmset_frontier <span class="free">M0</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ac_Diff_iff<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> member_antichain.rep_eq<span class="main">)</span>

<span class="keyword1" id="Propagate-frontier_empty"><span class="command">lemma</span></span> frontier_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"frontier <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span> <span class="main">=</span> <span class="keyword1">{}<span class="hidden">⇩</span><sub>A</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer'</span> <span class="operator">simp</span>

<span class="keyword1" id="Propagate-zmset_frontier_empty"><span class="command">lemma</span></span> zmset_frontier_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"zmset_frontier <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span> <span class="main">=</span> <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Propagate-after_summary_empty"><span class="command">lemma</span></span> after_summary_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"after_summary <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">S</span> <span class="main">=</span> <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> after_summary_def<span class="main">)</span>

<span class="keyword1" id="Propagate-after_summary_empty_summary"><span class="command">lemma</span></span> after_summary_empty_summary<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"after_summary <span class="free">M</span> <span class="keyword1">{}<span class="hidden">⇩</span><sub>A</sub></span> <span class="main">=</span> <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> after_summary_def<span class="main">)</span>

<span class="keyword1" id="Propagate-mem_frontier_diff"><span class="command">lemma</span></span> mem_frontier_diff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="free">M</span> <span class="main">-</span> frontier <span class="free">N</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>frontier_changes <span class="free">M</span> <span class="free">N</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> assms
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="free">M</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">∉<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="free">N</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ac_Diff_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">from</span></span> t<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>zmset_frontier <span class="free">M</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> member_antichain.rep_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> t<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>zmset_frontier <span class="free">N</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> member_antichain.rep_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>frontier_changes <span class="free">M</span> <span class="free">N</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Propagate-mem_frontier_diff'"><span class="command">lemma</span></span> mem_frontier_diff'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="free">N</span> <span class="main">-</span> frontier <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>frontier_changes <span class="free">M</span> <span class="free">N</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> assms
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="free">N</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">∉<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="free">M</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ac_Diff_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">from</span></span> t<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>zmset_frontier <span class="free">M</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> member_antichain.rep_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> t<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>zmset_frontier <span class="free">N</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> member_antichain.rep_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>frontier_changes <span class="free">M</span> <span class="free">N</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Propagate-not_mem_frontier_diff"><span class="command">lemma</span></span> not_mem_frontier_diff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">∉<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="free">M</span> <span class="main">-</span> frontier <span class="free">N</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">∉<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="free">N</span> <span class="main">-</span> frontier <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>frontier_changes <span class="free">M</span> <span class="free">N</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="free">M</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> N<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="free">N</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> ac_notin_Diff<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> M N <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>zmset_frontier <span class="free">M</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>zmset_frontier <span class="free">N</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> member_antichain.rep_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>frontier_changes <span class="free">M</span> <span class="free">N</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">∉<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="free">M</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> N<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">∉<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="free">N</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> ac_notin_Diff<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> M N <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>zmset_frontier <span class="free">M</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>zmset_frontier <span class="free">N</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> member_antichain.rep_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>frontier_changes <span class="free">M</span> <span class="free">N</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>frontier_changes <span class="free">M</span> <span class="free">N</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Propagate-mset_neg_after_summary"><span class="command">lemma</span></span> mset_neg_after_summary<span class="main">:</span> <span class="quoted"><span class="quoted">"mset_neg <span class="free">M</span> <span class="main">=</span> <span class="main">{#}</span> <span class="main">⟹</span> mset_neg <span class="main">(</span>after_summary <span class="free">M</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> mset_neg_image_zmset mset_neg_sum_set <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> after_summary_def<span class="main">)</span>

<span class="comment1">― ‹Changes in loc's frontier are reflected in the worklist of loc'.›</span>
<span class="keyword1" id="Propagate-next_p_frontier_change"><span class="command">lemma</span></span> next_p_frontier_change<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"next_propagate' <span class="free">c0</span> <span class="free">c1</span> <span class="free">loc</span> <span class="free">t</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">summary</span> <span class="free">loc</span> <span class="free">loc'</span> <span class="main">≠</span> <span class="keyword1">{}<span class="hidden">⇩</span><sub>A</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"c_work <span class="free">c1</span> <span class="free">loc'</span> <span class="main">=</span>
         c_work <span class="free">c0</span> <span class="free">loc'</span>
          <span class="main">+</span> after_summary
              <span class="main">(</span>frontier_changes <span class="main">(</span>c_imp <span class="free">c1</span> <span class="free">loc</span><span class="main">)</span> <span class="main">(</span>c_imp <span class="free">c0</span> <span class="free">loc</span><span class="main">)</span><span class="main">)</span>
              <span class="main">(</span><span class="free">summary</span> <span class="free">loc</span> <span class="free">loc'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> summary_self next_propagate'_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> configuration.equality<span class="main">)</span>

<span class="keyword1" id="Propagate-after_summary_union"><span class="command">lemma</span></span> after_summary_union<span class="main">:</span> <span class="quoted"><span class="quoted">"after_summary <span class="main">(</span><span class="free">M</span> <span class="main">+</span> <span class="free">N</span><span class="main">)</span> <span class="free">S</span> <span class="main">=</span> after_summary <span class="free">M</span> <span class="free">S</span> <span class="main">+</span> after_summary <span class="free">N</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum.distrib after_summary_def<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Invariants›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Invariant: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">inv_imps_work_sum</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="comment1">― ‹Get timestamps in frontiers of loc's predecessor locations, apply respective summaries and
    return union of results.›</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">union_frontiers</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'loc</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">)</span> configuration <span class="main">⇒</span> <span class="tfree">'loc</span> <span class="main">⇒</span> <span class="tfree">'t</span> zmultiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">union_frontiers</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="main">≡</span>
    <span class="main">(</span><span class="main">∑</span><span class="bound">loc'</span><span class="main">∈</span>UNIV<span class="main">.</span> after_summary <span class="main">(</span>zmset_frontier <span class="main">(</span>c_imp <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">loc'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">summary</span> <span class="bound">loc'</span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">― ‹Implications + worklist is equal to the frontiers of pointstamps and all preceding nodes
    (after accounting for summaries).›</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">inv_imps_work_sum</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'loc</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">)</span> configuration <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">inv_imps_work_sum</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≡</span>
    <span class="main">∀</span><span class="bound">loc</span><span class="main">.</span> c_imp <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">loc</span> <span class="main">+</span> c_work <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">loc</span>
        <span class="main">=</span> zmset_frontier <span class="main">(</span>c_pts <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">loc</span><span class="main">)</span> <span class="main">+</span> union_frontiers <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">loc</span>"</span></span>

<span class="comment1">― ‹Version with zcount is easier to reason with›</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">inv_imps_work_sum_zcount</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'loc</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">)</span> configuration <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">inv_imps_work_sum_zcount</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≡</span>
    <span class="main">∀</span><span class="bound">loc</span> <span class="bound">t</span><span class="main">.</span> zcount <span class="main">(</span>c_imp <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">loc</span> <span class="main">+</span> c_work <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">loc</span><span class="main">)</span> <span class="bound">t</span>
          <span class="main">=</span> zcount <span class="main">(</span>zmset_frontier <span class="main">(</span>c_pts <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">loc</span><span class="main">)</span> <span class="main">+</span> union_frontiers <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">loc</span><span class="main">)</span> <span class="bound">t</span>"</span></span>

<span class="keyword1" id="Propagate-inv_imps_work_sum_zcount"><span class="command">lemma</span></span> inv_imps_work_sum_zcount<span class="main">:</span> <span class="quoted"><span class="quoted">"inv_imps_work_sum <span class="free">c</span> <span class="main">⟷</span> inv_imps_work_sum_zcount <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> inv_imps_work_sum_zcount_def inv_imps_work_sum_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zmultiset_eq_iff<span class="main">)</span>


<span class="keyword1" id="Propagate-union_frontiers_nonneg"><span class="command">lemma</span></span> union_frontiers_nonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> zcount <span class="main">(</span>union_frontiers <span class="free">c</span> <span class="free">loc</span><span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> zcount_sum<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sum_nonneg<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> mset_neg_zcount_nonneg<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> mset_neg_after_summary<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Propagate-next_p_union_frontier_change"><span class="command">lemma</span></span> next_p_union_frontier_change<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"next_propagate' <span class="free">c0</span> <span class="free">c1</span> <span class="free">loc</span> <span class="free">t</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">summary</span> <span class="free">loc</span> <span class="free">loc'</span> <span class="main">≠</span> <span class="keyword1">{}<span class="hidden">⇩</span><sub>A</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"union_frontiers <span class="free">c1</span> <span class="free">loc'</span> <span class="main">=</span>
         union_frontiers <span class="free">c0</span> <span class="free">loc'</span>
          <span class="main">+</span> after_summary
              <span class="main">(</span>frontier_changes <span class="main">(</span>c_imp <span class="free">c1</span> <span class="free">loc</span><span class="main">)</span> <span class="main">(</span>c_imp <span class="free">c0</span> <span class="free">loc</span><span class="main">)</span><span class="main">)</span>
              <span class="main">(</span><span class="free">summary</span> <span class="free">loc</span> <span class="free">loc'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> zmultiset_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> zcount_of_mset image_zmset_Diff<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> zcount_sum<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Sum_eq_pick_changed_elem<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">UNIV</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">loc</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> zcount_union<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> after_summary_union<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next_propagate'_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">― ‹<span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">init_config</span><span class="antiquote">}</span></span> satisfies <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">inv_imps_work_sum</span><span class="antiquote">}</span></span>›</span>
<span class="keyword1" id="Propagate-init_imp_inv_imps_work_sum"><span class="command">lemma</span></span> init_imp_inv_imps_work_sum<span class="main">:</span> <span class="quoted"><span class="quoted">"init_config <span class="free">c</span> <span class="main">⟹</span> inv_imps_work_sum <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inv_imps_work_sum_def init_config_def<span class="main">)</span>

<span class="comment1">― ‹CM preserves <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">inv_imps_work_sum</span><span class="antiquote">}</span></span>›</span>
<span class="keyword1" id="Propagate-cm_preserves_inv_imps_work_sum"><span class="command">lemma</span></span> cm_preserves_inv_imps_work_sum<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"next_change_multiplicity' <span class="free">c0</span> <span class="free">c1</span> <span class="free">loc</span> <span class="free">t</span> <span class="free">n</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"inv_imps_work_sum <span class="free">c0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"inv_imps_work_sum <span class="free">c1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="comment1">― ‹Given CM at loc, t, we show result for loc', t'›</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">loc</span> <span class="skolem">t</span> <span class="skolem">loc'</span> <span class="skolem">t'</span> <span class="skolem">n</span>
    <span class="keyword3"><span class="command">assume</span></span> cm'<span class="main">:</span> <span class="quoted"><span class="quoted">"next_change_multiplicity' <span class="free">c0</span> <span class="free">c1</span> <span class="skolem">loc</span> <span class="skolem">t</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">note</span></span> cm <span class="main">=</span> this<span class="main">[</span><span class="operator">unfolded</span> next_change_multiplicity'_def<span class="main">]</span>
    <span class="keyword1"><span class="command">from</span></span> cm <span class="keyword1"><span class="command">have</span></span> unchanged_imps<span class="main">:</span> <span class="quoted"><span class="quoted">"unchanged c_imp <span class="free">c0</span> <span class="free">c1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"inv_imps_work_sum <span class="free">c0</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> iiws'<span class="main">:</span> <span class="quoted"><span class="quoted">"inv_imps_work_sum_zcount <span class="free">c0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inv_imps_work_sum_zcount<span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> iiws <span class="main">=</span> iiws'<span class="main">[</span><span class="operator">unfolded</span> inv_imps_work_sum_zcount_def<span class="main">,</span> <span class="operator">THEN</span> spec2<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> unchanged_union<span class="main">:</span> <span class="quoted"><span class="quoted">"union_frontiers <span class="free">c1</span> <span class="skolem">locX</span> <span class="main">=</span> union_frontiers <span class="free">c0</span> <span class="skolem">locX</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">locX</span>
      <span class="keyword1"><span class="command">using</span></span> unchanged_imps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sum.cong<span class="main">)</span>
        <span class="comment1">― ‹For locations other than loc nothing changes.›</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> loc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">loc'</span> <span class="main">≠</span> <span class="skolem">loc</span>"</span></span>
      <span class="keyword1"><span class="command">note</span></span> iiws <span class="main">=</span> iiws'<span class="main">[</span><span class="operator">unfolded</span> inv_imps_work_sum_zcount_def<span class="main">,</span> <span class="operator">THEN</span> spec2<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">loc'</span></span> <span class="quoted"><span class="skolem">t'</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">from</span></span> loc cm <span class="keyword1"><span class="command">have</span></span> unchanged_worklist<span class="main">:</span>
        <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>c_work <span class="free">c1</span> <span class="skolem">loc'</span><span class="main">)</span> <span class="skolem">t'</span> <span class="main">=</span> zcount <span class="main">(</span>c_work <span class="free">c0</span> <span class="skolem">loc'</span><span class="main">)</span> <span class="skolem">t'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> loc cm <span class="keyword1"><span class="command">have</span></span> unchanged_frontier<span class="main">:</span>
        <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>zmset_frontier <span class="main">(</span>c_pts <span class="free">c1</span> <span class="skolem">loc'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t'</span>
       <span class="main">=</span> zcount <span class="main">(</span>zmset_frontier <span class="main">(</span>c_pts <span class="free">c0</span>       <span class="skolem">loc'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> loc <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>c_imp <span class="free">c1</span> <span class="skolem">loc'</span> <span class="main">+</span> c_work <span class="free">c1</span> <span class="skolem">loc'</span><span class="main">)</span> <span class="skolem">t'</span>
            <span class="main">=</span> zcount <span class="main">(</span>zmset_frontier <span class="main">(</span>c_pts <span class="free">c1</span> <span class="skolem">loc'</span><span class="main">)</span>
                <span class="main">+</span> union_frontiers <span class="free">c1</span> <span class="skolem">loc'</span><span class="main">)</span> <span class="skolem">t'</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> zcount_union<span class="main">)</span>
        <span class="keyword1"><span class="command">unfolding</span></span>
          unchanged_imps
          unchanged_union
          unchanged_frontier
          unchanged_worklist
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> zcount_union<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> iiws<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
      <span class="comment1">― ‹For pointstamps at location loc we make a case distinction on whether their "status" in
          the frontier has changed.›</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> loc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">loc'</span> <span class="main">=</span> <span class="skolem">loc</span>"</span></span>
      <span class="keyword1"><span class="command">note</span></span> iiws <span class="main">=</span> iiws'<span class="main">[</span><span class="operator">unfolded</span> inv_imps_work_sum_zcount_def<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">THEN</span> spec<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">loc</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
        <span class="comment1">― ‹If t appeared in the frontier›</span>
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> t'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_pts <span class="free">c1</span> <span class="skolem">loc</span><span class="main">)</span> <span class="main">-</span> frontier <span class="main">(</span>c_pts <span class="free">c0</span> <span class="skolem">loc</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">note</span></span> t'<span class="main">[</span><span class="operator">THEN</span> mem_frontier_diff<span class="main">]</span>
          <span class="comment1">― ‹then the worklist at t increased by 1›</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>c_work <span class="free">c1</span> <span class="skolem">loc</span><span class="main">)</span> <span class="skolem">t'</span> <span class="main">=</span> zcount <span class="main">(</span>c_work <span class="free">c0</span> <span class="skolem">loc</span><span class="main">)</span> <span class="skolem">t'</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> cm <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="comment1">― ‹and the frontier at t increased by 1›</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>zmset_frontier <span class="main">(</span>c_pts <span class="free">c1</span> <span class="skolem">loc</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t'</span>
              <span class="main">=</span> zcount <span class="main">(</span>zmset_frontier <span class="main">(</span>c_pts <span class="free">c0</span> <span class="skolem">loc</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t'</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> t'<span class="main">[</span><span class="operator">THEN</span> frontier_change_zmset_frontier<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="comment1">― ‹and the sum didn't change›</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> unchanged_union
          <span class="comment1">― ‹hence, the invariant is preserved.›</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
          <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>c_imp <span class="free">c1</span> <span class="skolem">loc</span> <span class="main">+</span> c_work <span class="free">c1</span> <span class="skolem">loc</span><span class="main">)</span> <span class="skolem">t'</span>
            <span class="main">=</span> zcount <span class="main">(</span>zmset_frontier <span class="main">(</span>c_pts <span class="free">c1</span> <span class="skolem">loc</span><span class="main">)</span>
              <span class="main">+</span> union_frontiers <span class="free">c1</span> <span class="skolem">loc</span><span class="main">)</span> <span class="skolem">t'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> iiws unchanged_imps <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
        <span class="comment1">― ‹If t disappeared from the frontier›</span>
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> t'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_pts <span class="free">c0</span> <span class="skolem">loc</span><span class="main">)</span> <span class="main">-</span> frontier <span class="main">(</span>c_pts <span class="free">c1</span> <span class="skolem">loc</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">note</span></span> t'<span class="main">[</span><span class="operator">THEN</span> mem_frontier_diff'<span class="main">]</span>
          <span class="comment1">― ‹then the worklist at t decreased by 1›</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>c_work <span class="free">c1</span> <span class="skolem">loc</span><span class="main">)</span> <span class="skolem">t'</span> <span class="main">=</span> zcount <span class="main">(</span>c_work <span class="free">c0</span> <span class="skolem">loc</span><span class="main">)</span> <span class="skolem">t'</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> cm <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ac_Diff_iff<span class="main">)</span>
            <span class="comment1">― ‹and the frontier at t decreased by 1›</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>zmset_frontier <span class="main">(</span>c_pts <span class="free">c1</span> <span class="skolem">loc</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t'</span>
              <span class="main">=</span> zcount <span class="main">(</span>zmset_frontier <span class="main">(</span>c_pts <span class="free">c0</span> <span class="skolem">loc</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t'</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> t'<span class="main">[</span><span class="operator">THEN</span> frontier_change_zmset_frontier<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="comment1">― ‹and the sum didn't change›</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> unchanged_union
          <span class="comment1">― ‹hence, the invariant is preserved.›</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
          <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>c_imp <span class="free">c1</span> <span class="skolem">loc</span> <span class="main">+</span> c_work <span class="free">c1</span> <span class="skolem">loc</span><span class="main">)</span> <span class="skolem">t'</span>
            <span class="main">=</span> zcount <span class="main">(</span>zmset_frontier <span class="main">(</span>c_pts <span class="free">c1</span> <span class="skolem">loc</span><span class="main">)</span>
              <span class="main">+</span> union_frontiers <span class="free">c1</span> <span class="skolem">loc</span><span class="main">)</span> <span class="skolem">t'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> iiws unchanged_imps <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
        <span class="comment1">― ‹If t's multiplicity in the frontier didn't change›</span>
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">t'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_pts <span class="free">c1</span> <span class="skolem">loc</span><span class="main">)</span> <span class="main">-</span> frontier <span class="main">(</span>c_pts <span class="free">c0</span> <span class="skolem">loc</span><span class="main">)</span>"</span></span>
        <span class="keyword3"><span class="command">assume</span></span> a2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">t'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_pts <span class="free">c0</span> <span class="skolem">loc</span><span class="main">)</span> <span class="main">-</span> frontier <span class="main">(</span>c_pts <span class="free">c1</span> <span class="skolem">loc</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> a1 a2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>frontier_changes <span class="main">(</span>c_pts <span class="free">c1</span> <span class="skolem">loc</span><span class="main">)</span> <span class="main">(</span>c_pts <span class="free">c0</span> <span class="skolem">loc</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t'</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> not_mem_frontier_diff<span class="main">)</span>
            <span class="comment1">― ‹then the worklist at t didn't change›</span>
        <span class="keyword1"><span class="command">with</span></span> cm <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>c_work <span class="free">c1</span> <span class="skolem">loc</span><span class="main">)</span> <span class="skolem">t'</span> <span class="main">=</span> zcount <span class="main">(</span>c_work <span class="free">c0</span> <span class="skolem">loc</span><span class="main">)</span> <span class="skolem">t'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ac_Diff_iff<span class="main">)</span>
            <span class="comment1">― ‹and the frontier at t didn't change›</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>zmset_frontier <span class="main">(</span>c_pts <span class="free">c1</span> <span class="skolem">loc</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t'</span>
            <span class="main">=</span> zcount <span class="main">(</span>zmset_frontier <span class="main">(</span>c_pts <span class="free">c0</span> <span class="skolem">loc</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> a1 a2
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> member_antichain.rep_eq <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ac_notin_Diff<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> ac_Diff_iff count_mset_set<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> count_mset_set<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> finite_set_antichain member_antichain.rep_eq<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
            <span class="comment1">― ‹and the sum didn't change›</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> unchanged_union
          <span class="comment1">― ‹hence, the invariant is preserved.›</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
          <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>c_imp <span class="free">c1</span> <span class="skolem">loc</span> <span class="main">+</span> c_work <span class="free">c1</span> <span class="skolem">loc</span><span class="main">)</span> <span class="skolem">t'</span>
            <span class="main">=</span> zcount <span class="main">(</span>zmset_frontier <span class="main">(</span>c_pts <span class="free">c1</span> <span class="skolem">loc</span><span class="main">)</span>
              <span class="main">+</span> union_frontiers <span class="free">c1</span> <span class="skolem">loc</span><span class="main">)</span> <span class="skolem">t'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> iiws unchanged_imps <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>c_imp <span class="free">c1</span> <span class="skolem">loc'</span> <span class="main">+</span> c_work <span class="free">c1</span> <span class="skolem">loc'</span><span class="main">)</span> <span class="skolem">t'</span>
            <span class="main">=</span> zcount <span class="main">(</span>zmset_frontier <span class="main">(</span>c_pts <span class="free">c1</span> <span class="skolem">loc'</span><span class="main">)</span>
              <span class="main">+</span> union_frontiers <span class="free">c1</span> <span class="skolem">loc'</span><span class="main">)</span> <span class="skolem">t'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> loc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>c_imp <span class="free">c1</span> <span class="skolem">loc'</span> <span class="main">+</span> c_work <span class="free">c1</span> <span class="skolem">loc'</span><span class="main">)</span> <span class="skolem">t'</span>
          <span class="main">=</span> zcount <span class="main">(</span>zmset_frontier <span class="main">(</span>c_pts <span class="free">c1</span> <span class="skolem">loc'</span><span class="main">)</span>
              <span class="main">+</span> union_frontiers <span class="free">c1</span> <span class="skolem">loc'</span><span class="main">)</span> <span class="skolem">t'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def inv_imps_work_sum_zcount inv_imps_work_sum_zcount_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">― ‹PR preserves <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">inv_imps_work_sum</span><span class="antiquote">}</span></span>›</span>
<span class="keyword1" id="Propagate-p_preserves_inv_imps_work_sum"><span class="command">lemma</span></span> p_preserves_inv_imps_work_sum<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"next_propagate' <span class="free">c0</span> <span class="free">c1</span> <span class="free">loc</span> <span class="free">t</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"inv_imps_work_sum <span class="free">c0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"inv_imps_work_sum <span class="free">c1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="comment1">― ‹Given <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">next_propagate'</span><span class="antiquote">}</span></span> for loc, t, we show the result for loc', t'.›</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">loc</span> <span class="skolem">t</span> <span class="skolem">loc'</span> <span class="skolem">t'</span>
    <span class="keyword3"><span class="command">assume</span></span> p'<span class="main">:</span> <span class="quoted"><span class="quoted">"next_propagate' <span class="free">c0</span> <span class="free">c1</span> <span class="skolem">loc</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">note</span></span> p <span class="main">=</span> this<span class="main">[</span><span class="operator">unfolded</span> next_propagate'_def<span class="main">]</span>
    <span class="keyword1"><span class="command">from</span></span> p <span class="keyword1"><span class="command">have</span></span> unchanged_ps<span class="main">:</span> <span class="quoted"><span class="quoted">"unchanged c_pts <span class="free">c0</span> <span class="free">c1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"inv_imps_work_sum <span class="free">c0</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> iiws'<span class="main">:</span> <span class="quoted"><span class="quoted">"inv_imps_work_sum_zcount <span class="free">c0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inv_imps_work_sum_zcount<span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> iiws <span class="main">=</span> iiws'<span class="main">[</span><span class="operator">unfolded</span> inv_imps_work_sum_zcount_def<span class="main">,</span> <span class="operator">THEN</span> spec2<span class="main">]</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> loc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">loc</span><span class="main">=</span><span class="skolem">loc'</span>"</span></span>
      <span class="keyword1"><span class="command">note</span></span> iiws
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> unchanged_ps
        <span class="comment1">― ‹The t entries in loc's worklist are shifted to the implications.›</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> p <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>c_work <span class="free">c1</span> <span class="skolem">loc</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> p <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>c_imp <span class="free">c1</span> <span class="skolem">loc</span><span class="main">)</span> <span class="skolem">t</span>
         <span class="main">=</span> zcount <span class="main">(</span>c_imp <span class="free">c0</span> <span class="skolem">loc</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">+</span> zcount <span class="main">(</span>c_work <span class="free">c0</span> <span class="skolem">loc</span><span class="main">)</span> <span class="skolem">t</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="comment1">― ‹Since the implications of other locations don't change and loc can't have an edge to
              itself, <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">union_frontiers</span><span class="antiquote">}</span></span> at loc doesn't change.›</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> p <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"union_frontiers <span class="free">c1</span> <span class="skolem">loc</span> <span class="main">=</span> union_frontiers <span class="free">c0</span> <span class="skolem">loc</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> summary_self <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.cong arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted">Sum</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="comment1">― ‹For all the other timestamps the worklist and implications don't change.›</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> p <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">tX</span> <span class="main">≠</span> <span class="skolem">t</span> <span class="main">⟹</span> zcount <span class="main">(</span>c_work <span class="free">c1</span> <span class="skolem">loc</span><span class="main">)</span> <span class="skolem">tX</span> <span class="main">=</span> zcount <span class="main">(</span>c_work <span class="free">c0</span> <span class="skolem">loc</span><span class="main">)</span> <span class="skolem">tX</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">tX</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> p <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">tX</span> <span class="main">≠</span> <span class="skolem">t</span> <span class="main">⟹</span> zcount <span class="main">(</span>c_imp <span class="free">c1</span> <span class="skolem">loc</span><span class="main">)</span> <span class="skolem">tX</span> <span class="main">=</span> zcount <span class="main">(</span>c_imp <span class="free">c0</span> <span class="skolem">loc</span><span class="main">)</span> <span class="skolem">tX</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">tX</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>c_imp <span class="free">c1</span> <span class="skolem">loc'</span> <span class="main">+</span> c_work <span class="free">c1</span> <span class="skolem">loc'</span><span class="main">)</span> <span class="skolem">t'</span>
         <span class="main">=</span> zcount <span class="main">(</span>zmset_frontier <span class="main">(</span>c_pts <span class="free">c1</span> <span class="skolem">loc'</span><span class="main">)</span> <span class="main">+</span> union_frontiers <span class="free">c1</span> <span class="skolem">loc'</span><span class="main">)</span> <span class="skolem">t'</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> loc
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span><span class="main">=</span><span class="skolem">t'</span>"</span></span><span class="main">)</span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> loc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">loc</span><span class="main">≠</span><span class="skolem">loc'</span>"</span></span>
        <span class="comment1">― ‹The implications are unchanged at all locations other than loc.›</span>
      <span class="keyword1"><span class="command">from</span></span> p loc <span class="keyword1"><span class="command">have</span></span> unchanged_imps<span class="main">:</span> <span class="quoted"><span class="quoted">"c_imp <span class="free">c1</span> <span class="skolem">loc'</span> <span class="main">=</span> c_imp <span class="free">c0</span> <span class="skolem">loc'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> sum<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">summary</span> <span class="skolem">loc</span> <span class="skolem">loc'</span> <span class="main">=</span> <span class="keyword1">{}<span class="hidden">⇩</span><sub>A</sub></span>"</span></span>
        <span class="keyword1"><span class="command">note</span></span> iiws
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> unchanged_ps
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> unchanged_imps
          <span class="comment1">― ‹The worklist only changes if loc, loc' are connected.›</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> p loc sum <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"c_work <span class="free">c1</span> <span class="skolem">loc'</span> <span class="main">=</span> c_work <span class="free">c0</span> <span class="skolem">loc'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="comment1">― ‹Since the implications only change at loc and loc is not connected to loc',
            <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">union_frontiers</span><span class="antiquote">}</span></span> doesn't change.›</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> p loc sum <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"union_frontiers <span class="free">c1</span> <span class="skolem">loc'</span> <span class="main">=</span> union_frontiers <span class="free">c0</span> <span class="skolem">loc'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.cong arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted">Sum</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
          <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>c_imp <span class="free">c1</span> <span class="skolem">loc'</span> <span class="main">+</span> c_work <span class="free">c1</span> <span class="skolem">loc'</span><span class="main">)</span> <span class="skolem">t'</span>
           <span class="main">=</span> zcount <span class="main">(</span>zmset_frontier <span class="main">(</span>c_pts <span class="free">c1</span> <span class="skolem">loc'</span><span class="main">)</span> <span class="main">+</span> union_frontiers <span class="free">c1</span> <span class="skolem">loc'</span><span class="main">)</span> <span class="skolem">t'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> sum<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">summary</span> <span class="skolem">loc</span> <span class="skolem">loc'</span> <span class="main">≠</span> <span class="keyword1">{}<span class="hidden">⇩</span><sub>A</sub></span>"</span></span>
          <span class="comment1">― ‹<span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">union_frontiers</span><span class="antiquote">}</span></span> at loc' changed by whatever amount the frontier changed.›</span>
        <span class="keyword1"><span class="command">note</span></span> iiws
          unchanged_imps
          unchanged_ps
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> p' sum <span class="keyword1"><span class="command">have</span></span>
          <span class="quoted"><span class="quoted">"union_frontiers <span class="free">c1</span> <span class="skolem">loc'</span> <span class="main">=</span>
           union_frontiers <span class="free">c0</span> <span class="skolem">loc'</span>
            <span class="main">+</span> after_summary
                <span class="main">(</span>zmset_frontier <span class="main">(</span>c_imp <span class="free">c1</span> <span class="skolem">loc</span><span class="main">)</span> <span class="main">-</span> zmset_frontier <span class="main">(</span>c_imp <span class="free">c0</span> <span class="skolem">loc</span><span class="main">)</span><span class="main">)</span>
                <span class="main">(</span><span class="free">summary</span> <span class="skolem">loc</span> <span class="skolem">loc'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> next_p_union_frontier_change<span class="main">)</span>
            <span class="comment1">― ‹The worklist at loc' changed by the same amount›</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> p' sum <span class="keyword1"><span class="command">have</span></span>
          <span class="quoted"><span class="quoted">"c_work <span class="free">c1</span> <span class="skolem">loc'</span> <span class="main">=</span>
           c_work <span class="free">c0</span> <span class="skolem">loc'</span>
            <span class="main">+</span> after_summary
                <span class="main">(</span>zmset_frontier <span class="main">(</span>c_imp <span class="free">c1</span> <span class="skolem">loc</span><span class="main">)</span> <span class="main">-</span> zmset_frontier <span class="main">(</span>c_imp <span class="free">c0</span> <span class="skolem">loc</span><span class="main">)</span><span class="main">)</span>
                <span class="main">(</span><span class="free">summary</span> <span class="skolem">loc</span> <span class="skolem">loc'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> next_p_frontier_change<span class="main">)</span>
            <span class="comment1">― ‹The two changes cancel out.›</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
          <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>c_imp <span class="free">c1</span> <span class="skolem">loc'</span> <span class="main">+</span> c_work <span class="free">c1</span> <span class="skolem">loc'</span><span class="main">)</span> <span class="skolem">t'</span>
         <span class="main">=</span> zcount <span class="main">(</span>zmset_frontier <span class="main">(</span>c_pts <span class="free">c1</span> <span class="skolem">loc'</span><span class="main">)</span> <span class="main">+</span> union_frontiers <span class="free">c1</span> <span class="skolem">loc'</span><span class="main">)</span> <span class="skolem">t'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>c_imp <span class="free">c1</span> <span class="skolem">loc'</span> <span class="main">+</span> c_work <span class="free">c1</span> <span class="skolem">loc'</span><span class="main">)</span> <span class="skolem">t'</span>
         <span class="main">=</span> zcount <span class="main">(</span>zmset_frontier <span class="main">(</span>c_pts <span class="free">c1</span> <span class="skolem">loc'</span><span class="main">)</span> <span class="main">+</span> union_frontiers <span class="free">c1</span> <span class="skolem">loc'</span><span class="main">)</span> <span class="skolem">t'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>c_imp <span class="free">c1</span> <span class="skolem">loc'</span> <span class="main">+</span> c_work <span class="free">c1</span> <span class="skolem">loc'</span><span class="main">)</span> <span class="skolem">t'</span>
         <span class="main">=</span> zcount <span class="main">(</span>zmset_frontier <span class="main">(</span>c_pts <span class="free">c1</span> <span class="skolem">loc'</span><span class="main">)</span> <span class="main">+</span> union_frontiers <span class="free">c1</span> <span class="skolem">loc'</span><span class="main">)</span> <span class="skolem">t'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">loc</span><span class="main">=</span><span class="skolem">loc'</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next_propagate'_def Let_def inv_imps_work_sum_zcount inv_imps_work_sum_zcount_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Propagate-next_preserves_inv_imps_work_sum"><span class="command">lemma</span></span> next_preserves_inv_imps_work_sum<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"next <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"holds inv_imps_work_sum <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"nxt <span class="main">(</span>holds inv_imps_work_sum<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
    cm_preserves_inv_imps_work_sum
    p_preserves_inv_imps_work_sum
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> next'_inv<span class="main">)</span>

<span class="keyword1" id="Propagate-spec_imp_iiws"><span class="command">lemma</span></span> spec_imp_iiws<span class="main">:</span> <span class="quoted"><span class="quoted">"spec <span class="free">s</span> <span class="main">⟹</span> alw <span class="main">(</span>holds inv_imps_work_sum<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> init_imp_inv_imps_work_sum next_preserves_inv_imps_work_sum
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> alw_invar <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> alw_mono spec_def<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Invariant: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">inv_imp_plus_work_nonneg</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹There is never an update in the worklist that could cause implications to become negative.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">inv_imp_plus_work_nonneg</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">inv_imp_plus_work_nonneg</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">loc</span> <span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> zcount <span class="main">(</span>c_imp <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">loc</span><span class="main">)</span> <span class="bound">t</span> <span class="main">+</span> zcount <span class="main">(</span>c_work <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">loc</span><span class="main">)</span> <span class="bound">t</span>"</span></span>

<span class="keyword1" id="Propagate-iiws_imp_iipwn"><span class="command">lemma</span></span> iiws_imp_iipwn<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inv_imps_work_sum <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inv_imp_plus_work_nonneg <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">loc</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"inv_imps_work_sum <span class="free">c</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> iiws'<span class="main">:</span> <span class="quoted"><span class="quoted">"inv_imps_work_sum_zcount <span class="free">c</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inv_imps_work_sum_zcount<span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> iiws <span class="main">=</span> iiws'<span class="main">[</span><span class="operator">unfolded</span> inv_imps_work_sum_zcount_def<span class="main">,</span> <span class="operator">THEN</span> spec2<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> zcount <span class="main">(</span>union_frontiers <span class="free">c</span> <span class="skolem">loc</span><span class="main">)</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_frontiers_nonneg<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> iiws <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> zcount <span class="main">(</span>c_imp <span class="free">c</span> <span class="skolem">loc</span> <span class="main">+</span> c_work <span class="free">c</span> <span class="skolem">loc</span><span class="main">)</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inv_imp_plus_work_nonneg_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Propagate-spec_imp_iipwn"><span class="command">lemma</span></span> spec_imp_iipwn<span class="main">:</span> <span class="quoted"><span class="quoted">"spec <span class="free">s</span> <span class="main">⟹</span> alw <span class="main">(</span>holds inv_imp_plus_work_nonneg<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> spec_imp_iiws iiws_imp_iipwn
    alw_mono holds_mono
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>


<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Invariant: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">inv_implications_nonneg</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1" id="Propagate-init_imp_inv_implications_nonneg"><span class="command">lemma</span></span> init_imp_inv_implications_nonneg<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"init_config <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"inv_implications_nonneg <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> init_config_def inv_implications_nonneg_def<span class="main">)</span>

<span class="keyword1" id="Propagate-cm_preserves_inv_implications_nonneg"><span class="command">lemma</span></span> cm_preserves_inv_implications_nonneg<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"next_change_multiplicity' <span class="free">c0</span> <span class="free">c1</span> <span class="free">loc</span> <span class="free">t</span> <span class="free">n</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"inv_implications_nonneg <span class="free">c0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"inv_implications_nonneg <span class="free">c1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next_change_multiplicity'_def inv_implications_nonneg_def<span class="main">)</span>

<span class="keyword1" id="Propagate-p_preserves_inv_implications_nonneg"><span class="command">lemma</span></span> p_preserves_inv_implications_nonneg<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"next_propagate' <span class="free">c0</span> <span class="free">c1</span> <span class="free">loc</span> <span class="free">t</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"inv_implications_nonneg <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"inv_imp_plus_work_nonneg <span class="free">c0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"inv_implications_nonneg <span class="free">c1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next_propagate'_def Let_def inv_implications_nonneg_def inv_imp_plus_work_nonneg_def<span class="main">)</span>

<span class="keyword1" id="Propagate-next_preserves_inv_implications_nonneg"><span class="command">lemma</span></span> next_preserves_inv_implications_nonneg<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"next <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"holds inv_implications_nonneg <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"holds inv_imp_plus_work_nonneg <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"nxt <span class="main">(</span>holds inv_implications_nonneg<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
    cm_preserves_inv_implications_nonneg
    p_preserves_inv_implications_nonneg
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> next'_inv<span class="main">)</span>

<span class="keyword1" id="Propagate-alw_inv_implications_nonneg"><span class="command">lemma</span></span> alw_inv_implications_nonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"spec <span class="free">s</span> <span class="main">⟹</span> alw <span class="main">(</span>holds inv_implications_nonneg<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> spec_imp_iipwn<span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> spec_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> alw_invar<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> init_imp_inv_implications_nonneg <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command">using</span></span> next_preserves_inv_implications_nonneg
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> alw_iff_sdrop<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Propagate-after_summary_Diff"><span class="command">lemma</span></span> after_summary_Diff<span class="main">:</span> <span class="quoted"><span class="quoted">"after_summary <span class="main">(</span><span class="free">M</span> <span class="main">-</span> <span class="free">N</span><span class="main">)</span> <span class="free">S</span> <span class="main">=</span> after_summary <span class="free">M</span> <span class="free">S</span> <span class="main">-</span> after_summary <span class="free">N</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_subtractf after_summary_def<span class="main">)</span>

<span class="keyword1" id="Propagate-mem_zmset_frontier"><span class="command">lemma</span></span> mem_zmset_frontier<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> zmset_frontier <span class="free">M</span> <span class="main">⟷</span> <span class="free">x</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1" id="Propagate-obtain_frontier_elem"><span class="command">lemma</span></span> obtain_frontier_elem<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">u</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="free">M</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≤</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">atomize_elim</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">transfer</span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> minimal_antichain_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> order_zmset_exists_foundation<span class="main">)</span>

<span class="keyword1" id="Propagate-frontier_unionD"><span class="command">lemma</span></span> frontier_unionD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span><span class="free">M</span><span class="main">+</span><span class="free">N</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="free">t</span> <span class="main">∨</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">N</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer'</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> minimal_antichain_def<span class="main">)</span>

<span class="keyword1" id="Propagate-ps_frontier_in_imps_wl"><span class="command">lemma</span></span> ps_frontier_in_imps_wl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inv_imps_work_sum <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>zmset_frontier <span class="main">(</span>c_pts <span class="free">c</span> <span class="free">loc</span><span class="main">)</span><span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_imp <span class="free">c</span> <span class="free">loc</span> <span class="main">+</span> c_work <span class="free">c</span> <span class="free">loc</span><span class="main">)</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> zcount <span class="main">(</span>union_frontiers <span class="free">c</span> <span class="free">loc</span><span class="main">)</span> <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> union_frontiers_nonneg<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> inv_imps_work_sum_def<span class="main">,</span> <span class="operator">THEN</span> spec<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">loc</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Propagate-obtain_elem_frontier"><span class="command">lemma</span></span> obtain_elem_frontier<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">s</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≤</span> <span class="free">t</span> <span class="main">∧</span> <span class="free">s</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> order_finite_set_obtain_foundation<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">{</span></span></span><span class="bound"><span class="bound"><span class="bound">s</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> zcount <span class="free"><span class="free"><span class="free">M</span></span></span> <span class="bound"><span class="bound"><span class="bound">s</span></span></span> <span class="main"><span class="main"><span class="main">&gt;</span></span></span> <span class="main"><span class="main"><span class="main">0</span></span></span><span class="main"><span class="main"><span class="main">}</span></span></span>"</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">t</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">thesis</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> assms antichain_inverse frontier_def member_antichain.rep_eq
      in_minimal_antichain<span class="main">)</span>

<span class="keyword1" id="Propagate-obtain_elem_zmset_frontier"><span class="command">lemma</span></span> obtain_elem_zmset_frontier<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">s</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≤</span> <span class="free">t</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>zmset_frontier <span class="free">M</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> member_antichain.rep_eq <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> obtain_elem_frontier<span class="main">)</span>

<span class="keyword1" id="Propagate-ps_in_imps_wl"><span class="command">lemma</span></span> ps_in_imps_wl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inv_imps_work_sum <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_pts <span class="free">c</span> <span class="free">loc</span><span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">s</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≤</span> <span class="free">t</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_imp <span class="free">c</span> <span class="free">loc</span> <span class="main">+</span> c_work <span class="free">c</span> <span class="free">loc</span><span class="main">)</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">atomize_elim</span>
  <span class="keyword1"><span class="command">note</span></span> iiws <span class="main">=</span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> inv_imps_work_sum_def<span class="main">,</span> <span class="operator">THEN</span> spec<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">loc</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="skolem">u</span> <span class="main">≤</span> <span class="free">t</span> <span class="main">∧</span> <span class="skolem">u</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_pts <span class="free">c</span> <span class="free">loc</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> obtain_elem_frontier <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_imp <span class="free">c</span> <span class="free">loc</span> <span class="main">+</span> c_work <span class="free">c</span> <span class="free">loc</span><span class="main">)</span> <span class="skolem">u</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> ps_frontier_in_imps_wl<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">c</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">loc</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">u</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> iffD1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> member_antichain.rep_eq<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">with</span></span> u <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">s</span></span><span class="main">≤</span><span class="free">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_imp <span class="free">c</span> <span class="free">loc</span> <span class="main">+</span> c_work <span class="free">c</span> <span class="free">loc</span><span class="main">)</span> <span class="bound">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">u</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Propagate-zero_le_after_summary_single"><span class="command">lemma</span></span> zero_le_after_summary_single<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> zcount <span class="main">(</span>after_summary <span class="main">{#</span><span class="free">t</span><span class="keyword1">#}<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">S</span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> zero_le_sum_single <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> after_summary_def<span class="main">)</span>

<span class="keyword1" id="Propagate-one_le_zcount_after_summary"><span class="command">lemma</span></span> one_le_zcount_after_summary<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">1</span> <span class="main">≤</span> zcount <span class="main">(</span>after_summary <span class="main">{#</span><span class="free">t</span><span class="keyword1">#}<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">S</span><span class="main">)</span> <span class="main">(</span><span class="free">results_in</span> <span class="free">t</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> image_zmset_single after_summary_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> zcount_sum<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> forw_subst<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="main"><span class="quoted"><span class="main">1</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"zcount <span class="main"><span class="main">{#</span></span><span class="free"><span class="free">results_in</span></span> <span class="free"><span class="free">t</span></span> <span class="free"><span class="free">s</span></span><span class="keyword1"><span class="keyword1">#}<span class="hidden">⇩</span><sub>z</sub></span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">results_in</span></span> <span class="free"><span class="free">t</span></span> <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sum_nonneg_leq_bound<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"set_antichain <span class="free"><span class="free">S</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">u</span></span><span class="main"><span class="main">.</span></span> zcount <span class="main"><span class="main">{#</span></span><span class="free"><span class="free">results_in</span></span> <span class="free"><span class="free">t</span></span> <span class="bound"><span class="bound">u</span></span><span class="keyword1"><span class="keyword1">#}<span class="hidden">⇩</span><sub>z</sub></span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">results_in</span></span> <span class="free"><span class="free">t</span></span> <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span>"</span></span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">s</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> member_antichain.rep_eq<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Propagate-zero_lt_zcount_after_summary"><span class="command">lemma</span></span> zero_lt_zcount_after_summary<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>after_summary <span class="main">{#</span><span class="free">t</span><span class="keyword1">#}<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">S</span><span class="main">)</span> <span class="main">(</span><span class="free">results_in</span> <span class="free">t</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> int_one_le_iff_zero_less<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> one_le_zcount_after_summary<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Propagate-pos_zcount_after_summary"><span class="command">lemma</span></span> pos_zcount_after_summary<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> zcount <span class="free">M</span> <span class="bound">t</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">s</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>after_summary <span class="free">M</span> <span class="free">S</span><span class="main">)</span> <span class="main">(</span><span class="free">results_in</span> <span class="free">t</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum_pos2 pos_zcount_image_zmset <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> member_antichain.rep_eq zcount_sum after_summary_def<span class="main">)</span>

<span class="keyword1" id="Propagate-after_summary_nonneg"><span class="command">lemma</span></span> after_summary_nonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> zcount <span class="free">M</span> <span class="bound">t</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">≤</span> zcount <span class="main">(</span>after_summary <span class="free">M</span> <span class="free">S</span><span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zcount_sum after_summary_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sum_nonneg<span class="main">)</span>

<span class="keyword1" id="Propagate-after_summary_zmset_of_nonneg"><span class="command">lemma</span></span> after_summary_zmset_of_nonneg<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> zcount <span class="main">(</span>after_summary <span class="main">(</span>zmset_of <span class="free">M</span><span class="main">)</span> <span class="free">S</span><span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mset_neg_image_zmset mset_neg_sum_set mset_neg_zcount_nonneg after_summary_def<span class="main">)</span>

<span class="keyword1" id="Propagate-pos_zcount_union_frontiers"><span class="command">lemma</span></span> pos_zcount_union_frontiers<span class="main">:</span>
  <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>after_summary <span class="main">(</span>zmset_frontier <span class="main">(</span>c_imp <span class="free">c</span> <span class="free">l1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">summary</span> <span class="free">l1</span> <span class="free">l2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">results_in</span> <span class="free">t</span> <span class="free">s</span><span class="main">)</span>
    <span class="main">≤</span> zcount <span class="main">(</span>union_frontiers <span class="free">c</span> <span class="free">l2</span><span class="main">)</span> <span class="main">(</span><span class="free">results_in</span> <span class="free">t</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> zcount_sum<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> member_le_sum<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> pos_zcount_image_zmset<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Propagate-after_summary_Sum_fun"><span class="command">lemma</span></span> after_summary_Sum_fun<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">MM</span> <span class="main">⟹</span> after_summary <span class="main">(</span><span class="main">∑</span><span class="bound">M</span><span class="main">∈</span><span class="free">MM</span><span class="main">.</span> <span class="free">f</span> <span class="bound">M</span><span class="main">)</span> <span class="free">A</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">M</span><span class="main">∈</span><span class="free">MM</span><span class="main">.</span> after_summary <span class="main">(</span><span class="free">f</span> <span class="bound">M</span><span class="main">)</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">MM</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> after_summary_union<span class="main">)</span>

<span class="keyword1" id="Propagate-after_summary_obtain_pre"><span class="command">lemma</span></span> after_summary_obtain_pre<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> zcount <span class="free">M</span> <span class="bound">t</span>"</span></span> <span class="comment1">(* could prove without this assumption *)</span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>after_summary <span class="free">M</span> <span class="free">S</span><span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">t'</span> <span class="free">s</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="free">t'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">results_in</span> <span class="free">t'</span> <span class="free">s</span> <span class="main">=</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> after_summary_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">atomize_elim</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> zcount_sum<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> sum_pos_ex_elem_pos<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> ex_comm<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">s</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> pos_image_zmset_obtain_pre<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> member_antichain.rep_eq<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Propagate-empty_antichain"><span class="command">lemma</span></span> empty_antichain<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> antichain <span class="main">{}</span> <span class="main">⟹</span> False"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> empty_antichain.abs_eq mem_antichain_nonempty<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">impWitnessPath</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">impWitnessPath</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">loc1</span></span></span> <span class="free"><span class="bound"><span class="entity">loc2</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span>
    path <span class="free"><span class="bound"><span class="entity">loc1</span></span></span> <span class="free"><span class="bound"><span class="entity">loc2</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">∧</span>
    distinct <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="bound">t'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">loc1</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="free">results_in</span> <span class="bound">t'</span> <span class="main">(</span>sum_path_weights <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span>length <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span>TO <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">t</span> <span class="main">=</span> <span class="free">results_in</span> <span class="bound">t'</span> <span class="main">(</span>sum_path_weights <span class="main">(</span>take <span class="main">(</span><span class="bound">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Propagate-impWitnessPathEx"><span class="command">lemma</span></span> impWitnessPathEx<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c</span> <span class="free">loc2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">loc1</span> <span class="bound">xs</span><span class="main">.</span> impWitnessPath <span class="free">c</span> <span class="bound">loc1</span> <span class="free">loc2</span> <span class="bound">xs</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"path <span class="free">loc2</span> <span class="free">loc2</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> path0<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">=</span> sum_path_weights <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> foldr_Nil list.map<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> <span class="free">results_in</span> <span class="free">t</span> <span class="main">(</span>sum_path_weights <span class="main">[]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> results_in_zero<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> 1 2 assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> impWitnessPath_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> results_in_zero<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">longestImpWitnessPath</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">longestImpWitnessPath</span>  <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">loc1</span></span></span> <span class="free"><span class="bound"><span class="entity">loc2</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span>
  impWitnessPath <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">loc1</span></span></span> <span class="free"><span class="bound"><span class="entity">loc2</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∧</span>
  <span class="main">(</span><span class="main">∀</span><span class="bound">loc'</span> <span class="bound">xs'</span><span class="main">.</span> impWitnessPath <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">loc'</span> <span class="free"><span class="bound"><span class="entity">loc2</span></span></span> <span class="bound">xs'</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟶</span> length <span class="main">(</span><span class="bound">xs'</span><span class="main">)</span> <span class="main">≤</span> length <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Propagate-finite_edges"><span class="command">lemma</span></span> finite_edges<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="main">(</span><span class="bound">loc1</span><span class="main">,</span><span class="bound">s</span><span class="main">,</span><span class="bound">loc2</span><span class="main">)</span><span class="main">.</span> <span class="bound">s</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">summary</span> <span class="bound">loc1</span> <span class="bound">loc2</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?sums</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">loc1</span><span class="main">,</span><span class="bound">loc2</span><span class="main">)</span><span class="main">.</span> set_antichain <span class="main">(</span><span class="free">summary</span> <span class="bound">loc1</span> <span class="bound">loc2</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> UNIV<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?sums</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">(</span>UNIV<span class="main">::</span><span class="tfree">'loc</span> set<span class="main">)</span> <span class="main">×</span> <span class="var">?sums</span> <span class="main">×</span> <span class="main">(</span>UNIV<span class="main">::</span><span class="tfree">'loc</span> set<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">loc1</span><span class="main">,</span><span class="bound">s</span><span class="main">,</span><span class="bound">loc2</span><span class="main">)</span><span class="main">.</span> <span class="bound">s</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">summary</span> <span class="bound">loc1</span> <span class="bound">loc2</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">(</span>UNIV<span class="main">::</span><span class="tfree">'loc</span> set<span class="main">)</span> <span class="main">×</span> <span class="var">?sums</span> <span class="main">×</span> <span class="main">(</span>UNIV<span class="main">::</span><span class="tfree">'loc</span> set<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> member_antichain.rep_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rev_finite_subset<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Propagate-longestImpWitnessPathEx"><span class="command">lemma</span></span> longestImpWitnessPathEx<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c</span> <span class="free">loc2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">loc1</span> <span class="bound">xs</span><span class="main">.</span> longestImpWitnessPath <span class="free">c</span> <span class="bound">loc1</span> <span class="free">loc2</span> <span class="bound">xs</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">paths</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">paths</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">loc1</span><span class="main">,</span> <span class="bound">xs</span><span class="main">)</span><span class="main">.</span> impWitnessPath <span class="free">c</span> <span class="bound">loc1</span> <span class="free">loc2</span> <span class="bound">xs</span> <span class="free">t</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> impWitnessPathEx<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="skolem">paths</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="skolem">paths</span> <span class="main">⟶</span> <span class="main">(</span>length <span class="main">∘</span> snd<span class="main">)</span> <span class="bound">p</span>  <span class="main">&lt;</span> card <span class="main">{</span><span class="main">(</span><span class="bound">loc1</span><span class="main">,</span><span class="bound">s</span><span class="main">,</span><span class="bound">loc2</span><span class="main">)</span><span class="main">.</span> <span class="bound">s</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">summary</span> <span class="bound">loc1</span> <span class="bound">loc2</span><span class="main">}</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
    <span class="keyword3"><span class="command">assume</span></span> p<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="skolem">paths</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>length <span class="main">∘</span> snd<span class="main">)</span> <span class="skolem">p</span> <span class="main">&lt;</span> card <span class="main">{</span><span class="main">(</span><span class="bound">loc1</span><span class="main">,</span><span class="bound">s</span><span class="main">,</span><span class="bound">loc2</span><span class="main">)</span><span class="main">.</span> <span class="bound">s</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">summary</span> <span class="bound">loc1</span> <span class="bound">loc2</span><span class="main">}</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> paths_def impWitnessPath_def less_Suc_eq_le finite_edges path_edge
          <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> distinct_card<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> card_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> ex_has_greatest_nat<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∈</span> <span class="skolem">paths</span>›</span></span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> paths_def longestImpWitnessPath_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Propagate-path_first_loc"><span class="command">lemma</span></span> path_first_loc<span class="main">:</span> <span class="quoted"><span class="quoted">"path <span class="free">l1</span> <span class="free">l2</span> <span class="free">xs</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">!</span> <span class="main">0</span> <span class="main">=</span> <span class="main">(</span><span class="free">l1'</span><span class="main">,</span><span class="free">s</span><span class="main">,</span><span class="free">l2'</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">l1</span> <span class="main">=</span> <span class="free">l1'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">l1'</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">l2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> path.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>path0 <span class="skolem">l1</span> <span class="skolem">l2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>path <span class="skolem">l1</span> <span class="skolem">l2</span> <span class="skolem">xs</span> <span class="skolem">lbl</span> <span class="skolem">l3</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span><span class="main">=</span><span class="main">[]</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> path0E<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> path<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">l1'</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">s</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Propagate-find_witness_from_frontier"><span class="command">lemma</span></span> find_witness_from_frontier<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c</span> <span class="free">loc2</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"inv_imps_work_sum <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t'</span> <span class="bound">loc1</span> <span class="bound">xs</span><span class="main">.</span> <span class="main">(</span>path <span class="bound">loc1</span> <span class="free">loc2</span> <span class="bound">xs</span> <span class="main">∧</span> <span class="free">t</span> <span class="main">=</span>  <span class="free">results_in</span> <span class="bound">t'</span> <span class="main">(</span>sum_path_weights <span class="bound">xs</span><span class="main">)</span> <span class="main">∧</span>
           <span class="main">(</span><span class="bound">t'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_pts <span class="free">c</span> <span class="bound">loc1</span><span class="main">)</span> <span class="main">∨</span> <span class="main">0</span> <span class="main">&gt;</span> zcount <span class="main">(</span>c_work <span class="free">c</span> <span class="bound">loc1</span><span class="main">)</span> <span class="bound">t'</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">loc1</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> longestP<span class="main">:</span> <span class="quoted"><span class="quoted">"longestImpWitnessPath <span class="free">c</span> <span class="skolem">loc1</span> <span class="free">loc2</span> <span class="skolem">xs</span> <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> longestImpWitnessPathEx <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword">where</span></span> t'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c</span> <span class="skolem">loc1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> <span class="free">results_in</span> <span class="skolem">t'</span> <span class="main">(</span>sum_path_weights <span class="skolem">xs</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span>length <span class="skolem">xs</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c</span> <span class="main">(</span>TO <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">t</span> <span class="main">=</span> <span class="free">results_in</span> <span class="skolem">t'</span> <span class="main">(</span>sum_path_weights <span class="main">(</span>take <span class="main">(</span><span class="bound">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> longestImpWitnessPath_def impWitnessPath_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> t'<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> cases<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&gt;</span> zcount <span class="main">(</span>c_work <span class="free">c</span> <span class="skolem">loc1</span><span class="main">)</span> <span class="skolem">t'</span> <span class="main">∨</span>
             <span class="main">(</span><span class="skolem">t'</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="main">(</span>zmset_frontier <span class="main">(</span>c_pts <span class="free">c</span> <span class="skolem">loc1</span><span class="main">)</span> <span class="main">+</span> union_frontiers <span class="free">c</span> <span class="skolem">loc1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> verit_forall_inst<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inv_imps_work_sum_def not_less<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> add_pos_nonneg mem_zmset_frontier member_frontier_pos_zmset obtain_frontier_elem zcount_empty zcount_ne_zero_iff zcount_union zmset_frontier_empty<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">assume</span></span> case1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&gt;</span> zcount <span class="main">(</span>c_work <span class="free">c</span> <span class="skolem">loc1</span><span class="main">)</span> <span class="skolem">t'</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>  <span class="keyword1"><span class="command">using</span></span> t' longestP
      <span class="keyword1"><span class="command">using</span></span> impWitnessPath_def longestImpWitnessPath_def dataflow_topology_axioms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> case2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">0</span> <span class="main">&gt;</span> zcount <span class="main">(</span>c_work <span class="free">c</span> <span class="skolem">loc1</span><span class="main">)</span> <span class="skolem">t'</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t'</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="main">(</span>zmset_frontier <span class="main">(</span>c_pts <span class="free">c</span> <span class="skolem">loc1</span><span class="main">)</span> <span class="main">+</span> union_frontiers <span class="free">c</span> <span class="skolem">loc1</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> case2 cases <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> case_split2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t'</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> zmset_frontier <span class="main">(</span>c_pts <span class="free">c</span> <span class="skolem">loc1</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="skolem">t'</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> union_frontiers <span class="free">c</span> <span class="skolem">loc1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> add_diff_cancel_left' in_diff_zcount zcount_ne_zero_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">assume</span></span> case2_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> zmset_frontier <span class="main">(</span>c_pts <span class="free">c</span> <span class="skolem">loc1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_pts <span class="free">c</span> <span class="skolem">loc1</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> case2_1 mem_zmset_frontier <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> t' impWitnessPath_def longestImpWitnessPath_def dataflow_topology_axioms longestP <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="skolem">t'</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> zmset_frontier <span class="main">(</span>c_pts <span class="free">c</span> <span class="skolem">loc1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> case2_2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span>  union_frontiers <span class="free">c</span> <span class="skolem">loc1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> case_split2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">loc0</span></span> <span class="skolem"><span class="skolem">t0</span></span> <span class="skolem"><span class="skolem">s0</span></span> <span class="keyword2"><span class="keyword">where</span></span> loc0 <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t0</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c</span> <span class="skolem">loc0</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">s0</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> <span class="main">(</span><span class="free">summary</span> <span class="skolem">loc0</span> <span class="skolem">loc1</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> <span class="free">results_in</span> <span class="skolem">t0</span> <span class="skolem">s0</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> after_summary_def set_zmset_def zcount_sum
            member_antichain.rep_eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> zcount_image_zmset card_gt_0_iff
            <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> zcount_ne_zero_iff
            <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.not_neutral_contains_not_neutral<span class="main">)</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?xs'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">loc0</span><span class="main">,</span> <span class="skolem">s0</span><span class="main">,</span> <span class="skolem">loc1</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> path_xs<span class="main">:</span> <span class="quoted"><span class="quoted">"path <span class="skolem">loc1</span> <span class="free">loc2</span> <span class="skolem">xs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> impWitnessPath_def longestImpWitnessPath_def longestP <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> is_path_xs'<span class="main">:</span> <span class="quoted"><span class="quoted">"path <span class="skolem">loc0</span> <span class="free">loc2</span> <span class="var">?xs'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> longestP
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> longestImpWitnessPath_def impWitnessPath_def<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_Cons append_Nil path_singleton path_trans loc0<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span>length <span class="var">?xs'</span><span class="main">.</span>
              <span class="free">results_in</span> <span class="skolem">t0</span> <span class="main">(</span>sum_path_weights <span class="main">(</span>take <span class="main">(</span><span class="bound">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="var">?xs'</span><span class="main">)</span><span class="main">)</span>
              <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c</span> <span class="main">(</span>TO <span class="main">(</span><span class="var">?xs'</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> k
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span><span class="main">=</span><span class="main">0</span>"</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
            <span class="keyword1"><span class="command">using</span></span> loc0<span class="main">(</span>3<span class="main">)</span> t'<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> results_in_zero<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
            <span class="keyword1"><span class="command">using</span></span> t'<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">unfolded</span> loc0<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> followed_by_summary<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span><span class="main">-</span><span class="main">1</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">note</span></span> r <span class="main">=</span> this<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> distinctxs<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">xs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> longestP
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> longestImpWitnessPath_def impWitnessPath_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
        <span class="keyword3"><span class="command">assume</span></span> case_distinct<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="var">?xs'</span>"</span></span>
          <span class="comment1">(* show that we have a longer longestImpWitnessPathEx ⟶ contradicition *)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> <span class="free">results_in</span> <span class="skolem">t0</span> <span class="main">(</span>sum_path_weights <span class="var">?xs'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> longestP loc0<span class="main">(</span>3<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> longestImpWitnessPath_def impWitnessPath_def<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> followed_by_summary t'<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> impPath<span class="main">:</span> <span class="quoted"><span class="quoted">"impWitnessPath <span class="free">c</span> <span class="skolem">loc0</span> <span class="free">loc2</span> <span class="var">?xs'</span> <span class="free">t</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> is_path_xs' case_distinct loc0<span class="main">(</span>1<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> impWitnessPath_def<span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> r <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="var">?xs'</span> <span class="main">&gt;</span> length <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> longestImpWitnessPath <span class="free">c</span> <span class="skolem">loc1</span> <span class="free">loc2</span> <span class="skolem">xs</span> <span class="free">t</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> impPath leD <span class="keyword1"><span class="command">unfolding</span></span> longestImpWitnessPath_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> longestP <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> distinct <span class="var">?xs'</span>"</span></span>
          <span class="comment1">(* show that we have a non-increasing cycle along path (loc0, s0, loc1) # xs *)</span>
        <span class="keyword1"><span class="command">with</span></span> distinctxs <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"TO <span class="main">(</span><span class="var">?xs'</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">loc0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="var">?xs'</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">atomize_elim</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> in_set_conv_nth<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> i
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">=</span><span class="main">0</span>"</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
              <span class="keyword1"><span class="command">using</span></span> path_first_loc<span class="main">[</span><span class="operator">OF</span> path_xs<span class="main">]</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">i</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command">using</span></span> path_xs
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> path_to_eq_from<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">-</span><span class="main">1</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">results_in</span> <span class="skolem">t0</span> <span class="main">(</span>sum_path_weights <span class="main">(</span>take <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="var">?xs'</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c</span> <span class="skolem">loc0</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> r<span class="main"><span class="main">[</span></span><span class="operator">OF</span> k<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> k<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t0</span> <span class="main">&lt;</span> <span class="free">results_in</span> <span class="skolem">t0</span> <span class="main">(</span>sum_path_weights <span class="main">(</span>take <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="var">?xs'</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> no_zero_cycle<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">loc0</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"take <span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">k</span></span><span class="main"><span class="main">+</span></span><span class="main"><span class="main">1</span></span><span class="main"><span class="main">)</span></span> <span class="var"><span class="var">?xs'</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"sum_path_weights <span class="main"><span class="main">(</span></span>take <span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">k</span></span><span class="main"><span class="main">+</span></span><span class="main"><span class="main">1</span></span><span class="main"><span class="main">)</span></span> <span class="var"><span class="var">?xs'</span></span><span class="main"><span class="main">)</span></span>"</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">t0</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> is_path_xs' k  path_take_to <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> loc0<span class="main">(</span>1<span class="main">)</span> frontier_comparable_False <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Propagate-implication_implies_pointstamp"><span class="command">lemma</span></span> implication_implies_pointstamp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c</span> <span class="free">loc</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"inv_imps_work_sum <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t'</span> <span class="bound">loc'</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> path_summary <span class="bound">loc'</span> <span class="free">loc</span> <span class="main">∧</span> <span class="free">t</span> <span class="main">≥</span> <span class="free">results_in</span> <span class="bound">t'</span> <span class="bound">s</span> <span class="main">∧</span>
               <span class="main">(</span><span class="bound">t'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_pts <span class="free">c</span> <span class="bound">loc'</span><span class="main">)</span> <span class="main">∨</span> <span class="main">0</span> <span class="main">&gt;</span> zcount <span class="main">(</span>c_work <span class="free">c</span> <span class="bound">loc'</span><span class="main">)</span> <span class="bound">t'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">loc'</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> witness<span class="main">:</span>
    <span class="quoted"><span class="quoted">"path <span class="skolem">loc'</span> <span class="free">loc</span> <span class="skolem">xs</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> <span class="free">results_in</span> <span class="skolem">t'</span> <span class="main">(</span>sum_path_weights <span class="skolem">xs</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_pts <span class="free">c</span> <span class="skolem">loc'</span><span class="main">)</span> <span class="main">∨</span> <span class="main">0</span> <span class="main">&gt;</span> zcount <span class="main">(</span>c_work <span class="free">c</span> <span class="skolem">loc'</span><span class="main">)</span> <span class="skolem">t'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms find_witness_from_frontier <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> path_summary <span class="skolem">loc'</span> <span class="free">loc</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≤</span> <span class="main">(</span>sum_path_weights <span class="skolem">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> witness<span class="main">(</span>1<span class="main">)</span> path_path_weight <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≥</span> <span class="free">results_in</span> <span class="skolem">t'</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> witness<span class="main">(</span>2<span class="main">)</span> results_in_mono<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> witness<span class="main">(</span>3<span class="main">)</span> s <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Proof of Safety›</span></span>

<span class="keyword1" id="Propagate-results_in_sum_path_weights_append"><span class="command">lemma</span></span> results_in_sum_path_weights_append<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">results_in</span> <span class="free">t</span> <span class="main">(</span>sum_path_weights <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">loc2</span><span class="main">,</span> <span class="free">s</span><span class="main">,</span> <span class="free">loc3</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">results_in</span> <span class="main">(</span><span class="free">results_in</span> <span class="free">t</span> <span class="main">(</span>sum_path_weights <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> followed_by_summary sum_path_weights_append_singleton<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">c</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'loc</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">)</span> configuration"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">loc_imps_fw</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">loc_imps_fw</span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="main">(</span>c_imp <span class="free">c</span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span><span class="main">)</span> <span class="main">[]</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">loc_imps_fw</span> <span class="free"><span class="bound"><span class="entity">loc1</span></span></span> <span class="free"><span class="bound"><span class="entity">loc2</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">summary</span> <span class="free"><span class="bound"><span class="entity">loc2</span></span></span> <span class="free"><span class="bound"><span class="entity">loc3</span></span></span> <span class="main">⟹</span> distinct <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">loc2</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">loc3</span></span></span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="free">loc_imps_fw</span> <span class="free"><span class="bound"><span class="entity">loc1</span></span></span> <span class="free"><span class="bound"><span class="entity">loc3</span></span></span> <span class="main">(</span><span class="main">{#</span> <span class="free">results_in</span> <span class="bound">t</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">.</span> <span class="bound">t</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">#}</span> <span class="main">+</span> c_imp <span class="free">c</span> <span class="free"><span class="bound"><span class="entity">loc3</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">loc2</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">loc3</span></span></span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Propagate-loc_imps_fw_conv_path"><span class="command">lemma</span></span> loc_imps_fw_conv_path<span class="main">:</span> <span class="quoted"><span class="quoted">"loc_imps_fw <span class="free">c</span> <span class="free">loc1</span> <span class="free">loc2</span> <span class="free">M</span> <span class="free">xs</span> <span class="main">⟹</span> path <span class="free">loc1</span> <span class="free">loc2</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> loc_imps_fw.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> path.intros<span class="main">)</span>

<span class="keyword1" id="Propagate-path_conv_loc_imps_fw"><span class="command">lemma</span></span> path_conv_loc_imps_fw<span class="main">:</span> <span class="quoted"><span class="quoted">"path <span class="free">loc1</span> <span class="free">loc2</span> <span class="free">xs</span> <span class="main">⟹</span> distinct <span class="free">xs</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">M</span><span class="main">.</span> loc_imps_fw <span class="free">c</span> <span class="free">loc1</span> <span class="free">loc2</span> <span class="bound">M</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> path.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>path0 <span class="skolem">l1</span> <span class="skolem">l2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> loc_imps_fw.intros<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>path <span class="skolem">l1</span> <span class="skolem">l2</span> <span class="skolem">xs</span> <span class="skolem">lbl</span> <span class="skolem">l3</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">M</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"loc_imps_fw <span class="free">c</span> <span class="skolem">l1</span> <span class="skolem">l2</span> <span class="skolem">M</span> <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> path <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> loc_imps_fw.intros<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Propagate-path_summary_conv_loc_imps_fw"><span class="command">lemma</span></span> path_summary_conv_loc_imps_fw<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> path_summary <span class="free">loc1</span> <span class="free">loc2</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">M</span> <span class="bound">xs</span><span class="main">.</span> loc_imps_fw <span class="free">c</span> <span class="free">loc1</span> <span class="free">loc2</span> <span class="bound">M</span> <span class="bound">xs</span> <span class="main">∧</span> sum_path_weights <span class="bound">xs</span> <span class="main">=</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> path_sum<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> path_summary <span class="free">loc1</span> <span class="free">loc2</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">M</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"path <span class="free">loc1</span> <span class="free">loc2</span> <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"loc_imps_fw <span class="free">c</span> <span class="free">loc1</span> <span class="free">loc2</span> <span class="skolem">M</span> <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"sum_path_weights <span class="skolem">xs</span> <span class="main">≤</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">atomize_elim</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> path_weight_conv_path<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> path_distinct<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> ys xs
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">xs</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> path_conv_loc_imps_fw<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">loc1</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">loc2</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">xs</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">c</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> subseq_sum_weights_le <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"sum_path_weights <span class="skolem">xs</span> <span class="main">=</span> <span class="free">s</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> le <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> le <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_path_weights <span class="skolem">xs</span> <span class="main">&lt;</span> <span class="free">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> le<span class="main">(</span>1<span class="main">)</span> path_sum <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> path_weight_conv_path<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Propagate-image_zmset_id"><span class="command">lemma</span></span> image_zmset_id<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">M</span><span class="main">#}</span> <span class="main">=</span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> equiv_zmset_def<span class="main">)</span>

<span class="keyword1" id="Propagate-sum_pos"><span class="command">lemma</span></span> sum_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">M</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">M</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">∈</span> <span class="free">M</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">f</span> <span class="free">y</span><span class="main">::</span><span class="main">_</span><span class="main">::</span>ordered_comm_monoid_add<span class="main">)</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">M</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">M</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> empty
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="skolem">x</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sum_nonneg add_pos_nonneg add_nonneg_pos<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Propagate-loc_imps_fw_M_in_implications"><span class="command">lemma</span></span> loc_imps_fw_M_in_implications<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"loc_imps_fw <span class="free">c</span> <span class="free">loc1</span> <span class="free">loc2</span> <span class="free">M</span> <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"inv_imps_work_sum <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"inv_implications_nonneg <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">loc</span><span class="main">.</span> c_work <span class="free">c</span> <span class="bound">loc</span> <span class="main">=</span> <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">≤</span> <span class="free">t</span> <span class="main">∧</span> <span class="bound">s</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c</span> <span class="free">loc2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>5<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> loc_imps_fw.induct<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> iiws <span class="main">=</span> assms<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> inv_imps_work_sum_def assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">loc</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> obtain_elem_frontier<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">note</span></span> iiws <span class="main">=</span> assms<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> inv_imps_work_sum_def assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">loc1</span> <span class="skolem">loc2</span> <span class="skolem">M</span> <span class="skolem">xs</span> <span class="skolem">s</span> <span class="skolem">loc3</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 2<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> disj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">{#</span> <span class="free">results_in</span> <span class="bound">t</span> <span class="skolem">s</span><span class="main">.</span> <span class="bound">t</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="skolem">M</span> <span class="main">#}</span> <span class="skolem">t</span> <span class="main">∨</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_imp <span class="free">c</span> <span class="skolem">loc3</span><span class="main">)</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">{#</span> <span class="free">results_in</span> <span class="bound">t</span> <span class="skolem">s</span><span class="main">.</span> <span class="bound">t</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="skolem">M</span> <span class="main">#}</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword">where</span></span> t'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">results_in</span> <span class="skolem">t'</span> <span class="skolem">s</span> <span class="main">=</span> <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="skolem">M</span> <span class="skolem">t'</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">atomize_elim</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> zcount_image_zmset<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vimage_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Int_iff mem_Collect_eq sum_pos_ex_elem_pos<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">≤</span> <span class="skolem">t'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c</span> <span class="skolem">loc2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span> <span class="main">(</span><span class="operator">rule</span> 2<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> t'<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> riu_le_rit'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">results_in</span> <span class="skolem">u</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="skolem">t</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> t'<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> results_in_mono<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> u <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>union_frontiers <span class="free">c</span> <span class="skolem">loc3</span><span class="main">)</span> <span class="main">(</span><span class="free">results_in</span> <span class="skolem">u</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> zcount_sum<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sum_pos<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> y<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">loc2</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span> <span class="main"><span class="keyword3">[</span></span>3<span class="main"><span class="keyword3">]</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> after_summary_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> zcount_sum<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sum_pos<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> y<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">s</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span> <span class="main"><span class="keyword3">[</span></span>3<span class="main"><span class="keyword3">]</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> zcount_image_zmset<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> card_eq_sum<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sum_pos<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> y<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">u</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>zmset_frontier <span class="main">(</span>c_pts <span class="free">c</span> <span class="skolem">loc3</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">results_in</span> <span class="skolem">u</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">+</span> zcount <span class="main">(</span>union_frontiers <span class="free">c</span> <span class="skolem">loc3</span><span class="main">)</span> <span class="main">(</span><span class="free">results_in</span> <span class="skolem">u</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> add_nonneg_pos<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> riu_le_rit' <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> zcount_union<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> iiws<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> obtain_elem_frontier<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> u'
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">u'</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="comment1">― ‹Same as induction base case›</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_imp <span class="free">c</span> <span class="skolem">loc3</span><span class="main">)</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> obtain_elem_frontier<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> disj
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Propagate-loc_imps_fw_M_nonneg"><span class="command">lemma</span></span> loc_imps_fw_M_nonneg<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"loc_imps_fw <span class="free">c</span> <span class="free">loc1</span> <span class="free">loc2</span> <span class="free">M</span> <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"inv_implications_nonneg <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> zcount <span class="free">M</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> loc_imps_fw.induct<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> add_nonneg_nonneg sum_nonneg <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zcount_image_zmset assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> inv_implications_nonneg_def<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Propagate-loc_imps_fw_implication_in_M"><span class="command">lemma</span></span> loc_imps_fw_implication_in_M<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inv_imps_work_sum <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"inv_implications_nonneg <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"loc_imps_fw <span class="free">c</span> <span class="free">loc1</span> <span class="free">loc2</span> <span class="free">M</span> <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_imp <span class="free">c</span> <span class="free">loc1</span><span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="main">(</span><span class="free">results_in</span> <span class="free">t</span> <span class="main">(</span>sum_path_weights <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> loc_imps_fw.induct<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> iiws <span class="main">=</span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> inv_imps_work_sum_def assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">loc</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> results_in_zero<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">loc1</span> <span class="skolem">loc2</span> <span class="skolem">M</span> <span class="skolem">xs</span> <span class="skolem">s</span> <span class="skolem">loc3</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="skolem">M</span> <span class="main">(</span><span class="free">results_in</span> <span class="free">t</span> <span class="main">(</span>sum_path_weights <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> 2<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> 2<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> results_in_sum_path_weights_append<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> zcount_union<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> add_pos_nonneg<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> zcount_image_zmset<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sum_pos<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> y <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">results_in</span></span> <span class="free"><span class="free">t</span></span> <span class="main"><span class="main">(</span></span>sum_weights <span class="main"><span class="main">(</span></span>map <span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">l</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">l</span></span><span class="main"><span class="main">)</span></span> <span class="skolem"><span class="skolem">xs</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> loc_imps_fw_M_nonneg<span class="main"><span class="main">[</span></span><span class="operator">OF</span> 2<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span> zcount_inI<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span>3<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> inv_implications_nonneg_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">impl_safe</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'loc</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">)</span> configuration <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">impl_safe</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">loc1</span> <span class="bound">loc2</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">.</span> zcount <span class="main">(</span>c_imp <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">loc1</span><span class="main">)</span> <span class="bound">t</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">s</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> path_summary <span class="bound">loc1</span> <span class="bound">loc2</span>
                   <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="bound">t'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">loc2</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">t'</span> <span class="main">≤</span> <span class="free">results_in</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Propagate-impl_safe"><span class="command">lemma</span></span> impl_safe<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inv_imps_work_sum <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"inv_implications_nonneg <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">loc</span><span class="main">.</span> c_work <span class="free">c</span> <span class="bound">loc</span> <span class="main">=</span> <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"impl_safe <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> impl_safe_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> iiws <span class="main">=</span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> inv_imps_work_sum_def assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">loc1</span> <span class="skolem">loc2</span> <span class="skolem">t</span> <span class="skolem">s</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_imp <span class="free">c</span> <span class="skolem">loc1</span><span class="main">)</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword">where</span></span> t'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c</span> <span class="skolem">loc1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">≤</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> obtain_elem_frontier<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> t'_zcount<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_imp <span class="free">c</span> <span class="skolem">loc1</span><span class="main">)</span> <span class="skolem">t'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> member_frontier_pos_zmset<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> path_sum<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> path_summary <span class="skolem">loc1</span> <span class="skolem">loc2</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">M</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> Mxs<span class="main">:</span> <span class="quoted"><span class="quoted">"loc_imps_fw <span class="free">c</span> <span class="skolem">loc1</span> <span class="skolem">loc2</span> <span class="skolem">M</span> <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"sum_path_weights <span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span> <span class="main">(</span><span class="operator">rule</span> path_summary_conv_loc_imps_fw<span class="main"><span class="main">[</span></span><span class="operator">OF</span> path_sum<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> inM<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="skolem">M</span> <span class="main">(</span><span class="free">results_in</span> <span class="skolem">t'</span> <span class="main">(</span>sum_path_weights <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> loc_imps_fw_implication_in_M<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span> Mxs<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span> t'_zcount<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">≤</span> <span class="free">results_in</span> <span class="skolem">t'</span> <span class="main">(</span>sum_path_weights <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c</span> <span class="skolem">loc2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span> <span class="main">(</span><span class="operator">rule</span> loc_imps_fw_M_in_implications<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Mxs<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>2<span class="main"><span class="main"><span class="main">,</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span> inM<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="bound">t'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c</span> <span class="skolem">loc2</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">t'</span> <span class="main">≤</span> <span class="free">results_in</span> <span class="skolem">t</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">u</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Mxs<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> t'<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">meson</span> order.trans results_in_mono<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">― ‹Safety for states where worklist is non-empty›</span>

<span class="keyword1" id="Propagate-cm_preserves_impl_safe"><span class="command">lemma</span></span> cm_preserves_impl_safe<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"impl_safe <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"next_change_multiplicity' <span class="free">c0</span> <span class="free">c1</span> <span class="free">loc</span> <span class="free">t</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"impl_safe <span class="free">c1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> impl_safe_def next_change_multiplicity'_def<span class="main">)</span>

<span class="keyword1" id="Propagate-cm_preserves_safe"><span class="command">lemma</span></span> cm_preserves_safe<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"safe <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"impl_safe <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"next_change_multiplicity' <span class="free">c0</span> <span class="free">c1</span> <span class="free">loc</span> <span class="free">t</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"safe <span class="free">c1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> safe<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_pts <span class="free">c0</span> <span class="skolem">loc1</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">⟹</span> <span class="skolem">s</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> path_summary <span class="skolem">loc1</span> <span class="skolem">loc2</span>
        <span class="main">⟹</span> <span class="main">∃</span><span class="bound"><span class="bound">t'</span></span><span class="main">≤</span><span class="free">results_in</span> <span class="skolem">t</span> <span class="skolem">s</span><span class="main">.</span> <span class="bound">t'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c0</span> <span class="skolem">loc2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">loc1</span> <span class="skolem">loc2</span> <span class="skolem">t</span> <span class="skolem">s</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> safe_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> impl_safe<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_imp <span class="free">c0</span> <span class="skolem">loc1</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">⟹</span> <span class="skolem">s</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> path_summary <span class="skolem">loc1</span> <span class="skolem">loc2</span>
        <span class="main">⟹</span> <span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="bound">t'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c0</span> <span class="skolem">loc2</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">t'</span> <span class="main">≤</span> <span class="free">results_in</span> <span class="skolem">t</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">loc1</span> <span class="skolem">loc2</span> <span class="skolem">t</span> <span class="skolem">s</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> impl_safe_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> imps<span class="main">:</span> <span class="quoted"><span class="quoted">"c_imp <span class="free">c1</span> <span class="main">=</span> c_imp <span class="free">c0</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> next_change_multiplicity'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">loc1</span> <span class="skolem">loc2</span> <span class="skolem">u</span> <span class="skolem">s</span> <span class="comment1">― ‹`safe c1` variables›</span>
    <span class="keyword3"><span class="command">assume</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_pts <span class="free">c1</span> <span class="skolem">loc1</span><span class="main">)</span> <span class="skolem">u</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="keyword2"><span class="keyword">where</span></span> u'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_pts <span class="free">c1</span> <span class="skolem">loc1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u'</span> <span class="main">≤</span> <span class="skolem">u</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> obtain_frontier_elem <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">assume</span></span> path_sum<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> path_summary <span class="skolem">loc1</span> <span class="skolem">loc2</span>"</span></span>
      <span class="comment1">― ‹CM state changes:›</span>
    <span class="keyword3"><span class="command">assume</span></span> n_neq_zero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> impl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="bound">t'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c0</span> <span class="free">loc</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">t'</span> <span class="main">≤</span> <span class="free">t</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> pointstamps<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">loc'</span><span class="main">.</span> c_pts <span class="free">c1</span> <span class="bound">loc'</span> <span class="main">=</span>
                    <span class="main">(</span><span class="keyword1">if</span> <span class="bound">loc'</span> <span class="main">=</span> <span class="free">loc</span> <span class="keyword1">then</span> update_zmultiset <span class="main">(</span>c_pts <span class="free">c0</span> <span class="bound">loc'</span><span class="main">)</span> <span class="free">t</span> <span class="free">n</span>
                                   <span class="keyword1">else</span> c_pts <span class="free">c0</span> <span class="bound">loc'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">t'</span></span><span class="main">≤</span><span class="free">results_in</span> <span class="skolem">u</span> <span class="skolem">s</span><span class="main">.</span> <span class="bound">t'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c1</span> <span class="skolem">loc2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True <span class="comment1">― ‹Trivial, because no new pointstamp could have appeared›</span>
      <span class="keyword1"><span class="command">with</span></span> u <span class="keyword1"><span class="command">have</span></span> u_c0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_pts <span class="free">c0</span> <span class="skolem">loc1</span><span class="main">)</span> <span class="skolem">u</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> pointstamps<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">loc1</span><span class="main">=</span><span class="free">loc</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main">=</span><span class="skolem">u</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zcount_update_zmultiset<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> imps
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> safe<span class="main"><span class="main">[</span></span><span class="operator">OF</span> u_c0 path_sum<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> n_neq_zero <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> imps
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">loc</span><span class="main">=</span><span class="skolem">loc1</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main">=</span><span class="skolem">u</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> impl
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> t'
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> member_frontier_pos_zmset<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> impl_safe<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> path_sum<span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> t''
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">t''</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">using</span></span> results_in_mono<span class="main">(</span>1<span class="main">)</span> order_trans <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command">using</span></span> u path_sum <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zcount_update_zmultiset pointstamps<span class="main"><span class="main">[</span></span><span class="operator">rule_format</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> safe<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> r <span class="main">=</span> this
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> safe_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> loc1 loc2 t s
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> next_change_multiplicity'_def<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> r<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">loc1</span></span></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">t</span></span></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">s</span></span></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">loc2</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹A Better (More Invariant) Safety›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">worklists_vacant_to</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'loc</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">)</span> configuration <span class="main">⇒</span> <span class="tfree">'t</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">worklists_vacant_to</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">loc1</span> <span class="bound">loc2</span> <span class="bound">s</span> <span class="bound">t'</span><span class="main">.</span> <span class="bound">s</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> path_summary <span class="bound">loc1</span> <span class="bound">loc2</span> <span class="main">∧</span> <span class="bound">t'</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> c_work <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">loc1</span> <span class="main">⟶</span> <span class="main">¬</span> <span class="free">results_in</span> <span class="bound">t'</span> <span class="bound">s</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">inv_safe</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'loc</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">)</span> configuration <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">inv_safe</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">loc1</span> <span class="bound">loc2</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_pts <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">loc1</span><span class="main">)</span> <span class="bound">t</span>
                            <span class="main">∧</span> <span class="bound">s</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> path_summary <span class="bound">loc1</span> <span class="bound">loc2</span>
                            <span class="main">∧</span> worklists_vacant_to <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span><span class="free">results_in</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span>
                <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">t'</span></span> <span class="main">≤</span> <span class="free">results_in</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">t'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">loc2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Intuition: Unlike safe, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">inv_safe</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is an invariant because it only claims the safety property
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">t'</span></span> <span class="keyword1"><span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span></span> frontier <span class="main"><span class="main">(</span></span>c_imp <span class="free"><span class="free">c</span></span> <span class="free"><span class="free">loc2</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> for pointstamps that can't be modified by future propagated
updates anymore (i.e. there are no upstream worklist entries which can result in a less or equal pointstamp).›</span></span>

<span class="keyword1" id="Propagate-in_frontier_diff"><span class="command">lemma</span></span> in_frontier_diff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span><span class="free">N</span><span class="main">.</span> <span class="main">¬</span> <span class="bound">y</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">x</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span><span class="free">M</span> <span class="main">-</span> <span class="free">N</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">x</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer'</span>
  <span class="keyword1"><span class="command">unfolding</span></span> in_minimal_antichain
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> diff_zero le_less mem_Collect_eq set_zmset_def zcount_diff<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Propagate-worklists_vacant_to_trans"><span class="command">lemma</span></span> worklists_vacant_to_trans<span class="main">:</span>
  <span class="quoted"><span class="quoted">"worklists_vacant_to <span class="free">c</span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">t'</span> <span class="main">≤</span> <span class="free">t</span> <span class="main">⟹</span> worklists_vacant_to <span class="free">c</span> <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> worklists_vacant_to_def
  <span class="keyword1"><span class="command">using</span></span> order.trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Propagate-loc_imps_fw_M_in_implications'"><span class="command">lemma</span></span> loc_imps_fw_M_in_implications'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"loc_imps_fw <span class="free">c</span> <span class="free">loc1</span> <span class="free">loc2</span> <span class="free">M</span> <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"inv_imps_work_sum <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"inv_implications_nonneg <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"worklists_vacant_to <span class="free">c</span> <span class="free">t</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">s</span></span><span class="main">≤</span><span class="free">t</span><span class="main">.</span> <span class="bound">s</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c</span> <span class="free">loc2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>4<span class="main">,</span>5<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> loc_imps_fw.induct<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> iiws <span class="main">=</span> assms<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> inv_imps_work_sum_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">loc</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> obtain_elem_frontier<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">note</span></span> iiws <span class="main">=</span> assms<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> inv_imps_work_sum_def eq_diff_eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">loc1</span> <span class="skolem">loc2</span> <span class="skolem">M</span> <span class="skolem">xs</span> <span class="skolem">s</span> <span class="skolem">loc3</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 2<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">{#</span> <span class="free">results_in</span> <span class="bound">t</span> <span class="skolem">s</span><span class="main">.</span> <span class="bound">t</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="skolem">M</span> <span class="main">#}</span> <span class="skolem">t</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_imp <span class="free">c</span> <span class="skolem">loc3</span><span class="main">)</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword">where</span></span> t'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">results_in</span> <span class="skolem">t'</span> <span class="skolem">s</span> <span class="main">=</span> <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="skolem">M</span> <span class="skolem">t'</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">atomize_elim</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> zcount_image_zmset<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vimage_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Int_iff mem_Collect_eq sum_pos_ex_elem_pos<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">have</span></span> vacant_to<span class="main">:</span> <span class="quoted"><span class="quoted">"worklists_vacant_to <span class="free">c</span> <span class="skolem">t'</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> worklists_vacant_to_trans<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> 2<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> zero_le results_in_mono<span class="main">(</span>2<span class="main">)</span> results_in_zero t'<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">≤</span> <span class="skolem">t'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c</span> <span class="skolem">loc2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> vacant_to t'<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> riu_le_rit'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">results_in</span> <span class="skolem">u</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> t'<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> results_in_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> u <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>union_frontiers <span class="free">c</span> <span class="skolem">loc3</span><span class="main">)</span> <span class="main">(</span><span class="free">results_in</span> <span class="skolem">u</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> zcount_sum<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sum_pos<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> y<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">loc2</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span> <span class="main"><span class="keyword3">[</span></span>3<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> after_summary_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> zcount_sum<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sum_pos<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> y<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">s</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span> <span class="main"><span class="keyword3">[</span></span>3<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> zcount_image_zmset<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> card_eq_sum<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sum_pos<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> y<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">u</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>zmset_frontier <span class="main">(</span>c_pts <span class="free">c</span> <span class="skolem">loc3</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">results_in</span> <span class="skolem">u</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">+</span> zcount <span class="main">(</span>union_frontiers <span class="free">c</span> <span class="skolem">loc3</span><span class="main">)</span> <span class="main">(</span><span class="free">results_in</span> <span class="skolem">u</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> add_nonneg_pos<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> riu_le_rit' <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> zcount_union<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> iiws<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> obtain_elem_frontier<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> u'
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">u'</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> in_frontier_diff<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> t'
          <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>5<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> worklists_vacant_to_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="skolem">loc3</span></span> <span class="quoted"><span class="skolem">loc3</span></span> <span class="quoted"><span class="skolem">t'</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> meta_mp<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> order_trans results_in_zero<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> obtain_elem_frontier<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Propagate-inv_safe"><span class="command">lemma</span></span> inv_safe<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inv_imps_work_sum <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"inv_implications_nonneg <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"inv_safe <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> inv_safe_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> iiws <span class="main">=</span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> inv_imps_work_sum_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">loc1</span> <span class="skolem">loc2</span> <span class="skolem">t</span> <span class="skolem">s</span>
  <span class="keyword3"><span class="command">assume</span></span> vacant<span class="main">:</span> <span class="quoted"><span class="quoted">"worklists_vacant_to <span class="free">c</span> <span class="main">(</span><span class="free">results_in</span> <span class="skolem">t</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_pts <span class="free">c</span> <span class="skolem">loc1</span><span class="main">)</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword">where</span></span> t'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_pts <span class="free">c</span> <span class="skolem">loc1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">≤</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> obtain_frontier_elem <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> zcount_wl<span class="main">:</span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>c_work <span class="free">c</span> <span class="skolem">loc1</span><span class="main">)</span> <span class="skolem">t'</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> vacant<span class="main">[</span><span class="operator">unfolded</span> worklists_vacant_to_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="skolem">loc1</span></span> <span class="quoted"><span class="skolem">loc1</span></span> <span class="quoted"><span class="skolem">t'</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.left_neutral order.trans le_plus<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> results_in_mono<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> results_in_zero t'<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> zcount_ne_zero_iff<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t''</span></span> <span class="keyword2"><span class="keyword">where</span></span> t''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t''</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c</span> <span class="skolem">loc1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t''</span> <span class="main">≤</span> <span class="skolem">t'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">atomize_elim</span>
    <span class="keyword1"><span class="command">from</span></span> t'<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>zmset_frontier <span class="main">(</span>c_pts <span class="free">c</span> <span class="skolem">loc1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t'</span> <span class="main">+</span> zcount <span class="main">(</span>union_frontiers <span class="free">c</span> <span class="skolem">loc1</span><span class="main">)</span> <span class="skolem">t'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> add_pos_nonneg <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> union_frontiers_nonneg<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t''</span><span class="main">.</span> <span class="bound">t''</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c</span> <span class="skolem">loc1</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">t''</span> <span class="main">≤</span> <span class="skolem">t'</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> zcount_union<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> iiws<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> zcount_wl
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> obtain_frontier_elem<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> t''_zcount<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_imp <span class="free">c</span> <span class="skolem">loc1</span><span class="main">)</span> <span class="skolem">t''</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> member_frontier_pos_zmset<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> path_sum<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> path_summary <span class="skolem">loc1</span> <span class="skolem">loc2</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">M</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> Mxs<span class="main">:</span> <span class="quoted"><span class="quoted">"loc_imps_fw <span class="free">c</span> <span class="skolem">loc1</span> <span class="skolem">loc2</span> <span class="skolem">M</span> <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"sum_path_weights <span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span> <span class="main">(</span><span class="operator">rule</span> path_summary_conv_loc_imps_fw<span class="main"><span class="main">[</span></span><span class="operator">OF</span> path_sum<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> inM<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="skolem">M</span> <span class="main">(</span><span class="free">results_in</span> <span class="skolem">t''</span> <span class="main">(</span>sum_path_weights <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> loc_imps_fw_implication_in_M<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span> Mxs<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span> t''_zcount<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> vacant2<span class="main">:</span> <span class="quoted"><span class="quoted">"worklists_vacant_to <span class="free">c</span> <span class="main">(</span><span class="free">results_in</span> <span class="skolem">t''</span> <span class="main">(</span>sum_weights <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="bound">l</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> Mxs<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">meson</span> results_in_mono<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> worklists_vacant_to_trans t''<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> t'<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> vacant<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">≤</span> <span class="free">results_in</span> <span class="skolem">t''</span> <span class="main">(</span>sum_path_weights <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c</span> <span class="skolem">loc2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span> <span class="main">(</span><span class="operator">rule</span> loc_imps_fw_M_in_implications'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Mxs<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span> vacant2 inM<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">t'</span></span><span class="main">≤</span><span class="free">results_in</span> <span class="skolem">t</span> <span class="skolem">s</span><span class="main">.</span> <span class="bound">t'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c</span> <span class="skolem">loc2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">u</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Mxs<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> t''<span class="main">(</span>2<span class="main">)</span> t'<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">meson</span> order.trans results_in_mono<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Propagate-alw_conjI"><span class="command">lemma</span></span> alw_conjI<span class="main">:</span> <span class="quoted"><span class="quoted">"alw <span class="free">P</span> <span class="free">s</span> <span class="main">⟹</span> alw <span class="free">Q</span> <span class="free">s</span> <span class="main">⟹</span> alw <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">s</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Propagate-alw_inv_safe"><span class="command">lemma</span></span> alw_inv_safe<span class="main">:</span> <span class="quoted"><span class="quoted">"spec <span class="free">s</span> <span class="main">⟹</span> alw <span class="main">(</span>holds inv_safe<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> spec_imp_iiws<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> alw_inv_implications_nonneg<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> alw_mp<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> φ <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">.</span></span> holds inv_imps_work_sum <span class="bound"><span class="bound">s</span></span> <span class="main"><span class="main">∧</span></span> holds inv_implications_nonneg <span class="bound"><span class="bound">s</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> alw_conjI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alw_mono inv_safe<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Propagate-empty_worklists_vacant_to"><span class="command">lemma</span></span> empty_worklists_vacant_to<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">loc</span><span class="main">.</span> c_work <span class="free">c</span> <span class="bound">loc</span> <span class="main">=</span> <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span> <span class="main">⟹</span> worklists_vacant_to <span class="free">c</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> worklists_vacant_to_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Propagate-inv_safe_safe"><span class="command">lemma</span></span> inv_safe_safe<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">loc</span><span class="main">.</span> c_work <span class="free">c</span> <span class="bound">loc</span> <span class="main">=</span> <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span><span class="main">)</span> <span class="main">⟹</span> inv_safe <span class="free">c</span> <span class="main">⟹</span> safe <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> inv_safe_def safe_def worklists_vacant_to_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Propagate-safe"><span class="command">lemma</span></span> safe<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inv_imps_work_sum <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"inv_implications_nonneg <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">loc</span><span class="main">.</span> c_work <span class="free">c</span> <span class="bound">loc</span> <span class="main">=</span> <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"safe <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_safe_safe<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span> inv_safe<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main">,</span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Implied Frontier›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">zmset_pos</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">zmset_pos</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">≡</span> zmset_of <span class="main">(</span>mset_pos <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">implied_frontier</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">implied_frontier</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="main">=</span> frontier <span class="main">(</span><span class="main">∑</span><span class="bound">loc'</span><span class="main">∈</span>UNIV<span class="main">.</span> after_summary <span class="main">(</span>zmset_pos <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">loc'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>path_summary <span class="bound">loc'</span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">implied_frontier_alt</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">implied_frontier_alt</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="main">=</span> frontier <span class="main">(</span><span class="main">∑</span><span class="bound">loc'</span><span class="main">∈</span>UNIV<span class="main">.</span> after_summary <span class="main">(</span>zmset_frontier <span class="main">(</span>c_pts <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">loc'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>path_summary <span class="bound">loc'</span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Propagate-in_frontier_least"><span class="command">lemma</span></span> in_frontier_least<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="free">M</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="main">¬</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer'</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> minimal_antichain_def<span class="main">)</span>

<span class="keyword1" id="Propagate-in_frontier_trans"><span class="command">lemma</span></span> in_frontier_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="free">M</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">y</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_less minimal_antichain_def<span class="main">)</span>

<span class="keyword1" id="Propagate-implied_frontier_alt_least"><span class="command">lemma</span></span> implied_frontier_alt_least<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> implied_frontier_alt <span class="free">c</span> <span class="free">loc2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">loc</span> <span class="bound">a'</span> <span class="bound">s'</span><span class="main">.</span> <span class="bound">a'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_pts <span class="free">c</span> <span class="bound">loc</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">s'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> path_summary <span class="bound">loc</span> <span class="free">loc2</span> <span class="main">⟶</span> <span class="main">¬</span> <span class="free">results_in</span> <span class="bound">a'</span> <span class="bound">s'</span> <span class="main">&lt;</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI notI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">loc</span> <span class="skolem">a'</span> <span class="skolem">s'</span>
  <span class="keyword3"><span class="command">assume</span></span> a'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_pts <span class="free">c</span> <span class="skolem">loc</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> s'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> path_summary <span class="skolem">loc</span> <span class="free">loc2</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> lt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">results_in</span> <span class="skolem">a'</span> <span class="skolem">s'</span> <span class="main">&lt;</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>after_summary <span class="main">(</span>zmset_frontier <span class="main">(</span>c_pts <span class="free">c</span> <span class="skolem">loc</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>path_summary <span class="skolem">loc</span> <span class="free">loc2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">results_in</span> <span class="skolem">a'</span> <span class="skolem">s'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> a' s' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> pos_zcount_after_summary<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span><span class="main">∑</span><span class="bound">loc'</span><span class="main">∈</span>UNIV<span class="main">.</span> after_summary <span class="main">(</span>zmset_frontier <span class="main">(</span>c_pts <span class="free">c</span> <span class="bound">loc'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>path_summary <span class="bound">loc'</span> <span class="free">loc2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">results_in</span> <span class="skolem">a'</span> <span class="skolem">s'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum_pos<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> y <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem">loc</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zcount_sum<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">results_in</span> <span class="skolem">a'</span> <span class="skolem">s'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> implied_frontier_alt <span class="free">c</span> <span class="free">loc2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms lt <span class="keyword1"><span class="command">unfolding</span></span> implied_frontier_alt_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_frontier_trans<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> y <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="free">results_in</span> <span class="skolem">a'</span> <span class="skolem">s'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="free">b</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> lt assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> implied_frontier_alt_def
    <span class="keyword1"><span class="command">using</span></span> frontier_comparable_False
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Propagate-implied_frontier_alt_in_pointstamps"><span class="command">lemma</span></span> implied_frontier_alt_in_pointstamps<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> implied_frontier_alt <span class="free">c</span> <span class="free">loc2</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">a</span> <span class="free">s</span> <span class="free">loc1</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_pts <span class="free">c</span> <span class="free">loc1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> path_summary <span class="free">loc1</span> <span class="free">loc2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">results_in</span> <span class="free">a</span> <span class="free">s</span> <span class="main">=</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">atomize_elim</span>
  <span class="keyword1"><span class="command">unfolding</span></span> implied_frontier_alt_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> member_frontier_pos_zmset<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> zcount_sum<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> sum_pos_ex_elem_pos<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> after_summary_obtain_pre<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> loc1 a s
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">loc1</span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">a</span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">s</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Propagate-in_implied_frontier_alt_in_implication_frontier"><span class="command">lemma</span></span> in_implied_frontier_alt_in_implication_frontier<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inv_imps_work_sum <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"inv_implications_nonneg <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"worklists_vacant_to <span class="free">c</span> <span class="free">b</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> implied_frontier_alt <span class="free">c</span> <span class="free">loc2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c</span> <span class="free">loc2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> safe<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_pts <span class="free">c</span> <span class="skolem">loc1</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">⟹</span> <span class="skolem">s</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> path_summary <span class="skolem">loc1</span> <span class="skolem">loc2</span> <span class="main">⟹</span> <span class="free">results_in</span> <span class="skolem">t</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="free">b</span>
        <span class="main">⟹</span> <span class="main">∃</span><span class="bound"><span class="bound">t'</span></span><span class="main">≤</span><span class="free">results_in</span> <span class="skolem">t</span> <span class="skolem">s</span><span class="main">.</span> <span class="bound">t'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c</span> <span class="skolem">loc2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">loc1</span> <span class="skolem">loc2</span> <span class="skolem">t</span> <span class="skolem">s</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_safe<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> inv_safe_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> worklists_vacant_to_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="comment1">― ‹Pointstamp <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">b</span></span><span class="antiquote">}</span></span> in the <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">implied_frontier_alt</span><span class="antiquote">}</span></span> is caused by a pointstamp <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">a</span></span><span class="antiquote">}</span></span> and summary <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">s</span></span><span class="antiquote">}</span></span>
          and <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">results_in</span> <span class="free">a</span> <span class="free">s</span>"</span><span class="antiquote">}</span></span> is least among such pointstamps›</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">loc1</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> loc1_a_s<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_pts <span class="free">c</span> <span class="skolem">loc1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> path_summary <span class="skolem">loc1</span> <span class="free">loc2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">results_in</span> <span class="skolem">a</span> <span class="skolem">s</span> <span class="main">=</span> <span class="free">b</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">loc</span> <span class="bound">a'</span> <span class="bound">s'</span><span class="main">.</span> <span class="bound">a'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_pts <span class="free">c</span> <span class="bound">loc</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">s'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> path_summary <span class="bound">loc</span> <span class="free">loc2</span> <span class="main">⟶</span> <span class="main">¬</span> <span class="free">results_in</span> <span class="bound">a'</span> <span class="bound">s'</span> <span class="main">&lt;</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">atomize_elim</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> implied_frontier_alt_in_pointstamps<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> implied_frontier_alt_least<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> zcount_ps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_pts <span class="free">c</span> <span class="skolem">loc1</span><span class="main">)</span> <span class="skolem">a</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> member_frontier_pos_zmset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="comment1">― ‹From `safe` we know that pointstamp <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="skolem">a</span></span><span class="antiquote">}</span></span> is reflected in the implications by some
      poinstamp <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">b'</span> <span class="main">≤</span> <span class="free">b</span>"</span><span class="antiquote">}</span></span>›</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b'</span></span> <span class="keyword2"><span class="keyword">where</span></span> b'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c</span> <span class="free">loc2</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b'</span> <span class="main">≤</span> <span class="free">results_in</span> <span class="skolem">a</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> safe<span class="main">[</span><span class="operator">OF</span> zcount_ps loc1_a_s<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> loc1_a_s<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b'</span> <span class="main">=</span> <span class="free">results_in</span> <span class="skolem">a</span> <span class="skolem">s</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>c_work <span class="free">c</span> <span class="skolem">loc</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">results_in</span> <span class="skolem">t</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="skolem">b'</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span> <span class="skolem">s</span> <span class="skolem">loc</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">results_in</span> <span class="skolem">t</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="free">b</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> b'<span class="main">(</span>2<span class="main">)</span> loc1_a_s<span class="main">(</span>3<span class="main">)</span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> results_in_mono<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> worklists_vacant_to_def flow.zero_le order_trans
            path_weight_refl zcount_inI<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
      <span class="comment1">― ‹but the pointstamp can't be strictly less, because we know that <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">results_in</span> <span class="skolem">a</span> <span class="skolem">s</span>"</span><span class="antiquote">}</span></span> is least›</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a'</span></span> <span class="skolem"><span class="skolem">loc1'</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="keyword2"><span class="keyword">where</span></span> a'<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="skolem">s'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> path_summary <span class="skolem">loc1'</span> <span class="free">loc2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">results_in</span> <span class="skolem">a'</span> <span class="skolem">s'</span> <span class="main">≤</span> <span class="skolem">b'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_pts <span class="free">c</span> <span class="skolem">loc1'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> implication_implies_pointstamp<span class="main">[</span><span class="operator">OF</span> b'<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b'</span> <span class="main">≠</span> <span class="free">results_in</span> <span class="skolem">a</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> b'<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> b'_lt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b'</span> <span class="main">&lt;</span> <span class="free">results_in</span> <span class="skolem">a</span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">note</span></span> loc1_a_s<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">unfolded</span> loc1_a_s<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">OF</span> a'<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">,</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">with</span></span> b'_lt a'<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> leD less_le order_trans<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
    <span class="comment1">― ‹Hence, the <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">implied_frontier_alt</span><span class="antiquote">}</span></span> pointstamp <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">b</span></span><span class="antiquote">}</span></span> is reflected in the implications›</span>
  <span class="keyword1"><span class="command">with</span></span> b' <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c</span> <span class="free">loc2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> loc1_a_s<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Propagate-in_implication_frontier_in_implied_frontier_alt"><span class="command">lemma</span></span> in_implication_frontier_in_implied_frontier_alt<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inv_imps_work_sum <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"inv_implications_nonneg <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"worklists_vacant_to <span class="free">c</span> <span class="free">b</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c</span> <span class="free">loc2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> implied_frontier_alt <span class="free">c</span> <span class="free">loc2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> safe<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_pts <span class="free">c</span> <span class="skolem">loc1</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">⟹</span> <span class="skolem">s</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> path_summary <span class="skolem">loc1</span> <span class="skolem">loc2</span> <span class="main">⟹</span> <span class="free">results_in</span> <span class="skolem">t</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="free">b</span>
        <span class="main">⟹</span> <span class="main">∃</span><span class="bound"><span class="bound">t'</span></span><span class="main">≤</span><span class="free">results_in</span> <span class="skolem">t</span> <span class="skolem">s</span><span class="main">.</span> <span class="bound">t'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c</span> <span class="skolem">loc2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">loc1</span> <span class="skolem">loc2</span> <span class="skolem">t</span> <span class="skolem">s</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_safe<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> inv_safe_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> worklists_vacant_to_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>c_work <span class="free">c</span> <span class="skolem">loc</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">results_in</span> <span class="skolem">t</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span> <span class="skolem">s</span> <span class="skolem">loc</span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> results_in_mono<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> worklists_vacant_to_def flow.zero_le
        order_trans path_weight_refl zcount_inI<span class="main">)</span>
      <span class="comment1">― ‹Pointstamp <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">b</span></span><span class="antiquote">}</span></span> in the implications is caused by a pointstamp <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">a</span></span><span class="antiquote">}</span></span> and a summary <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">s</span></span><span class="antiquote">}</span></span>›</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">loc1</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> loc1_a_s<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> path_summary <span class="skolem">loc1</span> <span class="free">loc2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">results_in</span> <span class="skolem">a</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_pts <span class="free">c</span> <span class="skolem">loc1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> implication_implies_pointstamp<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> zcount_a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_pts <span class="free">c</span> <span class="skolem">loc1</span><span class="main">)</span> <span class="skolem">a</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> member_frontier_pos_zmset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> b_ria<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">results_in</span> <span class="skolem">a</span> <span class="skolem">s</span> <span class="main">=</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">results_in</span> <span class="skolem">a</span> <span class="skolem">s</span> <span class="main">≠</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> loc1_a_s<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">results_in</span> <span class="skolem">a</span> <span class="skolem">s</span> <span class="main">&lt;</span> <span class="free">b</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> safe<span class="main">[</span><span class="operator">OF</span> zcount_a loc1_a_s<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> assms<span class="main">(</span>4<span class="main">)</span> loc1_a_s<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> order.strict_trans1 frontier_comparable_False <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
    <span class="comment1">― ‹<span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">results_in</span> <span class="skolem">a</span> <span class="skolem">s</span>"</span><span class="antiquote">}</span></span> is a candidate for inclusion in the <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">implied_frontier_alt</span><span class="antiquote">}</span></span>..›</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span><span class="main">∑</span><span class="bound">loc'</span><span class="main">∈</span>UNIV<span class="main">.</span> after_summary <span class="main">(</span>zmset_frontier <span class="main">(</span>c_pts <span class="free">c</span> <span class="bound">loc'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>path_summary <span class="bound">loc'</span> <span class="free">loc2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">results_in</span> <span class="skolem">a</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> after_summary_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> zcount_sum<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sum_pos<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">loc1</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zcount_sum<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sum_nonneg<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> zcount_image_zmset<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> zcount_sum<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sum_pos<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">s</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> loc1_a_s<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span> <span class="main"><span class="keyword3">[</span></span>3<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> zcount_image_zmset<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sum_pos<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">a</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> loc1_a_s<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="comment1">― ‹..which means a pointstamp <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">b'</span> <span class="main">≤</span> <span class="free">results_in</span> <span class="skolem">a</span> <span class="skolem">s</span>"</span><span class="antiquote">}</span></span> must exist in the <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">implied_frontier_alt</span><span class="antiquote">}</span></span>..›</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b'</span></span> <span class="keyword2"><span class="keyword">where</span></span> b'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> implied_frontier_alt <span class="free">c</span> <span class="free">loc2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b'</span> <span class="main">≤</span> <span class="free">results_in</span> <span class="skolem">a</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> implied_frontier_alt_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> obtain_frontier_elem<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"worklists_vacant_to <span class="free">c</span> <span class="skolem">b'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> loc1_a_s<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> worklists_vacant_to_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> b' <span class="keyword1"><span class="command">have</span></span> b'_frontier<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c</span> <span class="free">loc2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> in_implied_frontier_alt_in_implication_frontier assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="comment1">― ‹..and this pointstamp must be equal to <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="skolem">b'</span></span><span class="antiquote">}</span></span>›</span>
  <span class="keyword1"><span class="command">have</span></span> b'_ria<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b'</span> <span class="main">=</span> <span class="free">results_in</span> <span class="skolem">a</span> <span class="skolem">s</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b'</span> <span class="main">≠</span> <span class="free">results_in</span> <span class="skolem">a</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> b'<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> b'_lt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b'</span> <span class="main">&lt;</span> <span class="free">results_in</span> <span class="skolem">a</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> b'_frontier b'_lt b_ria assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> frontier_comparable_False <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
    <span class="comment1">― ‹Hence, the implication frontier pointstamp <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">b</span></span><span class="antiquote">}</span></span> is reflected in the <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">implied_frontier_alt</span><span class="antiquote">}</span></span>›</span>
  <span class="keyword1"><span class="command">from</span></span> b' b'_ria b_ria <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> implied_frontier_alt <span class="free">c</span> <span class="free">loc2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> implied_frontier_alt_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Propagate-implication_frontier_iff_implied_frontier_alt_vacant"><span class="command">lemma</span></span> implication_frontier_iff_implied_frontier_alt_vacant<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inv_imps_work_sum <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"inv_implications_nonneg <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"worklists_vacant_to <span class="free">c</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c</span> <span class="free">loc</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">b</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> implied_frontier_alt <span class="free">c</span> <span class="free">loc</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>
    ac_eq_iff
    in_implication_frontier_in_implied_frontier_alt<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
    in_implied_frontier_alt_in_implication_frontier<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Propagate-next_propagate_implied_frontier_alt_def"><span class="command">lemma</span></span> next_propagate_implied_frontier_alt_def<span class="main">:</span>
  <span class="quoted"><span class="quoted">"next_propagate <span class="free">c</span> <span class="free">c'</span> <span class="main">⟹</span> implied_frontier_alt <span class="free">c</span> <span class="free">loc</span> <span class="main">=</span> implied_frontier_alt <span class="free">c'</span> <span class="free">loc</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next_propagate'_def implied_frontier_alt_def<span class="main">)</span>

<span class="keyword1" id="Propagate-implication_frontier_eq_implied_frontier_alt"><span class="command">lemma</span></span> implication_frontier_eq_implied_frontier_alt<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inv_imps_work_sum <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"inv_implications_nonneg <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">loc</span><span class="main">.</span> c_work <span class="free">c</span> <span class="bound">loc</span> <span class="main">=</span> <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"frontier <span class="main">(</span>c_imp <span class="free">c</span> <span class="free">loc</span><span class="main">)</span> <span class="main">=</span> implied_frontier_alt <span class="free">c</span> <span class="free">loc</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ac_eq_iff implication_frontier_iff_implied_frontier_alt_vacant empty_worklists_vacant_to assms
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Propagate-alw_implication_frontier_eq_implied_frontier_alt_empty"><span class="command">lemma</span></span> alw_implication_frontier_eq_implied_frontier_alt_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"spec <span class="free">s</span> <span class="main">⟹</span>
  alw <span class="main">(</span>holds <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">loc</span><span class="main">.</span> c_work <span class="bound">c</span> <span class="bound">loc</span> <span class="main">=</span> <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span><span class="main">)</span> <span class="main">⟶</span> frontier <span class="main">(</span>c_imp <span class="bound">c</span> <span class="free">loc</span><span class="main">)</span> <span class="main">=</span> implied_frontier_alt <span class="bound">c</span> <span class="free">loc</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> spec_imp_iiws<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> alw_inv_implications_nonneg<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> alw_conjI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> thin_rl<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> alw_mono <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> implication_frontier_eq_implied_frontier_alt<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Propagate-alw_implication_frontier_eq_implied_frontier_alt_vacant"><span class="command">lemma</span></span> alw_implication_frontier_eq_implied_frontier_alt_vacant<span class="main">:</span> <span class="quoted"><span class="quoted">"spec <span class="free">s</span> <span class="main">⟹</span>
  alw <span class="main">(</span>holds <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> worklists_vacant_to <span class="bound">c</span> <span class="free">b</span> <span class="main">⟶</span> <span class="free">b</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="bound">c</span> <span class="free">loc</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">b</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> implied_frontier_alt <span class="bound">c</span> <span class="free">loc</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> spec_imp_iiws<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> alw_inv_implications_nonneg<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> alw_conjI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> thin_rl<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> alw_mono <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> implication_frontier_iff_implied_frontier_alt_vacant<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Propagate-antichain_eqI"><span class="command">lemma</span></span> antichain_eqI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">A</span> <span class="main">⟷</span> <span class="bound">b</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">B</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">=</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="Propagate-zmset_frontier_zmset_pos"><span class="command">lemma</span></span> zmset_frontier_zmset_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"zmset_frontier <span class="free">A</span> <span class="keyword1">⊆#<span class="hidden">⇩</span><sub>z</sub></span> zmset_pos <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subseteq_zmset_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer'</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> count_mset_set_if minimal_antichain_def<span class="main">)</span>

<span class="keyword1" id="Propagate-image_mset_mono_pos"><span class="command">lemma</span></span> image_mset_mono_pos<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">b</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> zcount <span class="free">A</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">b</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> zcount <span class="free">B</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="free">A</span> <span class="keyword1">⊆#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">B</span> <span class="main">⟹</span> image_zmset <span class="free">f</span> <span class="free">A</span> <span class="keyword1">⊆#<span class="hidden">⇩</span><sub>z</sub></span> image_zmset <span class="free">f</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subseteq_zmset_def zcount_image_zmset
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> allI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sum_mono sum_mono2<span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Int_subset_iff antisym subsetI zcount_ne_zero_iff<span class="main">)</span>

<span class="keyword1" id="Propagate-sum_mono_subseteq"><span class="command">lemma</span></span> sum_mono_subseteq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">∈</span><span class="free">K</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">i</span> <span class="keyword1">⊆#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">g</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">K</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="keyword1">⊆#<span class="hidden">⇩</span><sub>z</sub></span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">K</span><span class="main">.</span> <span class="free">g</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subseteq_zmset_def sum_mono zcount_sum<span class="main">)</span>

<span class="keyword1" id="Propagate-after_summary_zmset_frontier"><span class="command">lemma</span></span> after_summary_zmset_frontier<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"after_summary <span class="main">(</span>zmset_frontier <span class="free">A</span><span class="main">)</span> <span class="free">S</span> <span class="keyword1">⊆#<span class="hidden">⇩</span><sub>z</sub></span> after_summary <span class="main">(</span>zmset_pos <span class="free">A</span><span class="main">)</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> after_summary_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sum_mono_subseteq<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> image_mset_mono_pos<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ zmset_frontier_zmset_pos<span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Propagate-frontier_eqI"><span class="command">lemma</span></span> frontier_eqI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">b</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> zcount <span class="free">A</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">b</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> zcount <span class="free">B</span> <span class="bound">b</span> <span class="main">⟹</span>
  <span class="free">A</span> <span class="keyword1">⊆#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">B</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">B</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">A</span> <span class="main">∧</span> <span class="bound">a</span> <span class="main">≤</span> <span class="bound">b</span><span class="main">)</span> <span class="main">⟹</span> frontier <span class="free">A</span> <span class="main">=</span> frontier <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">transfer</span> <span class="quasi_keyword">fixing</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">B</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> minimal_antichain_def subseteq_zmset_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> less_le_trans<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> less_le less_le_trans zcount_ne_zero_iff<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> antisym less_le zcount_ne_zero_iff<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">meson</span> less_le_trans<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Propagate-implied_frontier_implied_frontier_alt"><span class="command">lemma</span></span> implied_frontier_implied_frontier_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"implied_frontier <span class="main">(</span>c_pts <span class="free">c</span><span class="main">)</span> <span class="free">loc</span> <span class="main">=</span> implied_frontier_alt <span class="free">c</span> <span class="free">loc</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> implied_frontier_alt_def implied_frontier_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> frontier_eqI<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zcount_sum sum_nonneg<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zcount_sum sum_nonneg<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum_mono_subseteq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> after_summary_zmset_frontier<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> zcount_ne_zero_iff <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zcount_sum<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> sum.not_neutral_contains_not_neutral<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> zcount_ne_zero_iff <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> after_summary_def zcount_sum<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> sum.not_neutral_contains_not_neutral<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> zcount_ne_zero_iff <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zcount_image_zmset <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> sum.not_neutral_contains_not_neutral<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> zcount_ne_zero_iff<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> u loc s t
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> obtain_elem_frontier<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"c_pts <span class="free"><span class="free">c</span></span> <span class="skolem"><span class="skolem">loc</span></span>"</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">t</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> le_less<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> a
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">results_in</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">s</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> results_in_mono<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> sum_nonneg_eq_0_iff<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_nonneg<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">loc</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> sum_nonneg_eq_0_iff<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> bexI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">s</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemmas</span></span> alw_implication_frontier_eq_implied_frontier_vacant <span class="main">=</span>
  alw_implication_frontier_eq_implied_frontier_alt_vacant<span class="main">[</span><span class="operator">folded</span> implied_frontier_implied_frontier_alt<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> implication_frontier_iff_implied_frontier_vacant <span class="main">=</span>
  implication_frontier_iff_implied_frontier_alt_vacant<span class="main">[</span><span class="operator">folded</span> implied_frontier_implied_frontier_alt<span class="main">]</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span></pre>
</div><div id="Combined">
<div class="head">
<h1>Theory Combined</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Combined Progress Tracking Protocol\label{sec:combined}›</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Combined
  <span class="keyword2"><span class="keyword">imports</span></span>
    <a href="#Exchange">Exchange</a>
    <a href="#Propagate">Propagate</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1" id="Combined-fold_invar"><span class="command">lemma</span></span> fold_invar<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">M</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">z</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">z</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">M</span><span class="main">.</span> <span class="free">P</span> <span class="bound">z</span> <span class="main">⟶</span> <span class="free">P</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">z</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"comp_fun_commute <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>Finite_Set.fold <span class="free">f</span> <span class="free">z</span> <span class="free">M</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">M</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">z</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> comp_fun_commute.fold_insert<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Could-result-in Relation›</span></span>

<span class="keyword1"><span class="command">context</span></span> dataflow_topology <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">cri_less_eq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'loc</span> <span class="main">×</span> <span class="tfree">'t</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'loc</span> <span class="main">×</span> <span class="tfree">'t</span><span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_<span class="keyword1">≤<span class="hidden">⇩</span><sub>p</sub></span>_"</span> <span class="main">[</span>51<span class="main">,</span>51<span class="main">]</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">cri_less_eq</span> <span class="main">=</span>
    <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">loc1</span><span class="main">,</span><span class="bound">t1</span><span class="main">)</span> <span class="main">(</span><span class="bound">loc2</span><span class="main">,</span><span class="bound">t2</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> path_summary <span class="bound">loc1</span> <span class="bound">loc2</span> <span class="main">∧</span> <span class="free">results_in</span> <span class="bound">t1</span> <span class="bound">s</span> <span class="main">≤</span> <span class="bound">t2</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">cri_less</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'loc</span> <span class="main">×</span> <span class="tfree">'t</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'loc</span> <span class="main">×</span> <span class="tfree">'t</span><span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_<span class="keyword1">&lt;<span class="hidden">⇩</span><sub>p</sub></span>_"</span> <span class="main">[</span>51<span class="main">,</span>51<span class="main">]</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">cri_less</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>p</sub></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Combined-cri_asym1"><span class="command">lemma</span></span> cri_asym1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">&lt;<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">y</span> <span class="main">⟶</span> <span class="main">¬</span> <span class="free">y</span> <span class="keyword1">&lt;<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">x</span> <span class="free">y</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">y</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">loc1</span> <span class="skolem">t1</span> <span class="skolem">loc2</span> <span class="skolem">t2</span>
  <span class="keyword3"><span class="command">assume</span></span> as<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="free">x</span> <span class="keyword1">&lt;<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">y</span> <span class="main">⟶</span> <span class="main">¬</span> <span class="free">y</span> <span class="keyword1">&lt;<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">x</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">loc1</span><span class="main">,</span> <span class="skolem">t1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">loc2</span><span class="main">,</span> <span class="skolem">t2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> as1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">loc1</span> <span class="main">≠</span> <span class="skolem">loc2</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> cri_less_def cri_less_eq_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span>
      <span class="main">(</span><span class="operator">metis</span> add.right_neutral order.antisym order.trans le_plus<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> results_in_mono<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> results_in_zero<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> as <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s1</span></span> <span class="keyword2"><span class="keyword">where</span></span> s1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s1</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> path_summary <span class="skolem">loc1</span> <span class="skolem">loc2</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">results_in</span> <span class="skolem">t1</span> <span class="skolem">s1</span> <span class="main">≤</span> <span class="skolem">t2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cri_less_def cri_less_eq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">path1</span></span> <span class="keyword2"><span class="keyword">where</span></span> path1<span class="main">:</span> <span class="quoted"><span class="quoted">"flow.path <span class="skolem">loc1</span> <span class="skolem">loc2</span> <span class="skolem">path1</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">s1</span> <span class="main">=</span> flow.sum_path_weights <span class="skolem">path1</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">path1</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> as1 flow.path_weight_conv_path flow.path0E <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> as <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s2</span></span> <span class="keyword2"><span class="keyword">where</span></span> s2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s2</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> path_summary <span class="skolem">loc2</span> <span class="skolem">loc1</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">results_in</span> <span class="skolem">t2</span> <span class="skolem">s2</span> <span class="main">≤</span> <span class="skolem">t1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cri_less_def cri_less_eq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">path2</span></span> <span class="keyword2"><span class="keyword">where</span></span> path2<span class="main">:</span> <span class="quoted"><span class="quoted">"flow.path <span class="skolem">loc2</span> <span class="skolem">loc1</span> <span class="skolem">path2</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">s2</span> <span class="main">=</span> flow.sum_path_weights <span class="skolem">path2</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">path2</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> as1 flow.path_weight_conv_path flow.path0E <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> path1 <span class="keyword1"><span class="command">have</span></span> path_total<span class="main">:</span> <span class="quoted"><span class="quoted">"flow.path <span class="skolem">loc1</span> <span class="skolem">loc1</span> <span class="main">(</span><span class="skolem">path1</span><span class="main">@</span><span class="skolem">path2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> flow.path_trans path2<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s3</span></span> <span class="keyword2"><span class="keyword">where</span></span> s3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s3</span> <span class="main">=</span> flow.sum_path_weights <span class="main">(</span><span class="skolem">path1</span><span class="main">@</span><span class="skolem">path2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> s3_sum<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s3</span> <span class="main">=</span> followed_by <span class="skolem">s1</span> <span class="skolem">s2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> path1 path2 flow.sum_weights_append <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">t1</span> <span class="main">&lt;</span> <span class="free">results_in</span> <span class="skolem">t1</span> <span class="skolem">s3</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> s3_sum s1<span class="main">(</span>2<span class="main">)</span> s2<span class="main">(</span>2<span class="main">)</span> followed_by_summary
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_less_trans less_le_not_le results_in_mono<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> path_total no_zero_cycle s3 path1<span class="main">(</span>3<span class="main">)</span> path2<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Combined-cri_asym2"><span class="command">lemma</span></span> cri_asym2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">&lt;<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">y</span> <span class="main">⟶</span> <span class="free">x</span> <span class="main">≠</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cri_less_def<span class="main">)</span>

<span class="keyword1"><span class="command">sublocale</span></span> cri<span class="main">:</span> order <span class="quoted">cri_less_eq</span> <span class="quoted">cri_less</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">using</span></span> cri_asym1 cri_asym2 cri_less_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x
    <span class="keyword1"><span class="command">unfolding</span></span> cri_less_eq_def
    <span class="keyword1"><span class="command">using</span></span> flow.path_weight_refl results_in_zero <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword2"><span class="keyword">for</span></span> x y z <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">aa</span> <span class="skolem">ba</span> <span class="skolem">ab</span> <span class="skolem">bb</span>
    <span class="keyword3"><span class="command">assume</span></span> as<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">z</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">aa</span><span class="main">,</span> <span class="skolem">ba</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ab</span><span class="main">,</span> <span class="skolem">bb</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s1</span></span> <span class="keyword2"><span class="keyword">where</span></span> s1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s1</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> path_summary <span class="skolem">a</span> <span class="skolem">aa</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">results_in</span> <span class="skolem">b</span> <span class="skolem">s1</span> <span class="main">≤</span> <span class="skolem">ba</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> cri_less_eq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> as<span class="main">(</span>2<span class="main">,</span>4<span class="main">,</span>5<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s2</span></span> <span class="keyword2"><span class="keyword">where</span></span> s2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s2</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> path_summary <span class="skolem">aa</span> <span class="skolem">ab</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">results_in</span> <span class="skolem">ba</span> <span class="skolem">s2</span> <span class="main">≤</span> <span class="skolem">bb</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> cri_less_eq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> s1 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s3</span></span> <span class="keyword2"><span class="keyword">where</span></span> s3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s3</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> path_summary <span class="skolem">a</span> <span class="skolem">ab</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s3</span> <span class="main">≤</span> followed_by <span class="skolem">s1</span> <span class="skolem">s2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> flow.path_weight_elem_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> s1 s2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">results_in</span> <span class="skolem">b</span> <span class="skolem">s3</span> <span class="main">≤</span> <span class="skolem">bb</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="free">results_in</span> <span class="main">(</span><span class="free">results_in</span> <span class="skolem">b</span> <span class="skolem">s1</span><span class="main">)</span> <span class="bound">s</span> <span class="main">≤</span> <span class="free">results_in</span> <span class="skolem">ba</span> <span class="bound">s</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> results_in_mono<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> s1<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> results_in_mono<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> followed_by_summary order_trans s2<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> s3<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">with</span></span> as s3 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> cri_less_eq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">using</span></span> cri_asym1 cri_asym2 cri_less_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Combined-wf_cri"><span class="command">lemma</span></span> wf_cri<span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="main">{</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">l'</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="keyword1">&lt;<span class="hidden">⇩</span><sub>p</sub></span> <span class="main">(</span><span class="bound">l'</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_acyclic_wf<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> cri.acyclicI_order<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> acyclic_converse<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Specification›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Configuration›</span></span>

<span class="keyword1"><span class="command">record</span></span> <span class="main">(</span><span class="tfree">'p</span><span class="main">::</span><span class="quoted">finite</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">::</span><span class="quoted">order</span><span class="main">,</span> <span class="tfree">'loc</span><span class="main">)</span> configuration <span class="main">=</span>
  exchange_config <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span><span class="main">,</span> <span class="main">(</span><span class="tfree">'loc</span> <span class="main">×</span> <span class="tfree">'t</span><span class="main">)</span><span class="main">)</span> Exchange.configuration"</span></span>
  prop_config <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'p</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'loc</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">)</span> Propagate.configuration"</span></span>
  init <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'p</span> <span class="main">⇒</span> bool"</span></span> <span class="comment1">(* True = initialization finished *)</span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">,</span> <span class="tfree">'loc</span><span class="main">)</span> computation <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">,</span> <span class="tfree">'loc</span><span class="main">)</span> configuration stream"</span></span>

<span class="keyword1"><span class="command">context</span></span> dataflow_topology <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">the_cm</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">the_cm</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">c'</span><span class="main">.</span> next_change_multiplicity' <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">c'</span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">the_cm</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is not commutative in general, only if the necessary conditions hold. It can be converted
to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">apply_cm</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> for which we prove <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">comp_fun_commute</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">apply_cm</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">apply_cm</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="bound">new_pointstamps</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">loc'</span><span class="main">.</span>
                <span class="main">(</span><span class="keyword1">if</span> <span class="bound">loc'</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="keyword1">then</span> update_zmultiset <span class="main">(</span>c_pts <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">loc'</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>
                               <span class="keyword1">else</span> c_pts <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">loc'</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">in</span>
        <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">⦇</span> c_pts <span class="main">:=</span> <span class="bound">new_pointstamps</span> <span class="main">⦈</span>
          <span class="main">⦇</span> c_work <span class="main">:=</span>
            <span class="main">(</span><span class="main">λ</span><span class="bound">loc'</span><span class="main">.</span> c_work <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">loc'</span> <span class="main">+</span> frontier_changes <span class="main">(</span><span class="bound">new_pointstamps</span> <span class="bound">loc'</span><span class="main">)</span> <span class="main">(</span>c_pts <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">loc'</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">cm_all'</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">cm_all'</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">Δ</span></span></span> <span class="main">=</span>
      Finite_Set.fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">loc</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="bound">c</span><span class="main">.</span> apply_cm <span class="bound">c</span> <span class="bound">loc</span> <span class="bound">t</span> <span class="main">(</span>zcount <span class="free"><span class="bound"><span class="entity">Δ</span></span></span> <span class="main">(</span><span class="bound">loc</span><span class="main">,</span><span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="main">(</span>set_zmset <span class="free"><span class="bound"><span class="entity">Δ</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">cm_all</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">cm_all</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">Δ</span></span></span> <span class="main">=</span>
      Finite_Set.fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">loc</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="bound">c</span><span class="main">.</span> the_cm <span class="bound">c</span> <span class="bound">loc</span> <span class="bound">t</span> <span class="main">(</span>zcount <span class="free"><span class="bound"><span class="entity">Δ</span></span></span> <span class="main">(</span><span class="bound">loc</span><span class="main">,</span><span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="main">(</span>set_zmset <span class="free"><span class="bound"><span class="entity">Δ</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">propagate_all</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="main">=</span> while_option <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> <span class="main">∃</span><span class="bound">loc</span><span class="main">.</span> <span class="main">(</span>c_work <span class="bound">c</span> <span class="bound">loc</span><span class="main">)</span> <span class="main">≠</span> <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span><span class="main">)</span>
                                            <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> <span class="keyword1">SOME</span> <span class="bound">c'</span><span class="main">.</span> <span class="main">∃</span><span class="bound">loc</span> <span class="bound">t</span><span class="main">.</span> next_propagate' <span class="bound">c</span> <span class="bound">c'</span> <span class="bound">loc</span> <span class="bound">t</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span>"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Initial state and state transitions›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">InitConfig</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span><span class="main">::</span>finite<span class="main">,</span> <span class="tfree">'t</span><span class="main">::</span>order<span class="main">,</span> <span class="tfree">'loc</span><span class="main">)</span> configuration <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">InitConfig</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span>
      <span class="main">(</span><span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span> init <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">p</span> <span class="main">=</span> False<span class="main">)</span>
    <span class="main">∧</span> cri.init_config <span class="main">(</span>exchange_config <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span>
    <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="bound">loc</span> <span class="bound">t</span><span class="main">.</span> zcount <span class="main">(</span>c_pts <span class="main">(</span>prop_config <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">p</span><span class="main">)</span> <span class="bound">loc</span><span class="main">)</span> <span class="bound">t</span>
       <span class="main">=</span> zcount <span class="main">(</span>c_glob <span class="main">(</span>exchange_config <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="bound">loc</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>
    <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">w</span><span class="main">.</span> init_config <span class="main">(</span>prop_config <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">w</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">NextPerformOp'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span><span class="main">::</span>finite<span class="main">,</span> <span class="tfree">'t</span><span class="main">::</span>order<span class="main">,</span> <span class="tfree">'loc</span><span class="main">)</span> configuration <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">,</span> <span class="tfree">'loc</span><span class="main">)</span> configuration
                              <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'loc</span> <span class="main">×</span> <span class="tfree">'t</span><span class="main">)</span> multiset <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'p</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'loc</span> <span class="main">×</span> <span class="tfree">'t</span><span class="main">)</span><span class="main">)</span> multiset <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'loc</span> <span class="main">×</span> <span class="tfree">'t</span><span class="main">)</span> multiset <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">NextPerformOp'</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">Δneg</span></span></span> <span class="free"><span class="bound"><span class="entity">Δmint_msg</span></span></span> <span class="free"><span class="bound"><span class="entity">Δmint_self</span></span></span> <span class="main">=</span> <span class="main">(</span>
     cri.next_performop' <span class="main">(</span>exchange_config <span class="free"><span class="bound"><span class="entity">c0</span></span></span><span class="main">)</span> <span class="main">(</span>exchange_config <span class="free"><span class="bound"><span class="entity">c1</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">Δneg</span></span></span> <span class="free"><span class="bound"><span class="entity">Δmint_msg</span></span></span> <span class="free"><span class="bound"><span class="entity">Δmint_self</span></span></span>
   <span class="main">∧</span> unchanged prop_config <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span>
   <span class="main">∧</span> unchanged init <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">NextPerformOp</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">NextPerformOp</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">p</span> <span class="bound">Δneg</span> <span class="bound">Δmint_msg</span> <span class="bound">Δmint_self</span><span class="main">.</span> NextPerformOp' <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="bound">p</span> <span class="bound">Δneg</span> <span class="bound">Δmint_msg</span> <span class="bound">Δmint_self</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">NextRecvCap'</span>
  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span><span class="main">::</span>finite<span class="main">,</span> <span class="tfree">'t</span><span class="main">::</span>order<span class="main">,</span> <span class="tfree">'loc</span><span class="main">)</span> configuration <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">,</span> <span class="tfree">'loc</span><span class="main">)</span> configuration <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> <span class="tfree">'loc</span> <span class="main">×</span> <span class="tfree">'t</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">NextRecvCap'</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span>
     cri.next_recvcap' <span class="main">(</span>exchange_config <span class="free"><span class="bound"><span class="entity">c0</span></span></span><span class="main">)</span> <span class="main">(</span>exchange_config <span class="free"><span class="bound"><span class="entity">c1</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>
   <span class="main">∧</span> unchanged prop_config <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span>
   <span class="main">∧</span> unchanged init <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">NextRecvCap</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">NextRecvCap</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">p</span> <span class="bound">t</span><span class="main">.</span> NextRecvCap' <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="bound">p</span> <span class="bound">t</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">NextSendUpd'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span><span class="main">::</span>finite<span class="main">,</span> <span class="tfree">'t</span><span class="main">::</span>order<span class="main">,</span> <span class="tfree">'loc</span><span class="main">)</span> configuration <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">,</span> <span class="tfree">'loc</span><span class="main">)</span> configuration
                              <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'loc</span> <span class="main">×</span> <span class="tfree">'t</span><span class="main">)</span> set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">NextSendUpd'</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">tt</span></span></span> <span class="main">=</span> <span class="main">(</span>
    cri.next_sendupd' <span class="main">(</span>exchange_config <span class="free"><span class="bound"><span class="entity">c0</span></span></span><span class="main">)</span> <span class="main">(</span>exchange_config <span class="free"><span class="bound"><span class="entity">c1</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">tt</span></span></span>
  <span class="main">∧</span> unchanged prop_config <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span>
  <span class="main">∧</span> unchanged init <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">NextSendUpd</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">NextSendUpd</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">p</span> <span class="bound">tt</span><span class="main">.</span> NextSendUpd' <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="bound">p</span> <span class="bound">tt</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">NextRecvUpd'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span><span class="main">::</span>finite<span class="main">,</span> <span class="tfree">'t</span><span class="main">::</span>order<span class="main">,</span> <span class="tfree">'loc</span><span class="main">)</span> configuration <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">,</span> <span class="tfree">'loc</span><span class="main">)</span> configuration
                              <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">NextRecvUpd'</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> <span class="main">(</span>
     init <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="comment1">― ‹Once init is set we are guaranteed that the CM transitions' premises are satisfied›</span>
   <span class="main">∧</span> cri.next_recvupd' <span class="main">(</span>exchange_config <span class="free"><span class="bound"><span class="entity">c0</span></span></span><span class="main">)</span> <span class="main">(</span>exchange_config <span class="free"><span class="bound"><span class="entity">c1</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span>
   <span class="main">∧</span> unchanged init <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span>
   <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p'</span><span class="main">.</span> prop_config <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="bound">p'</span> <span class="main">=</span>
          <span class="main">(</span><span class="keyword1">if</span> <span class="bound">p'</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span>
           <span class="keyword1">then</span> cm_all <span class="main">(</span>prop_config <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="main">(</span>hd <span class="main">(</span>c_msg <span class="main">(</span>exchange_config <span class="free"><span class="bound"><span class="entity">c0</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span><span class="main">)</span>
           <span class="keyword1">else</span> prop_config <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="bound">p'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">NextRecvUpd</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">NextRecvUpd</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> NextRecvUpd' <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="bound">p</span> <span class="bound">q</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">NextPropagate'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span><span class="main">::</span>finite<span class="main">,</span> <span class="tfree">'t</span><span class="main">::</span>order<span class="main">,</span> <span class="tfree">'loc</span><span class="main">)</span> configuration <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">,</span> <span class="tfree">'loc</span><span class="main">)</span> configuration
                              <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">NextPropagate'</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span>
     unchanged exchange_config <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span>
   <span class="main">∧</span>  init <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">=</span> <span class="main">(</span>init <span class="free"><span class="bound"><span class="entity">c0</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">:=</span> True<span class="main">)</span>
   <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p'</span><span class="main">.</span> Some <span class="main">(</span>prop_config <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="bound">p'</span><span class="main">)</span> <span class="main">=</span>
          <span class="main">(</span><span class="keyword1">if</span> <span class="bound">p'</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>
           <span class="keyword1">then</span> propagate_all <span class="main">(</span>prop_config <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="bound">p'</span><span class="main">)</span>
           <span class="keyword1">else</span> Some <span class="main">(</span>prop_config <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="bound">p'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">NextPropagate</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">NextPropagate</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">p</span><span class="main">.</span> NextPropagate' <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="bound">p</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted">"<span class="entity">Next'</span>"</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Next'</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">=</span> <span class="main">(</span>NextPerformOp <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">∨</span> NextSendUpd <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">∨</span> NextRecvUpd <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">∨</span> NextPropagate <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">∨</span> NextRecvCap <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted">"<span class="entity">Next</span>"</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Next</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> Next' <span class="main">(</span>shd <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">(</span>shd <span class="main">(</span>stl <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">FullSpec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span> <span class="main">::</span> finite<span class="main">,</span> <span class="tfree">'t</span> <span class="main">::</span> order<span class="main">,</span> <span class="tfree">'loc</span><span class="main">)</span> computation <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">FullSpec</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span>holds InitConfig <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∧</span> alw Next <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Combined-NextPerformOpD"><span class="command">lemma</span></span> NextPerformOpD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"NextPerformOp' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="free">Δneg</span> <span class="free">Δmint_msg</span> <span class="free">Δmint_self</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"cri.next_performop' <span class="main">(</span>exchange_config <span class="free">c0</span><span class="main">)</span> <span class="main">(</span>exchange_config <span class="free">c1</span><span class="main">)</span> <span class="free">p</span> <span class="free">Δneg</span> <span class="free">Δmint_msg</span> <span class="free">Δmint_self</span>"</span></span>
    <span class="quoted"><span class="quoted">"unchanged prop_config <span class="free">c0</span> <span class="free">c1</span>"</span></span>
    <span class="quoted"><span class="quoted">"unchanged init <span class="free">c0</span> <span class="free">c1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> NextPerformOp'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1" id="Combined-NextSendUpdD"><span class="command">lemma</span></span> NextSendUpdD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"NextSendUpd' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="free">tt</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"cri.next_sendupd' <span class="main">(</span>exchange_config <span class="free">c0</span><span class="main">)</span> <span class="main">(</span>exchange_config <span class="free">c1</span><span class="main">)</span> <span class="free">p</span> <span class="free">tt</span>"</span></span>
    <span class="quoted"><span class="quoted">"unchanged prop_config <span class="free">c0</span> <span class="free">c1</span>"</span></span>
    <span class="quoted"><span class="quoted">"unchanged init <span class="free">c0</span> <span class="free">c1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> NextSendUpd'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1" id="Combined-NextRecvUpdD"><span class="command">lemma</span></span> NextRecvUpdD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"NextRecvUpd' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"init <span class="free">c0</span> <span class="free">q</span>"</span></span>
    <span class="quoted"><span class="quoted">"cri.next_recvupd' <span class="main">(</span>exchange_config <span class="free">c0</span><span class="main">)</span> <span class="main">(</span>exchange_config <span class="free">c1</span><span class="main">)</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
    <span class="quoted"><span class="quoted">"unchanged init <span class="free">c0</span> <span class="free">c1</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">p'</span><span class="main">.</span> prop_config <span class="free">c1</span> <span class="bound">p'</span> <span class="main">=</span>
         <span class="main">(</span><span class="keyword1">if</span> <span class="bound">p'</span> <span class="main">=</span> <span class="free">q</span>
          <span class="keyword1">then</span> cm_all <span class="main">(</span>prop_config <span class="free">c0</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span>hd <span class="main">(</span>c_msg <span class="main">(</span>exchange_config <span class="free">c0</span><span class="main">)</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span>
          <span class="keyword1">else</span> prop_config <span class="free">c0</span> <span class="bound">p'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> NextRecvUpd'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1" id="Combined-NextPropagateD"><span class="command">lemma</span></span> NextPropagateD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"NextPropagate' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"unchanged exchange_config <span class="free">c0</span> <span class="free">c1</span>"</span></span>
    <span class="quoted"><span class="quoted">"init <span class="free">c1</span> <span class="main">=</span> <span class="main">(</span>init <span class="free">c0</span><span class="main">)</span><span class="main">(</span><span class="free">p</span> <span class="main">:=</span> True<span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">p'</span><span class="main">.</span> Some <span class="main">(</span>prop_config <span class="free">c1</span> <span class="bound">p'</span><span class="main">)</span> <span class="main">=</span>
         <span class="main">(</span><span class="keyword1">if</span> <span class="bound">p'</span> <span class="main">=</span> <span class="free">p</span>
          <span class="keyword1">then</span> propagate_all <span class="main">(</span>prop_config <span class="free">c0</span> <span class="bound">p'</span><span class="main">)</span>
          <span class="keyword1">else</span> Some <span class="main">(</span>prop_config <span class="free">c0</span> <span class="bound">p'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> NextPropagate'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1" id="Combined-NextRecvCapD"><span class="command">lemma</span></span> NextRecvCapD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"NextRecvCap' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"cri.next_recvcap' <span class="main">(</span>exchange_config <span class="free">c0</span><span class="main">)</span> <span class="main">(</span>exchange_config <span class="free">c1</span><span class="main">)</span> <span class="free">p</span> <span class="free">t</span>"</span></span>
    <span class="quoted"><span class="quoted">"unchanged prop_config <span class="free">c0</span> <span class="free">c1</span>"</span></span>
    <span class="quoted"><span class="quoted">"unchanged init <span class="free">c0</span> <span class="free">c1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> NextRecvCap'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Auxiliary Lemmas›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Auxiliary Lemmas for CM Conversion›</span></span>

<span class="keyword1" id="Combined-apply_cm_is_cm"><span class="command">lemma</span></span> apply_cm_is_cm<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="bound">t'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c</span> <span class="free">loc</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">t'</span> <span class="main">≤</span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">n</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> next_change_multiplicity' <span class="free">c</span> <span class="main">(</span>apply_cm <span class="free">c</span> <span class="free">loc</span> <span class="free">t</span> <span class="free">n</span><span class="main">)</span> <span class="free">loc</span> <span class="free">t</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next_change_multiplicity'_def apply_cm_def
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Propagate.configuration.equality<span class="main">)</span>

<span class="keyword1" id="Combined-update_zmultiset_commute"><span class="command">lemma</span></span> update_zmultiset_commute<span class="main">:</span>
  <span class="quoted"><span class="quoted">"update_zmultiset <span class="main">(</span>update_zmultiset <span class="free">M</span> <span class="free">t'</span> <span class="free">n'</span><span class="main">)</span> <span class="free">t</span> <span class="free">n</span> <span class="main">=</span> update_zmultiset <span class="main">(</span>update_zmultiset <span class="free">M</span> <span class="free">t</span> <span class="free">n</span><span class="main">)</span> <span class="free">t'</span> <span class="free">n'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> equiv_zmset_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1" id="Combined-apply_cm_commute"><span class="command">lemma</span></span> apply_cm_commute<span class="main">:</span> <span class="quoted"><span class="quoted">"apply_cm <span class="main">(</span>apply_cm <span class="free">c</span> <span class="free">loc</span> <span class="free">t</span> <span class="free">n</span><span class="main">)</span> <span class="free">loc'</span> <span class="free">t'</span> <span class="free">n'</span> <span class="main">=</span> apply_cm <span class="main">(</span>apply_cm <span class="free">c</span> <span class="free">loc'</span> <span class="free">t'</span> <span class="free">n'</span><span class="main">)</span> <span class="free">loc</span> <span class="free">t</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> apply_cm_def Let_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Propagate.configuration.equality <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> update_zmultiset_commute<span class="main">)</span>

<span class="keyword1" id="Combined-comp_fun_commute_apply_cm"><span class="command">lemma</span></span> comp_fun_commute_apply_cm<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"comp_fun_commute <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">loc</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="bound">c</span><span class="main">.</span> apply_cm <span class="bound">c</span> <span class="bound">loc</span> <span class="bound">t</span> <span class="main">(</span><span class="free">f</span> <span class="bound">loc</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Propagate.configuration.equality <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> update_zmultiset_commute comp_fun_commute_def o_def apply_cm_commute<span class="main">)</span>

<span class="keyword1" id="Combined-ex_cm_imp_conds"><span class="command">lemma</span></span> ex_cm_imp_conds<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">c'</span><span class="main">.</span> next_change_multiplicity' <span class="free">c</span> <span class="bound">c'</span> <span class="free">loc</span> <span class="free">t</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="bound">t'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c</span> <span class="free">loc</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">t'</span> <span class="main">≤</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next_change_multiplicity'_def<span class="main">)</span>

<span class="keyword1" id="Combined-the_cm_eq_apply_cm"><span class="command">lemma</span></span> the_cm_eq_apply_cm<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">c'</span><span class="main">.</span> next_change_multiplicity' <span class="free">c</span> <span class="bound">c'</span> <span class="free">loc</span> <span class="free">t</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"the_cm <span class="free">c</span> <span class="free">loc</span> <span class="free">t</span> <span class="free">n</span> <span class="main">=</span> apply_cm <span class="free">c</span> <span class="free">loc</span> <span class="free">t</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> cond<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="bound">t'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c</span> <span class="free">loc</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">t'</span> <span class="main">≤</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ex_cm_imp_conds <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> the_cm_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> the1_equality<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> next_change_multiplicity'_unique<span class="main"><span class="main">[</span></span><span class="operator">OF</span> cond<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">,</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> apply_cm_def next_change_multiplicity'_def
    <span class="keyword1"><span class="command">using</span></span> cond <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Propagate.configuration.equality<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Combined-apply_cm_preserves_cond"><span class="command">lemma</span></span> apply_cm_preserves_cond<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">loc</span><span class="main">,</span><span class="bound">t</span><span class="main">)</span><span class="main">∈</span>set_zmset <span class="free">Δ</span><span class="main">.</span> <span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="bound">t'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c0</span> <span class="bound">loc</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">t'</span> <span class="main">≤</span> <span class="bound">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">loc</span><span class="main">,</span><span class="bound">t</span><span class="main">)</span><span class="main">∈</span>set_zmset <span class="free">Δ</span><span class="main">.</span> <span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="bound">t'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="main">(</span>apply_cm <span class="free">c0</span> <span class="free">loc'</span> <span class="free">t''</span> <span class="free">n</span><span class="main">)</span> <span class="bound">loc</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">t'</span> <span class="main">≤</span> <span class="bound">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> apply_cm_def<span class="main">)</span>

<span class="keyword1" id="Combined-cm_all_eq_cm_all'"><span class="command">lemma</span></span> cm_all_eq_cm_all'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">loc</span><span class="main">,</span><span class="bound">t</span><span class="main">)</span><span class="main">∈</span>set_zmset <span class="free">Δ</span><span class="main">.</span> <span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="bound">t'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c0</span> <span class="bound">loc</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">t'</span> <span class="main">≤</span> <span class="bound">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"cm_all <span class="free">c0</span> <span class="free">Δ</span> <span class="main">=</span> cm_all' <span class="free">c0</span> <span class="free">Δ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> cm_all_def cm_all'_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fold_closed_eq<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> B <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">{</span></span><span class="bound"><span class="bound">c</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">∀</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">loc</span></span><span class="main"><span class="main">,</span></span><span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">∈</span></span>set_zmset <span class="free"><span class="free">Δ</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">∃</span></span><span class="bound"><span class="bound">t'</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">t'</span></span> <span class="keyword1"><span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span></span> frontier <span class="main"><span class="main">(</span></span>c_imp <span class="bound"><span class="bound">c</span></span> <span class="bound"><span class="bound">loc</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">∧</span></span> <span class="bound"><span class="bound">t'</span></span> <span class="main"><span class="main">≤</span></span> <span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">}</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> a Δ
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> the_cm_eq_apply_cm<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ex1_implies_ex<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> next_change_multiplicity'_unique<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> a Δ
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> apply_cm_preserves_cond<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Combined-cm_eq_the_cm"><span class="command">lemma</span></span> cm_eq_the_cm<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"next_change_multiplicity' <span class="free">c</span> <span class="free">c'</span> <span class="free">loc</span> <span class="free">t</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"the_cm <span class="free">c</span> <span class="free">loc</span> <span class="free">t</span> <span class="free">n</span> <span class="main">=</span> <span class="free">c'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> cond<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c</span> <span class="free">loc</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">u</span> <span class="main">≤</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> next_change_multiplicity'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> next_change_multiplicity'_unique<span class="main">[</span><span class="operator">OF</span> cond<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> assms the_cm_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Combined-zcount_ps_apply_cm"><span class="command">lemma</span></span> zcount_ps_apply_cm<span class="main">:</span>
  <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>c_pts <span class="main">(</span>apply_cm <span class="free">c</span> <span class="free">loc</span> <span class="free">t</span> <span class="free">n</span><span class="main">)</span> <span class="free">loc'</span><span class="main">)</span> <span class="free">t'</span> <span class="main">=</span> zcount <span class="main">(</span>c_pts <span class="free">c</span> <span class="free">loc'</span><span class="main">)</span> <span class="free">t'</span> <span class="main">+</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">loc</span> <span class="main">=</span> <span class="free">loc'</span> <span class="main">∧</span> <span class="free">t</span> <span class="main">=</span> <span class="free">t'</span> <span class="keyword1">then</span> <span class="free">n</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> apply_cm_def zcount_update_zmultiset<span class="main">)</span>

<span class="keyword1" id="Combined-zcount_pointstamps_update"><span class="command">lemma</span></span> zcount_pointstamps_update<span class="main">:</span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>c_pts <span class="main">(</span><span class="free">c</span><span class="main">⦇</span>c_pts<span class="main">:=</span><span class="free">M</span><span class="main">⦈</span><span class="main">)</span> <span class="free">loc</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> zcount <span class="main">(</span><span class="free">M</span> <span class="free">loc</span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Combined-nop"><span class="command">lemma</span></span> nop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">loc1</span> <span class="main">≠</span> <span class="free">loc2</span> <span class="main">∨</span> <span class="free">t1</span> <span class="main">≠</span> <span class="free">t2</span> <span class="main">⟶</span>
    zcount <span class="main">(</span>c_pts <span class="main">(</span>apply_cm <span class="free">c</span> <span class="free">loc2</span> <span class="free">t2</span> <span class="main">(</span>zcount <span class="free">Δ</span> <span class="main">(</span><span class="free">loc2</span><span class="main">,</span> <span class="free">t2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">loc1</span><span class="main">)</span> <span class="free">t1</span> <span class="main">=</span>
    zcount <span class="main">(</span>c_pts <span class="free">c</span> <span class="free">loc1</span><span class="main">)</span> <span class="free">t1</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> apply_cm_def<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> zcount_update_zmultiset
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zcount_update_zmultiset<span class="main">)</span>

<span class="keyword1" id="Combined-fold_nop"><span class="command">lemma</span></span> fold_nop<span class="main">:</span>
  <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>c_pts <span class="main">(</span>Finite_Set.fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">loc'</span><span class="main">,</span> <span class="bound">t'</span><span class="main">)</span> <span class="bound">c</span><span class="main">.</span> apply_cm <span class="bound">c</span> <span class="bound">loc'</span> <span class="bound">t'</span> <span class="main">(</span>zcount <span class="free">Δ'</span> <span class="main">(</span><span class="bound">loc'</span><span class="main">,</span> <span class="bound">t'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">c</span>
                          <span class="main">(</span>set_zmset <span class="free">Δ</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="free">loc</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="free">loc</span><span class="main">)</span> <span class="free">t</span>
  <span class="main">=</span> zcount <span class="main">(</span>c_pts <span class="free">c</span> <span class="free">loc</span><span class="main">)</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>set_zmset <span class="free">Δ</span><span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="free">loc</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> finite_set_zmset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"set_zmset <span class="free">Δ</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="free">loc</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Δ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> empty
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> fold_empty <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">loc'</span><span class="main">,</span> <span class="bound">t'</span><span class="main">)</span> <span class="bound">c</span><span class="main">.</span> apply_cm <span class="bound">c</span> <span class="bound">loc'</span> <span class="bound">t'</span> <span class="main">(</span>zcount <span class="free">Δ'</span> <span class="main">(</span><span class="bound">loc'</span><span class="main">,</span><span class="bound">t'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">loc'</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword">where</span></span> x_pair<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">loc'</span><span class="main">,</span> <span class="skolem">t'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> surj_pair<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> insert <span class="keyword1"><span class="command">have</span></span> nonmember<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="main">(</span><span class="free">loc</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> finite_s<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="skolem">F</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> commute<span class="main">:</span> <span class="quoted"><span class="quoted">"comp_fun_commute <span class="var">?f</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comp_fun_commute_def comp_def apply_cm_commute<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> finite_s <span class="keyword1"><span class="command">have</span></span> step1<span class="main">:</span>
      <span class="quoted"><span class="quoted">"Finite_Set.fold <span class="var">?f</span> <span class="free">c</span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span> <span class="main">=</span> <span class="var">?f</span> <span class="skolem">x</span> <span class="main">(</span>Finite_Set.fold <span class="var">?f</span> <span class="free">c</span> <span class="skolem">F</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> comp_fun_commute.fold_insert insert.hyps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> insert.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> nonmember <span class="keyword1"><span class="command">have</span></span> step2<span class="main">:</span>
      <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>c_pts <span class="main">(</span><span class="var">?f</span> <span class="skolem">x</span> <span class="main">(</span>Finite_Set.fold <span class="var">?f</span> <span class="free">c</span> <span class="skolem">F</span><span class="main">)</span><span class="main">)</span> <span class="free">loc</span><span class="main">)</span> <span class="free">t</span>
          <span class="main">=</span> zcount <span class="main">(</span>c_pts <span class="main">(</span>Finite_Set.fold <span class="var">?f</span> <span class="free">c</span> <span class="skolem">F</span><span class="main">)</span> <span class="free">loc</span><span class="main">)</span> <span class="free">t</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> x_pair
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> case_prod_conv nop<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> step1 <span class="keyword2"><span class="keyword">and</span></span> x_pair <span class="keyword1"><span class="command">have</span></span> final<span class="main">:</span>
      <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>c_pts <span class="main">(</span>Finite_Set.fold <span class="var">?f</span> <span class="free">c</span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span><span class="main">)</span> <span class="free">loc</span><span class="main">)</span> <span class="free">t</span>
          <span class="main">=</span> zcount <span class="main">(</span>c_pts <span class="main">(</span>Finite_Set.fold <span class="var">?f</span> <span class="free">c</span> <span class="skolem">F</span><span class="main">)</span> <span class="free">loc</span><span class="main">)</span> <span class="free">t</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> insert<span class="main">(</span>2<span class="main">,</span>4<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Δ2</span></span> <span class="keyword2"><span class="keyword">where</span></span> Δ2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Δ2</span> <span class="main">=</span> filter_zmset <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span><span class="main">≠</span><span class="skolem">x</span><span class="main">)</span> <span class="skolem">Δ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span> <span class="main">=</span> set_zmset <span class="skolem">Δ2</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="free">loc</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> Δ2 <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="keyword1">∉#<span class="hidden">⇩</span><sub>z</sub></span> <span class="skolem">Δ2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_in_iff_zmset<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> insert<span class="main">(</span>4<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> nonmember <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="skolem">Δ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">from</span></span> Δ2 ** <span class="keyword1"><span class="command">have</span></span> ***<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="skolem">Δ</span> <span class="main">⟷</span> <span class="main">(</span><span class="bound">y</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="skolem">Δ2</span> <span class="main">∨</span> <span class="bound">y</span> <span class="main">=</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> count_filter_zmset zcount_ne_zero_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> *** <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span> <span class="main">∈</span> set_zmset <span class="skolem">Δ</span> <span class="main">=</span> <span class="main">(</span><span class="bound">y</span> <span class="main">∈</span> <span class="main">(</span>set_zmset <span class="skolem">Δ2</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_zmset <span class="skolem">Δ</span> <span class="main">=</span> set_zmset <span class="skolem">Δ2</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_eq_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> insert<span class="main">(</span>2<span class="main">,</span>3<span class="main">,</span>4<span class="main">)</span> *  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Diff_insert Diff_insert2 Diff_insert_absorb Un_empty_right Un_insert_right<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">with</span></span> final insert <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Combined-zcount_pointstamps_cm_all'"><span class="command">lemma</span></span> zcount_pointstamps_cm_all'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>c_pts <span class="main">(</span>cm_all' <span class="free">c</span> <span class="free">Δ</span><span class="main">)</span> <span class="free">loc</span><span class="main">)</span> <span class="free">x</span>
 <span class="main">=</span> zcount <span class="main">(</span>c_pts <span class="free">c</span> <span class="free">loc</span><span class="main">)</span> <span class="free">x</span> <span class="main">+</span> zcount <span class="free">Δ</span> <span class="main">(</span><span class="free">loc</span><span class="main">,</span><span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">loc'</span><span class="main">,</span> <span class="bound">t'</span><span class="main">)</span> <span class="bound">c</span><span class="main">.</span> apply_cm <span class="bound">c</span> <span class="bound">loc'</span> <span class="bound">t'</span> <span class="main">(</span>zcount <span class="free">Δ</span> <span class="main">(</span><span class="bound">loc'</span><span class="main">,</span><span class="bound">t'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"zcount <span class="free">Δ</span> <span class="main">(</span><span class="free">loc</span><span class="main">,</span><span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> case_nonmember<span class="main">:</span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> set_zmsetΔ<span class="main">:</span> <span class="quoted"><span class="quoted">"set_zmset <span class="free">Δ</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="free">loc</span><span class="main">,</span> <span class="free">x</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> set_zmset <span class="free">Δ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> zcount_eq_zero_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>c_pts <span class="main">(</span>cm_all' <span class="free">c</span> <span class="free">Δ</span><span class="main">)</span> <span class="free">loc</span><span class="main">)</span> <span class="free">x</span>
             <span class="main">=</span> zcount <span class="main">(</span>c_pts <span class="free">c</span> <span class="free">loc</span><span class="main">)</span> <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> cm_all'_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> set_zmsetΔ<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fold_nop<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">with</span></span> case_nonmember <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> case_member<span class="main">:</span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> fold_rec<span class="main">:</span> <span class="quoted"><span class="quoted">"Finite_Set.fold <span class="var">?f</span> <span class="free">c</span> <span class="main">(</span>set_zmset <span class="free">Δ</span><span class="main">)</span>
             <span class="main">=</span> <span class="var">?f</span> <span class="main">(</span><span class="free">loc</span><span class="main">,</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>Finite_Set.fold <span class="var">?f</span> <span class="free">c</span> <span class="main">(</span>set_zmset <span class="free">Δ</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="free">loc</span><span class="main">,</span> <span class="free">x</span><span class="main">)</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">loc</span><span class="main">,</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">Δ</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> case_member zcount_inI<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> comp_fun_commute_apply_cm
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> comp_fun_commute.fold_rec<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>c_pts <span class="main">(</span>Finite_Set.fold <span class="var">?f</span> <span class="free">c</span> <span class="main">(</span>set_zmset <span class="free">Δ</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="free">loc</span><span class="main">,</span> <span class="free">x</span><span class="main">)</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="free">loc</span><span class="main">)</span> <span class="free">x</span>
          <span class="main">=</span> zcount <span class="main">(</span>c_pts <span class="free">c</span> <span class="free">loc</span><span class="main">)</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fold_nop<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>c_pts <span class="main">(</span>Finite_Set.fold <span class="var">?f</span> <span class="free">c</span> <span class="main">(</span>set_zmset <span class="free">Δ</span><span class="main">)</span><span class="main">)</span> <span class="free">loc</span><span class="main">)</span> <span class="free">x</span>
             <span class="main">=</span> zcount <span class="main">(</span>c_pts <span class="main">(</span><span class="var">?f</span> <span class="main">(</span><span class="free">loc</span><span class="main">,</span> <span class="free">x</span><span class="main">)</span> <span class="free">c</span><span class="main">)</span> <span class="free">loc</span><span class="main">)</span> <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> fold_nop fold_rec <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zcount_ps_apply_cm<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zcount_ps_apply_cm cm_all'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Combined-implications_apply_cm"><span class="command">lemma</span></span> implications_apply_cm<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"c_imp <span class="main">(</span>apply_cm <span class="free">c</span> <span class="free">loc</span> <span class="free">t</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> c_imp <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> apply_cm_def<span class="main">)</span>

<span class="keyword1" id="Combined-implications_cm_all"><span class="command">lemma</span></span> implications_cm_all<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"c_imp <span class="main">(</span>cm_all' <span class="free">c</span> <span class="free">Δ</span><span class="main">)</span> <span class="main">=</span> c_imp <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> cm_all'_def Let_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fold_invar<span class="main"><span class="main">[</span></span><span class="operator">OF</span> finite_set_zmset<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Combined-lift_cm_inv_cm_all'"><span class="command">lemma</span></span> lift_cm_inv_cm_all'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">c0</span> <span class="bound">c1</span> <span class="bound">loc</span> <span class="bound">t</span> <span class="bound">n</span><span class="main">.</span> <span class="free">P</span> <span class="bound">c0</span> <span class="main">⟹</span> next_change_multiplicity' <span class="bound">c0</span> <span class="bound">c1</span> <span class="bound">loc</span> <span class="bound">t</span> <span class="bound">n</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">c1</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">loc</span><span class="main">,</span><span class="bound">t</span><span class="main">)</span><span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span><span class="free">Δ</span><span class="main">.</span> <span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="bound">t'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c0</span> <span class="bound">loc</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">t'</span> <span class="main">≤</span> <span class="bound">t</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">c0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>cm_all' <span class="free">c0</span> <span class="free">Δ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?cond_invar</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">c</span><span class="main">.</span> <span class="main">∀</span><span class="main">(</span><span class="bound">loc</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span><span class="free">Δ</span><span class="main">.</span> <span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="bound">t'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="bound">c</span> <span class="bound">loc</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">t'</span> <span class="main">≤</span> <span class="bound">t</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?invar</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">c</span><span class="main">.</span> <span class="var">?cond_invar</span> <span class="bound">c</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">c</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> cm_all'_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjunct2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fold_invar<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> finite_set_zmset<span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">of</span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?invar</span></span></span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> apply_cm_is_cm<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Combined-lift_cm_inv_cm_all"><span class="command">lemma</span></span> lift_cm_inv_cm_all<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">c0</span> <span class="bound">c1</span> <span class="bound">loc</span> <span class="bound">t</span> <span class="bound">n</span><span class="main">.</span> <span class="free">P</span> <span class="bound">c0</span> <span class="main">⟹</span> next_change_multiplicity' <span class="bound">c0</span> <span class="bound">c1</span> <span class="bound">loc</span> <span class="bound">t</span> <span class="bound">n</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">c1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">loc</span><span class="main">,</span><span class="bound">t</span><span class="main">)</span><span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span><span class="free">Δ</span><span class="main">.</span> <span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="bound">t'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c0</span> <span class="bound">loc</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">t'</span> <span class="main">≤</span> <span class="bound">t</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">c0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>cm_all <span class="free">c0</span> <span class="free">Δ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> cm_all_eq_cm_all'<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> lift_cm_inv_cm_all'<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">(* Finds a minimal timestamp - location pair in a non-empty zmset (e.g. in c_work) *)</span>
<span class="keyword1" id="Combined-obtain_min_worklist"><span class="command">lemma</span></span> obtain_min_worklist<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span> <span class="main">(</span><span class="free">loc'</span><span class="main">::</span><span class="main">(</span><span class="main">_</span> <span class="main">::</span> finite<span class="main">)</span><span class="main">)</span><span class="main">::</span><span class="main">(</span><span class="main">(</span><span class="tfree">'t</span> <span class="main">::</span> order<span class="main">)</span> zmultiset<span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">loc</span> <span class="free">t</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">a</span> <span class="free">loc</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t'</span> <span class="bound">loc'</span><span class="main">.</span> <span class="bound">t'</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">a</span> <span class="bound">loc'</span> <span class="main">⟶</span> <span class="main">¬</span> <span class="bound">t'</span> <span class="main">&lt;</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">atomize_elim</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> minimal_antichain <span class="main">(</span><span class="main">⋃</span><span class="bound">loc'</span><span class="main">.</span> set_zmset <span class="main">(</span><span class="free">a</span> <span class="bound">loc'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="keyword2"><span class="keyword">where</span></span> x'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">loc'</span><span class="main">.</span> set_zmset <span class="main">(</span><span class="free">a</span> <span class="bound">loc'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pos_zcount_in_zmset <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite  <span class="main">(</span><span class="main">⋃</span><span class="bound">loc'</span><span class="main">.</span> set_zmset <span class="main">(</span><span class="free">a</span> <span class="bound">loc'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> finite_UNIV <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> x' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> f
    <span class="keyword1"><span class="command">using</span></span> minimal_antichain_nonempty <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> <span class="skolem">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">s</span><span class="main">∈</span><span class="skolem">f</span><span class="main">.</span> <span class="main">¬</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ex_min_if_finite f minimal_antichain_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">with</span></span> f <span class="keyword1"><span class="command">have</span></span> thesis1<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t'</span> <span class="bound">loc'</span><span class="main">.</span> <span class="bound">t'</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">a</span> <span class="bound">loc'</span> <span class="main">⟶</span> <span class="main">¬</span> <span class="bound">t'</span> <span class="main">&lt;</span> <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">loc</span><span class="main">.</span> <span class="skolem">t</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">a</span> <span class="bound">loc</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> minimal_antichain_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t</span> <span class="bound">loc</span><span class="main">.</span> <span class="bound">t</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">a</span> <span class="bound">loc</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t'</span> <span class="bound">loc'</span><span class="main">.</span> <span class="bound">t'</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">a</span> <span class="bound">loc'</span> <span class="main">⟶</span> <span class="main">¬</span> <span class="bound">t'</span> <span class="main">&lt;</span> <span class="bound">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Combined-propagate_pointstamps_eq"><span class="command">lemma</span></span> propagate_pointstamps_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"c_work <span class="free">c</span> <span class="free">loc</span> <span class="main">≠</span> <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"c_pts <span class="free">c</span> <span class="main">=</span> c_pts <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">c'</span><span class="main">.</span> <span class="main">∃</span><span class="bound">loc</span> <span class="bound">t</span><span class="main">.</span> next_propagate' <span class="free">c</span> <span class="bound">c'</span> <span class="bound">loc</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">loc'</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> loc't<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> c_work <span class="free">c</span> <span class="skolem">loc'</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t'</span> <span class="bound">loc'</span><span class="main">.</span> <span class="bound">t'</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> c_work <span class="free">c</span> <span class="bound">loc'</span> <span class="main">⟶</span> <span class="main">¬</span> <span class="bound">t'</span> <span class="main">&lt;</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> obtain_min_worklist<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"c_work <span class="free"><span class="free">c</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">loc</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?imps</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">locX</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">locX</span> <span class="main">=</span> <span class="skolem">loc'</span> <span class="keyword1">then</span> c_imp <span class="free">c</span> <span class="bound">locX</span> <span class="main">+</span> <span class="main">{#</span><span class="bound">t'</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> c_work <span class="free">c</span> <span class="bound">locX</span><span class="main">.</span> <span class="bound">t'</span> <span class="main">=</span> <span class="skolem">t</span><span class="main">#}</span>
                                     <span class="keyword1">else</span> c_imp <span class="free">c</span> <span class="bound">locX</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?wl</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">locX</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">locX</span> <span class="main">=</span> <span class="skolem">loc'</span> <span class="keyword1">then</span> <span class="main">{#</span><span class="bound">t'</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> c_work <span class="free">c</span> <span class="bound">locX</span><span class="main">.</span> <span class="bound">t'</span> <span class="main">≠</span> <span class="skolem">t</span><span class="main">#}</span>
                    <span class="keyword1">else</span> c_work <span class="free">c</span> <span class="bound">locX</span>
                           <span class="main">+</span> after_summary
                               <span class="main">(</span>frontier_changes <span class="main">(</span><span class="var">?imps</span> <span class="skolem">loc'</span><span class="main">)</span> <span class="main">(</span>c_imp <span class="free">c</span> <span class="skolem">loc'</span><span class="main">)</span><span class="main">)</span>
                               <span class="main">(</span><span class="free">summary</span> <span class="skolem">loc'</span> <span class="bound">locX</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?c</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">c</span><span class="main">⦇</span>c_imp <span class="main">:=</span> <span class="var">?imps</span><span class="main">,</span> c_work <span class="main">:=</span> <span class="var">?wl</span><span class="main">⦈</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> loc't assms <span class="keyword1"><span class="command">have</span></span> propagate<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">c'</span><span class="main">.</span> <span class="main">∃</span><span class="bound">loc</span> <span class="bound">t</span><span class="main">.</span> next_propagate' <span class="free">c</span> <span class="bound">c'</span> <span class="bound">loc</span> <span class="bound">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?c</span></span></span></span></span></span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">loc'</span></span></span></span></span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">t</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next_propagate'_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Propagate.configuration.equality<span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c'</span> <span class="skolem">loc</span> <span class="skolem">t</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"next_propagate' <span class="free">c</span> <span class="skolem">c'</span> <span class="skolem">loc</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"c_pts <span class="free">c</span> <span class="main">=</span> c_pts <span class="skolem">c'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next_propagate'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">with</span></span> propagate <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> verit_sko_ex'<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Combined-propagate_all_imp_InvGlobPointstampsEq"><span class="command">lemma</span></span> propagate_all_imp_InvGlobPointstampsEq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Some <span class="free">c1</span> <span class="main">=</span> propagate_all <span class="free">c0</span> <span class="main">⟹</span> c_pts <span class="free">c0</span> <span class="main">=</span> c_pts <span class="free">c1</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> propagate_all_def
  <span class="keyword1"><span class="command">using</span></span> while_option_rule<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> c_pts <span class="free">c0</span> <span class="main">=</span> c_pts <span class="bound">c</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> b<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> <span class="main">∃</span><span class="bound">loc</span><span class="main">.</span> c_work <span class="bound">c</span> <span class="bound">loc</span> <span class="main">≠</span> <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> c<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> <span class="keyword1">SOME</span> <span class="bound">c'</span><span class="main">.</span> <span class="main">∃</span><span class="bound">loc</span> <span class="bound">t</span><span class="main">.</span> next_propagate' <span class="bound">c</span> <span class="bound">c'</span> <span class="bound">loc</span> <span class="bound">t</span><span class="main">)</span>"</span></span><span class="main">]</span>
    propagate_pointstamps_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="Combined-exists_next_propagate'"><span class="command">lemma</span></span> exists_next_propagate'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"c_work <span class="free">c</span> <span class="free">loc</span> <span class="main">≠</span> <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">c'</span> <span class="bound">loc</span> <span class="bound">t</span><span class="main">.</span> next_propagate' <span class="free">c</span> <span class="bound">c'</span> <span class="bound">loc</span> <span class="bound">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">loc'</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> loc't<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> c_work <span class="free">c</span> <span class="skolem">loc'</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t'</span> <span class="bound">loc'</span><span class="main">.</span> <span class="bound">t'</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> c_work <span class="free">c</span> <span class="bound">loc'</span> <span class="main">⟶</span> <span class="main">¬</span> <span class="bound">t'</span> <span class="main">&lt;</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> obtain_min_worklist<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?imps</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">locX</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">locX</span> <span class="main">=</span> <span class="skolem">loc'</span> <span class="keyword1">then</span> c_imp <span class="free">c</span> <span class="bound">locX</span> <span class="main">+</span> <span class="main">{#</span><span class="bound">t'</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> c_work <span class="free">c</span> <span class="bound">locX</span><span class="main">.</span> <span class="bound">t'</span> <span class="main">=</span> <span class="skolem">t</span><span class="main">#}</span>
                                     <span class="keyword1">else</span> c_imp <span class="free">c</span> <span class="bound">locX</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?wl</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">locX</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">locX</span> <span class="main">=</span> <span class="skolem">loc'</span> <span class="keyword1">then</span> <span class="main">{#</span><span class="bound">t'</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> c_work <span class="free">c</span> <span class="bound">locX</span><span class="main">.</span> <span class="bound">t'</span> <span class="main">≠</span> <span class="skolem">t</span><span class="main">#}</span>
                    <span class="keyword1">else</span> c_work <span class="free">c</span> <span class="bound">locX</span>
                           <span class="main">+</span> after_summary
                               <span class="main">(</span>frontier_changes <span class="main">(</span><span class="var">?imps</span> <span class="skolem">loc'</span><span class="main">)</span> <span class="main">(</span>c_imp <span class="free">c</span> <span class="skolem">loc'</span><span class="main">)</span><span class="main">)</span>
                               <span class="main">(</span><span class="free">summary</span> <span class="skolem">loc'</span> <span class="bound">locX</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?c</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">c</span><span class="main">⦇</span>c_imp <span class="main">:=</span> <span class="var">?imps</span><span class="main">,</span> c_work <span class="main">:=</span> <span class="var">?wl</span><span class="main">⦈</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> loc't assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?c</span></span></span></span></span></span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">loc'</span></span></span></span></span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">t</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next_propagate'_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Propagate.configuration.equality<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Combined-lift_propagate_inv_propagate_all"><span class="command">lemma</span></span> lift_propagate_inv_propagate_all<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">c0</span> <span class="bound">c1</span> <span class="bound">loc</span> <span class="bound">t</span><span class="main">.</span> <span class="free">P</span> <span class="bound">c0</span> <span class="main">⟹</span> next_propagate' <span class="bound">c0</span> <span class="bound">c1</span> <span class="bound">loc</span> <span class="bound">t</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">c1</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"propagate_all <span class="free">c0</span> <span class="main">=</span> Some <span class="free">c1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">c1</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> while_option_rule<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span> <span class="main"><span class="main">_</span></span><span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> propagate_all_def<span class="main"><span class="main">]</span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> c loc
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> exists_next_propagate'<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> verit_sko_ex'<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Exchange is a Subsystem of Tracker›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Steps in the Tracker are valid steps in the Exchange protocol.›</span></span>
<span class="keyword1" id="Combined-next_imp_exchange_next"><span class="command">lemma</span></span> next_imp_exchange_next<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Next' <span class="free">c0</span> <span class="free">c1</span> <span class="main">⟹</span> cri.next' <span class="main">(</span>exchange_config <span class="free">c0</span><span class="main">)</span> <span class="main">(</span>exchange_config <span class="free">c1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Next'_def cri.next'_def NextPerformOp'_def NextRecvUpd'_def NextSendUpd'_def NextPropagate'_def NextRecvCap'_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Combined-alw_next_imp_exchange_next"><span class="command">lemma</span></span> alw_next_imp_exchange_next<span class="main">:</span> <span class="quoted"><span class="quoted">"alw Next <span class="free">s</span> <span class="main">⟹</span> alw cri.next <span class="main">(</span>smap exchange_config <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> alw.coinduct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> alwD next_imp_exchange_next<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Any Tracker trace is a valid Exchange trace›</span></span>
<span class="keyword1" id="Combined-spec_imp_exchange_spec"><span class="command">lemma</span></span> spec_imp_exchange_spec<span class="main">:</span> <span class="quoted"><span class="quoted">"FullSpec <span class="free">s</span> <span class="main">⟹</span> cri.spec <span class="main">(</span>smap exchange_config <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> cri.spec_def FullSpec_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> InitConfig_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> alw_next_imp_exchange_next<span class="main">)</span>

<span class="keyword1" id="Combined-lift_exchange_invariant"><span class="command">lemma</span></span> lift_exchange_invariant<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> cri.spec <span class="bound">s</span> <span class="main">⟹</span> alw <span class="main">(</span>holds <span class="free">P</span><span class="main">)</span> <span class="bound">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"FullSpec <span class="free">s</span> <span class="main">⟹</span> alw <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>exchange_config <span class="main">(</span>shd <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"FullSpec <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> spec_imp_exchange_spec<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> assms<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> alw_holds_smap_conv_comp<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Lifted Exchange invariants›</span></span>
<span class="keyword1"><span class="command">lemmas</span></span>
  exch_alw_InvCapsNonneg                 <span class="main">=</span> lift_exchange_invariant<span class="main">[</span><span class="operator">OF</span> cri.alw_InvCapsNonneg<span class="main">,</span> <span class="operator">unfolded</span> atomize_imp<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">folded</span> atomize_imp<span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span>
  exch_alw_InvRecordCount                <span class="main">=</span> lift_exchange_invariant<span class="main">[</span><span class="operator">OF</span> cri.alw_InvRecordCount<span class="main">,</span> <span class="operator">simplified</span> atomize_imp<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">folded</span> atomize_imp<span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span>
  exch_alw_InvRecordsNonneg              <span class="main">=</span> lift_exchange_invariant<span class="main">[</span><span class="operator">OF</span> cri.alw_InvRecordsNonneg<span class="main">,</span> <span class="operator">simplified</span> atomize_imp<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">folded</span> atomize_imp<span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span>
  exch_alw_InvGlobVacantImpRecordsVacant <span class="main">=</span> lift_exchange_invariant<span class="main">[</span><span class="operator">OF</span> cri.alw_InvGlobVacantImpRecordsVacant<span class="main">,</span> <span class="operator">simplified</span> atomize_imp<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">folded</span> atomize_imp<span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span>
  exch_alw_InvGlobNonposImpRecordsNonpos <span class="main">=</span> lift_exchange_invariant<span class="main">[</span><span class="operator">OF</span> cri.alw_InvGlobNonposImpRecordsNonpos<span class="main">,</span> <span class="operator">simplified</span> atomize_imp<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">folded</span> atomize_imp<span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span>
  exch_alw_InvJustifiedGII               <span class="main">=</span> lift_exchange_invariant<span class="main">[</span><span class="operator">OF</span> cri.alw_InvJustifiedGII<span class="main">,</span> <span class="operator">simplified</span> atomize_imp<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">folded</span> atomize_imp<span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span>
  exch_alw_InvJustifiedII                <span class="main">=</span> lift_exchange_invariant<span class="main">[</span><span class="operator">OF</span> cri.alw_InvJustifiedII<span class="main">,</span> <span class="operator">simplified</span> atomize_imp<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">folded</span> atomize_imp<span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span>
  exch_alw_InvGlobNonposEqVacant         <span class="main">=</span> lift_exchange_invariant<span class="main">[</span><span class="operator">OF</span> cri.alw_InvGlobNonposEqVacant<span class="main">,</span> <span class="operator">simplified</span> atomize_imp<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">folded</span> atomize_imp<span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span>
  exch_alw_InvMsgInGlob                  <span class="main">=</span> lift_exchange_invariant<span class="main">[</span><span class="operator">OF</span> cri.alw_InvMsgInGlob<span class="main">,</span> <span class="operator">simplified</span> atomize_imp<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">folded</span> atomize_imp<span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span>
  exch_alw_InvTempJustified              <span class="main">=</span> lift_exchange_invariant<span class="main">[</span><span class="operator">OF</span> cri.alw_InvTempJustified<span class="main">,</span> <span class="operator">simplified</span> atomize_imp<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">folded</span> atomize_imp<span class="main">]</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Definitions›</span></span>

<span class="comment1">(* First variant of global safe *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">safe_combined</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span><span class="main">::</span>finite<span class="main">,</span> <span class="tfree">'t</span><span class="main">::</span>order<span class="main">,</span> <span class="tfree">'loc</span><span class="main">)</span> configuration <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">safe_combined</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">loc1</span> <span class="bound">loc2</span> <span class="bound">t</span> <span class="bound">s</span> <span class="bound">p</span><span class="main">.</span>
        zcount <span class="main">(</span>cri.records <span class="main">(</span>exchange_config <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="bound">loc1</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">s</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> path_summary <span class="bound">loc1</span> <span class="bound">loc2</span> <span class="main">∧</span> init <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">p</span>
         <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="bound">t'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="main">(</span>prop_config <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">p</span><span class="main">)</span> <span class="bound">loc2</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">t'</span> <span class="main">≤</span> <span class="free">results_in</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span>"</span></span>

<span class="comment1">(* Second variant of global safe *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">safe_combined2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span><span class="main">::</span>finite<span class="main">,</span> <span class="tfree">'t</span><span class="main">::</span>order<span class="main">,</span> <span class="tfree">'loc</span><span class="main">)</span> configuration <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">safe_combined2</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">loc1</span> <span class="bound">loc2</span> <span class="bound">t</span> <span class="bound">s</span> <span class="bound">p1</span> <span class="bound">p2</span><span class="main">.</span>
        zcount <span class="main">(</span>c_caps <span class="main">(</span>exchange_config <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="bound">p1</span><span class="main">)</span> <span class="main">(</span><span class="bound">loc1</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">s</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> path_summary <span class="bound">loc1</span> <span class="bound">loc2</span> <span class="main">∧</span> init <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">p2</span>
         <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="bound">t'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="main">(</span>prop_config <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">p2</span><span class="main">)</span> <span class="bound">loc2</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">t'</span> <span class="main">≤</span> <span class="free">results_in</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">InvGlobPointstampsEq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span> <span class="main">::</span> finite<span class="main">,</span> <span class="tfree">'t</span> <span class="main">::</span> order<span class="main">,</span> <span class="tfree">'loc</span><span class="main">)</span> configuration <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">InvGlobPointstampsEq</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">(</span>
     <span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="bound">loc</span> <span class="bound">t</span><span class="main">.</span> zcount <span class="main">(</span>c_pts <span class="main">(</span>prop_config <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">p</span><span class="main">)</span> <span class="bound">loc</span><span class="main">)</span> <span class="bound">t</span>
                 <span class="main">=</span> zcount <span class="main">(</span>c_glob <span class="main">(</span>exchange_config <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="bound">loc</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Combined-safe_combined_implies_safe_combined2"><span class="command">lemma</span></span> safe_combined_implies_safe_combined2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cri.InvCapsNonneg <span class="main">(</span>exchange_config <span class="free">c</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"safe_combined <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"safe_combined2 <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> safe_combined2_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> loc1 loc2 t s p1 p2
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> safe_combined_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">loc1</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">t</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">s</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">loc2</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">p2</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cri.records_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> add_pos_nonneg<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> zcount_sum<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sum_pos<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> y <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">p1</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cri.InvCapsNonneg_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Propagate is a Subsystem of Tracker›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹CM Conditions›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">InvMsgCMConditions</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">InvMsgCMConditions</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="bound">q</span><span class="main">.</span>
    init <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">q</span> <span class="main">⟶</span> c_msg <span class="main">(</span>exchange_config <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="bound">p</span> <span class="bound">q</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟶</span>
     <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">loc</span><span class="main">,</span><span class="bound">t</span><span class="main">)</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="main">(</span>hd <span class="main">(</span>c_msg <span class="main">(</span>exchange_config <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="bound">t'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="main">(</span>prop_config <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">q</span><span class="main">)</span> <span class="bound">loc</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">t'</span> <span class="main">≤</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Pointstamps in incoming messages all satisfy the CM premise, which is required during NextRecvUpd' steps.›</span></span>
<span class="keyword1" id="Combined-msg_is_cm_safe"><span class="command">lemma</span></span> msg_is_cm_safe<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">c</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span><span class="main">::</span>finite<span class="main">,</span> <span class="tfree">'t</span><span class="main">::</span>order<span class="main">,</span> <span class="tfree">'loc</span><span class="main">)</span> configuration"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"safe <span class="main">(</span>prop_config <span class="free">c</span> <span class="free">q</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvGlobPointstampsEq <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"cri.InvMsgInGlob <span class="main">(</span>exchange_config <span class="free">c</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"c_msg <span class="main">(</span>exchange_config <span class="free">c</span><span class="main">)</span> <span class="free">p</span> <span class="free">q</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">loc</span><span class="main">,</span><span class="bound">t</span><span class="main">)</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="main">(</span>hd <span class="main">(</span>c_msg <span class="main">(</span>exchange_config <span class="free">c</span><span class="main">)</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="bound">t'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="main">(</span>prop_config <span class="free">c</span> <span class="free">q</span><span class="main">)</span> <span class="bound">loc</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">t'</span> <span class="main">≤</span> <span class="bound">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> cri.InvMsgInGlob_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> safe_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cri_less_eq_def assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> InvGlobPointstampsEq_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> order_trans <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Propagate Safety and InvGlobPointstampsEq›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹To be able to use the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[source] msg_is_cm_safe<span class="antiquote"><span class="antiquote">}</span></span></span></span> lemma at all times and show that Propagate is a
subsystem we need to prove that the specification implies Propagate's safe and the
InvGlobPointstampsEq. Both of these depend on the CM conditions being satisfied during the
NextRecvUpd' step and the safety proof additionally depends on other Propagate invariants, which
means that we need to prove all of these jointly.›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">prop_invs</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">prop_invs</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≡</span> inv_implications_nonneg <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">∧</span> inv_imps_work_sum <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">prop_safe</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">prop_safe</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≡</span> impl_safe <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">∧</span> safe <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">inv_init_imp_prop_safe</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">inv_init_imp_prop_safe</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span> init <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">p</span> <span class="main">⟶</span> prop_safe <span class="main">(</span>prop_config <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Combined-NextRecvUpd'_preserves_prop_safe"><span class="command">lemma</span></span> NextRecvUpd'_preserves_prop_safe<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prop_safe <span class="main">(</span>prop_config <span class="free">c0</span> <span class="free">q</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvGlobPointstampsEq <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"cri.InvMsgInGlob <span class="main">(</span>exchange_config <span class="free">c0</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"NextRecvUpd' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"prop_safe <span class="main">(</span>prop_config <span class="free">c1</span> <span class="free">q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> safe<span class="main">:</span> <span class="quoted"><span class="quoted">"safe <span class="main">(</span>prop_config <span class="free">c0</span> <span class="free">q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">note</span></span> recvupd_change <span class="main">=</span> cri.next_recvupdD<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> NextRecvUpdD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> cm_conds <span class="main">=</span> msg_is_cm_safe<span class="main">[</span><span class="operator">OF</span> safe assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span> recvupd_change<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> safes<span class="main">:</span>
    <span class="quoted"><span class="quoted">"prop_safe <span class="skolem">c0</span> <span class="main">⟹</span> next_change_multiplicity' <span class="skolem">c0</span> <span class="skolem">c1</span> <span class="skolem">loc</span> <span class="skolem">t</span> <span class="skolem">n</span> <span class="main">⟹</span> prop_safe <span class="skolem">c1</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">c0</span> <span class="skolem">c1</span> <span class="skolem">loc</span> <span class="skolem">t</span> <span class="skolem">n</span>
    <span class="keyword1"><span class="command">using</span></span>
      cm_preserves_safe
      cm_preserves_impl_safe
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"prop_safe <span class="main">(</span>prop_config <span class="free">c1</span> <span class="free">q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span>
      lift_cm_inv_cm_all<span class="main">[</span><span class="operator">rotated</span><span class="main">,</span> <span class="operator">OF</span> cm_conds<span class="main">,</span> <span class="operator">of</span> <span class="quoted">prop_safe</span><span class="main">,</span> <span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
      safes
      NextRecvUpdD<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Combined-NextRecvUpd'_preserves_InvGlobPointstampsEq"><span class="command">lemma</span></span> NextRecvUpd'_preserves_InvGlobPointstampsEq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"impl_safe <span class="main">(</span>prop_config <span class="free">c0</span> <span class="free">q</span><span class="main">)</span> <span class="main">∧</span> safe <span class="main">(</span>prop_config <span class="free">c0</span> <span class="free">q</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvGlobPointstampsEq <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"cri.InvMsgInGlob <span class="main">(</span>exchange_config <span class="free">c0</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"NextRecvUpd' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"InvGlobPointstampsEq <span class="free">c1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> safe<span class="main">:</span> <span class="quoted"><span class="quoted">"safe <span class="main">(</span>prop_config <span class="free">c0</span> <span class="free">q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">note</span></span> recvupd_change <span class="main">=</span> cri.next_recvupdD<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> NextRecvUpdD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> cm_conds <span class="main">=</span> msg_is_cm_safe<span class="main">[</span><span class="operator">OF</span> safe assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span> recvupd_change<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"InvGlobPointstampsEq <span class="free">c1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span>
      assms<span class="main">(</span>2<span class="main">,</span>4<span class="main">)</span>
      cm_conds
    <span class="keyword1"><span class="command">unfolding</span></span> NextRecvUpd'_def cri.next_recvupd'_def Let_def InvGlobPointstampsEq_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zcount_pointstamps_cm_all' cm_all_eq_cm_all'<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">― ‹Whenever some worker p propagates it ends up in a Propagate-safe state›</span>
<span class="keyword1" id="Combined-NextPropagate'_causes_safe"><span class="command">lemma</span></span> NextPropagate'_causes_safe<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"NextPropagate' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"inv_imps_work_sum <span class="main">(</span>prop_config <span class="free">c1</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"inv_implications_nonneg <span class="main">(</span>prop_config <span class="free">c1</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"safe <span class="main">(</span>prop_config <span class="free">c1</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"impl_safe <span class="main">(</span>prop_config <span class="free">c1</span> <span class="free">p</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Some <span class="main">(</span>prop_config <span class="free">c1</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> propagate_all <span class="main">(</span>prop_config <span class="free">c0</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> NextPropagate'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> wl<span class="main">:</span> <span class="quoted"><span class="quoted">"c_work <span class="main">(</span>prop_config <span class="free">c1</span> <span class="free">p</span><span class="main">)</span> <span class="skolem">loc</span> <span class="main">=</span> <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">loc</span>
    <span class="keyword1"><span class="command">unfolding</span></span> propagate_all_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> eq_commute<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> while_option_stop<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"safe <span class="main">(</span>prop_config <span class="free">c1</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"impl_safe <span class="main">(</span>prop_config <span class="free">c1</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> safe<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">,</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span> wl<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> impl_safe<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">,</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span> wl<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">― ‹NextPropagate' preserves Propagate-safe at all workers›</span>
<span class="keyword1" id="Combined-NextPropagate'_preserves_safe"><span class="command">lemma</span></span> NextPropagate'_preserves_safe<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"NextPropagate' <span class="free">c0</span> <span class="free">c1</span> <span class="free">q</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"inv_imps_work_sum <span class="main">(</span>prop_config <span class="free">c1</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"inv_implications_nonneg <span class="main">(</span>prop_config <span class="free">c1</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"safe <span class="main">(</span>prop_config <span class="free">c0</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"safe <span class="main">(</span>prop_config <span class="free">c1</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">=</span><span class="free">q</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1-3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> NextPropagate'_causes_safe<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">p</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> NextPropagate'_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Combined-NextPropagate'_preserves_impl_safe"><span class="command">lemma</span></span> NextPropagate'_preserves_impl_safe<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"NextPropagate' <span class="free">c0</span> <span class="free">c1</span> <span class="free">q</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"inv_imps_work_sum <span class="main">(</span>prop_config <span class="free">c1</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"inv_implications_nonneg <span class="main">(</span>prop_config <span class="free">c1</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"impl_safe <span class="main">(</span>prop_config <span class="free">c0</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"impl_safe <span class="main">(</span>prop_config <span class="free">c1</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">=</span><span class="free">q</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1-3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> NextPropagate'_causes_safe<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">p</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> NextPropagate'_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Combined-NextRecvUpd'_preserves_inv_init_imp_prop_safe"><span class="command">lemma</span></span> NextRecvUpd'_preserves_inv_init_imp_prop_safe<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cri.InvMsgInGlob <span class="main">(</span>exchange_config <span class="free">c0</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"inv_init_imp_prop_safe <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvGlobPointstampsEq <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"NextRecvUpd' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"inv_init_imp_prop_safe <span class="free">c1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> inv_init_imp_prop_safe_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> p
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span><span class="main">=</span><span class="free">q</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">p</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> NextRecvUpdD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>4<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> NextRecvUpd'_preserves_prop_safe<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ assms<span class="main"><span class="main"><span class="main">(</span></span></span>3<span class="main"><span class="main"><span class="main">,</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>4<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">using</span></span> NextRecvUpdD<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>4<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Combined-NextRecvUpd'_preserves_prop_invs"><span class="command">lemma</span></span> NextRecvUpd'_preserves_prop_invs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cri.InvMsgInGlob <span class="main">(</span>exchange_config <span class="free">c0</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"inv_init_imp_prop_safe <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> prop_invs <span class="main">(</span>prop_config <span class="free">c0</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvGlobPointstampsEq <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"NextRecvUpd' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> prop_invs <span class="main">(</span>prop_config <span class="free">c1</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> safe<span class="main">:</span> <span class="quoted"><span class="quoted">"safe <span class="main">(</span>prop_config <span class="free">c0</span> <span class="free">q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> NextRecvUpdD<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">,</span>5<span class="main">)</span> inv_init_imp_prop_safe_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">note</span></span> recvupd_change <span class="main">=</span> cri.next_recvupdD<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> NextRecvUpdD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> cm_conds <span class="main">=</span> msg_is_cm_safe<span class="main">[</span><span class="operator">OF</span> safe assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">,</span></span>1<span class="main"><span class="main">)</span></span> recvupd_change<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> invs<span class="main">:</span>
    <span class="quoted"><span class="quoted">"prop_invs <span class="skolem">c0</span> <span class="main">⟹</span> next_change_multiplicity' <span class="skolem">c0</span> <span class="skolem">c1</span> <span class="skolem">loc</span> <span class="skolem">t</span> <span class="skolem">n</span> <span class="main">⟹</span> prop_invs <span class="skolem">c1</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">c0</span> <span class="skolem">c1</span> <span class="skolem">loc</span> <span class="skolem">t</span> <span class="skolem">n</span>
    <span class="keyword1"><span class="command">using</span></span>
      cm_preserves_inv_imps_work_sum
      cm_preserves_inv_implications_nonneg
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> prop_invs <span class="main">(</span>prop_config <span class="free">c1</span> <span class="bound">q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q'
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span><span class="main">=</span><span class="free">q</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command">using</span></span>
          lift_cm_inv_cm_all<span class="main">[</span><span class="operator">rotated</span><span class="main">,</span> <span class="operator">OF</span> cm_conds<span class="main">,</span> <span class="operator">of</span> <span class="quoted">prop_invs</span><span class="main">,</span> <span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">]</span>
          invs
          NextRecvUpdD<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command">using</span></span> NextRecvUpdD<span class="main">(</span>4<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Combined-NextPropagate'_preserves_prop_invs"><span class="command">lemma</span></span> NextPropagate'_preserves_prop_invs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prop_invs <span class="main">(</span>prop_config <span class="free">c0</span> <span class="free">q</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"NextPropagate' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"prop_invs <span class="main">(</span>prop_config <span class="free">c1</span> <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">=</span><span class="free">q</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">using</span></span>
      assms<span class="main">(</span>1<span class="main">)</span>
      lift_propagate_inv_propagate_all<span class="main">[</span>
        <span class="operator">of</span> <span class="quoted">prop_invs</span><span class="main">,</span>
        <span class="operator">rotated</span> 2<span class="main">,</span>
        <span class="operator">OF</span> NextPropagateD<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> iiws_imp_iipwn p_preserves_inv_implications_nonneg p_preserves_inv_imps_work_sum<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> NextPropagateD<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> option.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Combined-NextPropagate'_preserves_inv_init_imp_prop_safe"><span class="command">lemma</span></span> NextPropagate'_preserves_inv_init_imp_prop_safe<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prop_invs <span class="main">(</span>prop_config <span class="free">c0</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"inv_init_imp_prop_safe <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"NextPropagate' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"inv_init_imp_prop_safe <span class="free">c1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> inv_init_imp_prop_safe_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> p'
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span><span class="main">=</span><span class="free">p</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">using</span></span> NextPropagate'_preserves_prop_invs<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> NextPropagate'_causes_safe<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">using</span></span> NextPropagateD<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">p'</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Combined-Next'_preserves_invs"><span class="command">lemma</span></span> Next'_preserves_invs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cri.InvMsgInGlob <span class="main">(</span>exchange_config <span class="free">c0</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"inv_init_imp_prop_safe <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvGlobPointstampsEq <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"Next' <span class="free">c0</span> <span class="free">c1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> prop_invs <span class="main">(</span>prop_config <span class="free">c0</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"inv_init_imp_prop_safe <span class="free">c1</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> prop_invs <span class="main">(</span>prop_config <span class="free">c1</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"InvGlobPointstampsEq <span class="free">c1</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> Next'_def
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> inv_init_imp_prop_safe_def
      <span class="keyword1"><span class="command">using</span></span> NextPerformOpD<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> inv_init_imp_prop_safe_def
      <span class="keyword1"><span class="command">using</span></span> NextSendUpdD<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">using</span></span> NextRecvUpd'_preserves_inv_init_imp_prop_safe<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">using</span></span> NextPropagate'_preserves_inv_init_imp_prop_safe assms<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> inv_init_imp_prop_safe_def
      <span class="keyword1"><span class="command">using</span></span> NextRecvCapD<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> Next'_def
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>5<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">using</span></span> NextPerformOpD<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">using</span></span> NextSendUpdD<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>3<span class="main">)</span> NextRecvUpd'_preserves_prop_invs <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">using</span></span> NextPropagate'_preserves_prop_invs <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> inv_init_imp_prop_safe_def
      <span class="keyword1"><span class="command">using</span></span> NextRecvCapD<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> Next'_def
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> InvGlobPointstampsEq_def NextPerformOpD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span> cri.next_performopD<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> InvGlobPointstampsEq_def NextSendUpdD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span> cri.next_sendupdD<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">using</span></span> NextRecvUpdD<span class="main">(</span>1<span class="main">)</span> NextRecvUpd'_preserves_InvGlobPointstampsEq assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> inv_init_imp_prop_safe_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> NextPropagate'_def InvGlobPointstampsEq_def
      <span class="keyword1"><span class="command">using</span></span> propagate_all_imp_InvGlobPointstampsEq
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> option.inject<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> InvGlobPointstampsEq_def NextRecvCapD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> NextRecvCapD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> cri.next_recvcapD<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Combined-init_imp_InvGlobPointstampsEq"><span class="command">lemma</span></span> init_imp_InvGlobPointstampsEq<span class="main">:</span> <span class="quoted"><span class="quoted">"InitConfig <span class="free">c</span> <span class="main">⟹</span> InvGlobPointstampsEq <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> InitConfig_def cri.init_config_def InvGlobPointstampsEq_def<span class="main">)</span>

<span class="keyword1" id="Combined-init_imp_inv_init_imp_prop_safe"><span class="command">lemma</span></span> init_imp_inv_init_imp_prop_safe<span class="main">:</span> <span class="quoted"><span class="quoted">"InitConfig <span class="free">c</span> <span class="main">⟹</span> inv_init_imp_prop_safe <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inv_init_imp_prop_safe_def InitConfig_def<span class="main">)</span>

<span class="keyword1" id="Combined-init_imp_prop_invs"><span class="command">lemma</span></span> init_imp_prop_invs<span class="main">:</span> <span class="quoted"><span class="quoted">"InitConfig <span class="free">c</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">p</span><span class="main">.</span> prop_invs <span class="main">(</span>prop_config <span class="free">c</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> InitConfig_def init_imp_inv_implications_nonneg init_imp_inv_imps_work_sum<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">all_invs</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">all_invs</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≡</span> InvGlobPointstampsEq <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">∧</span> inv_init_imp_prop_safe <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span> prop_invs <span class="main">(</span>prop_config <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Combined-alw_Next'_alw_invs"><span class="command">lemma</span></span> alw_Next'_alw_invs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"holds all_invs <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"alw <span class="main">(</span>holds <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> cri.InvMsgInGlob <span class="main">(</span>exchange_config <span class="bound">c</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"alw Next <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"alw <span class="main">(</span>holds all_invs<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> alw_holds2 Next'_preserves_invs<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> alwD<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> alw_holds2 Next'_preserves_invs<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> alwD<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> alw_holds2 Next'_preserves_invs<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> alwD<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> alw_holds2 Next'_preserves_invs<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> alwD<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Combined-alw_invs"><span class="command">lemma</span></span> alw_invs<span class="main">:</span> <span class="quoted"><span class="quoted">"FullSpec <span class="free">s</span> <span class="main">⟹</span> alw <span class="main">(</span>holds all_invs<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> exch_alw_InvMsgInGlob<span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> FullSpec_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> init_imp_InvGlobPointstampsEq<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> init_imp_inv_init_imp_prop_safe<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> init_imp_prop_invs<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alw_Next'_alw_invs alw_mono<span class="main">)</span>

<span class="keyword1" id="Combined-alw_InvGlobPointstampsEq"><span class="command">lemma</span></span> alw_InvGlobPointstampsEq<span class="main">:</span> <span class="quoted"><span class="quoted">"FullSpec <span class="free">s</span> <span class="main">⟹</span> alw <span class="main">(</span>holds InvGlobPointstampsEq<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> alw_invs alw_mono holds_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Combined-alw_inv_init_imp_prop_safe"><span class="command">lemma</span></span> alw_inv_init_imp_prop_safe<span class="main">:</span> <span class="quoted"><span class="quoted">"FullSpec <span class="free">s</span> <span class="main">⟹</span> alw <span class="main">(</span>holds inv_init_imp_prop_safe<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> alw_invs alw_mono holds_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Combined-alw_holds_conv_shd"><span class="command">lemma</span></span> alw_holds_conv_shd<span class="main">:</span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>holds <span class="free">φ</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> alw <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">φ</span> <span class="main">(</span>shd <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alw_iff_sdrop<span class="main">)</span>

<span class="keyword1" id="Combined-alw_prop_invs"><span class="command">lemma</span></span> alw_prop_invs<span class="main">:</span> <span class="quoted"><span class="quoted">"FullSpec <span class="free">s</span> <span class="main">⟹</span> alw <span class="main">(</span>holds <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> <span class="main">∀</span><span class="bound">p</span><span class="main">.</span> prop_invs <span class="main">(</span>prop_config <span class="bound">c</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span>
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> alw_mono<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"holds all_invs"</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="quoted">"holds <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> <span class="main">∀</span><span class="bound">p</span><span class="main">.</span> prop_invs <span class="main">(</span>prop_config <span class="bound">c</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span>
      <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> alw_invs<span class="main">)</span>

<span class="keyword1" id="Combined-nrec_pts_delayed"><span class="command">lemma</span></span> nrec_pts_delayed<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cri.InvGlobNonposImpRecordsNonpos <span class="main">(</span>exchange_config <span class="free">c</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>cri.records <span class="main">(</span>exchange_config <span class="free">c</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x'</span><span class="main">.</span> <span class="bound">x'</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">x</span> <span class="main">∧</span> zcount <span class="main">(</span>c_glob <span class="main">(</span>exchange_config <span class="free">c</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="bound">x'</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="main">¬</span> cri.nonpos_upto <span class="main">(</span>c_glob <span class="main">(</span>exchange_config <span class="free">c</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> cri.InvGlobNonposImpRecordsNonpos_def cri.nonpos_upto_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> linorder_not_less cri.order.order_iff_strict<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> r<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cri.nonpos_upto_def not_le<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Combined-help_lemma"><span class="command">lemma</span></span> help_lemma<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_pts <span class="main">(</span>prop_config <span class="free">c</span> <span class="free">p</span><span class="main">)</span> <span class="free">loc0</span><span class="main">)</span> <span class="free">t0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">loc0</span><span class="main">,</span> <span class="free">t0</span><span class="main">)</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>p</sub></span> <span class="main">(</span><span class="free">loc1</span><span class="main">,</span> <span class="free">t1</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">s2</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> path_summary <span class="free">loc1</span> <span class="free">loc2</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"safe <span class="main">(</span>prop_config <span class="free">c</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">t2</span><span class="main">.</span> <span class="main">(</span><span class="bound">t2</span> <span class="main">≤</span> <span class="free">results_in</span> <span class="free">t1</span> <span class="free">s2</span>
                <span class="main">∧</span> <span class="bound">t2</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="main">(</span>prop_config <span class="free">c</span> <span class="free">p</span><span class="main">)</span> <span class="free">loc2</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s1</span></span> <span class="keyword2"><span class="keyword">where</span></span> s1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s1</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> path_summary <span class="free">loc0</span> <span class="free">loc1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">results_in</span> <span class="free">t0</span> <span class="skolem">s1</span> <span class="main">≤</span> <span class="free">t1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cri_less_eq_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> s1<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s_full</span></span> <span class="keyword2"><span class="keyword">where</span></span> s_full<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s_full</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> path_summary <span class="free">loc0</span> <span class="free">loc2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s_full</span> <span class="main">≤</span> followed_by <span class="skolem">s1</span> <span class="free">s2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> flow.path_weight_elem_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> s_full<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>1<span class="main">,</span>4<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t2</span></span> <span class="keyword2"><span class="keyword">where</span></span> t2<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="skolem">t2</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="main">(</span>prop_config <span class="free">c</span> <span class="free">p</span><span class="main">)</span> <span class="free">loc2</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t2</span> <span class="main">≤</span> <span class="free">results_in</span> <span class="free">t0</span> <span class="skolem">s_full</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> safe_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> t2<span class="main">(</span>2<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> s_full<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t2</span> <span class="main">≤</span> <span class="free">results_in</span> <span class="main">(</span><span class="free">results_in</span> <span class="free">t0</span> <span class="skolem">s1</span><span class="main">)</span> <span class="free">s2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> followed_by_summary order_trans results_in_mono<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> s1<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t2</span> <span class="main">≤</span> <span class="free">results_in</span> <span class="free">t1</span> <span class="free">s2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> order.trans results_in_mono<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> t2<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">― ‹Lift an invariant's preservation proof over <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">next_propagate'</span><span class="antiquote">}</span></span> to NextPropagate' transitions›</span>
<span class="keyword1" id="Combined-lift_prop_inv_NextPropagate'"><span class="command">lemma</span></span> lift_prop_inv_NextPropagate'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">c0</span> <span class="bound">c1</span> <span class="bound">loc</span> <span class="bound">t</span><span class="main">.</span> <span class="free">P</span> <span class="bound">c0</span> <span class="main">⟹</span> next_propagate' <span class="bound">c0</span> <span class="bound">c1</span> <span class="bound">loc</span> <span class="bound">t</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">c1</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>prop_config <span class="free">c0</span> <span class="free">p'</span><span class="main">)</span> <span class="main">⟹</span> NextPropagate' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>prop_config <span class="free">c1</span> <span class="free">p'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> pc0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>prop_config <span class="free">c0</span> <span class="free">p'</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> np<span class="main">:</span> <span class="quoted"><span class="quoted">"NextPropagate' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> n_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">c0</span> <span class="bound">c1</span><span class="main">.</span> <span class="free">P</span> <span class="bound">c0</span> <span class="main">⟹</span> next_propagate <span class="bound">c0</span> <span class="bound">c1</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">c1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">c</span><span class="main">.</span> <span class="keyword1">SOME</span> <span class="bound">c'</span><span class="main">.</span> next_propagate <span class="bound">c</span> <span class="bound">c'</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?b</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">c</span><span class="main">.</span> <span class="main">∃</span><span class="bound">loc</span><span class="main">.</span> c_work <span class="bound">c</span> <span class="bound">loc</span> <span class="main">≠</span> <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> np <span class="keyword1"><span class="command">have</span></span> pc1<span class="main">:</span> <span class="quoted"><span class="quoted">"Some <span class="main">(</span>prop_config <span class="free">c1</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> propagate_all <span class="main">(</span>prop_config <span class="free">c0</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> NextPropagate'_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">p'</span><span class="main">=</span><span class="free">p</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> while_option_rule<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?b</span></span></span></span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?f</span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"prop_config <span class="free"><span class="free">c0</span></span> <span class="free"><span class="free">p</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> n_p<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> iffD1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> verit_sko_ex<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exists_next_propagate'<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
      <span class="keyword1"><span class="command">using</span></span> pc1 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> propagate_all_def<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> pc0 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">using</span></span> np pc0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> NextPropagate'_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">p'</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Propagate is a Subsystem›</span></span>


<span class="keyword1" id="Combined-NextRecvUpd'_next'"><span class="command">lemma</span></span> NextRecvUpd'_next'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"safe <span class="main">(</span>prop_config <span class="free">c0</span> <span class="free">q</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvGlobPointstampsEq <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"cri.InvMsgInGlob <span class="main">(</span>exchange_config <span class="free">c0</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"NextRecvUpd' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"next'<span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="main">(</span>prop_config <span class="free">c0</span> <span class="free">q'</span><span class="main">)</span> <span class="main">(</span>prop_config <span class="free">c1</span> <span class="free">q'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> NextRecvUpdD<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> cm_all_eq_cm_all'<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> cri.InvMsgInGlob_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> cri.next_recvupdD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> NextRecvUpdD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> loc t loc' t'
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> InvGlobPointstampsEq_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cri_less_eq_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> safe_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">loc'</span></span> <span class="quoted"><span class="skolem">t'</span></span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">loc</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> meta_mp<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> t''
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">t''</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> order_trans <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> lift_cm_inv_cm_all'<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> tranclp.intros<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next'_def<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> cri.InvMsgInGlob_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> cri.next_recvupdD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> NextRecvUpdD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> loc t loc' t'
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> InvGlobPointstampsEq_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cri_less_eq_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> safe_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">loc'</span></span> <span class="quoted"><span class="skolem">t'</span></span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">loc</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> meta_mp<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> t''
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">t''</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> order_trans <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next'_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next'_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Combined-NextPropagate'_next'"><span class="command">lemma</span></span> NextPropagate'_next'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"NextPropagate' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"next'<span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="main">(</span>prop_config <span class="free">c0</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span>prop_config <span class="free">c1</span> <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">=</span><span class="free">q</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> lift_propagate_inv_propagate_all<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"prop_config <span class="free"><span class="free">c0</span></span> <span class="free"><span class="free">p</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> tranclp.intros<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next'_def NextPropagateD<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> NextPropagateD<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms next'_def option.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> tranclp.intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Combined-next_imp_propagate_next"><span class="command">lemma</span></span> next_imp_propagate_next<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inv_init_imp_prop_safe <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvGlobPointstampsEq <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"cri.InvMsgInGlob <span class="main">(</span>exchange_config <span class="free">c0</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"Next' <span class="free">c0</span> <span class="free">c1</span> <span class="main">⟹</span> next'<span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="main">(</span>prop_config <span class="free">c0</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span>prop_config <span class="free">c1</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Next'_def NextPerformOp'_def NextSendUpd'_def NextRecvCap'_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next'_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next'_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> p' q
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> inv_init_imp_prop_safe_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">q</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> meta_mp<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> NextRecvUpdD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>    
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span><span class="main">=</span><span class="free">p</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> NextRecvUpd'_next'<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>2-<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> NextRecvUpd'_def next'_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> NextPropagate'_next'<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next'_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next'_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Combined-alw_next_imp_propagate_next"><span class="command">lemma</span></span> alw_next_imp_propagate_next<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>holds inv_init_imp_prop_safe<span class="main">)</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"alw <span class="main">(</span>holds InvGlobPointstampsEq<span class="main">)</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"alw <span class="main">(</span>holds cri.InvMsgInGlob<span class="main">)</span> <span class="main">(</span>smap exchange_config <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"alw Next <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"alw <span class="main">(</span>relates <span class="main">(</span>next'<span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>smap <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> prop_config <span class="bound">s</span> <span class="free">p</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> alw.coinduct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> next_imp_propagate_next <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> relates_def alw_holds_smap_conv_comp<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Any Tracker trace is a valid Propagate trace (using the transitive closure of next, since
tracker may take multiple propagate steps at once).›</span></span>
<span class="keyword1" id="Combined-spec_imp_propagate_spec"><span class="command">lemma</span></span> spec_imp_propagate_spec<span class="main">:</span> <span class="quoted"><span class="quoted">"FullSpec <span class="free">s</span> <span class="main">⟹</span> <span class="main">(</span>holds init_config <span class="keyword1">aand</span> alw <span class="main">(</span>relates <span class="main">(</span>next'<span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>smap <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> prop_config <span class="bound">c</span> <span class="free">p</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> alw_inv_init_imp_prop_safe<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> alw_InvGlobPointstampsEq<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> spec_imp_exchange_spec<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> cri.alw_InvMsgInGlob<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> alw_next_imp_propagate_next <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> FullSpec_def InitConfig_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Safety Proofs›</span></span>

<span class="keyword1" id="Combined-safe_satisfied"><span class="command">lemma</span></span> safe_satisfied<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cri.InvGlobNonposImpRecordsNonpos <span class="main">(</span>exchange_config <span class="free">c</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"inv_init_imp_prop_safe <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"InvGlobPointstampsEq <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"safe_combined <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">loc1</span> <span class="skolem">loc2</span> <span class="skolem">t</span> <span class="skolem">s</span> <span class="skolem">p</span>
    <span class="keyword3"><span class="command">assume</span></span> as<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>cri.records <span class="main">(</span>exchange_config <span class="free">c</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">loc1</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> path_summary <span class="skolem">loc1</span> <span class="skolem">loc2</span>"</span></span> <span class="quoted"><span class="quoted">"init <span class="free">c</span> <span class="skolem">p</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">loc0</span></span> <span class="skolem"><span class="skolem">t0</span></span> <span class="keyword2"><span class="keyword">where</span></span> delayed<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">loc0</span><span class="main">,</span> <span class="skolem">t0</span><span class="main">)</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>p</sub></span> <span class="main">(</span><span class="skolem">loc1</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_glob <span class="main">(</span>exchange_config <span class="free">c</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">(</span><span class="skolem">loc0</span><span class="main">,</span> <span class="skolem">t0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> nrec_pts_delayed<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> as<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">with</span></span> as<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t2</span><span class="main">.</span> <span class="bound">t2</span> <span class="main">≤</span> <span class="free">results_in</span> <span class="skolem">t</span> <span class="skolem">s</span> <span class="main">∧</span> <span class="bound">t2</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="main">(</span>prop_config <span class="free">c</span> <span class="skolem">p</span><span class="main">)</span> <span class="skolem">loc2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> help_lemma delayed
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> InvGlobPointstampsEq_def assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> inv_init_imp_prop_safe_def<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> safe_combined_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Combined-alw_safe_combined"><span class="command">lemma</span></span> alw_safe_combined<span class="main">:</span> <span class="quoted"><span class="quoted">"FullSpec <span class="free">s</span> <span class="main">⟹</span> alw <span class="main">(</span>holds safe_combined<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> alw_inv_init_imp_prop_safe<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> exch_alw_InvGlobNonposImpRecordsNonpos<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> alw_InvGlobPointstampsEq<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> alw.coinduct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> alwD alw_holds2 safe_satisfied<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI1<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Combined-alw_safe_combined2"><span class="command">lemma</span></span> alw_safe_combined2<span class="main">:</span> <span class="quoted"><span class="quoted">"FullSpec <span class="free">s</span> <span class="main">⟹</span> alw <span class="main">(</span>holds safe_combined2<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> exch_alw_InvCapsNonneg<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> alw_safe_combined<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alw_iff_sdrop safe_combined_implies_safe_combined2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Combined-alw_implication_frontier_eq_implied_frontier"><span class="command">lemma</span></span> alw_implication_frontier_eq_implied_frontier<span class="main">:</span>
  <span class="quoted"><span class="quoted">"FullSpec <span class="free">s</span> <span class="main">⟹</span> 
    alw <span class="main">(</span>holds <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> worklists_vacant_to <span class="main">(</span>prop_config <span class="bound">c</span> <span class="free">p</span><span class="main">)</span> <span class="free">b</span> <span class="main">⟶</span>
      <span class="free">b</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="main">(</span>prop_config <span class="bound">c</span> <span class="free">p</span><span class="main">)</span> <span class="free">loc</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">b</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> implied_frontier <span class="main">(</span>c_pts <span class="main">(</span>prop_config <span class="bound">c</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="free">loc</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> alw_prop_invs<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> implication_frontier_iff_implied_frontier_vacant all_imp_alw <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> alw_mp<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span></pre>
</div>