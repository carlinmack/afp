<div id="Status">
<div class="head">
<h1>Theory Status</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Preliminaries›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Status functions›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A status function assigns to each n-ary symbol a list of indices between 0 and n-1.
These functions are encapsulated into a separate type, so that recursion on the i-th subterm
does not have to perform out-of-bounds checks (e.g., to ensure termination).›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Status
  <span class="keyword2"><span class="keyword">imports</span></span> 
    <a href="../../first_order_terms/theories/#Term">First_Order_Terms.Term</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">typedef</span></span> <span class="tfree">'f</span> status <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span> <span class="main">(</span><span class="bound">σ</span> <span class="main">::</span> <span class="tfree">'f</span> <span class="main">×</span> nat <span class="main">⇒</span> nat list<span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">f</span> <span class="bound">k</span><span class="main">.</span> set <span class="main">(</span><span class="bound">σ</span> <span class="main">(</span><span class="bound">f</span><span class="main">,</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="bound">k</span><span class="main">}</span><span class="main">)</span><span class="main">}</span>"</span></span> 
  <span class="keyword2"><span class="keyword">morphisms</span></span> status Abs_status
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span> <span class="main"><span class="bound"><span class="main"><span class="bound"><span class="main"><span class="bound">_</span></span></span></span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="main"><span class="main"><span class="main">[]</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">setup_lifting</span></span> type_definition_status

<span class="keyword1" id="Status-status"><span class="command">lemma</span></span> status<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>status <span class="free">σ</span> <span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">n</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Status-status_aux"><span class="command">lemma</span></span> status_aux<span class="main">[</span><span class="operator">termination_simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> set <span class="main">(</span>status <span class="free">σ</span> <span class="main">(</span><span class="free">f</span><span class="main">,</span> length <span class="free">ss</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">ss</span> <span class="main">!</span> <span class="free">i</span> <span class="main">∈</span> set <span class="free">ss</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> status<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ss</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> set_conv_nth <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Status-status_termination_simps"><span class="command">lemma</span></span> status_termination_simps<span class="main">[</span><span class="operator">termination_simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> i1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="main">(</span>status <span class="free">σ</span> <span class="main">(</span><span class="free">f</span><span class="main">,</span> length <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"size <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="main">(</span>status <span class="free">σ</span> <span class="main">(</span><span class="free">f</span><span class="main">,</span> length <span class="free">xs</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> Suc <span class="main">(</span>size_list size <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?a</span> <span class="main">&lt;</span> <span class="var">?c</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> i1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"status <span class="free">σ</span> <span class="main">(</span><span class="free">f</span><span class="main">,</span> length <span class="free">xs</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span> <span class="main">∈</span> set <span class="main">(</span>status <span class="free">σ</span> <span class="main">(</span><span class="free">f</span><span class="main">,</span> length <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> status_aux<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?a</span> <span class="main">≤</span> size_list size <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">termination_simp</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Status-status_ne"><span class="command">lemma</span></span> status_ne<span class="main">:</span>
  <span class="quoted"><span class="quoted">"status <span class="free">σ</span> <span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>status <span class="free">σ</span> <span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> status <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> atLeastLessThan_iff set_empty subsetCE subsetI subset_empty<span class="main">)</span>

<span class="keyword1" id="Status-set_status_nth"><span class="command">lemma</span></span> set_status_nth<span class="main">:</span>
  <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">∈</span> set <span class="main">(</span>status <span class="free">σ</span> <span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">∧</span> <span class="free">xs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> status <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">lift_definition</span></span> full_status <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'f</span> status"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="main">(</span><span class="bound">f</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span><span class="main">.</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="bound">n</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Status-full_status"><span class="command">lemma</span></span> full_status<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"status full_status <span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">n</span><span class="main">]</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹An argument position i is simple wrt. some term relation, if the i-th subterm is in relation to the
  full term.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">simple_arg_pos</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> term rel <span class="main">⇒</span> <span class="tfree">'f</span> <span class="main">×</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">simple_arg_pos</span> <span class="free"><span class="bound"><span class="entity">rel</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span> <span class="main">∀</span> <span class="bound">ts</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">&lt;</span> snd <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">⟶</span> length <span class="bound">ts</span> <span class="main">=</span> snd <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">⟶</span> <span class="main">(</span>Fun <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="bound">ts</span><span class="main">,</span> <span class="bound">ts</span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">rel</span></span></span>"</span></span>

<span class="keyword1" id="Status-simple_arg_posI"><span class="command">lemma</span></span> simple_arg_posI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">⋀</span> <span class="bound">ts</span><span class="main">.</span> length <span class="bound">ts</span> <span class="main">=</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> <span class="main">(</span>Fun <span class="free">f</span> <span class="bound">ts</span><span class="main">,</span> <span class="bound">ts</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">rel</span><span class="main">⟧</span> <span class="main">⟹</span> simple_arg_pos <span class="free">rel</span> <span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> simple_arg_pos_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Precedence">
<div class="head">
<h1>Theory Precedence</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Precedence›</span></span>

<span class="keyword1"><span class="command">text</span></span> 
  <span class="quoted"><span class="plain_text">‹A precedence consists of two compatible relations (strict and non-strict) on symbols such that 
the strict relation is strongly normalizing. In the formalization we model this via a
function "prc" (precedence-compare) which returns two Booleans, indicating whether the one symbol is
strictly or weakly bigger than the other symbol. Moreover, there also is a function "prl" 
(precedence-least) which gives quick access to whether a symbol is least in precedence, i.e., 
without comparing it to all other symbols explicitly.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Precedence
  <span class="keyword2"><span class="keyword">imports</span></span> 
    <span class="quoted">"<a href="../Abstract-Rewriting/Abstract_Rewriting.html">Abstract-Rewriting.Abstract_Rewriting</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">locale</span></span> precedence <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">prc</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'f</span> <span class="main">⇒</span> <span class="tfree">'f</span> <span class="main">⇒</span> bool <span class="main">×</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">prl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'f</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> prc_refl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">prc</span> <span class="free">f</span> <span class="free">f</span> <span class="main">=</span> <span class="main">(</span>False<span class="main">,</span> True<span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> prc_SN<span class="main">:</span> <span class="quoted"><span class="quoted">"SN <span class="main">{</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span> <span class="bound">g</span><span class="main">)</span><span class="main">.</span> fst <span class="main">(</span><span class="free">prc</span> <span class="bound">f</span> <span class="bound">g</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> prl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">prl</span> <span class="free">g</span> <span class="main">⟹</span> snd <span class="main">(</span><span class="free">prc</span> <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> True"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> prl3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">prl</span> <span class="free">f</span> <span class="main">⟹</span> snd <span class="main">(</span><span class="free">prc</span> <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">prl</span> <span class="free">g</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> prc_compat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">prc</span> <span class="free">f</span> <span class="free">g</span> <span class="main">=</span> <span class="main">(</span><span class="free">s1</span><span class="main">,</span> <span class="free">ns1</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">prc</span> <span class="free">g</span> <span class="free">h</span> <span class="main">=</span> <span class="main">(</span><span class="free">s2</span><span class="main">,</span> <span class="free">ns2</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">prc</span> <span class="free">f</span> <span class="free">h</span> <span class="main">=</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">ns</span><span class="main">)</span> <span class="main">⟹</span> 
   <span class="main">(</span><span class="free">ns1</span> <span class="main">∧</span> <span class="free">ns2</span> <span class="main">⟶</span> <span class="free">ns</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">ns1</span> <span class="main">∧</span> <span class="free">s2</span> <span class="main">⟶</span> <span class="free">s</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">s1</span> <span class="main">∧</span> <span class="free">ns2</span> <span class="main">⟶</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> prc_stri_imp_nstri<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="free">prc</span> <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="main">⟹</span> snd <span class="main">(</span><span class="free">prc</span> <span class="free">f</span> <span class="free">g</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Precedence-prl2"><span class="command">lemma</span></span> prl2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">prl</span> <span class="free">g</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="free">prc</span> <span class="free">g</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> False"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?thesis</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> gf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">prc</span> <span class="free">g</span> <span class="free">f</span> <span class="main">=</span> <span class="main">(</span>True<span class="main">,</span> <span class="skolem">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">prc</span> <span class="free">g</span> <span class="free">f</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b1</span></span> <span class="skolem"><span class="skolem">b2</span></span> <span class="keyword2"><span class="keyword">where</span></span> gg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">prc</span> <span class="free">g</span> <span class="free">g</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">b1</span><span class="main">,</span> <span class="skolem">b2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b'</span></span> <span class="keyword2"><span class="keyword">where</span></span> fg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">prc</span> <span class="free">f</span> <span class="free">g</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">b'</span><span class="main">,</span> True<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prl<span class="main">[</span><span class="operator">OF</span> g<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">prc</span> <span class="free">f</span> <span class="free">g</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> prc_compat<span class="main">[</span><span class="operator">OF</span> gf fg gg<span class="main">]</span> gg <span class="keyword1"><span class="command">have</span></span> gg<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="free">prc</span> <span class="free">g</span> <span class="free">g</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> SN_on_irrefl<span class="main">[</span><span class="operator">OF</span> prc_SN<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">pr</span> <span class="main">≡</span> <span class="main">(</span><span class="free">prc</span><span class="main">,</span> <span class="free">prl</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Relations">
<div class="head">
<h1>Theory Relations</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Local versions of relations›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Relations
  <span class="keyword2"><span class="keyword">imports</span></span>
    <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Multiset.html">HOL-Library.Multiset</a>"</span>
    <span class="quoted">"<a href="../Abstract-Rewriting/Abstract_Rewriting.html">Abstract-Rewriting.Abstract_Rewriting</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Common predicates on relations›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">compatible_l</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rel <span class="main">⇒</span> <span class="tfree">'a</span> rel <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">compatible_l</span> <span class="free"><span class="bound"><span class="entity">R1</span></span></span> <span class="free"><span class="bound"><span class="entity">R2</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">R1</span></span></span> <span class="keyword1">O</span> <span class="free"><span class="bound"><span class="entity">R2</span></span></span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">R2</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">compatible_r</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rel <span class="main">⇒</span> <span class="tfree">'a</span> rel <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">compatible_r</span> <span class="free"><span class="bound"><span class="entity">R1</span></span></span> <span class="free"><span class="bound"><span class="entity">R2</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">R2</span></span></span> <span class="keyword1">O</span> <span class="free"><span class="bound"><span class="entity">R1</span></span></span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">R2</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Local reflexivity›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">locally_refl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rel <span class="main">⇒</span> <span class="tfree">'a</span> multiset <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">locally_refl</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈#</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">a</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">locally_irrefl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rel <span class="main">⇒</span> <span class="tfree">'a</span> multiset <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">locally_irrefl</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈#</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span><span class="bound">t</span><span class="main">)</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Local symmetry›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">locally_sym</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rel <span class="main">⇒</span> <span class="tfree">'a</span> multiset <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">locally_sym</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span> <span class="bound">u</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈#</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⟶</span> <span class="bound">u</span> <span class="main">∈#</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⟶</span>
               <span class="main">(</span><span class="bound">t</span><span class="main">,</span><span class="bound">u</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span><span class="bound">t</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">locally_antisym</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rel <span class="main">⇒</span> <span class="tfree">'a</span> multiset <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">locally_antisym</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span> <span class="bound">u</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈#</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⟶</span> <span class="bound">u</span> <span class="main">∈#</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⟶</span>
               <span class="main">(</span><span class="bound">t</span><span class="main">,</span><span class="bound">u</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span><span class="bound">t</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">⟶</span> <span class="bound">t</span> <span class="main">=</span> <span class="bound">u</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Local transitivity›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">locally_trans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rel <span class="main">⇒</span> <span class="tfree">'a</span> multiset <span class="main">⇒</span> <span class="tfree">'a</span> multiset <span class="main">⇒</span> <span class="tfree">'a</span> multiset <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">locally_trans</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span> <span class="bound">u</span> <span class="bound">v</span><span class="main">.</span>
               <span class="bound">t</span> <span class="main">∈#</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⟶</span> <span class="bound">u</span> <span class="main">∈#</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">⟶</span> <span class="bound">v</span> <span class="main">∈#</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">⟶</span>
               <span class="main">(</span><span class="bound">t</span><span class="main">,</span><span class="bound">u</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Local inclusion›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">locally_included</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rel <span class="main">⇒</span> <span class="tfree">'a</span> rel <span class="main">⇒</span> <span class="tfree">'a</span> multiset <span class="main">⇒</span> <span class="tfree">'a</span> multiset <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">locally_included</span> <span class="free"><span class="bound"><span class="entity">R1</span></span></span> <span class="free"><span class="bound"><span class="entity">R2</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span> <span class="bound">u</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈#</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⟶</span> <span class="bound">u</span> <span class="main">∈#</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">⟶</span>
               <span class="main">(</span><span class="bound">t</span><span class="main">,</span><span class="bound">u</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R1</span></span></span> <span class="main">⟶</span>  <span class="main">(</span><span class="bound">t</span><span class="main">,</span><span class="bound">u</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R2</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Local transitivity compatibility›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">locally_compatible_l</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rel <span class="main">⇒</span> <span class="tfree">'a</span> rel <span class="main">⇒</span> <span class="tfree">'a</span> multiset <span class="main">⇒</span> <span class="tfree">'a</span> multiset <span class="main">⇒</span> <span class="tfree">'a</span> multiset <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">locally_compatible_l</span> <span class="free"><span class="bound"><span class="entity">R1</span></span></span> <span class="free"><span class="bound"><span class="entity">R2</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span> <span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈#</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⟶</span> <span class="bound">u</span> <span class="main">∈#</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">⟶</span> <span class="bound">v</span> <span class="main">∈#</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">⟶</span>
               <span class="main">(</span><span class="bound">t</span><span class="main">,</span><span class="bound">u</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R1</span></span></span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R2</span></span></span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R2</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">locally_compatible_r</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rel <span class="main">⇒</span> <span class="tfree">'a</span> rel <span class="main">⇒</span> <span class="tfree">'a</span> multiset <span class="main">⇒</span> <span class="tfree">'a</span> multiset <span class="main">⇒</span> <span class="tfree">'a</span> multiset <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">locally_compatible_r</span> <span class="free"><span class="bound"><span class="entity">R1</span></span></span> <span class="free"><span class="bound"><span class="entity">R2</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span> <span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈#</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⟶</span> <span class="bound">u</span> <span class="main">∈#</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">⟶</span> <span class="bound">v</span> <span class="main">∈#</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">⟶</span>
               <span class="main">(</span><span class="bound">t</span><span class="main">,</span><span class="bound">u</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R2</span></span></span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R1</span></span></span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R2</span></span></span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹included + compatible $\longrightarrow$  transitive›</span></span>

<span class="keyword1" id="Relations-in_cl_tr"><span class="command">lemma</span></span> in_cl_tr<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">R1</span> <span class="main">⊆</span> <span class="free">R2</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"compatible_l <span class="free">R2</span> <span class="free">R1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">R1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span>
    <span class="keyword3"><span class="command">assume</span></span> s_x_y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> s_y_z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">z</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R1</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> assms s_x_y <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> s_y_z assms<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> compatible_l_def<span class="main">]</span>  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">z</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> trans_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Relations-in_cr_tr"><span class="command">lemma</span></span> in_cr_tr<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">R1</span> <span class="main">⊆</span> <span class="free">R2</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"compatible_r <span class="free">R2</span> <span class="free">R1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">R1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span>
    <span class="keyword3"><span class="command">assume</span></span> s_x_y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> s_y_z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">z</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R1</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">z</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> s_x_y assms<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> compatible_r_def<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">z</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> trans_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹If a property holds globally, it also holds locally. Obviously.›</span></span>

<span class="keyword1" id="Relations-r_lr"><span class="command">lemma</span></span> r_lr<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"refl <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"locally_refl <span class="free">R</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> refl_on_def locally_refl_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Relations-tr_ltr"><span class="command">lemma</span></span> tr_ltr<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"locally_trans <span class="free">R</span> <span class="free">A</span> <span class="free">B</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> trans_def <span class="keyword2"><span class="keyword">and</span></span> locally_trans_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Relations-in_lin"><span class="command">lemma</span></span> in_lin<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">R1</span> <span class="main">⊆</span> <span class="free">R2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"locally_included <span class="free">R1</span> <span class="free">R2</span> <span class="free">A</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> locally_included_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Relations-cl_lcl"><span class="command">lemma</span></span> cl_lcl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"compatible_l <span class="free">R1</span> <span class="free">R2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"locally_compatible_l <span class="free">R1</span> <span class="free">R2</span> <span class="free">A</span> <span class="free">B</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> compatible_l_def <span class="keyword2"><span class="keyword">and</span></span> locally_compatible_l_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Relations-cr_lcr"><span class="command">lemma</span></span> cr_lcr<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"compatible_r <span class="free">R1</span> <span class="free">R2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"locally_compatible_r <span class="free">R1</span> <span class="free">R2</span> <span class="free">A</span> <span class="free">B</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> compatible_r_def <span class="keyword2"><span class="keyword">and</span></span> locally_compatible_r_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹If a predicate holds on a set then it holds on
  all the subsets:›</span></span>

<span class="keyword1" id="Relations-lr_trans_l"><span class="command">lemma</span></span> lr_trans_l<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"locally_refl <span class="free">R</span> <span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"locally_refl <span class="free">R</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> locally_refl_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Relations-li_trans_l"><span class="command">lemma</span></span> li_trans_l<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"locally_irrefl <span class="free">R</span> <span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"locally_irrefl <span class="free">R</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> locally_irrefl_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Relations-ls_trans_l"><span class="command">lemma</span></span> ls_trans_l<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"locally_sym <span class="free">R</span> <span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"locally_sym <span class="free">R</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> locally_sym_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Relations-las_trans_l"><span class="command">lemma</span></span> las_trans_l<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"locally_antisym <span class="free">R</span> <span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"locally_antisym <span class="free">R</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> locally_antisym_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Relations-lt_trans_l"><span class="command">lemma</span></span> lt_trans_l<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"locally_trans <span class="free">R</span> <span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">B</span><span class="main">)</span> <span class="main">(</span><span class="free">C</span> <span class="main">+</span> <span class="free">D</span><span class="main">)</span> <span class="main">(</span><span class="free">E</span> <span class="main">+</span> <span class="free">F</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"locally_trans <span class="free">R</span> <span class="free">A</span> <span class="free">C</span> <span class="free">E</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">[</span><span class="operator">unfolded</span> locally_trans_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> locally_trans_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Relations-lin_trans_l"><span class="command">lemma</span></span> lin_trans_l<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"locally_included <span class="free">R1</span> <span class="free">R2</span> <span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">B</span><span class="main">)</span> <span class="main">(</span><span class="free">C</span> <span class="main">+</span> <span class="free">D</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"locally_included <span class="free">R1</span> <span class="free">R2</span> <span class="free">A</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> locally_included_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Relations-lcl_trans_l"><span class="command">lemma</span></span> lcl_trans_l<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"locally_compatible_l <span class="free">R1</span> <span class="free">R2</span> <span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">B</span><span class="main">)</span> <span class="main">(</span><span class="free">C</span> <span class="main">+</span> <span class="free">D</span><span class="main">)</span> <span class="main">(</span><span class="free">E</span> <span class="main">+</span> <span class="free">F</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"locally_compatible_l <span class="free">R1</span> <span class="free">R2</span> <span class="free">A</span> <span class="free">C</span> <span class="free">E</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">[</span><span class="operator">unfolded</span> locally_compatible_l_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> locally_compatible_l_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Relations-lcr_trans_l"><span class="command">lemma</span></span> lcr_trans_l<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"locally_compatible_r <span class="free">R1</span> <span class="free">R2</span> <span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">B</span><span class="main">)</span> <span class="main">(</span><span class="free">C</span> <span class="main">+</span> <span class="free">D</span><span class="main">)</span> <span class="main">(</span><span class="free">E</span> <span class="main">+</span> <span class="free">F</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"locally_compatible_r <span class="free">R1</span> <span class="free">R2</span> <span class="free">A</span> <span class="free">C</span> <span class="free">E</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">[</span><span class="operator">unfolded</span> locally_compatible_r_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> locally_compatible_r_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Relations-lr_trans_r"><span class="command">lemma</span></span> lr_trans_r<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"locally_refl <span class="free">R</span> <span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"locally_refl <span class="free">R</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> locally_refl_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Relations-li_trans_r"><span class="command">lemma</span></span> li_trans_r<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"locally_irrefl <span class="free">R</span> <span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"locally_irrefl <span class="free">R</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> locally_irrefl_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Relations-ls_trans_r"><span class="command">lemma</span></span> ls_trans_r<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"locally_sym <span class="free">R</span> <span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"locally_sym <span class="free">R</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> locally_sym_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Relations-las_trans_r"><span class="command">lemma</span></span> las_trans_r<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"locally_antisym <span class="free">R</span> <span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"locally_antisym <span class="free">R</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> locally_antisym_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Relations-lt_trans_r"><span class="command">lemma</span></span> lt_trans_r<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"locally_trans <span class="free">R</span> <span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">B</span><span class="main">)</span> <span class="main">(</span><span class="free">C</span> <span class="main">+</span> <span class="free">D</span><span class="main">)</span> <span class="main">(</span><span class="free">E</span> <span class="main">+</span> <span class="free">F</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"locally_trans <span class="free">R</span> <span class="free">B</span> <span class="free">D</span> <span class="free">F</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">[</span><span class="operator">unfolded</span> locally_trans_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> locally_trans_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Relations-lin_trans_r"><span class="command">lemma</span></span> lin_trans_r<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"locally_included <span class="free">R1</span> <span class="free">R2</span> <span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">B</span><span class="main">)</span> <span class="main">(</span><span class="free">C</span> <span class="main">+</span> <span class="free">D</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"locally_included <span class="free">R1</span> <span class="free">R2</span> <span class="free">B</span> <span class="free">D</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> locally_included_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Relations-lcl_trans_r"><span class="command">lemma</span></span> lcl_trans_r<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"locally_compatible_l <span class="free">R1</span> <span class="free">R2</span> <span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">B</span><span class="main">)</span> <span class="main">(</span><span class="free">C</span> <span class="main">+</span> <span class="free">D</span><span class="main">)</span> <span class="main">(</span><span class="free">E</span> <span class="main">+</span> <span class="free">F</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"locally_compatible_l <span class="free">R1</span> <span class="free">R2</span> <span class="free">B</span> <span class="free">D</span> <span class="free">F</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">[</span><span class="operator">unfolded</span> locally_compatible_l_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> locally_compatible_l_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Relations-lcr_trans_r"><span class="command">lemma</span></span> lcr_trans_r<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"locally_compatible_r <span class="free">R1</span> <span class="free">R2</span> <span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">B</span><span class="main">)</span> <span class="main">(</span><span class="free">C</span> <span class="main">+</span> <span class="free">D</span><span class="main">)</span> <span class="main">(</span><span class="free">E</span> <span class="main">+</span> <span class="free">F</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"locally_compatible_r <span class="free">R1</span> <span class="free">R2</span> <span class="free">B</span> <span class="free">D</span> <span class="free">F</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">[</span><span class="operator">unfolded</span> locally_compatible_r_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> locally_compatible_r_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Relations-lr_minus"><span class="command">lemma</span></span> lr_minus<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"locally_refl <span class="free">R</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"locally_refl <span class="free">R</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> locally_refl_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> in_diffD<span class="main">)</span>

<span class="keyword1" id="Relations-li_minus"><span class="command">lemma</span></span> li_minus<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"locally_irrefl <span class="free">R</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"locally_irrefl <span class="free">R</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> locally_irrefl_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> in_diffD<span class="main">)</span>

<span class="keyword1" id="Relations-ls_minus"><span class="command">lemma</span></span> ls_minus<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"locally_sym <span class="free">R</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"locally_sym <span class="free">R</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> locally_sym_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> in_diffD<span class="main">)</span>


<span class="keyword1" id="Relations-las_minus"><span class="command">lemma</span></span> las_minus<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"locally_antisym <span class="free">R</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"locally_antisym <span class="free">R</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> locally_antisym_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> in_diffD<span class="main">)</span>

<span class="keyword1" id="Relations-lt_minus"><span class="command">lemma</span></span> lt_minus<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"locally_trans <span class="free">R</span> <span class="free">A</span> <span class="free">C</span> <span class="free">E</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"locally_trans <span class="free">R</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">B</span><span class="main">)</span> <span class="main">(</span><span class="free">C</span> <span class="main">-</span> <span class="free">D</span><span class="main">)</span> <span class="main">(</span><span class="free">E</span> <span class="main">-</span> <span class="free">F</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">[</span><span class="operator">unfolded</span> locally_trans_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> locally_trans_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> in_diffD<span class="main">)</span>


<span class="keyword1" id="Relations-lin_minus"><span class="command">lemma</span></span> lin_minus<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"locally_included <span class="free">R1</span> <span class="free">R2</span> <span class="free">A</span> <span class="free">C</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"locally_included <span class="free">R1</span> <span class="free">R2</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">B</span><span class="main">)</span> <span class="main">(</span><span class="free">C</span> <span class="main">-</span> <span class="free">D</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> locally_included_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> in_diffD<span class="main">)</span>

<span class="keyword1" id="Relations-lcl_minus"><span class="command">lemma</span></span> lcl_minus<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"locally_compatible_l <span class="free">R1</span> <span class="free">R2</span> <span class="free">A</span> <span class="free">C</span> <span class="free">E</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"locally_compatible_l <span class="free">R1</span> <span class="free">R2</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">B</span><span class="main">)</span> <span class="main">(</span><span class="free">C</span> <span class="main">-</span> <span class="free">D</span><span class="main">)</span> <span class="main">(</span><span class="free">E</span> <span class="main">-</span> <span class="free">F</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">[</span><span class="operator">unfolded</span> locally_compatible_l_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> locally_compatible_l_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> in_diffD<span class="main">)</span>

<span class="keyword1" id="Relations-lcr_minus"><span class="command">lemma</span></span> lcr_minus<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"locally_compatible_r <span class="free">R1</span> <span class="free">R2</span> <span class="free">A</span> <span class="free">C</span> <span class="free">E</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"locally_compatible_r <span class="free">R1</span> <span class="free">R2</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">B</span><span class="main">)</span> <span class="main">(</span><span class="free">C</span> <span class="main">-</span> <span class="free">D</span><span class="main">)</span> <span class="main">(</span><span class="free">E</span> <span class="main">-</span> <span class="free">F</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">[</span><span class="operator">unfolded</span> locally_compatible_r_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> locally_compatible_r_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> in_diffD<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Notations›</span></span>

<span class="keyword1"><span class="command">notation</span></span> restrict <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">↾</span>"</span> 80<span class="main">)</span>

<span class="keyword1" id="Relations-mem_restrictI"><span class="command">lemma</span></span> mem_restrictI<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">↾</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> restrict_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Relations-mem_restrictD"><span class="command">lemma</span></span> mem_restrictD<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">↾</span> <span class="free">X</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> restrict_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="List_Order">
<div class="head">
<h1>Theory List_Order</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Interface for extending an order pair on lists›</span></span>

<span class="keyword1"><span class="command">theory</span></span> List_Order
  <span class="keyword2"><span class="keyword">imports</span></span>
    <a href="../../knuth_bendix_order/theories/#Order_Pair">Knuth_Bendix_Order.Order_Pair</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> list_ext <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rel <span class="main">⇒</span> <span class="tfree">'a</span> rel <span class="main">⇒</span> <span class="tfree">'a</span> list rel"</span></span>

<span class="keyword1"><span class="command">locale</span></span> list_order_extension <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">s_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list_ext"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ns_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list_ext"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> extension<span class="main">:</span> <span class="quoted"><span class="quoted">"SN_order_pair <span class="free">S</span> <span class="free">NS</span> <span class="main">⟹</span> SN_order_pair <span class="main">(</span><span class="free">s_list</span> <span class="free">S</span> <span class="free">NS</span><span class="main">)</span> <span class="main">(</span><span class="free">ns_list</span> <span class="free">S</span> <span class="free">NS</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> s_map<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">⋀</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">f</span> <span class="bound">a</span><span class="main">,</span><span class="free">f</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span><span class="main">;</span> <span class="main">⋀</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> <span class="free">NS</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">f</span> <span class="bound">a</span><span class="main">,</span><span class="free">f</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> <span class="free">NS</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">as</span><span class="main">,</span><span class="free">bs</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s_list</span> <span class="free">S</span> <span class="free">NS</span> <span class="main">⟹</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">as</span><span class="main">,</span> map <span class="free">f</span> <span class="free">bs</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s_list</span> <span class="free">S</span> <span class="free">NS</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> ns_map<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">⋀</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">f</span> <span class="bound">a</span><span class="main">,</span><span class="free">f</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span><span class="main">;</span> <span class="main">⋀</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> <span class="free">NS</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">f</span> <span class="bound">a</span><span class="main">,</span><span class="free">f</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> <span class="free">NS</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">as</span><span class="main">,</span><span class="free">bs</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ns_list</span> <span class="free">S</span> <span class="free">NS</span> <span class="main">⟹</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">as</span><span class="main">,</span> map <span class="free">f</span> <span class="free">bs</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ns_list</span> <span class="free">S</span> <span class="free">NS</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> all_ns_imp_ns<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">as</span> <span class="main">=</span> length <span class="free">bs</span> <span class="main">⟹</span> <span class="main">⟦</span><span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">bs</span> <span class="main">⟹</span>  <span class="main">(</span><span class="free">as</span> <span class="main">!</span> <span class="bound">i</span><span class="main">,</span> <span class="free">bs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">NS</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">as</span><span class="main">,</span><span class="free">bs</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ns_list</span> <span class="free">S</span> <span class="free">NS</span>"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> list_ext_impl <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool <span class="main">×</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> bool <span class="main">×</span> bool"</span></span>

<span class="keyword1"><span class="command">locale</span></span> list_order_extension_impl <span class="main">=</span> list_order_extension <span class="quoted"><span class="free">s_list</span></span> <span class="quoted"><span class="free">ns_list</span></span> <span class="keyword2"><span class="keyword">for</span></span>
  <span class="free">s_list</span> <span class="free">ns_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list_ext"</span></span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">list_ext</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list_ext_impl"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> list_ext_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">s</span> <span class="bound">ns</span><span class="main">.</span> <span class="free">s_list</span> <span class="main">{</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="bound">s</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">}</span> <span class="main">{</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="bound">ns</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">as</span><span class="main">,</span><span class="bound">bs</span><span class="main">)</span><span class="main">.</span> fst <span class="main">(</span><span class="free">list_ext</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="bound">s</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">,</span> <span class="bound">ns</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="bound">as</span> <span class="bound">bs</span><span class="main">)</span><span class="main">}</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span>  list_ext_ns<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">s</span> <span class="bound">ns</span><span class="main">.</span> <span class="free">ns_list</span> <span class="main">{</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="bound">s</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">}</span> <span class="main">{</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="bound">ns</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">as</span><span class="main">,</span><span class="bound">bs</span><span class="main">)</span><span class="main">.</span> snd <span class="main">(</span><span class="free">list_ext</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="bound">s</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">,</span> <span class="bound">ns</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="bound">as</span> <span class="bound">bs</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> s_ext_local_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">s</span> <span class="bound">ns</span> <span class="bound">s'</span> <span class="bound">ns'</span> <span class="bound">as</span> <span class="bound">bs</span><span class="main">.</span> <span class="main">(</span>set <span class="bound">as</span> <span class="main">×</span> set <span class="bound">bs</span><span class="main">)</span> <span class="main">∩</span> <span class="bound">ns</span> <span class="main">⊆</span> <span class="bound">ns'</span> <span class="main">⟹</span> <span class="main">(</span>set <span class="bound">as</span> <span class="main">×</span> set <span class="bound">bs</span><span class="main">)</span> <span class="main">∩</span> <span class="bound">s</span> <span class="main">⊆</span> <span class="bound">s'</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">as</span><span class="main">,</span><span class="bound">bs</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s_list</span> <span class="bound">ns</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">as</span><span class="main">,</span><span class="bound">bs</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s_list</span> <span class="bound">ns'</span> <span class="bound">s'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ns_ext_local_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">s</span> <span class="bound">ns</span> <span class="bound">s'</span> <span class="bound">ns'</span> <span class="bound">as</span> <span class="bound">bs</span><span class="main">.</span> <span class="main">(</span>set <span class="bound">as</span> <span class="main">×</span> set <span class="bound">bs</span><span class="main">)</span> <span class="main">∩</span> <span class="bound">ns</span> <span class="main">⊆</span> <span class="bound">ns'</span> <span class="main">⟹</span> <span class="main">(</span>set <span class="bound">as</span> <span class="main">×</span> set <span class="bound">bs</span><span class="main">)</span> <span class="main">∩</span> <span class="bound">s</span> <span class="main">⊆</span> <span class="bound">s'</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">as</span><span class="main">,</span><span class="bound">bs</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ns_list</span> <span class="bound">ns</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">as</span><span class="main">,</span><span class="bound">bs</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ns_list</span> <span class="bound">ns'</span> <span class="bound">s'</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Multiset_Extension_Pair">
<div class="head">
<h1>Theory Multiset_Extension_Pair</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Multiset extension of an order pair›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Given a well-founded order $\prec$ and a compatible non-strict order $\precsim$,
  we define the corresponding multiset-extension of these orders.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Multiset_Extension_Pair
  <span class="keyword2"><span class="keyword">imports</span></span> 
    <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Multiset.html">HOL-Library.Multiset</a>"</span> 
    <span class="quoted">"<a href="../Regular-Sets/Regexp_Method.html">Regular-Sets.Regexp_Method</a>"</span>
    <span class="quoted">"<a href="../Abstract-Rewriting/Abstract_Rewriting.html">Abstract-Rewriting.Abstract_Rewriting</a>"</span> 
    <a href="#Relations">Relations</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(* Possible to generalize by assuming trans locally *)</span>

<span class="keyword1" id="Multiset_Extension_Pair-mult_locally_cancel"><span class="command">lemma</span></span> mult_locally_cancel<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">s</span> "</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"locally_irrefl <span class="free">s</span> <span class="main">(</span><span class="free">X</span> <span class="main">+</span> <span class="free">Z</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"locally_irrefl <span class="free">s</span> <span class="main">(</span><span class="free">Y</span> <span class="main">+</span> <span class="free">Z</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X</span> <span class="main">+</span> <span class="free">Z</span><span class="main">,</span> <span class="free">Y</span> <span class="main">+</span> <span class="free">Z</span><span class="main">)</span> <span class="main">∈</span> mult <span class="free">s</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> mult <span class="free">s</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">⟷</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span> 3<span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Z</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">X</span></span> <span class="quoted"><span class="free">Y</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>add <span class="skolem">z</span> <span class="skolem">Z</span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X'</span></span> <span class="skolem"><span class="skolem">Y'</span></span> <span class="skolem"><span class="skolem">Z'</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"add_mset <span class="skolem">z</span> <span class="skolem">X</span> <span class="main">+</span> <span class="skolem">Z</span> <span class="main">=</span> <span class="skolem">Z'</span> <span class="main">+</span> <span class="skolem">X'</span>"</span></span> <span class="quoted"><span class="quoted">"add_mset <span class="skolem">z</span> <span class="skolem">Y</span> <span class="main">+</span> <span class="skolem">Z</span> <span class="main">=</span> <span class="skolem">Z'</span> <span class="main">+</span> <span class="skolem">Y'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y'</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set_mset <span class="skolem">X'</span><span class="main">.</span> <span class="main">∃</span><span class="bound">y</span> <span class="main">∈</span> set_mset <span class="skolem">Y'</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> mult_implies_one_step<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹trans <span class="free">s</span>›</span></span> add<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">consider</span></span> <span class="skolem">Z2</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Z'</span> <span class="main">=</span> add_mset <span class="skolem">z</span> <span class="skolem">Z2</span>"</span></span> <span class="main">|</span> <span class="skolem">X2</span> <span class="skolem">Y2</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X'</span> <span class="main">=</span> add_mset <span class="skolem">z</span> <span class="skolem">X2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y'</span> <span class="main">=</span> add_mset <span class="skolem">z</span> <span class="skolem">Y2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> *<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_mset_remove_trivial_If insert_iff set_mset_add_mset_insert union_iff<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> * one_step_implies_mult<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">Y'</span></span> <span class="quoted"><span class="skolem">X'</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="skolem">Z2</span></span><span class="main">]</span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add.commute<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="main">_</span><span class="main">#}</span>"</span></span><span class="main"><span class="main">]</span></span> add.assoc <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> add<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
          <span class="main">(</span><span class="operator">metis</span> add.hyps add.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> add.prems<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> add_mset_add_single li_trans_l union_mset_add_mset_right<span class="main">)</span> 
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> set_mset <span class="skolem">Y2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">z</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> *<span class="main">(</span>4<span class="main">)</span> add<span class="main">(</span>3<span class="main">,</span> 4<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> locally_irrefl_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this transD<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹trans <span class="free">s</span>›</span></span> _ this<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">∈</span> set_mset <span class="skolem">X2</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">y</span> <span class="main">∈</span> set_mset <span class="skolem">Y2</span><span class="main">.</span> <span class="main">(</span><span class="skolem">x'</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x'</span>
        <span class="keyword1"><span class="command">using</span></span> 2 *<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">x'</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span>  * one_step_implies_mult<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">Y2</span></span> <span class="quoted"><span class="skolem">X2</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="skolem">Z'</span></span><span class="main">]</span> 2 add<span class="main">(</span>3<span class="main">,</span> 4<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> locally_irrefl_def add.commute<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="main">_</span><span class="main">#}</span>"</span></span><span class="main"><span class="main">]</span></span> add.assoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> add<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="skolem"><span class="skolem">J</span></span> <span class="skolem"><span class="skolem">K</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">=</span> <span class="skolem">I</span> <span class="main">+</span> <span class="skolem">J</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="skolem">I</span> <span class="main">+</span> <span class="skolem">K</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">J</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span> <span class="main">∈</span> set_mset <span class="skolem">K</span><span class="main">.</span> <span class="main">∃</span><span class="bound">j</span> <span class="main">∈</span> set_mset <span class="skolem">J</span><span class="main">.</span> <span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> mult_implies_one_step<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹trans <span class="free">s</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span> <span class="keyword1"><span class="command">using</span></span> one_step_implies_mult<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">J</span></span> <span class="quoted"><span class="skolem">K</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">+</span> <span class="free">Z</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Multiset_Extension_Pair-mult_locally_cancelL"><span class="command">lemma</span></span> mult_locally_cancelL<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"locally_irrefl <span class="free">s</span> <span class="main">(</span><span class="free">X</span> <span class="main">+</span> <span class="free">Z</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"locally_irrefl <span class="free">s</span> <span class="main">(</span><span class="free">Y</span> <span class="main">+</span> <span class="free">Z</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Z</span> <span class="main">+</span> <span class="free">X</span><span class="main">,</span> <span class="free">Z</span> <span class="main">+</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> mult <span class="free">s</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> mult <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> mult_locally_cancel<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> union_commute<span class="main">)</span>

<span class="keyword1" id="Multiset_Extension_Pair-mult_cancelL"><span class="command">lemma</span></span> mult_cancelL<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"irrefl <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Z</span> <span class="main">+</span> <span class="free">X</span><span class="main">,</span> <span class="free">Z</span> <span class="main">+</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> mult <span class="free">s</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> mult <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms mult_locally_cancelL <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_cancel union_commute<span class="main">)</span> 

<span class="keyword1" id="Multiset_Extension_Pair-wf_trancl_conv"><span class="command">lemma</span></span> wf_trancl_conv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf <span class="main">(</span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span><span class="main">)</span> <span class="main">⟷</span> wf <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> wf_subset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wf_trancl<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Pointwise multiset order›</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span> <span class="entity">multpw</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rel <span class="main">⇒</span> <span class="tfree">'a</span> multiset rel"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">ns</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rel"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{#}</span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span> <span class="main">∈</span> <span class="free">multpw</span> <span class="free">ns</span>"</span></span>
<span class="main">|</span> add<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">ns</span> <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">multpw</span> <span class="free">ns</span> <span class="main">⟹</span> <span class="main">(</span>add_mset <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">,</span> add_mset <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">multpw</span> <span class="free">ns</span>"</span></span>

<span class="keyword1" id="Multiset_Extension_Pair-multpw_emptyL"><span class="command">lemma</span></span> multpw_emptyL <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{#}</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free">ns</span> <span class="main">⟷</span> <span class="free">X</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">X</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> multpw.cases <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> multpw.intros<span class="main">)</span>

<span class="keyword1" id="Multiset_Extension_Pair-multpw_emptyR"><span class="command">lemma</span></span> multpw_emptyR <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free">ns</span> <span class="main">⟷</span> <span class="free">X</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">X</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> multpw.cases <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> multpw.intros<span class="main">)</span>

<span class="keyword1" id="Multiset_Extension_Pair-refl_multpw"><span class="command">lemma</span></span> refl_multpw<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"refl <span class="free">ns</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"refl <span class="main">(</span>multpw <span class="free">ns</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">X</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free">ns</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">X</span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">X</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> multpw.intros <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> refl_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> refl_on_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Multiset_Extension_Pair-multpw_Id_Id"><span class="command">lemma</span></span> multpw_Id_Id <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"multpw Id <span class="main">=</span> Id"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">X</span><span class="main">,</span> <span class="skolem">Y</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="main">(</span>Id <span class="main">::</span> <span class="tfree">'a</span> rel<span class="main">)</span> <span class="main">⟹</span> <span class="skolem">X</span> <span class="main">=</span> <span class="skolem">Y</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">X</span> <span class="skolem">Y</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">X</span></span> <span class="quoted"><span class="skolem">Y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> multpw.induct<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> refl_multpw<span class="main">[</span><span class="operator">of</span> <span class="quoted">Id</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> refl_on_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Multiset_Extension_Pair-mono_multpw"><span class="command">lemma</span></span> mono_multpw<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ns</span> <span class="main">⊆</span> <span class="free">ns'</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"multpw <span class="free">ns</span> <span class="main">⊆</span> multpw <span class="free">ns'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">X</span><span class="main">,</span> <span class="skolem">Y</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free">ns</span> <span class="main">⟹</span> <span class="main">(</span><span class="skolem">X</span><span class="main">,</span> <span class="skolem">Y</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free">ns'</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">X</span> <span class="skolem">Y</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">X</span></span> <span class="quoted"><span class="skolem">Y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> multpw.induct<span class="main">)</span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> multpw.intros<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Multiset_Extension_Pair-multpw_converse"><span class="command">lemma</span></span> multpw_converse<span class="main">:</span>
  <span class="quoted"><span class="quoted">"multpw <span class="main">(</span><span class="free">ns</span><span class="main">¯</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>multpw <span class="free">ns</span><span class="main">)</span><span class="main">¯</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">X</span><span class="main">,</span> <span class="skolem">Y</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="main">(</span><span class="skolem">ns</span><span class="main">¯</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="skolem">X</span><span class="main">,</span> <span class="skolem">Y</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>multpw <span class="skolem">ns</span><span class="main">)</span><span class="main">¯</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">X</span> <span class="skolem">Y</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">ns</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rel"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">X</span></span> <span class="quoted"><span class="skolem">Y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> multpw.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> multpw.intros<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Multiset_Extension_Pair-multpw_local"><span class="command">lemma</span></span> multpw_local<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free">ns</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="main">(</span><span class="free">ns</span> <span class="main">∩</span> set_mset <span class="free">X</span> <span class="main">×</span> set_mset <span class="free">Y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">X</span></span> <span class="quoted"><span class="free">Y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> multpw.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>add <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">X</span> <span class="skolem">Y</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> mono_multpw<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">ns</span> <span class="main">∩</span> set_mset <span class="skolem">X</span> <span class="main">×</span> set_mset <span class="skolem">Y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ns</span> <span class="main">∩</span> insert <span class="skolem">x</span> <span class="main">(</span>set_mset <span class="skolem">X</span><span class="main">)</span> <span class="main">×</span> insert <span class="skolem">y</span> <span class="main">(</span>set_mset <span class="skolem">Y</span><span class="main">)</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> multpw.intros<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Multiset_Extension_Pair-multpw_split1R"><span class="command">lemma</span></span> multpw_split1R<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>add_mset <span class="free">x</span> <span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free">ns</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">z</span> <span class="free">Z</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">=</span> add_mset <span class="free">z</span> <span class="free">Z</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">z</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ns</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="free">Z</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free">ns</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span>  <span class="quoted"><span class="quoted">"add_mset <span class="free">x</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="free">Y</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">X</span></span> <span class="quoted"><span class="free">thesis</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> multpw.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>add <span class="skolem">x'</span> <span class="skolem">y'</span> <span class="skolem">X'</span> <span class="skolem">Y'</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="skolem">x'</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> add_mset <span class="skolem">x'</span> <span class="skolem">X''</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> add<span class="main">(</span>4<span class="main">)</span> False
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_eq_conv_diff<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X'</span> <span class="main">=</span> add_mset <span class="free">x</span> <span class="skolem">X''</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> add<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_eq_conv_ex<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> add<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Y''</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y'</span> <span class="main">=</span> add_mset <span class="skolem">y</span> <span class="skolem">Y''</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ns</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">X''</span><span class="main">,</span> <span class="skolem">Y''</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free">ns</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> add<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> add<span class="main">(</span>1<span class="main">)</span> add<span class="main">(</span>5<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="quoted">"add_mset <span class="skolem">y'</span> <span class="skolem">Y''</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> multpw.intros<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Multiset_Extension_Pair-multpw_splitR"><span class="command">lemma</span></span> multpw_splitR<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X1</span> <span class="main">+</span> <span class="free">X2</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free">ns</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">Y1</span> <span class="free">Y2</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">=</span> <span class="free">Y1</span> <span class="main">+</span> <span class="free">Y2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X1</span><span class="main">,</span> <span class="free">Y1</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free">ns</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X2</span><span class="main">,</span> <span class="free">Y2</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free">ns</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">X2</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Y</span></span> <span class="quoted"><span class="free">thesis</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>add <span class="skolem">x2</span> <span class="skolem">X2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> add<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Y'</span></span> <span class="skolem"><span class="skolem">y2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X1</span> <span class="main">+</span> <span class="skolem">X2</span><span class="main">,</span> <span class="skolem">Y'</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free">ns</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x2</span><span class="main">,</span> <span class="skolem">y2</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ns</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">=</span> add_mset <span class="skolem">y2</span> <span class="skolem">Y'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> multpw_split1R <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> union_assoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Y1</span></span> <span class="skolem"><span class="skolem">Y2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X1</span><span class="main">,</span> <span class="skolem">Y1</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free">ns</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">X2</span><span class="main">,</span> <span class="skolem">Y2</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free">ns</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y'</span> <span class="main">=</span> <span class="skolem">Y1</span> <span class="main">+</span> <span class="skolem">Y2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> add<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> add<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> union_assoc <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> multpw.intros<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Multiset_Extension_Pair-multpw_split1L"><span class="command">lemma</span></span> multpw_split1L<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X</span><span class="main">,</span> add_mset <span class="free">y</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free">ns</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">z</span> <span class="free">Z</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> add_mset <span class="free">z</span> <span class="free">Z</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">z</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ns</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Z</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free">ns</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms multpw_split1R<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="free">Y</span></span> <span class="quoted"><span class="free">X</span></span> <span class="quoted"><span class="quoted">"<span class="free">ns</span><span class="main">¯</span>"</span></span> <span class="quoted"><span class="free">thesis</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> multpw_converse<span class="main">)</span>

<span class="keyword1" id="Multiset_Extension_Pair-multpw_splitL"><span class="command">lemma</span></span> multpw_splitL<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="free">Y1</span> <span class="main">+</span> <span class="free">Y2</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free">ns</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">X1</span> <span class="free">X2</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="free">X1</span> <span class="main">+</span> <span class="free">X2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X1</span><span class="main">,</span> <span class="free">Y1</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free">ns</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X2</span><span class="main">,</span> <span class="free">Y2</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free">ns</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms multpw_splitR<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">Y1</span></span> <span class="quoted"><span class="free">Y2</span></span> <span class="quoted"><span class="free">X</span></span> <span class="quoted"><span class="quoted">"<span class="free">ns</span><span class="main">¯</span>"</span></span> <span class="quoted"><span class="free">thesis</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> multpw_converse<span class="main">)</span>

<span class="keyword1" id="Multiset_Extension_Pair-locally_trans_multpw"><span class="command">lemma</span></span> locally_trans_multpw<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"locally_trans <span class="free">ns</span> <span class="free">S</span> <span class="free">T</span> <span class="free">U</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">S</span><span class="main">,</span> <span class="free">T</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free">ns</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">T</span><span class="main">,</span> <span class="free">U</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free">ns</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">S</span><span class="main">,</span> <span class="free">U</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free">ns</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">,</span>1<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">U</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> multpw.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>add <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">X</span> <span class="skolem">Y</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> locally_trans_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> multpw.intros <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> multpw_split1R<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Multiset_Extension_Pair-trans_multpw"><span class="command">lemma</span></span> trans_multpw<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">ns</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"trans <span class="main">(</span>multpw <span class="free">ns</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> locally_trans_multpw <span class="keyword1"><span class="command">unfolding</span></span> locally_trans_def trans_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms locally_trans_multpw tr_ltr<span class="main">)</span>

<span class="keyword1" id="Multiset_Extension_Pair-multpw_add"><span class="command">lemma</span></span> multpw_add<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X1</span><span class="main">,</span> <span class="free">Y1</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free">ns</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X2</span><span class="main">,</span> <span class="free">Y2</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free">ns</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X1</span> <span class="main">+</span> <span class="free">X2</span><span class="main">,</span> <span class="free">Y1</span> <span class="main">+</span> <span class="free">Y2</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free">ns</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">X2</span></span> <span class="quoted"><span class="free">Y2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> multpw.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> multpw.intros <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add.assoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Multiset_Extension_Pair-multpw_single"><span class="command">lemma</span></span> multpw_single<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ns</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">{#</span><span class="free">x</span><span class="main">#}</span><span class="main">,</span> <span class="main">{#</span><span class="free">y</span><span class="main">#}</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free">ns</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> multpw.intros<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> _ multpw.intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="Multiset_Extension_Pair-multpw_mult1_commute"><span class="command">lemma</span></span> multpw_mult1_commute<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> compat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="keyword1">O</span> <span class="free">ns</span> <span class="main">⊆</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> reflns<span class="main">:</span> <span class="quoted"><span class="quoted">"refl <span class="free">ns</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mult1 <span class="free">s</span> <span class="keyword1">O</span> multpw <span class="free">ns</span> <span class="main">⊆</span> multpw <span class="free">ns</span> <span class="keyword1">O</span> mult1 <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="skolem">Y</span> <span class="skolem">Z</span> <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">X</span><span class="main">,</span> <span class="skolem">Y</span><span class="main">)</span> <span class="main">∈</span> mult1 <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Y</span><span class="main">,</span> <span class="skolem">Z</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free">ns</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X'</span></span> <span class="skolem"><span class="skolem">Y'</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> <span class="skolem">Y'</span> <span class="main">+</span> <span class="skolem">X'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">=</span> add_mset <span class="skolem">y</span> <span class="skolem">Y'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="skolem">X'</span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mult1_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Z'</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Z</span> <span class="main">=</span> add_mset <span class="skolem">z</span> <span class="skolem">Z'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">y</span><span class="main">,</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ns</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Y'</span><span class="main">,</span> <span class="skolem">Z'</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free">ns</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>2<span class="main">)</span> 2<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> multpw_split1R<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="skolem">X'</span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>3<span class="main">)</span> 3<span class="main">(</span>2<span class="main">)</span> compat <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Y'</span><span class="main">.</span> <span class="main">(</span><span class="skolem">X</span><span class="main">,</span> <span class="bound">Y'</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free">ns</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">Y'</span><span class="main">,</span> <span class="skolem">Z</span><span class="main">)</span> <span class="main">∈</span> mult1 <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> mult1_def
      <span class="keyword1"><span class="command">using</span></span> refl_multpw<span class="main">[</span><span class="operator">OF</span> reflns<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem"><span class="skolem">Z'</span></span></span> <span class="main"><span class="main"><span class="main">+</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">X'</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> multpw_add <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> refl_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Multiset_Extension_Pair-multpw_mult_commute"><span class="command">lemma</span></span> multpw_mult_commute<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="keyword1">O</span> <span class="free">ns</span> <span class="main">⊆</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"refl <span class="free">ns</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mult <span class="free">s</span> <span class="keyword1">O</span> multpw <span class="free">ns</span> <span class="main">⊆</span> multpw <span class="free">ns</span> <span class="keyword1">O</span> mult <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="skolem">Y</span> <span class="skolem">Z</span> <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">X</span><span class="main">,</span> <span class="skolem">Y</span><span class="main">)</span> <span class="main">∈</span> mult <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Y</span><span class="main">,</span> <span class="skolem">Z</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free">ns</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Y'</span><span class="main">.</span> <span class="main">(</span><span class="skolem">X</span><span class="main">,</span> <span class="bound">Y'</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free">ns</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">Y'</span><span class="main">,</span> <span class="skolem">Z</span><span class="main">)</span> <span class="main">∈</span> mult <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> mult_def
      <span class="keyword1"><span class="command">using</span></span> multpw_mult1_commute<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> converse_trancl_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> 0 3<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Multiset_Extension_Pair-wf_mult_rel_multpw"><span class="command">lemma</span></span> wf_mult_rel_multpw<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="keyword1">O</span> <span class="free">ns</span> <span class="main">⊆</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"refl <span class="free">ns</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf <span class="main">(</span><span class="main">(</span>multpw <span class="free">ns</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="keyword1">O</span> mult <span class="free">s</span> <span class="keyword1">O</span> <span class="main">(</span>multpw <span class="free">ns</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> multpw_mult_commute<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> qc_wf_relto_iff<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wf_mult<span class="main">)</span>

<span class="keyword1" id="Multiset_Extension_Pair-multpw_cancel1"><span class="command">lemma</span></span> multpw_cancel1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">ns</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">y</span><span class="main">,</span> <span class="free">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ns</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>add_mset <span class="free">x</span> <span class="free">X</span><span class="main">,</span> add_mset <span class="free">y</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free">ns</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free">ns</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">⟹</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="skolem"><span class="skolem">X'</span></span> <span class="keyword2"><span class="keyword">where</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x'</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ns</span>"</span></span> <span class="quoted"><span class="quoted">"add_mset <span class="skolem">x'</span> <span class="skolem">X'</span> <span class="main">=</span> add_mset <span class="free">x</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">X'</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free">ns</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> multpw_split1L <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> union_assoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="skolem">x'</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X2</span></span> <span class="keyword2"><span class="keyword">where</span></span> X2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X'</span> <span class="main">=</span> add_mset <span class="free">x</span> <span class="skolem">X2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> add_mset <span class="skolem">x'</span> <span class="skolem">X2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> X<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_eq_conv_ex<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y'</span></span> <span class="skolem"><span class="skolem">Y'</span></span> <span class="keyword2"><span class="keyword">where</span></span> Y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="skolem">y'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ns</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">=</span> add_mset <span class="skolem">y'</span> <span class="skolem">Y'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">X2</span><span class="main">,</span> <span class="skolem">Y'</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free">ns</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> X<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> multpw_split1R<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x'</span><span class="main">,</span> <span class="skolem">y'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ns</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> X<span class="main">(</span>1<span class="main">)</span> Y<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹trans <span class="free">ns</span>›</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> trans_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Y <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> multpw.intros <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> X2<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Multiset_Extension_Pair-multpw_cancel"><span class="command">lemma</span></span> multpw_cancel<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"refl <span class="free">ns</span>"</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">ns</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X</span> <span class="main">+</span> <span class="free">Z</span><span class="main">,</span> <span class="free">Y</span> <span class="main">+</span> <span class="free">Z</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free">ns</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free">ns</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">⟷</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Z</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>add <span class="skolem">z</span> <span class="skolem">Z</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> multpw_cancel1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">ns</span></span> <span class="quoted"><span class="skolem">z</span></span> <span class="quoted"><span class="skolem">z</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">+</span> <span class="skolem">Z</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">+</span> <span class="skolem">Z</span>"</span></span><span class="main">]</span> assms
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> refl_on_def union_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms refl_multpw <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> multpw_add <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> refl_on_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Multiset_Extension_Pair-multpw_cancelL"><span class="command">lemma</span></span> multpw_cancelL<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"refl <span class="free">ns</span>"</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">ns</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Z</span> <span class="main">+</span> <span class="free">X</span><span class="main">,</span> <span class="free">Z</span> <span class="main">+</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free">ns</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free">ns</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> multpw_cancel<span class="main">[</span><span class="operator">OF</span> assms<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">X</span></span> <span class="quoted"><span class="free">Z</span></span> <span class="quoted"><span class="free">Y</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> union_commute<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Multiset extension for order pairs via the pointwise order and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> mult<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">mult2_s</span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> multpw <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="keyword1">O</span> mult <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">mult2_ns</span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> multpw <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="keyword1">O</span> <span class="main">(</span>mult <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>=</sup></span>"</span></span>

<span class="keyword1" id="Multiset_Extension_Pair-mult2_ns_conv"><span class="command">lemma</span></span> mult2_ns_conv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mult2_ns <span class="free">ns</span> <span class="free">s</span> <span class="main">=</span> mult2_s <span class="free">ns</span> <span class="free">s</span> <span class="main">∪</span> multpw <span class="free">ns</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mult2_s_def mult2_ns_def<span class="main">)</span>

<span class="keyword1" id="Multiset_Extension_Pair-mono_mult2_s"><span class="command">lemma</span></span> mono_mult2_s<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ns</span> <span class="main">⊆</span> <span class="free">ns'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⊆</span> <span class="free">s'</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mult2_s <span class="free">ns</span> <span class="free">s</span> <span class="main">⊆</span> mult2_s <span class="free">ns'</span> <span class="free">s'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> mono_multpw<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> mono_mult<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> mult2_s_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Multiset_Extension_Pair-mono_mult2_ns"><span class="command">lemma</span></span> mono_mult2_ns<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ns</span> <span class="main">⊆</span> <span class="free">ns'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⊆</span> <span class="free">s'</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mult2_ns <span class="free">ns</span> <span class="free">s</span> <span class="main">⊆</span> mult2_ns <span class="free">ns'</span> <span class="free">s'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> mono_multpw<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> mono_mult<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> mult2_ns_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Multiset_Extension_Pair-wf_mult2_s"><span class="command">lemma</span></span> wf_mult2_s<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="keyword1">O</span> <span class="free">ns</span> <span class="main">⊆</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"refl <span class="free">ns</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf <span class="main">(</span>mult2_s <span class="free">ns</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> wf_mult_rel_multpw<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mult2_s_def wf_mult <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> wf_subset<span class="main">)</span>

<span class="keyword1" id="Multiset_Extension_Pair-refl_mult2_ns"><span class="command">lemma</span></span> refl_mult2_ns<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"refl <span class="free">ns</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"refl <span class="main">(</span>mult2_ns <span class="free">ns</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> refl_multpw<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> mult2_ns_def refl_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Multiset_Extension_Pair-trans_mult2_s"><span class="command">lemma</span></span> trans_mult2_s<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="keyword1">O</span> <span class="free">ns</span> <span class="main">⊆</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"refl <span class="free">ns</span>"</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">ns</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"trans <span class="main">(</span>mult2_s <span class="free">ns</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> trans_multpw<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> trans_trancl<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"mult1 <span class="free">s</span>"</span></span><span class="main">,</span> <span class="operator">folded</span> mult_def<span class="main">]</span> multpw_mult_commute<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> mult2_s_def trans_O_iff <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> 8<span class="main">)</span>

<span class="keyword1" id="Multiset_Extension_Pair-trans_mult2_ns"><span class="command">lemma</span></span> trans_mult2_ns<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="keyword1">O</span> <span class="free">ns</span> <span class="main">⊆</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"refl <span class="free">ns</span>"</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">ns</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"trans <span class="main">(</span>mult2_ns <span class="free">ns</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> trans_multpw<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> trans_trancl<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"mult1 <span class="free">s</span>"</span></span><span class="main">,</span> <span class="operator">folded</span> mult_def<span class="main">]</span> multpw_mult_commute<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> mult2_ns_def trans_O_iff <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> 8<span class="main">)</span>

<span class="keyword1" id="Multiset_Extension_Pair-compat_mult2"><span class="command">lemma</span></span> compat_mult2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="keyword1">O</span> <span class="free">ns</span> <span class="main">⊆</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"refl <span class="free">ns</span>"</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">ns</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mult2_ns <span class="free">ns</span> <span class="free">s</span> <span class="keyword1">O</span> mult2_s <span class="free">ns</span> <span class="free">s</span> <span class="main">⊆</span> mult2_s <span class="free">ns</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"mult2_s <span class="free">ns</span> <span class="free">s</span> <span class="keyword1">O</span> mult2_ns <span class="free">ns</span> <span class="free">s</span> <span class="main">⊆</span> mult2_s <span class="free">ns</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> trans_multpw<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> trans_trancl<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"mult1 <span class="free">s</span>"</span></span><span class="main">,</span> <span class="operator">folded</span> mult_def<span class="main">]</span> multpw_mult_commute<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> mult2_s_def mult2_ns_def trans_O_iff <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> 8<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Trivial inclusions›</span></span>

<span class="keyword1" id="Multiset_Extension_Pair-mult_implies_mult2_s"><span class="command">lemma</span></span> mult_implies_mult2_s<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"refl <span class="free">ns</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> mult <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> mult2_s <span class="free">ns</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> refl_multpw<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">ns</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">unfolding</span></span> mult2_s_def refl_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Multiset_Extension_Pair-mult_implies_mult2_ns"><span class="command">lemma</span></span> mult_implies_mult2_ns<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"refl <span class="free">ns</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>mult <span class="free">s</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>=</sup></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> mult2_ns <span class="free">ns</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> refl_multpw<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">ns</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">unfolding</span></span> mult2_ns_def refl_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Multiset_Extension_Pair-multpw_implies_mult2_ns"><span class="command">lemma</span></span> multpw_implies_mult2_ns<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free">ns</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> mult2_ns <span class="free">ns</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mult2_ns_def <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹One-step versions of the multiset extensions›</span></span>

<span class="keyword1" id="Multiset_Extension_Pair-mult2_s_one_step"><span class="command">lemma</span></span> mult2_s_one_step<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ns</span> <span class="keyword1">O</span> <span class="free">s</span> <span class="main">⊆</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"refl <span class="free">ns</span>"</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> mult2_s <span class="free">ns</span> <span class="free">s</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">X1</span> <span class="bound">X2</span> <span class="bound">Y1</span> <span class="bound">Y2</span><span class="main">.</span> <span class="free">X</span> <span class="main">=</span> <span class="bound">X1</span> <span class="main">+</span> <span class="bound">X2</span> <span class="main">∧</span> <span class="free">Y</span> <span class="main">=</span> <span class="bound">Y1</span> <span class="main">+</span> <span class="bound">Y2</span> <span class="main">∧</span>
    <span class="main">(</span><span class="bound">X1</span><span class="main">,</span> <span class="bound">Y1</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free">ns</span> <span class="main">∧</span> <span class="bound">Y2</span> <span class="main">≠</span> <span class="main">{#}</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="bound">X2</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈#</span> <span class="bound">Y2</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">⟷</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X1</span></span> <span class="skolem"><span class="skolem">X2</span></span> <span class="skolem"><span class="skolem">Y1</span></span> <span class="skolem"><span class="skolem">Y2</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="skolem">X1</span> <span class="main">+</span> <span class="skolem">X2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">=</span> <span class="skolem">Y1</span> <span class="main">+</span> <span class="skolem">Y2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">X1</span><span class="main">,</span> <span class="skolem">Y1</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free">ns</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">Y2</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="skolem">X2</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈#</span> <span class="skolem">Y2</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Y1</span> <span class="main">+</span> <span class="skolem">X2</span><span class="main">,</span> <span class="skolem">Y1</span> <span class="main">+</span> <span class="skolem">Y2</span><span class="main">)</span> <span class="main">∈</span> mult <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹trans <span class="free">s</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> one_step_implies_mult<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">X1</span> <span class="main">+</span> <span class="skolem">X2</span><span class="main">,</span> <span class="skolem">Y1</span> <span class="main">+</span> <span class="skolem">X2</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free">ns</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹refl <span class="free">ns</span>›</span></span> refl_multpw<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">ns</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> multpw_add <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> refl_on_def *<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mult2_s_def *<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X1</span></span> <span class="skolem"><span class="skolem">X2</span></span> <span class="skolem"><span class="skolem">Z1</span></span> <span class="skolem"><span class="skolem">Z2</span></span> <span class="skolem"><span class="skolem">Y2</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="skolem">X1</span> <span class="main">+</span> <span class="skolem">X2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">=</span> <span class="skolem">Z1</span> <span class="main">+</span> <span class="skolem">Y2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">X1</span><span class="main">,</span> <span class="skolem">Z1</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free">ns</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">X2</span><span class="main">,</span> <span class="skolem">Z2</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free">ns</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y2</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="skolem">Z2</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈#</span> <span class="skolem">Y2</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mult_implies_one_step<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹trans <span class="free">s</span>›</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mult2_s_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> multpw_splitL<span class="main">)</span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="skolem">X2</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈#</span> <span class="skolem">Y2</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈#</span> <span class="skolem">X2</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X2'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X2</span> <span class="main">=</span> add_mset <span class="skolem">x</span> <span class="skolem">X2'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> multi_member_split<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="skolem"><span class="skolem">Z2'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Z2</span> <span class="main">=</span> add_mset <span class="skolem">z</span> <span class="skolem">Z2'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ns</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> *<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> multpw_split1R<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈#</span> <span class="skolem">Z2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ns</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈#</span> <span class="skolem">Y2</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> *<span class="main">(</span>6<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="free">ns</span> <span class="keyword1">O</span> <span class="free">s</span> <span class="main">⊆</span> <span class="free">s</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Multiset_Extension_Pair-mult2_ns_one_step"><span class="command">lemma</span></span> mult2_ns_one_step<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ns</span> <span class="keyword1">O</span> <span class="free">s</span> <span class="main">⊆</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"refl <span class="free">ns</span>"</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> mult2_ns <span class="free">ns</span> <span class="free">s</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">X1</span> <span class="bound">X2</span> <span class="bound">Y1</span> <span class="bound">Y2</span><span class="main">.</span> <span class="free">X</span> <span class="main">=</span> <span class="bound">X1</span> <span class="main">+</span> <span class="bound">X2</span> <span class="main">∧</span> <span class="free">Y</span> <span class="main">=</span> <span class="bound">Y1</span> <span class="main">+</span> <span class="bound">Y2</span> <span class="main">∧</span>
    <span class="main">(</span><span class="bound">X1</span><span class="main">,</span> <span class="bound">Y1</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free">ns</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="bound">X2</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈#</span> <span class="bound">Y2</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">⟷</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free">ns</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> mult2_s <span class="free">ns</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mult2_s_def mult2_ns_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span> <span class="keyword1"><span class="command">using</span></span> mult2_s_one_step<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">{#}</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> exI<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">of</span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">Y</span></span></span></span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">THEN</span> exI<span class="main"><span class="main"><span class="main"><span class="main">[</span></span></span></span><span class="operator">of</span> <span class="main"><span class="main"><span class="main"><span class="main">_</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">{#}</span></span></span>"</span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main">,</span></span></span></span> <span class="operator">THEN</span> exI<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">[</span></span></span></span></span><span class="operator">of</span> <span class="main"><span class="main"><span class="main"><span class="main"><span class="main">_</span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">X</span></span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">]</span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main">]</span></span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X1</span></span> <span class="skolem"><span class="skolem">X2</span></span> <span class="skolem"><span class="skolem">Y1</span></span> <span class="skolem"><span class="skolem">Y2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="skolem">X1</span> <span class="main">+</span> <span class="skolem">X2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">=</span> <span class="skolem">Y1</span> <span class="main">+</span> <span class="skolem">Y2</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">X1</span><span class="main">,</span> <span class="skolem">Y1</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free">ns</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="skolem">X2</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈#</span> <span class="skolem">Y2</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span> <span class="keyword1"><span class="command">using</span></span> mult2_s_one_step<span class="main">[</span><span class="operator">OF</span> assms<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">X</span></span> <span class="quoted"><span class="free">Y</span></span><span class="main">]</span> count_inject<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">X2</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#}</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">Y2</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mult2_s_def mult2_ns_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Multiset_Extension_Pair-mult2_s_locally_one_step'"><span class="command">lemma</span></span> mult2_s_locally_one_step'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ns</span> <span class="keyword1">O</span> <span class="free">s</span> <span class="main">⊆</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"refl <span class="free">ns</span>"</span></span> <span class="quoted"><span class="quoted">"locally_irrefl <span class="free">s</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"locally_irrefl <span class="free">s</span> <span class="free">Y</span>"</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> mult2_s <span class="free">ns</span> <span class="free">s</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">X1</span> <span class="bound">X2</span> <span class="bound">Y1</span> <span class="bound">Y2</span><span class="main">.</span> <span class="free">X</span> <span class="main">=</span> <span class="bound">X1</span> <span class="main">+</span> <span class="bound">X2</span> <span class="main">∧</span> <span class="free">Y</span> <span class="main">=</span> <span class="bound">Y1</span> <span class="main">+</span> <span class="bound">Y2</span> <span class="main">∧</span>
    <span class="main">(</span><span class="bound">X1</span><span class="main">,</span> <span class="bound">Y1</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free">ns</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">X2</span><span class="main">,</span> <span class="bound">Y2</span><span class="main">)</span> <span class="main">∈</span> mult <span class="free">s</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">⟷</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> mult2_s_one_step<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">,</span></span>5<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> one_step_implies_mult<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#}</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X1</span></span> <span class="skolem"><span class="skolem">X2</span></span> <span class="skolem"><span class="skolem">Y1</span></span> <span class="skolem"><span class="skolem">Y2</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="skolem">X1</span> <span class="main">+</span> <span class="skolem">X2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">=</span> <span class="skolem">Y1</span> <span class="main">+</span> <span class="skolem">Y2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    ns<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">X1</span><span class="main">,</span> <span class="skolem">Y1</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free">ns</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">X2</span><span class="main">,</span> <span class="skolem">Y2</span><span class="main">)</span> <span class="main">∈</span> mult <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"locally_irrefl <span class="free">s</span> <span class="main">(</span><span class="skolem">X2</span> <span class="main">+</span> <span class="skolem">Y1</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"locally_irrefl <span class="free">s</span> <span class="main">(</span><span class="skolem">Y2</span> <span class="main">+</span> <span class="skolem">Y1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">,</span> 4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> locally_irrefl_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span> <span class="keyword1"><span class="command">using</span></span> ns s mult_locally_cancelL<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> l r<span class="main">]</span> multpw_add<span class="main">[</span><span class="operator">OF</span> ns<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">X2</span></span> <span class="quoted"><span class="skolem">X2</span></span><span class="main">]</span> refl_multpw<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹refl <span class="free">ns</span>›</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> mult2_s_def refl_on_def x y <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Multiset_Extension_Pair-mult2_s_one_step'"><span class="command">lemma</span></span> mult2_s_one_step'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ns</span> <span class="keyword1">O</span> <span class="free">s</span> <span class="main">⊆</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"refl <span class="free">ns</span>"</span></span> <span class="quoted"><span class="quoted">"irrefl <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> mult2_s <span class="free">ns</span> <span class="free">s</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">X1</span> <span class="bound">X2</span> <span class="bound">Y1</span> <span class="bound">Y2</span><span class="main">.</span> <span class="free">X</span> <span class="main">=</span> <span class="bound">X1</span> <span class="main">+</span> <span class="bound">X2</span> <span class="main">∧</span> <span class="free">Y</span> <span class="main">=</span> <span class="bound">Y1</span> <span class="main">+</span> <span class="bound">Y2</span> <span class="main">∧</span>
    <span class="main">(</span><span class="bound">X1</span><span class="main">,</span> <span class="bound">Y1</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free">ns</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">X2</span><span class="main">,</span> <span class="bound">Y2</span><span class="main">)</span> <span class="main">∈</span> mult <span class="free">s</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">⟷</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms mult2_s_locally_one_step' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult2_s_locally_one_step' irrefl_def locally_irrefl_def<span class="main">)</span> 

<span class="keyword1" id="Multiset_Extension_Pair-mult2_ns_one_step'"><span class="command">lemma</span></span> mult2_ns_one_step'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ns</span> <span class="keyword1">O</span> <span class="free">s</span> <span class="main">⊆</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"refl <span class="free">ns</span>"</span></span> <span class="quoted"><span class="quoted">"irrefl <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> mult2_ns <span class="free">ns</span> <span class="free">s</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">X1</span> <span class="bound">X2</span> <span class="bound">Y1</span> <span class="bound">Y2</span><span class="main">.</span> <span class="free">X</span> <span class="main">=</span> <span class="bound">X1</span> <span class="main">+</span> <span class="bound">X2</span> <span class="main">∧</span> <span class="free">Y</span> <span class="main">=</span> <span class="bound">Y1</span> <span class="main">+</span> <span class="bound">Y2</span> <span class="main">∧</span>
    <span class="main">(</span><span class="bound">X1</span><span class="main">,</span> <span class="bound">Y1</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free">ns</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">X2</span><span class="main">,</span> <span class="bound">Y2</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>mult <span class="free">s</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>=</sup></span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">⟷</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free">ns</span> <span class="main">⟹</span> <span class="var">?R</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">{#}</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> exI<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">of</span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">Y</span></span></span></span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">THEN</span> exI<span class="main"><span class="main"><span class="main"><span class="main">[</span></span></span></span><span class="operator">of</span> <span class="main"><span class="main"><span class="main"><span class="main">_</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">{#}</span></span></span>"</span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main">,</span></span></span></span> <span class="operator">THEN</span> exI<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">[</span></span></span></span></span><span class="operator">of</span> <span class="main"><span class="main"><span class="main"><span class="main"><span class="main">_</span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">X</span></span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">]</span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main">]</span></span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="skolem">X1</span> <span class="main">+</span> <span class="skolem">Y2</span> <span class="main">∧</span> <span class="free">Y</span> <span class="main">=</span> <span class="skolem">Y1</span> <span class="main">+</span> <span class="skolem">Y2</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">X1</span><span class="main">,</span> <span class="skolem">Y1</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free">ns</span> <span class="main">⟹</span> <span class="var">?L</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">X1</span> <span class="skolem">Y1</span> <span class="skolem">Y2</span>
    <span class="keyword1"><span class="command">using</span></span> multpw_add<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">X1</span></span> <span class="quoted"><span class="skolem">Y1</span></span> <span class="quoted"><span class="free">ns</span></span> <span class="quoted"><span class="skolem">Y2</span></span> <span class="quoted"><span class="skolem">Y2</span></span><span class="main">]</span> refl_multpw<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹refl <span class="free">ns</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mult2_ns_def refl_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> mult2_s_one_step'<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> mult2_ns_conv
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Cancellation›</span></span>

<span class="keyword1" id="Multiset_Extension_Pair-mult2_s_locally_cancel1"><span class="command">lemma</span></span> mult2_s_locally_cancel1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="keyword1">O</span> <span class="free">ns</span> <span class="main">⊆</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ns</span> <span class="keyword1">O</span> <span class="free">s</span> <span class="main">⊆</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"refl <span class="free">ns</span>"</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">ns</span>"</span></span> <span class="quoted"><span class="quoted">"locally_irrefl <span class="free">s</span> <span class="main">(</span>add_mset <span class="free">z</span> <span class="free">X</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"locally_irrefl <span class="free">s</span> <span class="main">(</span>add_mset <span class="free">z</span> <span class="free">Y</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">s</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>add_mset <span class="free">z</span> <span class="free">X</span><span class="main">,</span> add_mset <span class="free">z</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> mult2_s <span class="free">ns</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> mult2_s <span class="free">ns</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X1</span></span> <span class="skolem"><span class="skolem">X2</span></span> <span class="skolem"><span class="skolem">Y1</span></span> <span class="skolem"><span class="skolem">Y2</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"add_mset <span class="free">z</span> <span class="free">X</span> <span class="main">=</span> <span class="skolem">X1</span> <span class="main">+</span> <span class="skolem">X2</span>"</span></span> <span class="quoted"><span class="quoted">"add_mset <span class="free">z</span> <span class="free">Y</span> <span class="main">=</span> <span class="skolem">Y1</span> <span class="main">+</span> <span class="skolem">Y2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">X1</span><span class="main">,</span> <span class="skolem">Y1</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free">ns</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">X2</span><span class="main">,</span> <span class="skolem">Y2</span><span class="main">)</span> <span class="main">∈</span> mult <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>8<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> mult2_s_locally_one_step'<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">,</span></span>5<span class="main"><span class="main">,</span></span>6<span class="main"><span class="main">,</span></span>7<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>    
  <span class="keyword1"><span class="command">from</span></span> union_single_eq_member<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> union_single_eq_member<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> multi_member_split
  <span class="keyword1"><span class="command">consider</span></span> <span class="skolem">X1'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X1</span> <span class="main">=</span> add_mset <span class="free">z</span> <span class="skolem">X1'</span>"</span></span> <span class="main">|</span> <span class="skolem">Y1'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y1</span> <span class="main">=</span> add_mset <span class="free">z</span> <span class="skolem">Y1'</span>"</span></span>
    <span class="main">|</span> <span class="skolem">X2'</span> <span class="skolem">Y2'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X2</span> <span class="main">=</span> add_mset <span class="free">z</span> <span class="skolem">X2'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y2</span> <span class="main">=</span> add_mset <span class="free">z</span> <span class="skolem">Y2'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> set_mset_union Un_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Y1'</span></span> <span class="skolem"><span class="skolem">z'</span></span> <span class="keyword2"><span class="keyword">where</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">X1'</span><span class="main">,</span> <span class="skolem">Y1'</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free">ns</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y1</span> <span class="main">=</span> add_mset <span class="skolem">z'</span> <span class="skolem">Y1'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">z</span><span class="main">,</span> <span class="skolem">z'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ns</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> multpw_split1R<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="skolem">Y1'</span> <span class="main">+</span> <span class="skolem">Y2</span><span class="main">)</span> <span class="main">∈</span> mult2_s <span class="free">ns</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> * 1
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">metis</span> add_mset_add_single assms<span class="main"><span class="main">(</span></span>2 - 7<span class="main"><span class="main">)</span></span> li_trans_l mult2_s_locally_one_step'<span class="main">)</span> 
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Y1'</span> <span class="main">+</span> <span class="skolem">Y2</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free">ns</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> refl_multpw<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹refl <span class="free">ns</span>›</span></span><span class="main">]</span> * ** multpw_cancel1<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹trans <span class="free">ns</span>›</span></span> **<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">Y1'</span> <span class="main">+</span> <span class="skolem">Y2</span>"</span></span> <span class="quoted"><span class="free">Y</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> refl_on_def<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> compat_mult2<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>3<span class="main"><span class="main"><span class="main">,</span></span></span>4<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> mult2_ns_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X1'</span></span> <span class="skolem"><span class="skolem">z'</span></span> <span class="keyword2"><span class="keyword">where</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">X1'</span><span class="main">,</span> <span class="skolem">Y1'</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free">ns</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X1</span> <span class="main">=</span> add_mset <span class="skolem">z'</span> <span class="skolem">X1'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">z'</span><span class="main">,</span> <span class="free">z</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ns</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> multpw_split1L<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">X1'</span> <span class="main">+</span> <span class="skolem">X2</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> mult2_s <span class="free">ns</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> * 2
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">metis</span> add_mset_add_single assms<span class="main"><span class="main">(</span></span>2 - 7<span class="main"><span class="main">)</span></span> li_trans_l mult2_s_locally_one_step'<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="skolem">X1'</span> <span class="main">+</span> <span class="skolem">X2</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free">ns</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> refl_multpw<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹refl <span class="free">ns</span>›</span></span><span class="main">]</span> * ** multpw_cancel1<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹trans <span class="free">ns</span>›</span></span> **<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">X</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X1'</span> <span class="main">+</span> <span class="skolem">X2</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> refl_on_def<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> compat_mult2<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>3<span class="main"><span class="main"><span class="main">,</span></span></span>4<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> mult2_ns_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 3 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms *
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mult2_s_locally_one_step' union_commute<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="main">_</span><span class="main">#}</span>"</span></span><span class="main"><span class="main">]</span></span> union_assoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> mult_cancel mult_cancel_add_mset<span class="main">)</span>
        <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"*"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="quoted">"*"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> add_mset_add_single li_trans_l li_trans_r mult2_s_locally_one_step' mult_locally_cancel<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Multiset_Extension_Pair-mult2_s_cancel1"><span class="command">lemma</span></span> mult2_s_cancel1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="keyword1">O</span> <span class="free">ns</span> <span class="main">⊆</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ns</span> <span class="keyword1">O</span> <span class="free">s</span> <span class="main">⊆</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"refl <span class="free">ns</span>"</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">ns</span>"</span></span> <span class="quoted"><span class="quoted">"irrefl <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>add_mset <span class="free">z</span> <span class="free">X</span><span class="main">,</span> add_mset <span class="free">z</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> mult2_s <span class="free">ns</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> mult2_s <span class="free">ns</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms mult2_s_locally_cancel1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> irrefl_def locally_irrefl_def<span class="main">)</span> 

<span class="keyword1" id="Multiset_Extension_Pair-mult2_s_locally_cancel"><span class="command">lemma</span></span> mult2_s_locally_cancel<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="keyword1">O</span> <span class="free">ns</span> <span class="main">⊆</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ns</span> <span class="keyword1">O</span> <span class="free">s</span> <span class="main">⊆</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"refl <span class="free">ns</span>"</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">ns</span>"</span></span> <span class="quoted"><span class="quoted">"locally_irrefl <span class="free">s</span> <span class="main">(</span><span class="free">X</span> <span class="main">+</span> <span class="free">Z</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"locally_irrefl <span class="free">s</span> <span class="main">(</span><span class="free">Y</span> <span class="main">+</span> <span class="free">Z</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X</span> <span class="main">+</span> <span class="free">Z</span><span class="main">,</span> <span class="free">Y</span> <span class="main">+</span> <span class="free">Z</span><span class="main">)</span> <span class="main">∈</span> mult2_s <span class="free">ns</span> <span class="free">s</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> mult2_s <span class="free">ns</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>5<span class="main">,</span> 6<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Z</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>add <span class="skolem">z</span> <span class="skolem">Z</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> mult2_s_locally_cancel1<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-4<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">z</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">+</span> <span class="skolem">Z</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">+</span> <span class="skolem">Z</span>"</span></span><span class="main">]</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">metis</span> add_mset_add_single assms<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span> li_trans_l<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Multiset_Extension_Pair-mult2_s_cancel"><span class="command">lemma</span></span> mult2_s_cancel<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="keyword1">O</span> <span class="free">ns</span> <span class="main">⊆</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ns</span> <span class="keyword1">O</span> <span class="free">s</span> <span class="main">⊆</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"refl <span class="free">ns</span>"</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">ns</span>"</span></span> <span class="quoted"><span class="quoted">"irrefl <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X</span> <span class="main">+</span> <span class="free">Z</span><span class="main">,</span> <span class="free">Y</span> <span class="main">+</span> <span class="free">Z</span><span class="main">)</span> <span class="main">∈</span> mult2_s <span class="free">ns</span> <span class="free">s</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> mult2_s <span class="free">ns</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> mult2_s_locally_cancel assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> irrefl_def locally_irrefl_def<span class="main">)</span> 

<span class="keyword1" id="Multiset_Extension_Pair-mult2_ns_cancel"><span class="command">lemma</span></span> mult2_ns_cancel<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="keyword1">O</span> <span class="free">ns</span> <span class="main">⊆</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ns</span> <span class="keyword1">O</span> <span class="free">s</span> <span class="main">⊆</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"refl <span class="free">ns</span>"</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"irrefl <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">ns</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X</span> <span class="main">+</span> <span class="free">Z</span><span class="main">,</span> <span class="free">Y</span> <span class="main">+</span> <span class="free">Z</span><span class="main">)</span> <span class="main">∈</span> mult2_s <span class="free">ns</span> <span class="free">s</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> mult2_ns <span class="free">ns</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mult2_ns_conv <span class="keyword1"><span class="command">using</span></span> assms mult2_s_cancel multpw_cancel <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Implementation friendly versions of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> mult2_s<span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> mult2_ns<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mult2_alt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool <span class="main">⇒</span> <span class="tfree">'a</span> rel <span class="main">⇒</span> <span class="tfree">'a</span> rel <span class="main">⇒</span> <span class="tfree">'a</span> multiset rel"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mult2_alt</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">X</span><span class="main">,</span> <span class="bound">Y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">X1</span> <span class="bound">X2</span> <span class="bound">Y1</span> <span class="bound">Y2</span><span class="main">.</span> <span class="bound">X</span> <span class="main">=</span> <span class="bound">X1</span> <span class="main">+</span> <span class="bound">X2</span> <span class="main">∧</span> <span class="bound">Y</span> <span class="main">=</span> <span class="bound">Y1</span> <span class="main">+</span> <span class="bound">Y2</span> <span class="main">∧</span>
    <span class="main">(</span><span class="bound">X1</span><span class="main">,</span> <span class="bound">Y1</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">∨</span> <span class="bound">Y2</span> <span class="main">≠</span> <span class="main">{#}</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="bound">X2</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈#</span> <span class="bound">Y2</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Multiset_Extension_Pair-mult2_altI"><span class="command">lemma</span></span> mult2_altI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="free">X1</span> <span class="main">+</span> <span class="free">X2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">=</span> <span class="free">Y1</span> <span class="main">+</span> <span class="free">Y2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X1</span><span class="main">,</span> <span class="free">Y1</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free">ns</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∨</span> <span class="free">Y2</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="free">X2</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈#</span> <span class="free">Y2</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> mult2_alt <span class="free">b</span> <span class="free">ns</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> mult2_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Multiset_Extension_Pair-mult2_altE"><span class="command">lemma</span></span> mult2_altE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> mult2_alt <span class="free">b</span> <span class="free">ns</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">X1</span> <span class="free">X2</span> <span class="free">Y1</span> <span class="free">Y2</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="free">X1</span> <span class="main">+</span> <span class="free">X2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">=</span> <span class="free">Y1</span> <span class="main">+</span> <span class="free">Y2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X1</span><span class="main">,</span> <span class="free">Y1</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free">ns</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∨</span> <span class="free">Y2</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="free">X2</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈#</span> <span class="free">Y2</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> mult2_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Multiset_Extension_Pair-mono_mult2_alt"><span class="command">lemma</span></span> mono_mult2_alt<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ns</span> <span class="main">⊆</span> <span class="free">ns'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⊆</span> <span class="free">s'</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mult2_alt <span class="free">b</span> <span class="free">ns</span> <span class="free">s</span> <span class="main">⊆</span> mult2_alt <span class="free">b</span> <span class="free">ns'</span> <span class="free">s'</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mult2_alt_def <span class="keyword1"><span class="command">using</span></span> mono_multpw<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> 19<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">mult2_alt_s</span> <span class="main">≡</span> mult2_alt False"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">mult2_alt_ns</span> <span class="main">≡</span> mult2_alt True"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> mult2_alt_s_def <span class="main">=</span> mult2_alt_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> b <span class="main"><span class="main">=</span></span> <span class="quoted">False</span><span class="main">,</span> <span class="operator">unfolded</span> simp_thms<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> mult2_alt_ns_def <span class="main">=</span> mult2_alt_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> b <span class="main"><span class="main">=</span></span> <span class="quoted">True</span><span class="main">,</span> <span class="operator">unfolded</span> simp_thms<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> mult2_alt_sI <span class="main">=</span> mult2_altI<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> b <span class="main"><span class="main">=</span></span> <span class="quoted">False</span><span class="main">,</span> <span class="operator">unfolded</span> simp_thms<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> mult2_alt_nsI <span class="main">=</span> mult2_altI<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> b <span class="main"><span class="main">=</span></span> <span class="quoted">True</span><span class="main">,</span> <span class="operator">unfolded</span> simp_thms True_implies_equals<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> mult2_alt_sE <span class="main">=</span> mult2_altE<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> b <span class="main"><span class="main">=</span></span> <span class="quoted">False</span><span class="main">,</span> <span class="operator">unfolded</span> simp_thms<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> mult2_alt_nsE <span class="main">=</span> mult2_altE<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> b <span class="main"><span class="main">=</span></span> <span class="quoted">True</span><span class="main">,</span> <span class="operator">unfolded</span> simp_thms True_implies_equals<span class="main">]</span>

<span class="keyword1"><span class="command">paragraph</span></span> <span class="quoted"><span class="plain_text">‹Equivalence to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> mult2_s<span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> mult2_ns<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1" id="Multiset_Extension_Pair-mult2_s_eq_mult2_s_alt"><span class="command">lemma</span></span> mult2_s_eq_mult2_s_alt<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ns</span> <span class="keyword1">O</span> <span class="free">s</span> <span class="main">⊆</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"refl <span class="free">ns</span>"</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mult2_alt_s <span class="free">ns</span> <span class="free">s</span> <span class="main">=</span> mult2_s <span class="free">ns</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> mult2_s_one_step<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> mult2_alt_s_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Multiset_Extension_Pair-mult2_ns_eq_mult2_ns_alt"><span class="command">lemma</span></span> mult2_ns_eq_mult2_ns_alt<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ns</span> <span class="keyword1">O</span> <span class="free">s</span> <span class="main">⊆</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"refl <span class="free">ns</span>"</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mult2_alt_ns <span class="free">ns</span> <span class="free">s</span> <span class="main">=</span> mult2_ns <span class="free">ns</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> mult2_ns_one_step<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> mult2_alt_ns_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Multiset_Extension_Pair-mult2_alt_local"><span class="command">lemma</span></span> mult2_alt_local<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> mult2_alt <span class="free">b</span> <span class="free">ns</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> mult2_alt <span class="free">b</span> <span class="main">(</span><span class="free">ns</span> <span class="main">∩</span> set_mset <span class="free">X</span> <span class="main">×</span> set_mset <span class="free">Y</span><span class="main">)</span> <span class="main">(</span><span class="free">s</span> <span class="main">∩</span> set_mset <span class="free">X</span> <span class="main">×</span> set_mset <span class="free">Y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X1</span></span> <span class="skolem"><span class="skolem">X2</span></span> <span class="skolem"><span class="skolem">Y1</span></span> <span class="skolem"><span class="skolem">Y2</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="skolem">X1</span> <span class="main">+</span> <span class="skolem">X2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">=</span> <span class="skolem">Y1</span> <span class="main">+</span> <span class="skolem">Y2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">X1</span><span class="main">,</span> <span class="skolem">Y1</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free">ns</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">b</span> <span class="main">∨</span> <span class="skolem">Y2</span> <span class="main">≠</span> <span class="main">{#}</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="skolem">X2</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈#</span> <span class="skolem">Y2</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mult2_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="skolem">X1</span> <span class="main">+</span> <span class="skolem">X2</span> <span class="main">∧</span> <span class="free">Y</span> <span class="main">=</span> <span class="skolem">Y1</span> <span class="main">+</span> <span class="skolem">Y2</span> <span class="main">∧</span>
    <span class="main">(</span><span class="skolem">X1</span><span class="main">,</span> <span class="skolem">Y1</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="main">(</span><span class="free">ns</span> <span class="main">∩</span> set_mset <span class="free">X</span> <span class="main">×</span> set_mset <span class="free">Y</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">b</span> <span class="main">∨</span> <span class="skolem">Y2</span> <span class="main">≠</span> <span class="main">{#}</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="skolem">X2</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈#</span> <span class="skolem">Y2</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">∩</span> set_mset <span class="free">X</span> <span class="main">×</span> set_mset <span class="free">Y</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> multpw_local<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">X1</span></span> <span class="quoted"><span class="skolem">Y1</span></span> <span class="quoted"><span class="free">ns</span></span><span class="main">]</span>
      mono_multpw<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">ns</span> <span class="main">∩</span> set_mset <span class="skolem">X1</span> <span class="main">×</span> set_mset <span class="skolem">Y1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ns</span> <span class="main">∩</span> set_mset <span class="free">X</span> <span class="main">×</span> set_mset <span class="free">Y</span>"</span></span><span class="main">]</span> assms
    <span class="keyword1"><span class="command">unfolding</span></span> * set_mset_union <span class="keyword1"><span class="command">unfolding</span></span> set_mset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> mult2_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Local well-foundedness: restriction to downward closure of a set›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">wf_below</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rel <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wf_below</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> wf <span class="main">(</span>Restr <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">)</span><span class="main">¯</span> <span class="main">``</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Multiset_Extension_Pair-wf_below_UNIV"><span class="command">lemma</span></span> wf_below_UNIV<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf_below <span class="free">r</span> UNIV <span class="main">⟷</span> wf <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wf_below_def rtrancl_converse<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> Image_closed_trancl<span class="main"><span class="main">[</span></span><span class="operator">OF</span> subset_UNIV<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Multiset_Extension_Pair-wf_below_mono1"><span class="command">lemma</span></span> wf_below_mono1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">⊆</span> <span class="free">r'</span>"</span></span> <span class="quoted"><span class="quoted">"wf_below <span class="free">r'</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf_below <span class="free">r</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> wf_below_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> wf_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> wf_below_def<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span> Int_mono Sigma_mono Image_mono
      iffD2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> converse_mono<span class="main"><span class="main">]</span></span> rtrancl_mono subset_refl<span class="main">)</span>

<span class="keyword1" id="Multiset_Extension_Pair-wf_below_mono2"><span class="command">lemma</span></span> wf_below_mono2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> <span class="free">A'</span>"</span></span> <span class="quoted"><span class="quoted">"wf_below <span class="free">r</span> <span class="free">A'</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf_below <span class="free">r</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> wf_below_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> wf_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> wf_below_def<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">blast</span>

<span class="keyword1" id="Multiset_Extension_Pair-wf_below_pointwise"><span class="command">lemma</span></span> wf_below_pointwise<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wf_below <span class="free">r</span> <span class="free">A</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟶</span> wf_below <span class="free">r</span> <span class="main">{</span><span class="bound">a</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">⟷</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span> <span class="keyword1"><span class="command">using</span></span> wf_below_mono2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">_</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">)</span><span class="main">¯</span> <span class="main">``</span> <span class="free">A</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">{</span><span class="main">(</span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">)</span><span class="main">¯</span> <span class="main">``</span> <span class="main">{</span><span class="bound">a</span><span class="main">}</span> <span class="main">|</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Image_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">X</span> <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">⊆</span> Restr <span class="free">r</span> <span class="main">(</span><span class="main">(</span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">)</span><span class="main">¯</span> <span class="main">``</span> <span class="free">A</span><span class="main">)</span> <span class="main">``</span> <span class="skolem">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">X</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">∈</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Image_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∩</span> <span class="main">(</span><span class="main">(</span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">)</span><span class="main">¯</span> <span class="main">``</span> <span class="main">{</span><span class="skolem">a</span><span class="main">}</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span>Restr <span class="free">r</span> <span class="main">(</span><span class="main">(</span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">)</span><span class="main">¯</span> <span class="main">``</span> <span class="free">A</span><span class="main">)</span> <span class="main">``</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span><span class="main">(</span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">)</span><span class="main">¯</span> <span class="main">``</span> <span class="main">{</span><span class="skolem">a</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> Restr <span class="free">r</span> <span class="main">(</span><span class="main">(</span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">)</span><span class="main">¯</span> <span class="main">``</span> <span class="main">{</span><span class="skolem">a</span><span class="main">}</span><span class="main">)</span> <span class="main">``</span> <span class="main">(</span><span class="skolem">X</span>  <span class="main">∩</span> <span class="main">(</span><span class="main">(</span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">)</span><span class="main">¯</span> <span class="main">``</span> <span class="main">{</span><span class="skolem">a</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Image_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∩</span> <span class="main">(</span><span class="main">(</span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">)</span><span class="main">¯</span> <span class="main">``</span> <span class="main">{</span><span class="skolem">a</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?R</span>›</span></span> **<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> wf_below_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> wfE_pf<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"Restr <span class="free"><span class="free"><span class="free">r</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span><span class="main"><span class="main"><span class="main">(</span></span></span><span class="free"><span class="free"><span class="free">r</span></span></span><span class="main"><span class="main"><span class="main"><span class="hidden">⇧</span><sup>*</sup></span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">¯</span></span></span> <span class="main"><span class="main"><span class="main">``</span></span></span> <span class="main"><span class="main"><span class="main">{</span></span></span><span class="skolem"><span class="skolem"><span class="skolem">a</span></span></span><span class="main"><span class="main"><span class="main">}</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Image_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> *<span class="main">(</span>2<span class="main">)</span> ** <span class="keyword1"><span class="command">unfolding</span></span> Image_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> wf_below_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> wfI_pf<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Multiset_Extension_Pair-SN_on_Image_rtrancl_conv"><span class="command">lemma</span></span> SN_on_Image_rtrancl_conv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"SN_on <span class="free">r</span> <span class="free">A</span> <span class="main">⟷</span> SN_on <span class="free">r</span> <span class="main">(</span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="free">A</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">⟷</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> SN_on_Image_rtrancl<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> SN_on_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Multiset_Extension_Pair-SN_on_iff_wf_below"><span class="command">lemma</span></span> SN_on_iff_wf_below<span class="main">:</span>
  <span class="quoted"><span class="quoted">"SN_on <span class="free">r</span> <span class="free">A</span> <span class="main">⟷</span> wf_below <span class="main">(</span><span class="free">r</span><span class="main">¯</span><span class="main">)</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">0</span> <span class="main">∈</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">f</span> <span class="skolem">i</span><span class="main">,</span> <span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">i</span> <span class="main">∈</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Image_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> UnCI relcomp.relcompI rtrancl_unfold<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">f</span> <span class="skolem">i</span><span class="main">,</span> <span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> Restr <span class="free">r</span> <span class="main">(</span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="keyword1"><span class="command">using</span></span> ** <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"SN_on <span class="free">r</span> <span class="main">(</span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="free">A</span><span class="main">)</span> <span class="main">⟷</span> SN_on <span class="main">(</span>Restr <span class="free">r</span> <span class="main">(</span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> SN_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">i</span><span class="main">,</span> <span class="skolem">f</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> Restr <span class="free">r</span> <span class="main">(</span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="skolem">f</span> <span class="main">0</span> <span class="main">∈</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">f</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"SN_on <span class="main">(</span>Restr <span class="free">r</span> <span class="main">(</span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="free">A</span><span class="main">)</span> <span class="main">⟷</span> SN_on <span class="main">(</span>Restr <span class="free">r</span> <span class="main">(</span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> UNIV"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> SN_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>  <span class="keyword1"><span class="command">unfolding</span></span> SN_on_Image_rtrancl_conv <span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_below_def SN_iff_wf rtrancl_converse converse_Int converse_Times<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Multiset_Extension_Pair-restr_trancl_under"><span class="command">lemma</span></span> restr_trancl_under<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Restr <span class="main">(</span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">)</span><span class="main">¯</span> <span class="main">``</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Restr <span class="free">r</span> <span class="main">(</span><span class="main">(</span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">)</span><span class="main">¯</span> <span class="main">``</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> equalityI subrelI<span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> IntE conjE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> iffD1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> mem_Sigma_iff<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∈</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> <span class="main">(</span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">)</span><span class="main">¯</span> <span class="main">``</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>Restr <span class="free">r</span> <span class="main">(</span><span class="main">(</span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">)</span><span class="main">¯</span> <span class="main">``</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span> <span class="main">∧</span> <span class="skolem">a</span> <span class="main">∈</span> <span class="main">(</span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">)</span><span class="main">¯</span> <span class="main">``</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trancl_trans_induct<span class="main"><span class="main">[</span></span><span class="operator">consumes</span> 1<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Image_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> converse_rtrancl_into_rtrancl<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> Int_iff <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> ImageE<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>Restr <span class="free">r</span> <span class="main">(</span><span class="main">(</span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">)</span><span class="main">¯</span> <span class="main">``</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>Restr <span class="free">r</span> <span class="main">(</span><span class="main">(</span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">)</span><span class="main">¯</span> <span class="main">``</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">:</span> Restr <span class="main">(</span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">)</span><span class="main">¯</span> <span class="main">``</span> <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Multiset_Extension_Pair-wf_below_trancl"><span class="command">lemma</span></span> wf_below_trancl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf_below <span class="main">(</span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span><span class="main">)</span> <span class="free">A</span> <span class="main">⟷</span> wf_below <span class="free">r</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> restr_trancl_under<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_below_def wf_trancl_conv<span class="main">)</span>

<span class="keyword1" id="Multiset_Extension_Pair-wf_below_mult_local"><span class="command">lemma</span></span> wf_below_mult_local<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_below <span class="free">r</span> <span class="main">(</span>set_mset <span class="free">X</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf_below <span class="main">(</span>mult <span class="free">r</span><span class="main">)</span> <span class="main">{</span><span class="free">X</span><span class="main">}</span>"</span></span>
    <span class="comment1">(* this is actually an equivalence; is the other direction useful as well? *)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> foo<span class="main">:</span> <span class="quoted"><span class="quoted">"mult <span class="free">r</span> <span class="main">⊆</span> mult <span class="main">(</span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mono_mult<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Y</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>mult <span class="main">(</span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">⟹</span> set_mset <span class="skolem">Y</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">(</span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">)</span><span class="main">¯</span> <span class="main">``</span> set_mset <span class="free">X</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">Y</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> converse_rtrancl_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">Z</span> <span class="skolem">Y</span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="skolem"><span class="skolem">J</span></span> <span class="skolem"><span class="skolem">K</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">=</span> <span class="skolem">I</span> <span class="main">+</span> <span class="skolem">J</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Z</span> <span class="main">=</span> <span class="skolem">I</span> <span class="main">+</span> <span class="skolem">K</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">k</span> <span class="main">∈</span> set_mset <span class="skolem">K</span><span class="main">.</span> <span class="main">∃</span><span class="bound">j</span> <span class="main">∈</span> set_mset <span class="skolem">J</span><span class="main">.</span> <span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span> <span class="main">∈</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> mult_implies_one_step<span class="main">[</span><span class="operator">OF</span> _ step<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈#</span> <span class="skolem">K</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈#</span> <span class="skolem">J</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">k</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">∈</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> *<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈#</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">j</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> step<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> *<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="free">X</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">k</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> * step<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Image_def<span class="main">)</span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Y</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>mult <span class="main">(</span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">⟹</span> <span class="skolem">y</span> <span class="main">∈#</span> <span class="skolem">Y</span>  <span class="main">⟹</span> <span class="skolem">y</span> <span class="main">∈</span> <span class="main">(</span><span class="main">(</span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">)</span><span class="main">¯</span> <span class="main">``</span> set_mset <span class="free">X</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">Y</span> <span class="skolem">y</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Restr <span class="main">(</span>mult <span class="main">(</span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>mult <span class="main">(</span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">)</span><span class="main">¯</span> <span class="main">``</span> <span class="main">{</span><span class="free">X</span><span class="main">}</span><span class="main">)</span> <span class="main">⊆</span> mult <span class="main">(</span>Restr <span class="main">(</span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">)</span><span class="main">¯</span> <span class="main">``</span> set_mset <span class="free">X</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> subrelI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">N</span> <span class="skolem">M</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">N</span><span class="main">,</span> <span class="skolem">M</span><span class="main">)</span> <span class="main">∈</span> Restr <span class="main">(</span>mult <span class="main">(</span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>mult <span class="main">(</span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">)</span><span class="main">¯</span> <span class="main">``</span> <span class="main">{</span><span class="free">X</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">N</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>mult <span class="main">(</span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">M</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>mult <span class="main">(</span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">N</span><span class="main">,</span> <span class="skolem">M</span><span class="main">)</span> <span class="main">∈</span> mult <span class="main">(</span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="skolem"><span class="skolem">J</span></span> <span class="skolem"><span class="skolem">K</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">=</span> <span class="skolem">I</span> <span class="main">+</span> <span class="skolem">J</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">N</span> <span class="main">=</span> <span class="skolem">I</span> <span class="main">+</span> <span class="skolem">K</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">J</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span> <span class="main">∈</span> set_mset <span class="skolem">K</span><span class="main">.</span> <span class="main">∃</span><span class="bound">j</span> <span class="main">∈</span> set_mset <span class="skolem">J</span><span class="main">.</span> <span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span> <span class="main">∈</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> mult_implies_one_step<span class="main">[</span><span class="operator">OF</span> _ <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">N</span><span class="main">,</span> <span class="skolem">M</span><span class="main">)</span> <span class="main">∈</span> mult <span class="main">(</span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span><span class="main">)</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">N</span><span class="main">,</span> <span class="skolem">M</span><span class="main">)</span> <span class="main">∈</span> mult <span class="main">(</span>Restr <span class="main">(</span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">)</span><span class="main">¯</span> <span class="main">``</span> set_mset <span class="free">X</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> q<span class="main">[</span><span class="operator">OF</span> **<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> q<span class="main">[</span><span class="operator">OF</span> **<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> one_step_implies_mult<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">note</span></span> bar <span class="main">=</span> subset_trans<span class="main">[</span><span class="operator">OF</span> Int_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> foo Sigma_mono<span class="main"><span class="main">]</span></span> this<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>mult <span class="free">r</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">)</span><span class="main">¯</span> <span class="main">``</span> <span class="main">{</span><span class="free">X</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">(</span>mult <span class="main">(</span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">)</span><span class="main">¯</span> <span class="main">``</span> <span class="main">{</span><span class="free">X</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> foo <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Image_mono rtrancl_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Restr <span class="main">(</span>mult <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>mult <span class="free">r</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">)</span><span class="main">¯</span> <span class="main">``</span> <span class="main">{</span><span class="free">X</span><span class="main">}</span><span class="main">)</span> <span class="main">⊆</span> mult <span class="main">(</span>Restr <span class="main">(</span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">)</span><span class="main">¯</span> <span class="main">``</span> set_mset <span class="free">X</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bar<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> wf_mult assms wf_subset
    <span class="keyword1"><span class="command">unfolding</span></span> wf_below_trancl<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">r</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> wf_below_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Multiset_Extension_Pair-qc_wf_below"><span class="command">lemma</span></span> qc_wf_below<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="keyword1">O</span> <span class="free">ns</span> <span class="main">⊆</span> <span class="main">(</span><span class="free">s</span> <span class="main">∪</span> <span class="free">ns</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="keyword1">O</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"wf_below <span class="free">s</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf_below <span class="main">(</span><span class="free">ns</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="keyword1">O</span> <span class="free">s</span> <span class="keyword1">O</span> <span class="free">ns</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">)</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_below_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> wfI_pf<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">ns</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="keyword1">O</span> <span class="free">s</span> <span class="keyword1">O</span> <span class="free">ns</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">)</span><span class="main">¯</span> <span class="main">``</span> <span class="free">A</span>"</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="keyword3"><span class="command">assume</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">⊆</span> Restr <span class="main">(</span><span class="free">ns</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="keyword1">O</span> <span class="free">s</span> <span class="keyword1">O</span> <span class="free">ns</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">)</span> <span class="var">?A'</span> <span class="main">``</span> <span class="skolem">X</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?X'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">s</span> <span class="main">∪</span> <span class="free">ns</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">∩</span> UNIV <span class="main">×</span> <span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">)</span><span class="main">¯</span> <span class="main">``</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">``</span> <span class="skolem">X</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="keyword1">O</span> <span class="main">(</span><span class="free">s</span> <span class="main">∪</span> <span class="free">ns</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">⊆</span> <span class="main">(</span><span class="free">s</span> <span class="main">∪</span> <span class="free">ns</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="keyword1">O</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> <span class="comment1">(* taken from the proof of qc_wf_relto_iff *)</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">y</span><span class="main">,</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="free">s</span> <span class="main">∪</span> <span class="free">ns</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="free">s</span> <span class="main">∪</span> <span class="free">ns</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="keyword1">O</span> <span class="free">s</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="skolem">z</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> rtrancl_refl <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>rtrancl_into_rtrancl <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">c</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="main">(</span><span class="free">s</span> <span class="main">∪</span> <span class="free">ns</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="keyword1">O</span> <span class="main">(</span><span class="free">s</span> <span class="main">∪</span> <span class="free">ns</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">)</span> <span class="keyword1">O</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> Restr <span class="main">(</span><span class="free">ns</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="keyword1">O</span> <span class="free">s</span> <span class="keyword1">O</span> <span class="free">ns</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">)</span> <span class="var">?A'</span> <span class="main">``</span> <span class="skolem">X</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="skolem">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">y</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ns</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="keyword1">O</span> <span class="free">s</span> <span class="keyword1">O</span> <span class="free">ns</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="free">ns</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="keyword1">O</span> <span class="free">s</span> <span class="keyword1">O</span> <span class="free">ns</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ns</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="keyword1">O</span> <span class="free">s</span> <span class="keyword1">O</span> <span class="free">ns</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">)</span> <span class="keyword1">O</span> <span class="main">(</span><span class="free">ns</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="keyword1">O</span> <span class="free">s</span> <span class="keyword1">O</span> <span class="free">ns</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">⊆</span> <span class="main">(</span><span class="free">s</span> <span class="main">∪</span> <span class="free">ns</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">regexp</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">y</span><span class="main">,</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="free">s</span> <span class="main">∪</span> <span class="free">ns</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> **<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?X'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> wfE_pf<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> wf_below_def<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span> subsetI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X'</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">(</span><span class="free">s</span> <span class="main">∪</span> <span class="free">ns</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">∩</span> UNIV <span class="main">×</span> <span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">)</span><span class="main">¯</span> <span class="main">``</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">``</span> Restr <span class="main">(</span><span class="free">ns</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="keyword1">O</span> <span class="free">s</span> <span class="keyword1">O</span> <span class="free">ns</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">)</span> <span class="var">?A'</span> <span class="main">``</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> X <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x0</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="skolem">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x0</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">z</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ns</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="keyword1">O</span> <span class="free">s</span> <span class="keyword1">O</span> <span class="free">ns</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">y</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="free">s</span> <span class="main">∪</span> <span class="free">ns</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">x0</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> Image_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ns</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="keyword1">O</span> <span class="free">s</span> <span class="keyword1">O</span> <span class="free">ns</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">)</span> <span class="keyword1">O</span> <span class="main">(</span><span class="free">s</span> <span class="main">∪</span> <span class="free">ns</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">⊆</span> <span class="free">ns</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="keyword1">O</span> <span class="main">(</span><span class="free">s</span> <span class="keyword1">O</span> <span class="main">(</span><span class="free">s</span> <span class="main">∪</span> <span class="free">ns</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">regexp</span>
      <span class="keyword1"><span class="command">with</span></span> **<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">z</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ns</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="keyword1">O</span> <span class="main">(</span><span class="free">s</span> <span class="keyword1">O</span> <span class="main">(</span><span class="free">s</span> <span class="main">∪</span> <span class="free">ns</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ns</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="keyword1">O</span> <span class="main">(</span><span class="main">(</span><span class="free">s</span> <span class="main">∪</span> <span class="free">ns</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="keyword1">O</span> <span class="free">s</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span><span class="free">s</span> <span class="main">∪</span> <span class="free">ns</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="keyword1">O</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">regexp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">z</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="free">s</span> <span class="main">∪</span> <span class="free">ns</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="keyword1">O</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="skolem">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">z</span><span class="main">,</span> <span class="skolem">x'</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="free">s</span> <span class="main">∪</span> <span class="free">ns</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x'</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x'</span><span class="main">,</span> <span class="skolem">x0</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">x0</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x0</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> **<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>5<span class="main">)</span> converse_rtrancl_into_rtrancl<span class="main">[</span><span class="operator">OF</span> _ **<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> Restr <span class="free">s</span> <span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">)</span><span class="main">¯</span> <span class="main">``</span> <span class="free">A</span><span class="main">)</span> <span class="main">``</span> <span class="var">?X'</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> Image_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> **<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> Image_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> X <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Multiset_Extension_Pair-wf_below_mult2_s_local"><span class="command">lemma</span></span> wf_below_mult2_s_local<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_below <span class="free">s</span> <span class="main">(</span>set_mset <span class="free">X</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="keyword1">O</span> <span class="free">ns</span> <span class="main">⊆</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"refl <span class="free">ns</span>"</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">ns</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf_below <span class="main">(</span>mult2_s <span class="free">ns</span> <span class="free">s</span><span class="main">)</span> <span class="main">{</span><span class="free">X</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> wf_below_mult_local<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">X</span></span><span class="main">]</span> assms multpw_mult_commute<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">ns</span></span><span class="main">]</span>
    wf_below_mono1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"multpw <span class="free">ns</span> <span class="keyword1">O</span> mult <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>multpw <span class="free">ns</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="keyword1">O</span> mult <span class="free">s</span> <span class="keyword1">O</span> <span class="main">(</span>multpw <span class="free">ns</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">X</span><span class="main">}</span>"</span></span><span class="main">]</span>
    qc_wf_below<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"mult <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"multpw <span class="free">ns</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">X</span><span class="main">}</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> mult2_s_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Trivial cases›</span></span>

<span class="keyword1" id="Multiset_Extension_Pair-mult2_alt_emptyL"><span class="command">lemma</span></span> mult2_alt_emptyL<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{#}</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> mult2_alt <span class="free">b</span> <span class="free">ns</span> <span class="free">s</span> <span class="main">⟷</span> <span class="free">b</span> <span class="main">∨</span> <span class="free">Y</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mult2_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Multiset_Extension_Pair-mult2_alt_emptyR"><span class="command">lemma</span></span> mult2_alt_emptyR<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span> <span class="main">∈</span> mult2_alt <span class="free">b</span> <span class="free">ns</span> <span class="free">s</span> <span class="main">⟷</span> <span class="free">b</span> <span class="main">∧</span> <span class="free">X</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mult2_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> multiset_eqI<span class="main">)</span>

<span class="keyword1" id="Multiset_Extension_Pair-mult2_alt_s_single"><span class="command">lemma</span></span> mult2_alt_s_single<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">{#</span><span class="free">a</span><span class="main">#}</span><span class="main">,</span> <span class="main">{#</span><span class="free">b</span><span class="main">#}</span><span class="main">)</span> <span class="main">∈</span> mult2_alt_s <span class="free">ns</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> mult2_altI<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="main">{#}</span>"</span></span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="main">{#}</span>"</span></span> <span class="main">_</span> <span class="quoted"><span class="free">ns</span></span> <span class="quoted">False</span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Multiset_Extension_Pair-multpw_implies_mult2_alt_ns"><span class="command">lemma</span></span> multpw_implies_mult2_alt_ns<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free">ns</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> mult2_alt_ns <span class="free">ns</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mult2_alt_nsI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">X</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">X</span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">{#}</span></span></span>"</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">Y</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">Y</span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">{#}</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Multiset_Extension_Pair-mult2_alt_ns_conv"><span class="command">lemma</span></span> mult2_alt_ns_conv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"mult2_alt_ns <span class="free">ns</span> <span class="free">s</span> <span class="main">=</span> mult2_alt_s <span class="free">ns</span> <span class="free">s</span> <span class="main">∪</span> multpw <span class="free">ns</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> <span class="var">?r</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> equalityI subrelI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="skolem">Y</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">X</span><span class="main">,</span> <span class="skolem">Y</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?l</span>"</span></span>
  <span class="keyword1"><span class="command">thm</span></span> mult2_alt_nsE
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X1</span></span> <span class="skolem"><span class="skolem">X2</span></span> <span class="skolem"><span class="skolem">Y1</span></span> <span class="skolem"><span class="skolem">Y2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> <span class="skolem">X1</span> <span class="main">+</span> <span class="skolem">X2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">=</span> <span class="skolem">Y1</span> <span class="main">+</span> <span class="skolem">Y2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">X1</span><span class="main">,</span> <span class="skolem">Y1</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free">ns</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="skolem">X2</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈#</span> <span class="skolem">Y2</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> mult2_alt_nsE<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">X</span><span class="main">,</span> <span class="skolem">Y</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> count_inject<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">X2</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#}</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">Y2</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> mult2_alt_sI <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> mult2_alt_nsE mult2_alt_sE<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="skolem">Y</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">X</span><span class="main">,</span> <span class="skolem">Y</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?r</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">X</span><span class="main">,</span> <span class="skolem">Y</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?l</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> mult2_alt_nsI multpw_implies_mult2_alt_ns <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> mult2_alt_sE<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Multiset_Extension_Pair-mult2_alt_s_implies_mult2_alt_ns"><span class="command">lemma</span></span> mult2_alt_s_implies_mult2_alt_ns<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> mult2_alt_s <span class="free">ns</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> mult2_alt_ns <span class="free">ns</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> mult2_alt_nsI <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> mult2_alt_sE<span class="main">)</span>

<span class="keyword1" id="Multiset_Extension_Pair-mult2_alt_add"><span class="command">lemma</span></span> mult2_alt_add<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X1</span><span class="main">,</span> <span class="free">Y1</span><span class="main">)</span> <span class="main">∈</span> mult2_alt <span class="free">b1</span> <span class="free">ns</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X2</span><span class="main">,</span> <span class="free">Y2</span><span class="main">)</span> <span class="main">∈</span> mult2_alt <span class="free">b2</span> <span class="free">ns</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X1</span> <span class="main">+</span> <span class="free">X2</span><span class="main">,</span> <span class="free">Y1</span> <span class="main">+</span> <span class="free">Y2</span><span class="main">)</span> <span class="main">∈</span> mult2_alt <span class="main">(</span><span class="free">b1</span> <span class="main">∧</span> <span class="free">b2</span><span class="main">)</span> <span class="free">ns</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X11</span></span> <span class="skolem"><span class="skolem">X12</span></span> <span class="skolem"><span class="skolem">Y11</span></span> <span class="skolem"><span class="skolem">Y12</span></span> <span class="skolem"><span class="skolem">X21</span></span> <span class="skolem"><span class="skolem">X22</span></span> <span class="skolem"><span class="skolem">Y21</span></span> <span class="skolem"><span class="skolem">Y22</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">X1</span> <span class="main">=</span> <span class="skolem">X11</span> <span class="main">+</span> <span class="skolem">X12</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Y1</span> <span class="main">=</span> <span class="skolem">Y11</span> <span class="main">+</span> <span class="skolem">Y12</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">X11</span><span class="main">,</span> <span class="skolem">Y11</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free">ns</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">b1</span> <span class="main">∨</span> <span class="skolem">Y12</span> <span class="main">≠</span> <span class="main">{#}</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="skolem">X12</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈#</span> <span class="skolem">Y12</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">X2</span> <span class="main">=</span> <span class="skolem">X21</span> <span class="main">+</span> <span class="skolem">X22</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Y2</span> <span class="main">=</span> <span class="skolem">Y21</span> <span class="main">+</span> <span class="skolem">Y22</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">X21</span><span class="main">,</span> <span class="skolem">Y21</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free">ns</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">b2</span> <span class="main">∨</span> <span class="skolem">Y22</span> <span class="main">≠</span> <span class="main">{#}</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="skolem">X22</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈#</span> <span class="skolem">Y22</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mult2_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> 9<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mult2_altI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem"><span class="skolem">X11</span></span></span> <span class="main"><span class="main"><span class="main">+</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">X21</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem"><span class="skolem">X12</span></span></span> <span class="main"><span class="main"><span class="main">+</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">X22</span></span></span>"</span></span></span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem"><span class="skolem">Y11</span></span></span> <span class="main"><span class="main"><span class="main">+</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">Y21</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem"><span class="skolem">Y12</span></span></span> <span class="main"><span class="main"><span class="main">+</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">Y22</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> multpw_add <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> mult2_alt_s_s_add <span class="main">=</span> mult2_alt_add<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted">False</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted">False</span><span class="main">,</span> <span class="operator">unfolded</span> simp_thms<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> mult2_alt_ns_s_add <span class="main">=</span> mult2_alt_add<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted">True</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted">False</span><span class="main">,</span> <span class="operator">unfolded</span> simp_thms<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> mult2_alt_s_ns_add <span class="main">=</span> mult2_alt_add<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted">False</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted">True</span><span class="main">,</span> <span class="operator">unfolded</span> simp_thms<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> mult2_alt_ns_ns_add <span class="main">=</span> mult2_alt_add<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted">True</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted">True</span><span class="main">,</span> <span class="operator">unfolded</span> simp_thms<span class="main">]</span>


<span class="keyword1" id="Multiset_Extension_Pair-multpw_map"><span class="command">lemma</span></span> multpw_map<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="free">X</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">∈#</span> <span class="free">Y</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ns</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">,</span> <span class="free">g</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ns'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free">ns</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>image_mset <span class="free">f</span> <span class="free">X</span><span class="main">,</span> image_mset <span class="free">g</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free">ns'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">X</span></span> <span class="quoted"><span class="free">Y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> multpw.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> multpw.intros<span class="main">)</span>

<span class="keyword1" id="Multiset_Extension_Pair-mult2_alt_map"><span class="command">lemma</span></span> mult2_alt_map<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="free">X</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">∈#</span> <span class="free">Y</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ns</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">,</span> <span class="free">g</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ns'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="free">X</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">∈#</span> <span class="free">Y</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">,</span> <span class="free">g</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> mult2_alt <span class="free">b</span> <span class="free">ns</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>image_mset <span class="free">f</span> <span class="free">X</span><span class="main">,</span> image_mset <span class="free">g</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> mult2_alt <span class="free">b</span> <span class="free">ns'</span> <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X1</span></span> <span class="skolem"><span class="skolem">X2</span></span> <span class="skolem"><span class="skolem">Y1</span></span> <span class="skolem"><span class="skolem">Y2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="skolem">X1</span> <span class="main">+</span> <span class="skolem">X2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">=</span> <span class="skolem">Y1</span> <span class="main">+</span> <span class="skolem">Y2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">X1</span><span class="main">,</span> <span class="skolem">Y1</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free">ns</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∨</span> <span class="skolem">Y2</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="skolem">X2</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈#</span> <span class="skolem">Y2</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> mult2_altE<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>5<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> image_mset <span class="free">f</span> <span class="skolem">X2</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈#</span> image_mset <span class="free">g</span> <span class="skolem">Y2</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_image_mset image_iff<span class="main">)</span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms multpw_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">X1</span></span> <span class="quoted"><span class="skolem">Y1</span></span> <span class="quoted"><span class="free">ns</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">g</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mult2_altI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"image_mset <span class="free"><span class="free"><span class="free">f</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">X1</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"image_mset <span class="free"><span class="free"><span class="free">f</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">X2</span></span></span>"</span></span></span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"image_mset <span class="free"><span class="free"><span class="free">g</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">Y1</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"image_mset <span class="free"><span class="free"><span class="free">g</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">Y2</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Local transitivity of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> mult2_alt<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1" id="Multiset_Extension_Pair-trans_mult2_alt_local"><span class="command">lemma</span></span> trans_mult2_alt_local<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ss<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="free">X</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">∈#</span> <span class="free">Y</span> <span class="main">⟹</span> <span class="bound">z</span> <span class="main">∈#</span> <span class="free">Z</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ns<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="free">X</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">∈#</span> <span class="free">Y</span> <span class="main">⟹</span> <span class="bound">z</span> <span class="main">∈#</span> <span class="free">Z</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ns</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> sn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="free">X</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">∈#</span> <span class="free">Y</span> <span class="main">⟹</span> <span class="bound">z</span> <span class="main">∈#</span> <span class="free">Z</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ns</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> nn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="free">X</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">∈#</span> <span class="free">Y</span> <span class="main">⟹</span> <span class="bound">z</span> <span class="main">∈#</span> <span class="free">Z</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ns</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ns</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ns</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> xyz<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> mult2_alt <span class="free">b1</span> <span class="free">ns</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Y</span><span class="main">,</span> <span class="free">Z</span><span class="main">)</span> <span class="main">∈</span> mult2_alt <span class="free">b2</span> <span class="free">ns</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="free">Z</span><span class="main">)</span> <span class="main">∈</span> mult2_alt <span class="main">(</span><span class="free">b1</span> <span class="main">∧</span> <span class="free">b2</span><span class="main">)</span> <span class="free">ns</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?a1</span></span></span> <span class="main">=</span> <span class="quoted">Enum.finite_3.a<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?a2</span></span></span> <span class="main">=</span> <span class="quoted">Enum.finite_3.a<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?a3</span></span></span> <span class="main">=</span> <span class="quoted">Enum.finite_3.a<span class="hidden">⇩</span><sub>3</sub></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="var">?a1</span><span class="main">,</span> <span class="var">?a2</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="var">?a1</span><span class="main">,</span> <span class="var">?a3</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="var">?a2</span><span class="main">,</span> <span class="var">?a3</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="var">?a1</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="free">X</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="var">?a2</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">|</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈#</span> <span class="free">Y</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="var">?a3</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span> <span class="main">|</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">∈#</span> <span class="free">Z</span><span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s'</span> <span class="main">=</span> Restr <span class="main">{</span><span class="main">(</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span><span class="bound">a</span> <span class="bound">x</span> <span class="bound">b</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?t</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span><span class="main">}</span> <span class="var">?A</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ns'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ns'</span> <span class="main">=</span> <span class="main">(</span>Restr <span class="main">{</span><span class="main">(</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span><span class="bound">a</span> <span class="bound">x</span> <span class="bound">b</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?t</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ns</span><span class="main">}</span> <span class="var">?A</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>=</sup></span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"refl <span class="skolem">ns'</span>"</span></span> <span class="quoted"><span class="quoted">"trans <span class="skolem">ns'</span>"</span></span> <span class="quoted"><span class="quoted">"trans <span class="skolem">s'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s'</span> <span class="keyword1">O</span> <span class="skolem">ns'</span> <span class="main">⊆</span> <span class="skolem">s'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ns'</span> <span class="keyword1">O</span> <span class="skolem">s'</span> <span class="main">⊆</span> <span class="skolem">s'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> trans_def ss ns sn nn s'_def ns'_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{#</span><span class="main">(</span><span class="var">?a1</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="free">X</span><span class="main">#}</span><span class="main">,</span> <span class="main">{#</span><span class="main">(</span><span class="var">?a2</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈#</span> <span class="free">Y</span><span class="main">#}</span><span class="main">)</span> <span class="main">∈</span> mult2_alt <span class="free">b1</span> <span class="skolem">ns'</span> <span class="skolem">s'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> mult2_alt_map<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ xyz<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> s'_def ns'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{#</span><span class="main">(</span><span class="var">?a2</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈#</span> <span class="free">Y</span><span class="main">#}</span><span class="main">,</span> <span class="main">{#</span><span class="main">(</span><span class="var">?a3</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span><span class="main">.</span> <span class="bound">z</span> <span class="main">∈#</span> <span class="free">Z</span><span class="main">#}</span><span class="main">)</span> <span class="main">∈</span> mult2_alt <span class="free">b2</span> <span class="skolem">ns'</span> <span class="skolem">s'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> mult2_alt_map<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ xyz<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> s'_def ns'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{#</span><span class="main">(</span><span class="var">?a1</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="free">X</span><span class="main">#}</span><span class="main">,</span> <span class="main">{#</span><span class="main">(</span><span class="var">?a3</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span><span class="main">.</span> <span class="bound">z</span> <span class="main">∈#</span> <span class="free">Z</span><span class="main">#}</span><span class="main">)</span> <span class="main">∈</span> mult2_alt <span class="main">(</span><span class="free">b1</span> <span class="main">∧</span> <span class="free">b2</span><span class="main">)</span> <span class="skolem">ns'</span> <span class="skolem">s'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> mult2_s_eq_mult2_s_alt<span class="main">[</span><span class="operator">OF</span> *<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">,</span></span>1<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> mult2_ns_eq_mult2_ns_alt<span class="main">[</span><span class="operator">OF</span> *<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">,</span></span>1<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
      trans_mult2_s<span class="main">[</span><span class="operator">OF</span> *<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">,</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> trans_mult2_ns<span class="main">[</span><span class="operator">OF</span> *<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">,</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> compat_mult2<span class="main">[</span><span class="operator">OF</span> *<span class="main"><span class="main"><span class="main">(</span></span></span>4<span class="main"><span class="main"><span class="main">,</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">b1</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">b2</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> trans_O_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> mult2_alt_map<span class="main">[</span><span class="operator">OF</span> _ _ this<span class="main">,</span> <span class="operator">of</span> <span class="quoted">snd</span> <span class="quoted">snd</span> <span class="quoted"><span class="free">ns</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> s'_def ns'_def image_mset.compositionality comp_def in_image_mset image_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> trans_mult2_alt_s_s_local <span class="main">=</span> trans_mult2_alt_local<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted">False</span> <span class="quoted">False</span><span class="main">,</span> <span class="operator">unfolded</span> simp_thms<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> trans_mult2_alt_ns_s_local <span class="main">=</span> trans_mult2_alt_local<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted">True</span> <span class="quoted">False</span><span class="main">,</span> <span class="operator">unfolded</span> simp_thms<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> trans_mult2_alt_s_ns_local <span class="main">=</span> trans_mult2_alt_local<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted">False</span> <span class="quoted">True</span><span class="main">,</span> <span class="operator">unfolded</span> simp_thms<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> trans_mult2_alt_ns_ns_local <span class="main">=</span> trans_mult2_alt_local<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted">True</span> <span class="quoted">True</span><span class="main">,</span> <span class="operator">unfolded</span> simp_thms<span class="main">]</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Multiset_Extension_Pair_Impl">
<div class="head">
<h1>Theory Multiset_Extension_Pair_Impl</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Executable version›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Multiset_Extension_Pair_Impl
  <span class="keyword2"><span class="keyword">imports</span></span> 
    <a href="#Multiset_Extension_Pair">Multiset_Extension_Pair</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Multiset_Extension_Pair_Impl-subset_mult2_alt"><span class="command">lemma</span></span> subset_mult2_alt<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">⊆#</span> <span class="free">Y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Y</span><span class="main">,</span> <span class="free">Z</span><span class="main">)</span> <span class="main">∈</span> mult2_alt <span class="free">b</span> <span class="free">ns</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">⟹</span> <span class="free">b'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="free">Z</span><span class="main">)</span> <span class="main">∈</span> mult2_alt <span class="free">b'</span> <span class="free">ns</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Y1</span></span> <span class="skolem"><span class="skolem">Y2</span></span> <span class="skolem"><span class="skolem">Z1</span></span> <span class="skolem"><span class="skolem">Z2</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">=</span> <span class="skolem">Y1</span> <span class="main">+</span> <span class="skolem">Y2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Z</span> <span class="main">=</span> <span class="skolem">Z1</span> <span class="main">+</span> <span class="skolem">Z2</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Y1</span><span class="main">,</span> <span class="skolem">Z1</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free">ns</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∨</span> <span class="skolem">Z2</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈#</span> <span class="skolem">Y2</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">∈#</span> <span class="skolem">Z2</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mult2_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Y11</span></span> <span class="skolem"><span class="skolem">Y12</span></span> <span class="skolem"><span class="skolem">X2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y11</span> <span class="main">=</span> <span class="skolem">Y1</span> <span class="main">∩#</span> <span class="free">X</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y12</span> <span class="main">=</span> <span class="skolem">Y1</span> <span class="main">-</span> <span class="free">X</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X2</span> <span class="main">=</span> <span class="free">X</span> <span class="main">-</span> <span class="skolem">Y11</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="skolem">Y11</span> <span class="main">+</span> <span class="skolem">X2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X2</span> <span class="main">⊆#</span> <span class="skolem">Y2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y1</span> <span class="main">=</span> <span class="skolem">Y11</span> <span class="main">+</span> <span class="skolem">Y12</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> *<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Y11_def Y12_def X2_def multiset_eq_iff subseteq_mset_def<span class="main">)</span>
      <span class="main">(</span><span class="operator">metis</span> add.commute assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> le_diff_conv subseteq_mset_def<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Z11</span></span> <span class="skolem"><span class="skolem">Z12</span></span> <span class="keyword2"><span class="keyword">where</span></span> ***<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Z</span> <span class="main">=</span> <span class="skolem">Z11</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">Z12</span> <span class="main">+</span> <span class="skolem">Z2</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Z1</span> <span class="main">=</span> <span class="skolem">Z11</span> <span class="main">+</span> <span class="skolem">Z12</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Y11</span><span class="main">,</span> <span class="skolem">Z11</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free">ns</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> *<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> **<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> multpw_splitR <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈#</span> <span class="skolem">X2</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">∈#</span> <span class="skolem">Z12</span> <span class="main">+</span> <span class="skolem">Z2</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∨</span> <span class="skolem">Z12</span> <span class="main">+</span> <span class="skolem">Z2</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> *<span class="main">(</span>4<span class="main">,</span>5<span class="main">)</span> **<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mset_subset_eqD<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> *<span class="main">(</span>2<span class="main">)</span> **<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> mult2_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Case distinction for recursion on left argument›</span></span>

<span class="keyword1" id="Multiset_Extension_Pair_Impl-mem_multiset_diff"><span class="command">lemma</span></span> mem_multiset_diff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈#</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≠</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈#</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="main">{#</span><span class="free">y</span><span class="main">#}</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_mset_remove_trivial_If diff_single_trivial insert_noteq_member<span class="main">)</span>

<span class="keyword1" id="Multiset_Extension_Pair_Impl-mult2_alt_addL"><span class="command">lemma</span></span> mult2_alt_addL<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>add_mset <span class="free">x</span> <span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> mult2_alt <span class="free">b</span> <span class="free">ns</span> <span class="free">s</span> <span class="main">⟷</span>
  <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈#</span> <span class="free">Y</span> <span class="main">∧</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">∧</span> <span class="main">(</span><span class="main">{#</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="free">X</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∉</span> <span class="free">s</span> <span class="main">#}</span><span class="main">,</span> <span class="free">Y</span> <span class="main">-</span> <span class="main">{#</span><span class="bound">y</span><span class="main">#}</span><span class="main">)</span> <span class="main">∈</span> mult2_alt_ns <span class="free">ns</span> <span class="free">s</span><span class="main">)</span> <span class="main">∨</span>
  <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈#</span> <span class="free">Y</span> <span class="main">∧</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ns</span> <span class="main">∧</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∉</span> <span class="free">s</span> <span class="main">∧</span> <span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span> <span class="main">-</span> <span class="main">{#</span><span class="bound">y</span><span class="main">#}</span><span class="main">)</span> <span class="main">∈</span> mult2_alt <span class="free">b</span> <span class="free">ns</span> <span class="free">s</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">⟷</span> <span class="var">?R1</span> <span class="main">∨</span> <span class="var">?R2</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> iffI<span class="main"><span class="keyword3">;</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X1</span></span> <span class="skolem"><span class="skolem">X2</span></span> <span class="skolem"><span class="skolem">Y1</span></span> <span class="skolem"><span class="skolem">Y2</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"add_mset <span class="free">x</span> <span class="free">X</span> <span class="main">=</span> <span class="skolem">X1</span> <span class="main">+</span> <span class="skolem">X2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">=</span> <span class="skolem">Y1</span> <span class="main">+</span> <span class="skolem">Y2</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">X1</span><span class="main">,</span> <span class="skolem">Y1</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free">ns</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∨</span> <span class="skolem">Y2</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="skolem">X2</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈#</span> <span class="skolem">Y2</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mult2_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> union_single_eq_member<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> multi_member_split
  <span class="keyword1"><span class="command">consider</span></span> <span class="skolem">X1'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X1</span> <span class="main">=</span> add_mset <span class="free">x</span> <span class="skolem">X1'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈#</span> <span class="skolem">X1</span>"</span></span> <span class="main">|</span> <span class="skolem">X2'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X2</span> <span class="main">=</span> add_mset <span class="free">x</span> <span class="skolem">X2'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈#</span> <span class="skolem">X2</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> set_mset_union Un_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R1</span> <span class="main">∨</span> <span class="var">?R2</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="skolem"><span class="skolem">Y1'</span></span> <span class="keyword2"><span class="keyword">where</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈#</span> <span class="skolem">Y1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y1</span> <span class="main">=</span> add_mset <span class="skolem">y</span> <span class="skolem">Y1'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">X1'</span><span class="main">,</span> <span class="skolem">Y1'</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free">ns</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ns</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> multpw_split1R<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> mult2_altI<span class="main">[</span><span class="operator">OF</span> refl refl **<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> *<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">,</span></span>5<span class="main"><span class="main">)</span></span><span class="main">]</span> *
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> 1 ** <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">y</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">X2'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X2'</span> <span class="main">=</span> <span class="main">{#</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="skolem">X2</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∉</span> <span class="free">s</span> <span class="main">#}</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> x3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="skolem">X2'</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">∈#</span> <span class="skolem">Y2</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> *<span class="main">(</span>5<span class="main">)</span> **<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> X2'_def<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> x4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="free">X</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∉</span> <span class="free">s</span><span class="main">#}</span> <span class="main">⊆#</span> <span class="skolem">X1'</span> <span class="main">+</span> <span class="skolem">X2'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> *<span class="main">(</span>1<span class="main">)</span> 1
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> X2'_def multiset_eq_iff <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mset_subset_eqI <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_countE<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> le_refl<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> mult2_alt_nsI<span class="main">[</span><span class="operator">OF</span> refl refl **<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> x3<span class="main">,</span> <span class="operator">THEN</span> subset_mult2_alt<span class="main"><span class="main">[</span></span><span class="operator">OF</span> x4<span class="main"><span class="main">]</span></span><span class="main">]</span>
          **<span class="main">(</span>2<span class="main">)</span> *<span class="main">(</span>2<span class="main">)</span> True <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">y</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈#</span> <span class="skolem">Y2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">X2'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X2'</span> <span class="main">=</span> <span class="main">{#</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="skolem">X2</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∉</span> <span class="free">s</span> <span class="main">#}</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> x3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="skolem">X2'</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">∈#</span> <span class="skolem">Y2</span> <span class="main">-</span> <span class="main">{#</span><span class="skolem">y</span><span class="main">#}</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> *<span class="main">(</span>5<span class="main">)</span> **<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> X2'_def<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> mem_multiset_diff<span class="main">)</span> 
    <span class="keyword1"><span class="command">have</span></span> x4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="free">X</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∉</span> <span class="free">s</span><span class="main">#}</span> <span class="main">⊆#</span> <span class="skolem">X1</span> <span class="main">+</span> <span class="skolem">X2'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> *<span class="main">(</span>1<span class="main">)</span> **<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> X2'_def multiset_eq_iff <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mset_subset_eqI <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> mult2_alt_nsI<span class="main">[</span><span class="operator">OF</span> refl refl *<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> x3<span class="main">,</span> <span class="operator">THEN</span> subset_mult2_alt<span class="main"><span class="main">[</span></span><span class="operator">OF</span> x4<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted">True</span><span class="main">]</span> **<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> *<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> diff_union_single_conv<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?R1</span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈#</span> <span class="free">Y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{#</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="free">X</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∉</span> <span class="free">s</span> <span class="main">#}</span><span class="main">,</span> <span class="free">Y</span> <span class="main">-</span> <span class="main">{#</span><span class="skolem">y</span><span class="main">#}</span><span class="main">)</span> <span class="main">∈</span> mult2_alt_ns <span class="free">ns</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{#</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="free">X</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">#}</span> <span class="main">+</span> <span class="main">{#</span><span class="free">x</span><span class="main">#}</span><span class="main">,</span> <span class="main">{#</span><span class="skolem">y</span><span class="main">#}</span><span class="main">)</span> <span class="main">∈</span> mult2_alt <span class="free">b</span> <span class="free">ns</span> <span class="free">s</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">{#</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="free">X</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∉</span> <span class="free">s</span> <span class="main">#}</span> <span class="main">+</span> <span class="main">{#</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="free">X</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">#}</span> <span class="main">=</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> mult2_altI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#}</span>"</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#}</span>"</span></span><span class="main"><span class="main">]</span></span> multiset_eqI <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span> <span class="keyword1"><span class="command">using</span></span> mult2_alt_add<span class="main">[</span><span class="operator">OF</span> *<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> **<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> * ** <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> union_assoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?R2</span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈#</span> <span class="free">Y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ns</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span> <span class="main">-</span> <span class="main">{#</span><span class="skolem">y</span><span class="main">#}</span><span class="main">)</span> <span class="main">∈</span> mult2_alt <span class="free">b</span> <span class="free">ns</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span> <span class="keyword1"><span class="command">using</span></span> mult2_alt_add<span class="main">[</span><span class="operator">OF</span> *<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> multpw_implies_mult2_alt_ns<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="free">x</span><span class="main">#}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="skolem">y</span><span class="main">#}</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> multpw_single<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Auxiliary version with an extra <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">bool</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> argument for distinguishing between the
  non-strict and the strict orders›</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">nss</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">mult2_impl0</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> bool <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">mult2_ex_dom0</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> bool <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">mult2_impl0</span> <span class="main">[]</span>       <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mult2_impl0</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>       <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">⟷</span> False"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mult2_impl0</span> <span class="main">[]</span>       <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">⟷</span> True"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mult2_impl0</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">⟷</span> <span class="free">mult2_ex_dom0</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span>

<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mult2_ex_dom0</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">[]</span>       <span class="free"><span class="bound"><span class="entity">ys'</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">⟷</span> False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mult2_ex_dom0</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ys'</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">⟷</span>
     <span class="free">nss</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> False <span class="main">∧</span> <span class="free">mult2_impl0</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">¬</span> <span class="free">nss</span> <span class="bound">x</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> False<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">ys'</span></span></span><span class="main">)</span> True <span class="main">∨</span>
     <span class="free">nss</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> True <span class="main">∧</span> <span class="main">¬</span> <span class="free">nss</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> False <span class="main">∧</span> <span class="free">mult2_impl0</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">ys'</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">∨</span>
     <span class="free">mult2_ex_dom0</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys'</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Multiset_Extension_Pair_Impl-mult2_impl0_sound"><span class="command">lemma</span></span> mult2_impl0_sound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">nss</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">ns</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="free">nss</span> <span class="bound">x</span> <span class="bound">y</span> True<span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="free">nss</span> <span class="bound">x</span> <span class="bound">y</span> False<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mult2_impl0 <span class="free">nss</span> <span class="free">xs</span> <span class="free">ys</span> <span class="free">b</span> <span class="main">⟷</span> <span class="main">(</span>mset <span class="free">xs</span><span class="main">,</span> mset <span class="free">ys</span><span class="main">)</span> <span class="main">∈</span> mult2_alt <span class="free">b</span> <span class="free">ns</span> <span class="free">s</span>"</span></span>
    <span class="quoted"><span class="quoted">"mult2_ex_dom0 <span class="free">nss</span> <span class="free">x</span> <span class="free">xs</span> <span class="free">ys</span> <span class="free">ys'</span> <span class="free">b</span> <span class="main">⟷</span>
      <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈#</span> mset <span class="free">ys</span> <span class="main">∧</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">∧</span> <span class="main">(</span>mset <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∉</span> <span class="free">s</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">,</span> mset <span class="main">(</span><span class="free">ys</span> <span class="main">@</span> <span class="free">ys'</span><span class="main">)</span> <span class="main">-</span> <span class="main">{#</span><span class="bound">y</span><span class="main">#}</span><span class="main">)</span> <span class="main">∈</span> mult2_alt True <span class="free">ns</span> <span class="free">s</span><span class="main">)</span> <span class="main">∨</span>
      <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈#</span> mset <span class="free">ys</span> <span class="main">∧</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ns</span> <span class="main">∧</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∉</span> <span class="free">s</span> <span class="main">∧</span> <span class="main">(</span>mset <span class="free">xs</span><span class="main">,</span> mset <span class="main">(</span><span class="free">ys</span> <span class="main">@</span> <span class="free">ys'</span><span class="main">)</span> <span class="main">-</span> <span class="main">{#</span><span class="bound">y</span><span class="main">#}</span><span class="main">)</span> <span class="main">∈</span> mult2_alt <span class="free">b</span> <span class="free">ns</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quoted"><span class="free">b</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quoted"><span class="free">ys'</span></span> <span class="quoted"><span class="free">b</span></span> <span class="quasi_keyword">taking</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">nss</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> mult2_impl0_mult2_ex_dom0.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">y</span> <span class="skolem">ys</span> <span class="skolem">b</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> mult2_impl0.simps 4
    <span class="keyword1"><span class="command">using</span></span> mult2_alt_addL<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="quoted">"mset <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"mset <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">b</span></span> <span class="quoted"><span class="free">ns</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mset_filter<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>6 <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">y</span> <span class="skolem">ys</span> <span class="skolem">ys'</span> <span class="skolem">b</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> mult2_ex_dom0.simps 6
    <span class="keyword1"><span class="command">using</span></span> subset_mult2_alt<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"mset <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">xs</span> <span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∉</span> <span class="free">s</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"mset <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"mset <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="skolem">ys'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">b</span></span> <span class="quoted"><span class="free">ns</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted">True</span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> iffI<span class="main"><span class="keyword3">;</span></span> <span class="operator">elim</span> disjE conjE exE<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mset_filter ns_def s_def<span class="main"><span class="keyword3">;</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> disjI1 exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">y</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> disjI2 exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">y</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> y' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> disjI1 exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">y'</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> y' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> disjI2 exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">y'</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> y' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> y' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> disjI2<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> disjI2<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> disjI1<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">y'</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> y' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> y' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> disjI2<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> disjI2<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> disjI2<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">y'</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mult2_alt_emptyL mult2_alt_emptyR<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Now, instead of functions of type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"bool <span class="main"><span class="main">⇒</span></span> bool"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, use pairs of type
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"bool <span class="main"><span class="main">×</span></span> bool"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">or2</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">∨</span> fst <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">,</span> snd <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">∨</span> snd <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">sns</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool <span class="main">×</span> bool"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">mult2_impl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> bool <span class="main">×</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">mult2_ex_dom</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> bool <span class="main">×</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">mult2_impl</span> <span class="main">[]</span>       <span class="main">[]</span> <span class="main">=</span> <span class="main">(</span>False<span class="main">,</span> True<span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mult2_impl</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>       <span class="main">[]</span> <span class="main">=</span> <span class="main">(</span>False<span class="main">,</span> False<span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mult2_impl</span> <span class="main">[]</span>       <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">=</span> <span class="main">(</span>True<span class="main">,</span> True<span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mult2_impl</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">=</span> <span class="free">mult2_ex_dom</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">[]</span>"</span></span>

<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mult2_ex_dom</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">[]</span>       <span class="free"><span class="bound"><span class="entity">ys'</span></span></span> <span class="main">=</span> <span class="main">(</span>False<span class="main">,</span> False<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mult2_ex_dom</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ys'</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">case</span> <span class="free">sns</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">of</span>
      <span class="main">(</span>True<span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">if</span> snd <span class="main">(</span><span class="free">mult2_impl</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">¬</span> fst <span class="main">(</span><span class="free">sns</span> <span class="bound">x</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">ys'</span></span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">(</span>True<span class="main">,</span> True<span class="main">)</span>
                   <span class="keyword1">else</span> <span class="free">mult2_ex_dom</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys'</span></span></span><span class="main">)</span>
    <span class="main">|</span> <span class="main">(</span>False<span class="main">,</span> True<span class="main">)</span> <span class="main">⇒</span> or2 <span class="main">(</span><span class="free">mult2_impl</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">ys'</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">mult2_ex_dom</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys'</span></span></span><span class="main">)</span><span class="main">)</span>
    <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="free">mult2_ex_dom</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys'</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Multiset_Extension_Pair_Impl-mult2_impl_sound0"><span class="command">lemma</span></span> mult2_impl_sound0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">pair</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="main">(</span><span class="bound">f</span> False<span class="main">,</span> <span class="bound">f</span> True<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">fun</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">p</span> <span class="bound">b</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span> snd <span class="bound">p</span> <span class="keyword1">else</span> fst <span class="bound">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mult2_impl <span class="free">sns</span> <span class="free">xs</span> <span class="free">ys</span> <span class="main">=</span> <span class="free">pair</span> <span class="main">(</span>mult2_impl0 <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">fun</span> <span class="main">(</span><span class="free">sns</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span><span class="main">)</span>
    <span class="quoted"><span class="quoted">"mult2_ex_dom <span class="free">sns</span> <span class="free">x</span> <span class="free">xs</span> <span class="free">ys</span> <span class="free">ys'</span> <span class="main">=</span> <span class="free">pair</span> <span class="main">(</span>mult2_ex_dom0 <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">fun</span> <span class="main">(</span><span class="free">sns</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="free">xs</span> <span class="free">ys</span> <span class="free">ys'</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?Q</span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="var"><span class="quoted"><span class="var">?Q</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quoted"><span class="free">ys'</span></span> <span class="quasi_keyword">taking</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">sns</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> mult2_impl_mult2_ex_dom.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>6 <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">y</span> <span class="skolem">ys</span> <span class="skolem">ys'</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> mult2_ex_dom.simps mult2_ex_dom0.simps
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pair_def fun_def 6 if_bool_eq_conj <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits bool.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pair_def fun_def if_bool_eq_conj<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> mult2_impl_sound <span class="main">=</span> mult2_impl_sound0<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> mult2_impl0_sound if_True if_False<span class="main">]</span>
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Multiset_Extension2">
<div class="head">
<h1>Theory Multiset_Extension2</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Multiset extension of order pairs in the other direction›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Many term orders are formulated in the other direction, i.e., they use
  strong normalization of $&gt;$ instead of well-foundedness of $&lt;$. Here, we
  flip the direction of the multiset extension of two orders, connect it to existing interfaces,
  and prove some further properties of the multiset extension.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Multiset_Extension2
  <span class="keyword2"><span class="keyword">imports</span></span>
    <a href="#List_Order">List_Order</a>
    <a href="#Multiset_Extension_Pair">Multiset_Extension_Pair</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹List based characterization of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> multpw<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1" id="Multiset_Extension2-multpw_listI"><span class="command">lemma</span></span> multpw_listI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="free">ys</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> mset <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">=</span> mset <span class="free">ys</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">ys</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">,</span> <span class="free">ys</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ns</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free">ns</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quoted"><span class="free">X</span></span> <span class="quoted"><span class="free">Y</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Nil <span class="skolem">ys</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ys</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> multpw.intros<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Cons1<span class="main">:</span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">ys'</span> <span class="skolem">X</span> <span class="skolem">Y</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ys'</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="skolem">ys</span> <span class="main">⟶</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">,</span> <span class="skolem">ys</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ns</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons1<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons1<span class="main">(</span>2<span class="main">,</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> multpw.intros <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Cons<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Cons1<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Multiset_Extension2-multpw_listE"><span class="command">lemma</span></span> multpw_listE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free">ns</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">xs</span> <span class="free">ys</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="free">ys</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> mset <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">=</span> mset <span class="free">ys</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">ys</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">,</span> <span class="free">ys</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ns</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">X</span></span> <span class="quoted"><span class="free">Y</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">thesis</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> multpw.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>add <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">X</span> <span class="skolem">Y</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span> <span class="main">=</span> length <span class="skolem">ys</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> mset <span class="skolem">xs</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">=</span> mset <span class="skolem">ys</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="skolem">ys</span> <span class="main">⟶</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">,</span> <span class="skolem">ys</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ns</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> add<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> add<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem"><span class="skolem">x</span></span></span> <span class="main"><span class="main"><span class="main">#</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">xs</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem"><span class="skolem">y</span></span></span> <span class="main"><span class="main"><span class="main">#</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">ys</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">i</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Definition of the multiset extension of $&gt;$-orders›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹We define here the non-strict extension of the order pair $(\geqslant, &gt;)$ --
  usually written as (ns, s) in the sources --
  by just flipping the directions twice.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ns_mul_ext</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rel <span class="main">⇒</span> <span class="tfree">'a</span> rel <span class="main">⇒</span> <span class="tfree">'a</span> multiset rel"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ns_mul_ext</span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">(</span>mult2_alt_ns <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ns</span></span></span><span class="main">¯</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">¯</span><span class="main">)</span><span class="main">)</span><span class="main">¯</span>"</span></span>

<span class="keyword1" id="Multiset_Extension2-ns_mul_extI"><span class="command">lemma</span></span> ns_mul_extI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="free">A1</span> <span class="main">+</span> <span class="free">A2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">=</span> <span class="free">B1</span> <span class="main">+</span> <span class="free">B2</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A1</span><span class="main">,</span> <span class="free">B1</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free">ns</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="free">B2</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈#</span> <span class="free">A2</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> ns_mul_ext <span class="free">ns</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ns_mul_ext_def multpw_converse <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mult2_alt_nsI<span class="main">)</span>

<span class="keyword1" id="Multiset_Extension2-ns_mul_extE"><span class="command">lemma</span></span> ns_mul_extE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> ns_mul_ext <span class="free">ns</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">A1</span> <span class="free">A2</span> <span class="free">B1</span> <span class="free">B2</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="free">A1</span> <span class="main">+</span> <span class="free">A2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">=</span> <span class="free">B1</span> <span class="main">+</span> <span class="free">B2</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A1</span><span class="main">,</span> <span class="free">B1</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free">ns</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="free">B2</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈#</span> <span class="free">A2</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ns_mul_ext_def multpw_converse <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mult2_alt_nsE<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> ns_mul_extI_old <span class="main">=</span> ns_mul_extI<span class="main">[</span><span class="operator">OF</span> _ _ multpw_listI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ refl refl<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Same for the "greater than" order on multisets.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">s_mul_ext</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rel <span class="main">⇒</span> <span class="tfree">'a</span> rel <span class="main">⇒</span> <span class="tfree">'a</span> multiset rel"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">s_mul_ext</span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">(</span>mult2_alt_s <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ns</span></span></span><span class="main">¯</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">¯</span><span class="main">)</span><span class="main">)</span><span class="main">¯</span>"</span></span>

<span class="keyword1" id="Multiset_Extension2-s_mul_extI"><span class="command">lemma</span></span> s_mul_extI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="free">A1</span> <span class="main">+</span> <span class="free">A2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">=</span> <span class="free">B1</span> <span class="main">+</span> <span class="free">B2</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A1</span><span class="main">,</span> <span class="free">B1</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free">ns</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">A2</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="free">B2</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈#</span> <span class="free">A2</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> s_mul_ext <span class="free">ns</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> s_mul_ext_def multpw_converse <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mult2_alt_sI<span class="main">)</span>

<span class="keyword1" id="Multiset_Extension2-s_mul_extE"><span class="command">lemma</span></span> s_mul_extE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> s_mul_ext <span class="free">ns</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">A1</span> <span class="free">A2</span> <span class="free">B1</span> <span class="free">B2</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="free">A1</span> <span class="main">+</span> <span class="free">A2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">=</span> <span class="free">B1</span> <span class="main">+</span> <span class="free">B2</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A1</span><span class="main">,</span> <span class="free">B1</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free">ns</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">A2</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="free">B2</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈#</span> <span class="free">A2</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> s_mul_ext_def multpw_converse <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mult2_alt_sE<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> s_mul_extI_old <span class="main">=</span> s_mul_extI<span class="main">[</span><span class="operator">OF</span> _ _ multpw_listI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ refl refl<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Basic properties›</span></span>

<span class="keyword1" id="Multiset_Extension2-s_mul_ext_mono"><span class="command">lemma</span></span> s_mul_ext_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ns</span> <span class="main">⊆</span> <span class="free">ns'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⊆</span> <span class="free">s'</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"s_mul_ext <span class="free">ns</span> <span class="free">s</span> <span class="main">⊆</span> s_mul_ext <span class="free">ns'</span> <span class="free">s'</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> s_mul_ext_def <span class="keyword1"><span class="command">using</span></span> assms mono_mult2_alt<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">ns</span><span class="main">¯</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ns'</span><span class="main">¯</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">¯</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s'</span><span class="main">¯</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Multiset_Extension2-ns_mul_ext_mono"><span class="command">lemma</span></span> ns_mul_ext_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ns</span> <span class="main">⊆</span> <span class="free">ns'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⊆</span> <span class="free">s'</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ns_mul_ext <span class="free">ns</span> <span class="free">s</span> <span class="main">⊆</span> ns_mul_ext <span class="free">ns'</span> <span class="free">s'</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ns_mul_ext_def <span class="keyword1"><span class="command">using</span></span> assms mono_mult2_alt<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">ns</span><span class="main">¯</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ns'</span><span class="main">¯</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">¯</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s'</span><span class="main">¯</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Multiset_Extension2-s_mul_ext_local_mono"><span class="command">lemma</span></span> s_mul_ext_local_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>set_mset <span class="free">xs</span> <span class="main">×</span> set_mset <span class="free">ys</span><span class="main">)</span> <span class="main">∩</span> <span class="free">ns</span> <span class="main">⊆</span> <span class="free">ns'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>set_mset <span class="free">xs</span> <span class="main">×</span> set_mset <span class="free">ys</span><span class="main">)</span> <span class="main">∩</span> <span class="free">s</span> <span class="main">⊆</span> <span class="free">s'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> rel<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span><span class="main">,</span><span class="free">ys</span><span class="main">)</span> <span class="main">∈</span> s_mul_ext <span class="free">ns</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span><span class="main">,</span><span class="free">ys</span><span class="main">)</span> <span class="main">∈</span> s_mul_ext <span class="free">ns'</span> <span class="free">s'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> rel s_mul_ext_mono<span class="main">[</span><span class="operator">OF</span> sub<span class="main">]</span> mult2_alt_local<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">ys</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted">False</span> <span class="quoted"><span class="quoted">"<span class="free">ns</span><span class="main">¯</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">¯</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> s_mul_ext_def converse_Int <span class="dynamic"><span class="dynamic">ac_simps</span></span> converse_Times<span class="main">)</span>

<span class="keyword1" id="Multiset_Extension2-ns_mul_ext_local_mono"><span class="command">lemma</span></span> ns_mul_ext_local_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>set_mset <span class="free">xs</span> <span class="main">×</span> set_mset <span class="free">ys</span><span class="main">)</span> <span class="main">∩</span> <span class="free">ns</span> <span class="main">⊆</span> <span class="free">ns'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>set_mset <span class="free">xs</span> <span class="main">×</span> set_mset <span class="free">ys</span><span class="main">)</span> <span class="main">∩</span> <span class="free">s</span> <span class="main">⊆</span> <span class="free">s'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> rel<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span><span class="main">,</span><span class="free">ys</span><span class="main">)</span> <span class="main">∈</span> ns_mul_ext <span class="free">ns</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span><span class="main">,</span><span class="free">ys</span><span class="main">)</span> <span class="main">∈</span> ns_mul_ext <span class="free">ns'</span> <span class="free">s'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> rel ns_mul_ext_mono<span class="main">[</span><span class="operator">OF</span> sub<span class="main">]</span> mult2_alt_local<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">ys</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted">True</span> <span class="quoted"><span class="quoted">"<span class="free">ns</span><span class="main">¯</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">¯</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ns_mul_ext_def converse_Int <span class="dynamic"><span class="dynamic">ac_simps</span></span> converse_Times<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The empty multiset is the minimal element for these orders›</span></span>

<span class="keyword1" id="Multiset_Extension2-ns_mul_ext_bottom"><span class="command">lemma</span></span> ns_mul_ext_bottom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="main">,</span><span class="main">{#}</span><span class="main">)</span> <span class="main">∈</span> ns_mul_ext <span class="free">ns</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ns_mul_extI<span class="main">)</span>

<span class="keyword1" id="Multiset_Extension2-ns_mul_ext_bottom_uniqueness"><span class="command">lemma</span></span> ns_mul_ext_bottom_uniqueness<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{#}</span><span class="main">,</span><span class="free">A</span><span class="main">)</span> <span class="main">∈</span> ns_mul_ext <span class="free">ns</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ns_mul_ext_def mult2_alt_ns_def<span class="main">)</span>

<span class="keyword1" id="Multiset_Extension2-ns_mul_ext_bottom2"><span class="command">lemma</span></span> ns_mul_ext_bottom2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="main">,</span><span class="free">B</span><span class="main">)</span> <span class="main">∈</span> ns_mul_ext <span class="free">ns</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ns_mul_ext_def mult2_alt_ns_def<span class="main">)</span>

<span class="keyword1" id="Multiset_Extension2-s_mul_ext_bottom"><span class="command">lemma</span></span> s_mul_ext_bottom<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="main">,</span><span class="main">{#}</span><span class="main">)</span> <span class="main">∈</span> s_mul_ext <span class="free">ns</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> s_mul_ext_def mult2_alt_s_def<span class="main">)</span>

<span class="keyword1" id="Multiset_Extension2-s_mul_ext_bottom_strict"><span class="command">lemma</span></span> s_mul_ext_bottom_strict<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{#}</span><span class="main">,</span><span class="free">A</span><span class="main">)</span> <span class="main">∉</span> s_mul_ext <span class="free">ns</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> s_mul_ext_def mult2_alt_s_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Obvious introduction rules.›</span></span>

<span class="keyword1" id="Multiset_Extension2-all_ns_ns_mul_ext"><span class="command">lemma</span></span> all_ns_ns_mul_ext<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">as</span> <span class="main">=</span> length <span class="free">bs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">bs</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">as</span> <span class="main">!</span> <span class="bound">i</span><span class="main">,</span> <span class="free">bs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ns</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mset <span class="free">as</span><span class="main">,</span> mset <span class="free">bs</span><span class="main">)</span> <span class="main">∈</span> ns_mul_ext <span class="free">ns</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ns_mul_extI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#}</span>"</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#}</span>"</span></span><span class="main"><span class="main">]</span></span> multpw_listI<span class="main">)</span>

<span class="keyword1" id="Multiset_Extension2-all_s_s_mul_ext"><span class="command">lemma</span></span> all_s_s_mul_ext<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="free">B</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈#</span> <span class="free">A</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> s_mul_ext <span class="free">ns</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> s_mul_extI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#}</span>"</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#}</span>"</span></span><span class="main"><span class="main">]</span></span> multpw_listI<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Being stricly lesser than implies being lesser than›</span></span>

<span class="keyword1" id="Multiset_Extension2-s_ns_mul_ext"><span class="command">lemma</span></span> s_ns_mul_ext<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> s_mul_ext <span class="free">ns</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> ns_mul_ext <span class="free">ns</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> s_mul_ext_def ns_mul_ext_def mult2_alt_s_implies_mult2_alt_ns<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The non-strict order is reflexive.›</span></span>

<span class="keyword1" id="Multiset_Extension2-multpw_refl'"><span class="command">lemma</span></span> multpw_refl'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"locally_refl <span class="free">ns</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> multpw <span class="free">ns</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Restr Id <span class="main">(</span>set_mset <span class="free">A</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">ns</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> locally_refl_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> refl_multpw<span class="main">[</span><span class="operator">of</span> <span class="quoted">Id</span><span class="main">]</span> multpw_local<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted">Id</span><span class="main">]</span> mono_multpw<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> refl_on_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Multiset_Extension2-ns_mul_ext_refl_local"><span class="command">lemma</span></span> ns_mul_ext_refl_local<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"locally_refl <span class="free">ns</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> ns_mul_ext <span class="free">ns</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>  ns_mul_extI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#}</span>"</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#}</span>"</span></span> <span class="quoted"><span class="free">ns</span></span> <span class="quoted"><span class="free">s</span></span><span class="main"><span class="main">]</span></span> multpw_refl'<span class="main">)</span>

<span class="keyword1" id="Multiset_Extension2-ns_mul_ext_refl"><span class="command">lemma</span></span> ns_mul_ext_refl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"refl <span class="free">ns</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> ns_mul_ext <span class="free">ns</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms ns_mul_ext_refl_local<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">ns</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> refl_on_def locally_refl_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The orders are union-compatible›</span></span>

<span class="keyword1" id="Multiset_Extension2-ns_s_mul_ext_union_multiset_l"><span class="command">lemma</span></span> ns_s_mul_ext_union_multiset_l<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> ns_mul_ext <span class="free">ns</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">.</span> <span class="bound">d</span> <span class="main">∈#</span> <span class="free">D</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">c</span><span class="main">.</span> <span class="bound">c</span> <span class="main">∈#</span> <span class="free">C</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">c</span><span class="main">,</span><span class="bound">d</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">C</span><span class="main">,</span> <span class="free">B</span> <span class="main">+</span> <span class="free">D</span><span class="main">)</span> <span class="main">∈</span> s_mul_ext <span class="free">ns</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> ns_mul_ext_def s_mul_ext_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> converseI mult2_alt_ns_s_add mult2_alt_sI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#}</span>"</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#}</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Multiset_Extension2-s_mul_ext_union_compat"><span class="command">lemma</span></span> s_mul_ext_union_compat<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> s_mul_ext <span class="free">ns</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"locally_refl <span class="free">ns</span> <span class="free">C</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">C</span><span class="main">,</span> <span class="free">B</span> <span class="main">+</span> <span class="free">C</span><span class="main">)</span> <span class="main">∈</span> s_mul_ext <span class="free">ns</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms ns_mul_ext_refl_local<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> ns_mul_ext_def s_mul_ext_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> converseI mult2_alt_s_ns_add<span class="main">)</span>

<span class="keyword1" id="Multiset_Extension2-ns_mul_ext_union_compat"><span class="command">lemma</span></span> ns_mul_ext_union_compat<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> ns_mul_ext <span class="free">ns</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"locally_refl <span class="free">ns</span> <span class="free">C</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">C</span><span class="main">,</span> <span class="free">B</span> <span class="main">+</span> <span class="free">C</span><span class="main">)</span> <span class="main">∈</span> ns_mul_ext <span class="free">ns</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms ns_mul_ext_refl_local<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> ns_mul_ext_def s_mul_ext_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> converseI mult2_alt_ns_ns_add<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">NS</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rel"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> NS<span class="main">:</span> <span class="quoted"><span class="quoted">"refl <span class="free">NS</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Multiset_Extension2-refl_imp_locally_refl"><span class="command">lemma</span></span> refl_imp_locally_refl<span class="main">:</span> <span class="quoted"><span class="quoted">"locally_refl <span class="free">NS</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> NS <span class="keyword1"><span class="command">unfolding</span></span> refl_on_def locally_refl_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Multiset_Extension2-supseteq_imp_ns_mul_ext"><span class="command">lemma</span></span> supseteq_imp_ns_mul_ext<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊇#</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> ns_mul_ext <span class="free">NS</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ns_mul_extI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">-</span> <span class="free">B</span>"</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#}</span>"</span></span><span class="main"><span class="main">]</span></span> multpw_refl' refl_imp_locally_refl
      <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subset_mset.add_diff_inverse<span class="main">)</span>

<span class="keyword1" id="Multiset_Extension2-supset_imp_s_mul_ext"><span class="command">lemma</span></span> supset_imp_s_mul_ext<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊃#</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> s_mul_ext <span class="free">NS</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms subset_mset.add_diff_inverse<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> s_mul_extI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">-</span> <span class="free">B</span>"</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#}</span>"</span></span><span class="main"><span class="main">]</span></span> multpw_refl' refl_imp_locally_refl
      <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Diff_eq_empty_iff_mset<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mul_ext</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool <span class="main">×</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> bool <span class="main">×</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">mul_ext</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">≡</span> <span class="keyword1">let</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> fst <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span><span class="main">;</span> <span class="bound">ns</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> snd <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span>
    <span class="keyword1">in</span> <span class="main">(</span><span class="main">(</span>mset <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span>mset <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">∈</span> s_mul_ext <span class="bound">ns</span> <span class="bound">s</span><span class="main">,</span> <span class="main">(</span>mset <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> mset <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">∈</span> ns_mul_ext <span class="bound">ns</span> <span class="bound">s</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">smulextp</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">∈</span> s_mul_ext <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> snd <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> fst <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">nsmulextp</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">∈</span> ns_mul_ext <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> snd <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> fst <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span>"</span></span>


<span class="keyword1" id="Multiset_Extension2-smulextp_cong"><span class="command">lemma</span></span> smulextp_cong<span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs1</span> <span class="main">=</span> <span class="free">ys1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs2</span> <span class="main">=</span> <span class="free">ys2</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="free">ys1</span> <span class="main">⟹</span> <span class="bound">x'</span> <span class="main">∈#</span> <span class="free">ys2</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">x'</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">x</span> <span class="bound">x'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"smulextp <span class="free">f</span> <span class="free">xs1</span> <span class="free">xs2</span> <span class="main">=</span> smulextp <span class="free">g</span> <span class="free">ys1</span> <span class="free">ys2</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> smulextp_def
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs1</span><span class="main">,</span> <span class="free">xs2</span><span class="main">)</span> <span class="main">∈</span> s_mul_ext <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> snd <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> fst <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> s_mul_ext_local_mono<span class="main">[</span><span class="operator">OF</span> _ _ this<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> snd <span class="main">(</span><span class="free">g</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> fst <span class="main">(</span><span class="free">g</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span>"</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ys1</span><span class="main">,</span> <span class="free">ys2</span><span class="main">)</span> <span class="main">∈</span> s_mul_ext <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> snd <span class="main">(</span><span class="free">g</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> fst <span class="main">(</span><span class="free">g</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ys1</span><span class="main">,</span> <span class="free">ys2</span><span class="main">)</span> <span class="main">∈</span> s_mul_ext <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> snd <span class="main">(</span><span class="free">g</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> fst <span class="main">(</span><span class="free">g</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> s_mul_ext_local_mono<span class="main">[</span><span class="operator">OF</span> _ _ this<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> snd <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> fst <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span>"</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs1</span><span class="main">,</span> <span class="free">xs2</span><span class="main">)</span> <span class="main">∈</span> s_mul_ext <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> snd <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> fst <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Multiset_Extension2-nsmulextp_cong"><span class="command">lemma</span></span> nsmulextp_cong<span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs1</span> <span class="main">=</span> <span class="free">ys1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs2</span> <span class="main">=</span> <span class="free">ys2</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="free">ys1</span> <span class="main">⟹</span> <span class="bound">x'</span> <span class="main">∈#</span> <span class="free">ys2</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">x'</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">x</span> <span class="bound">x'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nsmulextp <span class="free">f</span> <span class="free">xs1</span> <span class="free">xs2</span> <span class="main">=</span> nsmulextp <span class="free">g</span> <span class="free">ys1</span> <span class="free">ys2</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> nsmulextp_def
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs1</span><span class="main">,</span> <span class="free">xs2</span><span class="main">)</span> <span class="main">∈</span> ns_mul_ext <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> snd <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> fst <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> ns_mul_ext_local_mono<span class="main">[</span><span class="operator">OF</span> _ _ this<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> snd <span class="main">(</span><span class="free">g</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> fst <span class="main">(</span><span class="free">g</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span>"</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ys1</span><span class="main">,</span> <span class="free">ys2</span><span class="main">)</span> <span class="main">∈</span> ns_mul_ext <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> snd <span class="main">(</span><span class="free">g</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> fst <span class="main">(</span><span class="free">g</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ys1</span><span class="main">,</span> <span class="free">ys2</span><span class="main">)</span> <span class="main">∈</span> ns_mul_ext <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> snd <span class="main">(</span><span class="free">g</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> fst <span class="main">(</span><span class="free">g</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> ns_mul_ext_local_mono<span class="main">[</span><span class="operator">OF</span> _ _ this<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> snd <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> fst <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span>"</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs1</span><span class="main">,</span> <span class="free">xs2</span><span class="main">)</span> <span class="main">∈</span> ns_mul_ext <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> snd <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> fst <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">mulextp</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">(</span>smulextp <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> nsmulextp <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Multiset_Extension2-mulextp_cong"><span class="command">lemma</span></span> mulextp_cong<span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs1</span> <span class="main">=</span> <span class="free">ys1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs2</span> <span class="main">=</span> <span class="free">ys2</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="free">ys1</span> <span class="main">⟹</span> <span class="bound">x'</span> <span class="main">∈#</span> <span class="free">ys2</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">x'</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">x</span> <span class="bound">x'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mulextp <span class="free">f</span> <span class="free">xs1</span> <span class="free">xs2</span> <span class="main">=</span> mulextp <span class="free">g</span> <span class="free">ys1</span> <span class="free">ys2</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mulextp_def <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> nsmulextp_cong smulextp_cong<span class="main">)</span>

<span class="keyword1" id="Multiset_Extension2-mset_s_mul_ext"><span class="command">lemma</span></span> mset_s_mul_ext<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>mset <span class="free">xs</span><span class="main">,</span> mset <span class="free">ys</span><span class="main">)</span> <span class="main">∈</span> s_mul_ext <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> snd <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span>fst <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span> <span class="main">⟷</span>
    fst <span class="main">(</span>mul_ext <span class="free">f</span> <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mul_ext_def Let_def<span class="main">)</span>

<span class="keyword1" id="Multiset_Extension2-mset_ns_mul_ext"><span class="command">lemma</span></span> mset_ns_mul_ext<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>mset <span class="free">xs</span><span class="main">,</span> mset <span class="free">ys</span><span class="main">)</span> <span class="main">∈</span> ns_mul_ext <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> snd <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span>fst <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span> <span class="main">⟷</span>
    snd <span class="main">(</span>mul_ext <span class="free">f</span> <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mul_ext_def Let_def<span class="main">)</span>

<span class="keyword1" id="Multiset_Extension2-smulextp_mset_code"><span class="command">lemma</span></span> smulextp_mset_code<span class="main">:</span>
  <span class="quoted"><span class="quoted">"smulextp <span class="free">f</span> <span class="main">(</span>mset <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>mset <span class="free">ys</span><span class="main">)</span> <span class="main">⟷</span> fst <span class="main">(</span>mul_ext <span class="free">f</span> <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> smulextp_def mset_s_mul_ext <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1" id="Multiset_Extension2-nsmulextp_mset_code"><span class="command">lemma</span></span> nsmulextp_mset_code<span class="main">:</span>
  <span class="quoted"><span class="quoted">"nsmulextp <span class="free">f</span> <span class="main">(</span>mset <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>mset <span class="free">ys</span><span class="main">)</span> <span class="main">⟷</span> snd <span class="main">(</span>mul_ext <span class="free">f</span> <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> nsmulextp_def mset_ns_mul_ext <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1" id="Multiset_Extension2-nstri_mul_ext_map"><span class="command">lemma</span></span> nstri_mul_ext_map<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> set <span class="free">ss</span> <span class="main">⟹</span> <span class="bound">t</span> <span class="main">∈</span> set <span class="free">ts</span> <span class="main">⟹</span> fst <span class="main">(</span><span class="free">order</span> <span class="bound">s</span> <span class="bound">t</span><span class="main">)</span> <span class="main">⟹</span> fst <span class="main">(</span><span class="free">order'</span> <span class="main">(</span><span class="free">f</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> set <span class="free">ss</span> <span class="main">⟹</span> <span class="bound">t</span> <span class="main">∈</span> set <span class="free">ts</span> <span class="main">⟹</span> snd <span class="main">(</span><span class="free">order</span> <span class="bound">s</span> <span class="bound">t</span><span class="main">)</span> <span class="main">⟹</span> snd <span class="main">(</span><span class="free">order'</span> <span class="main">(</span><span class="free">f</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>mul_ext <span class="free">order</span> <span class="free">ss</span> <span class="free">ts</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>mul_ext <span class="free">order'</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">ss</span><span class="main">)</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">ts</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms mult2_alt_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"mset <span class="free">ts</span>"</span></span> <span class="quoted"><span class="quoted">"mset <span class="free">ss</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">.</span> snd <span class="main">(</span><span class="free">order</span> <span class="bound">s</span> <span class="bound">t</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">f</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">.</span> snd <span class="main">(</span><span class="free">order'</span> <span class="bound">s</span> <span class="bound">t</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">.</span> fst <span class="main">(</span><span class="free">order</span> <span class="bound">s</span> <span class="bound">t</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">.</span> fst <span class="main">(</span><span class="free">order'</span> <span class="bound">s</span> <span class="bound">t</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="quoted">True</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mul_ext_def ns_mul_ext_def converse_unfold<span class="main">)</span>

<span class="keyword1" id="Multiset_Extension2-stri_mul_ext_map"><span class="command">lemma</span></span> stri_mul_ext_map<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> set <span class="free">ss</span> <span class="main">⟹</span> <span class="bound">t</span> <span class="main">∈</span> set <span class="free">ts</span> <span class="main">⟹</span> fst <span class="main">(</span><span class="free">order</span> <span class="bound">s</span> <span class="bound">t</span><span class="main">)</span> <span class="main">⟹</span> fst <span class="main">(</span><span class="free">order'</span> <span class="main">(</span><span class="free">f</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> set <span class="free">ss</span> <span class="main">⟹</span> <span class="bound">t</span> <span class="main">∈</span> set <span class="free">ts</span> <span class="main">⟹</span> snd <span class="main">(</span><span class="free">order</span> <span class="bound">s</span> <span class="bound">t</span><span class="main">)</span> <span class="main">⟹</span> snd <span class="main">(</span><span class="free">order'</span> <span class="main">(</span><span class="free">f</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>mul_ext <span class="free">order</span> <span class="free">ss</span> <span class="free">ts</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>mul_ext <span class="free">order'</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">ss</span><span class="main">)</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">ts</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms mult2_alt_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"mset <span class="free">ts</span>"</span></span> <span class="quoted"><span class="quoted">"mset <span class="free">ss</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">.</span> snd <span class="main">(</span><span class="free">order</span> <span class="bound">s</span> <span class="bound">t</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">f</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">.</span> snd <span class="main">(</span><span class="free">order'</span> <span class="bound">s</span> <span class="bound">t</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">.</span> fst <span class="main">(</span><span class="free">order</span> <span class="bound">s</span> <span class="bound">t</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">.</span> fst <span class="main">(</span><span class="free">order'</span> <span class="bound">s</span> <span class="bound">t</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="quoted">False</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mul_ext_def s_mul_ext_def converse_unfold<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The non-strict order is transitive.›</span></span>

<span class="keyword1" id="Multiset_Extension2-ns_mul_ext_trans"><span class="command">lemma</span></span> ns_mul_ext_trans<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">ns</span>"</span></span> <span class="quoted"><span class="quoted">"compatible_l <span class="free">ns</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"compatible_r <span class="free">ns</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"refl <span class="free">ns</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> ns_mul_ext <span class="free">ns</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">B</span><span class="main">,</span> <span class="free">C</span><span class="main">)</span> <span class="main">∈</span> ns_mul_ext <span class="free">ns</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">C</span><span class="main">)</span> <span class="main">∈</span> ns_mul_ext <span class="free">ns</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> compatible_l_def compatible_r_def ns_mul_ext_def
  <span class="keyword1"><span class="command">using</span></span> trans_mult2_ns<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">¯</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ns</span><span class="main">¯</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mult2_ns_eq_mult2_ns_alt converse_relcomp<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> trans_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The strict order is trans.›</span></span>

<span class="keyword1" id="Multiset_Extension2-s_mul_ext_trans"><span class="command">lemma</span></span> s_mul_ext_trans<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">ns</span>"</span></span> <span class="quoted"><span class="quoted">"compatible_l <span class="free">ns</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"compatible_r <span class="free">ns</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"refl <span class="free">ns</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> s_mul_ext <span class="free">ns</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">B</span><span class="main">,</span> <span class="free">C</span><span class="main">)</span> <span class="main">∈</span> s_mul_ext <span class="free">ns</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">C</span><span class="main">)</span> <span class="main">∈</span> s_mul_ext <span class="free">ns</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> compatible_l_def compatible_r_def s_mul_ext_def
  <span class="keyword1"><span class="command">using</span></span> trans_mult2_s<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">¯</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ns</span><span class="main">¯</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mult2_s_eq_mult2_s_alt converse_relcomp<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> trans_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The strict order is compatible on the left with the non strict one›</span></span>

<span class="keyword1" id="Multiset_Extension2-s_ns_mul_ext_trans"><span class="command">lemma</span></span> s_ns_mul_ext_trans<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">ns</span>"</span></span> <span class="quoted"><span class="quoted">"compatible_l <span class="free">ns</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"compatible_r <span class="free">ns</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"refl <span class="free">ns</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> s_mul_ext <span class="free">ns</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">B</span><span class="main">,</span> <span class="free">C</span><span class="main">)</span> <span class="main">∈</span> ns_mul_ext <span class="free">ns</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">C</span><span class="main">)</span> <span class="main">∈</span> s_mul_ext <span class="free">ns</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> compatible_l_def compatible_r_def s_mul_ext_def ns_mul_ext_def
  <span class="keyword1"><span class="command">using</span></span> compat_mult2<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">¯</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ns</span><span class="main">¯</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mult2_s_eq_mult2_s_alt mult2_ns_eq_mult2_ns_alt converse_relcomp<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The strict order is compatible on the right with the non-strict one.›</span></span>

<span class="keyword1" id="Multiset_Extension2-ns_s_mul_ext_trans"><span class="command">lemma</span></span> ns_s_mul_ext_trans<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">ns</span>"</span></span> <span class="quoted"><span class="quoted">"compatible_l <span class="free">ns</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"compatible_r <span class="free">ns</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"refl <span class="free">ns</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> ns_mul_ext <span class="free">ns</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">B</span><span class="main">,</span> <span class="free">C</span><span class="main">)</span> <span class="main">∈</span> s_mul_ext <span class="free">ns</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">C</span><span class="main">)</span> <span class="main">∈</span> s_mul_ext <span class="free">ns</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> compatible_l_def compatible_r_def s_mul_ext_def ns_mul_ext_def
  <span class="keyword1"><span class="command">using</span></span> compat_mult2<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">¯</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ns</span><span class="main">¯</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mult2_s_eq_mult2_s_alt mult2_ns_eq_mult2_ns_alt converse_relcomp<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> s_mul_ext<span class="antiquote"><span class="antiquote">}</span></span></span></span> is strongly normalizing›</span></span>

<span class="keyword1" id="Multiset_Extension2-SN_s_mul_ext_strong"><span class="command">lemma</span></span> SN_s_mul_ext_strong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"order_pair <span class="free">s</span> <span class="free">ns</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈#</span> <span class="free">M</span> <span class="main">⟶</span> SN_on <span class="free">s</span> <span class="main">{</span><span class="bound">y</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"SN_on <span class="main">(</span>s_mul_ext <span class="free">ns</span> <span class="free">s</span><span class="main">)</span> <span class="main">{</span><span class="free">M</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> mult2_s_eq_mult2_s_alt<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">ns</span><span class="main">¯</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">¯</span>"</span></span><span class="main">]</span> assms wf_below_pointwise<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">¯</span>"</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="free">M</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> SN_on_iff_wf_below s_mul_ext_def order_pair_def compat_pair_def pre_order_pair_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf_below_mult2_s_local <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> converse_relcomp<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Multiset_Extension2-SN_s_mul_ext"><span class="command">lemma</span></span> SN_s_mul_ext<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"order_pair <span class="free">s</span> <span class="free">ns</span>"</span></span> <span class="quoted"><span class="quoted">"SN <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"SN <span class="main">(</span>s_mul_ext <span class="free">ns</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> SN_s_mul_ext_strong<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> assms<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> SN_on_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> order_pair<span class="main">)</span> mul_ext_order_pair<span class="main">:</span>
  <span class="quoted"><span class="quoted">"order_pair <span class="main">(</span>s_mul_ext <span class="free">NS</span> <span class="free">S</span><span class="main">)</span> <span class="main">(</span>ns_mul_ext <span class="free">NS</span> <span class="free">S</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"order_pair <span class="var">?S</span> <span class="var">?NS</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">from</span></span> s_mul_ext_trans trans_S trans_NS compat_NS_S compat_S_NS refl_NS
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"trans <span class="var">?S</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> trans_def compatible_l_def compatible_r_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">from</span></span> ns_mul_ext_trans trans_S trans_NS compat_NS_S compat_S_NS refl_NS
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"trans <span class="var">?NS</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> trans_def compatible_l_def compatible_r_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">from</span></span> ns_s_mul_ext_trans trans_S trans_NS compat_NS_S compat_S_NS refl_NS
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?NS</span> <span class="keyword1">O</span> <span class="var">?S</span> <span class="main">⊆</span> <span class="var">?S</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> trans_def compatible_l_def compatible_r_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">from</span></span> s_ns_mul_ext_trans trans_S trans_NS compat_NS_S compat_S_NS refl_NS
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="keyword1">O</span> <span class="var">?NS</span> <span class="main">⊆</span> <span class="var">?S</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> trans_def compatible_l_def compatible_r_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">from</span></span> ns_mul_ext_refl<span class="main">[</span><span class="operator">OF</span> refl_NS<span class="main">,</span> <span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">S</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"refl <span class="var">?NS</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> refl_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> SN_order_pair<span class="main">)</span> mul_ext_SN_order_pair<span class="main">:</span> <span class="quoted"><span class="quoted">"SN_order_pair <span class="main">(</span>s_mul_ext <span class="free">NS</span> <span class="free">S</span><span class="main">)</span> <span class="main">(</span>ns_mul_ext <span class="free">NS</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"SN_order_pair <span class="var">?S</span> <span class="var">?NS</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> mul_ext_order_pair
  <span class="keyword1"><span class="command">interpret</span></span> order_pair <span class="var"><span class="quoted"><span class="var">?S</span></span></span> <span class="var"><span class="quoted"><span class="var">?NS</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"order_pair <span class="free">S</span> <span class="free">NS</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> SN_ars <span class="var"><span class="quoted"><span class="var">?S</span></span></span> <span class="keyword1"><span class="command">using</span></span> SN_s_mul_ext<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="free">NS</span></span><span class="main">]</span> SN <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Multiset_Extension2-mul_ext_compat"><span class="command">lemma</span></span> mul_ext_compat<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> compat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">s</span> <span class="bound">t</span> <span class="bound">u</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">s</span> <span class="main">∈</span> set <span class="free">ss</span><span class="main">;</span> <span class="bound">t</span> <span class="main">∈</span> set <span class="free">ts</span><span class="main">;</span> <span class="bound">u</span> <span class="main">∈</span> set <span class="free">us</span><span class="main">⟧</span> <span class="main">⟹</span>
    <span class="main">(</span>snd <span class="main">(</span><span class="free">f</span> <span class="bound">s</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span> fst <span class="main">(</span><span class="free">f</span> <span class="bound">t</span> <span class="bound">u</span><span class="main">)</span> <span class="main">⟶</span> fst <span class="main">(</span><span class="free">f</span> <span class="bound">s</span> <span class="bound">u</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span>fst <span class="main">(</span><span class="free">f</span> <span class="bound">s</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span> snd <span class="main">(</span><span class="free">f</span> <span class="bound">t</span> <span class="bound">u</span><span class="main">)</span> <span class="main">⟶</span> fst <span class="main">(</span><span class="free">f</span> <span class="bound">s</span> <span class="bound">u</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span>snd <span class="main">(</span><span class="free">f</span> <span class="bound">s</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span> snd <span class="main">(</span><span class="free">f</span> <span class="bound">t</span> <span class="bound">u</span><span class="main">)</span> <span class="main">⟶</span> snd <span class="main">(</span><span class="free">f</span> <span class="bound">s</span> <span class="bound">u</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span>fst <span class="main">(</span><span class="free">f</span> <span class="bound">s</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span> fst <span class="main">(</span><span class="free">f</span> <span class="bound">t</span> <span class="bound">u</span><span class="main">)</span> <span class="main">⟶</span> fst <span class="main">(</span><span class="free">f</span> <span class="bound">s</span> <span class="bound">u</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"
    <span class="main">(</span>snd <span class="main">(</span>mul_ext <span class="free">f</span> <span class="free">ss</span> <span class="free">ts</span><span class="main">)</span> <span class="main">∧</span> fst <span class="main">(</span>mul_ext <span class="free">f</span> <span class="free">ts</span> <span class="free">us</span><span class="main">)</span> <span class="main">⟶</span> fst <span class="main">(</span>mul_ext <span class="free">f</span> <span class="free">ss</span> <span class="free">us</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span>fst <span class="main">(</span>mul_ext <span class="free">f</span> <span class="free">ss</span> <span class="free">ts</span><span class="main">)</span> <span class="main">∧</span> snd <span class="main">(</span>mul_ext <span class="free">f</span> <span class="free">ts</span> <span class="free">us</span><span class="main">)</span> <span class="main">⟶</span> fst <span class="main">(</span>mul_ext <span class="free">f</span> <span class="free">ss</span> <span class="free">us</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span>snd <span class="main">(</span>mul_ext <span class="free">f</span> <span class="free">ss</span> <span class="free">ts</span><span class="main">)</span> <span class="main">∧</span> snd <span class="main">(</span>mul_ext <span class="free">f</span> <span class="free">ts</span> <span class="free">us</span><span class="main">)</span> <span class="main">⟶</span> snd <span class="main">(</span>mul_ext <span class="free">f</span> <span class="free">ss</span> <span class="free">us</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span>fst <span class="main">(</span>mul_ext <span class="free">f</span> <span class="free">ss</span> <span class="free">ts</span><span class="main">)</span> <span class="main">∧</span> fst <span class="main">(</span>mul_ext <span class="free">f</span> <span class="free">ts</span> <span class="free">us</span><span class="main">)</span> <span class="main">⟶</span> fst <span class="main">(</span>mul_ext <span class="free">f</span> <span class="free">ss</span> <span class="free">us</span><span class="main">)</span><span class="main">)</span> "</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> fst <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span><span class="main">¯</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?ns</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> snd <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span><span class="main">¯</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mset <span class="free">ts</span><span class="main">,</span> mset <span class="free">ss</span><span class="main">)</span> <span class="main">∈</span> mult2_alt <span class="skolem">b2</span> <span class="var">?ns</span> <span class="var">?s</span> <span class="main">⟹</span> <span class="main">(</span>mset <span class="free">us</span><span class="main">,</span> mset <span class="free">ts</span><span class="main">)</span> <span class="main">∈</span> mult2_alt <span class="skolem">b1</span> <span class="var">?ns</span> <span class="var">?s</span> <span class="main">⟹</span>
    <span class="main">(</span>mset <span class="free">us</span><span class="main">,</span> mset <span class="free">ss</span><span class="main">)</span> <span class="main">∈</span> mult2_alt <span class="main">(</span><span class="skolem">b1</span> <span class="main">∧</span> <span class="skolem">b2</span><span class="main">)</span> <span class="var">?ns</span> <span class="var">?s</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">b1</span> <span class="skolem">b2</span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trans_mult2_alt_local<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"mset <span class="free">ts</span>"</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_multiset_in_set<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mul_ext_def s_mul_ext_def ns_mul_ext_def Let_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Multiset_Extension2-mul_ext_cong"><span class="command">lemma</span></span> mul_ext_cong<span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mset <span class="free">xs1</span> <span class="main">=</span> mset <span class="free">ys1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"mset <span class="free">xs2</span> <span class="main">=</span> mset <span class="free">ys2</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">ys1</span> <span class="main">⟹</span> <span class="bound">x'</span> <span class="main">∈</span> set <span class="free">ys2</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">x'</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">x</span> <span class="bound">x'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mul_ext <span class="free">f</span> <span class="free">xs1</span> <span class="free">xs2</span> <span class="main">=</span> mul_ext <span class="free">g</span> <span class="free">ys1</span> <span class="free">ys2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
    mult2_alt_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"mset <span class="free">xs2</span>"</span></span> <span class="quoted"><span class="quoted">"mset <span class="free">xs1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> snd <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span><span class="main">¯</span>"</span></span> <span class="quoted">id</span> <span class="quoted">id</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> snd <span class="main">(</span><span class="free">g</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span><span class="main">¯</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> fst <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span><span class="main">¯</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> fst <span class="main">(</span><span class="free">g</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span><span class="main">¯</span>"</span></span><span class="main">]</span>
    mult2_alt_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"mset <span class="free">ys2</span>"</span></span> <span class="quoted"><span class="quoted">"mset <span class="free">ys1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> snd <span class="main">(</span><span class="free">g</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span><span class="main">¯</span>"</span></span> <span class="quoted">id</span> <span class="quoted">id</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> snd <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span><span class="main">¯</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> fst <span class="main">(</span><span class="free">g</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span><span class="main">¯</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> fst <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span><span class="main">¯</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mul_ext_def s_mul_ext_def ns_mul_ext_def Let_def in_multiset_in_set<span class="main">)</span>

<span class="keyword1" id="Multiset_Extension2-all_nstri_imp_mul_nstri"><span class="command">lemma</span></span> all_nstri_imp_mul_nstri<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="free">ys</span><span class="main">.</span> snd <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">ys</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>mul_ext <span class="free">f</span> <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">ys</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">,</span> <span class="free">ys</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> snd <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> all_ns_ns_mul_ext<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mul_ext_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Multiset_Extension2-relation_inter"><span class="command">lemma</span></span> relation_inter<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">}</span> <span class="main">∩</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Multiset_Extension2-mul_ext_unfold"><span class="command">lemma</span></span> mul_ext_unfold<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">.</span> fst <span class="main">(</span>mul_ext <span class="free">g</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span><span class="main">}</span> <span class="main">⟷</span> <span class="main">(</span>mset <span class="free">x</span><span class="main">,</span> mset <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>s_mul_ext <span class="main">{</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">.</span> snd <span class="main">(</span><span class="free">g</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span><span class="main">}</span> <span class="main">{</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">.</span> fst <span class="main">(</span><span class="free">g</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mul_ext_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The next lemma is a local version of strong-normalization of
  the multiset extension, where the base-order only has to be strongly normalizing
  on elements of the multisets. This will be crucial for orders that are defined recursively
  on terms, such as RPO or WPO.›</span></span>
<span class="keyword1" id="Multiset_Extension2-mul_ext_SN"><span class="command">lemma</span></span> mul_ext_SN<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> snd <span class="main">(</span><span class="free">g</span> <span class="bound">x</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> fst <span class="main">(</span><span class="free">g</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="main">⟶</span> snd <span class="main">(</span><span class="free">g</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">)</span> <span class="main">⟶</span> fst <span class="main">(</span><span class="free">g</span> <span class="bound">x</span> <span class="bound">z</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> snd <span class="main">(</span><span class="free">g</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="main">⟶</span> fst <span class="main">(</span><span class="free">g</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">)</span> <span class="main">⟶</span> fst <span class="main">(</span><span class="free">g</span> <span class="bound">x</span> <span class="bound">z</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> snd <span class="main">(</span><span class="free">g</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="main">⟶</span> snd <span class="main">(</span><span class="free">g</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">)</span> <span class="main">⟶</span> snd <span class="main">(</span><span class="free">g</span> <span class="bound">x</span> <span class="bound">z</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> fst <span class="main">(</span><span class="free">g</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="main">⟶</span> fst <span class="main">(</span><span class="free">g</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">)</span> <span class="main">⟶</span> fst <span class="main">(</span><span class="free">g</span> <span class="bound">x</span> <span class="bound">z</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"SN <span class="main">{</span><span class="main">(</span><span class="bound">ys</span><span class="main">,</span> <span class="bound">xs</span><span class="main">)</span><span class="main">.</span>
  <span class="main">(</span><span class="main">∀</span><span class="bound">y</span><span class="main">∈</span>set <span class="bound">ys</span><span class="main">.</span> SN_on <span class="main">{</span><span class="main">(</span><span class="bound">s</span> <span class="main">,</span><span class="bound">t</span><span class="main">)</span><span class="main">.</span> fst <span class="main">(</span><span class="free">g</span> <span class="bound">s</span> <span class="bound">t</span><span class="main">)</span><span class="main">}</span> <span class="main">{</span><span class="bound">y</span><span class="main">}</span><span class="main">)</span> <span class="main">∧</span>
  fst <span class="main">(</span>mul_ext <span class="free">g</span> <span class="bound">ys</span> <span class="bound">xs</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?R1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span> set <span class="bound">ys</span><span class="main">.</span> SN_on <span class="main">{</span><span class="main">(</span><span class="bound">s</span> <span class="main">,</span><span class="bound">t</span><span class="main">)</span><span class="main">.</span> fst <span class="main">(</span><span class="free">g</span> <span class="bound">s</span> <span class="bound">t</span><span class="main">)</span><span class="main">}</span> <span class="main">{</span><span class="bound">y</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?R2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> fst <span class="main">(</span>mul_ext <span class="free">g</span> <span class="bound">ys</span> <span class="bound">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> fst <span class="main">(</span><span class="free">g</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?ns</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> snd <span class="main">(</span><span class="free">g</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> OP<span class="main">:</span> <span class="quoted"><span class="quoted">"order_pair <span class="var">?s</span> <span class="var">?ns</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1-5<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="main">(</span><span class="operator">unfold</span> refl_on_def trans_def<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">ys</span><span class="main">,</span> <span class="bound">xs</span><span class="main">)</span><span class="main">.</span> <span class="var">?R1</span> <span class="bound">xs</span> <span class="bound">ys</span> <span class="main">∧</span> <span class="var">?R2</span> <span class="bound">xs</span> <span class="bound">ys</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Sn</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"SN_on <span class="var">?R</span>"</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ys</span> <span class="skolem">xs</span>
    <span class="keyword3"><span class="command">assume</span></span> R_ys_xs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ys</span><span class="main">,</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mys</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"mset <span class="skolem">ys</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mxs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"mset <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> R_ys_xs <span class="keyword1"><span class="command">have</span></span>  HSN_ys<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="skolem">ys</span> <span class="main">⟶</span> SN_on <span class="var">?s</span> <span class="main">{</span><span class="bound">y</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> in_multiset_in_set<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">ys</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈#</span> <span class="var">?mys</span> <span class="main">⟶</span> SN_on <span class="var">?s</span> <span class="main">{</span><span class="bound">y</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> SN_s_mul_ext_strong<span class="main">[</span><span class="operator">OF</span> OP this<span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> mul_ext_unfold
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"SN_on <span class="main">{</span><span class="main">(</span><span class="bound">ys</span><span class="main">,</span><span class="bound">xs</span><span class="main">)</span><span class="main">.</span> fst <span class="main">(</span>mul_ext <span class="free">g</span> <span class="bound">ys</span> <span class="bound">xs</span><span class="main">)</span><span class="main">}</span> <span class="main">{</span><span class="skolem">ys</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">from</span></span> relation_inter<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?R2</span></span></span> <span class="var"><span class="quoted"><span class="var">?R1</span></span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> SN_on_weakening<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"SN_on <span class="var">?R</span> <span class="main">{</span><span class="skolem">ys</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> Hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">ys</span> <span class="bound">xs</span><span class="main">.</span> <span class="main">(</span><span class="bound">ys</span><span class="main">,</span><span class="bound">xs</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?R</span> <span class="main">⟶</span> SN_on <span class="var">?R</span> <span class="main">{</span><span class="bound">ys</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ys</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"SN_on <span class="var">?R</span> <span class="main">{</span><span class="skolem">ys</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">xs</span><span class="main">.</span> <span class="main">(</span><span class="skolem">ys</span><span class="main">,</span> <span class="bound">xs</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> Hyp <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> SN_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Multiset_Extension2-mul_ext_stri_imp_nstri"><span class="command">lemma</span></span> mul_ext_stri_imp_nstri<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>mul_ext <span class="free">f</span> <span class="free">as</span> <span class="free">bs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>mul_ext <span class="free">f</span> <span class="free">as</span> <span class="free">bs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword2"><span class="keyword">and</span></span> s_ns_mul_ext <span class="keyword1"><span class="command">unfolding</span></span> mul_ext_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1" id="Multiset_Extension2-ns_ns_mul_ext_union_compat"><span class="command">lemma</span></span> ns_ns_mul_ext_union_compat<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="main">,</span><span class="free">B</span><span class="main">)</span> <span class="main">∈</span> ns_mul_ext <span class="free">ns</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">C</span><span class="main">,</span><span class="free">D</span><span class="main">)</span> <span class="main">∈</span> ns_mul_ext <span class="free">ns</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">C</span><span class="main">,</span> <span class="free">B</span> <span class="main">+</span> <span class="free">D</span><span class="main">)</span> <span class="main">∈</span> ns_mul_ext <span class="free">ns</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ns_mul_ext_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> mult2_alt_ns_ns_add<span class="main">)</span>

<span class="keyword1" id="Multiset_Extension2-s_ns_mul_ext_union_compat"><span class="command">lemma</span></span> s_ns_mul_ext_union_compat<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="main">,</span><span class="free">B</span><span class="main">)</span> <span class="main">∈</span> s_mul_ext <span class="free">ns</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">C</span><span class="main">,</span><span class="free">D</span><span class="main">)</span> <span class="main">∈</span> ns_mul_ext <span class="free">ns</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">C</span><span class="main">,</span> <span class="free">B</span> <span class="main">+</span> <span class="free">D</span><span class="main">)</span> <span class="main">∈</span> s_mul_ext <span class="free">ns</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> s_mul_ext_def ns_mul_ext_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> mult2_alt_s_ns_add<span class="main">)</span>

<span class="keyword1" id="Multiset_Extension2-ns_ns_mul_ext_union_compat_rtrancl"><span class="command">lemma</span></span> ns_ns_mul_ext_union_compat_rtrancl<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> refl<span class="main">:</span> <span class="quoted"><span class="quoted">"refl <span class="free">ns</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> AB<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>ns_mul_ext <span class="free">ns</span> <span class="free">s</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> CD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="free">D</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>ns_mul_ext <span class="free">ns</span> <span class="free">s</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">C</span><span class="main">,</span> <span class="free">B</span> <span class="main">+</span> <span class="free">D</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>ns_mul_ext <span class="free">ns</span> <span class="free">s</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">C</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>ns_mul_ext <span class="free">ns</span> <span class="free">s</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span> <span class="main">+</span> <span class="skolem">C</span><span class="main">,</span> <span class="skolem">B</span> <span class="main">+</span> <span class="skolem">C</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>ns_mul_ext <span class="free">ns</span> <span class="free">s</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rtrancl_induct<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">B</span> <span class="skolem">D</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">C</span><span class="main">,</span> <span class="skolem">C</span><span class="main">)</span> <span class="main">∈</span> ns_mul_ext <span class="free">ns</span> <span class="free">s</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ns_mul_ext_refl<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> refl<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> locally_refl_def refl_on_def<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> ns_ns_mul_ext_union_compat<span class="main">[</span><span class="operator">OF</span> step<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> this<span class="main">]</span> step<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">OF</span> AB<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">C</span></span><span class="main">]</span> this<span class="main">[</span><span class="operator">OF</span> CD<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">B</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Multisets as order on lists›</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> mul_ext_list<span class="main">:</span> list_order_extension
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span> <span class="bound">ns</span><span class="main">.</span> <span class="main">{</span><span class="main">(</span><span class="bound">as</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>mset <span class="bound">as</span><span class="main">,</span> mset <span class="bound">bs</span><span class="main">)</span> <span class="main">∈</span> s_mul_ext <span class="bound">ns</span> <span class="bound">s</span><span class="main">}</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span> <span class="bound">ns</span><span class="main">.</span> <span class="main">{</span><span class="main">(</span><span class="bound">as</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>mset <span class="bound">as</span><span class="main">,</span> mset <span class="bound">bs</span><span class="main">)</span> <span class="main">∈</span> ns_mul_ext <span class="bound">ns</span> <span class="bound">s</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?m</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"mset <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> multiset<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?S</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span> <span class="bound">ns</span><span class="main">.</span> <span class="main">{</span><span class="main">(</span><span class="bound">as</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="var">?m</span> <span class="bound">as</span><span class="main">,</span> <span class="var">?m</span> <span class="bound">bs</span><span class="main">)</span> <span class="main">∈</span> s_mul_ext <span class="bound">ns</span> <span class="bound">s</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?NS</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span> <span class="bound">ns</span><span class="main">.</span> <span class="main">{</span><span class="main">(</span><span class="bound">as</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="var">?m</span> <span class="bound">as</span><span class="main">,</span> <span class="var">?m</span> <span class="bound">bs</span><span class="main">)</span> <span class="main">∈</span> ns_mul_ext <span class="bound">ns</span> <span class="bound">s</span><span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"list_order_extension <span class="var">?S</span> <span class="var">?NS</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> list_order_extension.intro<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">ns</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="skolem">s</span> <span class="skolem">ns</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ns</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?NS</span> <span class="skolem">s</span> <span class="skolem">ns</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"SN_order_pair <span class="skolem">s</span> <span class="skolem">ns</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> SN_order_pair <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">ns</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">interpret</span></span> SN_order_pair <span class="quoted"><span class="quoted">"<span class="main">(</span>s_mul_ext <span class="skolem">ns</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ns_mul_ext <span class="skolem">ns</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mul_ext_SN_order_pair<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"SN_order_pair <span class="var">?s</span> <span class="var">?ns</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"refl <span class="var">?ns</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> refl_NS <span class="keyword1"><span class="command">unfolding</span></span> refl_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ns</span> <span class="keyword1">O</span> <span class="var">?s</span> <span class="main">⊆</span> <span class="var">?s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> compat_NS_S <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?s</span> <span class="keyword1">O</span> <span class="var">?ns</span> <span class="main">⊆</span> <span class="var">?s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> compat_S_NS <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"trans <span class="var">?ns</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> trans_NS <span class="keyword1"><span class="command">unfolding</span></span> trans_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"trans <span class="var">?s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> trans_S <span class="keyword1"><span class="command">unfolding</span></span> trans_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"SN <span class="var">?s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> SN_inv_image<span class="main">[</span><span class="operator">OF</span> SN<span class="main">,</span> <span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?m</span></span></span><span class="main">,</span> <span class="operator">unfolded</span> inv_image_def<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">S</span> <span class="skolem">f</span> <span class="skolem">NS</span> <span class="skolem">as</span> <span class="skolem">bs</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">S</span> <span class="main">⟹</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">a</span><span class="main">,</span> <span class="skolem">f</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">S</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">NS</span> <span class="main">⟹</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">a</span><span class="main">,</span> <span class="skolem">f</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">NS</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">as</span><span class="main">,</span> <span class="skolem">bs</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?S</span> <span class="skolem">S</span> <span class="skolem">NS</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="skolem">f</span> <span class="skolem">as</span><span class="main">,</span> map <span class="skolem">f</span> <span class="skolem">bs</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?S</span> <span class="skolem">S</span> <span class="skolem">NS</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> mult2_alt_map<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="skolem">NS</span><span class="main">¯</span>"</span></span> <span class="quoted"><span class="skolem">f</span></span> <span class="quoted"><span class="skolem">f</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">NS</span><span class="main">¯</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span><span class="main">¯</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span><span class="main">¯</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mset_map s_mul_ext_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">S</span> <span class="skolem">f</span> <span class="skolem">NS</span> <span class="skolem">as</span> <span class="skolem">bs</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">S</span> <span class="main">⟹</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">a</span><span class="main">,</span> <span class="skolem">f</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">S</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">NS</span> <span class="main">⟹</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">a</span><span class="main">,</span> <span class="skolem">f</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">NS</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">as</span><span class="main">,</span> <span class="skolem">bs</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?NS</span> <span class="skolem">S</span> <span class="skolem">NS</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="skolem">f</span> <span class="skolem">as</span><span class="main">,</span> map <span class="skolem">f</span> <span class="skolem">bs</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?NS</span> <span class="skolem">S</span> <span class="skolem">NS</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> mult2_alt_map<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="skolem">NS</span><span class="main">¯</span>"</span></span> <span class="quoted"><span class="skolem">f</span></span> <span class="quoted"><span class="skolem">f</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">NS</span><span class="main">¯</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span><span class="main">¯</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span><span class="main">¯</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mset_map ns_mul_ext_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">as</span> <span class="skolem">bs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">NS</span> <span class="skolem">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rel"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> ass<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">as</span> <span class="main">=</span> length <span class="skolem">bs</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="skolem">bs</span> <span class="main">⟹</span> <span class="main">(</span><span class="skolem">as</span> <span class="main">!</span> <span class="bound">i</span><span class="main">,</span> <span class="skolem">bs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">NS</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">as</span><span class="main">,</span> <span class="skolem">bs</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?NS</span> <span class="skolem">S</span> <span class="skolem">NS</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> split<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> all_ns_ns_mul_ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> ass<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Multiset_Extension2-s_mul_ext_singleton"><span class="command">lemma</span></span> s_mul_ext_singleton <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{#</span><span class="free">a</span><span class="main">#}</span><span class="main">,</span> <span class="main">{#</span><span class="free">b</span><span class="main">#}</span><span class="main">)</span> <span class="main">∈</span> s_mul_ext <span class="free">ns</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> s_mul_ext_def mult2_alt_s_single<span class="main">)</span>

<span class="keyword1" id="Multiset_Extension2-ns_mul_ext_singleton"><span class="command">lemma</span></span> ns_mul_ext_singleton <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ns</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">{#</span><span class="free">a</span><span class="main">#}</span><span class="main">,</span> <span class="main">{#</span><span class="free">b</span><span class="main">#}</span><span class="main">)</span> <span class="main">∈</span> ns_mul_ext <span class="free">ns</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ns_mul_ext_def multpw_converse <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> multpw_implies_mult2_alt_ns multpw_single<span class="main">)</span>

<span class="keyword1" id="Multiset_Extension2-ns_mul_ext_singleton2"><span class="command">lemma</span></span> ns_mul_ext_singleton2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">{#</span><span class="free">a</span><span class="main">#}</span><span class="main">,</span> <span class="main">{#</span><span class="free">b</span><span class="main">#}</span><span class="main">)</span> <span class="main">∈</span> ns_mul_ext <span class="free">ns</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> s_ns_mul_ext s_mul_ext_singleton<span class="main">)</span>

<span class="keyword1" id="Multiset_Extension2-s_mul_ext_self_extend_left"><span class="command">lemma</span></span> s_mul_ext_self_extend_left<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"locally_refl <span class="free">W</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">B</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> s_mul_ext <span class="free">W</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">B</span><span class="main">,</span> <span class="main">{#}</span> <span class="main">+</span> <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> s_mul_ext <span class="free">W</span> <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> s_mul_ext_union_compat<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> s_mul_ext_bottom<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Multiset_Extension2-s_mul_ext_ne_extend_left"><span class="command">lemma</span></span> s_mul_ext_ne_extend_left<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">B</span><span class="main">,</span> <span class="free">C</span><span class="main">)</span> <span class="main">∈</span> ns_mul_ext <span class="free">W</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">B</span><span class="main">,</span> <span class="free">C</span><span class="main">)</span> <span class="main">∈</span> s_mul_ext <span class="free">W</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">B</span><span class="main">,</span> <span class="main">{#}</span> <span class="main">+</span> <span class="free">C</span><span class="main">)</span> <span class="main">∈</span> s_mul_ext <span class="free">W</span> <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> s_ns_mul_ext_union_compat<span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> s_mul_ext_bottom <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> s_ns_mul_ext<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Multiset_Extension2-s_mul_ext_extend_left"><span class="command">lemma</span></span> s_mul_ext_extend_left<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">B</span><span class="main">,</span> <span class="free">C</span><span class="main">)</span> <span class="main">∈</span> s_mul_ext <span class="free">W</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">B</span><span class="main">,</span> <span class="free">C</span><span class="main">)</span> <span class="main">∈</span> s_mul_ext <span class="free">W</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">B</span> <span class="main">+</span> <span class="free">A</span><span class="main">,</span> <span class="free">C</span> <span class="main">+</span> <span class="main">{#}</span><span class="main">)</span> <span class="main">∈</span> s_mul_ext <span class="free">W</span> <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> s_ns_mul_ext_union_compat<span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ns_mul_ext_bottom <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> s_ns_mul_ext<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Multiset_Extension2-mul_ext_mono"><span class="command">lemma</span></span> mul_ext_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">;</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="free">ys</span><span class="main">;</span> fst <span class="main">(</span><span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> fst <span class="main">(</span><span class="free">P'</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">;</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="free">ys</span><span class="main">;</span> snd <span class="main">(</span><span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> snd <span class="main">(</span><span class="free">P'</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"fst <span class="main">(</span>mul_ext <span class="free">P</span> <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">⟹</span> fst <span class="main">(</span>mul_ext <span class="free">P'</span> <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"snd <span class="main">(</span>mul_ext <span class="free">P</span> <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">⟹</span> snd <span class="main">(</span>mul_ext <span class="free">P'</span> <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mul_ext_def Let_def fst_conv snd_conv
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mset <span class="free">xs</span><span class="main">,</span> mset <span class="free">ys</span><span class="main">)</span> <span class="main">∈</span> s_mul_ext <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> snd <span class="main">(</span><span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> fst <span class="main">(</span><span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mset <span class="free">xs</span><span class="main">,</span> mset <span class="free">ys</span><span class="main">)</span> <span class="main">∈</span> s_mul_ext <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> snd <span class="main">(</span><span class="free">P'</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> fst <span class="main">(</span><span class="free">P'</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> s_mul_ext_local_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ mem<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mset <span class="free">xs</span><span class="main">,</span> mset <span class="free">ys</span><span class="main">)</span> <span class="main">∈</span> ns_mul_ext <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> snd <span class="main">(</span><span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> fst <span class="main">(</span><span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mset <span class="free">xs</span><span class="main">,</span> mset <span class="free">ys</span><span class="main">)</span> <span class="main">∈</span> ns_mul_ext <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> snd <span class="main">(</span><span class="free">P'</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> fst <span class="main">(</span><span class="free">P'</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ns_mul_ext_local_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ mem<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Special case: non-strict order is equality›</span></span>

<span class="keyword1" id="Multiset_Extension2-ns_mul_ext_IdE"><span class="command">lemma</span></span> ns_mul_ext_IdE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M</span><span class="main">,</span> <span class="free">N</span><span class="main">)</span> <span class="main">∈</span> ns_mul_ext Id <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">X</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">Y</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">Z</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> <span class="free">X</span> <span class="main">+</span> <span class="free">Z</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">=</span> <span class="free">Y</span> <span class="main">+</span> <span class="free">Z</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> set_mset <span class="free">Y</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x</span> <span class="main">∈</span> set_mset <span class="free">X</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ns_mul_ext_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mult2_alt_nsE<span class="main">)</span> <span class="main">(</span><span class="operator">insert</span> union_commute<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1" id="Multiset_Extension2-ns_mul_ext_IdI"><span class="command">lemma</span></span> ns_mul_ext_IdI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> <span class="free">X</span> <span class="main">+</span> <span class="free">Z</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">=</span> <span class="free">Y</span> <span class="main">+</span> <span class="free">Z</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> set_mset <span class="free">Y</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x</span> <span class="main">∈</span> set_mset <span class="free">X</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M</span><span class="main">,</span> <span class="free">N</span><span class="main">)</span> <span class="main">∈</span> ns_mul_ext Id <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms mult2_alt_nsI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">N</span></span> <span class="quoted"><span class="free">Z</span></span> <span class="quoted"><span class="free">Y</span></span> <span class="quoted"><span class="free">M</span></span> <span class="quoted"><span class="free">Z</span></span> <span class="quoted"><span class="free">X</span></span> <span class="quoted">Id</span> <span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">¯</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ns_mul_ext_def<span class="main">)</span>

<span class="keyword1" id="Multiset_Extension2-s_mul_ext_IdE"><span class="command">lemma</span></span> s_mul_ext_IdE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M</span><span class="main">,</span> <span class="free">N</span><span class="main">)</span> <span class="main">∈</span> s_mul_ext Id <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">X</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">Y</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">Z</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> <span class="free">X</span> <span class="main">+</span> <span class="free">Z</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">=</span> <span class="free">Y</span> <span class="main">+</span> <span class="free">Z</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> set_mset <span class="free">Y</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x</span> <span class="main">∈</span> set_mset <span class="free">X</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> s_mul_ext_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mult2_alt_sE<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> union_commute<span class="main">)</span>

<span class="keyword1" id="Multiset_Extension2-s_mul_ext_IdI"><span class="command">lemma</span></span> s_mul_ext_IdI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> <span class="free">X</span> <span class="main">+</span> <span class="free">Z</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">=</span> <span class="free">Y</span> <span class="main">+</span> <span class="free">Z</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> set_mset <span class="free">Y</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x</span> <span class="main">∈</span> set_mset <span class="free">X</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M</span><span class="main">,</span> <span class="free">N</span><span class="main">)</span> <span class="main">∈</span> s_mul_ext Id <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms mult2_alt_sI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">N</span></span> <span class="quoted"><span class="free">Z</span></span> <span class="quoted"><span class="free">Y</span></span> <span class="quoted"><span class="free">M</span></span> <span class="quoted"><span class="free">Z</span></span> <span class="quoted"><span class="free">X</span></span> <span class="quoted">Id</span> <span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">¯</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> s_mul_ext_def <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>

<span class="keyword1" id="Multiset_Extension2-mult_s_mul_ext_conv"><span class="command">lemma</span></span> mult_s_mul_ext_conv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mult <span class="main">(</span><span class="free">R</span><span class="main">¯</span><span class="main">)</span><span class="main">)</span><span class="main">¯</span> <span class="main">=</span> s_mul_ext Id <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> mult2_s_eq_mult2_s_alt<span class="main">[</span><span class="operator">of</span> <span class="quoted">Id</span> <span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">¯</span>"</span></span><span class="main">]</span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> s_mul_ext_def refl_Id mult2_s_def<span class="main">)</span>

<span class="keyword1" id="Multiset_Extension2-ns_mul_ext_Id_eq"><span class="command">lemma</span></span> ns_mul_ext_Id_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ns_mul_ext Id <span class="free">R</span> <span class="main">=</span> <span class="main">(</span>s_mul_ext Id <span class="free">R</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>=</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ns_mul_ext_def s_mul_ext_def mult2_alt_ns_conv<span class="main">)</span>

<span class="keyword1" id="Multiset_Extension2-subseteq_mset_imp_ns_mul_ext_Id"><span class="command">lemma</span></span> subseteq_mset_imp_ns_mul_ext_Id<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆#</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">B</span><span class="main">,</span> <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> ns_mul_ext Id <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">=</span> <span class="skolem">C</span> <span class="main">+</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mset_subset_eq_exists_conv <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">C</span> <span class="main">+</span> <span class="free">A</span><span class="main">,</span> <span class="main">{#}</span> <span class="main">+</span> <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> ns_mul_ext Id <span class="free">R</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ns_mul_ext_IdI <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">C</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">A</span></span></span></span></span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">{#}</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Multiset_Extension2-subset_mset_imp_s_mul_ext_Id"><span class="command">lemma</span></span> subset_mset_imp_s_mul_ext_Id<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊂#</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">B</span><span class="main">,</span> <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> s_mul_ext Id <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> supset_imp_s_mul_ext<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> refl_Id<span class="main">)</span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Multiset_Extension2_Impl">
<div class="head">
<h1>Theory Multiset_Extension2_Impl</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Executable version›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Multiset_Extension2_Impl
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/DAList_Multiset.html">HOL-Library.DAList_Multiset</a>"</span>
  <a href="#List_Order">List_Order</a>
  <a href="#Multiset_Extension2">Multiset_Extension2</a> 
  <a href="#Multiset_Extension_Pair_Impl">Multiset_Extension_Pair_Impl</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(**
We use the lifting when it is sufficient to prove the non-strict
domination to also prove the strict one. For example if [a &gt; x] then
it is sufficient to prove that [A ≥ X] to get [A + {#a#} &gt; X + {#x#}]
**)</span>

<span class="keyword1" id="Multiset_Extension2_Impl-mul_ext_list_ext"><span class="command">lemma</span></span> mul_ext_list_ext<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">s</span> <span class="bound">ns</span><span class="main">.</span> list_order_extension_impl <span class="bound">s</span> <span class="bound">ns</span> mul_ext"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">s</span> <span class="bound">ns</span><span class="main">.</span> <span class="main">{</span><span class="main">(</span><span class="bound">as</span><span class="main">,</span><span class="bound">bs</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>mset <span class="bound">as</span><span class="main">,</span> mset <span class="bound">bs</span><span class="main">)</span> <span class="main">∈</span> s_mul_ext <span class="bound">ns</span> <span class="bound">s</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ns</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">s</span> <span class="bound">ns</span><span class="main">.</span> <span class="main">{</span><span class="main">(</span><span class="bound">as</span><span class="main">,</span><span class="bound">bs</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>mset <span class="bound">as</span><span class="main">,</span> mset <span class="bound">bs</span><span class="main">)</span> <span class="main">∈</span> ns_mul_ext <span class="bound">ns</span> <span class="bound">s</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?m</span></span></span> <span class="main">=</span> <span class="quoted">mset</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"list_order_extension_impl <span class="var">?s</span> <span class="var">?ns</span> mul_ext"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">ns</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?s</span> <span class="main">{</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="skolem">s</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">}</span> <span class="main">{</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="skolem">ns</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">as</span><span class="main">,</span><span class="bound">bs</span><span class="main">)</span><span class="main">.</span> fst <span class="main">(</span>mul_ext <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="skolem">s</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">,</span> <span class="skolem">ns</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="bound">as</span> <span class="bound">bs</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> mul_ext_def Let_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">ns</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ns</span> <span class="main">{</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="skolem">s</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">}</span> <span class="main">{</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="skolem">ns</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">as</span><span class="main">,</span><span class="bound">bs</span><span class="main">)</span><span class="main">.</span> snd <span class="main">(</span>mul_ext <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="skolem">s</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">,</span> <span class="skolem">ns</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="bound">as</span> <span class="bound">bs</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> mul_ext_def Let_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">ns</span> <span class="skolem">s'</span> <span class="skolem">ns'</span> <span class="skolem">as</span> <span class="skolem">bs</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">as</span> <span class="main">×</span> set <span class="skolem">bs</span> <span class="main">∩</span> <span class="skolem">ns</span> <span class="main">⊆</span> <span class="skolem">ns'</span>"</span></span>
           <span class="quoted"><span class="quoted">"set <span class="skolem">as</span> <span class="main">×</span> set <span class="skolem">bs</span> <span class="main">∩</span> <span class="skolem">s</span> <span class="main">⊆</span> <span class="skolem">s'</span>"</span></span>
           <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">as</span><span class="main">,</span><span class="skolem">bs</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?s</span> <span class="skolem">s</span> <span class="skolem">ns</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">as</span><span class="main">,</span><span class="skolem">bs</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?s</span> <span class="skolem">s'</span> <span class="skolem">ns'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> s_mul_ext_local_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="var">?m</span> <span class="skolem">as</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?m</span> <span class="skolem">bs</span>"</span></span> <span class="quoted"><span class="skolem">ns</span></span> <span class="quoted"><span class="skolem">ns'</span></span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">s'</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> set_mset_mset <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">ns</span> <span class="skolem">s'</span> <span class="skolem">ns'</span> <span class="skolem">as</span> <span class="skolem">bs</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">as</span> <span class="main">×</span> set <span class="skolem">bs</span> <span class="main">∩</span> <span class="skolem">ns</span> <span class="main">⊆</span> <span class="skolem">ns'</span>"</span></span>
           <span class="quoted"><span class="quoted">"set <span class="skolem">as</span> <span class="main">×</span> set <span class="skolem">bs</span> <span class="main">∩</span> <span class="skolem">s</span> <span class="main">⊆</span> <span class="skolem">s'</span>"</span></span>
           <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">as</span><span class="main">,</span><span class="skolem">bs</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?ns</span> <span class="skolem">s</span> <span class="skolem">ns</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">as</span><span class="main">,</span><span class="skolem">bs</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?ns</span> <span class="skolem">s'</span> <span class="skolem">ns'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ns_mul_ext_local_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="var">?m</span> <span class="skolem">as</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?m</span> <span class="skolem">bs</span>"</span></span> <span class="quoted"><span class="skolem">ns</span></span> <span class="quoted"><span class="skolem">ns'</span></span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">s'</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> set_mset_mset <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">sns</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool <span class="main">×</span> bool"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">mul_ext_impl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> bool <span class="main">×</span> bool"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="entity">mul_ex_dom</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> bool <span class="main">×</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mul_ext_impl</span> <span class="main">[]</span> <span class="main">[]</span>       <span class="main">=</span> <span class="main">(</span>False<span class="main">,</span> True<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mul_ext_impl</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span>       <span class="main">=</span> <span class="main">(</span>False<span class="main">,</span> False<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mul_ext_impl</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">[]</span>       <span class="main">=</span> <span class="main">(</span>True<span class="main">,</span> True<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mul_ext_impl</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">mul_ex_dom</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span>"</span></span>

<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mul_ex_dom</span> <span class="main">[]</span>       <span class="free"><span class="bound"><span class="entity">xs'</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">=</span> <span class="main">(</span>False<span class="main">,</span> False<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mul_ex_dom</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs'</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">case</span> <span class="free">sns</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">of</span>
      <span class="main">(</span>True<span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">if</span> snd <span class="main">(</span><span class="free">mul_ext_impl</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">xs'</span></span></span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">¬</span> fst <span class="main">(</span><span class="free">sns</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">(</span>True<span class="main">,</span> True<span class="main">)</span>
                   <span class="keyword1">else</span> <span class="free">mul_ex_dom</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs'</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span>
    <span class="main">|</span> <span class="main">(</span>False<span class="main">,</span> True<span class="main">)</span> <span class="main">⇒</span> or2 <span class="main">(</span><span class="free">mul_ext_impl</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">xs'</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">mul_ex_dom</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs'</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span>
    <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="free">mul_ex_dom</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs'</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1" id="Multiset_Extension2_Impl-mul_ext_impl_sound0"><span class="command">lemma</span></span> mul_ext_impl_sound0<span class="main">:</span>
  <span class="quoted"><span class="quoted">"mul_ext_impl <span class="free">sns</span> <span class="free">xs</span> <span class="free">ys</span> <span class="main">=</span> mult2_impl <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">sns</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">)</span> <span class="free">ys</span> <span class="free">xs</span>"</span></span>
  <span class="quoted"><span class="quoted">"mul_ex_dom <span class="free">sns</span> <span class="free">xs</span> <span class="free">xs'</span> <span class="free">y</span> <span class="free">ys</span> <span class="main">=</span> mult2_ex_dom <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">sns</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">)</span> <span class="free">y</span> <span class="free">ys</span> <span class="free">xs</span> <span class="free">xs'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">xs'</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">taking</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">sns</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> mul_ext_impl_mul_ex_dom.induct<span class="main">)</span>
  <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits bool.splits<span class="main">)</span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">cond1</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">cond1</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">≡</span>
  <span class="main">(</span><span class="main">(</span><span class="main">∃</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="main">∧</span> fst <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">b</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">∧</span> snd <span class="main">(</span>mul_ext <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>remove1 <span class="bound">b</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">[</span><span class="bound">y</span><span class="main">←</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">.</span> <span class="main">¬</span> fst <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">b</span> <span class="bound">y</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
  <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="main">∧</span> snd <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">b</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">∧</span> fst <span class="main">(</span>mul_ext <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>remove1 <span class="bound">b</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Multiset_Extension2_Impl-cond1_propagate"><span class="command">lemma</span></span> cond1_propagate<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cond1 <span class="free">f</span> <span class="free">bs</span> <span class="free">y</span> <span class="free">xs</span> <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cond1 <span class="free">f</span> <span class="main">(</span><span class="free">b</span> <span class="main">#</span> <span class="free">bs</span><span class="main">)</span> <span class="free">y</span> <span class="free">xs</span> <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> cond1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">cond2</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">cond2</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">≡</span> <span class="main">(</span>cond1 <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span>
  <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="main">∧</span> snd <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">b</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">∧</span> snd <span class="main">(</span>mul_ext <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>remove1 <span class="bound">b</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Multiset_Extension2_Impl-cond2_propagate"><span class="command">lemma</span></span> cond2_propagate<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cond2 <span class="free">f</span> <span class="free">bs</span> <span class="free">y</span> <span class="free">xs</span> <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cond2 <span class="free">f</span> <span class="main">(</span><span class="free">b</span> <span class="main">#</span> <span class="free">bs</span><span class="main">)</span> <span class="free">y</span> <span class="free">xs</span> <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword2"><span class="keyword">and</span></span> cond1_propagate<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">bs</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">]</span>
<span class="keyword1"><span class="command">unfolding</span></span> cond2_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Multiset_Extension2_Impl-cond1_cond2"><span class="command">lemma</span></span> cond1_cond2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cond1 <span class="free">f</span> <span class="free">bs</span> <span class="free">y</span> <span class="free">xs</span> <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cond2 <span class="free">f</span> <span class="free">bs</span> <span class="free">y</span> <span class="free">xs</span> <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> cond2_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Multiset_Extension2_Impl-mul_ext_impl_sound"><span class="command">lemma</span></span> mul_ext_impl_sound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mul_ext_impl <span class="free">f</span> <span class="free">xs</span> <span class="free">ys</span> <span class="main">=</span> mul_ext <span class="free">f</span> <span class="free">xs</span> <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> mul_ext_def s_mul_ext_def ns_mul_ext_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def converse_def mul_ext_impl_sound0 mult2_impl_sound<span class="main">)</span>

<span class="keyword1" id="Multiset_Extension2_Impl-mul_ext_code"><span class="command">lemma</span></span> mul_ext_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mul_ext <span class="main">=</span> mul_ext_impl"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> mul_ext_impl_sound<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Multiset_Extension2_Impl-mul_ext_impl_cong"><span class="command">lemma</span></span> mul_ext_impl_cong<span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> <span class="bound">x'</span> <span class="main">∈</span> set <span class="free">ys</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">x'</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">x</span> <span class="bound">x'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mul_ext_impl <span class="free">f</span> <span class="free">xs</span> <span class="free">ys</span> <span class="main">=</span> mul_ext_impl <span class="free">g</span> <span class="free">xs</span> <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
 stri_mul_ext_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quoted"><span class="free">g</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted">id</span><span class="main">]</span> nstri_mul_ext_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quoted"><span class="free">g</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted">id</span><span class="main">]</span>
 stri_mul_ext_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">g</span></span> <span class="quoted">id</span><span class="main">]</span> nstri_mul_ext_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">g</span></span> <span class="quoted">id</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mul_ext_impl_sound mul_ext_def Let_def<span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">ass_list_to_single_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> nat<span class="main">)</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">ass_list_to_single_list</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ass_list_to_single_list</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> replicate <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">@</span> <span class="free">ass_list_to_single_list</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

<span class="keyword1" id="Multiset_Extension2_Impl-set_ass_list_to_single_list"><span class="command">lemma</span></span> set_ass_list_to_single_list <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="main">(</span>ass_list_to_single_list <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">∧</span> <span class="bound">n</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ass_list_to_single_list.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Multiset_Extension2_Impl-count_mset_replicate"><span class="command">lemma</span></span> count_mset_replicate <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset <span class="main">(</span>replicate <span class="free">n</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Multiset_Extension2_Impl-count_mset_lal_ge"><span class="command">lemma</span></span> count_mset_lal_ge<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> count <span class="main">(</span>mset <span class="main">(</span>ass_list_to_single_list <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="main">≥</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Multiset_Extension2_Impl-count_of_count_mset_lal"><span class="command">lemma</span></span> count_of_count_mset_lal <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">y</span><span class="main">)</span> <span class="main">⟹</span> count_of <span class="free">y</span> <span class="free">x</span> <span class="main">=</span> count <span class="main">(</span>mset <span class="main">(</span>ass_list_to_single_list <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">y</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> count_mset_lal_ge count_of_empty<span class="main">)</span>

<span class="keyword1" id="Multiset_Extension2_Impl-Bag_mset"><span class="command">lemma</span></span> Bag_mset<span class="main">:</span> <span class="quoted"><span class="quoted">"Bag <span class="free">xs</span> <span class="main">=</span> mset <span class="main">(</span>ass_list_to_single_list <span class="main">(</span>DAList.impl_of <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> multiset_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Alist_inverse<span class="main">)</span>

<span class="keyword1" id="Multiset_Extension2_Impl-Bag_Alist_Cons"><span class="command">lemma</span></span> Bag_Alist_Cons<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> fst <span class="main">`</span> set <span class="free">xs</span> <span class="main">⟹</span> distinct <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span>
    Bag <span class="main">(</span>Alist <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> mset <span class="main">(</span>replicate <span class="free">n</span> <span class="free">x</span><span class="main">)</span> <span class="main">+</span> Bag <span class="main">(</span>Alist <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Bag_mset Alist_inverse<span class="main">)</span>

<span class="keyword1" id="Multiset_Extension2_Impl-mset_lal"><span class="command">lemma</span></span> mset_lal <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span> mset <span class="main">(</span>ass_list_to_single_list <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> Bag <span class="main">(</span>Alist <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Bag_Alist_Cons<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Mempty_Bag empty.abs_eq<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Multiset_Extension2_Impl-Bag_s_mul_ext"><span class="command">lemma</span></span> Bag_s_mul_ext<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>Bag <span class="free">xs</span><span class="main">,</span> Bag <span class="free">ys</span><span class="main">)</span> <span class="main">∈</span> s_mul_ext <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> snd <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> fst <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span> <span class="main">⟷</span>
    fst <span class="main">(</span>mul_ext <span class="free">f</span> <span class="main">(</span>ass_list_to_single_list <span class="main">(</span>DAList.impl_of <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>ass_list_to_single_list <span class="main">(</span>DAList.impl_of <span class="free">ys</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mul_ext_def Let_def Alist_impl_of<span class="main">)</span>

<span class="keyword1" id="Multiset_Extension2_Impl-Bag_ns_mul_ext"><span class="command">lemma</span></span> Bag_ns_mul_ext<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>Bag <span class="free">xs</span><span class="main">,</span> Bag <span class="free">ys</span><span class="main">)</span> <span class="main">∈</span> ns_mul_ext <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> snd <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> fst <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span> <span class="main">⟷</span>
    snd <span class="main">(</span>mul_ext <span class="free">f</span> <span class="main">(</span>ass_list_to_single_list <span class="main">(</span>DAList.impl_of <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>ass_list_to_single_list <span class="main">(</span>DAList.impl_of <span class="free">ys</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mul_ext_def Let_def Alist_impl_of<span class="main">)</span>

<span class="keyword1" id="Multiset_Extension2_Impl-smulextp_code"><span class="command">lemma</span></span> smulextp_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"smulextp <span class="free">f</span> <span class="main">(</span>Bag <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>Bag <span class="free">ys</span><span class="main">)</span> <span class="main">⟷</span> fst <span class="main">(</span>mul_ext <span class="free">f</span> <span class="main">(</span>ass_list_to_single_list <span class="main">(</span>DAList.impl_of <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>ass_list_to_single_list <span class="main">(</span>DAList.impl_of <span class="free">ys</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> smulextp_def Bag_s_mul_ext <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1" id="Multiset_Extension2_Impl-nsmulextp_code"><span class="command">lemma</span></span> nsmulextp_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"nsmulextp <span class="free">f</span> <span class="main">(</span>Bag <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>Bag <span class="free">ys</span><span class="main">)</span> <span class="main">⟷</span> snd <span class="main">(</span>mul_ext <span class="free">f</span> <span class="main">(</span>ass_list_to_single_list <span class="main">(</span>DAList.impl_of <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>ass_list_to_single_list <span class="main">(</span>DAList.impl_of <span class="free">ys</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> nsmulextp_def Bag_ns_mul_ext <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1" id="Multiset_Extension2_Impl-mulextp_code"><span class="command">lemma</span></span> mulextp_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"mulextp <span class="free">f</span> <span class="main">(</span>Bag <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>Bag <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> mul_ext <span class="free">f</span> <span class="main">(</span>ass_list_to_single_list <span class="main">(</span>DAList.impl_of <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>ass_list_to_single_list <span class="main">(</span>DAList.impl_of <span class="free">ys</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mulextp_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nsmulextp_code smulextp_code<span class="main">)</span> 

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="WPO">
<div class="head">
<h1>Theory WPO</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹The Weighted Path Order›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This is a version of WPO that also permits multiset comparisons of lists of terms.
  It therefore generalizes RPO.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> WPO
  <span class="keyword2"><span class="keyword">imports</span></span>
    <a href="../../knuth_bendix_order/theories/#Lexicographic_Extension">Knuth_Bendix_Order.Lexicographic_Extension</a>
    <a href="../../knuth_bendix_order/theories/#Term_Aux">Knuth_Bendix_Order.Term_Aux</a>
    <a href="../../knuth_bendix_order/theories/#Order_Pair">Knuth_Bendix_Order.Order_Pair</a>
    <a href="../../polynomial_factorization/theories/#Missing_List">Polynomial_Factorization.Missing_List</a>
    <a href="#Status">Status</a>
    <a href="#Precedence">Precedence</a>
    <a href="#Multiset_Extension2">Multiset_Extension2</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">datatype</span></span> order_tag <span class="main">=</span> Lex <span class="main">|</span> Mul

<span class="keyword1"><span class="command">locale</span></span> wpo <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">S</span> <span class="free">NS</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> term rel"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted">"<span class="free">prc</span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span> <span class="main">×</span> nat <span class="main">⇒</span> <span class="tfree">'f</span> <span class="main">×</span> nat <span class="main">⇒</span> bool <span class="main">×</span> bool<span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">prl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'f</span> <span class="main">×</span> nat <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">σσ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'f</span> status"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">c</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'f</span> <span class="main">×</span> nat <span class="main">⇒</span> order_tag"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ssimple</span> <span class="main">::</span> <span class="quoted">bool</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">large</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'f</span> <span class="main">×</span> nat <span class="main">⇒</span> bool"</span></span> 
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">wpo</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> term <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> term <span class="main">⇒</span> bool <span class="main">×</span> bool"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">wpo</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">of</span>
      Var <span class="bound">x</span> <span class="main">⇒</span> <span class="main">(</span>False<span class="main">,</span> 
        <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">of</span> 
          Var <span class="bound">y</span> <span class="main">⇒</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">y</span> 
        <span class="main">|</span> Fun <span class="bound">g</span> <span class="bound">ts</span> <span class="main">⇒</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">NS</span> <span class="main">∧</span> status <span class="free">σσ</span> <span class="main">(</span><span class="bound">g</span><span class="main">,</span> length <span class="bound">ts</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∧</span> <span class="free">prl</span> <span class="main">(</span><span class="bound">g</span><span class="main">,</span> length <span class="bound">ts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">|</span> Fun <span class="bound">f</span> <span class="bound">ss</span> <span class="main">⇒</span>
      <span class="keyword1">if</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span> <span class="keyword1">then</span> <span class="main">(</span>True<span class="main">,</span> True<span class="main">)</span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">NS</span> <span class="keyword1">then</span>
        <span class="keyword1">if</span> <span class="main">∃</span> <span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>status <span class="free">σσ</span> <span class="main">(</span><span class="bound">f</span><span class="main">,</span> length <span class="bound">ss</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> snd <span class="main">(</span><span class="free">wpo</span> <span class="main">(</span><span class="bound">ss</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">(</span>True<span class="main">,</span> True<span class="main">)</span>
        <span class="keyword1">else</span>
          <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">of</span>
            Var <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="main">(</span>False<span class="main">,</span> <span class="free">ssimple</span> <span class="main">∧</span> <span class="free">large</span> <span class="main">(</span><span class="bound">f</span><span class="main">,</span> length <span class="bound">ss</span><span class="main">)</span><span class="main">)</span>
          <span class="main">|</span> Fun <span class="bound">g</span> <span class="bound">ts</span> <span class="main">⇒</span> 
            <span class="main">(</span><span class="keyword1">case</span> <span class="free">prc</span> <span class="main">(</span><span class="bound">f</span><span class="main">,</span> length <span class="bound">ss</span><span class="main">)</span> <span class="main">(</span><span class="bound">g</span><span class="main">,</span> length <span class="bound">ts</span><span class="main">)</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">prs</span><span class="main">,</span> <span class="bound">prns</span><span class="main">)</span> <span class="main">⇒</span>            
              <span class="keyword1">if</span> <span class="bound">prns</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">j</span> <span class="main">∈</span> set <span class="main">(</span>status <span class="free">σσ</span> <span class="main">(</span><span class="bound">g</span><span class="main">,</span> length <span class="bound">ts</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> fst <span class="main">(</span><span class="free">wpo</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="bound">ts</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span> 
                <span class="keyword1">if</span> <span class="bound">prs</span> <span class="keyword1">then</span> <span class="main">(</span>True<span class="main">,</span> True<span class="main">)</span>
                <span class="keyword1">else</span> <span class="keyword1">let</span> <span class="bound">ss'</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">ss</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>status <span class="free">σσ</span> <span class="main">(</span><span class="bound">f</span><span class="main">,</span> length <span class="bound">ss</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
                         <span class="bound">ts'</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">ts</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>status <span class="free">σσ</span> <span class="main">(</span><span class="bound">g</span><span class="main">,</span> length <span class="bound">ts</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
                         <span class="bound">cf</span> <span class="main">=</span> <span class="free">c</span> <span class="main">(</span><span class="bound">f</span><span class="main">,</span>length <span class="bound">ss</span><span class="main">)</span><span class="main">;</span>
                         <span class="bound">cg</span> <span class="main">=</span> <span class="free">c</span> <span class="main">(</span><span class="bound">g</span><span class="main">,</span>length <span class="bound">ts</span><span class="main">)</span>    
                   <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="bound">cf</span> <span class="main">=</span> Lex <span class="main">∧</span> <span class="bound">cg</span> <span class="main">=</span> Lex 
                      <span class="keyword1">then</span> lex_ext <span class="free">wpo</span> <span class="free">n</span> <span class="bound">ss'</span> <span class="bound">ts'</span>
                      <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">cf</span> <span class="main">=</span> Mul <span class="main">∧</span> <span class="bound">cg</span> <span class="main">=</span> Mul
                           <span class="keyword1">then</span> mul_ext <span class="free">wpo</span> <span class="bound">ss'</span> <span class="bound">ts'</span>
                           <span class="keyword1">else</span> <span class="main">(</span>length <span class="bound">ss'</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> length <span class="bound">ts'</span> <span class="main">=</span> <span class="main">0</span><span class="main">,</span> length <span class="bound">ts'</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>
              <span class="keyword1">else</span> <span class="main">(</span>False<span class="main">,</span> False<span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="keyword1">else</span> <span class="main">(</span>False<span class="main">,</span> False<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> wpo.simps <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">wpo_s</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">≻</span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main"><span class="free">≻</span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> fst <span class="main">(</span>wpo <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">wpo_ns</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">≽</span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main"><span class="free">≽</span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> snd <span class="main">(</span>wpo <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">WPO_S</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="bound">s</span> <span class="main">≻</span> <span class="bound">t</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">WPO_NS</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="bound">s</span> <span class="main">≽</span> <span class="bound">t</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="WPO-wpo_s_imp_ns"><span class="command">lemma</span></span> wpo_s_imp_ns<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≻</span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">≽</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lex_ext_stri_imp_nstri
  <span class="keyword1"><span class="command">unfolding</span></span> wpo.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def mul_ext_stri_imp_nstri <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> term.splits if_splits prod.splits<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">declare</span></span> wpo.wpo.simps<span class="main">[</span><span class="operator">code</span><span class="main">]</span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">strictly_simple_status</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'f</span> status <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'f</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span>term rel <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">strictly_simple_status</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">rel</span></span></span> <span class="main">=</span> 
    <span class="main">(</span><span class="main">∀</span> <span class="bound">f</span> <span class="bound">ts</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>status <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span><span class="bound">f</span><span class="main">,</span>length <span class="bound">ts</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>Fun <span class="bound">f</span> <span class="bound">ts</span><span class="main">,</span> <span class="bound">ts</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">rel</span></span></span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">locale</span></span> wpo_with_assms <span class="main">=</span> wpo <span class="main">+</span>
  SN_order_pair <span class="main">+</span> precedence <span class="main">+</span>
  <span class="keyword2"><span class="keyword">constrains</span></span> S <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> term rel"</span></span> <span class="keyword2"><span class="keyword">and</span></span> NS <span class="main">::</span> <span class="quoted"><span class="main">_</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> prc <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'f</span> <span class="main">×</span> nat <span class="main">⇒</span> <span class="tfree">'f</span> <span class="main">×</span> nat <span class="main">⇒</span> bool <span class="main">×</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> prl <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'f</span> <span class="main">×</span> nat <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ssimple <span class="main">::</span> <span class="quoted">bool</span>
    <span class="keyword2"><span class="keyword">and</span></span> large <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'f</span> <span class="main">×</span> nat <span class="main">⇒</span> bool"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> c <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'f</span> <span class="main">×</span> nat <span class="main">⇒</span> order_tag"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> n <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword2"><span class="keyword">and</span></span> σσ <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'f</span> status"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> subst_S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">t</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">s</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">,</span> <span class="free">t</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> subst_NS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">t</span><span class="main">)</span> <span class="main">∈</span> <span class="free">NS</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">s</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">,</span> <span class="free">t</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span> <span class="main">∈</span> <span class="free">NS</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ctxt_NS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">t</span><span class="main">)</span> <span class="main">∈</span> <span class="free">NS</span> <span class="main">⟹</span> <span class="main">(</span>Fun <span class="free">f</span> <span class="main">(</span><span class="free">bef</span> <span class="main">@</span> <span class="free">s</span> <span class="main">#</span> <span class="free">aft</span><span class="main">)</span><span class="main">,</span> Fun <span class="free">f</span> <span class="main">(</span><span class="free">bef</span> <span class="main">@</span> <span class="free">t</span> <span class="main">#</span> <span class="free">aft</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">NS</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> S_imp_NS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">⊆</span> <span class="free">NS</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ws_status<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> set <span class="main">(</span>status <span class="free">σσ</span> <span class="free">fn</span><span class="main">)</span> <span class="main">⟹</span> simple_arg_pos <span class="free">NS</span> <span class="free">fn</span> <span class="free">i</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> large<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ssimple</span> <span class="main">⟹</span> <span class="free">large</span> <span class="free">fn</span> <span class="main">⟹</span> fst <span class="main">(</span><span class="free">prc</span> <span class="free">fn</span> <span class="free">gm</span><span class="main">)</span> <span class="main">∨</span> snd <span class="main">(</span><span class="free">prc</span> <span class="free">fn</span> <span class="free">gm</span><span class="main">)</span> <span class="main">∧</span> status <span class="free">σσ</span> <span class="free">gm</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>  
    <span class="keyword2"><span class="keyword">and</span></span> large_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ssimple</span> <span class="main">⟹</span> <span class="free">large</span> <span class="free">fn</span> <span class="main">⟹</span> snd <span class="main">(</span><span class="free">prc</span> <span class="free">gm</span> <span class="free">fn</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">large</span> <span class="free">gm</span>"</span></span>  
    <span class="keyword2"><span class="keyword">and</span></span> ss_status<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ssimple</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">∈</span> set <span class="main">(</span>status <span class="free">σσ</span> <span class="free">fn</span><span class="main">)</span> <span class="main">⟹</span> simple_arg_pos <span class="free">S</span> <span class="free">fn</span> <span class="free">i</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ss_S_non_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ssimple</span> <span class="main">⟹</span> <span class="free">S</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="WPO-ss_NS_not_UNIV"><span class="command">lemma</span></span> ss_NS_not_UNIV<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ssimple</span> <span class="main">⟹</span> <span class="free">NS</span> <span class="main">≠</span> UNIV"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">ssimple</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">NS</span> <span class="main">=</span> UNIV"</span></span> 
  <span class="keyword1"><span class="command">with</span></span> ss_S_non_empty <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">b</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">b</span><span class="main">,</span><span class="skolem">a</span><span class="main">)</span> <span class="main">∈</span> <span class="free">NS</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> compat_S_NS_point<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">a</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">with</span></span> SN <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">≡</span> status <span class="free">σσ</span>"</span></span>


<span class="keyword1"><span class="command">lemmas</span></span> σ <span class="main">=</span> status<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">σσ</span></span><span class="main">]</span>

<span class="keyword1" id="WPO-NS_arg"><span class="command">lemma</span></span> NS_arg<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> set <span class="main">(</span>σ <span class="main">(</span><span class="free">f</span><span class="main">,</span>length <span class="free">ts</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Fun <span class="free">f</span> <span class="free">ts</span><span class="main">,</span> <span class="free">ts</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">NS</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ws_status<span class="main"><span class="main">[</span></span><span class="operator">OF</span> i<span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> simple_arg_pos_def fst_conv<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
      <span class="operator">insert</span> σ<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">f</span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"length <span class="free"><span class="free"><span class="free">ts</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span> i<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="WPO-NS_subterm"><span class="command">lemma</span></span> NS_subterm<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> all<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">f</span> <span class="bound">k</span><span class="main">.</span> set <span class="main">(</span>σ <span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="bound">k</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⊵</span> <span class="free">t</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">t</span><span class="main">)</span> <span class="main">∈</span> <span class="free">NS</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> supteq.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>refl<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> refl_NS <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> refl_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>subt <span class="skolem">s</span> <span class="skolem">ss</span> <span class="skolem">t</span> <span class="skolem">f</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> subt<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">ss</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> <span class="skolem">ss</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> set_conv_nth <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> NS_arg<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="skolem">f</span></span> <span class="quoted"><span class="skolem">ss</span></span><span class="main">,</span> <span class="operator">unfolded</span> all<span class="main">]</span> s i <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Fun <span class="skolem">f</span> <span class="skolem">ss</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">∈</span> <span class="free">NS</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> trans_NS_point<span class="main">[</span><span class="operator">OF</span> this subt<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="WPO-σE"><span class="command">lemma</span></span> σE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> set <span class="main">(</span>σ <span class="main">(</span><span class="free">f</span><span class="main">,</span> length <span class="free">ss</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">ss</span> <span class="main">!</span> <span class="free">i</span> <span class="main">∈</span> set <span class="free">ss</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> status_aux<span class="main">)</span>

<span class="keyword1" id="WPO-wpo_ns_refl"><span class="command">lemma</span></span> wpo_ns_refl<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≽</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Fun <span class="skolem">f</span> <span class="skolem">ss</span><span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">assume</span></span> si<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> set <span class="main">(</span>σ <span class="main">(</span><span class="skolem">f</span><span class="main">,</span>length <span class="skolem">ss</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> NS_arg<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Fun <span class="skolem">f</span> <span class="skolem">ss</span><span class="main">,</span> <span class="skolem">ss</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">NS</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">with</span></span> si Fun<span class="main">[</span><span class="operator">OF</span> σE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> si<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wpo_s <span class="main">(</span>Fun <span class="skolem">f</span> <span class="skolem">ss</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ss</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> wpo.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Fun <span class="skolem">f</span> <span class="skolem">ss</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> wpo_s <span class="main">=</span> this
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ss</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">ss</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>σ <span class="main">(</span><span class="skolem">f</span><span class="main">,</span>length <span class="skolem">ss</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> rec11<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>lex_ext wpo <span class="free">n</span> <span class="var">?ss</span> <span class="var">?ss</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> all_nstri_imp_lex_nstri<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> σE<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">f</span></span></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">ss</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Fun<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> rec12<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>mul_ext wpo <span class="var">?ss</span> <span class="var">?ss</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mul_ext_def Let_def snd_conv 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ns_mul_ext_refl_local<span class="main"><span class="keyword3">,</span></span>
        <span class="operator">unfold</span> locally_refl_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_multiset_in_set<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?ss</span></span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Fun status_aux<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> rec11 rec12 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> refl_NS_point prc_refl wpo_s
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">(</span><span class="skolem">f</span><span class="main">,</span>length <span class="skolem">ss</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wpo.simps<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Fun <span class="skolem">f</span> <span class="skolem">ss</span>"</span></span> <span class="quoted"><span class="quoted">"Fun <span class="skolem">f</span> <span class="skolem">ss</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wpo.simps<span class="main">)</span>

<span class="keyword1" id="WPO-wpo_ns_imp_NS"><span class="command">lemma</span></span> wpo_ns_imp_NS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≽</span> <span class="free">t</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">t</span><span class="main">)</span> <span class="main">∈</span> <span class="free">NS</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> S_imp_NS
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">s</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wpo.simps<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">t</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main"><span class="keyword3">,</span></span> 
      <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> refl_NS_point <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1" id="WPO-wpo_s_imp_NS"><span class="command">lemma</span></span> wpo_s_imp_NS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≻</span> <span class="free">t</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">t</span><span class="main">)</span> <span class="main">∈</span> <span class="free">NS</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wpo_ns_imp_NS<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wpo_s_imp_ns<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="WPO-S_imp_wpo_s"><span class="command">lemma</span></span> S_imp_wpo_s<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> st<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">t</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≻</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Fun <span class="skolem">f</span> <span class="skolem">ss</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> st <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wpo.simps<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> SN_imp_minimal<span class="main">[</span><span class="operator">OF</span> SN<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted">undefined</span> <span class="quoted">UNIV</span><span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">u</span><span class="main">.</span> <span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="bound">u</span><span class="main">)</span> <span class="main">∉</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> subst_S<span class="main">[</span><span class="operator">OF</span> st<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> Var<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="skolem">s</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="WPO-wpo_least_1"><span class="command">lemma</span></span> wpo_least_1<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">prl</span> <span class="main">(</span><span class="free">f</span><span class="main">,</span>length <span class="free">ss</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">t</span><span class="main">,</span> Fun <span class="free">f</span> <span class="free">ss</span><span class="main">)</span> <span class="main">∈</span> <span class="free">NS</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"σ <span class="main">(</span><span class="free">f</span><span class="main">,</span>length <span class="free">ss</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≽</span> Fun <span class="free">f</span> <span class="free">ss</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wpo.simps<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Fun <span class="skolem">g</span> <span class="skolem">ts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">,</span>length <span class="free">ss</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">g</span><span class="main">,</span>length <span class="skolem">ts</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">ns</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">prc</span> <span class="var">?g</span> <span class="var">?f</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">ns</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">with</span></span> prl<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> prc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">prc</span> <span class="var">?g</span> <span class="var">?f</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">s</span><span class="main">,</span>True<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> Fun 
    <span class="keyword1"><span class="command">unfolding</span></span> wpo.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Fun <span class="skolem">g</span> <span class="skolem">ts</span>"</span></span> <span class="quoted"><span class="quoted">"Fun <span class="free">f</span> <span class="free">ss</span>"</span></span><span class="main">]</span> term.simps assms<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prc lex_ext_least_1 mul_ext_def ns_mul_ext_bottom Let_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="WPO-wpo_least_2"><span class="command">lemma</span></span> wpo_least_2<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">prl</span> <span class="main">(</span><span class="free">f</span><span class="main">,</span>length <span class="free">ss</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="free">prl</span> <span class="var">?f</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Fun <span class="free">f</span> <span class="free">ss</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="main">∉</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"σ <span class="main">(</span><span class="free">f</span><span class="main">,</span>length <span class="free">ss</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> Fun <span class="free">f</span> <span class="free">ss</span> <span class="main">≻</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> Var <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2-3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wpo.simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Fun <span class="skolem">g</span> <span class="skolem">ts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">g</span><span class="main">,</span>length <span class="skolem">ts</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">ns</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">prc</span> <span class="var">?f</span> <span class="var">?g</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">ns</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">with</span></span> prl2<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> prc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">prc</span> <span class="var">?f</span> <span class="var">?g</span> <span class="main">=</span> <span class="main">(</span>False<span class="main">,</span><span class="skolem">ns</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> Fun 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wpo.simps<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"Fun <span class="skolem">g</span> <span class="skolem">ts</span>"</span></span><span class="main"><span class="main">]</span></span> lex_ext_least_2 prc
        mul_ext_def s_mul_ext_bottom_strict Let_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="WPO-wpo_least_3"><span class="command">lemma</span></span> wpo_least_3<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">prl</span> <span class="main">(</span><span class="free">f</span><span class="main">,</span>length <span class="free">ss</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="free">prl</span> <span class="var">?f</span>"</span></span><span class="main">)</span> 
  <span class="keyword2"><span class="keyword">and</span></span> ns<span class="main">:</span> <span class="quoted"><span class="quoted">"Fun <span class="free">f</span> <span class="free">ss</span> <span class="main">≽</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> NS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span> Fun <span class="free">f</span> <span class="free">ss</span><span class="main">)</span> <span class="main">∈</span> <span class="free">NS</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> ss<span class="main">:</span> <span class="quoted"><span class="quoted">"σ <span class="main">(</span><span class="free">f</span><span class="main">,</span>length <span class="free">ss</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span>Fun <span class="free">f</span> <span class="free">ss</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∉</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">=</span> Var <span class="free">x</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≽</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Fun <span class="free">f</span> <span class="free">ss</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">∨</span> <span class="main">(</span><span class="free">u</span><span class="main">,</span> Fun <span class="free">f</span> <span class="free">ss</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">∨</span> <span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">with</span></span> wpo_ns_imp_NS<span class="main">[</span><span class="operator">OF</span> ns<span class="main">]</span> NS compat_NS_S_point compat_S_NS_point <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> wpo_s_imp_ns<span class="main">[</span><span class="operator">OF</span> S_imp_wpo_s<span class="main"><span class="main">[</span></span><span class="operator">OF</span> this<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">from</span></span> trans_NS_point<span class="main">[</span><span class="operator">OF</span> NS wpo_ns_imp_NS<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ns<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> utA<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="main">∈</span> <span class="free">NS</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> t<span class="main">:</span> <span class="main">(</span>Var <span class="skolem">y</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> ns False ss <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ssimple</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">large</span> <span class="main">(</span><span class="free">f</span><span class="main">,</span>length <span class="free">ss</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wpo.simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> ns * False utA ss
        <span class="keyword1"><span class="command">unfolding</span></span> wpo.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">]</span> wpo.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Fun <span class="free">f</span> <span class="free">ss</span>"</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">unfolding</span></span> t u term.simps
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">from</span></span> utA<span class="main">[</span><span class="operator">unfolded</span> t u<span class="main">]</span> 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Var <span class="free">x</span><span class="main">,</span> Var <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">NS</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">from</span></span> False subst_NS<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">z</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">z</span> <span class="main">=</span> <span class="free">x</span> <span class="keyword1">then</span> <span class="skolem">v</span> <span class="keyword1">else</span> <span class="skolem">w</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="skolem">v</span> <span class="skolem">w</span><span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v</span><span class="main">,</span><span class="skolem">w</span><span class="main">)</span> <span class="main">∈</span> <span class="free">NS</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">v</span> <span class="skolem">w</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">NS</span> <span class="main">=</span> UNIV"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> ss_NS_not_UNIV<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">`<span class="free">ssimple</span>`</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Fun <span class="skolem">g</span> <span class="skolem">ts</span><span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">g</span><span class="main">,</span>length <span class="skolem">ts</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">ns</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">prc</span> <span class="var">?f</span> <span class="var">?g</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">ns</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">with</span></span> prl2<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">prl</span> <span class="var">?f</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> prc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">prc</span> <span class="var">?f</span> <span class="var">?g</span> <span class="main">=</span> <span class="main">(</span>False<span class="main">,</span><span class="skolem">ns</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"σ <span class="var">?g</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil
      <span class="keyword1"><span class="command">with</span></span> False Fun assms prc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">prc</span> <span class="var">?f</span> <span class="var">?g</span> <span class="main">=</span> <span class="main">(</span>False<span class="main">,</span>True<span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>  wpo.simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> prl3<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">prl</span> <span class="var">?f</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">prl</span> <span class="var">?g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> utA <span class="keyword1"><span class="command">unfolding</span></span> Fun <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wpo_least_1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">prl</span> <span class="var">?g</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Nil<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">t1</span> <span class="skolem">tts</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> wpo_s <span class="main">(</span>Fun <span class="free">f</span> <span class="free">ss</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ts</span> <span class="main">!</span> <span class="skolem">t1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wpo_least_2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">prl</span> <span class="var">?f</span>›</span></span> S ss<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹wpo_ns <span class="main">(</span>Fun <span class="free">f</span> <span class="free">ss</span><span class="main">)</span> <span class="free">t</span>›</span></span> False Fun Cons 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ss wpo.simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* Transitivity / compatibility of the orders *)</span>
<span class="keyword1" id="WPO-wpo_compat"><span class="command">lemma</span></span> wpo_compat<span class="main">:</span> <span class="quoted"><span class="quoted">"
  <span class="main">(</span><span class="free">s</span> <span class="main">≽</span> <span class="free">t</span> <span class="main">∧</span> <span class="free">t</span> <span class="main">≻</span> <span class="free">u</span> <span class="main">⟶</span> <span class="free">s</span> <span class="main">≻</span> <span class="free">u</span><span class="main">)</span> <span class="main">∧</span>
  <span class="main">(</span><span class="free">s</span> <span class="main">≻</span> <span class="free">t</span> <span class="main">∧</span> <span class="free">t</span> <span class="main">≽</span> <span class="free">u</span> <span class="main">⟶</span> <span class="free">s</span> <span class="main">≻</span> <span class="free">u</span><span class="main">)</span> <span class="main">∧</span>
  <span class="main">(</span><span class="free">s</span> <span class="main">≽</span> <span class="free">t</span> <span class="main">∧</span> <span class="free">t</span> <span class="main">≽</span> <span class="free">u</span> <span class="main">⟶</span> <span class="free">s</span> <span class="main">≽</span> <span class="free">u</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?tran</span> <span class="free">s</span> <span class="free">t</span> <span class="free">u</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">t</span><span class="main">,</span><span class="free">u</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">u</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> wf_induct<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf_measures<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">[</span></span><span class="main"><span class="main">λ</span></span> <span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">,</span></span><span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">,</span></span><span class="bound"><span class="bound">u</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> size <span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">,</span></span> <span class="main"><span class="main">λ</span></span> <span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">,</span></span><span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">,</span></span><span class="bound"><span class="bound">u</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> size <span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">,</span></span> <span class="main"><span class="main">λ</span></span> <span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">,</span></span><span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">,</span></span><span class="bound"><span class="bound">u</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> size <span class="bound"><span class="bound">u</span></span><span class="main"><span class="main">]</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword1"><span class="command">note</span></span> ind <span class="main">=</span> 1<span class="main">[</span><span class="operator">simplified</span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?tran</span> <span class="skolem">s</span> <span class="skolem">t</span> <span class="skolem">u</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">∨</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span><span class="skolem">u</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">∨</span> <span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">u</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> st<span class="main">:</span> <span class="quoted"><span class="quoted">"wpo_ns <span class="skolem">s</span> <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> tu<span class="main">:</span> <span class="quoted"><span class="quoted">"wpo_ns <span class="skolem">t</span> <span class="skolem">u</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> wpo_ns_imp_NS<span class="main">[</span><span class="operator">OF</span> st<span class="main">]</span> wpo_ns_imp_NS<span class="main">[</span><span class="operator">OF</span> tu<span class="main">]</span>
        True compat_NS_S_point compat_S_NS_point <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">u</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">from</span></span> S_imp_wpo_s<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wpo_s <span class="skolem">s</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">with</span></span> wpo_s_imp_ns <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> stS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">t</span><span class="main">)</span> <span class="main">∉</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> tuS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span><span class="skolem">u</span><span class="main">)</span> <span class="main">∉</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> suS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">u</span><span class="main">)</span> <span class="main">∉</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> wpo.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">u</span></span><span class="main">]</span> wpo.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span> wpo.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="skolem">u</span></span><span class="main">]</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span>
      <span class="keyword1"><span class="command">note</span></span> wpo.simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"wpo_s <span class="skolem">t</span> <span class="skolem">u</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> Var <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wpo_s <span class="skolem">s</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">u</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> gr<span class="main">:</span> <span class="quoted"><span class="quoted">"wpo_s <span class="skolem">s</span> <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ge<span class="main">:</span> <span class="quoted"><span class="quoted">"wpo_ns <span class="skolem">t</span> <span class="skolem">u</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> wpo_s_imp_NS<span class="main">[</span><span class="operator">OF</span> gr<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> stA<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> <span class="free">NS</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">from</span></span> wpo_ns_imp_NS<span class="main">[</span><span class="operator">OF</span> ge<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> tuA<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span><span class="skolem">u</span><span class="main">)</span> <span class="main">∈</span> <span class="free">NS</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">from</span></span> trans_NS_point<span class="main">[</span><span class="operator">OF</span> stA tuA<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> suA<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">u</span><span class="main">)</span> <span class="main">∈</span> <span class="free">NS</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wpo_s <span class="skolem">s</span> <span class="skolem">u</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">u</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Var <span class="skolem">y</span><span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> ge <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">=</span> Var <span class="skolem">x</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">with</span></span> gr <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Fun <span class="skolem">h</span> <span class="skolem">us</span><span class="main">)</span>
          <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">h</span><span class="main">,</span>length <span class="skolem">us</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">from</span></span> Fun ge Var <span class="keyword1"><span class="command">have</span></span> us<span class="main">:</span> <span class="quoted"><span class="quoted">"σ <span class="var">?h</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> pri<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">prl</span> <span class="var">?h</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">from</span></span> gr Var <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="skolem"><span class="skolem">ss</span></span> <span class="keyword2"><span class="keyword">where</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> Fun <span class="skolem">f</span> <span class="skolem">ss</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
          <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">f</span><span class="main">,</span>length <span class="skolem">ss</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">from</span></span> s gr Var False <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> set <span class="main">(</span>σ <span class="var">?f</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sit<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">≽</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>        
          <span class="keyword1"><span class="command">from</span></span> trans_NS_point<span class="main">[</span><span class="operator">OF</span> wpo_ns_imp_NS<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sit<span class="main"><span class="main">]</span></span> tuA<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> siu<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ss</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">,</span><span class="skolem">u</span><span class="main">)</span> <span class="main">∈</span> <span class="free">NS</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
          <span class="keyword1"><span class="command">from</span></span> wpo_least_1<span class="main">[</span><span class="operator">OF</span> pri siu<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> Fun us<span class="main"><span class="main">]</span></span> us<span class="main">]</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">≽</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Fun us <span class="keyword1"><span class="command">.</span></span>
          <span class="keyword1"><span class="command">with</span></span> i <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>σ <span class="var">?f</span><span class="main">)</span><span class="main">.</span> <span class="skolem">ss</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">≽</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">with</span></span> s suA <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> ge1<span class="main">:</span> <span class="quoted"><span class="quoted">"wpo_ns <span class="skolem">s</span> <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ge2<span class="main">:</span> <span class="quoted"><span class="quoted">"wpo_ns <span class="skolem">t</span> <span class="skolem">u</span>"</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wpo_ns <span class="skolem">s</span> <span class="skolem">u</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">u</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Var <span class="skolem">y</span><span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> ge2 <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">=</span> Var <span class="skolem">x</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">with</span></span> ge1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Fun <span class="skolem">h</span> <span class="skolem">us</span><span class="main">)</span>
          <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">h</span><span class="main">,</span>length <span class="skolem">us</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">from</span></span> Fun ge2 Var <span class="keyword1"><span class="command">have</span></span> us<span class="main">:</span> <span class="quoted"><span class="quoted">"σ <span class="var">?h</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> pri<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">prl</span> <span class="var">?h</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> Fun us
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wpo_least_1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> pri trans_NS_point<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wpo_ns_imp_NS<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ge1<span class="main"><span class="main">]</span></span> 
                    wpo_ns_imp_NS<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ge2<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> Fun us<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span> us<span class="main"><span class="main">]</span></span><span class="main">)</span> 
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Fun <span class="skolem">g</span> <span class="skolem">ts</span><span class="main">)</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">g</span><span class="main">,</span>length <span class="skolem">ts</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ts</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>σ <span class="var">?g</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Fun <span class="skolem">g</span> <span class="skolem">ts</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> Fun <span class="keyword1"><span class="command">have</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> <span class="var">?t</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
          <span class="keyword3"><span class="command">assume</span></span> gr<span class="main">:</span> <span class="quoted"><span class="quoted">"wpo_s <span class="skolem">s</span> <span class="skolem">t</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> Var Fun <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wpo_s <span class="skolem">s</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wpo.simps<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">assume</span></span> ge<span class="main">:</span> <span class="quoted"><span class="quoted">"wpo_ns <span class="skolem">s</span> <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> gr<span class="main">:</span> <span class="quoted"><span class="quoted">"wpo_s <span class="skolem">t</span> <span class="skolem">u</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> Var Fun <span class="keyword1"><span class="command">have</span></span> pri<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">prl</span> <span class="var">?g</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"σ <span class="var">?g</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wpo.simps<span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> gr Fun <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wpo_s <span class="skolem">s</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> wpo_least_2<span class="main">[</span><span class="operator">OF</span> pri<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">u</span></span><span class="main">]</span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">assume</span></span> ge1<span class="main">:</span> <span class="quoted"><span class="quoted">"wpo_ns <span class="skolem">s</span> <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ge2<span class="main">:</span> <span class="quoted"><span class="quoted">"wpo_ns <span class="skolem">t</span> <span class="skolem">u</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> Var Fun <span class="keyword1"><span class="command">have</span></span> pri<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">prl</span> <span class="var">?g</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> empty<span class="main">:</span> <span class="quoted"><span class="quoted">"σ <span class="var">?g</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wpo.simps<span class="main">)</span>
          <span class="keyword1"><span class="command">from</span></span> wpo_ns_imp_NS<span class="main">[</span><span class="operator">OF</span> ge1<span class="main">]</span> Var Fun empty <span class="keyword1"><span class="command">have</span></span> ns<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Var <span class="skolem">x</span><span class="main">,</span> Fun <span class="skolem">g</span> <span class="skolem">ts</span><span class="main">)</span> <span class="main">∈</span> <span class="free">NS</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wpo_ns <span class="skolem">s</span> <span class="skolem">u</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> wpo_least_3<span class="main"><span class="main">[</span></span><span class="operator">OF</span> pri ge2<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> Fun empty<span class="main"><span class="main">]</span></span> 
                wpo_ns_imp_NS<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ge1<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> Fun empty<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span> empty _ Var<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span><span class="main">)</span>
            <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>
            <span class="keyword3"><span class="command">assume</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Fun <span class="skolem">g</span> <span class="skolem">ts</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
            <span class="keyword1"><span class="command">from</span></span> SN_imp_minimal<span class="main">[</span><span class="operator">OF</span> SN<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted">undefined</span> <span class="quoted">UNIV</span><span class="main">]</span>
            <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">u</span><span class="main">.</span> <span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="bound">u</span><span class="main">)</span> <span class="main">∉</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">with</span></span> compat_NS_S_point<span class="main">[</span><span class="operator">OF</span> subst_NS<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ns<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="skolem">s</span>"</span></span><span class="main"><span class="main">]</span></span> subst_S<span class="main"><span class="main">[</span></span><span class="operator">OF</span> S<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="skolem">s</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Fun <span class="skolem">f</span> <span class="skolem">ss</span><span class="main">)</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Fun <span class="skolem">f</span> <span class="skolem">ss</span>"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">f</span><span class="main">,</span>length <span class="skolem">ss</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ss</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>σ <span class="var">?f</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> Fun <span class="keyword1"><span class="command">have</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> <span class="var">?s</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">i</span> <span class="main">∈</span> <span class="var">?ss</span><span class="main">.</span> <span class="skolem">ss</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">≽</span> <span class="skolem">t</span>"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">j</span> <span class="main">∈</span> <span class="var">?ts</span><span class="main">.</span> <span class="skolem">ts</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">≽</span> <span class="skolem">u</span>"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ls</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"length <span class="skolem">ss</span>"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?lt</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"length <span class="skolem">ts</span>"</span></span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ps</span></span> <span class="skolem"><span class="skolem">pns</span></span> <span class="keyword2"><span class="keyword">where</span></span> prc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">prc</span> <span class="var">?f</span> <span class="var">?g</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">pns</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?tran2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span><span class="main">.</span>  
           <span class="main">(</span><span class="main">(</span>wpo_ns <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>wpo_s <span class="bound">b</span> <span class="bound">c</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>wpo_s <span class="bound">a</span> <span class="bound">c</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
           <span class="main">(</span><span class="main">(</span>wpo_s <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>wpo_ns <span class="bound">b</span> <span class="bound">c</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>wpo_s <span class="bound">a</span> <span class="bound">c</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> 
           <span class="main">(</span><span class="main">(</span>wpo_ns <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>wpo_ns <span class="bound">b</span> <span class="bound">c</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>wpo_ns <span class="bound">a</span> <span class="bound">c</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> 
           <span class="main">(</span><span class="main">(</span>wpo_s <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>wpo_s <span class="bound">b</span> <span class="bound">c</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>wpo_s <span class="bound">a</span> <span class="bound">c</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> s <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">s'</span> <span class="main">∈</span> set <span class="skolem">ss</span><span class="main">.</span> size <span class="bound">s'</span> <span class="main">&lt;</span> size <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> size_simps<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> ind <span class="keyword1"><span class="command">have</span></span> ind2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">s'</span> <span class="bound">t'</span> <span class="bound">u'</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">s'</span> <span class="main">∈</span> set <span class="skolem">ss</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="var">?tran</span> <span class="bound">s'</span> <span class="bound">t'</span> <span class="bound">u'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">with</span></span> wpo_s_imp_ns <span class="keyword1"><span class="command">have</span></span> ind3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">us</span> <span class="bound">s'</span> <span class="bound">t'</span> <span class="bound">u'</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">s'</span> <span class="main">∈</span> set <span class="skolem">ss</span><span class="main">;</span> <span class="bound">t'</span> <span class="main">∈</span> set <span class="skolem">ts</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="var">?tran2</span> <span class="bound">s'</span> <span class="bound">t'</span> <span class="bound">u'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mss</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">ss</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>σ <span class="var">?f</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mts</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span> <span class="bound">j</span><span class="main">.</span> <span class="skolem">ts</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">(</span>σ <span class="var">?g</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> ind3'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">us</span> <span class="bound">s'</span> <span class="bound">t'</span> <span class="bound">u'</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">s'</span> <span class="main">∈</span> set <span class="var">?mss</span><span class="main">;</span> <span class="bound">t'</span> <span class="main">∈</span> set <span class="var">?mts</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="var">?tran2</span> <span class="bound">s'</span> <span class="bound">t'</span> <span class="bound">u'</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ind3<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> status_aux<span class="main">)</span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">assume</span></span> ge1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≽</span> <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ge2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≻</span> <span class="skolem">u</span>"</span></span>
          <span class="keyword1"><span class="command">from</span></span> wpo_ns_imp_NS<span class="main">[</span><span class="operator">OF</span> ge1<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> stA<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> <span class="free">NS</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
          <span class="keyword1"><span class="command">from</span></span> wpo_s_imp_NS<span class="main">[</span><span class="operator">OF</span> ge2<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> tuA<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span><span class="skolem">u</span><span class="main">)</span> <span class="main">∈</span> <span class="free">NS</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
          <span class="keyword1"><span class="command">from</span></span> trans_NS_point<span class="main">[</span><span class="operator">OF</span> stA tuA<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> suA<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">u</span><span class="main">)</span> <span class="main">∈</span> <span class="free">NS</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≻</span> <span class="skolem">u</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="var"><span class="quoted"><span class="var">?s1</span></span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> True
            <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="var">?ss</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ges<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">≽</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">from</span></span> σE<span class="main">[</span><span class="operator">OF</span> i<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> s'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">∈</span> set <span class="skolem">ss</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
            <span class="keyword1"><span class="command">with</span></span> i s s' ind2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="skolem">u</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> ges ge2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">≻</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">≽</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wpo_s_imp_ns<span class="main">)</span>
            <span class="keyword1"><span class="command">with</span></span> i s suA <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">u</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wpo.simps<span class="main">)</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> False
            <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="var"><span class="quoted"><span class="var">?t1</span></span></span><span class="main">)</span>
              <span class="keyword3"><span class="command">case</span></span> True
              <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="var">?ts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ges<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ts</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">≽</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">from</span></span> σE<span class="main">[</span><span class="operator">OF</span> j<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> t'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ts</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">∈</span> set <span class="skolem">ts</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">from</span></span> j t' t stS False ge1 s <span class="keyword1"><span class="command">have</span></span> ge1'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≻</span> <span class="skolem">ts</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> wpo.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits prod.splits<span class="main">)</span>        
              <span class="keyword1"><span class="command">from</span></span> t' s t ge1' ges ind<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ts</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span> <span class="quoted"><span class="skolem">u</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> 
              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≻</span> <span class="skolem">u</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> suA size_simps supt.intros <span class="keyword1"><span class="command">unfolding</span></span> wpo.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">u</span></span><span class="main">]</span> 
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">case</span></span> False
              <span class="keyword1"><span class="command">from</span></span> t this ge2 tuS <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="skolem"><span class="skolem">us</span></span> <span class="keyword2"><span class="keyword">where</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">=</span> Fun <span class="skolem">h</span> <span class="skolem">us</span>"</span></span> 
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">u</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wpo.simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
              <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?u</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Fun <span class="skolem">h</span> <span class="skolem">us</span>"</span></span>
              <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">h</span><span class="main">,</span>length <span class="skolem">us</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?us</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>σ <span class="var">?h</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mus</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span> <span class="bound">k</span><span class="main">.</span> <span class="skolem">us</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> <span class="main">(</span>σ <span class="var">?h</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">from</span></span> s t u ge1 ge2 <span class="keyword1"><span class="command">have</span></span> ge1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?s</span> <span class="main">≽</span> <span class="var">?t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ge2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?t</span> <span class="main">≻</span> <span class="var">?u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">from</span></span> stA stS s t <span class="keyword1"><span class="command">have</span></span> stAS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="var">?s</span><span class="main">,</span><span class="var">?t</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> False"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="var">?s</span><span class="main">,</span><span class="var">?t</span><span class="main">)</span> <span class="main">∈</span> <span class="free">NS</span><span class="main">)</span> <span class="main">=</span> True"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">from</span></span> tuA tuS t u <span class="keyword1"><span class="command">have</span></span> tuAS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="var">?t</span><span class="main">,</span><span class="var">?u</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> False"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="var">?t</span><span class="main">,</span><span class="var">?u</span><span class="main">)</span> <span class="main">∈</span> <span class="free">NS</span><span class="main">)</span> <span class="main">=</span> True"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">note</span></span> ge1 <span class="main">=</span> ge1<span class="main">[</span><span class="operator">unfolded</span> wpo.simps<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span><span class="main"><span class="main">]</span></span> stAS<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
              <span class="keyword1"><span class="command">note</span></span> ge2 <span class="main">=</span> ge2<span class="main">[</span><span class="operator">unfolded</span> wpo.simps<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="var"><span class="quoted"><span class="var">?u</span></span></span><span class="main"><span class="main">]</span></span> tuAS<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>              
              <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ps2</span></span> <span class="skolem"><span class="skolem">pns2</span></span> <span class="keyword2"><span class="keyword">where</span></span> prc2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">prc</span> <span class="var">?g</span> <span class="var">?h</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps2</span><span class="main">,</span><span class="skolem">pns2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
              <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ps3</span></span> <span class="skolem"><span class="skolem">pns3</span></span> <span class="keyword2"><span class="keyword">where</span></span> prc3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">prc</span> <span class="var">?f</span> <span class="var">?h</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps3</span><span class="main">,</span><span class="skolem">pns3</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
              <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="var">?s1</span>›</span></span> t ge1 <span class="keyword1"><span class="command">have</span></span> st'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">j</span> <span class="main">∈</span> <span class="var">?ts</span><span class="main">.</span> <span class="var">?s</span> <span class="main">≻</span> <span class="skolem">ts</span> <span class="main">!</span> <span class="bound">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits prod.splits<span class="main">)</span>
              <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="var">?t1</span>›</span></span> t u ge2 tuS <span class="keyword1"><span class="command">have</span></span> tu'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">k</span> <span class="main">∈</span> <span class="var">?us</span><span class="main">.</span> <span class="var">?t</span> <span class="main">≻</span> <span class="skolem">us</span> <span class="main">!</span> <span class="bound">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits prod.splits<span class="main">)</span>
              <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="var">?s1</span>›</span></span> s t ge1 stS st' <span class="keyword1"><span class="command">have</span></span> fg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pns</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prc<span class="main">)</span> 
              <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="var">?t1</span>›</span></span> u ge2 tu' <span class="keyword1"><span class="command">have</span></span> gh<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pns2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prc2<span class="main">)</span>
              <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="var">?s1</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?s1</span> <span class="main">=</span> False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command">note</span></span> ge1 <span class="main">=</span> ge1<span class="main">[</span><span class="operator">unfolded</span> this<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> t<span class="main"><span class="main">]</span></span> if_False term.simps prc split<span class="main">]</span>
              <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="var">?t1</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?t1</span> <span class="main">=</span> False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command">note</span></span> ge2 <span class="main">=</span> ge2<span class="main">[</span><span class="operator">unfolded</span> this<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> u<span class="main"><span class="main">]</span></span> if_False term.simps prc2 split<span class="main">]</span>
              <span class="keyword1"><span class="command">note</span></span> compat <span class="main">=</span> prc_compat<span class="main">[</span><span class="operator">OF</span> prc prc2 prc3<span class="main">]</span>
              <span class="keyword1"><span class="command">from</span></span> fg gh compat <span class="keyword1"><span class="command">have</span></span> fh<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pns3</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
              <span class="keyword1"><span class="command">{</span></span>
                <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
                <span class="keyword3"><span class="command">assume</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> <span class="var">?us</span>"</span></span>
                <span class="keyword1"><span class="command">from</span></span> σE<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size <span class="main">(</span><span class="skolem">us</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">&lt;</span> size <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> u <span class="keyword1"><span class="command">using</span></span> size_simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">with</span></span> tu'<span class="main">[</span><span class="operator">folded</span> t<span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">≽</span> <span class="skolem">t</span>›</span></span> 
                  ind<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">us</span> <span class="main">!</span> <span class="skolem">k</span>"</span></span><span class="main">]</span> k <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≻</span> <span class="skolem">us</span> <span class="main">!</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
              <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> su' <span class="main">=</span> this
              <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ps3</span></span><span class="main">)</span>
                <span class="keyword3"><span class="command">case</span></span> True
                <span class="keyword1"><span class="command">with</span></span> su' s u fh prc3 suA <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wpo.simps<span class="main">)</span>
              <span class="keyword1"><span class="command">next</span></span>
                <span class="keyword3"><span class="command">case</span></span> False
                <span class="keyword1"><span class="command">from</span></span> False fg gh compat <span class="keyword1"><span class="command">have</span></span> nfg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">ps</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ngh<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">ps2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ps</span> <span class="main">=</span> False"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ps2</span> <span class="main">=</span> False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
                <span class="keyword1"><span class="command">note</span></span> ge1 <span class="main">=</span> ge1<span class="main">[</span><span class="operator">unfolded</span> * if_False<span class="main">]</span>
                <span class="keyword1"><span class="command">note</span></span> ge2 <span class="main">=</span> ge2<span class="main">[</span><span class="operator">unfolded</span> * if_False<span class="main">]</span>
                <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="var">?f</span>"</span></span><span class="main">)</span>
                  <span class="keyword3"><span class="command">case</span></span> Mul <span class="keyword1"><span class="command">note</span></span> cf <span class="main">=</span> this
                  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="var">?g</span>"</span></span><span class="main">)</span>
                    <span class="keyword3"><span class="command">case</span></span> Mul <span class="keyword1"><span class="command">note</span></span> cg <span class="main">=</span> this
                    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="var">?h</span>"</span></span><span class="main">)</span>
                      <span class="keyword3"><span class="command">case</span></span> Mul <span class="keyword1"><span class="command">note</span></span> ch <span class="main">=</span> this
                      <span class="keyword1"><span class="command">from</span></span> ge1<span class="main">[</span><span class="operator">unfolded</span> cf cg<span class="main">]</span>
                      <span class="keyword1"><span class="command">have</span></span> mul1<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>mul_ext wpo <span class="var">?mss</span> <span class="var">?mts</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
                      <span class="keyword1"><span class="command">from</span></span> ge2<span class="main">[</span><span class="operator">unfolded</span> cg ch<span class="main">]</span>
                      <span class="keyword1"><span class="command">have</span></span> mul2<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>mul_ext wpo <span class="var">?mts</span> <span class="var">?mus</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
                      <span class="keyword1"><span class="command">from</span></span> mul1 mul2 mul_ext_compat<span class="main">[</span><span class="operator">OF</span> ind3'<span class="main">,</span> <span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?mss</span></span></span> <span class="var"><span class="quoted"><span class="var">?mts</span></span></span> <span class="var"><span class="quoted"><span class="var">?mus</span></span></span><span class="main">]</span>
                      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>mul_ext wpo <span class="var">?mss</span> <span class="var">?mus</span><span class="main">)</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                      <span class="keyword1"><span class="command">with</span></span> s u fh su' prc3 cf ch suA <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> wpo.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">u</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                    <span class="keyword1"><span class="command">next</span></span>
                      <span class="keyword3"><span class="command">case</span></span> Lex <span class="keyword1"><span class="command">note</span></span> ch <span class="main">=</span> this
                      <span class="keyword1"><span class="command">from</span></span> gh u ge2 tu' prc2 ngh cg ch <span class="keyword1"><span class="command">have</span></span> us_e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?mus</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                      <span class="keyword1"><span class="command">from</span></span> gh u ge2 tu' prc2 ngh cg ch <span class="keyword1"><span class="command">have</span></span> ts_ne<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?mts</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
                      <span class="keyword1"><span class="command">from</span></span> ns_mul_ext_bottom_uniqueness<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"mset <span class="var">?mts</span>"</span></span><span class="main">]</span>
                      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> snd <span class="main">(</span>mul_ext <span class="bound">f</span> <span class="main">[]</span> <span class="var">?mts</span><span class="main">)</span> <span class="main">⟹</span> <span class="var">?mts</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> mul_ext_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
                      <span class="keyword1"><span class="command">with</span></span> ts_ne fg <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="var">?s1</span>›</span></span> t ge1 st' prc nfg cf cg <span class="keyword1"><span class="command">have</span></span> ss_ne<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?mss</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
                        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ss</span></span><span class="main">)</span> <span class="operator">auto</span>
                      <span class="keyword1"><span class="command">from</span></span> us_e ss_ne s u fh su' prc3 cf cg ch suA <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> wpo.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">u</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                    <span class="keyword1"><span class="command">qed</span></span>
                  <span class="keyword1"><span class="command">next</span></span>
                    <span class="keyword3"><span class="command">case</span></span> Lex <span class="keyword1"><span class="command">note</span></span> cg <span class="main">=</span> this
                    <span class="keyword1"><span class="command">from</span></span> fg <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="var">?s1</span>›</span></span> t ge1 st' prc nfg cf cg <span class="keyword1"><span class="command">have</span></span> ts_e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?mts</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                    <span class="keyword1"><span class="command">with</span></span> gh <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="var">?t1</span>›</span></span> u ge2 tu' prc2 ngh cg <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="var">?h</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lex_ext_least_2<span class="main">)</span>
                  <span class="keyword1"><span class="command">qed</span></span>
                <span class="keyword1"><span class="command">next</span></span>
                  <span class="keyword3"><span class="command">case</span></span> Lex <span class="keyword1"><span class="command">note</span></span> cf <span class="main">=</span> this 
                  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="var">?g</span>"</span></span><span class="main">)</span>
                    <span class="keyword3"><span class="command">case</span></span> Mul <span class="keyword1"><span class="command">note</span></span> cg <span class="main">=</span> this
                    <span class="keyword1"><span class="command">from</span></span> fg <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="var">?s1</span>›</span></span> t ge1 st' prc nfg cf cg <span class="keyword1"><span class="command">have</span></span> ts_e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?mts</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                    <span class="keyword1"><span class="command">with</span></span> gh <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="var">?t1</span>›</span></span> u ge2 tu' prc2 ngh cg <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="var">?h</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def s_mul_ext_def s_mul_ext_bottom mul_ext_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> mult2_alt_sE<span class="main">)</span>
                  <span class="keyword1"><span class="command">next</span></span>
                    <span class="keyword3"><span class="command">case</span></span> Lex <span class="keyword1"><span class="command">note</span></span> cg <span class="main">=</span> this
                    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="var">?h</span>"</span></span><span class="main">)</span>
                      <span class="keyword3"><span class="command">case</span></span> Mul <span class="keyword1"><span class="command">note</span></span> ch <span class="main">=</span> this
                      <span class="keyword1"><span class="command">from</span></span> gh u ge2 tu' ngh cg ch <span class="keyword1"><span class="command">have</span></span> us_e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?mus</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                      <span class="keyword1"><span class="command">from</span></span> gh u ge2 tu' ngh cg ch <span class="keyword1"><span class="command">have</span></span> ts_ne<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?mts</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                      <span class="keyword1"><span class="command">from</span></span> lex_ext_iff<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="var"><span class="quoted"><span class="var">?mts</span></span></span><span class="main">]</span>
                      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> snd <span class="main">(</span>lex_ext <span class="bound">f</span> <span class="free">n</span> <span class="main">[]</span> <span class="var">?mts</span><span class="main">)</span> <span class="main">⟹</span> <span class="var">?mts</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                      <span class="keyword1"><span class="command">with</span></span> ts_ne fg t ge1 st' nfg cf cg <span class="keyword1"><span class="command">have</span></span> ss_ne<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?mss</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                      <span class="keyword1"><span class="command">from</span></span> us_e ss_ne s u fh su' prc3 cf cg ch suA <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> wpo.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">u</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                    <span class="keyword1"><span class="command">next</span></span>
                      <span class="keyword3"><span class="command">case</span></span> Lex <span class="keyword1"><span class="command">note</span></span> ch <span class="main">=</span> this
                      <span class="keyword1"><span class="command">from</span></span> fg t ge1 st' nfg cf cg
                      <span class="keyword1"><span class="command">have</span></span> lex1<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>lex_ext wpo <span class="free">n</span> <span class="var">?mss</span> <span class="var">?mts</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                      <span class="keyword1"><span class="command">from</span></span> gh u ge2 tu' ngh cg ch
                      <span class="keyword1"><span class="command">have</span></span> lex2<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>lex_ext wpo <span class="free">n</span> <span class="var">?mts</span> <span class="var">?mus</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                      <span class="keyword1"><span class="command">from</span></span> lex1 lex2 lex_ext_compat<span class="main">[</span><span class="operator">OF</span> ind3'<span class="main">,</span> <span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?mss</span></span></span> <span class="var"><span class="quoted"><span class="var">?mts</span></span></span> <span class="var"><span class="quoted"><span class="var">?mus</span></span></span><span class="main">]</span>
                      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>lex_ext wpo <span class="free">n</span> <span class="var">?mss</span> <span class="var">?mus</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                      <span class="keyword1"><span class="command">with</span></span> s u fh su' prc3 cf cg ch suA <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> wpo.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">u</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                    <span class="keyword1"><span class="command">qed</span></span>
                  <span class="keyword1"><span class="command">qed</span></span>
                <span class="keyword1"><span class="command">qed</span></span>
              <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">assume</span></span> ge1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≻</span> <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ge2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≽</span> <span class="skolem">u</span>"</span></span>
          <span class="keyword1"><span class="command">from</span></span> wpo_s_imp_NS<span class="main">[</span><span class="operator">OF</span> ge1<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> stA<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> <span class="free">NS</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
          <span class="keyword1"><span class="command">from</span></span> wpo_ns_imp_NS<span class="main">[</span><span class="operator">OF</span> ge2<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> tuA<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span><span class="skolem">u</span><span class="main">)</span> <span class="main">∈</span> <span class="free">NS</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
          <span class="keyword1"><span class="command">from</span></span> trans_NS_point<span class="main">[</span><span class="operator">OF</span> stA tuA<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> suA<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">u</span><span class="main">)</span> <span class="main">∈</span> <span class="free">NS</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≻</span> <span class="skolem">u</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="var"><span class="quoted"><span class="var">?s1</span></span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> True
            <span class="keyword1"><span class="command">from</span></span> True <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="var">?ss</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ges<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">≽</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">from</span></span> σE<span class="main">[</span><span class="operator">OF</span> i<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> s'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">∈</span> set <span class="skolem">ss</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">with</span></span> s s' ind2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="skolem">u</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> ges ge2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">≽</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">with</span></span> i s' s suA <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">u</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wpo.simps<span class="main">)</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> False
            <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="var"><span class="quoted"><span class="var">?t1</span></span></span><span class="main">)</span>
              <span class="keyword3"><span class="command">case</span></span> True
              <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="var">?ts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ges<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ts</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">≽</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">from</span></span> σE<span class="main">[</span><span class="operator">OF</span> j<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> t'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ts</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">∈</span> set <span class="skolem">ts</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
              <span class="keyword1"><span class="command">from</span></span> j t' t stS False ge1 s <span class="keyword1"><span class="command">have</span></span> ge1'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≻</span> <span class="skolem">ts</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> wpo.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits prod.splits<span class="main">)</span>        
              <span class="keyword1"><span class="command">from</span></span> t' s t ge1' ges ind<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ts</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span> <span class="quoted"><span class="skolem">u</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> 
              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≻</span> <span class="skolem">u</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> suA size_simps supt.intros <span class="keyword1"><span class="command">unfolding</span></span> wpo.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">u</span></span><span class="main">]</span> 
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">case</span></span> False
              <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">u</span></span><span class="main">)</span>
                <span class="keyword3"><span class="command">case</span></span> u<span class="main">:</span> <span class="main">(</span>Fun <span class="skolem">h</span> <span class="skolem">us</span><span class="main">)</span>
                <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?u</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Fun <span class="skolem">h</span> <span class="skolem">us</span>"</span></span>
                <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">h</span><span class="main">,</span>length <span class="skolem">us</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?us</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>σ <span class="var">?h</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mss</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">ss</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>σ <span class="var">?f</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mts</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span> <span class="bound">j</span><span class="main">.</span> <span class="skolem">ts</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">(</span>σ <span class="var">?g</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mus</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span> <span class="bound">k</span><span class="main">.</span> <span class="skolem">us</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> <span class="main">(</span>σ <span class="var">?h</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">note</span></span> σE <span class="main">=</span>  σE<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">f</span></span> <span class="quoted"><span class="skolem">ss</span></span><span class="main">]</span> σE<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">g</span></span> <span class="quoted"><span class="skolem">ts</span></span><span class="main">]</span> σE<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">h</span></span> <span class="quoted"><span class="skolem">us</span></span><span class="main">]</span>
                <span class="keyword1"><span class="command">from</span></span> s t u ge1 ge2 <span class="keyword1"><span class="command">have</span></span> ge1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?s</span> <span class="main">≻</span> <span class="var">?t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ge2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?t</span> <span class="main">≽</span> <span class="var">?u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">from</span></span> stA stS s t <span class="keyword1"><span class="command">have</span></span> stAS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="var">?s</span><span class="main">,</span><span class="var">?t</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> False"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="var">?s</span><span class="main">,</span><span class="var">?t</span><span class="main">)</span> <span class="main">∈</span> <span class="free">NS</span><span class="main">)</span> <span class="main">=</span> True"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">from</span></span> tuA tuS t u <span class="keyword1"><span class="command">have</span></span> tuAS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="var">?t</span><span class="main">,</span><span class="var">?u</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> False"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="var">?t</span><span class="main">,</span><span class="var">?u</span><span class="main">)</span> <span class="main">∈</span> <span class="free">NS</span><span class="main">)</span> <span class="main">=</span> True"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">note</span></span> ge1 <span class="main">=</span> ge1<span class="main">[</span><span class="operator">unfolded</span> wpo.simps<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span><span class="main"><span class="main">]</span></span> stAS<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
                <span class="keyword1"><span class="command">note</span></span> ge2 <span class="main">=</span> ge2<span class="main">[</span><span class="operator">unfolded</span> wpo.simps<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="var"><span class="quoted"><span class="var">?u</span></span></span><span class="main"><span class="main">]</span></span> tuAS<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
                <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?lu</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"length <span class="skolem">us</span>"</span></span>
                <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ps2</span></span> <span class="skolem"><span class="skolem">pns2</span></span> <span class="keyword2"><span class="keyword">where</span></span> prc2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">prc</span> <span class="var">?g</span> <span class="var">?h</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps2</span><span class="main">,</span><span class="skolem">pns2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
                <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ps3</span></span> <span class="skolem"><span class="skolem">pns3</span></span> <span class="keyword2"><span class="keyword">where</span></span> prc3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">prc</span> <span class="var">?f</span> <span class="var">?h</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps3</span><span class="main">,</span><span class="skolem">pns3</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
                <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="var">?s1</span>›</span></span> t ge1 <span class="keyword1"><span class="command">have</span></span> st'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">j</span> <span class="main">∈</span> <span class="var">?ts</span><span class="main">.</span> <span class="var">?s</span> <span class="main">≻</span> <span class="skolem">ts</span> <span class="main">!</span> <span class="bound">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits prod.splits<span class="main">)</span>
                <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="var">?t1</span>›</span></span> t u ge2 tuS <span class="keyword1"><span class="command">have</span></span> tu'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">k</span> <span class="main">∈</span> <span class="var">?us</span><span class="main">.</span> <span class="var">?t</span> <span class="main">≻</span> <span class="skolem">us</span> <span class="main">!</span> <span class="bound">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits prod.splits<span class="main">)</span>
                <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="var">?s1</span>›</span></span> s t ge1 stS st' <span class="keyword1"><span class="command">have</span></span> fg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pns</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prc<span class="main">)</span> 
                <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="var">?t1</span>›</span></span> u ge2 tu' <span class="keyword1"><span class="command">have</span></span> gh<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pns2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prc2<span class="main">)</span>
                <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="var">?s1</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?s1</span> <span class="main">=</span> False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                <span class="keyword1"><span class="command">note</span></span> ge1 <span class="main">=</span> ge1<span class="main">[</span><span class="operator">unfolded</span> this<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> t<span class="main"><span class="main">]</span></span> if_False term.simps prc split<span class="main">]</span>
                <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="var">?t1</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?t1</span> <span class="main">=</span> False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                <span class="keyword1"><span class="command">note</span></span> ge2 <span class="main">=</span> ge2<span class="main">[</span><span class="operator">unfolded</span> this<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> u<span class="main"><span class="main">]</span></span> if_False term.simps prc2 split<span class="main">]</span>
                <span class="keyword1"><span class="command">note</span></span> compat <span class="main">=</span> prc_compat<span class="main">[</span><span class="operator">OF</span> prc prc2 prc3<span class="main">]</span>
                <span class="keyword1"><span class="command">from</span></span> fg gh compat <span class="keyword1"><span class="command">have</span></span> fh<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pns3</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
                <span class="keyword1"><span class="command">{</span></span>
                  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
                  <span class="keyword3"><span class="command">assume</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> <span class="var">?us</span>"</span></span>
                  <span class="keyword1"><span class="command">from</span></span> σE<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size <span class="main">(</span><span class="skolem">us</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">&lt;</span> size <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> u <span class="keyword1"><span class="command">using</span></span> size_simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">with</span></span> tu'<span class="main">[</span><span class="operator">folded</span> t<span class="main">]</span> wpo_s_imp_ns<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">≻</span> <span class="skolem">t</span>›</span></span><span class="main">]</span> 
                    ind<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">us</span> <span class="main">!</span> <span class="skolem">k</span>"</span></span><span class="main">]</span> k <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≻</span> <span class="skolem">us</span> <span class="main">!</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> su' <span class="main">=</span> this
                <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ps3</span></span><span class="main">)</span>
                  <span class="keyword3"><span class="command">case</span></span> True
                  <span class="keyword1"><span class="command">with</span></span> su' s u fh prc3 suA <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wpo.simps<span class="main">)</span>
                <span class="keyword1"><span class="command">next</span></span>
                  <span class="keyword3"><span class="command">case</span></span> False
                  <span class="keyword1"><span class="command">from</span></span> False fg gh compat <span class="keyword1"><span class="command">have</span></span> nfg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">ps</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ngh<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">ps2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ps</span> <span class="main">=</span> False"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ps2</span> <span class="main">=</span> False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
                  <span class="keyword1"><span class="command">note</span></span> ge1 <span class="main">=</span> ge1<span class="main">[</span><span class="operator">unfolded</span> * if_False<span class="main">]</span>
                  <span class="keyword1"><span class="command">note</span></span> ge2 <span class="main">=</span> ge2<span class="main">[</span><span class="operator">unfolded</span> * if_False<span class="main">]</span>
                  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="var">?f</span>"</span></span><span class="main">)</span>
                    <span class="keyword3"><span class="command">case</span></span> Mul <span class="keyword1"><span class="command">note</span></span> cf <span class="main">=</span> this
                    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="var">?g</span>"</span></span><span class="main">)</span>
                      <span class="keyword3"><span class="command">case</span></span> Mul <span class="keyword1"><span class="command">note</span></span> cg <span class="main">=</span> this
                      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="var">?h</span>"</span></span><span class="main">)</span>
                        <span class="keyword3"><span class="command">case</span></span> Mul <span class="keyword1"><span class="command">note</span></span> ch <span class="main">=</span> this
                        <span class="keyword1"><span class="command">from</span></span> fg t ge1 st' nfg cf cg
                        <span class="keyword1"><span class="command">have</span></span> mul1<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>mul_ext wpo <span class="var">?mss</span> <span class="var">?mts</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                        <span class="keyword1"><span class="command">from</span></span> gh u ge2 tu' ngh cg ch
                        <span class="keyword1"><span class="command">have</span></span> mul2<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>mul_ext wpo <span class="var">?mts</span> <span class="var">?mus</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                        <span class="keyword1"><span class="command">from</span></span> mul1 mul2 mul_ext_compat<span class="main">[</span><span class="operator">OF</span> ind3'<span class="main">,</span> <span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?mss</span></span></span> <span class="var"><span class="quoted"><span class="var">?mts</span></span></span> <span class="var"><span class="quoted"><span class="var">?mus</span></span></span><span class="main">]</span>
                        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>mul_ext wpo <span class="var">?mss</span> <span class="var">?mus</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                        <span class="keyword1"><span class="command">with</span></span> s u fh su' prc3 cf ch suA <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> wpo.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">u</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                      <span class="keyword1"><span class="command">next</span></span>
                        <span class="keyword3"><span class="command">case</span></span> Lex <span class="keyword1"><span class="command">note</span></span> ch <span class="main">=</span> this
                        <span class="keyword1"><span class="command">from</span></span> gh u ge2 tu' ngh cg ch <span class="keyword1"><span class="command">have</span></span> us_e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?mus</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                        <span class="keyword1"><span class="command">from</span></span> fg t ge1 st' nfg cf cg s_mul_ext_bottom_strict
                        <span class="keyword1"><span class="command">have</span></span> ss_ne<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?mss</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="var"><span class="quoted"><span class="var">?mss</span></span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def mul_ext_def<span class="main">)</span>
                        <span class="keyword1"><span class="command">from</span></span> us_e ss_ne s u fh su' prc3 cf cg ch suA <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> wpo.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">u</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                      <span class="keyword1"><span class="command">qed</span></span>
                    <span class="keyword1"><span class="command">next</span></span>
                      <span class="keyword3"><span class="command">case</span></span> Lex <span class="keyword1"><span class="command">note</span></span> cg <span class="main">=</span> this
                      <span class="keyword1"><span class="command">from</span></span> fg t ge1 st' prc nfg cf cg s_mul_ext_bottom_strict
                      <span class="keyword1"><span class="command">have</span></span> ss_ne<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?mss</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mul_ext_def<span class="main">)</span>
                      <span class="keyword1"><span class="command">from</span></span> fg t ge1 st' nfg cf cg <span class="keyword1"><span class="command">have</span></span> ts_e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?mts</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="var">?h</span>"</span></span><span class="main">)</span>
                        <span class="keyword3"><span class="command">case</span></span> Mul <span class="keyword1"><span class="command">note</span></span> ch <span class="main">=</span> this
                        <span class="keyword1"><span class="command">with</span></span> gh u ge2 tu' ngh cg ch ns_mul_ext_bottom_uniqueness
                        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mus</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                        <span class="keyword1"><span class="command">with</span></span> ss_ne s u fh su' prc3 cf cg ch s_mul_ext_bottom suA
                        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> wpo.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">u</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def mul_ext_def s_mul_ext_def mult2_alt_s_def<span class="main">)</span>
                      <span class="keyword1"><span class="command">next</span></span>
                        <span class="keyword3"><span class="command">case</span></span> Lex <span class="keyword1"><span class="command">note</span></span> ch <span class="main">=</span> this
                        <span class="keyword1"><span class="command">from</span></span> lex_ext_iff<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="var"><span class="quoted"><span class="var">?mus</span></span></span><span class="main">]</span>
                        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> snd <span class="main">(</span>lex_ext <span class="bound">f</span> <span class="free">n</span> <span class="main">[]</span> <span class="var">?mus</span><span class="main">)</span> <span class="main">⟹</span> <span class="var">?mus</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                        <span class="keyword1"><span class="command">with</span></span> ts_e gh u ge2 tu' ngh cg ch
                        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mus</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                        <span class="keyword1"><span class="command">with</span></span> ss_ne s u fh su' prc3 cf cg ch s_mul_ext_bottom suA
                        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> wpo.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">u</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mul_ext_def<span class="main">)</span>
                      <span class="keyword1"><span class="command">qed</span></span>
                    <span class="keyword1"><span class="command">qed</span></span>
                  <span class="keyword1"><span class="command">next</span></span>
                    <span class="keyword3"><span class="command">case</span></span> Lex <span class="keyword1"><span class="command">note</span></span> cf <span class="main">=</span> this
                    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="var">?g</span>"</span></span><span class="main">)</span>
                      <span class="keyword3"><span class="command">case</span></span> Mul <span class="keyword1"><span class="command">note</span></span> cg <span class="main">=</span> this
                      <span class="keyword1"><span class="command">from</span></span> fg t ge1 st' nfg cf cg <span class="keyword1"><span class="command">have</span></span> ss_ne<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?mss</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                      <span class="keyword1"><span class="command">from</span></span> fg t ge1 st' nfg cf cg <span class="keyword1"><span class="command">have</span></span> ts_e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?mts</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="var">?h</span>"</span></span><span class="main">)</span>
                        <span class="keyword3"><span class="command">case</span></span> Mul <span class="keyword1"><span class="command">note</span></span> ch <span class="main">=</span> this
                        <span class="keyword1"><span class="command">from</span></span> ts_e gh u ge2 tu' ngh cg ch
                          ns_mul_ext_bottom_uniqueness<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"mset <span class="var">?mus</span>"</span></span><span class="main">]</span>
                        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mus</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mul_ext_def Let_def<span class="main">)</span>
                        <span class="keyword1"><span class="command">with</span></span> ss_ne s u fh su' prc3 cf cg ch s_mul_ext_bottom suA
                        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> wpo.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">u</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mul_ext_def<span class="main">)</span>
                      <span class="keyword1"><span class="command">next</span></span>
                        <span class="keyword3"><span class="command">case</span></span> Lex <span class="keyword1"><span class="command">note</span></span> ch <span class="main">=</span> this
                        <span class="keyword1"><span class="command">from</span></span> gh u ge2 tu' prc2 ngh cg ch <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mus</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                        <span class="keyword1"><span class="command">with</span></span> ss_ne s u fh su' prc3 cf cg ch suA
                        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> wpo.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">u</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lex_ext_iff<span class="main">)</span> 
                      <span class="keyword1"><span class="command">qed</span></span>
                    <span class="keyword1"><span class="command">next</span></span>
                      <span class="keyword3"><span class="command">case</span></span> Lex <span class="keyword1"><span class="command">note</span></span> cg <span class="main">=</span> this
                      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="var">?h</span>"</span></span><span class="main">)</span>
                        <span class="keyword3"><span class="command">case</span></span> Mul <span class="keyword1"><span class="command">note</span></span> ch <span class="main">=</span> this
                        <span class="keyword1"><span class="command">from</span></span> gh u ge2 tu' ngh cg ch <span class="keyword1"><span class="command">have</span></span> us_e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?mus</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> fst <span class="main">(</span>lex_ext <span class="bound">f</span> <span class="free">n</span> <span class="var">?mss</span> <span class="var">?mts</span><span class="main">)</span> <span class="main">⟹</span> <span class="var">?mss</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
                          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="var"><span class="quoted"><span class="var">?mss</span></span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lex_ext_iff<span class="main">)</span>
                        <span class="keyword1"><span class="command">with</span></span> fg t ge1 st' prc nfg cf cg <span class="keyword1"><span class="command">have</span></span> ss_ne<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?mss</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                        <span class="keyword1"><span class="command">with</span></span> us_e s u fh su' prc3 cf cg ch suA <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> wpo.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">u</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                      <span class="keyword1"><span class="command">next</span></span>
                        <span class="keyword3"><span class="command">case</span></span> Lex <span class="keyword1"><span class="command">note</span></span> ch <span class="main">=</span> this
                        <span class="keyword1"><span class="command">from</span></span> fg t ge1 st' nfg cf cg
                        <span class="keyword1"><span class="command">have</span></span> lex1<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>lex_ext wpo <span class="free">n</span> <span class="var">?mss</span> <span class="var">?mts</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                        <span class="keyword1"><span class="command">from</span></span> gh u ge2 tu' ngh cg ch
                        <span class="keyword1"><span class="command">have</span></span> lex2<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>lex_ext wpo <span class="free">n</span> <span class="var">?mts</span> <span class="var">?mus</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                        <span class="keyword1"><span class="command">from</span></span> lex1 lex2 lex_ext_compat<span class="main">[</span><span class="operator">OF</span> ind3'<span class="main">,</span> <span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?mss</span></span></span> <span class="var"><span class="quoted"><span class="var">?mts</span></span></span> <span class="var"><span class="quoted"><span class="var">?mus</span></span></span><span class="main">]</span>
                        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>lex_ext wpo <span class="free">n</span> <span class="var">?mss</span> <span class="var">?mus</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                        <span class="keyword1"><span class="command">with</span></span> s u fh su' prc3 cf cg ch suA <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> wpo.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">u</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                      <span class="keyword1"><span class="command">qed</span></span>
                    <span class="keyword1"><span class="command">qed</span></span>
                  <span class="keyword1"><span class="command">qed</span></span>
                <span class="keyword1"><span class="command">qed</span></span>              
              <span class="keyword1"><span class="command">next</span></span>
                <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Var <span class="skolem">z</span><span class="main">)</span>
                <span class="keyword1"><span class="command">from</span></span> ge2 <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="var">?t1</span>›</span></span> tuS <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ssimple</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">large</span> <span class="var">?g</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Var t
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wpo.simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>    
                <span class="keyword1"><span class="command">from</span></span> large<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span><span class="main">]</span>
                <span class="keyword1"><span class="command">have</span></span> large<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="free">prc</span> <span class="var">?g</span> <span class="var">?f</span><span class="main">)</span> <span class="main">∨</span> snd <span class="main">(</span><span class="free">prc</span> <span class="var">?g</span> <span class="var">?f</span><span class="main">)</span> <span class="main">∧</span> σ <span class="var">?f</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fgs</span></span> <span class="skolem"><span class="skolem">fgns</span></span> <span class="keyword2"><span class="keyword">where</span></span> prc_fg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">prc</span> <span class="var">?f</span> <span class="var">?g</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">fgs</span><span class="main">,</span><span class="skolem">fgns</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">prc</span> <span class="var">?f</span> <span class="var">?g</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> 
                <span class="keyword1"><span class="command">from</span></span> ge1 <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="var">?s1</span>›</span></span> stS <span class="keyword1"><span class="command">have</span></span> weak_fg<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="free">prc</span> <span class="var">?f</span> <span class="var">?g</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> s t <span class="keyword1"><span class="command">using</span></span> prc_fg
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wpo.simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
                <span class="keyword1"><span class="command">from</span></span> refl_not_SN<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span><span class="main">]</span> prc_SN <span class="keyword1"><span class="command">have</span></span> prc_irrefl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> fst <span class="main">(</span><span class="free">prc</span> <span class="var">?f</span> <span class="var">?f</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">from</span></span> large <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span>
                <span class="keyword1"><span class="command">proof</span></span>
                  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="free">prc</span> <span class="var">?g</span> <span class="var">?f</span><span class="main">)</span>"</span></span> 
                  <span class="keyword1"><span class="command">with</span></span> weak_fg <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="free">prc</span> <span class="var">?f</span> <span class="var">?f</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prc_compat prod.collapse<span class="main">)</span>
                  <span class="keyword1"><span class="command">with</span></span> prc_irrefl <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">next</span></span>
                  <span class="keyword3"><span class="command">assume</span></span> weak<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="free">prc</span> <span class="var">?g</span> <span class="var">?f</span><span class="main">)</span> <span class="main">∧</span> σ <span class="var">?f</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> 
                  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mss</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">ss</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>σ <span class="var">?f</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mts</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span> <span class="bound">j</span><span class="main">.</span> <span class="skolem">ts</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">(</span>σ <span class="var">?g</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">{</span></span>
                    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="free">prc</span> <span class="var">?f</span> <span class="var">?g</span><span class="main">)</span>"</span></span> 
                    <span class="keyword1"><span class="command">with</span></span> weak <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="free">prc</span> <span class="var">?f</span> <span class="var">?f</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prc_compat prod.collapse<span class="main">)</span>
                    <span class="keyword1"><span class="command">with</span></span> prc_irrefl <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">}</span></span>
                  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> fst <span class="main">(</span><span class="free">prc</span> <span class="var">?f</span> <span class="var">?g</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">with</span></span> ge1 <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="var">?s1</span>›</span></span> stS prc_fg 
                  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>lex_ext wpo <span class="free">n</span> <span class="var">?mss</span> <span class="var">?mts</span><span class="main">)</span> <span class="main">∨</span> fst <span class="main">(</span>mul_ext wpo <span class="var">?mss</span> <span class="var">?mts</span><span class="main">)</span> <span class="main">∨</span> <span class="var">?mss</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> 
                    <span class="keyword1"><span class="command">unfolding</span></span> wpo.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> s t 
                    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
                  <span class="keyword1"><span class="command">with</span></span> weak <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>lex_ext wpo <span class="free">n</span> <span class="main">[]</span> <span class="var">?mts</span><span class="main">)</span> <span class="main">∨</span> fst <span class="main">(</span>mul_ext wpo <span class="main">[]</span> <span class="var">?mts</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> lex_ext_least_2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mul_ext_def Let_def s_mul_ext_bottom_strict<span class="main">)</span> 
                <span class="keyword1"><span class="command">qed</span></span>
                <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
              <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">assume</span></span> ge1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≽</span> <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ge2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≽</span> <span class="skolem">u</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ngt1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">s</span> <span class="main">≻</span> <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ngt2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">t</span> <span class="main">≻</span> <span class="skolem">u</span>"</span></span>
          <span class="keyword1"><span class="command">from</span></span> wpo_ns_imp_NS<span class="main">[</span><span class="operator">OF</span> ge1<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> stA<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> <span class="free">NS</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
          <span class="keyword1"><span class="command">from</span></span> wpo_ns_imp_NS<span class="main">[</span><span class="operator">OF</span> ge2<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> tuA<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span><span class="skolem">u</span><span class="main">)</span> <span class="main">∈</span> <span class="free">NS</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
          <span class="keyword1"><span class="command">from</span></span> trans_NS_point<span class="main">[</span><span class="operator">OF</span> stA tuA<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> suA<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">u</span><span class="main">)</span> <span class="main">∈</span> <span class="free">NS</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
          <span class="keyword1"><span class="command">from</span></span> ngt1 stA <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?s1</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> s t <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wpo.simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
          <span class="keyword1"><span class="command">from</span></span> ngt2 tuA <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?t1</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> t <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">u</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wpo.simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≽</span> <span class="skolem">u</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">u</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> u<span class="main">:</span> <span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span>
            <span class="keyword1"><span class="command">from</span></span> t <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="var">?t1</span>›</span></span> ge2 tuA ngt2 <span class="keyword1"><span class="command">have</span></span> large<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ssimple</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">large</span> <span class="var">?g</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> u
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wpo.simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
            <span class="keyword1"><span class="command">from</span></span> s t ngt1 ge1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="free">prc</span> <span class="var">?f</span> <span class="var">?g</span><span class="main">)</span>"</span></span> 
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wpo.simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits prod.splits<span class="main">)</span>
            <span class="keyword1"><span class="command">from</span></span> large_trans<span class="main">[</span><span class="operator">OF</span> large this<span class="main">]</span> suA large
            <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> wpo.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">u</span></span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> s u <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> u<span class="main">:</span> <span class="main">(</span>Fun <span class="skolem">h</span> <span class="skolem">us</span><span class="main">)</span>
            <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?u</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Fun <span class="skolem">h</span> <span class="skolem">us</span>"</span></span>	 
            <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">h</span><span class="main">,</span>length <span class="skolem">us</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?us</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>σ <span class="var">?h</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mss</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">ss</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>σ <span class="var">?f</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mts</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span> <span class="bound">j</span><span class="main">.</span> <span class="skolem">ts</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">(</span>σ <span class="var">?g</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mus</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span> <span class="bound">k</span><span class="main">.</span> <span class="skolem">us</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> <span class="main">(</span>σ <span class="var">?h</span><span class="main">)</span>"</span></span>   
            <span class="keyword1"><span class="command">from</span></span> s t u ge1 ge2 <span class="keyword1"><span class="command">have</span></span> ge1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?s</span> <span class="main">≽</span> <span class="var">?t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ge2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?t</span> <span class="main">≽</span> <span class="var">?u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">from</span></span> stA stS s t <span class="keyword1"><span class="command">have</span></span> stAS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="var">?s</span><span class="main">,</span><span class="var">?t</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> False"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="var">?s</span><span class="main">,</span><span class="var">?t</span><span class="main">)</span> <span class="main">∈</span> <span class="free">NS</span><span class="main">)</span> <span class="main">=</span> True"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">from</span></span> tuA tuS t u <span class="keyword1"><span class="command">have</span></span> tuAS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="var">?t</span><span class="main">,</span><span class="var">?u</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> False"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="var">?t</span><span class="main">,</span><span class="var">?u</span><span class="main">)</span> <span class="main">∈</span> <span class="free">NS</span><span class="main">)</span> <span class="main">=</span> True"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">note</span></span> ge1 <span class="main">=</span> ge1<span class="main">[</span><span class="operator">unfolded</span> wpo.simps<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span><span class="main"><span class="main">]</span></span> stAS<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
            <span class="keyword1"><span class="command">note</span></span> ge2 <span class="main">=</span> ge2<span class="main">[</span><span class="operator">unfolded</span> wpo.simps<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="var"><span class="quoted"><span class="var">?u</span></span></span><span class="main"><span class="main">]</span></span> tuAS<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
            <span class="keyword1"><span class="command">from</span></span> s t u ngt1 ngt2 <span class="keyword1"><span class="command">have</span></span> ngt1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?s</span> <span class="main">≻</span> <span class="var">?t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ngt2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?t</span> <span class="main">≻</span> <span class="var">?u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">note</span></span> ngt1 <span class="main">=</span> ngt1<span class="main">[</span><span class="operator">unfolded</span> wpo.simps<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span><span class="main"><span class="main">]</span></span> stAS<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
            <span class="keyword1"><span class="command">note</span></span> ngt2 <span class="main">=</span> ngt2<span class="main">[</span><span class="operator">unfolded</span> wpo.simps<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="var"><span class="quoted"><span class="var">?u</span></span></span><span class="main"><span class="main">]</span></span> tuAS<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
            <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="var">?s1</span>›</span></span> t ge1 <span class="keyword1"><span class="command">have</span></span> st'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">j</span> <span class="main">∈</span> <span class="var">?ts</span><span class="main">.</span> <span class="var">?s</span> <span class="main">≻</span> <span class="skolem">ts</span> <span class="main">!</span> <span class="bound">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
            <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="var">?t1</span>›</span></span> u ge2 <span class="keyword1"><span class="command">have</span></span> tu'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">k</span> <span class="main">∈</span> <span class="var">?us</span><span class="main">.</span> <span class="var">?t</span> <span class="main">≻</span> <span class="skolem">us</span> <span class="main">!</span> <span class="bound">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
            <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?lu</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"length <span class="skolem">us</span>"</span></span>        
            <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ps2</span></span> <span class="skolem"><span class="skolem">pns2</span></span> <span class="keyword2"><span class="keyword">where</span></span> prc2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">prc</span> <span class="var">?g</span> <span class="var">?h</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps2</span><span class="main">,</span><span class="skolem">pns2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
            <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ps3</span></span> <span class="skolem"><span class="skolem">pns3</span></span> <span class="keyword2"><span class="keyword">where</span></span> prc3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">prc</span> <span class="var">?f</span> <span class="var">?h</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps3</span><span class="main">,</span><span class="skolem">pns3</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
            <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="var">?s1</span>›</span></span> t ge1 st' <span class="keyword1"><span class="command">have</span></span> fg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pns</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prc<span class="main">)</span> 
            <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="var">?t1</span>›</span></span> u ge2 tu' <span class="keyword1"><span class="command">have</span></span> gh<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pns2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prc2<span class="main">)</span>
            <span class="keyword1"><span class="command">note</span></span> compat <span class="main">=</span> prc_compat<span class="main">[</span><span class="operator">OF</span> prc prc2 prc3<span class="main">]</span>
            <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="var">?s1</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?s1</span> <span class="main">=</span> False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">note</span></span> ge1 <span class="main">=</span> ge1<span class="main">[</span><span class="operator">unfolded</span> this<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> t<span class="main"><span class="main">]</span></span> if_False term.simps prc split<span class="main">]</span>
            <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="var">?t1</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?t1</span> <span class="main">=</span> False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">note</span></span> ge2 <span class="main">=</span> ge2<span class="main">[</span><span class="operator">unfolded</span> this<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> u<span class="main"><span class="main">]</span></span> if_False term.simps prc2 split<span class="main">]</span>
            <span class="keyword1"><span class="command">from</span></span> compat fg gh <span class="keyword1"><span class="command">have</span></span> fh<span class="main">:</span> <span class="quoted"><span class="skolem">pns3</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">{</span></span>
              <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
              <span class="keyword3"><span class="command">assume</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> <span class="var">?us</span>"</span></span>
              <span class="keyword1"><span class="command">from</span></span> σE<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size <span class="main">(</span><span class="skolem">us</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">&lt;</span> size <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> u <span class="keyword1"><span class="command">using</span></span> size_simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">with</span></span> tu'<span class="main">[</span><span class="operator">folded</span> t<span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">≽</span> <span class="skolem">t</span>›</span></span>
                ind<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">us</span> <span class="main">!</span> <span class="skolem">k</span>"</span></span><span class="main">]</span> k <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≻</span> <span class="skolem">us</span> <span class="main">!</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> su' <span class="main">=</span> this
            <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="var">?s1</span>›</span></span> st' ge1 ngt1 s t <span class="keyword1"><span class="command">have</span></span> nfg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">ps</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">ps</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prc fg<span class="main">)</span> 
            <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="var">?t1</span>›</span></span> tu' ge2 ngt2 t u <span class="keyword1"><span class="command">have</span></span> ngh<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">ps2</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">ps2</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prc2 gh<span class="main">)</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≽</span> <span class="skolem">u</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="var">?f</span>"</span></span><span class="main">)</span>
              <span class="keyword3"><span class="command">case</span></span> Mul <span class="keyword1"><span class="command">note</span></span> cf <span class="main">=</span> this
              <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="var">?g</span>"</span></span><span class="main">)</span>
                <span class="keyword3"><span class="command">case</span></span> Mul <span class="keyword1"><span class="command">note</span></span> cg <span class="main">=</span> this
                <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="var">?h</span>"</span></span><span class="main">)</span>
                  <span class="keyword3"><span class="command">case</span></span> Mul <span class="keyword1"><span class="command">note</span></span> ch <span class="main">=</span> this
                  <span class="keyword1"><span class="command">from</span></span> fg t ge1 st' nfg cf cg
                  <span class="keyword1"><span class="command">have</span></span> mul1<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>mul_ext wpo <span class="var">?mss</span> <span class="var">?mts</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">from</span></span> gh u ge2 tu' ngh cg ch
                  <span class="keyword1"><span class="command">have</span></span> mul2<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>mul_ext wpo <span class="var">?mts</span> <span class="var">?mus</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">from</span></span> mul1 mul2 mul_ext_compat<span class="main">[</span><span class="operator">OF</span> ind3'<span class="main">,</span> <span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?mss</span></span></span> <span class="var"><span class="quoted"><span class="var">?mts</span></span></span> <span class="var"><span class="quoted"><span class="var">?mus</span></span></span><span class="main">]</span>
                  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>mul_ext wpo <span class="var">?mss</span> <span class="var">?mus</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">with</span></span> s u fh su' prc3 cf ch suA <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> wpo.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">u</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                <span class="keyword1"><span class="command">next</span></span>
                  <span class="keyword3"><span class="command">case</span></span> Lex <span class="keyword1"><span class="command">note</span></span> ch <span class="main">=</span> this
                  <span class="keyword1"><span class="command">from</span></span> gh u ge2 tu' ngh cg ch <span class="keyword1"><span class="command">have</span></span> us_e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?mus</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                  <span class="keyword1"><span class="command">with</span></span> s u fh su' prc3 cf cg ch suA <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> wpo.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">u</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                <span class="keyword1"><span class="command">qed</span></span>
              <span class="keyword1"><span class="command">next</span></span>
                <span class="keyword3"><span class="command">case</span></span> Lex <span class="keyword1"><span class="command">note</span></span> cg <span class="main">=</span> this
                <span class="keyword1"><span class="command">from</span></span> fg t ge1 st' nfg cf cg <span class="keyword1"><span class="command">have</span></span> ts_e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?mts</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="var">?h</span>"</span></span><span class="main">)</span>
                  <span class="keyword3"><span class="command">case</span></span> Mul <span class="keyword1"><span class="command">note</span></span> ch <span class="main">=</span> this
                  <span class="keyword1"><span class="command">with</span></span> gh u ge2 tu' ngh cg ch <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mus</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                  <span class="keyword1"><span class="command">with</span></span> s u fh su' prc3 cf cg ch ns_mul_ext_bottom suA
                  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> wpo.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">u</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ns_mul_ext_def mul_ext_def Let_def mult2_alt_ns_def<span class="main">)</span>
                <span class="keyword1"><span class="command">next</span></span>
                  <span class="keyword3"><span class="command">case</span></span> Lex <span class="keyword1"><span class="command">note</span></span> ch <span class="main">=</span> this
                  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> snd <span class="main">(</span>lex_ext <span class="bound">f</span> <span class="free">n</span> <span class="main">[]</span> <span class="var">?mus</span><span class="main">)</span> <span class="main">⟹</span> <span class="var">?mus</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lex_ext_iff<span class="main">)</span>
                  <span class="keyword1"><span class="command">with</span></span> ts_e gh u ge2 tu' ngh cg ch <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mus</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                  <span class="keyword1"><span class="command">with</span></span> s u fh su' prc3 cf cg ch suA <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> wpo.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">u</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                <span class="keyword1"><span class="command">qed</span></span>
              <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">case</span></span> Lex <span class="keyword1"><span class="command">note</span></span> cf <span class="main">=</span> this
              <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="var">?g</span>"</span></span><span class="main">)</span>
                <span class="keyword3"><span class="command">case</span></span> Mul <span class="keyword1"><span class="command">note</span></span> cg <span class="main">=</span> this
                <span class="keyword1"><span class="command">from</span></span> fg t ge1 st' prc nfg cf cg <span class="keyword1"><span class="command">have</span></span> ts_e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?mts</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="var">?h</span>"</span></span><span class="main">)</span>
                  <span class="keyword3"><span class="command">case</span></span> Mul <span class="keyword1"><span class="command">note</span></span> ch <span class="main">=</span> this
                  <span class="keyword1"><span class="command">with</span></span> ts_e gh u ge2 tu' ngh cg ch
                    ns_mul_ext_bottom_uniqueness<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"mset <span class="var">?mus</span>"</span></span><span class="main">]</span>
                  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mus</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def mul_ext_def<span class="main">)</span>
                  <span class="keyword1"><span class="command">with</span></span> s u fh su' prc3 cf cg ch suA <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> wpo.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">u</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                <span class="keyword1"><span class="command">next</span></span>
                  <span class="keyword3"><span class="command">case</span></span> Lex <span class="keyword1"><span class="command">note</span></span> ch <span class="main">=</span> this
                  <span class="keyword1"><span class="command">with</span></span> gh u ge2 tu' prc2 ngh cg ch <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mus</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                  <span class="keyword1"><span class="command">with</span></span> s u fh su' prc3 cf cg ch suA <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> wpo.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">u</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lex_ext_least_1<span class="main">)</span>
                <span class="keyword1"><span class="command">qed</span></span>
              <span class="keyword1"><span class="command">next</span></span>
                <span class="keyword3"><span class="command">case</span></span> Lex <span class="keyword1"><span class="command">note</span></span> cg <span class="main">=</span> this
                <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="var">?h</span>"</span></span><span class="main">)</span>
                  <span class="keyword3"><span class="command">case</span></span> Mul <span class="keyword1"><span class="command">note</span></span> ch <span class="main">=</span> this
                  <span class="keyword1"><span class="command">with</span></span> gh u ge2 tu' ngh cg ch <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mus</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                  <span class="keyword1"><span class="command">with</span></span> s u fh su' prc3 cf cg ch suA <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> wpo.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">u</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lex_ext_least_1<span class="main">)</span>
                <span class="keyword1"><span class="command">next</span></span>
                  <span class="keyword3"><span class="command">case</span></span> Lex <span class="keyword1"><span class="command">note</span></span> ch <span class="main">=</span> this
                  <span class="keyword1"><span class="command">from</span></span> st' ge1 s t fg nfg cf cg
                  <span class="keyword1"><span class="command">have</span></span> lex1<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>lex_ext wpo <span class="free">n</span> <span class="var">?mss</span> <span class="var">?mts</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prc<span class="main">)</span>
                  <span class="keyword1"><span class="command">from</span></span> tu' ge2 t u gh ngh cg ch
                  <span class="keyword1"><span class="command">have</span></span> lex2<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>lex_ext wpo <span class="free">n</span> <span class="var">?mts</span> <span class="var">?mus</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prc2<span class="main">)</span>
                  <span class="keyword1"><span class="command">from</span></span> lex1 lex2 lex_ext_compat<span class="main">[</span><span class="operator">OF</span> ind3'<span class="main">,</span> <span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?mss</span></span></span> <span class="var"><span class="quoted"><span class="var">?mts</span></span></span> <span class="var"><span class="quoted"><span class="var">?mus</span></span></span><span class="main">]</span>
                  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>lex_ext wpo <span class="free">n</span> <span class="var">?mss</span> <span class="var">?mus</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">with</span></span> fg gh su' s u fh cf cg ch suA <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> wpo.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">u</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prc3<span class="main">)</span>
                <span class="keyword1"><span class="command">qed</span></span>
              <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> wpo_s_imp_ns <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="WPO-subterm_wpo_s_arg"><span class="command">lemma</span></span> subterm_wpo_s_arg<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> set <span class="main">(</span>σ <span class="main">(</span><span class="free">f</span><span class="main">,</span>length <span class="free">ss</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Fun <span class="free">f</span> <span class="free">ss</span> <span class="main">≻</span> <span class="free">ss</span> <span class="main">!</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> refl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ss</span> <span class="main">!</span> <span class="free">i</span> <span class="main">≽</span> <span class="free">ss</span> <span class="main">!</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wpo_ns_refl<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> i <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">t</span> <span class="main">∈</span> set <span class="main">(</span>σ <span class="main">(</span><span class="free">f</span><span class="main">,</span>length <span class="free">ss</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="free">ss</span> <span class="main">!</span> <span class="free">i</span> <span class="main">≽</span> <span class="free">ss</span> <span class="main">!</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> NS_arg<span class="main">[</span><span class="operator">OF</span> i<span class="main">]</span> i
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wpo.simps<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="WPO-subterm_wpo_ns_arg"><span class="command">lemma</span></span> subterm_wpo_ns_arg<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> set <span class="main">(</span>σ <span class="main">(</span><span class="free">f</span><span class="main">,</span>length <span class="free">ss</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Fun <span class="free">f</span> <span class="free">ss</span> <span class="main">≽</span> <span class="free">ss</span> <span class="main">!</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wpo_s_imp_ns<span class="main"><span class="main">[</span></span><span class="operator">OF</span> subterm_wpo_s_arg<span class="main"><span class="main">[</span></span><span class="operator">OF</span> i<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="WPO-wpo_ns_pre_mono"><span class="command">lemma</span></span> wpo_ns_pre_mono<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">bef</span> <span class="free">aft</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span>term list"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">σf</span> <span class="main">≡</span> σ <span class="main">(</span><span class="free">f</span><span class="main">,</span> Suc <span class="main">(</span>length <span class="free">bef</span> <span class="main">+</span> length <span class="free">aft</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> rel<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>wpo_ns <span class="free">s</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">j</span><span class="main">∈</span>set <span class="free">σf</span><span class="main">.</span> Fun <span class="free">f</span> <span class="main">(</span><span class="free">bef</span> <span class="main">@</span> <span class="free">s</span> <span class="main">#</span> <span class="free">aft</span><span class="main">)</span> <span class="main">≻</span> <span class="main">(</span><span class="free">bef</span> <span class="main">@</span> <span class="free">t</span> <span class="main">#</span> <span class="free">aft</span><span class="main">)</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span>
    <span class="main">∧</span> <span class="main">(</span>Fun <span class="free">f</span> <span class="main">(</span><span class="free">bef</span> <span class="main">@</span> <span class="free">s</span> <span class="main">#</span> <span class="free">aft</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>Fun <span class="free">f</span> <span class="main">(</span><span class="free">bef</span> <span class="main">@</span> <span class="free">t</span> <span class="main">#</span> <span class="free">aft</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">NS</span>
    <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="free">σf</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="main">(</span><span class="free">bef</span> <span class="main">@</span> <span class="free">s</span> <span class="main">#</span> <span class="free">aft</span><span class="main">)</span><span class="main">)</span> <span class="free">σf</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">≽</span> <span class="main">(</span><span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="main">(</span><span class="free">bef</span> <span class="main">@</span> <span class="free">t</span> <span class="main">#</span> <span class="free">aft</span><span class="main">)</span><span class="main">)</span> <span class="free">σf</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">∧</span> <span class="main">_</span> <span class="main">∧</span> <span class="var">?three</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ss</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">bef</span> <span class="main">@</span> <span class="free">s</span> <span class="main">#</span> <span class="free">aft</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ts</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">bef</span> <span class="main">@</span> <span class="free">t</span> <span class="main">#</span> <span class="free">aft</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Fun <span class="free">f</span> <span class="var">?ss</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Fun <span class="free">f</span> <span class="var">?ts</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?len</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>length <span class="free">bef</span> <span class="main">+</span> length <span class="free">aft</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="var">?len</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?σ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"σ <span class="var">?f</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> wpo_ns_imp_NS<span class="main">[</span><span class="operator">OF</span> rel<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> stA<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">t</span><span class="main">)</span> <span class="main">∈</span> <span class="free">NS</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?three</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> σf_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="var">?σ</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">ss</span><span class="main">.</span> <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="bound">ss</span><span class="main">)</span> <span class="var">?σ</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="bound">ss</span> <span class="main">!</span> <span class="main">(</span><span class="var">?σ</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wpo_ns <span class="main">(</span><span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="var">?ss</span><span class="main">)</span> <span class="var">?σ</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="var">?ts</span><span class="main">)</span> <span class="var">?σ</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?σ</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> length <span class="free">bef</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> id <span class="keyword1"><span class="command">using</span></span> rel <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">from</span></span> append_Cons_nth_not_middle<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">aft</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">]</span> wpo_ns_refl 
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> id <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">j</span><span class="main">∈</span>set <span class="var">?σ</span><span class="main">.</span> wpo_s <span class="var">?s</span> <span class="main">(</span><span class="main">(</span><span class="free">bef</span> <span class="main">@</span> <span class="free">t</span> <span class="main">#</span> <span class="free">aft</span><span class="main">)</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?one</span></span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
    <span class="keyword3"><span class="command">assume</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> set <span class="var">?σ</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> set <span class="main">(</span>σ <span class="main">(</span><span class="free">f</span><span class="main">,</span>length <span class="var">?ss</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> subterm_wpo_s_arg<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"wpo_s <span class="var">?s</span> <span class="main">(</span><span class="var">?ss</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wpo_s <span class="var">?s</span> <span class="main">(</span><span class="var">?ts</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> length <span class="free">bef</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ss</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> <span class="var">?ts</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> append_Cons_nth_not_middle<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> s <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">with</span></span> s <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wpo_s <span class="var">?s</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> rel wpo_compat <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wpo_s <span class="var">?s</span> <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">with</span></span> True <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?three</span>›</span></span> ctxt_NS<span class="main">[</span><span class="operator">OF</span> stA<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> σf_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="WPO-wpo_ns_mono"><span class="command">lemma</span></span> wpo_ns_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> rel<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≽</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Fun <span class="free">f</span> <span class="main">(</span><span class="free">bef</span> <span class="main">@</span> <span class="free">s</span> <span class="main">#</span> <span class="free">aft</span><span class="main">)</span> <span class="main">≽</span> Fun <span class="free">f</span> <span class="main">(</span><span class="free">bef</span> <span class="main">@</span> <span class="free">t</span> <span class="main">#</span> <span class="free">aft</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ss</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">bef</span> <span class="main">@</span> <span class="free">s</span> <span class="main">#</span> <span class="free">aft</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ts</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">bef</span> <span class="main">@</span> <span class="free">t</span> <span class="main">#</span> <span class="free">aft</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Fun <span class="free">f</span> <span class="var">?ss</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Fun <span class="free">f</span> <span class="var">?ts</span>"</span></span>  
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?len</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>length <span class="free">bef</span> <span class="main">+</span> length <span class="free">aft</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="var">?len</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?σ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"σ <span class="var">?f</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> wpo_ns_pre_mono<span class="main">[</span><span class="operator">OF</span> rel<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">j</span><span class="main">∈</span>set <span class="var">?σ</span><span class="main">.</span> wpo_s <span class="var">?s</span> <span class="main">(</span><span class="main">(</span><span class="free">bef</span> <span class="main">@</span> <span class="free">t</span> <span class="main">#</span> <span class="free">aft</span><span class="main">)</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> True"</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="var">?s</span><span class="main">,</span><span class="var">?t</span><span class="main">)</span> <span class="main">∈</span> <span class="free">NS</span><span class="main">)</span> <span class="main">=</span> True"</span></span> 
    <span class="quoted"><span class="quoted">"length <span class="var">?ss</span> <span class="main">=</span> <span class="var">?len</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="var">?ts</span> <span class="main">=</span> <span class="var">?len</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>lex_ext wpo <span class="free">n</span> <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="var">?ss</span><span class="main">)</span> <span class="var">?σ</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="var">?ts</span><span class="main">)</span> <span class="var">?σ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> all_nstri_imp_lex_nstri<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> allI impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> wpo_ns_pre_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> rel<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>mul_ext wpo <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="var">?ss</span><span class="main">)</span> <span class="var">?σ</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="var">?ts</span><span class="main">)</span> <span class="var">?σ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> all_nstri_imp_mul_nstri<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> allI impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> wpo_ns_pre_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> rel<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> wpo.simps<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span><span class="main">]</span> term.simps id prc_refl
    <span class="keyword1"><span class="command">using</span></span> order_tag.exhaust <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="WPO-wpo_stable"><span class="command">lemma</span></span> wpo_stable<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">δ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span>subst"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span> <span class="main">≻</span> <span class="free">t</span> <span class="main">⟶</span> <span class="free">s</span> <span class="main">⋅</span> <span class="free">δ</span> <span class="main">≻</span> <span class="free">t</span> <span class="main">⋅</span> <span class="free">δ</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">s</span> <span class="main">≽</span> <span class="free">t</span> <span class="main">⟶</span> <span class="free">s</span> <span class="main">⋅</span> <span class="free">δ</span> <span class="main">≽</span> <span class="free">t</span> <span class="main">⋅</span> <span class="free">δ</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="free">s</span> <span class="free">t</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">t</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> wf_induct<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf_measure<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span> <span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">,</span></span><span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> size <span class="bound"><span class="bound">s</span></span> <span class="main"><span class="main">+</span></span> size <span class="bound"><span class="bound">t</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">s</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 1
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">s'</span> <span class="bound">t'</span><span class="main">.</span> size <span class="bound">s'</span> <span class="main">+</span> size <span class="bound">t'</span> <span class="main">&lt;</span> size <span class="skolem">s</span> <span class="main">+</span> size <span class="skolem">t</span> <span class="main">⟶</span> <span class="var">?p</span> <span class="bound">s'</span> <span class="bound">t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> this<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">⋅</span> <span class="free">δ</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">⋅</span> <span class="free">δ</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> simps <span class="main">=</span> wpo.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span> wpo.simps<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?case</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">∨</span> <span class="main">(</span><span class="var">?s</span><span class="main">,</span><span class="var">?t</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">t</span><span class="main">)</span> <span class="main">∉</span> <span class="free">NS</span> <span class="main">∨</span> <span class="main">¬</span> wpo_ns <span class="skolem">s</span> <span class="skolem">t</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">∨</span> <span class="main">(</span><span class="var">?s</span><span class="main">,</span><span class="var">?t</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> subst_S<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="free">δ</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?s</span><span class="main">,</span><span class="var">?t</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">from</span></span> S_imp_wpo_s<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wpo_s <span class="var">?s</span> <span class="var">?t</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">with</span></span> wpo_s_imp_ns<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">t</span><span class="main">)</span> <span class="main">∉</span> <span class="free">NS</span> <span class="main">∨</span> <span class="main">¬</span> wpo_ns <span class="skolem">s</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> wpo_ns_imp_NS <span class="keyword1"><span class="command">have</span></span> st<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> wpo_ns <span class="skolem">s</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> wpo_s_imp_ns <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> wpo_s <span class="skolem">s</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> st <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> not<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> False"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="var">?s</span><span class="main">,</span><span class="var">?t</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> False"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> stA<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> <span class="free">NS</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ns<span class="main">:</span> <span class="quoted"><span class="quoted">"wpo_ns <span class="skolem">s</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> subst_NS<span class="main">[</span><span class="operator">OF</span> stA<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> sstsA<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?s</span><span class="main">,</span><span class="var">?t</span><span class="main">)</span> <span class="main">∈</span> <span class="free">NS</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> stA sstsA <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> <span class="free">NS</span><span class="main">)</span> <span class="main">=</span> True"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="var">?s</span><span class="main">,</span><span class="var">?t</span><span class="main">)</span> <span class="main">∈</span> <span class="free">NS</span><span class="main">)</span> <span class="main">=</span> True"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">note</span></span> simps <span class="main">=</span> simps<span class="main">[</span><span class="operator">unfolded</span> id not if_False if_True<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> s <span class="main">=</span> this
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Var <span class="skolem">y</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> t <span class="main">=</span> this
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> simps<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> s t <span class="keyword1"><span class="command">using</span></span> wpo_ns_refl<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="skolem">y</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Fun <span class="skolem">g</span> <span class="skolem">ts</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> t <span class="main">=</span> this
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">g</span><span class="main">,</span>length <span class="skolem">ts</span><span class="main">)</span>"</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="skolem">x</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Var <span class="skolem">y</span><span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> simps <span class="keyword1"><span class="command">unfolding</span></span> s t <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Fun <span class="skolem">f</span> <span class="skolem">ss</span><span class="main">)</span>
          <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">f</span><span class="main">,</span> length <span class="skolem">ss</span><span class="main">)</span>"</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">prl</span> <span class="var">?g</span>"</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> simps <span class="keyword1"><span class="command">unfolding</span></span> s t Fun <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> True
            <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">ns</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">prc</span> <span class="var">?f</span> <span class="var">?g</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">ns</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
            <span class="keyword1"><span class="command">with</span></span> prl<span class="main">[</span><span class="operator">OF</span> True<span class="main">,</span> <span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> prc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">prc</span> <span class="var">?f</span> <span class="var">?g</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">s</span><span class="main">,</span> True<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> simps <span class="keyword1"><span class="command">unfolding</span></span> s t Fun 
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Fun prc mul_ext_def ns_mul_ext_bottom Let_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> all_nstri_imp_lex_nstri<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Fun <span class="skolem">f</span> <span class="skolem">ss</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> s <span class="main">=</span> this
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">f</span><span class="main">,</span>length <span class="skolem">ss</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ss</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>σ <span class="var">?f</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
        <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="var">?ss</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ns<span class="main">:</span> <span class="quoted"><span class="quoted">"wpo_ns <span class="main">(</span><span class="skolem">ss</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">t</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> IH<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span> σE<span class="main">[</span><span class="operator">OF</span> i<span class="main">]</span> ns <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wpo_ns <span class="main">(</span><span class="skolem">ss</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">⋅</span> <span class="free">δ</span><span class="main">)</span> <span class="var">?t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> s
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> size_simps<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wpo_s <span class="var">?s</span> <span class="var">?t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i sstsA σ<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">f</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">ss</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> simps <span class="keyword1"><span class="command">unfolding</span></span> s <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command">with</span></span> wpo_s_imp_ns<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> si_arg <span class="main">=</span> this        
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> t<span class="main">:</span> <span class="main">(</span>Var <span class="skolem">y</span><span class="main">)</span> 
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">∈</span><span class="var">?ss</span><span class="main">.</span> wpo_ns <span class="main">(</span><span class="skolem">ss</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">t</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span>
            <span class="keyword2"><span class="keyword">where</span></span> si<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="var">?ss</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ns<span class="main">:</span> <span class="quoted"><span class="quoted">"wpo_ns <span class="main">(</span><span class="skolem">ss</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">t</span>"</span></span> 
            <span class="keyword1"><span class="command">unfolding</span></span> s t <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">from</span></span> si_arg<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">with</span></span> ns<span class="main">[</span><span class="operator">unfolded</span> simps<span class="main">]</span> s t
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="free">ssimple</span></span> <span class="keyword2"><span class="keyword">and</span></span> largef<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">large</span> <span class="var">?f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
          <span class="keyword1"><span class="command">from</span></span> False s t not 
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> wpo_s <span class="skolem">s</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> wpo.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">moreover</span></span>          
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wpo_ns <span class="var">?s</span> <span class="var">?t</span>"</span></span> 
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="skolem">y</span>"</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Var <span class="skolem">z</span><span class="main">)</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> wpo.simps<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span><span class="main">]</span> not id 
              <span class="keyword1"><span class="command">unfolding</span></span> s t <span class="keyword1"><span class="command">using</span></span> Var <span class="quoted"><span class="quoted">`<span class="free">ssimple</span>`</span></span> largef <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Fun <span class="skolem">g</span> <span class="skolem">ts</span><span class="main">)</span>
            <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">g</span><span class="main">,</span>length <span class="skolem">ts</span><span class="main">)</span>"</span></span> 
            <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ps</span></span> <span class="skolem"><span class="skolem">pns</span></span> <span class="keyword2"><span class="keyword">where</span></span> prc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">prc</span> <span class="var">?f</span> <span class="var">?g</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">pns</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">prc</span> <span class="var">?f</span> <span class="var">?g</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
            <span class="keyword1"><span class="command">from</span></span> prc_stri_imp_nstri<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span><span class="main">]</span> prc <span class="keyword1"><span class="command">have</span></span> ps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ps</span> <span class="main">⟹</span> <span class="skolem">pns</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">{</span></span>
              <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> set <span class="main">(</span>σ <span class="var">?g</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">with</span></span> set_status_nth<span class="main">[</span><span class="operator">OF</span> refl this<span class="main">]</span> ss_status<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">`<span class="free">ssimple</span>`</span></span> this<span class="main">]</span> t Fun
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span> <span class="main">⋅</span> <span class="free">δ</span><span class="main">,</span> <span class="skolem">ts</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> simple_arg_pos_def<span class="main">)</span>
              <span class="keyword1"><span class="command">with</span></span> sstsA <span class="keyword1"><span class="command">have</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span> <span class="main">⋅</span> <span class="free">δ</span><span class="main">,</span> <span class="skolem">ts</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> compat_NS_S_point<span class="main">)</span>
              <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"wpo_s <span class="main">(</span><span class="skolem">s</span> <span class="main">⋅</span> <span class="free">δ</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ts</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> S_imp_wpo_s<span class="main">)</span>
            <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> ssimple <span class="main">=</span> this
            <span class="keyword1"><span class="command">from</span></span> large<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">`<span class="free">ssimple</span>`</span></span> largef<span class="main">,</span> <span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span><span class="main">,</span> <span class="operator">unfolded</span> prc<span class="main">]</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ps</span> <span class="main">∨</span> <span class="skolem">pns</span> <span class="main">∧</span>  σ <span class="var">?g</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
            <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> ssimple <span class="keyword1"><span class="command">unfolding</span></span> wpo.simps<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span><span class="main">]</span> not id 
              <span class="keyword1"><span class="command">unfolding</span></span> s t <span class="keyword1"><span class="command">using</span></span> Fun prc ps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lex_ext_least_1 mul_ext_def Let_def ns_mul_ext_bottom<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Fun <span class="skolem">g</span> <span class="skolem">ts</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> t <span class="main">=</span> this
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">g</span><span class="main">,</span>length <span class="skolem">ts</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ts</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>σ <span class="var">?g</span><span class="main">)</span>"</span></span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">prs</span></span> <span class="skolem"><span class="skolem">prns</span></span> <span class="keyword2"><span class="keyword">where</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">prc</span> <span class="var">?f</span> <span class="var">?g</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">prs</span><span class="main">,</span> <span class="skolem">prns</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command">note</span></span> ns <span class="main">=</span> ns<span class="main">[</span><span class="operator">unfolded</span> simps<span class="main">,</span> <span class="operator">unfolded</span> s t p term.simps split<span class="main">]</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">i</span> <span class="main">∈</span> <span class="var">?ss</span><span class="main">.</span> wpo_ns <span class="main">(</span><span class="skolem">ss</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">t</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">with</span></span> si_arg <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span> <span class="bound">i</span> <span class="main">∈</span> <span class="var">?ss</span><span class="main">.</span> wpo_ns <span class="main">(</span><span class="skolem">ss</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>Fun <span class="skolem">g</span> <span class="skolem">ts</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> False"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> t <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">note</span></span> ns <span class="main">=</span> ns<span class="main">[</span><span class="operator">unfolded</span> this if_False<span class="main">]</span>
          <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mss</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span> <span class="bound">s</span> <span class="main">.</span> <span class="bound">s</span> <span class="main">⋅</span> <span class="free">δ</span><span class="main">)</span> <span class="skolem">ss</span>"</span></span>
          <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mts</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span> <span class="bound">t</span> <span class="main">.</span> <span class="bound">t</span> <span class="main">⋅</span> <span class="free">δ</span><span class="main">)</span> <span class="skolem">ts</span>"</span></span>
          <span class="keyword1"><span class="command">from</span></span> ns <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="skolem">prns</span></span> <span class="keyword2"><span class="keyword">and</span></span> s_tj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">∈</span> <span class="var">?ts</span> <span class="main">⟹</span> wpo_s <span class="main">(</span>Fun <span class="skolem">f</span> <span class="skolem">ss</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ts</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span>"</span></span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
          <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
            <span class="keyword3"><span class="command">assume</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="var">?ts</span>"</span></span>
            <span class="keyword1"><span class="command">from</span></span> σE<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size <span class="skolem">s</span> <span class="main">+</span> size <span class="main">(</span><span class="skolem">ts</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">&lt;</span> size <span class="skolem">s</span> <span class="main">+</span> size <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> t <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> size_simps<span class="main">)</span>
            <span class="keyword1"><span class="command">from</span></span> IH<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> s_tj<span class="main">[</span><span class="operator">OF</span> j<span class="main">,</span> <span class="operator">folded</span> s<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> wpo<span class="main">:</span> <span class="quoted"><span class="quoted">"wpo_s <span class="var">?s</span> <span class="main">(</span><span class="skolem">ts</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">⋅</span> <span class="free">δ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">from</span></span> j σ<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">g</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">ts</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="skolem">ts</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">with</span></span> wpo <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wpo_s <span class="var">?s</span> <span class="main">(</span><span class="var">?mts</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> ss_ts <span class="main">=</span> this
          <span class="keyword1"><span class="command">note</span></span> σE <span class="main">=</span> σE<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">f</span></span> <span class="quoted"><span class="skolem">ss</span></span><span class="main">]</span> σE<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">g</span></span> <span class="quoted"><span class="skolem">ts</span></span><span class="main">]</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">prs</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> True
            <span class="keyword1"><span class="command">with</span></span> ss_ts sstsA p <span class="quoted"><span class="quoted">‹<span class="skolem">prns</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wpo_s <span class="var">?s</span> <span class="var">?t</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> simps <span class="keyword1"><span class="command">unfolding</span></span> s t 
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
            <span class="keyword1"><span class="command">with</span></span> wpo_s_imp_ns<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> False
            <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mmss</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">(!)</span> <span class="skolem">ss</span><span class="main">)</span> <span class="main">(</span>σ <span class="var">?f</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mmts</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">(!)</span> <span class="skolem">ts</span><span class="main">)</span> <span class="main">(</span>σ <span class="var">?g</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Mmss</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">(!)</span> <span class="var">?mss</span><span class="main">)</span> <span class="main">(</span>σ <span class="var">?f</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Mmts</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">(!)</span> <span class="var">?mts</span><span class="main">)</span> <span class="main">(</span>σ <span class="var">?g</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">have</span></span> id_map<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?Mmss</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">⋅</span> <span class="free">δ</span><span class="main">)</span> <span class="var">?mmss</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Mmts</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">⋅</span> <span class="free">δ</span><span class="main">)</span> <span class="var">?mmts</span>"</span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> map_map o_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_status_nth<span class="main">)</span>
            <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ls</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>σ <span class="var">?f</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?lt</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>σ <span class="var">?g</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">{</span></span>
              <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">si</span> <span class="skolem">tj</span>
              <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">si</span> <span class="main">∈</span> set <span class="var">?mmss</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tj</span> <span class="main">∈</span> set <span class="var">?mmts</span>"</span></span> 
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>wpo_s <span class="skolem">si</span> <span class="skolem">tj</span> <span class="main">⟶</span> wpo_s <span class="main">(</span><span class="skolem">si</span> <span class="main">⋅</span> <span class="free">δ</span><span class="main">)</span> <span class="main">(</span><span class="skolem">tj</span> <span class="main">⋅</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>wpo_ns <span class="skolem">si</span> <span class="skolem">tj</span> <span class="main">⟶</span> wpo_ns <span class="main">(</span><span class="skolem">si</span> <span class="main">⋅</span> <span class="free">δ</span><span class="main">)</span> <span class="main">(</span><span class="skolem">tj</span> <span class="main">⋅</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span>"</span></span> 
              <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> IH add_strict_mono<span class="main">)</span>
                <span class="keyword1"><span class="command">from</span></span> *<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">si</span> <span class="main">∈</span> set <span class="skolem">ss</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> set_status_nth<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="free">σσ</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"size <span class="skolem">si</span> <span class="main">&lt;</span> size <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> s <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">termination_simp</span></span><span class="main">)</span>
                <span class="keyword1"><span class="command">from</span></span> *<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tj</span> <span class="main">∈</span> set <span class="skolem">ts</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> set_status_nth<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="free">σσ</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"size <span class="skolem">tj</span> <span class="main">&lt;</span> size <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> t <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">termination_simp</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command">qed</span></span>
              <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"wpo_s <span class="skolem">si</span> <span class="skolem">tj</span> <span class="main">⟹</span> wpo_s <span class="main">(</span><span class="skolem">si</span> <span class="main">⋅</span> <span class="free">δ</span><span class="main">)</span> <span class="main">(</span><span class="skolem">tj</span> <span class="main">⋅</span> <span class="free">δ</span><span class="main">)</span>"</span></span>
                <span class="quoted"><span class="quoted">"wpo_ns <span class="skolem">si</span> <span class="skolem">tj</span> <span class="main">⟹</span> wpo_ns <span class="main">(</span><span class="skolem">si</span> <span class="main">⋅</span> <span class="free">δ</span><span class="main">)</span> <span class="main">(</span><span class="skolem">tj</span> <span class="main">⋅</span> <span class="free">δ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
            <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> IH' <span class="main">=</span> this
            <span class="keyword1"><span class="command">{</span></span>
              <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> 
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="var">?ls</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="var">?lt</span>"</span></span> 
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> i_f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>σ <span class="var">?f</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i_g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>σ <span class="var">?g</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">with</span></span> σ<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">f</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">ss</span>"</span></span><span class="main">]</span> σ<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">g</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">ts</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"σ <span class="var">?f</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">ss</span>"</span></span> <span class="quoted"><span class="quoted">"σ <span class="var">?g</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">ts</span>"</span></span> 
                <span class="keyword1"><span class="command">unfolding</span></span> set_conv_nth <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size <span class="main">(</span><span class="skolem">ss</span> <span class="main">!</span> <span class="main">(</span>σ <span class="var">?f</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> size <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"size <span class="main">(</span><span class="skolem">ts</span> <span class="main">!</span> <span class="main">(</span>σ <span class="var">?g</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> size <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> s t <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> size_simps<span class="main">)</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size <span class="main">(</span><span class="skolem">ss</span> <span class="main">!</span> <span class="main">(</span>σ <span class="var">?f</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> size <span class="main">(</span><span class="skolem">ts</span> <span class="main">!</span> <span class="main">(</span>σ <span class="var">?g</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> size <span class="skolem">s</span> <span class="main">+</span> size <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command">from</span></span> IH<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> i i_f i_g
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>wpo_s <span class="main">(</span><span class="var">?mmss</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="var">?mmts</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">⟹</span>
                     wpo_s <span class="main">(</span><span class="var">?mss</span> <span class="main">!</span> <span class="main">(</span>σ <span class="var">?f</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="var">?mts</span> <span class="main">!</span> <span class="main">(</span>σ <span class="var">?g</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
                <span class="quoted"><span class="quoted">"<span class="main">(</span>wpo_ns <span class="main">(</span><span class="var">?mmss</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="var">?mmts</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">⟹</span>
                     wpo_ns <span class="main">(</span><span class="var">?mss</span> <span class="main">!</span> <span class="main">(</span>σ <span class="var">?f</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="var">?mts</span> <span class="main">!</span> <span class="main">(</span>σ <span class="var">?g</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> this
            <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>Lex<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="var">?f</span> <span class="main">=</span> Lex"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="var">?g</span> <span class="main">=</span> Lex"</span></span> <span class="main">|</span> <span class="main">(</span>Mul<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="var">?f</span> <span class="main">=</span> Mul"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="var">?g</span> <span class="main">=</span> Mul"</span></span> <span class="main">|</span> <span class="main">(</span>Diff<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="var">?f</span> <span class="main">≠</span> <span class="free">c</span> <span class="var">?g</span>"</span></span> 
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="var">?f</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="var">?g</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
            <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
              <span class="keyword3"><span class="command">case</span></span> Lex
              <span class="keyword1"><span class="command">from</span></span> Lex False ns <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>lex_ext wpo <span class="free">n</span> <span class="var">?mmss</span> <span class="var">?mmts</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
              <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">unfolded</span> lex_ext_iff snd_conv<span class="main">]</span>
              <span class="keyword1"><span class="command">have</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?ls</span> <span class="main">=</span> <span class="var">?lt</span> <span class="main">∨</span> <span class="var">?lt</span> <span class="main">≤</span> <span class="free">n</span><span class="main">)</span>"</span></span>
                <span class="keyword2"><span class="keyword">and</span></span> choice<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span> <span class="var">?ls</span><span class="main">.</span>
               <span class="bound">i</span> <span class="main">&lt;</span> <span class="var">?lt</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span><span class="bound">i</span><span class="main">.</span> wpo_ns <span class="main">(</span><span class="var">?mmss</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">(</span><span class="var">?mmts</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> wpo_s <span class="main">(</span><span class="var">?mmss</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="var">?mmts</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span>
               <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span> <span class="var">?lt</span><span class="main">.</span> wpo_ns <span class="main">(</span><span class="var">?mmss</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="var">?mmts</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="var">?lt</span> <span class="main">≤</span> <span class="var">?ls</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?stri</span> <span class="main">∨</span> <span class="var">?nstri</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">from</span></span> choice <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?stri</span> <span class="main">∨</span> <span class="main">(</span><span class="main">¬</span> <span class="var">?stri</span> <span class="main">∧</span> <span class="var">?nstri</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">proof</span></span>
                <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?stri</span></span></span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="var">?ls</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="var">?lt</span>"</span></span>
                  <span class="keyword2"><span class="keyword">and</span></span> NS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span><span class="skolem">i</span><span class="main">.</span> wpo_ns <span class="main">(</span><span class="var">?mmss</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">(</span><span class="var">?mmts</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"wpo_s <span class="main">(</span><span class="var">?mmss</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="var">?mmts</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">with</span></span> IH <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span><span class="skolem">i</span><span class="main">.</span> wpo_ns <span class="main">(</span><span class="var">?Mmss</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">(</span><span class="var">?Mmts</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"wpo_s <span class="main">(</span><span class="var">?Mmss</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="var">?Mmts</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">with</span></span> i len <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>lex_ext wpo <span class="free">n</span> <span class="var">?Mmss</span> <span class="var">?Mmts</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lex_ext_iff
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">with</span></span> Lex ss_ts sstsA p <span class="quoted"><span class="quoted">‹<span class="skolem">prns</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wpo_s <span class="var">?s</span> <span class="var">?t</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> simps <span class="keyword1"><span class="command">unfolding</span></span> s t 
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
                <span class="keyword1"><span class="command">with</span></span> wpo_s_imp_ns<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
              <span class="keyword1"><span class="command">next</span></span>
                <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?stri</span> <span class="main">∧</span> <span class="var">?nstri</span>"</span></span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?nstri</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> nstri<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?stri</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
                <span class="keyword1"><span class="command">with</span></span> IH <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span> <span class="var">?lt</span><span class="main">.</span> wpo_ns <span class="main">(</span><span class="var">?Mmss</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="var">?Mmts</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="var">?lt</span> <span class="main">≤</span> <span class="var">?ls</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">with</span></span> len <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>lex_ext wpo <span class="free">n</span> <span class="var">?Mmss</span> <span class="var">?Mmts</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lex_ext_iff
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">with</span></span> Lex ss_ts sstsA p <span class="quoted"><span class="quoted">‹<span class="skolem">prns</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> ns<span class="main">:</span> <span class="quoted"><span class="quoted">"wpo_ns <span class="var">?s</span> <span class="var">?t</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> simps <span class="keyword1"><span class="command">unfolding</span></span> s t 
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
                <span class="keyword1"><span class="command">{</span></span>
                  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"wpo_s <span class="skolem">s</span> <span class="skolem">t</span>"</span></span>
                  <span class="keyword1"><span class="command">from</span></span> Lex this<span class="main">[</span><span class="operator">unfolded</span> simps<span class="main">,</span> <span class="operator">unfolded</span> s t term.simps p split id<span class="main">]</span> False
                  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>lex_ext wpo <span class="free">n</span> <span class="var">?mmss</span> <span class="var">?mmts</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
                  <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">unfolded</span> lex_ext_iff fst_conv<span class="main">]</span> nstri
                  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span> <span class="var">?lt</span><span class="main">.</span> wpo_ns <span class="main">(</span><span class="var">?mmss</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="var">?mmts</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="var">?lt</span> <span class="main">&lt;</span> <span class="var">?ls</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">with</span></span> IH <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span> <span class="var">?lt</span><span class="main">.</span> wpo_ns <span class="main">(</span><span class="var">?Mmss</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="var">?Mmts</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="var">?lt</span> <span class="main">&lt;</span> <span class="var">?ls</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>lex_ext wpo <span class="free">n</span> <span class="var">?Mmss</span> <span class="var">?Mmts</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> len <span class="keyword1"><span class="command">unfolding</span></span> lex_ext_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">with</span></span> Lex ss_ts sstsA p <span class="quoted"><span class="quoted">‹<span class="skolem">prns</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> ns<span class="main">:</span> <span class="quoted"><span class="quoted">"wpo_s <span class="var">?s</span> <span class="var">?t</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> simps <span class="keyword1"><span class="command">unfolding</span></span> s t 
                    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
                <span class="keyword1"><span class="command">}</span></span>
                <span class="keyword1"><span class="command">with</span></span> ns <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
              <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">case</span></span> Diff
              <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> ns ss_ts sstsA p <span class="quoted"><span class="quoted">‹<span class="skolem">prns</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> simps <span class="keyword1"><span class="command">unfolding</span></span> s t
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">case</span></span> Mul
              <span class="keyword1"><span class="command">from</span></span> Mul False ns <span class="keyword1"><span class="command">have</span></span> ge<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>mul_ext wpo <span class="var">?mmss</span> <span class="var">?mmts</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
              <span class="keyword1"><span class="command">have</span></span> ge<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>mul_ext wpo <span class="var">?Mmss</span> <span class="var">?Mmts</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> id_map
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> nstri_mul_ext_map<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ ge<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">intro</span> IH'<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command">{</span></span>
                <span class="keyword3"><span class="command">assume</span></span> gr<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>mul_ext wpo <span class="var">?mmss</span> <span class="var">?mmts</span><span class="main">)</span>"</span></span> 
                <span class="keyword1"><span class="command">have</span></span> grσ<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>mul_ext wpo <span class="var">?Mmss</span> <span class="var">?Mmts</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> id_map
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> stri_mul_ext_map<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ gr<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">intro</span> IH'<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> gr <span class="main">=</span> this
              <span class="keyword1"><span class="command">from</span></span> ge gr
              <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
                <span class="keyword1"><span class="command">using</span></span> ss_ts <span class="quoted"><span class="quoted">‹<span class="skolem">prns</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> simps 
                <span class="keyword1"><span class="command">unfolding</span></span> s t term.simps p split subst_apply_term.simps length_map Mul
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> id_map id<span class="main">)</span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="WPO-WPO_S_SN"><span class="command">lemma</span></span> WPO_S_SN<span class="main">:</span> <span class="quoted"><span class="quoted">"SN WPO_S"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span>term"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?S</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> SN_on WPO_S <span class="main">{</span><span class="bound">x</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">note</span></span> iff <span class="main">=</span> SN_on_all_reducts_SN_on_conv<span class="main">[</span><span class="operator">of</span> <span class="quoted">WPO_S</span><span class="main">]</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Var <span class="skolem">x</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Var <span class="skolem">x</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">∈</span> WPO_S"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wpo.simps<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> var_SN <span class="main">=</span> this
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> var_SN<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Fun <span class="skolem">f</span> <span class="skolem">ts</span><span class="main">)</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Slist</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">f</span> <span class="bound">ys</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>σ <span class="bound">f</span><span class="main">)</span><span class="main">.</span> <span class="var">?S</span> <span class="main">(</span><span class="bound">ys</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r3</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">ab</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">g</span><span class="main">,</span><span class="bound">ab'</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="free">c</span> <span class="bound">f</span> <span class="main">=</span> <span class="free">c</span> <span class="bound">g</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="var">?Slist</span> <span class="bound">f</span> <span class="bound">ab</span> <span class="main">∧</span> 
          <span class="main">(</span><span class="free">c</span> <span class="bound">f</span> <span class="main">=</span> Mul <span class="main">⟶</span> fst <span class="main">(</span>mul_ext wpo <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="bound">ab</span><span class="main">)</span> <span class="main">(</span>σ <span class="bound">f</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="bound">ab'</span><span class="main">)</span> <span class="main">(</span>σ <span class="bound">g</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
          <span class="main">(</span><span class="free">c</span> <span class="bound">f</span> <span class="main">=</span> Lex <span class="main">⟶</span> fst <span class="main">(</span>lex_ext wpo <span class="free">n</span> <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="bound">ab</span><span class="main">)</span> <span class="main">(</span>σ <span class="bound">f</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="bound">ab'</span><span class="main">)</span> <span class="main">(</span>σ <span class="bound">g</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
       <span class="main">∧</span> <span class="main">(</span><span class="main">(</span><span class="free">c</span> <span class="bound">f</span> <span class="main">≠</span> <span class="free">c</span> <span class="bound">g</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="bound">ab</span><span class="main">)</span> <span class="main">(</span>σ <span class="bound">f</span><span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="bound">ab'</span><span class="main">)</span> <span class="main">(</span>σ <span class="bound">g</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r0</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"lex_two <span class="main">{</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">g</span><span class="main">)</span><span class="main">.</span> fst <span class="main">(</span><span class="free">prc</span> <span class="bound">f</span> <span class="bound">g</span><span class="main">)</span><span class="main">}</span> <span class="main">{</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">g</span><span class="main">)</span><span class="main">.</span> snd <span class="main">(</span><span class="free">prc</span> <span class="bound">f</span> <span class="bound">g</span><span class="main">)</span><span class="main">}</span> <span class="var">?r3</span>"</span></span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ab</span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">S</span><span class="main">.</span> <span class="bound">S</span> <span class="main">0</span> <span class="main">=</span> <span class="skolem">ab</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="bound">S</span> <span class="bound">i</span><span class="main">,</span> <span class="bound">S</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?r3</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span>
            S0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">0</span> <span class="main">=</span> <span class="skolem">ab</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
            SS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="skolem">S</span> <span class="bound">i</span><span class="main">,</span> <span class="skolem">S</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?r3</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Sf</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> fst <span class="main">(</span>fst <span class="main">(</span><span class="skolem">S</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Sn</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> snd <span class="main">(</span>fst <span class="main">(</span><span class="skolem">S</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Sfn</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> fst <span class="main">(</span><span class="skolem">S</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Sts</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> snd <span class="main">(</span><span class="skolem">S</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Stsσ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> map <span class="main">(</span><span class="main">(!)</span> <span class="main">(</span><span class="var">?Sts</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>σ <span class="main">(</span><span class="var">?Sfn</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="free">c</span> <span class="main">(</span><span class="var">?Sfn</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> Mul"</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> True
            <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">ys</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">g</span><span class="main">,</span><span class="bound">xs</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
                <span class="main">(</span><span class="main">∀</span> <span class="bound">yi</span> <span class="main">∈</span>set <span class="main">(</span><span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">(</span>σ <span class="bound">f</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> SN_on WPO_S <span class="main">{</span><span class="bound">yi</span><span class="main">}</span><span class="main">)</span>
                <span class="main">∧</span> fst <span class="main">(</span>mul_ext wpo <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">(</span>σ <span class="bound">f</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="bound">xs</span><span class="main">)</span> <span class="main">(</span>σ <span class="bound">g</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">{</span></span>
              <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
              <span class="keyword1"><span class="command">from</span></span> True<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> True<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span>"</span></span><span class="main">]</span>
                <span class="keyword2"><span class="keyword">and</span></span> SS<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">S</span> <span class="skolem">i</span><span class="main">,</span> <span class="skolem">S</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?r'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">}</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> Hf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> SN_on <span class="var">?r'</span> <span class="main">{</span><span class="skolem">S</span> <span class="main">0</span><span class="main">}</span>"</span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> SN_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">from</span></span> mul_ext_SN<span class="main">[</span><span class="operator">of</span> <span class="quoted">wpo</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> wpo_ns_refl<span class="main">]</span>
              <span class="keyword2"><span class="keyword">and</span></span> wpo_compat wpo_s_imp_ns
            <span class="keyword1"><span class="command">have</span></span> tmp<span class="main">:</span> <span class="quoted"><span class="quoted">"SN <span class="main">{</span><span class="main">(</span><span class="bound">ys</span><span class="main">,</span> <span class="bound">xs</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span><span class="main">∈</span>set <span class="bound">ys</span><span class="main">.</span> SN_on <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> wpo_s <span class="bound">s</span> <span class="bound">t</span><span class="main">}</span> <span class="main">{</span><span class="bound">y</span><span class="main">}</span><span class="main">)</span> <span class="main">∧</span> fst <span class="main">(</span>mul_ext wpo <span class="bound">ys</span> <span class="bound">xs</span><span class="main">)</span><span class="main">}</span>"</span></span> 
              <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"SN <span class="var">?R</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?r'</span> <span class="main">=</span> inv_image <span class="var">?R</span> <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">ys</span><span class="main">)</span><span class="main">.</span> map <span class="main">(</span><span class="main">(!)</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">(</span>σ <span class="bound">f</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">from</span></span> SN_inv_image<span class="main">[</span><span class="operator">OF</span> tmp<span class="main">]</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"SN <span class="var">?r'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> id <span class="keyword1"><span class="command">.</span></span> 
            <span class="keyword1"><span class="command">from</span></span> SN_on_subset2<span class="main">[</span><span class="operator">OF</span> subset_UNIV<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">S</span> <span class="main">0</span><span class="main">}</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">OF</span> this<span class="main">]</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"SN_on <span class="var">?r'</span> <span class="main">{</span><span class="main">(</span><span class="skolem">S</span> <span class="main">0</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
            <span class="keyword1"><span class="command">with</span></span> Hf <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">note</span></span> HMul <span class="main">=</span> this
            <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="free">c</span> <span class="main">(</span><span class="var">?Sfn</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> Lex"</span></span><span class="main">)</span>
              <span class="keyword3"><span class="command">case</span></span> True
              <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">ys</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">g</span><span class="main">,</span><span class="bound">xs</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
                <span class="main">(</span><span class="main">∀</span> <span class="bound">yi</span> <span class="main">∈</span>set <span class="main">(</span><span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">(</span>σ <span class="bound">f</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> SN_on WPO_S <span class="main">{</span><span class="bound">yi</span><span class="main">}</span><span class="main">)</span>
                <span class="main">∧</span> fst <span class="main">(</span>lex_ext wpo <span class="free">n</span> <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">(</span>σ <span class="bound">f</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="bound">xs</span><span class="main">)</span> <span class="main">(</span>σ <span class="bound">g</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
              <span class="keyword1"><span class="command">{</span></span>
                <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
                <span class="keyword1"><span class="command">from</span></span> SS<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> True<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> True<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span>"</span></span><span class="main">]</span>
                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">S</span> <span class="skolem">i</span><span class="main">,</span> <span class="skolem">S</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?r'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">}</span></span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> Hf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> SN_on <span class="var">?r'</span> <span class="main">{</span><span class="skolem">S</span> <span class="main">0</span><span class="main">}</span>"</span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> SN_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">from</span></span> wpo_compat <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> wpo_ns <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟹</span> wpo_s <span class="bound">y</span> <span class="bound">z</span> <span class="main">⟹</span> wpo_s <span class="bound">x</span> <span class="bound">z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
              <span class="keyword1"><span class="command">from</span></span> lex_ext_SN<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"wpo"</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">,</span> <span class="operator">OF</span> this<span class="main">]</span> 
              <span class="keyword1"><span class="command">have</span></span> tmp<span class="main">:</span> <span class="quoted"><span class="quoted">"SN <span class="main">{</span><span class="main">(</span><span class="bound">ys</span><span class="main">,</span> <span class="bound">xs</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span><span class="main">∈</span>set <span class="bound">ys</span><span class="main">.</span> SN_on WPO_S <span class="main">{</span><span class="bound">y</span><span class="main">}</span><span class="main">)</span> <span class="main">∧</span> fst <span class="main">(</span>lex_ext wpo <span class="free">n</span> <span class="bound">ys</span> <span class="bound">xs</span><span class="main">)</span><span class="main">}</span>"</span></span> 
                <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"SN <span class="var">?R</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">.</span></span>
              <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?r'</span> <span class="main">=</span> inv_image <span class="var">?R</span> <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">ys</span><span class="main">)</span><span class="main">.</span> map <span class="main">(</span><span class="main">(!)</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">(</span>σ <span class="bound">f</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">from</span></span> SN_inv_image<span class="main">[</span><span class="operator">OF</span> tmp<span class="main">]</span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"SN <span class="var">?r'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> id <span class="keyword1"><span class="command">.</span></span> 
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"SN_on <span class="var">?r'</span> <span class="main">{</span><span class="main">(</span><span class="skolem">S</span> <span class="main">0</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> SN_defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
              <span class="keyword1"><span class="command">with</span></span> Hf <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">..</span></span> 
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">note</span></span> HLex <span class="main">=</span> this
              <span class="keyword1"><span class="command">from</span></span> HMul <span class="keyword2"><span class="keyword">and</span></span> HLex
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="free">c</span> <span class="main">(</span><span class="var">?Sfn</span> <span class="bound">i</span><span class="main">)</span> <span class="main">≠</span> <span class="free">c</span> <span class="main">(</span><span class="var">?Sfn</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
                <span class="keyword3"><span class="command">case</span></span> False
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> T<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="free">c</span> <span class="main">(</span><span class="var">?Sfn</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">c</span> <span class="main">(</span><span class="var">?Sfn</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                <span class="keyword1"><span class="command">{</span></span>
                  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
                  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">(</span><span class="var">?Sfn</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">c</span> <span class="main">(</span><span class="var">?Sfn</span> <span class="main">0</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
                    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> T<span class="main"><span class="main">[</span></span><span class="operator">rule_format</span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="skolem">j</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
                  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
                <span class="keyword1"><span class="command">}</span></span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> HMul HLex
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">(</span><span class="var">?Sfn</span> <span class="main">0</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">qed</span></span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span>
                Hdiff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">(</span><span class="var">?Sfn</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">≠</span> <span class="free">c</span> <span class="main">(</span><span class="var">?Sfn</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">from</span></span> Hdiff <span class="keyword1"><span class="command">have</span></span> Hf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?Stsσ</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> SS<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">(</span><span class="var">?Sfn</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">c</span> <span class="main">(</span><span class="var">?Sfn</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>
                <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Hf <span class="keyword2"><span class="keyword">and</span></span> SS<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">next</span></span>
                <span class="keyword3"><span class="command">case</span></span> True
                <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">(</span><span class="var">?Sfn</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>
                  <span class="keyword3"><span class="command">case</span></span> Mul
                  <span class="keyword1"><span class="command">with</span></span> True <span class="keyword2"><span class="keyword">and</span></span> SS<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span>"</span></span><span class="main">]</span>
                  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>mul_ext wpo <span class="main">(</span><span class="var">?Stsσ</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="var">?Stsσ</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
                    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">with</span></span> Hf <span class="keyword2"><span class="keyword">and</span></span> s_mul_ext_bottom_strict <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def mul_ext_def s_mul_ext_bottom_strict<span class="main">)</span>
                <span class="keyword1"><span class="command">next</span></span>
                  <span class="keyword3"><span class="command">case</span></span> Lex
                  <span class="keyword1"><span class="command">with</span></span> True <span class="keyword2"><span class="keyword">and</span></span> SS<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span>"</span></span><span class="main">]</span>
                  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>lex_ext wpo <span class="free">n</span> <span class="main">(</span><span class="var">?Stsσ</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="var">?Stsσ</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
                    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">with</span></span> Hf <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lex_ext_iff<span class="main">)</span>
                <span class="keyword1"><span class="command">qed</span></span>
              <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"SN <span class="var">?r3</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> SN_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> SN1<span class="main">:</span><span class="quoted"><span class="quoted">"SN <span class="var">?r0</span>"</span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> lex_two<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ prc_SN <span class="quoted"><span class="quoted">‹SN <span class="var">?r3</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">g</span><span class="main">)</span><span class="main">.</span> fst <span class="main">(</span><span class="free">prc</span> <span class="bound">f</span> <span class="bound">g</span><span class="main">)</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">g</span><span class="main">)</span><span class="main">.</span> snd <span class="main">(</span><span class="free">prc</span> <span class="bound">f</span> <span class="bound">g</span><span class="main">)</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a1</span> <span class="skolem">a2</span> <span class="skolem">a3</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a1</span><span class="main">,</span><span class="skolem">a2</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a2</span><span class="main">,</span><span class="skolem">a3</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?r'</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a1</span><span class="main">,</span><span class="skolem">a3</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?r'</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">prc</span> <span class="skolem">a1</span> <span class="skolem">a2</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">prc</span> <span class="skolem">a2</span> <span class="skolem">a3</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">prc</span> <span class="skolem">a1</span> <span class="skolem">a3</span>"</span></span><span class="main"><span class="keyword3">,</span></span> 
                <span class="operator">insert</span> prc_compat<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">a1</span></span></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">a2</span></span></span></span></span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">a3</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="keyword1">O</span> <span class="var">?r'</span> <span class="main">⊆</span> <span class="var">?r'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?m</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">ts</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span>length <span class="bound">ts</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span> length <span class="bound">ts</span><span class="main">)</span><span class="main">,</span> <span class="bound">ts</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="var">?m</span> <span class="bound">a</span><span class="main">,</span> <span class="var">?m</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?r0</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> SN_r<span class="main">:</span> <span class="quoted"><span class="quoted">"SN <span class="var">?r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> SN_inv_image<span class="main">[</span><span class="operator">OF</span> SN1<span class="main">,</span> <span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?m</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> inv_image_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?SA</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?NSA</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">NS</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?rr</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"lex_two <span class="free">S</span> <span class="free">NS</span> <span class="var">?r</span>"</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">rr</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rr</span> <span class="main">=</span> <span class="var">?rr</span>"</span></span> 
      <span class="keyword1"><span class="command">from</span></span> lex_two<span class="main">[</span><span class="operator">OF</span> compat_NS_S SN SN_r<span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> SN_rr<span class="main">:</span> <span class="quoted"><span class="quoted">"SN <span class="skolem">rr</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> rr_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?rrr</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"inv_image <span class="skolem">rr</span> <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">ts</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>Fun <span class="bound">f</span> <span class="bound">ts</span><span class="main">,</span> <span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">ts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> SN_rrr<span class="main">:</span> <span class="quoted"><span class="quoted">"SN <span class="var">?rrr</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> SN_inv_image<span class="main"><span class="main">[</span></span><span class="operator">OF</span> SN_rr<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ind</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">ts</span><span class="main">)</span><span class="main">.</span> <span class="var">?Slist</span> <span class="main">(</span><span class="bound">f</span><span class="main">,</span>length <span class="bound">ts</span><span class="main">)</span> <span class="bound">ts</span> <span class="main">⟶</span> <span class="var">?S</span> <span class="main">(</span>Fun <span class="bound">f</span> <span class="bound">ts</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ind</span> <span class="main">(</span><span class="skolem">f</span><span class="main">,</span><span class="skolem">ts</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> SN_induct<span class="main"><span class="main">[</span></span><span class="operator">OF</span> SN_rrr<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?ind</span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">fts</span>
        <span class="keyword3"><span class="command">assume</span></span> ind<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">gss</span><span class="main">.</span> <span class="main">(</span><span class="skolem">fts</span><span class="main">,</span><span class="bound">gss</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?rrr</span> <span class="main">⟹</span> <span class="var">?ind</span> <span class="bound">gss</span>"</span></span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="skolem"><span class="skolem">ts</span></span> <span class="keyword2"><span class="keyword">where</span></span> Pair<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">fts</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">f</span><span class="main">,</span><span class="skolem">ts</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">f</span><span class="main">,</span>length <span class="skolem">ts</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">note</span></span> ind <span class="main">=</span> ind<span class="main">[</span><span class="operator">unfolded</span> Pair<span class="main">]</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ind</span> <span class="skolem">fts</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Pair split
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> impI<span class="main">)</span>
          <span class="keyword3"><span class="command">assume</span></span> ts<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?Slist</span> <span class="var">?f</span> <span class="skolem">ts</span>"</span></span>
          <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Fun <span class="skolem">f</span> <span class="skolem">ts</span>"</span></span>	
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="var">?t</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> iff<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> allI impI<span class="main">)</span>
            <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?t</span><span class="main">,</span><span class="skolem">s</span><span class="main">)</span> <span class="main">∈</span> WPO_S"</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?t</span> <span class="main">≻</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="skolem">s</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">s</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> var_SN<span class="main">)</span>
              <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Fun <span class="skolem">g</span> <span class="skolem">ss</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> this
              <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Fun <span class="skolem">g</span> <span class="skolem">ss</span>"</span></span>
              <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">g</span><span class="main">,</span>length <span class="skolem">ss</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">from</span></span> Fun <span class="keyword1"><span class="command">have</span></span> t_gr_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?t</span> <span class="main">≻</span> <span class="var">?s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="var">?s</span>"</span></span>
              <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>σ <span class="var">?f</span><span class="main">)</span><span class="main">.</span> <span class="skolem">ts</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">≽</span> <span class="var">?s</span>"</span></span><span class="main">)</span>
                <span class="keyword3"><span class="command">case</span></span> True
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> set <span class="main">(</span>σ <span class="var">?f</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ge<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ts</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">≽</span> <span class="var">?s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>	      
                <span class="keyword1"><span class="command">with</span></span> ts <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">(</span><span class="skolem">ts</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="var">?s</span>"</span></span>
                <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> iff<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?s</span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> allI impI<span class="main">)</span>
                  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span>
                  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?s</span><span class="main">,</span><span class="skolem">u</span><span class="main">)</span> <span class="main">∈</span> WPO_S"</span></span>
                  <span class="keyword1"><span class="command">with</span></span> wpo_compat ge <span class="keyword1"><span class="command">have</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ts</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">≻</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?S</span> <span class="main">(</span><span class="skolem">ts</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>›</span></span><span class="main">[</span><span class="operator">unfolded</span> iff<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">ts</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
                  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                <span class="keyword1"><span class="command">qed</span></span>
              <span class="keyword1"><span class="command">next</span></span>
                <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">note</span></span> oFalse <span class="main">=</span> this
                <span class="keyword1"><span class="command">from</span></span> wpo_s_imp_NS<span class="main">[</span><span class="operator">OF</span> t_gr_s<span class="main">]</span>
                <span class="keyword1"><span class="command">have</span></span> t_NS_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?t</span><span class="main">,</span><span class="var">?s</span><span class="main">)</span> <span class="main">∈</span> <span class="free">NS</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
                <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?t</span><span class="main">,</span><span class="var">?s</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span>"</span></span><span class="main">)</span>
                  <span class="keyword3"><span class="command">case</span></span> True
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">f</span><span class="main">,</span><span class="skolem">ts</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="skolem">g</span><span class="main">,</span><span class="skolem">ss</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?rrr</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> rr_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">with</span></span> ind <span class="keyword1"><span class="command">have</span></span> ind<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?ind</span> <span class="main">(</span><span class="skolem">g</span><span class="main">,</span><span class="skolem">ss</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">{</span></span>
                    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
                    <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> set <span class="main">(</span>σ <span class="var">?g</span><span class="main">)</span>"</span></span>
                    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?s</span> <span class="main">≽</span> <span class="skolem">ss</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subterm_wpo_ns_arg<span class="main"><span class="main">[</span></span><span class="operator">OF</span> i<span class="main"><span class="main">]</span></span><span class="main">)</span>
                    <span class="keyword1"><span class="command">with</span></span> t_gr_s <span class="keyword1"><span class="command">have</span></span> ts<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?t</span> <span class="main">≻</span> <span class="skolem">ss</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> wpo_compat <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">(</span><span class="skolem">ss</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> IH<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> σE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> i<span class="main"><span class="main">]</span></span> ts<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> SN_ss <span class="main">=</span> this
                  <span class="keyword1"><span class="command">from</span></span> ind SN_ss <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">next</span></span>
                  <span class="keyword3"><span class="command">case</span></span> False 
                  <span class="keyword1"><span class="command">with</span></span> t_NS_s oFalse 
                  <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?t</span><span class="main">,</span><span class="var">?s</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">=</span> False"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?t</span><span class="main">,</span><span class="var">?s</span><span class="main">)</span> <span class="main">∈</span> <span class="free">NS</span> <span class="main">=</span> True"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
                  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ls</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"length <span class="skolem">ss</span>"</span></span>
                  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?lt</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"length <span class="skolem">ts</span>"</span></span>
                  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">f</span><span class="main">,</span><span class="var">?lt</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">g</span><span class="main">,</span><span class="var">?ls</span><span class="main">)</span>"</span></span>
                  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s1</span></span> <span class="skolem"><span class="skolem">ns1</span></span> <span class="keyword2"><span class="keyword">where</span></span> prc1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">prc</span> <span class="var">?f</span> <span class="var">?g</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">ns1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
                  <span class="keyword1"><span class="command">note</span></span> t_gr_s <span class="main">=</span> t_gr_s<span class="main">[</span><span class="operator">unfolded</span> wpo.simps<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> 
                      <span class="operator">unfolded</span> term.simps id if_True if_False prc1 split<span class="main">]</span>
                  <span class="keyword1"><span class="command">from</span></span> oFalse t_gr_s <span class="keyword1"><span class="command">have</span></span> f_ge_g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ns1</span>"</span></span>
                    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
                  <span class="keyword1"><span class="command">from</span></span> oFalse t_gr_s f_ge_g <span class="keyword1"><span class="command">have</span></span> small_ss<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>σ <span class="var">?g</span><span class="main">)</span><span class="main">.</span> <span class="var">?t</span> <span class="main">≻</span> <span class="skolem">ss</span> <span class="main">!</span> <span class="bound">i</span>"</span></span>
                    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
                  <span class="keyword1"><span class="command">with</span></span> Fun σE<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">g</span></span> <span class="quoted"><span class="skolem">ss</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> ss_S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?Slist</span> <span class="var">?g</span> <span class="skolem">ss</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s1</span></span><span class="main">)</span>
                    <span class="keyword3"><span class="command">case</span></span> True
                    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">f</span><span class="main">,</span><span class="skolem">ts</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="skolem">g</span><span class="main">,</span><span class="skolem">ss</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?r</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prc1<span class="main">)</span>
                    <span class="keyword1"><span class="command">with</span></span> t_NS_s <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">f</span><span class="main">,</span><span class="skolem">ts</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="skolem">g</span><span class="main">,</span><span class="skolem">ss</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?rrr</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> rr_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                    <span class="keyword1"><span class="command">with</span></span> ind <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ind</span> <span class="main">(</span><span class="skolem">g</span><span class="main">,</span><span class="skolem">ss</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                    <span class="keyword1"><span class="command">with</span></span> ss_S <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">next</span></span>
                    <span class="keyword3"><span class="command">case</span></span> False
                    <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>Diff<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="var">?f</span> <span class="main">≠</span> <span class="free">c</span> <span class="var">?g</span>"</span></span> <span class="main">|</span> <span class="main">(</span>Lex<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="var">?f</span> <span class="main">=</span> Lex"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="var">?g</span> <span class="main">=</span> Lex"</span></span> <span class="main">|</span> <span class="main">(</span>Mul<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="var">?f</span> <span class="main">=</span> Mul"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="var">?g</span> <span class="main">=</span> Mul"</span></span> 
                      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="var">?f</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="var">?g</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
                    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
                      <span class="keyword3"><span class="command">case</span></span> Diff
                      <span class="keyword1"><span class="command">with</span></span> False oFalse f_ge_g t_gr_s small_ss prc1 t_NS_s
                      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">f</span><span class="main">,</span><span class="skolem">ts</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="skolem">g</span><span class="main">,</span><span class="skolem">ss</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?rrr</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> rr_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="var">?f</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="var">?g</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
                      <span class="keyword1"><span class="command">with</span></span> ind <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ind</span> <span class="main">(</span><span class="skolem">g</span><span class="main">,</span><span class="skolem">ss</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Pair <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                      <span class="keyword1"><span class="command">with</span></span> ss_S <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                    <span class="keyword1"><span class="command">next</span></span>
                      <span class="keyword3"><span class="command">case</span></span> Lex
                      <span class="keyword1"><span class="command">from</span></span> False oFalse t_gr_s small_ss f_ge_g Lex
                      <span class="keyword1"><span class="command">have</span></span> lex<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>lex_ext wpo <span class="free">n</span> <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="skolem">ts</span><span class="main">)</span> <span class="main">(</span>σ <span class="var">?f</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="skolem">ss</span><span class="main">)</span> <span class="main">(</span>σ <span class="var">?g</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
                        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                      <span class="keyword1"><span class="command">from</span></span> False lex ts f_ge_g Lex <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">f</span><span class="main">,</span><span class="skolem">ts</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="skolem">g</span><span class="main">,</span><span class="skolem">ss</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?r</span>"</span></span>
                        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prc1<span class="main">)</span>
                      <span class="keyword1"><span class="command">with</span></span> t_NS_s <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">f</span><span class="main">,</span><span class="skolem">ts</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="skolem">g</span><span class="main">,</span><span class="skolem">ss</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?rrr</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> rr_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                      <span class="keyword1"><span class="command">with</span></span> ind <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ind</span> <span class="main">(</span><span class="skolem">g</span><span class="main">,</span><span class="skolem">ss</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                      <span class="keyword1"><span class="command">with</span></span> ss_S <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                    <span class="keyword1"><span class="command">next</span></span>
                      <span class="keyword3"><span class="command">case</span></span> Mul
                      <span class="keyword1"><span class="command">from</span></span> False oFalse t_gr_s small_ss f_ge_g Mul
                      <span class="keyword1"><span class="command">have</span></span> mul<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>mul_ext wpo <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="skolem">ts</span><span class="main">)</span> <span class="main">(</span>σ <span class="var">?f</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="skolem">ss</span><span class="main">)</span> <span class="main">(</span>σ <span class="var">?g</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
                        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                      <span class="keyword1"><span class="command">from</span></span> False mul ts f_ge_g Mul <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">f</span><span class="main">,</span><span class="skolem">ts</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="skolem">g</span><span class="main">,</span><span class="skolem">ss</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?r</span>"</span></span>
                        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prc1<span class="main">)</span>
                      <span class="keyword1"><span class="command">with</span></span> t_NS_s <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">f</span><span class="main">,</span><span class="skolem">ts</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="skolem">g</span><span class="main">,</span><span class="skolem">ss</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?rrr</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> rr_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                      <span class="keyword1"><span class="command">with</span></span> ind <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ind</span> <span class="main">(</span><span class="skolem">g</span><span class="main">,</span><span class="skolem">ss</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                      <span class="keyword1"><span class="command">with</span></span> ss_S <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                    <span class="keyword1"><span class="command">qed</span></span>
                  <span class="keyword1"><span class="command">qed</span></span>
                <span class="keyword1"><span class="command">qed</span></span>
              <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">with</span></span> Fun <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> σE<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">f</span></span> <span class="quoted"><span class="skolem">ts</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">from</span></span> SN_I<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"SN <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">::</span><span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span>term<span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> fst <span class="main">(</span>wpo <span class="bound">s</span> <span class="bound">t</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> WPO_SN_order_pair<span class="main">:</span> <span class="quoted"><span class="quoted">"SN_order_pair WPO_S WPO_NS"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"refl WPO_NS"</span></span> <span class="keyword1"><span class="command">using</span></span> wpo_ns_refl <span class="keyword1"><span class="command">unfolding</span></span> refl_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"trans WPO_NS"</span></span> <span class="keyword1"><span class="command">using</span></span> wpo_compat <span class="keyword1"><span class="command">unfolding</span></span> trans_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"trans WPO_S"</span></span> <span class="keyword1"><span class="command">using</span></span> wpo_compat wpo_s_imp_ns <span class="keyword1"><span class="command">unfolding</span></span> trans_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"WPO_NS <span class="keyword1">O</span> WPO_S <span class="main">⊆</span> WPO_S"</span></span> <span class="keyword1"><span class="command">using</span></span> wpo_compat <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"WPO_S <span class="keyword1">O</span> WPO_NS <span class="main">⊆</span> WPO_S"</span></span> <span class="keyword1"><span class="command">using</span></span> wpo_compat <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"SN WPO_S"</span></span> <span class="keyword1"><span class="command">using</span></span> WPO_S_SN <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> WPO_S_subst<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">t</span><span class="main">)</span> <span class="main">∈</span> WPO_S <span class="main">⟹</span> <span class="main">(</span><span class="free">s</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">,</span> <span class="free">t</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span> <span class="main">∈</span> WPO_S"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">σ</span>
  <span class="keyword1"><span class="command">using</span></span> wpo_stable <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">theorem</span></span> WPO_NS_subst<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">t</span><span class="main">)</span> <span class="main">∈</span> WPO_NS <span class="main">⟹</span> <span class="main">(</span><span class="free">s</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">,</span> <span class="free">t</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span> <span class="main">∈</span> WPO_NS"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">σ</span>
  <span class="keyword1"><span class="command">using</span></span> wpo_stable <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">theorem</span></span> WPO_NS_ctxt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">t</span><span class="main">)</span> <span class="main">∈</span> WPO_NS <span class="main">⟹</span> <span class="main">(</span>Fun <span class="free">f</span> <span class="main">(</span><span class="free">bef</span> <span class="main">@</span> <span class="free">s</span> <span class="main">#</span> <span class="free">aft</span><span class="main">)</span><span class="main">,</span> Fun <span class="free">f</span> <span class="main">(</span><span class="free">bef</span> <span class="main">@</span> <span class="free">t</span> <span class="main">#</span> <span class="free">aft</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> WPO_NS"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> wpo_ns_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">theorem</span></span> WPO_S_subset_WPO_NS<span class="main">:</span> <span class="quoted"><span class="quoted">"WPO_S <span class="main">⊆</span> WPO_NS"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> wpo_s_imp_ns <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>


<span class="keyword1"><span class="command">context</span></span> <span class="comment1">(* if σ is the full status, then WPO_S is a simplification order *)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> σ_full<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">f</span> <span class="bound">k</span><span class="main">.</span> set <span class="main">(</span>σ <span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="bound">k</span><span class="main">}</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="WPO-subterm_wpo_s"><span class="command">lemma</span></span> subterm_wpo_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⊳</span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">≻</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> supt.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>arg <span class="skolem">s</span> <span class="skolem">ss</span> <span class="skolem">f</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> arg<span class="main">[</span><span class="operator">unfolded</span> set_conv_nth<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">ss</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> <span class="skolem">ss</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
  <span class="keyword1"><span class="command">from</span></span> σ_full<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">f</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">ss</span>"</span></span><span class="main">]</span> i <span class="keyword1"><span class="command">have</span></span> ii<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> set <span class="main">(</span>σ <span class="main">(</span><span class="skolem">f</span><span class="main">,</span>length <span class="skolem">ss</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> subterm_wpo_s_arg<span class="main">[</span><span class="operator">OF</span> ii<span class="main">]</span> s <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>subt <span class="skolem">s</span> <span class="skolem">ss</span> <span class="skolem">t</span> <span class="skolem">f</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> subt wpo_s_imp_ns <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">s</span> <span class="main">∈</span> set <span class="skolem">ss</span><span class="main">.</span> wpo_ns <span class="bound">s</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">unfolded</span> set_conv_nth<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> ns<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">≽</span> <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">ss</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> σ_full<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">f</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">ss</span>"</span></span><span class="main">]</span> i <span class="keyword1"><span class="command">have</span></span> ii<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> set <span class="main">(</span>σ <span class="main">(</span><span class="skolem">f</span><span class="main">,</span>length <span class="skolem">ss</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> subt <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Fun <span class="skolem">f</span> <span class="skolem">ss</span> <span class="main">⊵</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> NS_subterm<span class="main">[</span><span class="operator">OF</span> σ_full this<span class="main">]</span> ns ii
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wpo.simps<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* Compatibility of the subterm relation with the order relation:
    a subterm is smaller *)</span>
<span class="keyword1" id="WPO-subterm_wpo_ns"><span class="command">lemma</span></span> subterm_wpo_ns<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> supteq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⊵</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≽</span> <span class="free">t</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> supteq <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">=</span> <span class="free">t</span> <span class="main">∨</span> <span class="free">s</span> <span class="main">⊳</span> <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">=</span> <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> wpo_ns_refl <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⊳</span> <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> wpo_s_imp_ns<span class="main">[</span><span class="operator">OF</span> subterm_wpo_s<span class="main"><span class="main">[</span></span><span class="operator">OF</span> this<span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="WPO-wpo_s_mono"><span class="command">lemma</span></span> wpo_s_mono<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> rels<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≻</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Fun <span class="free">f</span> <span class="main">(</span><span class="free">bef</span> <span class="main">@</span> <span class="free">s</span> <span class="main">#</span> <span class="free">aft</span><span class="main">)</span> <span class="main">≻</span> Fun <span class="free">f</span> <span class="main">(</span><span class="free">bef</span> <span class="main">@</span> <span class="free">t</span> <span class="main">#</span> <span class="free">aft</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ss</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">bef</span> <span class="main">@</span> <span class="free">s</span> <span class="main">#</span> <span class="free">aft</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ts</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">bef</span> <span class="main">@</span> <span class="free">t</span> <span class="main">#</span> <span class="free">aft</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Fun <span class="free">f</span> <span class="var">?ss</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Fun <span class="free">f</span> <span class="var">?ts</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?len</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>length <span class="free">bef</span> <span class="main">+</span> length <span class="free">aft</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="var">?len</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?σ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"σ <span class="var">?f</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> wpo_s_imp_ns<span class="main">[</span><span class="operator">OF</span> rels<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> rel<span class="main">:</span> <span class="quoted"><span class="quoted">"wpo_ns <span class="free">s</span> <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> wpo_ns_pre_mono<span class="main">[</span><span class="operator">OF</span> rel<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">j</span><span class="main">∈</span>set <span class="var">?σ</span><span class="main">.</span> wpo_s <span class="var">?s</span> <span class="main">(</span><span class="main">(</span><span class="free">bef</span> <span class="main">@</span> <span class="free">t</span> <span class="main">#</span> <span class="free">aft</span><span class="main">)</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> True"</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="var">?s</span><span class="main">,</span><span class="var">?t</span><span class="main">)</span> <span class="main">∈</span> <span class="free">NS</span><span class="main">)</span> <span class="main">=</span> True"</span></span> 
    <span class="quoted"><span class="quoted">"length <span class="var">?ss</span> <span class="main">=</span> <span class="var">?len</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="var">?ts</span> <span class="main">=</span> <span class="var">?len</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?lb</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"length <span class="free">bef</span>"</span></span> 
  <span class="keyword1"><span class="command">from</span></span> σ_full<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="var"><span class="quoted"><span class="var">?len</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> lb_mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?lb</span> <span class="main">∈</span> set <span class="var">?σ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> σi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?σ</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="var">?lb</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="var">?σ</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> set_conv_nth <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mss</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">(!)</span> <span class="var">?ss</span><span class="main">)</span> <span class="var">?σ</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mts</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">(!)</span> <span class="var">?ts</span><span class="main">)</span> <span class="var">?σ</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>lex_ext wpo <span class="free">n</span> <span class="var">?mss</span> <span class="var">?mts</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> lex_ext_iff fst_conv
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> disjI1<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> length_map id<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> exI conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> i<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> i<span class="main"><span class="keyword3">,</span></span> 
      <span class="operator">intro</span> allI impI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wpo_s <span class="main">(</span><span class="var">?mss</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="var">?mts</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> σi i rels <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> i <span class="keyword1"><span class="command">have</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="var">?σ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> wpo_ns_pre_mono<span class="main">[</span><span class="operator">OF</span> rel<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mss</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">≽</span> <span class="var">?mts</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> 
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">lb</span></span> <span class="skolem"><span class="skolem">nlb</span></span> <span class="keyword2"><span class="keyword">where</span></span> part<span class="main">:</span> <span class="quoted"><span class="quoted">"partition <span class="main">(</span><span class="main">(=)</span> <span class="var">?lb</span><span class="main">)</span> <span class="var">?σ</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">lb</span><span class="main">,</span> <span class="skolem">nlb</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">hence</span></span> mset_σ<span class="main">:</span> <span class="quoted"><span class="quoted">"mset <span class="var">?σ</span> <span class="main">=</span> mset <span class="skolem">lb</span> <span class="main">+</span> mset <span class="skolem">nlb</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="var"><span class="quoted"><span class="var">?σ</span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mlbs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">(!)</span> <span class="var">?ss</span><span class="main">)</span> <span class="skolem">lb</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mnlbs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">(!)</span> <span class="var">?ss</span><span class="main">)</span> <span class="skolem">nlb</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mlbt</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">(!)</span> <span class="var">?ts</span><span class="main">)</span> <span class="skolem">lb</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mnlbt</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">(!)</span> <span class="var">?ts</span><span class="main">)</span> <span class="skolem">nlb</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> id1<span class="main">:</span> <span class="quoted"><span class="quoted">"mset <span class="var">?mss</span> <span class="main">=</span> mset <span class="var">?mnlbs</span> <span class="main">+</span> mset <span class="var">?mlbs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mset_σ <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> id2<span class="main">:</span> <span class="quoted"><span class="quoted">"mset <span class="var">?mts</span> <span class="main">=</span> mset <span class="var">?mnlbt</span> <span class="main">+</span> mset <span class="var">?mlbt</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mset_σ <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> part lb_mem <span class="keyword1"><span class="command">have</span></span> lb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?lb</span> <span class="main">∈</span> set <span class="skolem">lb</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>mul_ext wpo <span class="var">?mss</span> <span class="var">?mts</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> mul_ext_def Let_def fst_conv
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> s_mul_extI_old<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> id1<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> id2<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> lb <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mset <span class="var">?mlbs</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="var">?mnlbt</span>"</span></span> 
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?mnlbs</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="var">?ss</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mnlbt</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="var">?ts</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> set <span class="skolem">nlb</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> part <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≠</span> <span class="var">?lb</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ss</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> <span class="var">?ts</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?mnlbs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">,</span> <span class="var">?mnlbt</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> WPO_NS"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> id <span class="keyword1"><span class="command">using</span></span> wpo_ns_refl <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈#</span> mset <span class="var">?mlbt</span>"</span></span> 
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">=</span> <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> part <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈#</span> mset <span class="var">?mlbs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lb <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈#</span>  mset <span class="var">?mlbs</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span><span class="skolem">u</span><span class="main">)</span> <span class="main">∈</span> WPO_S"</span></span> <span class="keyword1"><span class="command">using</span></span> rels <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> wpo.simps<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span><span class="main">]</span> term.simps id prc_refl
    <span class="keyword1"><span class="command">using</span></span> order_tag.exhaust <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> WPO_S_ctxt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">t</span><span class="main">)</span> <span class="main">∈</span> WPO_S <span class="main">⟹</span> <span class="main">(</span>Fun <span class="free">f</span> <span class="main">(</span><span class="free">bef</span> <span class="main">@</span> <span class="free">s</span> <span class="main">#</span> <span class="free">aft</span><span class="main">)</span><span class="main">,</span> Fun <span class="free">f</span> <span class="main">(</span><span class="free">bef</span> <span class="main">@</span> <span class="free">t</span> <span class="main">#</span> <span class="free">aft</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> WPO_S"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> wpo_s_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">theorem</span></span> supt_subset_WPO_S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{⊳}</span> <span class="main">⊆</span> WPO_S"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> subterm_wpo_s <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">theorem</span></span> supteq_subset_WPO_NS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{⊵}</span> <span class="main">⊆</span> WPO_NS"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> subterm_wpo_ns <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="RPO">
<div class="head">
<h1>Theory RPO</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹The Recursive Path Order as an instance of WPO›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This theory defines the recursive path order (RPO) that given two terms provides two Booleans,
  whether the terms can be strictly or non-strictly oriented. It is proven that RPO is an instance of WPO, and hence,
  carries over all the nice properties of WPO immediately.›</span></span>
<span class="keyword1"><span class="command">theory</span></span> RPO
  <span class="keyword2"><span class="keyword">imports</span></span>
    <a href="#WPO">WPO</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="quoted">"<span class="free">pr</span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'f</span> <span class="main">×</span> nat <span class="main">⇒</span> <span class="tfree">'f</span> <span class="main">×</span> nat <span class="main">⇒</span> bool <span class="main">×</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">prl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'f</span> <span class="main">×</span> nat <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">c</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'f</span> <span class="main">×</span> nat <span class="main">⇒</span> order_tag"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">rpo</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> term <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> term <span class="main">⇒</span> bool <span class="main">×</span> bool"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">rpo</span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>False<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">rpo</span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>Fun <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>False<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∧</span> <span class="free">prl</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">,</span><span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">rpo</span> <span class="main">(</span>Fun <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">ss</span></span></span><span class="main">)</span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">con</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">s</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">ss</span></span></span><span class="main">.</span> snd <span class="main">(</span><span class="free">rpo</span> <span class="bound">s</span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">in</span> <span class="main">(</span><span class="bound">con</span><span class="main">,</span><span class="bound">con</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">rpo</span> <span class="main">(</span>Fun <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">ss</span></span></span><span class="main">)</span> <span class="main">(</span>Fun <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">if</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">s</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">ss</span></span></span><span class="main">.</span> snd <span class="main">(</span><span class="free">rpo</span> <span class="bound">s</span> <span class="main">(</span>Fun <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
       <span class="keyword1">then</span> <span class="main">(</span>True<span class="main">,</span>True<span class="main">)</span>
       <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">prs</span><span class="main">,</span><span class="bound">prns</span><span class="main">)</span> <span class="main">=</span> <span class="free">pr</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">,</span>length <span class="free"><span class="bound"><span class="entity">ss</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">,</span>length <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="keyword1">in</span> 
         <span class="keyword1">if</span> <span class="bound">prns</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">t</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">.</span> fst <span class="main">(</span><span class="free">rpo</span> <span class="main">(</span>Fun <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">ss</span></span></span><span class="main">)</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>
         <span class="keyword1">then</span> <span class="keyword1">if</span> <span class="bound">prs</span>
              <span class="keyword1">then</span> <span class="main">(</span>True<span class="main">,</span>True<span class="main">)</span> 
              <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free">c</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">,</span>length <span class="free"><span class="bound"><span class="entity">ss</span></span></span><span class="main">)</span> <span class="main">=</span> Lex <span class="main">∧</span> <span class="free">c</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">,</span>length <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">=</span> Lex
                   <span class="keyword1">then</span> lex_ext <span class="free">rpo</span> <span class="free">n</span> <span class="free"><span class="bound"><span class="entity">ss</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span>
                   <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free">c</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">,</span>length <span class="free"><span class="bound"><span class="entity">ss</span></span></span><span class="main">)</span> <span class="main">=</span> Mul <span class="main">∧</span> <span class="free">c</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">,</span>length <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">=</span> Mul
                        <span class="keyword1">then</span> mul_ext <span class="free">rpo</span> <span class="free"><span class="bound"><span class="entity">ss</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span>
                        <span class="keyword1">else</span> <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">ss</span></span></span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> length <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">=</span> <span class="main">0</span><span class="main">,</span> length <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>
          <span class="keyword1">else</span> <span class="main">(</span>False<span class="main">,</span>False<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> rpo_with_assms <span class="main">=</span> precedence <span class="quoted"><span class="free">prc</span></span> <span class="quoted"><span class="free">prl</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">prc</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'f</span> <span class="main">×</span> nat <span class="main">⇒</span> <span class="tfree">'f</span> <span class="main">×</span> nat <span class="main">⇒</span> bool <span class="main">×</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">prl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'f</span> <span class="main">×</span> nat <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">c</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'f</span> <span class="main">×</span> nat <span class="main">⇒</span> order_tag"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> wpo_with_assms <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span> <span class="quoted">UNIV</span> <span class="quoted"><span class="free">prc</span></span> <span class="quoted"><span class="free">prl</span></span> <span class="quoted">full_status</span> <span class="quoted"><span class="free">c</span></span> <span class="quoted">False</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> False"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> refl_on_def trans_def simple_arg_pos_def<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">rpo_pr</span> <span class="main">≡</span> rpo <span class="free">prc</span> <span class="free">prl</span> <span class="free">c</span> <span class="free">n</span>"</span></span> 
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">rpo_s</span> <span class="main">≡</span> <span class="main">λ</span> <span class="bound">s</span> <span class="bound">t</span><span class="main">.</span> fst <span class="main">(</span>rpo_pr <span class="bound">s</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">rpo_ns</span> <span class="main">≡</span> <span class="main">λ</span> <span class="bound">s</span> <span class="bound">t</span><span class="main">.</span> snd <span class="main">(</span>rpo_pr <span class="bound">s</span> <span class="bound">t</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="RPO-rpo_eq_wpo"><span class="command">lemma</span></span> rpo_eq_wpo<span class="main">:</span> <span class="quoted"><span class="quoted">"rpo_pr <span class="free">s</span> <span class="free">t</span> <span class="main">=</span> wpo <span class="free">s</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> simps <span class="main">=</span> wpo.simps
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rpo.induct<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">prc</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">prl</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">c</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> simps<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">x</span> <span class="skolem">g</span> <span class="skolem">ts</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> simps<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">f</span> <span class="skolem">ss</span> <span class="skolem">y</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> simps<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Fun <span class="skolem">f</span> <span class="skolem">ss</span>"</span></span> <span class="quoted"><span class="quoted">"Var <span class="skolem">y</span>"</span></span><span class="main"><span class="main">]</span></span> Let_def set_conv_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> IH<span class="main">:</span> <span class="main">(</span>4 <span class="skolem">f</span> <span class="skolem">ss</span> <span class="skolem">g</span> <span class="skolem">ts</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="bound">s</span> <span class="main">∈</span> <span class="main">{}</span><span class="main">)</span> <span class="main">=</span> False"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="bound">s</span> <span class="main">∈</span> UNIV<span class="main">)</span> <span class="main">=</span> True"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="skolem">ss</span><span class="main">}</span><span class="main">.</span> wpo_ns <span class="main">(</span><span class="skolem">ss</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">si</span><span class="main">∈</span>set <span class="skolem">ss</span><span class="main">.</span> wpo_ns <span class="bound">si</span> <span class="free">t</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_conv_nth<span class="main">)</span> 
    <span class="keyword1"><span class="command">have</span></span> id'<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">(!)</span> <span class="skolem">ss</span><span class="main">)</span> <span class="main">(</span>σ <span class="main">(</span><span class="skolem">f</span><span class="main">,</span> length <span class="skolem">ss</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">ss</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">f</span> <span class="skolem">ss</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nth_equalityI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> ex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">∈</span>set <span class="main">(</span>σ <span class="main">(</span><span class="skolem">f</span><span class="main">,</span> length <span class="skolem">ss</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> wpo_ns <span class="main">(</span><span class="skolem">ss</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>Fun <span class="skolem">g</span> <span class="skolem">ts</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">si</span> <span class="main">∈</span> set <span class="skolem">ss</span><span class="main">.</span> rpo_ns <span class="bound">si</span> <span class="main">(</span>Fun <span class="skolem">g</span> <span class="skolem">ts</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> IH<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> set_conv_nth <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">prs</span></span> <span class="skolem"><span class="skolem">prns</span></span> <span class="keyword2"><span class="keyword">where</span></span> prc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">prc</span> <span class="main">(</span><span class="skolem">f</span><span class="main">,</span> length <span class="skolem">ss</span><span class="main">)</span> <span class="main">(</span><span class="skolem">g</span><span class="main">,</span> length <span class="skolem">ts</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">prs</span><span class="main">,</span> <span class="skolem">prns</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> rpo.simps simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Fun <span class="skolem">f</span> <span class="skolem">ss</span>"</span></span> <span class="quoted"><span class="quoted">"Fun <span class="skolem">g</span> <span class="skolem">ts</span>"</span></span><span class="main">]</span> term.simps id id' if_False if_True
        Let_def ex prc split
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> if_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl refl<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> if_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> conj_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span> if_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl refl if_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl _ if_cong<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span> refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">si</span><span class="main">∈</span>set <span class="skolem">ss</span><span class="main">.</span> rpo_ns <span class="bound">si</span> <span class="main">(</span>Fun <span class="skolem">g</span> <span class="skolem">ts</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> IH<span class="main">(</span>2-<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this prc<span class="main"><span class="main"><span class="main"><span class="main">[</span></span></span></span><span class="operator"><span class="operator"><span class="operator">symmetric</span></span></span><span class="main"><span class="main"><span class="main"><span class="main">]</span></span></span></span> refl<span class="main">]</span>
      <span class="keyword1"><span class="command">from</span></span> IH<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">j</span><span class="main">∈</span>set <span class="main">(</span>σ <span class="main">(</span><span class="skolem">g</span><span class="main">,</span> length <span class="skolem">ts</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> wpo_s <span class="main">(</span>Fun <span class="skolem">f</span> <span class="skolem">ss</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ts</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">∈</span>set <span class="skolem">ts</span><span class="main">.</span> rpo_s <span class="main">(</span>Fun <span class="skolem">f</span> <span class="skolem">ss</span><span class="main">)</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> set_conv_nth <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">prns</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">∈</span>set <span class="skolem">ts</span><span class="main">.</span> rpo_s <span class="main">(</span>Fun <span class="skolem">f</span> <span class="skolem">ss</span><span class="main">)</span> <span class="bound">t</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">prs</span>"</span></span> 
      <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> IH<span class="main">(</span>2-<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">(</span><span class="skolem">f</span><span class="main">,</span> length <span class="skolem">ss</span><span class="main">)</span> <span class="main">=</span> Lex <span class="main">∧</span> <span class="free">c</span> <span class="main">(</span><span class="skolem">g</span><span class="main">,</span> length <span class="skolem">ts</span><span class="main">)</span> <span class="main">=</span> Lex"</span></span> 
        <span class="keyword1"><span class="command">from</span></span> IH<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lex_ext wpo <span class="free">n</span> <span class="skolem">ss</span> <span class="skolem">ts</span> <span class="main">=</span> lex_ext rpo_pr <span class="free">n</span> <span class="skolem">ss</span> <span class="skolem">ts</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> lex_ext_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="free">c</span> <span class="main">(</span><span class="skolem">f</span><span class="main">,</span> length <span class="skolem">ss</span><span class="main">)</span> <span class="main">=</span> Lex <span class="main">∧</span> <span class="free">c</span> <span class="main">(</span><span class="skolem">g</span><span class="main">,</span> length <span class="skolem">ts</span><span class="main">)</span> <span class="main">=</span> Lex<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">(</span><span class="skolem">f</span><span class="main">,</span> length <span class="skolem">ss</span><span class="main">)</span> <span class="main">=</span> Mul <span class="main">∧</span> <span class="free">c</span> <span class="main">(</span><span class="skolem">g</span><span class="main">,</span> length <span class="skolem">ts</span><span class="main">)</span> <span class="main">=</span> Mul"</span></span> 
        <span class="keyword1"><span class="command">from</span></span> IH<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mul_ext wpo <span class="skolem">ss</span> <span class="skolem">ts</span> <span class="main">=</span> mul_ext rpo_pr <span class="skolem">ss</span> <span class="skolem">ts</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mul_ext_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">RPO_S</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">t</span><span class="main">)</span><span class="main">.</span> rpo_s <span class="bound">s</span> <span class="bound">t</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">RPO_NS</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">t</span><span class="main">)</span><span class="main">.</span> rpo_ns <span class="bound">s</span> <span class="bound">t</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">theorem</span></span> RPO_SN_order_pair<span class="main">:</span> <span class="quoted"><span class="quoted">"SN_order_pair RPO_S RPO_NS"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rpo_eq_wpo <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> WPO_SN_order_pair<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> RPO_S_subst<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">t</span><span class="main">)</span> <span class="main">∈</span> RPO_S <span class="main">⟹</span> <span class="main">(</span><span class="free">s</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">,</span> <span class="free">t</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span> <span class="main">∈</span> RPO_S"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">σ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span>subst"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> WPO_S_subst <span class="keyword1"><span class="command">unfolding</span></span> rpo_eq_wpo <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">theorem</span></span> RPO_NS_subst<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">t</span><span class="main">)</span> <span class="main">∈</span> RPO_NS <span class="main">⟹</span> <span class="main">(</span><span class="free">s</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">,</span> <span class="free">t</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span> <span class="main">∈</span> RPO_NS"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">σ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span>subst"</span></span>
  <span class="keyword1"><span class="command">using</span></span> WPO_NS_subst <span class="keyword1"><span class="command">unfolding</span></span> rpo_eq_wpo <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">theorem</span></span> RPO_NS_ctxt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">t</span><span class="main">)</span> <span class="main">∈</span> RPO_NS <span class="main">⟹</span> <span class="main">(</span>Fun <span class="free">f</span> <span class="main">(</span><span class="free">bef</span> <span class="main">@</span> <span class="free">s</span> <span class="main">#</span> <span class="free">aft</span><span class="main">)</span><span class="main">,</span> Fun <span class="free">f</span> <span class="main">(</span><span class="free">bef</span> <span class="main">@</span> <span class="free">t</span> <span class="main">#</span> <span class="free">aft</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> RPO_NS"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> WPO_NS_ctxt <span class="keyword1"><span class="command">unfolding</span></span> rpo_eq_wpo <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">theorem</span></span> RPO_S_ctxt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">t</span><span class="main">)</span> <span class="main">∈</span> RPO_S <span class="main">⟹</span> <span class="main">(</span>Fun <span class="free">f</span> <span class="main">(</span><span class="free">bef</span> <span class="main">@</span> <span class="free">s</span> <span class="main">#</span> <span class="free">aft</span><span class="main">)</span><span class="main">,</span> Fun <span class="free">f</span> <span class="main">(</span><span class="free">bef</span> <span class="main">@</span> <span class="free">t</span> <span class="main">#</span> <span class="free">aft</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> RPO_S"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> WPO_S_ctxt <span class="keyword1"><span class="command">unfolding</span></span> rpo_eq_wpo <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">theorem</span></span> RPO_S_subset_RPO_NS<span class="main">:</span> <span class="quoted"><span class="quoted">"RPO_S <span class="main">⊆</span> RPO_NS"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> WPO_S_subset_WPO_NS <span class="keyword1"><span class="command">unfolding</span></span> rpo_eq_wpo <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">theorem</span></span> supt_subset_RPO_S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{⊳}</span> <span class="main">⊆</span> RPO_S"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> supt_subset_WPO_S <span class="keyword1"><span class="command">unfolding</span></span> rpo_eq_wpo <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">theorem</span></span> supteq_subset_RPO_NS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{⊵}</span> <span class="main">⊆</span> RPO_NS"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> supteq_subset_WPO_NS <span class="keyword1"><span class="command">unfolding</span></span> rpo_eq_wpo <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="LPO">
<div class="head">
<h1>Theory LPO</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹The Lexicographic Path Order as an instance of WPO›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We first directly define the strict- and non-strict lexicographic path orders (LPO)
  w.r.t.\ some precedence, and then show that it is an instance of WPO.
  For this instance we use the trivial reduction pair in WPO ($\emptyset$, UNIV) and
  the status is the full one, i.e., taking parameters [0,..,n-1] for each n-ary symbol.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> LPO
  <span class="keyword2"><span class="keyword">imports</span></span>
    <a href="#WPO">WPO</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="quoted">"<span class="free">pr</span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span> <span class="main">×</span> nat <span class="main">⇒</span> <span class="tfree">'f</span> <span class="main">×</span> nat <span class="main">⇒</span> bool <span class="main">×</span> bool<span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">prl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'f</span> <span class="main">×</span> nat <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">lpo</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> term <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> term <span class="main">⇒</span> bool <span class="main">×</span> bool"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">lpo</span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>False<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">lpo</span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>Fun <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>False<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∧</span> <span class="free">prl</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">,</span><span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">lpo</span> <span class="main">(</span>Fun <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">ss</span></span></span><span class="main">)</span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">con</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">s</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">ss</span></span></span><span class="main">.</span> snd <span class="main">(</span><span class="free">lpo</span> <span class="bound">s</span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">in</span> <span class="main">(</span><span class="bound">con</span><span class="main">,</span><span class="bound">con</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">lpo</span> <span class="main">(</span>Fun <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">ss</span></span></span><span class="main">)</span> <span class="main">(</span>Fun <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
      <span class="keyword1">if</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">s</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">ss</span></span></span><span class="main">.</span> snd <span class="main">(</span><span class="free">lpo</span> <span class="bound">s</span> <span class="main">(</span>Fun <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
         <span class="keyword1">then</span> <span class="main">(</span>True<span class="main">,</span>True<span class="main">)</span>
         <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">prs</span><span class="main">,</span><span class="bound">prns</span><span class="main">)</span> <span class="main">=</span> <span class="free">pr</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">,</span>length <span class="free"><span class="bound"><span class="entity">ss</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">,</span>length <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="keyword1">in</span> 
           <span class="keyword1">if</span> <span class="bound">prns</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">t</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">.</span> fst <span class="main">(</span><span class="free">lpo</span> <span class="main">(</span>Fun <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">ss</span></span></span><span class="main">)</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>
           <span class="keyword1">then</span> <span class="keyword1">if</span> <span class="bound">prs</span>
              <span class="keyword1">then</span> <span class="main">(</span>True<span class="main">,</span>True<span class="main">)</span> 
              <span class="keyword1">else</span> lex_ext <span class="free">lpo</span> <span class="free">n</span> <span class="free"><span class="bound"><span class="entity">ss</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span>
           <span class="keyword1">else</span> <span class="main">(</span>False<span class="main">,</span>False<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">locale</span></span> lpo_with_assms <span class="main">=</span> precedence <span class="quoted"><span class="free">prc</span></span> <span class="quoted"><span class="free">prl</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">prc</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'f</span> <span class="main">×</span> nat <span class="main">⇒</span> <span class="tfree">'f</span> <span class="main">×</span> nat <span class="main">⇒</span> bool <span class="main">×</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">prl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'f</span> <span class="main">×</span> nat <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> wpo_with_assms <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span> <span class="quoted">UNIV</span> <span class="quoted"><span class="free">prc</span></span> <span class="quoted"><span class="free">prl</span></span> <span class="quoted">full_status</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> Lex"</span></span> <span class="quoted">False</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> False"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> refl_on_def trans_def simple_arg_pos_def<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">lpo_pr</span> <span class="main">≡</span> lpo <span class="free">prc</span> <span class="free">prl</span> <span class="free">n</span>"</span></span> 
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">lpo_s</span> <span class="main">≡</span> <span class="main">λ</span> <span class="bound">s</span> <span class="bound">t</span><span class="main">.</span> fst <span class="main">(</span>lpo_pr <span class="bound">s</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">lpo_ns</span> <span class="main">≡</span> <span class="main">λ</span> <span class="bound">s</span> <span class="bound">t</span><span class="main">.</span> snd <span class="main">(</span>lpo_pr <span class="bound">s</span> <span class="bound">t</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="LPO-lpo_eq_wpo"><span class="command">lemma</span></span> lpo_eq_wpo<span class="main">:</span> <span class="quoted"><span class="quoted">"lpo_pr <span class="free">s</span> <span class="free">t</span> <span class="main">=</span> wpo <span class="free">s</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">note</span></span> simps <span class="main">=</span> wpo.simps
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lpo.induct<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">prc</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">prl</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> simps<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">x</span> <span class="skolem">g</span> <span class="skolem">ts</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> simps<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">f</span> <span class="skolem">ss</span> <span class="skolem">y</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> simps<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Fun <span class="skolem">f</span> <span class="skolem">ss</span>"</span></span> <span class="quoted"><span class="quoted">"Var <span class="skolem">y</span>"</span></span><span class="main"><span class="main">]</span></span> Let_def set_conv_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> IH<span class="main">:</span> <span class="main">(</span>4 <span class="skolem">f</span> <span class="skolem">ss</span> <span class="skolem">g</span> <span class="skolem">ts</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="bound">s</span> <span class="main">∈</span> <span class="main">{}</span><span class="main">)</span> <span class="main">=</span> False"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="bound">s</span> <span class="main">∈</span> UNIV<span class="main">)</span> <span class="main">=</span> True"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="skolem">ss</span><span class="main">}</span><span class="main">.</span> wpo_ns <span class="main">(</span><span class="skolem">ss</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">si</span><span class="main">∈</span>set <span class="skolem">ss</span><span class="main">.</span> wpo_ns <span class="bound">si</span> <span class="free">t</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_conv_nth<span class="main">)</span> 
    <span class="keyword1"><span class="command">have</span></span> id'<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">(!)</span> <span class="skolem">ss</span><span class="main">)</span> <span class="main">(</span>σ <span class="main">(</span><span class="skolem">f</span><span class="main">,</span> length <span class="skolem">ss</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">ss</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">f</span> <span class="skolem">ss</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nth_equalityI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> ex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">∈</span>set <span class="main">(</span>σ <span class="main">(</span><span class="skolem">f</span><span class="main">,</span> length <span class="skolem">ss</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> wpo_ns <span class="main">(</span><span class="skolem">ss</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>Fun <span class="skolem">g</span> <span class="skolem">ts</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">si</span> <span class="main">∈</span> set <span class="skolem">ss</span><span class="main">.</span> lpo_ns <span class="bound">si</span> <span class="main">(</span>Fun <span class="skolem">g</span> <span class="skolem">ts</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> IH<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> set_conv_nth <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">prs</span></span> <span class="skolem"><span class="skolem">prns</span></span> <span class="keyword2"><span class="keyword">where</span></span> prc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">prc</span> <span class="main">(</span><span class="skolem">f</span><span class="main">,</span> length <span class="skolem">ss</span><span class="main">)</span> <span class="main">(</span><span class="skolem">g</span><span class="main">,</span> length <span class="skolem">ts</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">prs</span><span class="main">,</span> <span class="skolem">prns</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">have</span></span> lex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Lex <span class="main">=</span> Lex <span class="main">∧</span> Lex <span class="main">=</span> Lex<span class="main">)</span> <span class="main">=</span> True"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> lpo.simps simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Fun <span class="skolem">f</span> <span class="skolem">ss</span>"</span></span> <span class="quoted"><span class="quoted">"Fun <span class="skolem">g</span> <span class="skolem">ts</span>"</span></span><span class="main">]</span> term.simps id id' if_False if_True lex
        Let_def ex prc split
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> if_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl refl<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> if_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> conj_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span> if_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl refl<span class="main"><span class="main">]</span></span> refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">si</span><span class="main">∈</span>set <span class="skolem">ss</span><span class="main">.</span> lpo_ns <span class="bound">si</span> <span class="main">(</span>Fun <span class="skolem">g</span> <span class="skolem">ts</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> IH<span class="main">(</span>2-<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this prc<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator"><span class="operator">symmetric</span></span><span class="main"><span class="main"><span class="main">]</span></span></span> refl<span class="main">]</span>
      <span class="keyword1"><span class="command">from</span></span> IH<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">j</span><span class="main">∈</span>set <span class="main">(</span>σ <span class="main">(</span><span class="skolem">g</span><span class="main">,</span> length <span class="skolem">ts</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> wpo_s <span class="main">(</span>Fun <span class="skolem">f</span> <span class="skolem">ss</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ts</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">∈</span>set <span class="skolem">ts</span><span class="main">.</span> lpo_s <span class="main">(</span>Fun <span class="skolem">f</span> <span class="skolem">ss</span><span class="main">)</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> set_conv_nth <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">prns</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">∈</span>set <span class="skolem">ts</span><span class="main">.</span> lpo_s <span class="main">(</span>Fun <span class="skolem">f</span> <span class="skolem">ss</span><span class="main">)</span> <span class="bound">t</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">prs</span>"</span></span> 
      <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> IH<span class="main">(</span>2-<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lex_ext wpo <span class="free">n</span> <span class="skolem">ss</span> <span class="skolem">ts</span> <span class="main">=</span> lex_ext lpo_pr <span class="free">n</span> <span class="skolem">ss</span> <span class="skolem">ts</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> IH <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> lex_ext_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">LPO_S</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">t</span><span class="main">)</span><span class="main">.</span> lpo_s <span class="bound">s</span> <span class="bound">t</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">LPO_NS</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">t</span><span class="main">)</span><span class="main">.</span> lpo_ns <span class="bound">s</span> <span class="bound">t</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">theorem</span></span> LPO_SN_order_pair<span class="main">:</span> <span class="quoted"><span class="quoted">"SN_order_pair LPO_S LPO_NS"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> lpo_eq_wpo <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> WPO_SN_order_pair<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> LPO_S_subst<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">t</span><span class="main">)</span> <span class="main">∈</span> LPO_S <span class="main">⟹</span> <span class="main">(</span><span class="free">s</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">,</span> <span class="free">t</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span> <span class="main">∈</span> LPO_S"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">σ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span>subst"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> WPO_S_subst <span class="keyword1"><span class="command">unfolding</span></span> lpo_eq_wpo <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">theorem</span></span> LPO_NS_subst<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">t</span><span class="main">)</span> <span class="main">∈</span> LPO_NS <span class="main">⟹</span> <span class="main">(</span><span class="free">s</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">,</span> <span class="free">t</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span> <span class="main">∈</span> LPO_NS"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">σ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span>subst"</span></span>
  <span class="keyword1"><span class="command">using</span></span> WPO_NS_subst <span class="keyword1"><span class="command">unfolding</span></span> lpo_eq_wpo <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">theorem</span></span> LPO_NS_ctxt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">t</span><span class="main">)</span> <span class="main">∈</span> LPO_NS <span class="main">⟹</span> <span class="main">(</span>Fun <span class="free">f</span> <span class="main">(</span><span class="free">bef</span> <span class="main">@</span> <span class="free">s</span> <span class="main">#</span> <span class="free">aft</span><span class="main">)</span><span class="main">,</span> Fun <span class="free">f</span> <span class="main">(</span><span class="free">bef</span> <span class="main">@</span> <span class="free">t</span> <span class="main">#</span> <span class="free">aft</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> LPO_NS"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> WPO_NS_ctxt <span class="keyword1"><span class="command">unfolding</span></span> lpo_eq_wpo <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">theorem</span></span> LPO_S_ctxt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">t</span><span class="main">)</span> <span class="main">∈</span> LPO_S <span class="main">⟹</span> <span class="main">(</span>Fun <span class="free">f</span> <span class="main">(</span><span class="free">bef</span> <span class="main">@</span> <span class="free">s</span> <span class="main">#</span> <span class="free">aft</span><span class="main">)</span><span class="main">,</span> Fun <span class="free">f</span> <span class="main">(</span><span class="free">bef</span> <span class="main">@</span> <span class="free">t</span> <span class="main">#</span> <span class="free">aft</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> LPO_S"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> WPO_S_ctxt <span class="keyword1"><span class="command">unfolding</span></span> lpo_eq_wpo <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">theorem</span></span> LPO_S_subset_LPO_NS<span class="main">:</span> <span class="quoted"><span class="quoted">"LPO_S <span class="main">⊆</span> LPO_NS"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> WPO_S_subset_WPO_NS <span class="keyword1"><span class="command">unfolding</span></span> lpo_eq_wpo <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">theorem</span></span> supt_subset_LPO_S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{⊳}</span> <span class="main">⊆</span> LPO_S"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> supt_subset_WPO_S <span class="keyword1"><span class="command">unfolding</span></span> lpo_eq_wpo <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">theorem</span></span> supteq_subset_LPO_NS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{⊵}</span> <span class="main">⊆</span> LPO_NS"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> supteq_subset_WPO_NS <span class="keyword1"><span class="command">unfolding</span></span> lpo_eq_wpo <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="KBO_Transformation">
<div class="head">
<h1>Theory KBO_Transformation</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹The Knuth--Bendix Order as an instance of WPO›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Making the Knuth--Bendix an instance of WPO is more complicated than in the 
  case of RPO and LPO, because of syntactic and semantic differences. 
  We face the two main challenges in two different theories and sub-sections.›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Aligning least elements›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In all of RPO, LPO and WPO there is the concept of a minimal term, e.g., 
  a constant term $c$ where $c$ is least in precedence among \emph{all function symbols}. 
  By contrast, in KBO a constant $c$ is minimal if it has minimal weight and has
  least precende \emph{among all constants of minimal weight}.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In this theory we prove that for any KBO one can modify the precedence in a way
  that least constants $c$ also have least precendence among \emph{all function symbols},
  without changing the defined order. Hence, afterwards it will be simpler to relate such 
  a KBO to WPO.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> KBO_Transformation
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="#WPO">WPO</a> <a href="../../knuth_bendix_order/theories/#KBO">Knuth_Bendix_Order.KBO</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span> admissible_kbo
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="KBO_Transformation-weight_w0_unary"><span class="command">lemma</span></span> weight_w0_unary<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"weight <span class="free">t</span> <span class="main">=</span> <span class="free">w0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> Fun <span class="free">f</span> <span class="free">ts</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ts</span> <span class="main">=</span> <span class="free">t1</span> <span class="main">#</span> <span class="free">ts'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ts'</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">(</span><span class="free">f</span><span class="main">,</span><span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">w0</span> <span class="main">+</span> sum_list <span class="main">(</span>map weight <span class="free">ts'</span><span class="main">)</span> <span class="main">≤</span> weight <span class="free">t1</span> <span class="main">+</span> sum_list <span class="main">(</span>map weight <span class="free">ts'</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> add_right_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> weight_w0<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> sum_list <span class="main">(</span>map weight <span class="free">ts</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> sum_list <span class="main">(</span>map weight <span class="main">(</span>scf_list <span class="main">(</span><span class="free">scf</span> <span class="main">(</span><span class="free">f</span><span class="main">,</span> length <span class="free">ts</span><span class="main">)</span><span class="main">)</span> <span class="free">ts</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum_list_scf_list<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> scf<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">(</span><span class="free">f</span><span class="main">,</span>length <span class="free">ts</span><span class="main">)</span> <span class="main">+</span> <span class="free">w0</span> <span class="main">+</span> sum_list <span class="main">(</span>map weight <span class="free">ts'</span><span class="main">)</span> <span class="main">≤</span> weight <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> *<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> sum<span class="main">:</span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span>map weight <span class="free">ts'</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">(</span><span class="free">f</span><span class="main">,</span>length <span class="free">ts</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> weight_gt_0 <span class="keyword3"><span class="command">show</span></span> ts'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ts'</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ts'</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> wf <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">(</span><span class="free">f</span><span class="main">,</span><span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lConsts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span> <span class="main">×</span> nat<span class="main">)</span>set"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">lConsts</span> <span class="main">=</span> <span class="main">{</span> <span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">|</span> <span class="bound">f</span><span class="main">.</span> <span class="free">least</span> <span class="bound">f</span><span class="main">}</span>"</span></span> 
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pr_strict'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">pr_strict'</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">∉</span> lConsts <span class="main">∧</span> <span class="main">(</span><span class="free">pr_strict</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">∈</span> lConsts<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pr_weak'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">pr_weak'</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">∉</span> lConsts <span class="main">∧</span> <span class="free">pr_weak</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">∈</span> lConsts<span class="main">)</span>"</span></span>

<span class="keyword1" id="KBO_Transformation-admissible_kbo'"><span class="command">lemma</span></span> admissible_kbo'<span class="main">:</span> <span class="quoted"><span class="quoted">"admissible_kbo <span class="free">w</span> <span class="free">w0</span> pr_strict' pr_weak' <span class="free">least</span> <span class="free">scf</span>"</span></span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> w0<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> w0<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> f g n <span class="keyword1"><span class="command">using</span></span> adm<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">f</span></span> <span class="quoted"><span class="skolem">g</span></span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> pr_weak'_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lConsts_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> f <span class="keyword1"><span class="command">using</span></span> least<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">f</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> pr_weak'_def lConsts_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> scf<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> f <span class="keyword1"><span class="command">using</span></span> pr_weak_refl<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">f</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> pr_weak'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> f g h <span class="keyword1"><span class="command">using</span></span> pr_weak_trans<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">f</span></span> <span class="quoted"><span class="skolem">g</span></span> <span class="quoted"><span class="skolem">h</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> pr_weak'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> f g <span class="keyword1"><span class="command">using</span></span> pr_strict<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">f</span></span> <span class="quoted"><span class="skolem">g</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> pr_strict'_def pr_weak'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"SN <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> pr_strict' <span class="bound">x</span> <span class="bound">y</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"SN <span class="var">?R</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> 
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">i</span><span class="main">,</span> <span class="skolem">f</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span> 
    <span class="keyword1"><span class="command">hence</span></span> steps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">i</span><span class="main">,</span> <span class="skolem">f</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">i</span> <span class="main">∉</span> lConsts"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="keyword1"><span class="command">using</span></span> steps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> pr_strict'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">pr_strict</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="keyword1"><span class="command">using</span></span> steps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> pr_strict'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> pr_SN <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>
 
<span class="keyword1" id="KBO_Transformation-least_pr_weak'"><span class="command">lemma</span></span> least_pr_weak'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">least</span> <span class="free">f</span> <span class="main">⟹</span> pr_weak' <span class="free">g</span> <span class="main">(</span><span class="free">f</span><span class="main">,</span><span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lConsts_def pr_weak'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="KBO_Transformation-least_pr_weak'_trans"><span class="command">lemma</span></span> least_pr_weak'_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">least</span> <span class="free">f</span> <span class="main">⟹</span> pr_weak' <span class="main">(</span><span class="free">f</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="free">g</span> <span class="main">⟹</span> <span class="free">least</span> <span class="main">(</span>fst <span class="free">g</span><span class="main">)</span> <span class="main">∧</span> snd <span class="free">g</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> lConsts_def pr_weak'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">context</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">interpretation</span></span> kbo'<span class="main">:</span> admissible_kbo <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">w0</span></span> <span class="quoted">pr_strict'</span> <span class="quoted">pr_weak'</span> <span class="quoted"><span class="free">least</span></span> <span class="quoted"><span class="free">scf</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> admissible_kbo'<span class="main">)</span>

<span class="keyword1" id="KBO_Transformation-kbo'_eq_kbo"><span class="command">lemma</span></span> kbo'_eq_kbo<span class="main">:</span> <span class="quoted"><span class="quoted">"kbo'.kbo <span class="free">s</span> <span class="free">t</span> <span class="main">=</span> kbo <span class="free">s</span> <span class="free">t</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> kbo.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">s</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> simps <span class="main">=</span> kbo.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span> kbo'.kbo.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> simps
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> if_cong refl<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> term.case_cong refl<span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span> <span class="skolem">ss</span> <span class="skolem">g</span> <span class="skolem">ts</span>
    <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"vars_term_ms <span class="main">(</span>SCF <span class="skolem">t</span><span class="main">)</span> <span class="main">⊆#</span> vars_term_ms <span class="main">(</span>SCF <span class="skolem">s</span><span class="main">)</span> <span class="main">∧</span> weight <span class="skolem">t</span> <span class="main">≤</span> weight <span class="skolem">s</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">¬</span> weight <span class="skolem">t</span> <span class="main">&lt;</span> weight <span class="skolem">s</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> Fun <span class="skolem">f</span> <span class="skolem">ss</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> Fun <span class="skolem">g</span> <span class="skolem">ts</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">g</span><span class="main">,</span>length <span class="skolem">ts</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">f</span><span class="main">,</span>length <span class="skolem">ss</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">if</span> <span class="free">pr_strict</span> <span class="var">?f</span> <span class="var">?g</span> <span class="keyword1">then</span> <span class="main">(</span>True<span class="main">,</span> True<span class="main">)</span>
        <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free">pr_weak</span> <span class="var">?f</span> <span class="var">?g</span> <span class="keyword1">then</span> lex_ext_unbounded kbo <span class="skolem">ss</span> <span class="skolem">ts</span> <span class="keyword1">else</span> <span class="main">(</span>False<span class="main">,</span> False<span class="main">)</span><span class="main">)</span>
      <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">pr_strict</span> <span class="var">?f</span> <span class="var">?g</span> <span class="keyword1">then</span> <span class="main">(</span>True<span class="main">,</span> True<span class="main">)</span>
        <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free">pr_weak</span> <span class="var">?f</span> <span class="var">?g</span> <span class="keyword1">then</span> lex_ext_unbounded kbo'.kbo <span class="skolem">ss</span> <span class="skolem">ts</span> <span class="keyword1">else</span> <span class="main">(</span>False<span class="main">,</span> False<span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> if_cong refl lex_ext_unbounded_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> 1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> * s t<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"pr_strict' <span class="var">?f</span> <span class="var">?g</span> <span class="main">=</span> <span class="free">pr_strict</span> <span class="var">?f</span> <span class="var">?g</span> <span class="main">∧</span> <span class="main">(</span><span class="main">¬</span> <span class="free">pr_strict</span> <span class="var">?f</span> <span class="var">?g</span> <span class="main">⟶</span> pr_weak' <span class="var">?f</span> <span class="var">?g</span> <span class="main">=</span> <span class="free">pr_weak</span> <span class="var">?f</span> <span class="var">?g</span><span class="main">)</span>"</span></span> 
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">if</span> pr_strict' <span class="var">?f</span> <span class="var">?g</span> <span class="keyword1">then</span> <span class="main">(</span>True<span class="main">,</span> True<span class="main">)</span>
        <span class="keyword1">else</span> <span class="keyword1">if</span> pr_weak' <span class="var">?f</span> <span class="var">?g</span> <span class="keyword1">then</span> lex_ext_unbounded kbo'.kbo <span class="skolem">ss</span> <span class="skolem">ts</span> <span class="keyword1">else</span> <span class="main">(</span>False<span class="main">,</span> False<span class="main">)</span><span class="main">)</span> <span class="main">=</span>
       <span class="main">(</span><span class="keyword1">if</span> <span class="free">pr_strict</span> <span class="var">?f</span> <span class="var">?g</span> <span class="keyword1">then</span> <span class="main">(</span>True<span class="main">,</span> True<span class="main">)</span>
        <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free">pr_weak</span> <span class="var">?f</span> <span class="var">?g</span> <span class="keyword1">then</span> lex_ext_unbounded kbo <span class="skolem">ss</span> <span class="skolem">ts</span> <span class="keyword1">else</span> <span class="main">(</span>False<span class="main">,</span> False<span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> notP<span class="main">:</span> False  
      <span class="keyword1"><span class="command">hence</span></span> fgC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="main">∈</span> lConsts <span class="main">∨</span> <span class="var">?g</span> <span class="main">∈</span> lConsts"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> pr_strict'_def pr_weak'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> weight<span class="main">:</span> <span class="quoted"><span class="quoted">"weight <span class="skolem">s</span> <span class="main">=</span> <span class="free">w0</span>"</span></span> <span class="quoted"><span class="quoted">"weight <span class="skolem">t</span> <span class="main">=</span> <span class="free">w0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">unfolding</span></span> lConsts_def least s t <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∧</span> <span class="skolem">ts</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> empty<span class="main">:</span> True
        <span class="keyword1"><span class="command">with</span></span> weight <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="var">?f</span> <span class="main">=</span> <span class="free">w0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="var">?g</span> <span class="main">=</span> <span class="free">w0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> s t <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> empty <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> pr_strict'_def pr_weak'_def <span class="keyword1"><span class="command">using</span></span> pr_weak_trans<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">g</span><span class="main">,</span><span class="main">0</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">f</span><span class="main">,</span><span class="main">0</span><span class="main">)</span>"</span></span><span class="main">]</span>
            pr_weak_trans<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">f</span><span class="main">,</span><span class="main">0</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">g</span><span class="main">,</span><span class="main">0</span><span class="main">)</span>"</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lConsts_def pr_strict least<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> notP <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">t</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span>term"</span></span>  <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">t1</span> <span class="skolem">ts'</span> <span class="skolem">ts</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">g</span>
          <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"weight <span class="skolem">t</span> <span class="main">=</span> <span class="free">w0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> Fun <span class="skolem">f</span> <span class="skolem">ts</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ts</span> <span class="main">=</span> <span class="skolem">t1</span> <span class="main">#</span> <span class="skolem">ts'</span>"</span></span>
          <span class="keyword1"><span class="command">from</span></span> weight_w0_unary<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
          <span class="keyword1"><span class="command">have</span></span> ts'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ts'</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">(</span><span class="skolem">f</span><span class="main">,</span><span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
          <span class="keyword1"><span class="command">from</span></span> adm<span class="main">[</span><span class="operator">OF</span> w<span class="main">]</span> ts' 
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">pr_weak</span> <span class="main">(</span><span class="skolem">f</span><span class="main">,</span> Suc <span class="main">(</span>length <span class="skolem">ts'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">g</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> unary <span class="main">=</span> this
        <span class="keyword1"><span class="command">from</span></span> fgC <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∨</span> <span class="skolem">ts</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lConsts_def least <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span>
          <span class="keyword3"><span class="command">assume</span></span> ss<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> 
          <span class="keyword1"><span class="command">with</span></span> False <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t1</span></span> <span class="skolem"><span class="skolem">ts'</span></span> <span class="keyword2"><span class="keyword">where</span></span> ts<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ts</span> <span class="main">=</span> <span class="skolem">t1</span> <span class="main">#</span> <span class="skolem">ts'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ts</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> ss ts <span class="keyword1"><span class="command">using</span></span> unary<span class="main">[</span><span class="operator">OF</span> weight<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> t ts<span class="main">]</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lex_ext_unbounded.simps pr_strict'_def lConsts_def pr_strict<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">assume</span></span> ts<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ts</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> 
          <span class="keyword1"><span class="command">with</span></span> False <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s1</span></span> <span class="skolem"><span class="skolem">ss'</span></span> <span class="keyword2"><span class="keyword">where</span></span> ss<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span> <span class="main">=</span> <span class="skolem">s1</span> <span class="main">#</span> <span class="skolem">ss'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ss</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> ss ts <span class="keyword1"><span class="command">using</span></span> unary<span class="main">[</span><span class="operator">OF</span> weight<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> s ss<span class="main">]</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lex_ext_unbounded.simps pr_strict'_def pr_weak'_def lConsts_def pr_strict<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="KBO_as_WPO">
<div class="head">
<h1>Theory KBO_as_WPO</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹A restricted equality between KBO and WPO›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The remaining difficulty to make KBO an instance of WPO is the
  different treatment of lexicographic comparisons, which is unrestricted in KBO,
  but there is a length-restriction in WPO. 
  Therefore we will only show that KBO is an instance of WPO if we compare terms with 
  bounded arity.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This restriction does however not prohibit us from lifting properties of WPO to KBO.
  For instance, for several properties one can choose a large-enough bound restriction of WPO, 
  since there are only finitely many arities occurring in a property.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> KBO_as_WPO
  <span class="keyword2"><span class="keyword">imports</span></span> 
    <a href="#WPO">WPO</a> 
    <a href="#KBO_Transformation">KBO_Transformation</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">bounded_arity</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'f</span> <span class="main">×</span> nat<span class="main">)</span>set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">bounded_arity</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span> <span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span><span class="main">.</span> <span class="bound">n</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span> 

<span class="keyword1" id="KBO_as_WPO-finite_funas_term"><span class="command">lemma</span></span> finite_funas_term<span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>funas_term <span class="free">t</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span> weight_fun <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">weight_le</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span>
  <span class="main">(</span>vars_term_ms <span class="main">(</span>SCF <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">⊆#</span> vars_term_ms <span class="main">(</span>SCF <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">∧</span> weight <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≤</span> weight <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">weight_less</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span>
  <span class="main">(</span>vars_term_ms <span class="main">(</span>SCF <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">⊆#</span> vars_term_ms <span class="main">(</span>SCF <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">∧</span> weight <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">&lt;</span> weight <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="KBO_as_WPO-weight_le_less_iff"><span class="command">lemma</span></span> weight_le_less_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"weight_le <span class="free">s</span> <span class="free">t</span> <span class="main">⟹</span> weight_less <span class="free">s</span> <span class="free">t</span> <span class="main">⟷</span> weight <span class="free">s</span> <span class="main">&lt;</span> weight <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> weight_le_def weight_less_def<span class="main">)</span>

<span class="keyword1" id="KBO_as_WPO-weight_less_iff"><span class="command">lemma</span></span> weight_less_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"weight_less <span class="free">s</span> <span class="free">t</span> <span class="main">⟹</span> weight_le <span class="free">s</span> <span class="free">t</span> <span class="main">∧</span> weight <span class="free">s</span> <span class="main">&lt;</span> weight <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> weight_le_def weight_less_def<span class="main">)</span>


<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">weight_NS</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">.</span> weight_le <span class="bound">s</span> <span class="bound">t</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">weight_S</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">.</span> weight_less <span class="bound">s</span> <span class="bound">t</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="KBO_as_WPO-weight_le_mono_one"><span class="command">lemma</span></span> weight_le_mono_one<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"weight_le <span class="free">s</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"weight_le <span class="main">(</span>Fun <span class="free">f</span> <span class="main">(</span><span class="free">ss1</span> <span class="main">@</span> <span class="free">s</span> <span class="main">#</span> <span class="free">ss2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Fun <span class="free">f</span> <span class="main">(</span><span class="free">ss1</span> <span class="main">@</span> <span class="free">t</span> <span class="main">#</span> <span class="free">ss2</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"weight_le <span class="var">?s</span> <span class="var">?t</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> S <span class="keyword1"><span class="command">have</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"weight <span class="free">s</span> <span class="main">≤</span> weight <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"vars_term_ms <span class="main">(</span>SCF <span class="free">s</span><span class="main">)</span> <span class="main">⊆#</span> vars_term_ms <span class="main">(</span>SCF <span class="free">t</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> weight_le_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> v'<span class="main">:</span> <span class="quoted"><span class="quoted">"vars_term_ms <span class="main">(</span>SCF <span class="var">?s</span><span class="main">)</span> <span class="main">⊆#</span> vars_term_ms <span class="main">(</span>SCF <span class="var">?t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> mset_replicate_mono<span class="main">[</span><span class="operator">OF</span> v<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> w'<span class="main">:</span> <span class="quoted"><span class="quoted">"weight <span class="var">?s</span> <span class="main">≤</span> weight <span class="var">?t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sum_list_replicate_mono<span class="main">[</span><span class="operator">OF</span> w<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> v' w' <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> weight_le_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="KBO_as_WPO-weight_le_ctxt"><span class="command">lemma</span></span> weight_le_ctxt<span class="main">:</span> <span class="quoted"><span class="quoted">"weight_le <span class="free">s</span> <span class="free">t</span> <span class="main">⟹</span> weight_le <span class="main">(</span><span class="free">C</span><span class="main">⟨</span><span class="free">s</span><span class="main">⟩</span><span class="main">)</span> <span class="main">(</span><span class="free">C</span><span class="main">⟨</span><span class="free">t</span><span class="main">⟩</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">C</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> weight_le_mono_one<span class="main">)</span>

<span class="keyword1" id="KBO_as_WPO-SCF_stable"><span class="command">lemma</span></span> SCF_stable<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"vars_term_ms <span class="main">(</span>SCF <span class="free">s</span><span class="main">)</span> <span class="main">⊆#</span> vars_term_ms <span class="main">(</span>SCF <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"vars_term_ms <span class="main">(</span>SCF <span class="main">(</span><span class="free">s</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆#</span> vars_term_ms <span class="main">(</span>SCF <span class="main">(</span><span class="free">t</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> scf_term_subst
  <span class="keyword1"><span class="command">using</span></span> vars_term_ms_subst_mono<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="KBO_as_WPO-SN_weight_S"><span class="command">lemma</span></span> SN_weight_S<span class="main">:</span> <span class="quoted"><span class="quoted">"SN weight_S"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> wf_inv_image<span class="main">[</span><span class="operator">OF</span> wf_less<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">t</span><span class="main">)</span><span class="main">.</span> weight <span class="bound">s</span> <span class="main">&lt;</span> weight <span class="bound">t</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inv_image_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> SN_iff_wf<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> wf_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> weight_less_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="KBO_as_WPO-weight_less_imp_le"><span class="command">lemma</span></span> weight_less_imp_le<span class="main">:</span> <span class="quoted"><span class="quoted">"weight_less <span class="free">s</span> <span class="free">t</span> <span class="main">⟹</span> weight_le <span class="free">s</span> <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> weight_less_def weight_le_def<span class="main">)</span>

<span class="keyword1" id="KBO_as_WPO-weight_le_Var_Var"><span class="command">lemma</span></span> weight_le_Var_Var<span class="main">:</span> <span class="quoted"><span class="quoted">"weight_le <span class="main">(</span>Var <span class="free">x</span><span class="main">)</span> <span class="main">(</span>Var <span class="free">y</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> weight_le_def<span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> kbo <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="KBO_as_WPO-kbo_altdef"><span class="command">lemma</span></span> kbo_altdef<span class="main">:</span>
    <span class="quoted"><span class="quoted">"kbo <span class="free">s</span> <span class="free">t</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> weight_le <span class="free">t</span> <span class="free">s</span>
      <span class="keyword1">then</span> <span class="keyword1">if</span> weight_less <span class="free">t</span> <span class="free">s</span>
        <span class="keyword1">then</span> <span class="main">(</span>True<span class="main">,</span> True<span class="main">)</span>
        <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">s</span> <span class="keyword1">of</span>
          Var <span class="bound">y</span> <span class="main">⇒</span> <span class="main">(</span>False<span class="main">,</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">t</span> <span class="keyword1">of</span> Var <span class="bound">x</span> <span class="main">⇒</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">y</span> <span class="main">|</span> Fun <span class="bound">g</span> <span class="bound">ts</span> <span class="main">⇒</span> <span class="bound">ts</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∧</span> <span class="free">least</span> <span class="bound">g</span><span class="main">)</span><span class="main">)</span>
        <span class="main">|</span> Fun <span class="bound">f</span> <span class="bound">ss</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">t</span> <span class="keyword1">of</span>
            Var <span class="bound">x</span> <span class="main">⇒</span> <span class="main">(</span>True<span class="main">,</span> True<span class="main">)</span>
          <span class="main">|</span> Fun <span class="bound">g</span> <span class="bound">ts</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="free">pr_strict</span> <span class="main">(</span><span class="bound">f</span><span class="main">,</span> length <span class="bound">ss</span><span class="main">)</span> <span class="main">(</span><span class="bound">g</span><span class="main">,</span> length <span class="bound">ts</span><span class="main">)</span>
            <span class="keyword1">then</span> <span class="main">(</span>True<span class="main">,</span> True<span class="main">)</span>
            <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free">pr_weak</span> <span class="main">(</span><span class="bound">f</span><span class="main">,</span> length <span class="bound">ss</span><span class="main">)</span> <span class="main">(</span><span class="bound">g</span><span class="main">,</span> length <span class="bound">ts</span><span class="main">)</span>
            <span class="keyword1">then</span> lex_ext_unbounded kbo <span class="bound">ss</span> <span class="bound">ts</span>
            <span class="keyword1">else</span> <span class="main">(</span>False<span class="main">,</span> False<span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="keyword1">else</span> <span class="main">(</span>False<span class="main">,</span> False<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> weight_le_less_iff weight_le_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> admissible_kbo <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="KBO_as_WPO-weight_le_stable"><span class="command">lemma</span></span> weight_le_stable<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"weight_le <span class="free">s</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"weight_le <span class="main">(</span><span class="free">s</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span> <span class="main">(</span><span class="free">t</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms weight_stable_le SCF_stable <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> weight_le_def<span class="main">)</span>

<span class="keyword1" id="KBO_as_WPO-weight_less_stable"><span class="command">lemma</span></span> weight_less_stable<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"weight_less <span class="free">s</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"weight_less <span class="main">(</span><span class="free">s</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span> <span class="main">(</span><span class="free">t</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms weight_stable_lt SCF_stable <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> weight_less_def<span class="main">)</span>

<span class="keyword1" id="KBO_as_WPO-simple_arg_pos_weight"><span class="command">lemma</span></span> simple_arg_pos_weight<span class="main">:</span> <span class="quoted"><span class="quoted">"simple_arg_pos weight_NS <span class="main">(</span><span class="free">f</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> simple_arg_pos_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> snd_conv fst_conv<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span>term list"</span></span> 
  <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">ts</span> <span class="main">=</span> <span class="free">n</span>"</span></span> 
  <span class="keyword1"><span class="command">from</span></span> id_take_nth_drop<span class="main">[</span><span class="operator">OF</span> i<span class="main"><span class="main">[</span></span><span class="operator">folded</span> len<span class="main"><span class="main">]</span></span><span class="main">]</span> i<span class="main">[</span><span class="operator">folded</span> len<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">us</span></span> <span class="skolem"><span class="skolem">vs</span></span> <span class="keyword2"><span class="keyword">where</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"Fun <span class="free">f</span> <span class="skolem">ts</span> <span class="main">=</span> Fun <span class="free">f</span> <span class="main">(</span><span class="skolem">us</span> <span class="main">@</span> <span class="skolem">ts</span> <span class="main">!</span> <span class="free">i</span> <span class="main">#</span> <span class="skolem">vs</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> us<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">us</span> <span class="main">=</span> take <span class="free">i</span> <span class="skolem">ts</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">us</span> <span class="main">=</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">us</span> <span class="main">&lt;</span> Suc <span class="main">(</span>length <span class="skolem">us</span> <span class="main">+</span> length <span class="skolem">vs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> scf<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">scf</span> <span class="main">(</span><span class="free">f</span><span class="main">,</span> Suc <span class="main">(</span>length <span class="skolem">us</span> <span class="main">+</span> length <span class="skolem">vs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">us</span><span class="main">)</span> <span class="main">=</span> Suc <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lessE<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Fun <span class="free">f</span> <span class="skolem">ts</span><span class="main">,</span> <span class="skolem">ts</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> weight_NS"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> weight_le_def id <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="KBO_as_WPO-weight_lemmas"><span class="command">lemma</span></span> weight_lemmas<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"refl weight_NS"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"trans weight_NS"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"trans weight_S"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"weight_NS <span class="keyword1">O</span> weight_S <span class="main">⊆</span> weight_S"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"weight_S <span class="keyword1">O</span> weight_NS <span class="main">⊆</span> weight_S"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> refl_onI transI <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> weight_le_def weight_less_def<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> kbo'<span class="main">:</span> admissible_kbo <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">w0</span></span> <span class="quoted">pr_strict'</span> <span class="quoted">pr_weak'</span> <span class="quoted"><span class="free">least</span></span> <span class="quoted"><span class="free">scf</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> admissible_kbo'<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> least_global<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">f</span> <span class="bound">g</span><span class="main">.</span> <span class="free">least</span> <span class="bound">f</span> <span class="main">⟹</span> <span class="free">pr_weak</span> <span class="bound">g</span> <span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> least_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">f</span> <span class="bound">g</span><span class="main">.</span> <span class="free">least</span> <span class="bound">f</span> <span class="main">⟹</span> <span class="free">pr_weak</span> <span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="bound">g</span> <span class="main">⟹</span> <span class="free">least</span> <span class="main">(</span>fst <span class="bound">g</span><span class="main">)</span> <span class="main">∧</span> snd <span class="bound">g</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="KBO_as_WPO-kbo_instance_of_wpo_with_assms"><span class="command">lemma</span></span> kbo_instance_of_wpo_with_assms<span class="main">:</span> <span class="quoted"><span class="quoted">"wpo_with_assms 
  weight_S weight_NS <span class="main">(</span><span class="main">λ</span><span class="bound">f</span> <span class="bound">g</span><span class="main">.</span> <span class="main">(</span><span class="free">pr_strict</span> <span class="bound">f</span> <span class="bound">g</span><span class="main">,</span> <span class="free">pr_weak</span> <span class="bound">f</span> <span class="bound">g</span><span class="main">)</span><span class="main">)</span>
     <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span><span class="main">.</span> <span class="bound">n</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">least</span> <span class="bound">f</span><span class="main">)</span> full_status False <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> False<span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>
                      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> weight_lemmas SN_weight_S pr_SN pr_strict_irrefl
      weight_less_stable weight_le_stable weight_le_mono_one weight_less_imp_le
      simple_arg_pos_weight<span class="main">)</span>
                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> least_global least_trans <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pr_strict<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pr_strict least <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>pr_weak_trans<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">interpretation</span></span> wpo<span class="main">:</span> wpo_with_assms
  <span class="keyword2"><span class="keyword">where</span></span> S <span class="main">=</span> <span class="quoted">weight_S</span> <span class="keyword2"><span class="keyword">and</span></span> NS <span class="main">=</span> <span class="quoted">weight_NS</span>
    <span class="keyword2"><span class="keyword">and</span></span> prc <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">f</span> <span class="bound">g</span><span class="main">.</span> <span class="main">(</span><span class="free">pr_strict</span> <span class="bound">f</span> <span class="bound">g</span><span class="main">,</span> <span class="free">pr_weak</span> <span class="bound">f</span> <span class="bound">g</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> prl <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span><span class="main">.</span> <span class="bound">n</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">least</span> <span class="bound">f</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> c <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> Lex"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ssimple <span class="main">=</span> <span class="quoted">False</span> <span class="keyword2"><span class="keyword">and</span></span> large <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">f</span><span class="main">.</span> False"</span></span> <span class="keyword2"><span class="keyword">and</span></span> σσ <span class="main">=</span> <span class="quoted">full_status</span>
    <span class="keyword2"><span class="keyword">and</span></span> n <span class="main">=</span> <span class="quoted"><span class="free">n</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> kbo_instance_of_wpo_with_assms<span class="main">)</span>

<span class="keyword1" id="KBO_as_WPO-kbo_as_wpo_with_assms"><span class="command">lemma</span></span> kbo_as_wpo_with_assms<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bounded_arity <span class="free">n</span> <span class="main">(</span>funas_term <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"kbo <span class="free">s</span> <span class="free">t</span> <span class="main">=</span> wpo.wpo <span class="free">s</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> size <span class="free">s</span> <span class="main">+</span> size <span class="free">t</span>"</span></span> 
  <span class="keyword1"><span class="command">from</span></span> m_def assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">m</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">m</span> <span class="skolem">s</span> <span class="skolem">t</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="skolem">si</span> <span class="main">+</span> size <span class="skolem">ti</span> <span class="main">&lt;</span> size <span class="skolem">s</span> <span class="main">+</span> size <span class="skolem">t</span> <span class="main">⟹</span> bounded_arity <span class="free">n</span> <span class="main">(</span>funas_term <span class="skolem">ti</span><span class="main">)</span> <span class="main">⟹</span> kbo <span class="skolem">si</span> <span class="skolem">ti</span> <span class="main">=</span> wpo.wpo <span class="skolem">si</span> <span class="skolem">ti</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">si</span> <span class="skolem">ti</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span>term"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">note</span></span> wpo_sI <span class="main">=</span> arg_cong<span class="main">[</span><span class="operator">OF</span> wpo.wpo.simps<span class="main">,</span> <span class="operator">of</span> <span class="quoted">fst</span><span class="main">,</span> <span class="operator">THEN</span> iffD2<span class="main">]</span>
    <span class="keyword1"><span class="command">note</span></span> wpo_nsI <span class="main">=</span> arg_cong<span class="main">[</span><span class="operator">OF</span> wpo.wpo.simps<span class="main">,</span> <span class="operator">of</span> <span class="quoted">snd</span><span class="main">,</span> <span class="operator">THEN</span> iffD2<span class="main">]</span>
    <span class="keyword1"><span class="command">note</span></span> bounded <span class="main">=</span> less<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> s<span class="main">:</span> <span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> weight_less <span class="skolem">t</span> <span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> leD weight.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> weight_le_less_iff weight_less_imp_le weight_w0<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> s kbo_altdef wpo.wpo.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> weight_le_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> s<span class="main">:</span> <span class="main">(</span>Fun <span class="skolem">f</span> <span class="skolem">ss</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> t<span class="main">:</span> <span class="main">(</span>Var <span class="skolem">y</span><span class="main">)</span>
        <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"weight_le <span class="skolem">t</span> <span class="skolem">s</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s'</span> <span class="main">∈</span> set <span class="skolem">ss</span><span class="main">.</span> weight_le <span class="skolem">t</span> <span class="bound">s'</span>"</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> s t weight_le_def<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> scf set_scf_list weight_w0<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="keyword2"><span class="keyword">where</span></span> s'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s'</span> <span class="main">∈</span> set <span class="skolem">ss</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"weight_le <span class="skolem">t</span> <span class="skolem">s'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wpo.wpo_ns <span class="skolem">s'</span> <span class="skolem">t</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">s'</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>wpo_nsI <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> t weight_le_Var_Var<span class="main">)</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Fun <span class="skolem">f'</span> <span class="skolem">ss'</span><span class="main">)</span>
            <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s''</span> <span class="main">∈</span> set <span class="skolem">ss'</span><span class="main">.</span> weight_le <span class="skolem">t</span> <span class="bound">s''</span>"</span></span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> t weight_le_def<span class="main">)</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> scf set_scf_list weight_w0<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s''</span> <span class="main">∈</span> set <span class="skolem">ss'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"weight_le <span class="skolem">t</span> <span class="skolem">s''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">with</span></span> Fun<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> Fun<span class="main">(</span>2<span class="main">)</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wpo_nsI <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> t in_set_conv_nth<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">with</span></span> s' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s'</span> <span class="main">∈</span> set <span class="skolem">ss</span><span class="main">.</span> wpo.wpo_ns <span class="bound">s'</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">then</span></span> 
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> wpo.wpo.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span> kbo_altdef<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> s t weight_less_iff set_conv_nth<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> t<span class="main">:</span> <span class="main">(</span>Fun <span class="skolem">g</span> <span class="skolem">ts</span><span class="main">)</span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="skolem">ts</span>"</span></span> 
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ts</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">∈</span> set <span class="skolem">ts</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"funas_term <span class="main">(</span><span class="skolem">ts</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">⊆</span> funas_term <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> t <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">with</span></span> bounded <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bounded_arity <span class="free">n</span> <span class="main">(</span>funas_term <span class="main">(</span><span class="skolem">ts</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> bounded_arity_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> bounded_tj <span class="main">=</span> this
        <span class="keyword1"><span class="command">note</span></span> IH_tj <span class="main">=</span> IH<span class="main">[</span><span class="operator">OF</span> _ this<span class="main">]</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> weight_le <span class="skolem">t</span> <span class="skolem">s</span> <span class="main">∨</span> weight_less <span class="skolem">t</span> <span class="skolem">s</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True  
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> wpo.wpo.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span> kbo_altdef<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span>
            <span class="keyword1"><span class="command">unfolding</span></span> s t <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> weight_less_iff<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">f</span><span class="main">,</span>length <span class="skolem">ss</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">g</span><span class="main">,</span>length <span class="skolem">ts</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">from</span></span> False <span class="keyword1"><span class="command">have</span></span> wle<span class="main">:</span> <span class="quoted"><span class="quoted">"weight_le <span class="skolem">t</span> <span class="skolem">s</span> <span class="main">=</span> True"</span></span> <span class="quoted"><span class="quoted">"weight_less <span class="skolem">t</span> <span class="skolem">s</span> <span class="main">=</span> False"</span></span> 
            <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> weight_NS <span class="main">⟷</span> True"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> weight_S <span class="main">⟷</span> False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> lex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Lex <span class="main">=</span> Lex <span class="main">∧</span> Lex <span class="main">=</span> Lex<span class="main">)</span> <span class="main">=</span> True"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">have</span></span> sig<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>wpo.σ <span class="var">?f</span><span class="main">)</span> <span class="main">=</span> <span class="main">{..&lt;</span>length <span class="skolem">ss</span><span class="main">}</span>"</span></span>
            <span class="quoted"><span class="quoted">"set <span class="main">(</span>wpo.σ <span class="var">?g</span><span class="main">)</span> <span class="main">=</span> <span class="main">{..&lt;</span>length <span class="skolem">ts</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> map<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">(!)</span> <span class="skolem">ss</span><span class="main">)</span> <span class="main">(</span>wpo.σ <span class="var">?f</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">ss</span>"</span></span>
            <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">(!)</span> <span class="skolem">ts</span><span class="main">)</span> <span class="main">(</span>wpo.σ <span class="var">?g</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">ts</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_nth<span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> sizes<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">ss</span> <span class="main">⟹</span> size <span class="main">(</span><span class="skolem">ss</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">&lt;</span> size <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="keyword1"><span class="command">unfolding</span></span> s
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> size_simp1<span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> sizet<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">ts</span> <span class="main">⟹</span> size <span class="main">(</span><span class="skolem">ts</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">&lt;</span> size <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="keyword1"><span class="command">unfolding</span></span> t
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> size_simp1<span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> wpo<span class="main">:</span> <span class="quoted"><span class="quoted">"wpo.wpo <span class="skolem">s</span> <span class="skolem">t</span> <span class="main">=</span> 
             <span class="main">(</span><span class="keyword1">if</span> <span class="main">∃</span><span class="bound">i</span><span class="main">∈</span><span class="main">{..&lt;</span>length <span class="skolem">ss</span><span class="main">}</span><span class="main">.</span> wpo.wpo_ns <span class="main">(</span><span class="skolem">ss</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">t</span> <span class="keyword1">then</span> <span class="main">(</span>True<span class="main">,</span> True<span class="main">)</span>
              <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free">pr_weak</span> <span class="var">?f</span> <span class="var">?g</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">j</span><span class="main">∈</span><span class="main">{..&lt;</span>length <span class="skolem">ts</span><span class="main">}</span><span class="main">.</span> wpo.wpo_s <span class="skolem">s</span> <span class="main">(</span><span class="skolem">ts</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>
              <span class="keyword1">then</span> <span class="keyword1">if</span> <span class="free">pr_strict</span> <span class="var">?f</span> <span class="var">?g</span> <span class="keyword1">then</span> <span class="main">(</span>True<span class="main">,</span> True<span class="main">)</span> <span class="keyword1">else</span> lex_ext wpo.wpo <span class="free">n</span> <span class="skolem">ss</span> <span class="skolem">ts</span>
              <span class="keyword1">else</span> <span class="main">(</span>False<span class="main">,</span> False<span class="main">)</span><span class="main">)</span>"</span></span> 
            <span class="keyword1"><span class="command">unfolding</span></span> wpo.wpo.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span>
            <span class="keyword1"><span class="command">unfolding</span></span> s t term.simps split Let_def lex if_True sig map
            <span class="keyword1"><span class="command">unfolding</span></span> s<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> t<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> wle if_True weight_less_iff if_False False snd_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"kbo <span class="skolem">s</span> <span class="skolem">t</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">pr_strict</span> <span class="var">?f</span> <span class="var">?g</span> <span class="keyword1">then</span> <span class="main">(</span>True<span class="main">,</span> True<span class="main">)</span>
               <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free">pr_weak</span> <span class="var">?f</span> <span class="var">?g</span> <span class="keyword1">then</span> lex_ext_unbounded kbo <span class="skolem">ss</span> <span class="skolem">ts</span>
               <span class="keyword1">else</span> <span class="main">(</span>False<span class="main">,</span> False<span class="main">)</span><span class="main">)</span>"</span></span> 
            <span class="keyword1"><span class="command">unfolding</span></span> kbo_altdef<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span>
            <span class="keyword1"><span class="command">unfolding</span></span> s t term.simps split Let_def if_True 
            <span class="keyword1"><span class="command">unfolding</span></span> s<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> t<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> wle if_True weight_less_iff if_False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lex_ext_unbounded kbo <span class="skolem">ss</span> <span class="skolem">ts</span> <span class="main">=</span> lex_ext kbo <span class="free">n</span> <span class="skolem">ss</span> <span class="skolem">ts</span>"</span></span> 
            <span class="keyword1"><span class="command">using</span></span> bounded<span class="main">[</span><span class="operator">unfolded</span> t<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> bounded_arity_def lex_ext_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> lex_ext wpo.wpo <span class="free">n</span> <span class="skolem">ss</span> <span class="skolem">ts</span>"</span></span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lex_ext_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl refl refl<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> IH_tj<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sizes sizet<span class="main">)</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> kbo<span class="main">:</span> <span class="quoted"><span class="quoted">"kbo <span class="skolem">s</span> <span class="skolem">t</span> <span class="main">=</span>
              <span class="main">(</span><span class="keyword1">if</span> <span class="free">pr_strict</span> <span class="var">?f</span> <span class="var">?g</span> <span class="keyword1">then</span> <span class="main">(</span>True<span class="main">,</span> True<span class="main">)</span>
               <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free">pr_weak</span> <span class="var">?f</span> <span class="var">?g</span> <span class="keyword1">then</span> lex_ext wpo.wpo <span class="free">n</span> <span class="skolem">ss</span> <span class="skolem">ts</span>
               <span class="keyword1">else</span> <span class="main">(</span>False<span class="main">,</span> False<span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">∈</span><span class="main">{..&lt;</span>length <span class="skolem">ss</span><span class="main">}</span><span class="main">.</span> wpo.wpo_ns <span class="main">(</span><span class="skolem">ss</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">t</span>"</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> True
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">ss</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"wpo.wpo_ns <span class="main">(</span><span class="skolem">ss</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"wpo.wpo <span class="main">(</span><span class="skolem">ss</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">b</span><span class="main">,</span> True<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"wpo.wpo <span class="main">(</span><span class="skolem">ss</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">t</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
            <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wpo.wpo <span class="main">(</span><span class="skolem">ss</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">=</span> kbo <span class="main">(</span><span class="skolem">ss</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> IH<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ bounded<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> sizes<span class="main">)</span>
            <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"NS <span class="main">(</span><span class="skolem">ss</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">from</span></span> kbo_supt_one<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"S <span class="main">(</span>Fun <span class="skolem">f</span> <span class="main">(</span>take <span class="skolem">i</span> <span class="skolem">ss</span> <span class="main">@</span> <span class="skolem">ss</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">#</span> drop <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="skolem">ss</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
            <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>take <span class="skolem">i</span> <span class="skolem">ss</span> <span class="main">@</span> <span class="skolem">ss</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">#</span> drop <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="skolem">ss</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">ss</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> id_take_nth_drop<span class="main">)</span>
            <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Fun <span class="skolem">f</span> <span class="skolem">ss</span> <span class="main">=</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> s <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"S <span class="skolem">s</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
            <span class="keyword1"><span class="command">with</span></span> S_imp_NS<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"kbo <span class="skolem">s</span> <span class="skolem">t</span> <span class="main">=</span> <span class="main">(</span>True<span class="main">,</span>True<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"kbo <span class="skolem">s</span> <span class="skolem">t</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> 
            <span class="keyword1"><span class="command">with</span></span> True <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> wpo <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> False
            <span class="keyword1"><span class="command">hence</span></span> False<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">∈</span><span class="main">{..&lt;</span>length <span class="skolem">ss</span><span class="main">}</span><span class="main">.</span> wpo.wpo_ns <span class="main">(</span><span class="skolem">ss</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">{</span></span>
              <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
              <span class="keyword3"><span class="command">assume</span></span> NS<span class="main">:</span> <span class="quoted"><span class="quoted">"NS <span class="skolem">s</span> <span class="skolem">t</span>"</span></span> 
              <span class="keyword3"><span class="command">assume</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="skolem">ts</span>"</span></span> 
              <span class="comment1">(* here we make use of proven properties of KBO: subterm-property and transitivity,
                 perhaps there is a simple proof without already using these properties *)</span>
              <span class="keyword1"><span class="command">from</span></span> kbo_supt_one<span class="main">[</span><span class="operator">OF</span> NS_refl<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">g</span></span> <span class="quoted"><span class="quoted">"take <span class="skolem">j</span> <span class="skolem">ts</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ts</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span> <span class="quoted"><span class="quoted">"drop <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> <span class="skolem">ts</span>"</span></span><span class="main">]</span>
              <span class="keyword1"><span class="command">have</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"S <span class="skolem">t</span> <span class="main">(</span><span class="skolem">ts</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> id_take_nth_drop<span class="main">[</span><span class="operator">OF</span> j<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> t <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">from</span></span> kbo_trans<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ts</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span><span class="main">]</span> NS S <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"S <span class="skolem">s</span> <span class="main">(</span><span class="skolem">ts</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">with</span></span> S S_imp_NS<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"kbo <span class="skolem">s</span> <span class="main">(</span><span class="skolem">ts</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>True<span class="main">,</span> True<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"kbo <span class="skolem">s</span> <span class="main">(</span><span class="skolem">ts</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
              <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"wpo.wpo_s <span class="skolem">s</span> <span class="main">(</span><span class="skolem">ts</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> 
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> IH_tj<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> sizet<span class="main"><span class="main">[</span></span><span class="operator">OF</span> j<span class="main"><span class="main">]</span></span> j<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
            <span class="keyword1"><span class="command">}</span></span>
            <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> wpo kbo False if_False <span class="keyword1"><span class="command">using</span></span> lex_ext_stri_imp_nstri<span class="main">[</span><span class="operator">of</span> <span class="quoted">wpo.wpo</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="skolem">ss</span></span> <span class="quoted"><span class="skolem">ts</span></span><span class="main">]</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"lex_ext wpo.wpo <span class="free">n</span> <span class="skolem">ss</span> <span class="skolem">ts</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pr_strict <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This is the main theorem. It tells us that KBO can be seen as an instance of WPO, under mild preconditions:
  the parameter $n$ for the lexicographic extension has to be chosen high enough to cover the arities of all 
  terms that should be compared.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">prec</span> <span class="main">≡</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">f</span> <span class="bound">g</span><span class="main">.</span> <span class="main">(</span>pr_strict' <span class="bound">f</span> <span class="bound">g</span><span class="main">,</span> pr_weak' <span class="bound">f</span> <span class="bound">g</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">prl</span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span><span class="main">.</span> <span class="bound">n</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">least</span> <span class="bound">f</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> 
    kbo_encoding_is_valid_wpo<span class="main">:</span> <span class="quoted"><span class="quoted">"wpo_with_assms weight_S weight_NS <span class="free">prec</span> <span class="free">prl</span> full_status False <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> False<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> 
    kbo_as_wpo<span class="main">:</span> <span class="quoted"><span class="quoted">"bounded_arity <span class="free">n</span> <span class="main">(</span>funas_term <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span> kbo <span class="free">s</span> <span class="free">t</span> <span class="main">=</span> wpo.wpo <span class="free">n</span> weight_S weight_NS <span class="free">prec</span> <span class="free">prl</span> full_status <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> Lex<span class="main">)</span> False <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> False<span class="main">)</span> <span class="free">s</span> <span class="free">t</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> prec_def prl_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> admissible_kbo.kbo_instance_of_wpo_with_assms<span class="main"><span class="main">[</span></span><span class="operator">OF</span> admissible_kbo'<span class="main"><span class="main">]</span></span> 
        least_pr_weak' least_pr_weak'_trans<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> kbo'_eq_kbo<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> admissible_kbo.kbo_as_wpo_with_assms<span class="main"><span class="main">[</span></span><span class="operator">OF</span> admissible_kbo' least_pr_weak' least_pr_weak'_trans<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>3<span class="main"><span class="keyword3">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹As a proof-of-concept we show that now properties of WPO can be used to prove these properties for KBO.
  Here, as example we consider closure under substitutions and strong normalization, 
  but the following idea can be applied for several more properties:
  if the property involves only terms where the arities are bounded, then just choose the parameter $n$ large enough.
  This even works for strong normalization, since in an infinite chain of KBO-decreases $t_1 &gt; t_2 &gt; t_3 &gt; ...$ all terms have
  a weight of at most the weight of $t_1$, and this weight is also a bound on the arities.›</span></span>

<span class="keyword1" id="KBO_as_WPO-KBO_stable_via_WPO"><span class="command">lemma</span></span> KBO_stable_via_WPO<span class="main">:</span> <span class="quoted"><span class="quoted">"S <span class="free">s</span> <span class="free">t</span> <span class="main">⟹</span> S <span class="main">(</span><span class="free">s</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">σ</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'f</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> subst<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">t</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?terms</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">t</span><span class="main">,</span> <span class="free">t</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">}</span>"</span></span> <span class="comment1">(* collect all rhss of comparisons *)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?prec</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">f</span> <span class="bound">g</span><span class="main">.</span> <span class="main">(</span>pr_strict' <span class="bound">f</span> <span class="bound">g</span><span class="main">,</span> pr_weak' <span class="bound">f</span> <span class="bound">g</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?prl</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span><span class="main">.</span> <span class="bound">n</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">least</span> <span class="bound">f</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span>funas_term <span class="main">`</span> <span class="var">?terms</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> finite_list<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">F</span></span> <span class="keyword2"><span class="keyword">where</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">F</span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">(</span>funas_term <span class="main">`</span> <span class="var">?terms</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="comment1">(* since there only finitely many symbols, we can take n as the maximal arity *)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> max_list <span class="main">(</span>map snd <span class="skolem">F</span><span class="main">)</span>"</span></span> 

  <span class="comment1">(* now get a WPO for this choice of n *)</span>
  <span class="keyword1"><span class="command">interpret</span></span> wpo<span class="main">:</span> wpo_with_assms
  <span class="keyword2"><span class="keyword">where</span></span> S <span class="main">=</span> <span class="quoted">weight_S</span> <span class="keyword2"><span class="keyword">and</span></span> NS <span class="main">=</span> <span class="quoted">weight_NS</span>
    <span class="keyword2"><span class="keyword">and</span></span> prc <span class="main">=</span> <span class="var"><span class="quoted"><span class="var">?prec</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> prl <span class="main">=</span> <span class="var"><span class="quoted"><span class="var">?prl</span></span></span>
    <span class="keyword2"><span class="keyword">and</span></span> c <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> Lex"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ssimple <span class="main">=</span> <span class="quoted">False</span> <span class="keyword2"><span class="keyword">and</span></span> large <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">f</span><span class="main">.</span> False"</span></span> <span class="keyword2"><span class="keyword">and</span></span> σσ <span class="main">=</span> <span class="quoted">full_status</span>
    <span class="keyword2"><span class="keyword">and</span></span> n <span class="main">=</span> <span class="quoted"><span class="skolem">n</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> kbo_encoding_is_valid_wpo<span class="main">)</span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> <span class="var">?terms</span>"</span></span> 
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"funas_term <span class="skolem">t</span> <span class="main">⊆</span> set <span class="skolem">F</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"bounded_arity <span class="skolem">n</span> <span class="main">(</span>funas_term <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> bounded_arity_def 
      <span class="keyword1"><span class="command">using</span></span> max_list<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"map snd <span class="skolem">F</span>"</span></span><span class="main">,</span> <span class="operator">folded</span> n_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="comment1">(* for all the terms we have that KBO = WPO *)</span>
  <span class="keyword1"><span class="command">note</span></span> kbo_as_wpo <span class="main">=</span> kbo_as_wpo<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>

  <span class="comment1">(* and finally transfer the existing property of WPO to KBO *)</span>
  <span class="keyword1"><span class="command">from</span></span> wpo.WPO_S_subst<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">σ</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"S <span class="free">s</span> <span class="free">t</span> <span class="main">⟹</span> S <span class="main">(</span><span class="free">s</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span> <span class="main">(</span><span class="free">t</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> kbo_as_wpo <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="KBO_as_WPO-weight_is_arity_bound"><span class="command">lemma</span></span> weight_is_arity_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"weight <span class="free">t</span> <span class="main">≤</span> <span class="free">b</span> <span class="main">⟹</span> bounded_arity <span class="free">b</span> <span class="main">(</span>funas_term <span class="free">t</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Fun <span class="skolem">f</span> <span class="skolem">ts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span>map weight <span class="skolem">ts</span><span class="main">)</span> <span class="main">≤</span> weight <span class="main">(</span>Fun <span class="skolem">f</span> <span class="skolem">ts</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> sum_list_scf_list<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">ts</span></span> <span class="quoted"><span class="quoted">"<span class="free">scf</span> <span class="main">(</span><span class="skolem">f</span><span class="main">,</span>length <span class="skolem">ts</span><span class="main">)</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> scf<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Fun <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> sum_b<span class="main">:</span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span>map weight <span class="skolem">ts</span><span class="main">)</span> <span class="main">≤</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span>
    <span class="keyword3"><span class="command">assume</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> set <span class="skolem">ts</span>"</span></span> 
    <span class="keyword1"><span class="command">from</span></span> split_list<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"weight <span class="skolem">t</span> <span class="main">≤</span> sum_list <span class="main">(</span>map weight <span class="skolem">ts</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> sum_b <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bounded_arity <span class="free">b</span> <span class="main">(</span>funas_term <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> t Fun <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> this
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">ts</span> <span class="main">=</span> sum_list <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">ts</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">ts</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> sum_list <span class="main">(</span>map weight <span class="skolem">ts</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sum_list_mono<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> t <span class="keyword1"><span class="command">using</span></span> weight_gt_0<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">ts</span> <span class="main">≤</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> IH len <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> bounded_arity_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bounded_arity_def<span class="main">)</span>
  
<span class="keyword1" id="KBO_as_WPO-KBO_SN_via_WPO"><span class="command">lemma</span></span> KBO_SN_via_WPO<span class="main">:</span> <span class="quoted"><span class="quoted">"SN <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">t</span><span class="main">)</span><span class="main">.</span> S <span class="bound">s</span> <span class="bound">t</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> 
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'f</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span>term"</span></span> 
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">i</span><span class="main">,</span> <span class="skolem">f</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> S <span class="bound">s</span> <span class="bound">t</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">hence</span></span> steps<span class="main">:</span> <span class="quoted"><span class="quoted">"S <span class="main">(</span><span class="skolem">f</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> weight <span class="main">(</span><span class="skolem">f</span> <span class="main">0</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> w_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"weight <span class="main">(</span><span class="skolem">f</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> steps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"weight <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> weight <span class="main">(</span><span class="skolem">f</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> kbo.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">i</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> Suc <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> n_def<span class="main">)</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?prec</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">f</span> <span class="bound">g</span><span class="main">.</span> <span class="main">(</span>pr_strict' <span class="bound">f</span> <span class="bound">g</span><span class="main">,</span> pr_weak' <span class="bound">f</span> <span class="bound">g</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?prl</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span><span class="main">.</span> <span class="bound">n</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">least</span> <span class="bound">f</span><span class="main">)</span>"</span></span> 

  <span class="comment1">(* now get a WPO for this choice of n *)</span>
  <span class="keyword1"><span class="command">interpret</span></span> wpo<span class="main">:</span> wpo_with_assms
  <span class="keyword2"><span class="keyword">where</span></span> S <span class="main">=</span> <span class="quoted">weight_S</span> <span class="keyword2"><span class="keyword">and</span></span> NS <span class="main">=</span> <span class="quoted">weight_NS</span>
    <span class="keyword2"><span class="keyword">and</span></span> prc <span class="main">=</span> <span class="var"><span class="quoted"><span class="var">?prec</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> prl <span class="main">=</span> <span class="var"><span class="quoted"><span class="var">?prl</span></span></span>
    <span class="keyword2"><span class="keyword">and</span></span> c <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> Lex"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ssimple <span class="main">=</span> <span class="quoted">False</span> <span class="keyword2"><span class="keyword">and</span></span> large <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">f</span><span class="main">.</span> False"</span></span> <span class="keyword2"><span class="keyword">and</span></span> σσ <span class="main">=</span> <span class="quoted">full_status</span>
    <span class="keyword2"><span class="keyword">and</span></span> n <span class="main">=</span> <span class="quoted"><span class="skolem">n</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> kbo_encoding_is_valid_wpo<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"kbo <span class="main">(</span><span class="skolem">f</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> wpo.wpo <span class="main">(</span><span class="skolem">f</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> kbo_as_wpo<span class="main"><span class="main">[</span></span><span class="operator">OF</span> weight_is_arity_bound<span class="main"><span class="main">[</span></span><span class="operator">OF</span> w_bound<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="comment1">(* for all the terms in the infinite sequence f 0, f 1, ... 
     we have that KBO = WPO *)</span>

  <span class="comment1">(* and finally derive contradiction to SN-property of WPO *)</span>
  <span class="keyword1"><span class="command">from</span></span> steps<span class="main">[</span><span class="operator">unfolded</span> this<span class="main">]</span> wpo.WPO_S_SN <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
  
<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Executable_Orders">
<div class="head">
<h1>Theory Executable_Orders</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Executability of the orders›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Executable_Orders
  <span class="keyword2"><span class="keyword">imports</span></span> 
    <a href="#WPO">WPO</a>
    <a href="#RPO">RPO</a>
    <a href="#LPO">LPO</a>
    <a href="#Multiset_Extension2_Impl">Multiset_Extension2_Impl</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If one loads the implementation of multiset orders (in particular for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> mul_ext<span class="antiquote"><span class="antiquote">}</span></span></span></span>), 
  then all orders defined in this AFP-entry (WPO, RPO, LPO, multiset extension of order pairs) are executable.›</span></span>

<span class="keyword1"><span class="command">export_code</span></span> 
  <span class="quoted"><span class="quoted">lpo</span></span>
  <span class="quoted"><span class="quoted">rpo</span></span> 
  <span class="quoted"><span class="quoted">wpo.wpo</span></span> 
  <span class="quoted"><span class="quoted">mul_ext</span></span> 
  <span class="quoted"><span class="quoted">mult2_impl</span></span> 
  <span class="keyword2"><span class="keyword">in</span></span> Haskell 

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div>