<div id="Extra">
<div class="head">
<h1>Theory Extra</h1>
</div>
<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="comment1">(*
 * Knowledge-based programs.
 * (C)opyright 2011, Peter Gammie, peteg42 at gmail.com.
 * License: BSD
 *)</span>

<span class="keyword1"><span class="command">theory</span></span> Extra
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Option_ord.html">HOL-Library.Option_ord</a>"</span>
  <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Product_Lexorder.html">HOL-Library.Product_Lexorder</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(* Extra lemmas that are not noteworthy. *)</span>

<span class="keyword1" id="Extra-relation_mono"><span class="command">lemma</span></span> relation_mono<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">A</span> <span class="main">⊆</span> <span class="free">C</span><span class="main">;</span> <span class="free">B</span> <span class="main">⊆</span> <span class="free">D</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">×</span> <span class="free">B</span> <span class="main">⊆</span> <span class="free">C</span> <span class="main">×</span> <span class="free">D</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">bestsimp</span>

<span class="keyword1" id="Extra-quotientI2"><span class="command">lemma</span></span> quotientI2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">A</span><span class="main">;</span> <span class="free">X</span> <span class="main">=</span> <span class="free">r</span> <span class="main">``</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">X</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">//</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> quotientI<span class="main">)</span>

<span class="comment1">(*

Concretely enumerate all the agent action functions. Can't be too
abstract here as we want extensionality.

Introduced in the clock view.

*)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">listToFun</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span> list<span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">listToFun</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span> foldr <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">acts</span><span class="main">)</span> <span class="bound">M</span><span class="main">.</span> <span class="main">[</span> <span class="bound">m</span><span class="main">(</span><span class="bound">a</span> <span class="main">:=</span> <span class="bound">act</span><span class="main">)</span> <span class="main">.</span> m <span class="main">←</span> <span class="bound">M</span><span class="main">,</span> act <span class="main">←</span> <span class="bound">acts</span> <span class="main">]</span><span class="main">)</span>
                     <span class="free"><span class="bound"><span class="entity">xs</span></span></span>
                     <span class="main">[</span><span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> undefined<span class="main">)</span><span class="main">]</span>"</span></span>

<span class="keyword1" id="Extra-listToFun_futz"><span class="command">lemma</span></span> listToFun_futz<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">M</span> <span class="main">∈</span> set <span class="main">(</span>listToFun <span class="free">xs</span><span class="main">)</span><span class="main">;</span> <span class="free">x</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="free">xs</span> <span class="main">⟧</span>
     <span class="main">⟹</span> <span class="free">M</span> <span class="free">x</span> <span class="main">∈</span> <span class="main">{</span> <span class="bound">y</span> <span class="main">|</span><span class="bound">y</span> <span class="bound">ys</span><span class="main">.</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="bound">ys</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> listToFun_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">M</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">a</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Extra-distinct_map_fst"><span class="command">lemma</span></span> distinct_map_fst<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">x</span> <span class="main">∉</span> fst <span class="main">`</span> set <span class="free">xs</span><span class="main">;</span> distinct <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∉</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Extra-listToFun_futz_rev"><span class="command">lemma</span></span> listToFun_futz_rev<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">M</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="free">xs</span> <span class="keyword1">then</span> <span class="main">{</span> <span class="bound">y</span> <span class="main">|</span><span class="bound">y</span> <span class="bound">ys</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="bound">ys</span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">{</span>undefined<span class="main">}</span><span class="main">)</span><span class="main">;</span> distinct <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span> <span class="main">⟧</span>
      <span class="main">⟹</span> <span class="free">M</span> <span class="main">∈</span> set <span class="main">(</span>listToFun <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">M</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> listToFun_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span><span class="main">(</span>fst <span class="skolem">x</span> <span class="main">:=</span> undefined<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> M'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?M'</span> <span class="main">∈</span> set <span class="main">(</span>listToFun <span class="skolem">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Cons.hyps<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2
     <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>3<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">xa</span> <span class="main">=</span> fst <span class="skolem">x</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>3<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">xa</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="skolem">xs</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cut_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">xa</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> Cons<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cut_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">xa</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> Cons<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> listToFun_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> bexI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="var"><span class="var">?M'</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="improper">a</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> image_eqI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cut_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> Cons<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> distinct_map_fst<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">listToFuns</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> list<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">listToFuns</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> listToFun <span class="main">∘</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Extra-map_id_clunky"><span class="command">lemma</span></span> map_id_clunky<span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">=</span> UNIV <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> set_map<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> map_map<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">(*

The main result is that we can freely move between representations.

*)</span>

<span class="keyword1" id="Extra-listToFuns_ext"><span class="command">lemma</span></span> listToFuns_ext<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> xs<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">=</span> UNIV"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">∈</span> set <span class="main">(</span>listToFuns <span class="free">f</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free">g</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> listToFuns_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cut_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> listToFun_futz<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> M<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">g</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ map_id_clunky<span class="main"><span class="main">[</span></span><span class="operator">OF</span> xs<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> listToFun_futz_rev<span class="main">)</span>
   <span class="keyword1"><span class="command">using</span></span> map_id_clunky<span class="main">[</span><span class="operator">OF</span> xs<span class="main">]</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="improper">xa</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">using</span></span> d
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distinct_map<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> inj_onI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Extra-listToFun_splice"><span class="command">lemma</span></span> listToFun_splice<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> xs<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">=</span> UNIV"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">∈</span> set <span class="main">(</span>listToFuns <span class="free">f</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">∈</span> set <span class="main">(</span>listToFuns <span class="free">f</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">h</span> <span class="free">x</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>listToFuns <span class="free">f</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> g h <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> listToFuns_ext<span class="main"><span class="main">[</span></span><span class="operator">OF</span> xs d<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="List_local">
<div class="head">
<h1>Theory List_local</h1>
</div>
<pre class="source">
<span class="comment1">(*
 * Knowledge-based programs.
 * (C)opyright 2011, Peter Gammie, peteg42 at gmail.com.
 * License: BSD
 *)</span>

<span class="keyword1"><span class="command">theory</span></span> List_local
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#Extra">Extra</a> <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/While_Combinator.html">HOL-Library.While_Combinator</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Partition a list with respect to an equivalence relation.›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹First up: split a list according to a relation.›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">rel_ext</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">≡</span> <span class="main">{</span> <span class="bound">x</span> <span class="main">.</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="bound">x</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">partition_split_body</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">×</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">×</span> <span class="tfree">'a</span> list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">partition_split_body</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">y</span> <span class="main">(</span><span class="bound">X'</span><span class="main">,</span> <span class="bound">xc</span><span class="main">)</span><span class="main">.</span>
            <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">(</span><span class="bound">X'</span><span class="main">,</span> List.insert <span class="bound">y</span> <span class="bound">xc</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span>List.insert <span class="bound">y</span> <span class="bound">X'</span><span class="main">,</span> <span class="bound">xc</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">partition_split</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">×</span> <span class="tfree">'a</span> list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">partition_split</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span> foldr <span class="main">(</span>partition_split_body <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="List_local-partition_split"><span class="command">lemma</span></span> partition_split<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>fst <span class="main">(</span>partition_split <span class="free">r</span> <span class="free">x</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="free">xs</span> <span class="main">-</span> <span class="main">(</span>rel_ext <span class="free">r</span> <span class="main">``</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>snd <span class="main">(</span>partition_split <span class="free">r</span> <span class="free">x</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="free">xs</span> <span class="main">∩</span> <span class="main">(</span>rel_ext <span class="free">r</span> <span class="main">``</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword1"><span class="command">with</span></span> Nil <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> partition_split_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword1"><span class="command">with</span></span> Nil <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> partition_split_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword1"><span class="command">with</span></span> Cons <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> partition_split_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> partition_split_body_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">split</span> prod.split<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command">unfolding</span></span> Image_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword1"><span class="command">with</span></span> Cons <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> partition_split_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> partition_split_body_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">split</span> prod.split<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span> <span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="List_local-partition_split'"><span class="command">lemma</span></span> partition_split'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"partition_split <span class="free">r</span> <span class="free">x</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">(</span><span class="free">xxs'</span><span class="main">,</span> <span class="free">xec</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xxs'</span> <span class="main">=</span> set <span class="free">xs</span> <span class="main">-</span> <span class="main">(</span>rel_ext <span class="free">r</span> <span class="main">``</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xec</span> <span class="main">=</span> set <span class="free">xs</span> <span class="main">∩</span> <span class="main">(</span>rel_ext <span class="free">r</span> <span class="main">``</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms partition_split<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">r</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">x</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> xs<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">xs</span></span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Next, split an list on each of its members. For this to be
unambiguous <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">r</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> must be an equivalence relation.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">partition_aux_body</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">×</span> <span class="tfree">'a</span> list list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">×</span> <span class="tfree">'a</span> list list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">partition_aux_body</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">r</span> <span class="main">(</span><span class="bound">xxs</span><span class="main">,</span> <span class="bound">ecs</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">xxs</span> <span class="keyword1">of</span> <span class="main">[]</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">|</span> <span class="bound">x</span> <span class="main">#</span> <span class="bound">xs</span> <span class="main">⇒</span>
                           <span class="keyword1">let</span> <span class="main">(</span><span class="bound">xxs'</span><span class="main">,</span> <span class="bound">xec</span><span class="main">)</span> <span class="main">=</span> partition_split <span class="bound">r</span> <span class="bound">x</span> <span class="bound">xs</span>
                            <span class="keyword1">in</span> <span class="main">(</span><span class="bound">xxs'</span><span class="main">,</span> <span class="main">(</span><span class="bound">x</span> <span class="main">#</span> <span class="bound">xec</span><span class="main">)</span> <span class="main">#</span> <span class="bound">ecs</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">partition_aux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">×</span> <span class="tfree">'a</span> list list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">partition_aux</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span>
             while <span class="main">(</span>Not <span class="main">∘</span> List.null <span class="main">∘</span> fst<span class="main">)</span> <span class="main">(</span>partition_aux_body <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span>

<span class="comment1">(* FIXME move these. *)</span>

<span class="keyword1" id="List_local-equiv_subseteq_in_sym"><span class="command">lemma</span></span> equiv_subseteq_in_sym<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">r</span> <span class="main">``</span> <span class="free">X</span> <span class="main">⊆</span> <span class="free">X</span><span class="main">;</span>  <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">r</span><span class="main">;</span> <span class="free">y</span> <span class="main">∈</span> <span class="free">X</span><span class="main">;</span> equiv <span class="free">Y</span> <span class="free">r</span><span class="main">;</span> <span class="free">X</span> <span class="main">⊆</span> <span class="free">Y</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> equiv_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> symD<span class="main">)</span>

<span class="keyword1" id="List_local-FIXME_refl_on_insert_absorb"><span class="command">lemma</span></span> FIXME_refl_on_insert_absorb<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> refl_on <span class="free">A</span> <span class="free">r</span><span class="main">;</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟧</span> <span class="main">⟹</span> insert <span class="free">x</span> <span class="main">(</span><span class="free">r</span> <span class="main">``</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="free">r</span> <span class="main">``</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> refl_onD<span class="main">)</span>

<span class="keyword1" id="List_local-equiv_subset"><span class="command">lemma</span></span> equiv_subset<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> equiv <span class="free">A</span> <span class="free">r</span><span class="main">;</span> <span class="free">B</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">⟧</span> <span class="main">⟹</span> equiv <span class="free">B</span> <span class="main">(</span><span class="free">r</span> <span class="main">∩</span> <span class="free">B</span> <span class="main">×</span> <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> equiv_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> refl_onI symI transI <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> refl_onD symD transD<span class="main">)</span>

<span class="keyword1" id="List_local-FIXME_fiddle1"><span class="command">lemma</span></span> FIXME_fiddle1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">Y</span><span class="main">;</span> <span class="free">X</span> <span class="main">⊆</span> <span class="free">Y</span><span class="main">;</span> refl_on <span class="free">Y</span> <span class="free">r</span> <span class="main">⟧</span> <span class="main">⟹</span> insert <span class="free">x</span> <span class="main">(</span><span class="free">X</span> <span class="main">∩</span> <span class="free">r</span> <span class="main">``</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>insert <span class="free">x</span> <span class="free">X</span><span class="main">)</span> <span class="main">∩</span> <span class="free">r</span> <span class="main">``</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> refl_onD<span class="main">)</span>

<span class="keyword1" id="List_local-FIXME_second_fiddle"><span class="command">lemma</span></span> FIXME_second_fiddle<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free">r</span> <span class="main">∩</span> <span class="free">Y</span> <span class="main">×</span> <span class="free">Y</span><span class="main">)</span> <span class="main">``</span> <span class="free">X</span> <span class="main">⊆</span> <span class="free">X</span><span class="main">;</span> refl_on <span class="free">Z</span> <span class="free">r</span><span class="main">;</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">;</span> <span class="free">X</span> <span class="main">⊆</span> <span class="free">Y</span><span class="main">;</span> <span class="free">Y</span> <span class="main">⊆</span> <span class="free">Z</span> <span class="main">⟧</span>
     <span class="main">⟹</span> <span class="main">(</span><span class="free">r</span> <span class="main">∩</span> <span class="main">(</span><span class="free">Y</span> <span class="main">-</span> <span class="main">(</span><span class="free">X</span> <span class="main">-</span> <span class="free">r</span> <span class="main">``</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">×</span> <span class="main">(</span><span class="free">Y</span> <span class="main">-</span> <span class="main">(</span><span class="free">X</span> <span class="main">-</span> <span class="free">r</span> <span class="main">``</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">``</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>
       <span class="main">=</span> <span class="main">(</span><span class="free">r</span> <span class="main">∩</span> <span class="free">X</span> <span class="main">×</span> <span class="free">X</span><span class="main">)</span> <span class="main">``</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> refl_onD<span class="main">)</span>

<span class="keyword1" id="List_local-FIXME_third_fiddle"><span class="command">lemma</span></span> FIXME_third_fiddle<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free">r</span> <span class="main">∩</span> <span class="free">Y</span> <span class="main">×</span> <span class="free">Y</span><span class="main">)</span> <span class="main">``</span> <span class="free">X</span> <span class="main">⊆</span> <span class="free">X</span><span class="main">;</span> <span class="free">X</span> <span class="main">⊆</span> <span class="free">Y</span><span class="main">;</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">;</span> <span class="free">y</span> <span class="main">∈</span> <span class="free">Y</span> <span class="main">-</span> <span class="free">X</span>    <span class="main">;</span>    <span class="free">r</span> <span class="main">``</span> <span class="main">{</span><span class="free">y</span><span class="main">}</span> <span class="main">∩</span> <span class="free">X</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟧</span>
     <span class="main">⟹</span> <span class="main">(</span><span class="free">r</span> <span class="main">∩</span> <span class="main">(</span><span class="free">Y</span> <span class="main">-</span> <span class="main">(</span><span class="free">X</span> <span class="main">-</span> <span class="free">r</span> <span class="main">``</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">×</span> <span class="main">(</span><span class="free">Y</span> <span class="main">-</span> <span class="main">(</span><span class="free">X</span> <span class="main">-</span> <span class="free">r</span> <span class="main">``</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">``</span> <span class="main">{</span><span class="free">y</span><span class="main">}</span>
       <span class="main">=</span> <span class="main">(</span><span class="free">r</span> <span class="main">∩</span> <span class="main">(</span><span class="free">Y</span> <span class="main">-</span> <span class="free">X</span><span class="main">)</span> <span class="main">×</span> <span class="main">(</span><span class="free">Y</span> <span class="main">-</span> <span class="free">X</span><span class="main">)</span><span class="main">)</span> <span class="main">``</span> <span class="main">{</span><span class="free">y</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="List_local-partition_aux"><span class="command">lemma</span></span> partition_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> equiv<span class="main">:</span> <span class="quoted"><span class="quoted">"equiv <span class="free">X</span> <span class="main">(</span>rel_ext <span class="free">r</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> XZ<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>partition_aux <span class="free">r</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>
       <span class="main">∧</span> set <span class="main">`</span> set <span class="main">(</span>snd <span class="main">(</span>partition_aux <span class="free">r</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>
       <span class="main">=</span> <span class="main">(</span>set <span class="free">xs</span> <span class="main">//</span> <span class="main">(</span>rel_ext <span class="free">r</span> <span class="main">∩</span> set <span class="free">xs</span> <span class="main">×</span> set <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?b</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Not <span class="main">∘</span> List.null <span class="main">∘</span> fst"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?c</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"partition_aux_body <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">A</span><span class="main">.</span> rel_ext <span class="free">r</span> <span class="main">∩</span> <span class="bound">A</span> <span class="main">×</span> <span class="bound">A</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">)</span><span class="main">.</span> set <span class="bound">A</span> <span class="main">⊆</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">)</span><span class="main">.</span> <span class="var">?r'</span> <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span> <span class="main">``</span> set <span class="bound">A</span> <span class="main">⊆</span> set <span class="bound">A</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P3</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">)</span><span class="main">.</span> set <span class="main">`</span> set <span class="bound">B</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>set <span class="free">xs</span> <span class="main">-</span> set <span class="bound">A</span><span class="main">)</span> <span class="main">//</span> <span class="var">?r'</span> <span class="main">(</span>set <span class="free">xs</span> <span class="main">-</span> set <span class="bound">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">AB</span><span class="main">.</span> <span class="var">?P1</span> <span class="bound">AB</span> <span class="main">∧</span> <span class="var">?P2</span> <span class="bound">AB</span> <span class="main">∧</span> <span class="var">?P3</span> <span class="bound">AB</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?wfr</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"inv_image finite_psubset <span class="main">(</span>set <span class="main">∘</span> fst<span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> partition_aux_def
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> while_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="var"><span class="var">?P</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> r<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="var"><span class="var">?wfr</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> equiv XZ <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="keyword3"><span class="command">assume</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?b</span> <span class="skolem">s</span>"</span></span>

    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span> <span class="operator">blast</span>

    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> XZ P s <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P1</span> <span class="main">(</span><span class="var">?c</span> <span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">B</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> partition_aux_body_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partition_split' <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.split prod.split<span class="main">)</span>

    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> equiv XZ P s <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P2</span> <span class="main">(</span><span class="var">?c</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">A</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> partition_aux_body_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> a as
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"partition_split <span class="free">r</span> <span class="skolem">a</span> <span class="skolem">as</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partition_split'<span class="main">)</span>
        <span class="keyword1"><span class="command">unfolding</span></span> equiv_def
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> symD transD <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> quotientE<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P3</span> <span class="main">(</span><span class="var">?c</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> b s <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">A</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> null_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> XZ equiv P b s x
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      
        <span class="keyword1"><span class="command">unfolding</span></span> partition_aux_body_def
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> equivE<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">A</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"partition_split <span class="free">r</span> <span class="improper">a</span> <span class="improper">list</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partition_split'<span class="main">)</span>

        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> FIXME_fiddle1<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Y<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">X</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>

        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> quotientI2<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> refl_onD<span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> XZ
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> refl_onD<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> quotientE<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">xa</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> quotientI2<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> refl_onD<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cut_tac</span> X<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"insert <span class="improper">a</span> <span class="main">(</span>set <span class="improper">list</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Y<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"set <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">xa</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> y<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"rel_ext <span class="free">r</span> <span class="main">∩</span> set <span class="free">xs</span> <span class="main">×</span> set <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> equiv_subseteq_in_sym<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
          <span class="keyword1"><span class="command">using</span></span> equiv
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cut_tac</span> X<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"insert <span class="improper">a</span> <span class="main">(</span>set <span class="improper">list</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Y<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"set <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">xa</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> y<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">xb</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"rel_ext <span class="free">r</span> <span class="main">∩</span> set <span class="free">xs</span> <span class="main">×</span> set <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> equiv_subseteq_in_sym<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
         <span class="keyword1"><span class="command">using</span></span> equiv
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>

        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> quotientE<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">xaa</span> <span class="main">=</span> <span class="improper">a</span>"</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>

        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">xa</span> <span class="main">∈</span> set <span class="improper">list</span>"</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> transD<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> symD transD<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>

        <span class="keyword1"><span class="command">unfolding</span></span> quotient_def
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">xa</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> ballE<span class="main">)</span>
         <span class="keyword1"><span class="command">unfolding</span></span> Image_def
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> symD transD<span class="main">)</span>  <span class="comment1">(* SLOW *)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span><span class="var">?c</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="keyword3"><span class="command">assume</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="var">?b</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> b <span class="keyword1"><span class="command">have</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">s</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">a</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> List.null_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">from</span></span> equiv P F <span class="keyword1"><span class="command">have</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">`</span> set <span class="main">(</span>snd <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>set <span class="free">xs</span> <span class="main">//</span> <span class="var">?r'</span> <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> Image_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">from</span></span> F S <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">s</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∧</span> set <span class="main">`</span> set <span class="main">(</span>snd <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>set <span class="free">xs</span> <span class="main">//</span> <span class="var">?r'</span> <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod_eqI<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wf <span class="var">?wfr</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> wf_finite_psubset Int_lower2 <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> <span class="main"><span class="main"><span class="main">[</span></span></span>2<span class="main"><span class="main"><span class="main">]</span></span></span> wf_subset<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="keyword3"><span class="command">assume</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?b</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> equiv XZ P b <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>fst <span class="main">(</span><span class="var">?c</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⊂</span> set <span class="main">(</span>fst <span class="skolem">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> partition_aux_body_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">a</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> List.null_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"partition_split <span class="free">r</span> <span class="improper">aa</span> <span class="improper">list</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partition_split'<span class="main">)</span>

      <span class="keyword1"><span class="command">unfolding</span></span> equiv_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> refl_onD<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?c</span> <span class="skolem">s</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?wfr</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">partition</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">partition</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span> snd <span class="main">(</span>partition_aux <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="List_local-partition"><span class="command">lemma</span></span> partition<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> equiv<span class="main">:</span> <span class="quoted"><span class="quoted">"equiv <span class="free">X</span> <span class="main">(</span>rel_ext <span class="free">r</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> xs<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">`</span> set <span class="main">(</span>partition <span class="free">r</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> set <span class="free">xs</span> <span class="main">//</span> <span class="main">(</span><span class="main">(</span>rel_ext <span class="free">r</span><span class="main">)</span> <span class="main">∩</span> set <span class="free">xs</span> <span class="main">×</span> set <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> partition_def
  <span class="keyword1"><span class="command">using</span></span> partition_aux<span class="main">[</span><span class="operator">OF</span> equiv xs<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="comment1">(* **************************************** *)</span>

<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">odlist_equal</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">odlist_equal</span> <span class="main">[]</span> <span class="main">[]</span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">odlist_equal</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">=</span> False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">odlist_equal</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">[]</span> <span class="main">=</span> False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">odlist_equal</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">∧</span> <span class="free">odlist_equal</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> odlist_equal.simps <span class="main">[</span><span class="operator">code</span><span class="main">]</span>

<span class="keyword1" id="List_local-equal_odlist_equal"><span class="command">lemma</span></span> equal_odlist_equal<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> distinct <span class="free">xs</span><span class="main">;</span> distinct <span class="free">ys</span><span class="main">;</span> sorted <span class="free">xs</span><span class="main">;</span> sorted <span class="free">ys</span> <span class="main">⟧</span>
     <span class="main">⟹</span> odlist_equal <span class="free">xs</span> <span class="free">ys</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">xs</span> <span class="main">=</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> odlist_equal.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">difference</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> linorder<span class="main">)</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">difference</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">difference</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">difference</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span> <span class="free">difference</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span>
               <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free">difference</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span>
                             <span class="keyword1">else</span> <span class="free">difference</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> difference.simps <span class="main">[</span><span class="operator">code</span><span class="main">]</span>

<span class="keyword1" id="List_local-set_difference"><span class="command">lemma</span></span> set_difference<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> distinct <span class="free">xs</span><span class="main">;</span> distinct <span class="free">ys</span><span class="main">;</span> sorted <span class="free">xs</span><span class="main">;</span> sorted <span class="free">ys</span> <span class="main">⟧</span>
     <span class="main">⟹</span> set <span class="main">(</span>difference <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> set <span class="free">xs</span> <span class="main">-</span> set <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> difference.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="List_local-distinct_sorted_difference"><span class="command">lemma</span></span> distinct_sorted_difference<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> distinct <span class="free">xs</span><span class="main">;</span> distinct <span class="free">ys</span><span class="main">;</span> sorted <span class="free">xs</span><span class="main">;</span> sorted <span class="free">ys</span> <span class="main">⟧</span>
     <span class="main">⟹</span> distinct <span class="main">(</span>difference <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">∧</span> sorted <span class="main">(</span>difference <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> difference.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">intersection</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> linorder<span class="main">)</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">intersection</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">intersection</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">intersection</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free">intersection</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span>
               <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span> <span class="free">intersection</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span>
                             <span class="keyword1">else</span> <span class="free">intersection</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> intersection.simps <span class="main">[</span><span class="operator">code</span><span class="main">]</span>

<span class="keyword1" id="List_local-set_intersection"><span class="command">lemma</span></span> set_intersection<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> distinct <span class="free">xs</span><span class="main">;</span> distinct <span class="free">ys</span><span class="main">;</span> sorted <span class="free">xs</span><span class="main">;</span> sorted <span class="free">ys</span> <span class="main">⟧</span>
     <span class="main">⟹</span> set <span class="main">(</span>intersection <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> set <span class="free">xs</span> <span class="main">∩</span> set <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> intersection.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="List_local-distinct_sorted_intersection"><span class="command">lemma</span></span> distinct_sorted_intersection<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> distinct <span class="free">xs</span><span class="main">;</span> distinct <span class="free">ys</span><span class="main">;</span> sorted <span class="free">xs</span><span class="main">;</span> sorted <span class="free">ys</span> <span class="main">⟧</span>
     <span class="main">⟹</span> distinct <span class="main">(</span>intersection <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">∧</span> sorted <span class="main">(</span>intersection <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> intersection.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="comment1">(* This is a variant of zipWith *)</span>
<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">image</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> linorder <span class="main">×</span> <span class="tfree">'b</span> <span class="main">::</span> linorder<span class="main">)</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'b</span> list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">image</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">image</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">[]</span>  <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">image</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">zs</span></span></span><span class="main">)</span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free">image</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">zs</span></span></span><span class="main">)</span>
               <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="keyword1">then</span> <span class="free">image</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">zs</span></span></span><span class="main">)</span>
                             <span class="keyword1">else</span> <span class="free">image</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">zs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> image.simps <span class="main">[</span><span class="operator">code</span><span class="main">]</span>

<span class="keyword1" id="List_local-set_image"><span class="command">lemma</span></span> set_image<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> distinct <span class="free">R</span><span class="main">;</span> distinct <span class="free">xs</span><span class="main">;</span> sorted <span class="free">R</span><span class="main">;</span> sorted <span class="free">xs</span> <span class="main">⟧</span>
     <span class="main">⟹</span> set <span class="main">(</span>image <span class="free">R</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> set <span class="free">R</span> <span class="main">``</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">R</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> image.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> less_eq_prod_def<span class="main">)</span>

<span class="comment1">(* Extra lemmas that really belong in List.thy *)</span>

<span class="keyword1" id="List_local-sorted_filter"><span class="command">lemma</span></span> sorted_filter<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"sorted <span class="free">xs</span> <span class="main">⟹</span> sorted <span class="main">(</span>filter <span class="free">P</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="List_local-map_prod_eq"><span class="command">lemma</span></span> map_prod_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"map fst <span class="free">xs</span> <span class="main">=</span> map fst <span class="free">ys</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"map snd <span class="free">xs</span> <span class="main">=</span> map snd <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> pair_list_eqI<span class="main">)</span>

<span class="keyword1" id="List_local-list_choose_hd"><span class="command">lemma</span></span> list_choose_hd<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>List.hd <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Kripke">
<div class="head">
<h1>Theory Kripke</h1>
</div>
<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="comment1">(*
 * Knowledge-based programs.
 * (C)opyright 2011, Peter Gammie, peteg42 at gmail.com.
 * License: BSD
 *)</span>

<span class="keyword1"><span class="command">theory</span></span> Kripke
<span class="keyword2"><span class="keyword">imports</span></span> <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹A modal logic of knowledge›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

\label{sec:kbps-logic-of-knowledge}

We begin with the standard syntax and semantics of the propositional
logic of knowledge based on \emph{Kripke structures}. More extensive
treatments can be found in \citet{Lenzen:1978}, \citet{Chellas:1980},
\citet{Hintikka:1962} and \citet[Chapter~2]{FHMV:1995}.

The syntax includes one knowledge modality per agent, and one for
\emph{common knowledge} amongst a set of agents. It is parameterised
by the type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'a</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> of agents and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'p</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> of propositions.

›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">)</span> Kform
  <span class="main">=</span> Kprop <span class="quoted"><span class="quoted">"<span class="tfree">'p</span>"</span></span>
  <span class="main">|</span> Knot <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">)</span> Kform"</span></span>
  <span class="main">|</span> Kand <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">)</span> Kform"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">)</span> Kform"</span></span>
  <span class="main">|</span> Kknows <span class="quoted"><span class="quoted">"<span class="tfree">'a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">)</span> Kform"</span></span>  <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="hidden">❙</span><b>K</b>⇩</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>_ _"</span><span class="main">)</span>
  <span class="main">|</span> Kcknows <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">)</span> Kform"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="hidden">❙</span><b>C</b>⇘</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>_<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">⇙</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> _"</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

A Kripke structure consists of a set of \emph{worlds} of type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span>
<span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'w</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, one \emph{accessibility relation} between worlds for each agent
and a \emph{valuation function} that indicates the truth of a
proposition at a world. This is a very general story that we will
quickly specialise.

›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'w</span> Relation <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'w</span> <span class="main">×</span> <span class="tfree">'w</span><span class="main">)</span> set"</span></span>

<span class="keyword1"><span class="command">record</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'w</span><span class="main">)</span> KripkeStructure <span class="main">=</span>
  worlds <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'w</span> set"</span></span>
  relations <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'w</span> Relation"</span></span>
  valuation <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'w</span> <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> bool"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">kripke</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'w</span><span class="main">)</span> KripkeStructure <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">kripke</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">a</span><span class="main">.</span> relations <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="bound">a</span> <span class="main">⊆</span> worlds <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">×</span> worlds <span class="free"><span class="bound"><span class="entity">M</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">mkKripke</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'w</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'w</span> Relation<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'w</span> <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> bool<span class="main">)</span>
            <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'w</span><span class="main">)</span> KripkeStructure"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mkKripke</span> <span class="free"><span class="bound"><span class="entity">ws</span></span></span> <span class="free"><span class="bound"><span class="entity">rels</span></span></span> <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="main">≡</span>
     <span class="main">⦇</span> worlds <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ws</span></span></span><span class="main">,</span> relations <span class="main">=</span> <span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">rels</span></span></span> <span class="bound">a</span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">ws</span></span></span> <span class="main">×</span> <span class="free"><span class="bound"><span class="entity">ws</span></span></span><span class="main">,</span> valuation <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="main">⦈</span>"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1" id="Kripke-kripkeI"><span class="command">lemma</span></span> kripkeI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> relations <span class="free">M</span> <span class="bound">a</span> <span class="main">⊆</span> worlds <span class="free">M</span> <span class="main">×</span> worlds <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"kripke <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> kripke_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Kripke-kripke_rels_worlds"><span class="command">lemma</span></span> kripke_rels_worlds<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">w'</span><span class="main">)</span> <span class="main">∈</span> relations <span class="free">M</span> <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"kripke <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> worlds <span class="free">M</span> <span class="main">∧</span> <span class="free">w'</span> <span class="main">∈</span> worlds <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> kripke_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Kripke-kripke_tc_rels_worlds"><span class="command">lemma</span></span> kripke_tc_rels_worlds<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">w'</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">a</span> <span class="main">∈</span> <span class="free">as</span><span class="main">.</span> relations <span class="free">M</span> <span class="bound">a</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"kripke <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> worlds <span class="free">M</span> <span class="main">∧</span> <span class="free">w'</span> <span class="main">∈</span> worlds <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trancl_induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Kripke-kripke_rels_trc_worlds"><span class="command">lemma</span></span> kripke_rels_trc_worlds<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">w'</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">a</span><span class="main">.</span> relations <span class="free">M</span> <span class="bound">a</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> worlds <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"kripke <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> W<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">W</span> <span class="main">=</span> worlds <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w'</span> <span class="main">∈</span> <span class="free">W</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rtrancl_induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Kripke-mkKripke_kripke"><span class="command">lemma</span></span> mkKripke_kripke<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"kripke <span class="main">(</span>mkKripke <span class="free">ws</span> <span class="free">rels</span> <span class="free">val</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> kripke_def mkKripke_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span>

<span class="keyword1" id="Kripke-mkKripke_simps"><span class="command">lemma</span></span> mkKripke_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"worlds <span class="main">(</span>mkKripke <span class="free">ws</span> <span class="free">rels</span> <span class="free">val</span><span class="main">)</span> <span class="main">=</span> <span class="free">ws</span>"</span></span>
  <span class="quoted"><span class="quoted">"relations <span class="main">(</span>mkKripke <span class="free">ws</span> <span class="free">rels</span> <span class="free">val</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free">rels</span> <span class="bound">a</span> <span class="main">∩</span> <span class="free">ws</span> <span class="main">×</span> <span class="free">ws</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"valuation <span class="main">(</span>mkKripke <span class="free">ws</span> <span class="free">rels</span> <span class="free">val</span><span class="main">)</span> <span class="main">=</span> <span class="free">val</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mkKripke_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹

The standard semantics for knowledge is given by taking the
accessibility relations to be equivalence relations, yielding the
S$5_n$ structures, so-called due to their axiomatisation.

›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">S5n</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'w</span><span class="main">)</span> KripkeStructure <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">S5n</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">a</span><span class="main">.</span> equiv <span class="main">(</span>worlds <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">(</span>relations <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="bound">a</span><span class="main">)</span>"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1" id="Kripke-S5nI"><span class="command">lemma</span></span> S5nI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> equiv <span class="main">(</span>worlds <span class="free">M</span><span class="main">)</span> <span class="main">(</span>relations <span class="free">M</span> <span class="bound">a</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> S5n <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S5n_def<span class="main">)</span>

<span class="keyword1" id="Kripke-S5nD"><span class="command">lemma</span></span> S5nD<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"S5n <span class="free">M</span> <span class="main">⟹</span> equiv <span class="main">(</span>worlds <span class="free">M</span><span class="main">)</span> <span class="main">(</span>relations <span class="free">M</span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S5n_def<span class="main">)</span>

<span class="keyword1" id="Kripke-S5n_kripke"><span class="command">lemma</span></span> S5n_kripke<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"S5n <span class="free">M</span> <span class="main">⟹</span> kripke <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> kripkeI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> equivE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> S5nD<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> refl_on_def<span class="main">)</span>

<span class="keyword1" id="Kripke-S5n_rels_closed"><span class="command">lemma</span></span> S5n_rels_closed<span class="main">:</span>
  <span class="quoted"><span class="quoted">"S5n <span class="free">M</span> <span class="main">⟹</span> relations <span class="free">M</span> <span class="free">a</span> <span class="main">``</span> <span class="main">(</span>relations <span class="free">M</span> <span class="free">a</span> <span class="main">``</span> <span class="free">X</span><span class="main">)</span> <span class="main">⊆</span> relations <span class="free">M</span> <span class="free">a</span> <span class="main">``</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> S5nD<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">a</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> equivE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> refl_onD symD transD<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

Intuitively an agent considers two worlds to be equivalent if it
cannot distinguish between them.

›</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Satisfaction›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

A formula $\phi$ is satisfied at a world $w$ in Kripke structure $M$
in the following way:›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">models</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'w</span><span class="main">)</span> KripkeStructure <span class="main">⇒</span> <span class="tfree">'w</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">)</span> Kform
           <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span>_<span class="keyword1">,</span> _ <span class="keyword1">⊨</span> _<span class="keyword3">)</span>"</span> <span class="main">[</span>80<span class="main">,</span>0<span class="main">,</span>80<span class="main">]</span> 80<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main"><span class="free">⊨</span></span> <span class="main">(</span>Kprop <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">=</span> valuation <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main"><span class="free">⊨</span></span> <span class="main">(</span>Knot <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main"><span class="free">⊨</span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main"><span class="free">⊨</span></span> <span class="main">(</span>Kand <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main"><span class="free">⊨</span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main"><span class="free">⊨</span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main"><span class="free">⊨</span></span> <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>K</b>⇩</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">w'</span> <span class="main">∈</span> relations <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">``</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">}</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main"><span class="free">,</span></span> <span class="bound">w'</span> <span class="main"><span class="free">⊨</span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main"><span class="free">⊨</span></span> <span class="main">(</span><span class="hidden">❙</span><b>C</b><span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">as</span></span></span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">w'</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">a</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">.</span> relations <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="bound">a</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span> <span class="main">``</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">}</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main"><span class="free">,</span></span> <span class="bound">w'</span> <span class="main"><span class="free">⊨</span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The first three clauses are standard.

The clause for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Kknows <span class="free"><span class="free">a</span></span> <span class="free"><span class="free">φ</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> expresses the idea that an agent
knows <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">φ</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> at world <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">w</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> in structure <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">M</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> iff
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">φ</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is true at all worlds it considers possible.

The clause for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Kcknows <span class="free"><span class="free">as</span></span> <span class="free"><span class="free">φ</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> captures what it means for the
set of agents <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">as</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to commonly know <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">φ</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>; roughly,
everyone knows <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">φ</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and knows that everyone knows it, and so
forth. Note that the transitive closure and the reflexive-transitive
closure generate the same relation due to the reflexivity of the
agents' accessibility relations; we use the former as it has a more
pleasant induction principle.

›</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1" id="Kripke-S5n_rels_eq"><span class="command">lemma</span></span> S5n_rels_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> S5n<span class="main">:</span> <span class="quoted"><span class="quoted">"S5n <span class="free">M</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> ww'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">w'</span><span class="main">)</span> <span class="main">∈</span> relations <span class="free">M</span> <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"relations <span class="free">M</span> <span class="free">a</span> <span class="main">``</span> <span class="main">{</span><span class="free">w</span><span class="main">}</span> <span class="main">=</span> relations <span class="free">M</span> <span class="free">a</span> <span class="main">``</span> <span class="main">{</span><span class="free">w'</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> S5nD<span class="main">[</span><span class="operator">OF</span> S5n<span class="main">]</span> ww' <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">rule</span> equiv_class_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

A key property of the semantics for common knowledge is that it forms
an equivalence class itself.

›</span></span>

<span class="keyword1" id="Kripke-tc_equiv"><span class="command">lemma</span></span> tc_equiv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">is</span> <span class="main">⟹</span> equiv <span class="free">A</span> <span class="main">(</span><span class="free">f</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> is_nempty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">is</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"equiv <span class="free">A</span> <span class="main">(</span><span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">∈</span><span class="free">is</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> equivI<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> E is_nempty <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"refl_on <span class="free">A</span> <span class="main">(</span><span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">∈</span><span class="free">is</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> equiv_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> refl_onI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> trancl_Int_subset<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> refl_onD refl_onD1 refl_onD2<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">from</span></span> E <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sym <span class="main">(</span><span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">∈</span><span class="free">is</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sym_trancl<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> equiv_def sym_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"trans  <span class="main">(</span><span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">∈</span><span class="free">is</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> trans_trancl<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Kripke-S5n_tc_rels_eq"><span class="command">lemma</span></span> S5n_tc_rels_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> S5n<span class="main">:</span> <span class="quoted"><span class="quoted">"S5n <span class="free">M</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> ww'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">w'</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">a</span> <span class="main">∈</span> <span class="free">as</span><span class="main">.</span> relations <span class="free">M</span> <span class="bound">a</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">a</span> <span class="main">∈</span> <span class="free">as</span><span class="main">.</span> relations <span class="free">M</span> <span class="bound">a</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span> <span class="main">``</span> <span class="main">{</span><span class="free">w</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">a</span> <span class="main">∈</span> <span class="free">as</span><span class="main">.</span> relations <span class="free">M</span> <span class="bound">a</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span> <span class="main">``</span> <span class="main">{</span><span class="free">w'</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> equiv_class_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ ww'<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> tc_equiv<span class="main"><span class="main">[</span></span><span class="operator">OF</span> S5nD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> S5n<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹We can show that the standard S5 properties hold of this semantics:›</span></span>

<span class="keyword1" id="Kripke-S5n_knowledge_generalisation"><span class="command">lemma</span></span> S5n_knowledge_generalisation<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> S5n <span class="free">M</span><span class="main">;</span> <span class="main">∀</span><span class="bound">w</span> <span class="main">∈</span> worlds <span class="free">M</span><span class="main">.</span> <span class="free">M</span><span class="main">,</span> <span class="bound">w</span> <span class="main">⊨</span> <span class="free">φ</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">M</span><span class="main">,</span> <span class="free">w</span> <span class="main">⊨</span> Kknows <span class="free">a</span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> S5n_def equiv_def refl_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Kripke-S5n_knowledge"><span class="command">lemma</span></span> S5n_knowledge<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> S5n <span class="free">M</span><span class="main">;</span> <span class="free">w</span> <span class="main">∈</span> worlds <span class="free">M</span><span class="main">;</span> <span class="free">M</span><span class="main">,</span> <span class="free">w</span> <span class="main">⊨</span> Kknows <span class="free">a</span> <span class="free">φ</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">M</span><span class="main">,</span> <span class="free">w</span> <span class="main">⊨</span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> S5n_def equiv_def refl_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Kripke-S5n_positive_introspection"><span class="command">lemma</span></span> S5n_positive_introspection<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> S5n <span class="free">M</span><span class="main">;</span> <span class="free">w</span> <span class="main">∈</span> worlds <span class="free">M</span><span class="main">;</span> <span class="free">M</span><span class="main">,</span> <span class="free">w</span> <span class="main">⊨</span> Kknows <span class="free">a</span> <span class="free">φ</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">M</span><span class="main">,</span> <span class="free">w</span> <span class="main">⊨</span> Kknows <span class="free">a</span> <span class="main">(</span>Kknows <span class="free">a</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> S5n_def equiv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> transD<span class="main">)</span>

<span class="keyword1" id="Kripke-S5n_negative_introspection"><span class="command">lemma</span></span> S5n_negative_introspection<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> S5n <span class="free">M</span><span class="main">;</span> <span class="free">w</span> <span class="main">∈</span> worlds <span class="free">M</span><span class="main">;</span> <span class="free">M</span><span class="main">,</span> <span class="free">w</span> <span class="main">⊨</span> Knot <span class="main">(</span>Kknows <span class="free">a</span> <span class="free">φ</span><span class="main">)</span> <span class="main">⟧</span>
     <span class="main">⟹</span> <span class="free">M</span><span class="main">,</span> <span class="free">w</span> <span class="main">⊨</span> Kknows <span class="free">a</span> <span class="main">(</span>Knot <span class="main">(</span>Kknows <span class="free">a</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> S5n_def equiv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> symD transD<span class="main">)</span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The relation between knowledge and common knowledge can be understood
as follows, following \citet[\S2.4]{FHMV:1995}. Firstly, that $\phi$
is common knowledge to a set of agents $as$ can be seen as asserting
that everyone in $as$ knows $\phi$ and moreover knows that it is
common knowledge amongst $as$.

›</span></span>

<span class="keyword1" id="Kripke-S5n_common_knowledge_fixed_point"><span class="command">lemma</span></span> S5n_common_knowledge_fixed_point<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> S5n<span class="main">:</span> <span class="quoted"><span class="quoted">"S5n <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> worlds <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> set <span class="free">as</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span><span class="main">,</span> <span class="free">w</span> <span class="main">⊨</span> Kcknows <span class="free">as</span> <span class="free">φ</span>
     <span class="main">⟷</span> <span class="free">M</span><span class="main">,</span> <span class="free">w</span> <span class="main">⊨</span> Kand <span class="main">(</span>Kknows <span class="free">a</span> <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>Kknows <span class="free">a</span> <span class="main">(</span>Kcknows <span class="free">as</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> CK<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span><span class="main">,</span> <span class="free">w</span> <span class="main">⊨</span> Kcknows <span class="free">as</span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> S5n a w CK
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span><span class="main">,</span> <span class="free">w</span> <span class="main">⊨</span> Kknows <span class="free">a</span> <span class="free">φ</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span><span class="main">,</span> <span class="free">w</span> <span class="main">⊨</span> Kknows <span class="free">a</span> <span class="main">(</span>Kcknows <span class="free">as</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> trancl_into_trancl2<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span><span class="main">,</span> <span class="free">w</span> <span class="main">⊨</span> Kand <span class="main">(</span>Kknows <span class="free">a</span> <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>Kknows <span class="free">a</span> <span class="main">(</span>Kcknows <span class="free">as</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span><span class="main">,</span> <span class="free">w</span> <span class="main">⊨</span> Kand <span class="main">(</span>Kknows <span class="free">a</span> <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>Kknows <span class="free">a</span> <span class="main">(</span>Kcknows <span class="free">as</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span><span class="main">,</span> <span class="free">w</span> <span class="main">⊨</span> <span class="main">(</span>Kknows <span class="free">a</span> <span class="main">(</span>Kcknows <span class="free">as</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> S5n w <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span><span class="main">,</span> <span class="free">w</span> <span class="main">⊨</span> <span class="main">(</span>Kcknows <span class="free">as</span> <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> S5n_knowledge<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

Secondly we can provide an induction schema for the introduction of
common knowledge: from everyone in $as$ knows that $\phi$ implies
$\phi \land \psi$, and that $\phi$ is satisfied at world $w$, infer
that $\psi$ is common knowledge amongst $as$ at $w$.

›</span></span>

<span class="keyword1" id="Kripke-S5n_common_knowledge_induct"><span class="command">lemma</span></span> S5n_common_knowledge_induct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> S5n<span class="main">:</span> <span class="quoted"><span class="quoted">"S5n <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> worlds <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span> <span class="main">∈</span> set <span class="free">as</span><span class="main">.</span> <span class="main">∀</span><span class="bound">w</span> <span class="main">∈</span> worlds <span class="free">M</span><span class="main">.</span>
                 <span class="free">M</span><span class="main">,</span> <span class="bound">w</span> <span class="main">⊨</span> <span class="free">φ</span> <span class="main">⟶</span> <span class="free">M</span><span class="main">,</span> <span class="bound">w</span> <span class="main">⊨</span> <span class="keyword1"><span class="hidden">❙</span><b>K</b>⇩</span><span class="bound">a</span> <span class="main">(</span>Kand <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span><span class="main">,</span> <span class="free">w</span> <span class="main">⊨</span> <span class="free">φ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span><span class="main">,</span> <span class="free">w</span> <span class="main">⊨</span> <span class="hidden">❙</span><b>C</b><span class="hidden">⇘</span><sub><span class="free">as</span></sub><span class="hidden">⇙</span> <span class="free">ψ</span>"</span></span>
<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w'</span> <span class="keyword3"><span class="command">assume</span></span> ww'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="skolem">w'</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span>set <span class="free">as</span><span class="main">.</span> relations <span class="free">M</span> <span class="bound">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> ww' S5n E p w <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span><span class="main">,</span> <span class="skolem">w'</span> <span class="main">⊨</span> Kand <span class="free">φ</span> <span class="free">ψ</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span> <span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trancl_induct
         <span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* We actually use a simpler variant. *)</span>

<span class="keyword1" id="Kripke-S5n_common_knowledge_fixed_point_simpler"><span class="command">lemma</span></span> S5n_common_knowledge_fixed_point_simpler<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> S5n<span class="main">:</span> <span class="quoted"><span class="quoted">"S5n <span class="free">M</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> worlds <span class="free">M</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> set <span class="free">as</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span><span class="main">,</span> <span class="free">w</span> <span class="main">⊨</span> Kcknows <span class="free">as</span> <span class="free">φ</span> <span class="main">⟷</span> <span class="free">M</span><span class="main">,</span> <span class="free">w</span> <span class="main">⊨</span> Kknows <span class="free">a</span> <span class="main">(</span>Kcknows <span class="free">as</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> CK<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span><span class="main">,</span> <span class="free">w</span> <span class="main">⊨</span> Kcknows <span class="free">as</span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> S5n a w CK <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span><span class="main">,</span> <span class="free">w</span> <span class="main">⊨</span> Kknows <span class="free">a</span> <span class="main">(</span>Kcknows <span class="free">as</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> trancl_into_trancl2<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span><span class="main">,</span> <span class="free">w</span> <span class="main">⊨</span> Kknows <span class="free">a</span> <span class="main">(</span>Kcknows <span class="free">as</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> S5n w <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span><span class="main">,</span> <span class="free">w</span> <span class="main">⊨</span> <span class="main">(</span>Kcknows <span class="free">as</span> <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> S5n_knowledge<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*&gt;*)</span>

<span class="comment1">(* **************************************** *)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Generated models›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

\label{sec:generated_models}

The rest of this section introduces the technical machinery we use to
relate Kripke structures.

Intuitively the truth of a formula at a world depends only on the
worlds that are reachable from it in zero or more steps, using any of
the accessibility relations at each step. Traditionally this result is
called the \emph{generated model property}
\citep[\S3.4]{Chellas:1980}.

Given the model generated by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">w</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">M</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>:

›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">gen_model</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'w</span><span class="main">)</span> KripkeStructure <span class="main">⇒</span> <span class="tfree">'w</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'w</span><span class="main">)</span> KripkeStructure"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">gen_model</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">≡</span>
    <span class="keyword1">let</span> <span class="bound">ws'</span> <span class="main">=</span> worlds <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">∩</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">a</span><span class="main">.</span> relations <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="bound">a</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">}</span>
     <span class="keyword1">in</span> <span class="main">⦇</span> worlds <span class="main">=</span> <span class="bound">ws'</span><span class="main">,</span>
          relations <span class="main">=</span> <span class="main">λ</span><span class="bound">a</span><span class="main">.</span> relations <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="bound">a</span> <span class="main">∩</span> <span class="main">(</span><span class="bound">ws'</span> <span class="main">×</span> <span class="bound">ws'</span><span class="main">)</span><span class="main">,</span>
          valuation <span class="main">=</span> valuation <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">⦈</span>"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1" id="Kripke-gen_model_worldsD"><span class="command">lemma</span></span> gen_model_worldsD<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">w'</span> <span class="main">∈</span> worlds <span class="main">(</span>gen_model <span class="free">M</span> <span class="free">w</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">w'</span> <span class="main">∈</span> worlds <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> gen_model_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Kripke-gen_model_world_refl"><span class="command">lemma</span></span> gen_model_world_refl<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> worlds <span class="free">M</span> <span class="main">⟹</span> <span class="free">w</span> <span class="main">∈</span> worlds <span class="main">(</span>gen_model <span class="free">M</span> <span class="free">w</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> gen_model_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Kripke-gen_model_rels_worlds"><span class="command">lemma</span></span> gen_model_rels_worlds<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">w'</span><span class="main">,</span> <span class="free">w''</span><span class="main">)</span> <span class="main">∈</span> relations <span class="main">(</span>gen_model <span class="free">M</span> <span class="free">w</span><span class="main">)</span> <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w'</span> <span class="main">∈</span> worlds <span class="main">(</span>gen_model <span class="free">M</span> <span class="free">w</span><span class="main">)</span> <span class="main">∧</span> <span class="free">w''</span> <span class="main">∈</span> worlds <span class="main">(</span>gen_model <span class="free">M</span> <span class="free">w</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> gen_model_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Kripke-gen_model_rels_tc_worlds"><span class="command">lemma</span></span> gen_model_rels_tc_worlds<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">w'</span><span class="main">,</span> <span class="free">w''</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">a</span> <span class="main">∈</span> <span class="free">as</span><span class="main">.</span> relations <span class="main">(</span>gen_model <span class="free">M</span> <span class="free">w</span><span class="main">)</span> <span class="bound">a</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w''</span> <span class="main">∈</span> worlds <span class="main">(</span>gen_model <span class="free">M</span> <span class="free">w</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trancl_induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Kripke-gen_model_rels"><span class="command">lemma</span></span> gen_model_rels<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">w'</span><span class="main">,</span> <span class="free">w''</span><span class="main">)</span> <span class="main">∈</span> relations <span class="main">(</span>gen_model <span class="free">M</span> <span class="free">w</span><span class="main">)</span> <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">w'</span><span class="main">,</span> <span class="free">w''</span><span class="main">)</span> <span class="main">∈</span> relations <span class="free">M</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> gen_model_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Kripke-gen_model_worlds"><span class="command">lemma</span></span> gen_model_worlds<span class="main">:</span>
  <span class="quoted"><span class="quoted">"worlds <span class="main">(</span>gen_model <span class="free">M</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> worlds <span class="free">M</span> <span class="main">∩</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">a</span><span class="main">.</span> relations <span class="free">M</span> <span class="bound">a</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="main">{</span><span class="free">w</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> gen_model_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Kripke-gen_model_tc_rels"><span class="command">lemma</span></span> gen_model_tc_rels<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"kripke <span class="free">M</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">w'</span><span class="main">,</span> <span class="free">w''</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">a</span> <span class="main">∈</span> <span class="free">as</span><span class="main">.</span> relations <span class="main">(</span>gen_model <span class="free">M</span> <span class="free">w</span><span class="main">)</span> <span class="bound">a</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">w'</span><span class="main">,</span> <span class="free">w''</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">a</span> <span class="main">∈</span> <span class="free">as</span><span class="main">.</span> relations <span class="free">M</span> <span class="bound">a</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> R
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trancl_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>base <span class="skolem">y</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> M <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">y</span> <span class="skolem">z</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> M <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> worlds <span class="main">(</span>gen_model <span class="free">M</span> <span class="free">w</span><span class="main">)</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> worlds <span class="main">(</span>gen_model <span class="free">M</span> <span class="free">w</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> M step <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> trancl_into_trancl<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Kripke-gen_model_rels_rev"><span class="command">lemma</span></span> gen_model_rels_rev<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"kripke <span class="free">M</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">w'</span> <span class="main">∈</span> worlds <span class="main">(</span>gen_model <span class="free">M</span> <span class="free">w</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">w'</span><span class="main">,</span> <span class="free">w''</span><span class="main">)</span> <span class="main">∈</span> relations <span class="free">M</span> <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">w'</span><span class="main">,</span> <span class="free">w''</span><span class="main">)</span> <span class="main">∈</span> relations <span class="main">(</span>gen_model <span class="free">M</span> <span class="free">w</span><span class="main">)</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">unfolding</span></span> gen_model_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rtrancl_into_rtrancl<span class="main">)</span>

<span class="keyword1" id="Kripke-gen_model_tc_rels_rev"><span class="command">lemma</span></span> gen_model_tc_rels_rev<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"kripke <span class="free">M</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">w'</span><span class="main">,</span> <span class="free">w''</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">a</span> <span class="main">∈</span> <span class="free">as</span><span class="main">.</span> relations <span class="free">M</span> <span class="bound">a</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> W<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w'</span> <span class="main">∈</span> worlds <span class="main">(</span>gen_model <span class="free">M</span> <span class="free">w</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">w'</span><span class="main">,</span> <span class="free">w''</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">a</span> <span class="main">∈</span> <span class="free">as</span><span class="main">.</span> relations <span class="main">(</span>gen_model <span class="free">M</span> <span class="free">w</span><span class="main">)</span> <span class="bound">a</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> R W
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trancl_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>base <span class="skolem">y</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> M <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">y</span> <span class="skolem">z</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> M <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> worlds <span class="main">(</span>gen_model <span class="free">M</span> <span class="free">w</span><span class="main">)</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> worlds <span class="main">(</span>gen_model <span class="free">M</span> <span class="free">w</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> M step <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> trancl_into_trancl<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Kripke-gen_model_kripke"><span class="command">lemma</span></span> gen_model_kripke<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"kripke <span class="main">(</span>gen_model <span class="free">M</span> <span class="free">w</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> gen_model_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

where we take the image of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">w</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> under the reflexive transitive
closure of the agents' relations, we can show that the satisfaction of
a formula <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">φ</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> at a world <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">w'</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is preserved, provided
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">w'</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is relevant to the world <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">w</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> that the sub-model
is based upon:

›</span></span>

<span class="keyword1" id="Kripke-gen_model_semantic_equivalence"><span class="command">lemma</span></span> gen_model_semantic_equivalence<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"kripke <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> w'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w'</span> <span class="main">∈</span> worlds <span class="main">(</span>gen_model <span class="free">M</span> <span class="free">w</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span><span class="main">,</span> <span class="free">w'</span> <span class="main">⊨</span> <span class="free">φ</span> <span class="main">⟷</span> <span class="main">(</span>gen_model <span class="free">M</span> <span class="free">w</span><span class="main">)</span><span class="main">,</span> <span class="free">w'</span> <span class="main">⊨</span> <span class="free">φ</span>"</span></span>
<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span> <span class="skolem">w'</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w'</span> <span class="main">∈</span> worlds <span class="main">(</span>gen_model <span class="free">M</span> <span class="skolem">w</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span><span class="main">,</span> <span class="skolem">w'</span> <span class="main">⊨</span> <span class="free">φ</span> <span class="main">⟷</span> <span class="main">(</span>gen_model <span class="free">M</span> <span class="skolem">w</span><span class="main">)</span><span class="main">,</span> <span class="skolem">w'</span> <span class="main">⊨</span> <span class="free">φ</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">w'</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Kknows <span class="skolem">a</span> <span class="skolem">f</span> <span class="skolem">w'</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">assume</span></span> lhs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span><span class="main">,</span> <span class="skolem">w'</span> <span class="main">⊨</span> Kknows <span class="skolem">a</span> <span class="skolem">f</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> Kknows <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"gen_model <span class="free">M</span> <span class="skolem">w</span><span class="main">,</span> <span class="skolem">w'</span> <span class="main">⊨</span> Kknows <span class="skolem">a</span> <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> rhs<span class="main">:</span> <span class="quoted"><span class="quoted">"gen_model <span class="free">M</span> <span class="skolem">w</span><span class="main">,</span> <span class="skolem">w'</span> <span class="main">⊨</span> Kknows <span class="skolem">a</span> <span class="skolem">f</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> M Kknows <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span><span class="main">,</span> <span class="skolem">w'</span> <span class="main">⊨</span> Kknows <span class="skolem">a</span> <span class="skolem">f</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Kcknows <span class="skolem">as</span> <span class="skolem">f</span> <span class="skolem">w'</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">assume</span></span> lhs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span><span class="main">,</span> <span class="skolem">w'</span> <span class="main">⊨</span> Kcknows <span class="skolem">as</span> <span class="skolem">f</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> M Kcknows <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"gen_model <span class="free">M</span> <span class="skolem">w</span><span class="main">,</span> <span class="skolem">w'</span> <span class="main">⊨</span> Kcknows <span class="skolem">as</span> <span class="skolem">f</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> rhs<span class="main">:</span> <span class="quoted"><span class="quoted">"gen_model <span class="free">M</span> <span class="skolem">w</span><span class="main">,</span> <span class="skolem">w'</span> <span class="main">⊨</span> Kcknows <span class="skolem">as</span> <span class="skolem">f</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> M Kcknows <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span><span class="main">,</span> <span class="skolem">w'</span> <span class="main">⊨</span> Kcknows <span class="skolem">as</span> <span class="skolem">f</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gen_model_def<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">with</span></span> w' <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

This is shown by a straightforward structural induction over the
formula <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">φ</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

›</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1" id="Kripke-gen_model_S5n"><span class="command">lemma</span></span> gen_model_S5n<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> S5n<span class="main">:</span> <span class="quoted"><span class="quoted">"S5n <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"S5n <span class="main">(</span>gen_model <span class="free">M</span> <span class="free">w</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> S5nI equivI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> refl_on <span class="main">(</span>worlds <span class="main">(</span>gen_model <span class="free">M</span> <span class="free">w</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>relations <span class="main">(</span>gen_model <span class="free">M</span> <span class="free">w</span><span class="main">)</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> equivE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> S5nD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> S5n<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">rule</span> refl_onI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> refl_on_def gen_model_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> sym <span class="main">(</span>relations <span class="main">(</span>gen_model <span class="free">M</span> <span class="free">w</span><span class="main">)</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> equivE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> S5nD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> S5n<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> gen_model_def sym_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> trans <span class="main">(</span>relations <span class="main">(</span>gen_model <span class="free">M</span> <span class="free">w</span><span class="main">)</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> equivE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> S5nD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> S5n<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">rule</span> transI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gen_model_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> trans_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

If two models generate the same sub-model for a world, they satisfy
the same formulas at that world.

›</span></span>

<span class="keyword1" id="Kripke-gen_model_eq"><span class="command">lemma</span></span> gen_model_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"kripke <span class="free">M</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> M'<span class="main">:</span> <span class="quoted"><span class="quoted">"kripke <span class="free">M'</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"gen_model <span class="free">M</span> <span class="free">w</span> <span class="main">=</span> gen_model <span class="free">M'</span> <span class="free">w</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">w'</span> <span class="main">∈</span> worlds <span class="main">(</span>gen_model <span class="free">M'</span> <span class="free">w</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span><span class="main">,</span> <span class="free">w'</span> <span class="main">⊨</span> <span class="free">φ</span> <span class="main">⟷</span> <span class="free">M'</span><span class="main">,</span> <span class="free">w'</span> <span class="main">⊨</span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms gen_model_semantic_equivalence<span class="main">[</span><span class="operator">OF</span> M<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> w<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">w</span></span><span class="main">]</span>
              gen_model_semantic_equivalence<span class="main">[</span><span class="operator">OF</span> M'<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> w<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">w</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹

Our final lemma in this section is technical: it allows us to move
between two Kripke structures that have the same relevant worlds.

›</span></span>

<span class="keyword1" id="Kripke-gen_model_subset_aux"><span class="command">lemma</span></span> gen_model_subset_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> relations <span class="free">M</span> <span class="bound">a</span> <span class="main">∩</span> <span class="free">T</span> <span class="main">×</span> <span class="free">T</span> <span class="main">=</span> relations <span class="free">M'</span> <span class="bound">a</span> <span class="main">∩</span> <span class="free">T</span> <span class="main">×</span> <span class="free">T</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> T<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">a</span><span class="main">.</span> relations <span class="free">M</span> <span class="bound">a</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="main">{</span><span class="free">t</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">.</span> relations <span class="free">M</span> <span class="bound">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="main">{</span><span class="free">t</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">.</span> relations <span class="free">M'</span> <span class="bound">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="main">{</span><span class="free">t</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">t</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">.</span> relations <span class="free">M</span> <span class="bound">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">t</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">.</span> relations <span class="free">M'</span> <span class="bound">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rtrancl_induct<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">y</span> <span class="skolem">z</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> R T <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">y</span><span class="main">,</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">a</span><span class="main">.</span> relations <span class="free">M'</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> rtrancl_trans<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> step <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rtrancl_trans<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Kripke-gen_model_subset"><span class="command">lemma</span></span> gen_model_subset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"kripke <span class="free">M</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> M'<span class="main">:</span> <span class="quoted"><span class="quoted">"kripke <span class="free">M'</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> relations <span class="free">M</span> <span class="bound">a</span> <span class="main">∩</span> <span class="free">T</span> <span class="main">×</span> <span class="free">T</span> <span class="main">=</span> relations <span class="free">M'</span> <span class="bound">a</span> <span class="main">∩</span> <span class="free">T</span> <span class="main">×</span> <span class="free">T</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> tMT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">a</span><span class="main">.</span> relations <span class="free">M</span> <span class="bound">a</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="main">{</span><span class="free">t</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">T</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> tM'T<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">a</span><span class="main">.</span> relations <span class="free">M'</span> <span class="bound">a</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="main">{</span><span class="free">t</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">T</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> tM<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> worlds <span class="free">M</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> tM'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> worlds <span class="free">M'</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> V<span class="main">:</span> <span class="quoted"><span class="quoted">"valuation <span class="free">M</span> <span class="main">=</span> valuation <span class="free">M'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"gen_model <span class="free">M</span> <span class="free">t</span> <span class="main">=</span> gen_model <span class="free">M'</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> tMT tM'T gen_model_subset_aux<span class="main">[</span><span class="operator">OF</span> R<span class="main">]</span> gen_model_subset_aux<span class="main">[</span><span class="operator">OF</span> R<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">a</span><span class="main">.</span> relations <span class="free">M</span> <span class="bound">a</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="main">{</span><span class="free">t</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">a</span><span class="main">.</span> relations <span class="free">M'</span> <span class="bound">a</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="main">{</span><span class="free">t</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> M tMT tM <span class="keyword1"><span class="command">have</span></span> G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">a</span><span class="main">.</span> relations <span class="free">M</span> <span class="bound">a</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="main">{</span><span class="free">t</span><span class="main">}</span> <span class="main">⊆</span> worlds <span class="free">M</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> kripke_rels_trc_worlds<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> M' tM'T tM' <span class="keyword1"><span class="command">have</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">a</span><span class="main">.</span> relations <span class="free">M'</span> <span class="bound">a</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="main">{</span><span class="free">t</span><span class="main">}</span> <span class="main">⊆</span> worlds <span class="free">M'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> kripke_rels_trc_worlds<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> F G H <span class="keyword1"><span class="command">have</span></span> WORLDS<span class="main">:</span> <span class="quoted"><span class="quoted">"worlds <span class="main">(</span>gen_model <span class="free">M</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> worlds <span class="main">(</span>gen_model <span class="free">M'</span> <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> gen_model_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> Int_absorb1<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> RELATIONS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> relations <span class="main">(</span>gen_model <span class="free">M</span> <span class="free">t</span><span class="main">)</span> <span class="bound">a</span> <span class="main">=</span> relations <span class="main">(</span>gen_model <span class="free">M'</span> <span class="free">t</span><span class="main">)</span> <span class="bound">a</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Int_absorb1 G H gen_model_def<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">x</span> <span class="skolem">y</span>
      <span class="keyword3"><span class="command">assume</span></span> XY<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> relations <span class="free">M</span> <span class="skolem">a</span> <span class="main">∩</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">.</span> relations <span class="free">M</span> <span class="bound">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="main">{</span><span class="free">t</span><span class="main">}</span> <span class="main">×</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">.</span> relations <span class="free">M</span> <span class="bound">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="main">{</span><span class="free">t</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> XY tMT
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> relations <span class="free">M</span> <span class="skolem">a</span> <span class="main">∩</span> <span class="free">T</span> <span class="main">×</span> <span class="free">T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">with</span></span> R
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> relations <span class="free">M'</span> <span class="skolem">a</span> <span class="main">∩</span> <span class="free">T</span> <span class="main">×</span> <span class="free">T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">with</span></span> F XY tM'T
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> relations <span class="free">M'</span> <span class="skolem">a</span> <span class="main">∩</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">.</span> relations <span class="free">M'</span> <span class="bound">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="main">{</span><span class="free">t</span><span class="main">}</span> <span class="main">×</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">.</span> relations <span class="free">M'</span> <span class="bound">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="main">{</span><span class="free">t</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">x</span> <span class="skolem">y</span>
      <span class="keyword3"><span class="command">assume</span></span> XY<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> relations <span class="free">M'</span> <span class="skolem">a</span> <span class="main">∩</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">.</span> relations <span class="free">M'</span> <span class="bound">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="main">{</span><span class="free">t</span><span class="main">}</span> <span class="main">×</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">.</span> relations <span class="free">M'</span> <span class="bound">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="main">{</span><span class="free">t</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> XY tM'T
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> relations <span class="free">M'</span> <span class="skolem">a</span> <span class="main">∩</span> <span class="free">T</span> <span class="main">×</span> <span class="free">T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">with</span></span> R
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> relations <span class="free">M</span> <span class="skolem">a</span> <span class="main">∩</span> <span class="free">T</span> <span class="main">×</span> <span class="free">T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">with</span></span> F XY tMT
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> relations <span class="free">M</span> <span class="skolem">a</span> <span class="main">∩</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">.</span> relations <span class="free">M</span> <span class="bound">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="main">{</span><span class="free">t</span><span class="main">}</span> <span class="main">×</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">.</span> relations <span class="free">M</span> <span class="bound">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="main">{</span><span class="free">t</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Restr <span class="main">(</span>relations <span class="free">M</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">.</span> relations <span class="free">M</span> <span class="bound">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="main">{</span><span class="free">t</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span>
      Restr <span class="main">(</span>relations <span class="free">M'</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">.</span> relations <span class="free">M'</span> <span class="bound">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="main">{</span><span class="free">t</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_use</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Image_singleton_iff mem_Sigma_iff<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> WORLDS RELATIONS V <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> gen_model_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Simulations›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

\label{sec:kripke-theory-simulations}

A \emph{simulation}, or \emph{p-morphism}, is a mapping from the
worlds of one Kripke structure to another that preserves the truth of
all formulas at related worlds \citep[\S3.4, Ex. 3.60]{Chellas:1980}.
Such a function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">f</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> must satisfy four properties. Firstly, the
image of the set of worlds of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">M</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> under <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">f</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> should
equal the set of worlds of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">M'</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">sim_range</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'w1</span><span class="main">)</span> KripkeStructure
              <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'w2</span><span class="main">)</span> KripkeStructure <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'w1</span> <span class="main">⇒</span> <span class="tfree">'w2</span><span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sim_range</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">M'</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> worlds <span class="free"><span class="bound"><span class="entity">M'</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">`</span> worlds <span class="free"><span class="bound"><span class="entity">M</span></span></span>
                    <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">.</span> relations <span class="free"><span class="bound"><span class="entity">M'</span></span></span> <span class="bound">a</span> <span class="main">⊆</span> worlds <span class="free"><span class="bound"><span class="entity">M'</span></span></span> <span class="main">×</span> worlds <span class="free"><span class="bound"><span class="entity">M'</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The value of a proposition should be the same at corresponding
worlds:›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">sim_val</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'w1</span><span class="main">)</span> KripkeStructure
           <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'w2</span><span class="main">)</span> KripkeStructure <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'w1</span> <span class="main">⇒</span> <span class="tfree">'w2</span><span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sim_val</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">M'</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> worlds <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">.</span> valuation <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="bound">u</span> <span class="main">=</span> valuation <span class="free"><span class="bound"><span class="entity">M'</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">u</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

If two worlds are related in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">M</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, then the simulation
maps them to related worlds in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">M'</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>; intuitively the
simulation relates enough worlds. We term this the \emph{forward}
property.

›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">sim_f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'w1</span><span class="main">)</span> KripkeStructure
         <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'w2</span><span class="main">)</span> KripkeStructure <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'w1</span> <span class="main">⇒</span> <span class="tfree">'w2</span><span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sim_f</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">M'</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span>
     <span class="main">∀</span><span class="bound">a</span> <span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> relations <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="bound">a</span> <span class="main">⟶</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">u</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> relations <span class="free"><span class="bound"><span class="entity">M'</span></span></span> <span class="bound">a</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

Conversely, if two worlds <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">f</span></span> <span class="free"><span class="free">u</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">v'</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> are related
in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">M'</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, then there is a pair of related worlds <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">u</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">v</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">M</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> where <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">f</span></span> <span class="free"><span class="free">v</span></span> <span class="main"><span class="main">=</span></span> <span class="free"><span class="free">v'</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Intuitively
the simulation makes enough distinctions. We term this the
\emph{reverse} property.

›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">sim_r</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'w1</span><span class="main">)</span> KripkeStructure
         <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'w2</span><span class="main">)</span> KripkeStructure <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'w1</span> <span class="main">⇒</span> <span class="tfree">'w2</span><span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sim_r</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">M'</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">a</span><span class="main">.</span> <span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> worlds <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">.</span> <span class="main">∀</span><span class="bound">v'</span><span class="main">.</span>
              <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">u</span><span class="main">,</span> <span class="bound">v'</span><span class="main">)</span> <span class="main">∈</span> relations <span class="free"><span class="bound"><span class="entity">M'</span></span></span> <span class="bound">a</span>
           <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> relations <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="bound">a</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">v</span> <span class="main">=</span> <span class="bound">v'</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">sim</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">M'</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> sim_range <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">M'</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">∧</span> sim_val <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">M'</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>
                       <span class="main">∧</span> sim_f <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">M'</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">∧</span> sim_r <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">M'</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1" id="Kripke-sim_rangeI"><span class="command">lemma</span></span> sim_rangeI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> worlds <span class="free">M'</span> <span class="main">=</span> <span class="free">f</span> <span class="main">`</span> worlds <span class="free">M</span><span class="main">;</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> relations <span class="free">M'</span> <span class="bound">a</span> <span class="main">⊆</span> worlds <span class="free">M'</span> <span class="main">×</span> worlds <span class="free">M'</span><span class="main">)</span> <span class="main">⟧</span>
     <span class="main">⟹</span> sim_range <span class="free">M</span> <span class="free">M'</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sim_range_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Kripke-sim_valI"><span class="command">lemma</span></span> sim_valI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> worlds <span class="free">M</span> <span class="main">⟹</span> valuation <span class="free">M</span> <span class="bound">u</span> <span class="main">=</span> valuation <span class="free">M'</span> <span class="main">(</span><span class="free">f</span> <span class="bound">u</span><span class="main">)</span><span class="main">)</span>
   <span class="main">⟹</span> sim_val <span class="free">M</span> <span class="free">M'</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sim_val_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Kripke-sim_fI"><span class="command">lemma</span></span> sim_fI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">a</span> <span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> relations <span class="free">M</span> <span class="bound">a</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">f</span> <span class="bound">u</span><span class="main">,</span> <span class="free">f</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> relations <span class="free">M'</span> <span class="bound">a</span><span class="main">)</span>
   <span class="main">⟹</span> sim_f <span class="free">M</span> <span class="free">M'</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sim_f_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Kripke-sim_fD"><span class="command">lemma</span></span> sim_fD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">∈</span> relations <span class="free">M</span> <span class="free">a</span><span class="main">;</span> sim <span class="free">M</span> <span class="free">M'</span> <span class="free">f</span> <span class="main">⟧</span>
     <span class="main">⟹</span> <span class="main">(</span><span class="free">f</span> <span class="free">u</span><span class="main">,</span> <span class="free">f</span> <span class="free">v</span><span class="main">)</span> <span class="main">∈</span> relations <span class="free">M'</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sim_def sim_f_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Kripke-sim_rI"><span class="command">lemma</span></span> sim_rI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">a</span> <span class="bound">u</span> <span class="bound">v'</span><span class="main">.</span>
    <span class="main">⟦</span><span class="bound">u</span> <span class="main">∈</span> worlds <span class="free">M</span><span class="main">;</span> <span class="main">(</span><span class="free">f</span> <span class="bound">u</span><span class="main">,</span> <span class="bound">v'</span><span class="main">)</span> <span class="main">∈</span> relations <span class="free">M'</span> <span class="bound">a</span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> relations <span class="free">M</span> <span class="bound">a</span> <span class="main">∧</span> <span class="free">f</span> <span class="bound">v</span> <span class="main">=</span> <span class="bound">v'</span><span class="main">)</span><span class="main">)</span>
  <span class="main">⟹</span> sim_r <span class="free">M</span> <span class="free">M'</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sim_r_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Kripke-sim_rD"><span class="command">lemma</span></span> sim_rD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free">f</span> <span class="free">u</span><span class="main">,</span> <span class="free">v'</span><span class="main">)</span> <span class="main">∈</span> relations <span class="free">M'</span> <span class="free">a</span><span class="main">;</span> sim <span class="free">M</span> <span class="free">M'</span> <span class="free">f</span><span class="main">;</span> <span class="free">u</span> <span class="main">∈</span> worlds <span class="free">M</span> <span class="main">⟧</span>
     <span class="main">⟹</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> relations <span class="free">M</span> <span class="free">a</span> <span class="main">∧</span> <span class="free">f</span> <span class="bound">v</span> <span class="main">=</span> <span class="free">v'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sim_def sim_r_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Kripke-simI"><span class="command">lemma</span></span> simI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> sim_range <span class="free">M</span> <span class="free">M'</span> <span class="free">f</span><span class="main">;</span> sim_val <span class="free">M</span> <span class="free">M'</span> <span class="free">f</span><span class="main">;</span> sim_f <span class="free">M</span> <span class="free">M'</span> <span class="free">f</span><span class="main">;</span> sim_r <span class="free">M</span> <span class="free">M'</span> <span class="free">f</span> <span class="main">⟧</span>
     <span class="main">⟹</span> sim <span class="free">M</span> <span class="free">M'</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sim_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The identity is a simulation:›</span></span>

<span class="keyword1" id="Kripke-sim_id"><span class="command">lemma</span></span> sim_id<span class="main">:</span> <span class="quoted"><span class="quoted">"kripke <span class="free">M</span> <span class="main">⟹</span> sim <span class="free">M</span> <span class="free">M</span> id"</span></span>
<span class="comment1">(*&lt;*)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> sim_def sim_r_def sim_f_def sim_range_def sim_val_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="comment1">(*&gt;*)</span>

<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

Due to the common knowledge modality, we need to show the simulation
properties lift through the transitive closure. In particular we can
show that forward simulation is preserved:

›</span></span>

<span class="keyword1" id="Kripke-sim_f_tc"><span class="command">lemma</span></span> sim_f_tc<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"sim <span class="free">M</span> <span class="free">M'</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> uv'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">a</span><span class="main">∈</span><span class="free">as</span><span class="main">.</span> relations <span class="free">M</span> <span class="bound">a</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="free">u</span><span class="main">,</span> <span class="free">f</span> <span class="free">v</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">a</span><span class="main">∈</span><span class="free">as</span><span class="main">.</span> relations <span class="free">M'</span> <span class="bound">a</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span>
<span class="comment1">(*&lt;*)</span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span> <span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trancl_induct<span class="main"><span class="main">[</span></span><span class="operator">OF</span> uv'<span class="main"><span class="main">]</span></span>
       <span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> sim_fD <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> trancl_into_trancl <span class="main">)</span>
<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

Reverse simulation also:

›</span></span>

<span class="keyword1" id="Kripke-sim_r_tc"><span class="command">lemma</span></span> sim_r_tc<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"kripke <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"sim <span class="free">M</span> <span class="free">M'</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> worlds <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fuv'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="free">u</span><span class="main">,</span> <span class="free">v'</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">a</span><span class="main">∈</span><span class="free">as</span><span class="main">.</span> relations <span class="free">M'</span> <span class="bound">a</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">v</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">v</span> <span class="main">=</span> <span class="free">v'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">a</span><span class="main">∈</span><span class="free">as</span><span class="main">.</span> relations <span class="free">M</span> <span class="bound">a</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span>
<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">v</span><span class="main">.</span> <span class="main">⟦</span><span class="free">f</span> <span class="bound">v</span> <span class="main">=</span> <span class="free">v'</span><span class="main">;</span> <span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">a</span><span class="main">∈</span><span class="free">as</span><span class="main">.</span> relations <span class="free">M</span> <span class="bound">a</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">thesis</span>"</span></span>

  <span class="keyword1"><span class="command">from</span></span> fuv' <span class="keyword1"><span class="command">have</span></span> as_nempty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> fuv' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span><span class="main">.</span> <span class="free">f</span> <span class="bound">v</span> <span class="main">=</span> <span class="free">v'</span> <span class="main">∧</span> <span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">a</span><span class="main">∈</span><span class="free">as</span><span class="main">.</span> relations <span class="free">M</span> <span class="bound">a</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trancl_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>base <span class="skolem">v'</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> u s as_nempty <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> sim_rD<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">v'</span> <span class="skolem">w'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> fuv'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="free">u</span><span class="main">,</span> <span class="skolem">v'</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">a</span><span class="main">∈</span><span class="free">as</span><span class="main">.</span> relations <span class="free">M'</span> <span class="bound">a</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> v'w'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v'</span><span class="main">,</span> <span class="skolem">w'</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">a</span><span class="main">∈</span><span class="free">as</span><span class="main">.</span> relations <span class="free">M'</span> <span class="bound">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">from</span></span> step
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> vv'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">v</span> <span class="main">=</span> <span class="skolem">v'</span>"</span></span>
               <span class="keyword2"><span class="keyword">and</span></span> uv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">a</span><span class="main">∈</span><span class="free">as</span><span class="main">.</span> relations <span class="free">M</span> <span class="bound">a</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> s v'w' vv' kripke_tc_rels_worlds<span class="main">[</span><span class="operator">OF</span> uv M<span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> ww'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">w</span> <span class="main">=</span> <span class="skolem">w'</span>"</span></span>
               <span class="keyword2"><span class="keyword">and</span></span> vw<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">a</span><span class="main">∈</span><span class="free">as</span><span class="main">.</span> relations <span class="free">M</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> sim_rD<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> uv vw ww' <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> trancl_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> E <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Kripke-sim_f_trc"><span class="command">lemma</span></span> sim_f_trc<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> uv'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">a</span><span class="main">.</span> relations <span class="free">M</span> <span class="bound">a</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"sim <span class="free">M</span> <span class="free">M'</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="free">u</span><span class="main">,</span> <span class="free">f</span> <span class="free">v</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">a</span><span class="main">.</span> relations <span class="free">M'</span> <span class="bound">a</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span> <span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rtrancl_induct<span class="main"><span class="main">[</span></span><span class="operator">OF</span> uv'<span class="main"><span class="main">]</span></span>
       <span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> sim_fD <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rtrancl_into_rtrancl <span class="main">)</span>

<span class="keyword1" id="Kripke-sim_r_trc"><span class="command">lemma</span></span> sim_r_trc<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"sim <span class="free">M</span> <span class="free">M'</span> <span class="free">f</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> fuv'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="free">u</span><span class="main">,</span> <span class="free">v'</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">a</span><span class="main">.</span> relations <span class="free">M'</span> <span class="bound">a</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"kripke <span class="free">M</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> worlds <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">v</span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">v</span> <span class="main">=</span> <span class="free">v'</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">a</span><span class="main">.</span> relations <span class="free">M</span> <span class="bound">a</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">v</span><span class="main">.</span> <span class="main">⟦</span><span class="free">f</span> <span class="bound">v</span> <span class="main">=</span> <span class="free">v'</span><span class="main">;</span> <span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">a</span><span class="main">.</span> relations <span class="free">M</span> <span class="bound">a</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">thesis</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> fuv' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span><span class="main">.</span> <span class="free">f</span> <span class="bound">v</span> <span class="main">=</span> <span class="free">v'</span> <span class="main">∧</span> <span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">a</span><span class="main">.</span> relations <span class="free">M</span> <span class="bound">a</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rtrancl_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> base <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">v'</span> <span class="skolem">w'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> fuv'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="free">u</span><span class="main">,</span> <span class="skolem">v'</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">a</span><span class="main">.</span> relations <span class="free">M'</span> <span class="bound">a</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> v'w'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v'</span><span class="main">,</span> <span class="skolem">w'</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">a</span><span class="main">.</span> relations <span class="free">M'</span> <span class="bound">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">from</span></span> step
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> vv'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">v</span> <span class="main">=</span> <span class="skolem">v'</span>"</span></span>
               <span class="keyword2"><span class="keyword">and</span></span> uv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">a</span><span class="main">.</span> relations <span class="free">M</span> <span class="bound">a</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> s v'w' vv' kripke_rels_trc_worlds<span class="main">[</span><span class="operator">OF</span> uv u M<span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> ww'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">w</span> <span class="main">=</span> <span class="skolem">w'</span>"</span></span>
               <span class="keyword2"><span class="keyword">and</span></span> vw<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">a</span><span class="main">.</span> relations <span class="free">M</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> sim_rD<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> uv vw ww' <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rtrancl_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> E <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Kripke-sim_trc_commute"><span class="command">lemma</span></span> sim_trc_commute<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"kripke <span class="free">M</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"sim <span class="free">M</span> <span class="free">M'</span> <span class="free">f</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> worlds <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> <span class="main">(</span><span class="main">(</span><span class="main">⋃</span><span class="bound">a</span><span class="main">.</span> relations <span class="free">M</span> <span class="bound">a</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="main">{</span><span class="free">t</span><span class="main">}</span><span class="main">)</span>
       <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">a</span><span class="main">.</span> relations <span class="free">M'</span> <span class="bound">a</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="main">{</span><span class="free">f</span> <span class="free">t</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">from</span></span> M s <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">⊆</span> <span class="var">?rhs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sim_f_trc<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">from</span></span> M s t <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span> <span class="main">⊆</span> <span class="var">?lhs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> sim_r_trc<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Kripke-sim_kripke"><span class="command">lemma</span></span> sim_kripke<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> sim <span class="free">M</span> <span class="free">M'</span> <span class="free">f</span><span class="main">;</span> kripke <span class="free">M</span> <span class="main">⟧</span> <span class="main">⟹</span> kripke <span class="free">M'</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sim_def sim_range_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> kripkeI<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1" id="Kripke-sim_S5n"><span class="command">lemma</span></span> sim_S5n<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> S5n<span class="main">:</span> <span class="quoted"><span class="quoted">"S5n <span class="free">M</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> sim<span class="main">:</span> <span class="quoted"><span class="quoted">"sim <span class="free">M</span> <span class="free">M'</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"S5n <span class="free">M'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> S5nI equivI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="keyword1"><span class="command">from</span></span> S5n sim <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"refl_on <span class="main">(</span>worlds <span class="free">M'</span><span class="main">)</span> <span class="main">(</span>relations <span class="free">M'</span> <span class="skolem">a</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> sim_kripke S5n_kripke
     <span class="keyword1"><span class="command">unfolding</span></span> S5n_def equiv_def sim_def sim_f_def sim_range_def
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">rule</span> refl_onI<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> refl_onD<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span> <span class="skolem">v</span> <span class="keyword3"><span class="command">assume</span></span> uv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">∈</span> relations <span class="free">M'</span> <span class="skolem">a</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> sim uv
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="keyword2"><span class="keyword">where</span></span> uw<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u'</span> <span class="main">∈</span> worlds <span class="free">M</span>"</span></span>
                <span class="keyword2"><span class="keyword">and</span></span> fu<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">u'</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> sim_def sim_range_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">bestsimp</span>
    <span class="keyword1"><span class="command">from</span></span> sim uv fu uw
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v'</span></span> <span class="keyword2"><span class="keyword">where</span></span> u'v'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u'</span><span class="main">,</span> <span class="skolem">v'</span><span class="main">)</span> <span class="main">∈</span> relations <span class="free">M</span> <span class="skolem">a</span>"</span></span>
                <span class="keyword2"><span class="keyword">and</span></span> fv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">v'</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> sim_def sim_r_def sim_range_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">best</span>
    <span class="keyword1"><span class="command">from</span></span> S5n u'v' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v'</span><span class="main">,</span> <span class="skolem">u'</span><span class="main">)</span> <span class="main">∈</span> relations <span class="free">M</span> <span class="skolem">a</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> S5n_def equiv_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> symD<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> sim fu fv <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">∈</span> relations <span class="free">M'</span> <span class="skolem">a</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> sim_def sim_f_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"sym <span class="main">(</span>relations <span class="free">M'</span> <span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> symI<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span>
    <span class="keyword3"><span class="command">assume</span></span> xy<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> relations <span class="free">M'</span> <span class="skolem">a</span>"</span></span>
       <span class="keyword2"><span class="keyword">and</span></span> yz<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">y</span><span class="main">,</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">∈</span> relations <span class="free">M'</span> <span class="skolem">a</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> sim xy
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="keyword2"><span class="keyword">where</span></span> xw<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">∈</span> worlds <span class="free">M</span>"</span></span>
                <span class="keyword2"><span class="keyword">and</span></span> fx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">x'</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> sim_def sim_range_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">bestsimp</span>
    <span class="keyword1"><span class="command">from</span></span> sim xy fx xw
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y'</span></span> <span class="keyword2"><span class="keyword">where</span></span> x'y'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x'</span><span class="main">,</span> <span class="skolem">y'</span><span class="main">)</span> <span class="main">∈</span> relations <span class="free">M</span> <span class="skolem">a</span>"</span></span>
                <span class="keyword2"><span class="keyword">and</span></span> fy<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">y'</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> sim_def sim_r_def sim_range_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">best</span>
    <span class="keyword1"><span class="command">from</span></span> S5n sim yz fy x'y'
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z'</span></span> <span class="keyword2"><span class="keyword">where</span></span> y'z'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">y'</span><span class="main">,</span> <span class="skolem">z'</span><span class="main">)</span> <span class="main">∈</span> relations <span class="free">M</span> <span class="skolem">a</span>"</span></span>
                <span class="keyword2"><span class="keyword">and</span></span> fz<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">z'</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> sim_def sim_r_def sim_range_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">best</span>
    <span class="keyword1"><span class="command">from</span></span> S5n x'y' y'z' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x'</span><span class="main">,</span> <span class="skolem">z'</span><span class="main">)</span> <span class="main">∈</span> relations <span class="free">M</span> <span class="skolem">a</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> S5n_def equiv_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> transD<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> sim fx fy fz <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">∈</span> relations <span class="free">M'</span> <span class="skolem">a</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> sim_def sim_f_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"trans <span class="main">(</span>relations <span class="free">M'</span> <span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> transI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

Finally we establish the key property of simulations, that they
preserve the satisfaction of all formulas in the following way:

›</span></span>

<span class="keyword1" id="Kripke-sim_semantic_equivalence"><span class="command">lemma</span></span> sim_semantic_equivalence<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"kripke <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"sim <span class="free">M</span> <span class="free">M'</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> worlds <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span><span class="main">,</span> <span class="free">u</span> <span class="main">⊨</span> <span class="free">φ</span> <span class="main">⟷</span> <span class="free">M'</span><span class="main">,</span> <span class="free">f</span> <span class="free">u</span> <span class="main">⊨</span> <span class="free">φ</span>"</span></span>
<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">using</span></span> u
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">u</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Kknows <span class="skolem">a</span> <span class="skolem">ψ</span> <span class="skolem">u</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> worlds <span class="free">M</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> lhs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span><span class="main">,</span> <span class="skolem">u</span> <span class="main">⊨</span> Kknows <span class="skolem">a</span> <span class="skolem">ψ</span>"</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v'</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="skolem">u</span><span class="main">,</span> <span class="skolem">v'</span><span class="main">)</span> <span class="main">∈</span> relations <span class="free">M'</span> <span class="skolem">a</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> s u <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> uv<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">∈</span> relations <span class="free">M</span> <span class="skolem">a</span>"</span></span>
                          <span class="keyword2"><span class="keyword">and</span></span> vv'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">v</span> <span class="main">=</span> <span class="skolem">v'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> sim_rD<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> lhs uv <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span><span class="main">,</span> <span class="skolem">v</span> <span class="main">⊨</span> <span class="skolem">ψ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> kripke_rels_worlds<span class="main">[</span><span class="operator">OF</span> uv M<span class="main">]</span> vv' Kknows
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">M'</span><span class="main">,</span> <span class="skolem">v'</span> <span class="main">⊨</span> <span class="skolem">ψ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">M'</span><span class="main">,</span> <span class="free">f</span> <span class="skolem">u</span> <span class="main">⊨</span> Kknows <span class="skolem">a</span> <span class="skolem">ψ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> rhs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M'</span><span class="main">,</span> <span class="free">f</span> <span class="skolem">u</span> <span class="main">⊨</span> Kknows <span class="skolem">a</span> <span class="skolem">ψ</span>"</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="keyword3"><span class="command">assume</span></span> uv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">∈</span> relations <span class="free">M</span> <span class="skolem">a</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> s <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="skolem">u</span><span class="main">,</span> <span class="free">f</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">∈</span> relations <span class="free">M'</span> <span class="skolem">a</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> sim_fD<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> rhs <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">M'</span><span class="main">,</span> <span class="free">f</span> <span class="skolem">v</span> <span class="main">⊨</span> <span class="skolem">ψ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> kripke_rels_worlds<span class="main">[</span><span class="operator">OF</span> uv M<span class="main">]</span> Kknows s
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span><span class="main">,</span> <span class="skolem">v</span> <span class="main">⊨</span> <span class="skolem">ψ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span><span class="main">,</span> <span class="skolem">u</span> <span class="main">⊨</span> Kknows <span class="skolem">a</span> <span class="skolem">ψ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Kcknows <span class="skolem">as</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> worlds <span class="free">M</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> lhs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span><span class="main">,</span> <span class="skolem">u</span> <span class="main">⊨</span> Kcknows <span class="skolem">as</span> <span class="skolem">ψ</span>"</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v'</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="skolem">u</span><span class="main">,</span> <span class="skolem">v'</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span>set <span class="skolem">as</span><span class="main">.</span> relations <span class="free">M'</span> <span class="bound">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> M s u
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> uv<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span>set <span class="skolem">as</span><span class="main">.</span> relations <span class="free">M</span> <span class="bound">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span>
                <span class="keyword2"><span class="keyword">and</span></span> vv'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">v</span> <span class="main">=</span> <span class="skolem">v'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sim_r_tc<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> uv lhs <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span><span class="main">,</span> <span class="skolem">v</span> <span class="main">⊨</span> <span class="skolem">ψ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> kripke_tc_rels_worlds<span class="main">[</span><span class="operator">OF</span> uv M<span class="main">]</span> vv' Kcknows
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">M'</span><span class="main">,</span> <span class="skolem">v'</span> <span class="main">⊨</span> <span class="skolem">ψ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">M'</span><span class="main">,</span> <span class="free">f</span> <span class="skolem">u</span> <span class="main">⊨</span> Kcknows <span class="skolem">as</span> <span class="skolem">ψ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> rhs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M'</span><span class="main">,</span> <span class="free">f</span> <span class="skolem">u</span> <span class="main">⊨</span> Kcknows <span class="skolem">as</span> <span class="skolem">ψ</span>"</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="keyword3"><span class="command">assume</span></span> uv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span>set <span class="skolem">as</span><span class="main">.</span> relations <span class="free">M</span> <span class="bound">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> s <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="skolem">u</span><span class="main">,</span> <span class="free">f</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span>set <span class="skolem">as</span><span class="main">.</span> relations <span class="free">M'</span> <span class="bound">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> sim_f_tc<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> rhs <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">M'</span><span class="main">,</span> <span class="free">f</span> <span class="skolem">v</span> <span class="main">⊨</span> <span class="skolem">ψ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> kripke_tc_rels_worlds<span class="main">[</span><span class="operator">OF</span> uv M<span class="main">]</span> Kcknows s
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span><span class="main">,</span> <span class="skolem">v</span> <span class="main">⊨</span> <span class="skolem">ψ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span><span class="main">,</span> <span class="skolem">u</span> <span class="main">⊨</span> Kcknows <span class="skolem">as</span> <span class="skolem">ψ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> s<span class="main"><span class="keyword3">,</span></span>
     <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sim_range_def sim_def sim_val_def<span class="main">)</span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The proof is by structural induction over the formula <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">φ</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. The
knowledge cases appeal to our two simulation preservation lemmas.

\citet{DBLP:journals/toplas/Sangiorgi09} surveys the history of
p-morphisms and the related concept of \emph{bisimulation}.

This is all we need to know about Kripke structures.

›</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="Traces">
<div class="head">
<h1>Theory Traces</h1>
</div>
<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="comment1">(*
 * Knowledge-based programs.
 * (C)opyright 2011, Peter Gammie, peteg42 at gmail.com.
 * License: BSD
 *)</span>

<span class="keyword1"><span class="command">theory</span></span> Traces
<span class="keyword2"><span class="keyword">imports</span></span> <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Traces›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

A \emph{trace} is a non-empty sequence of states. This custom type has
the advantage over the standard HOL list type of providing a more
suitable induction rule. We use these to give a semantics to
knowledge-based programs in \S\ref{sec:kbps-theory-kbps-semantics}.

›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'s</span> Trace <span class="main">=</span> tInit <span class="quoted"><span class="quoted">"<span class="tfree">'s</span>"</span></span>
                  <span class="main">|</span> tStep <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> Trace"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">↝</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span> 65<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">tFirst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> Trace <span class="main">⇒</span> <span class="tfree">'s</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">tFirst</span> <span class="main">(</span>tInit <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">tFirst</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">↝</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">tFirst</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">tLast</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> Trace <span class="main">⇒</span> <span class="tfree">'s</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">tLast</span> <span class="main">(</span>tInit <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">tLast</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">↝</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1" id="Traces-tLast_tInit_comp"><span class="command">lemma</span></span> tLast_tInit_comp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"tLast <span class="main">∘</span> tInit <span class="main">=</span> id"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span> <span class="operator">simp</span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

We provide a few of the standard list operations: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">tLength</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">tMap</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">tZip</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Our later ease hinges on taking the
length of a trace to be zero-based.

›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">tLength</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> Trace <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">tLength</span> <span class="main">(</span>tInit <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">tLength</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">↝</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="free">tLength</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1" id="Traces-tLength_0_conv"><span class="command">lemma</span></span> tLength_0_conv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>tLength <span class="free">t</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">s</span><span class="main">.</span> <span class="free">t</span> <span class="main">=</span> tInit <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Traces-tLength_g0_conv"><span class="command">lemma</span></span> tLength_g0_conv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>tLength <span class="free">t</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">s</span> <span class="bound">t'</span><span class="main">.</span> <span class="free">t</span> <span class="main">=</span> <span class="bound">t'</span> <span class="main">↝</span> <span class="bound">s</span> <span class="main">∧</span> tLength <span class="free">t</span> <span class="main">=</span> Suc <span class="main">(</span>tLength <span class="bound">t'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Traces-tLength_Suc"><span class="command">lemma</span></span> tLength_Suc<span class="main">:</span>
  <span class="quoted"><span class="quoted">"tLength <span class="free">t</span> <span class="main">=</span> Suc <span class="free">n</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∃</span><span class="bound">s</span> <span class="bound">t'</span><span class="main">.</span> <span class="free">t</span> <span class="main">=</span> <span class="bound">t'</span> <span class="main">↝</span> <span class="bound">s</span> <span class="main">∧</span> tLength <span class="bound">t'</span> <span class="main">=</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Traces-trace_induct2"><span class="command">lemma</span></span> trace_induct2<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> tInit tStep<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tLen<span class="main">:</span> <span class="quoted"><span class="quoted">"tLength <span class="free">t</span> <span class="main">=</span> tLength <span class="free">t'</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> tI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>tInit <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>tInit <span class="bound">s'</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> tS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">s'</span> <span class="bound">t</span> <span class="bound">t'</span><span class="main">.</span> <span class="main">⟦</span> tLength <span class="bound">t</span> <span class="main">=</span> tLength <span class="bound">t'</span><span class="main">;</span> <span class="free">P</span> <span class="bound">t</span> <span class="bound">t'</span> <span class="main">⟧</span>
               <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">t</span> <span class="main">↝</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span><span class="bound">t'</span> <span class="main">↝</span> <span class="bound">s'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">t</span> <span class="free">t'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> tLen
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t'</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tInit <span class="skolem">s</span> <span class="skolem">t'</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> tI <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> tLength_0_conv<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tStep <span class="skolem">t</span> <span class="skolem">s</span> <span class="skolem">t'</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> tS <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t'</span></span><span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">tMap</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">tMap</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>tInit <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> tInit <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">tMap</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">↝</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">tMap</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">↝</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1" id="Traces-tLength_tMap"><span class="command">lemma</span></span> tLength_tMap<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"tLength <span class="main">(</span>tMap <span class="free">f</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> tLength <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Traces-tMap_is_tInit"><span class="command">lemma</span></span> tMap_is_tInit<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>tMap <span class="free">f</span> <span class="free">t</span> <span class="main">=</span> tInit <span class="free">s</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">s'</span><span class="main">.</span> <span class="free">t</span> <span class="main">=</span> tInit <span class="bound">s'</span> <span class="main">∧</span> <span class="free">f</span> <span class="bound">s'</span> <span class="main">=</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Traces-tInit_is_tMap"><span class="command">lemma</span></span> tInit_is_tMap<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>tInit <span class="free">s</span> <span class="main">=</span> tMap <span class="free">f</span> <span class="free">t</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">s'</span><span class="main">.</span> <span class="free">t</span> <span class="main">=</span> tInit <span class="bound">s'</span> <span class="main">∧</span> <span class="free">f</span> <span class="bound">s'</span> <span class="main">=</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Traces-tStep_is_tMap_conv"><span class="command">lemma</span></span> tStep_is_tMap_conv<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">tp</span> <span class="main">↝</span> <span class="free">s</span> <span class="main">=</span> tMap <span class="free">f</span> <span class="free">t</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">tp'</span> <span class="bound">s'</span><span class="main">.</span> <span class="free">t</span> <span class="main">=</span> <span class="bound">tp'</span> <span class="main">↝</span> <span class="bound">s'</span> <span class="main">∧</span> <span class="free">s</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">s'</span> <span class="main">∧</span> <span class="free">tp</span> <span class="main">=</span> tMap <span class="free">f</span> <span class="bound">tp'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Traces-tMap_is_tStep_conv"><span class="command">lemma</span></span> tMap_is_tStep_conv<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">(</span>tMap <span class="free">f</span> <span class="free">t</span> <span class="main">=</span> <span class="free">tp</span> <span class="main">↝</span> <span class="free">s</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">tp'</span> <span class="bound">s'</span><span class="main">.</span> <span class="free">t</span> <span class="main">=</span> <span class="bound">tp'</span> <span class="main">↝</span> <span class="bound">s'</span> <span class="main">∧</span> <span class="free">s</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">s'</span> <span class="main">∧</span> tMap <span class="free">f</span> <span class="bound">tp'</span> <span class="main">=</span> <span class="free">tp</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Traces-tMap_eq_imp_tLength_eq"><span class="command">lemma</span></span> tMap_eq_imp_tLength_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"tMap <span class="free">f</span> <span class="free">t</span> <span class="main">=</span> tMap <span class="free">f'</span> <span class="free">t'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"tLength <span class="free">t</span> <span class="main">=</span> tLength <span class="free">t'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t'</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tStep <span class="skolem">tp</span> <span class="skolem">s</span> <span class="skolem">t'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">tp'</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="keyword2"><span class="keyword">where</span></span> t'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> <span class="skolem">tp'</span> <span class="main">↝</span> <span class="skolem">s'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> tStep <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tLength <span class="skolem">tp'</span> <span class="main">=</span> tLength <span class="skolem">tp</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> t' <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Traces-tMap_tFirst"><span class="command">lemma</span></span> tMap_tFirst<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"tFirst <span class="main">(</span>tMap <span class="free">f</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span>tFirst <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Traces-tMap_tLast"><span class="command">lemma</span></span> tMap_tLast<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"tLast <span class="main">(</span>tMap <span class="free">f</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span>tLast <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Traces-tMap_tFirst_inv"><span class="command">lemma</span></span> tMap_tFirst_inv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"tMap <span class="free">f</span> <span class="free">t</span> <span class="main">=</span> tMap <span class="free">f'</span> <span class="free">t'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span>tFirst <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">f'</span> <span class="main">(</span>tFirst <span class="free">t'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> M <span class="keyword1"><span class="command">have</span></span> L<span class="main">:</span> <span class="quoted"><span class="quoted">"tLength <span class="free">t</span> <span class="main">=</span> tLength <span class="free">t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> tMap_eq_imp_tLength_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> L M <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trace_induct2<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Traces-tMap_tLast_inv"><span class="command">lemma</span></span> tMap_tLast_inv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"tMap <span class="free">f</span> <span class="free">t</span> <span class="main">=</span> tMap <span class="free">f'</span> <span class="free">t'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span>tLast <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">f'</span> <span class="main">(</span>tLast <span class="free">t'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> M <span class="keyword1"><span class="command">have</span></span> L<span class="main">:</span> <span class="quoted"><span class="quoted">"tLength <span class="free">t</span> <span class="main">=</span> tLength <span class="free">t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> tMap_eq_imp_tLength_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> L M <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trace_induct2<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">tZip</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">tZip</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>tInit <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>tInit <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> tInit <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">tZip</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">↝</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">↝</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">tZip</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">↝</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1" id="Traces-tLength_tZip"><span class="command">lemma</span></span> tLength_tZip<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"tLength <span class="free">xs</span> <span class="main">=</span> tLength <span class="free">ys</span> <span class="main">⟹</span> tLength <span class="main">(</span>tZip <span class="free">f</span> <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> tLength <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trace_induct2<span class="main">)</span> <span class="operator">simp_all</span>

<span class="comment1">(*&gt;*)</span>
<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="KBPs">
<div class="head">
<h1>Theory KBPs</h1>
</div>
<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="comment1">(*
 * Knowledge-based programs.
 * (C)opyright 2011, Peter Gammie, peteg42 at gmail.com.
 * License: BSD
 *)</span>

<span class="keyword1"><span class="command">theory</span></span> KBPs
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#Kripke">Kripke</a> <a href="#Traces">Traces</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Knowledge-based Programs›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹

\label{sec:kbps-theory-kbps-semantics}

A knowledge-based programs (KBPs) encodes the dependency of action on
knowledge by a sequence of guarded commands, and a \emph{joint
knowledge-based program} (JKBP) assigns a KBP to each agent:

›</span></span>

<span class="keyword1"><span class="command">record</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'aAct</span><span class="main">)</span> GC <span class="main">=</span>
  guard  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">)</span> Kform"</span></span>
  action <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'aAct</span>"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'aAct</span><span class="main">)</span> KBP <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'aAct</span><span class="main">)</span> GC list"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'aAct</span><span class="main">)</span> JKBP <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'aAct</span><span class="main">)</span> KBP"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

We use a list of guarded commands just so we can reuse this definition
and others in algorithmic contexts; we would otherwise use a set as
there is no problem with infinite programs or actions, and we always
ignore the sequential structure.

Intuitively a KBP for an agent cannot directly evaluate the truth of
an arbitrary formula as it may depend on propositions that the agent
has no certainty about. For example, a card-playing agent cannot
determine which cards are in the deck, despite being sure that those
in her hand are not. Conversely agent $a$ can evaluate formulas of the
form <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="hidden">❙</span><b>K</b>⇩</span></span><span class="free"><span class="free">a</span></span> <span class="free"><span class="free">φ</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> as these depend only on the worlds the agent thinks
is possible.

Thus we restrict the guards of the JKBP to be boolean combinations of
\emph{subjective} formulas:

›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">subjective</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">)</span> Kform <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">subjective</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>Kprop <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>      <span class="main">=</span> False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">subjective</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>Knot <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span>       <span class="main">=</span> <span class="free">subjective</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">subjective</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>Kand <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span>     <span class="main">=</span> <span class="main">(</span><span class="free">subjective</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">∧</span> <span class="free">subjective</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">subjective</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>Kknows <span class="free"><span class="bound"><span class="entity">a'</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span>  <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">subjective</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>Kcknows <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

All JKBPs in the following sections are assumed to be subjective.

This syntactic restriction implies the desired semantic property, that
we can evaluate a guard at an arbitrary world that is compatible with
a given observation \citep[\S3]{DBLP:journals/dc/FaginHMV97}.

›</span></span>

<span class="keyword1" id="KBPs-S5n_subjective_eq"><span class="command">lemma</span></span> S5n_subjective_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> S5n<span class="main">:</span> <span class="quoted"><span class="quoted">"S5n <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> subj<span class="main">:</span> <span class="quoted"><span class="quoted">"subjective <span class="free">a</span> <span class="free">φ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ww'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">w'</span><span class="main">)</span> <span class="main">∈</span> relations <span class="free">M</span> <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span><span class="main">,</span> <span class="free">w</span> <span class="main">⊨</span> <span class="free">φ</span> <span class="main">⟷</span> <span class="free">M</span><span class="main">,</span> <span class="free">w'</span> <span class="main">⊨</span> <span class="free">φ</span>"</span></span>
<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">using</span></span> subj ww'
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> subjective.induct<span class="main"><span class="main">[</span></span><span class="operator">case_names</span> Kprop Knot Kand Kknows Kcknows<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Kcknows <span class="skolem">a</span> <span class="skolem">as</span> <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">w'</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">a</span><span class="main">∈</span>set <span class="skolem">as</span><span class="main">.</span> relations <span class="free">M</span> <span class="bound">a</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> Kcknows S5n <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> S5n_tc_rels_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> S5n_rels_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> S5n<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The proof is by induction over the formula <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">φ</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, using the
properties of $S5_n$ Kripke structures in the knowledge cases.

We capture the fixed but arbitrary JKBP using a locale, and work in
this context for the rest of this section.

›</span></span>

<span class="keyword1"><span class="command">locale</span></span> JKBP <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">jkbp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'aAct</span><span class="main">)</span> JKBP"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> subj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span> <span class="bound">gc</span><span class="main">.</span> <span class="bound">gc</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">jkbp</span> <span class="bound">a</span><span class="main">)</span> <span class="main">⟶</span> subjective <span class="bound">a</span> <span class="main">(</span>guard <span class="bound">gc</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span> JKBP
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The action of the JKBP at a world is the list of all actions that are
enabled at that world:

›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">jAction</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'w</span><span class="main">)</span> KripkeStructure <span class="main">⇒</span> <span class="tfree">'w</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'aAct</span> list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">jAction</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">M</span> <span class="bound">w</span> <span class="bound">a</span><span class="main">.</span> <span class="main">[</span> action <span class="bound">gc</span><span class="main">.</span> gc <span class="main">←</span> <span class="free">jkbp</span> <span class="bound">a</span><span class="main">,</span> <span class="bound">M</span><span class="main">,</span> <span class="bound">w</span> <span class="main">⊨</span> guard <span class="bound">gc</span> <span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

All of our machinery on Kripke structures lifts from the models
relation of \S\ref{sec:kbps-logic-of-knowledge} through <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>
<span class="quoted"><span class="quoted">"jAction"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, due to the subjectivity requirement. In particular, the
KBP for agent $a$ behaves the same at worlds that $a$ cannot
distinguish amongst:

›</span></span>

<span class="keyword1" id="KBPs-S5n_jAction_eq"><span class="command">lemma</span></span> S5n_jAction_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> S5n<span class="main">:</span> <span class="quoted"><span class="quoted">"S5n <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ww'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="free">w'</span><span class="main">)</span> <span class="main">∈</span> relations <span class="free">M</span> <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"jAction <span class="free">M</span> <span class="free">w</span> <span class="free">a</span> <span class="main">=</span> jAction <span class="free">M</span> <span class="free">w'</span> <span class="free">a</span>"</span></span>
<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">gc</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">gc</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">jkbp</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> subj <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subjective <span class="free">a</span> <span class="main">(</span>guard <span class="skolem">gc</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> S5n ww' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span><span class="main">,</span> <span class="free">w</span> <span class="main">⊨</span> guard <span class="skolem">gc</span> <span class="main">=</span> <span class="free">M</span><span class="main">,</span> <span class="free">w'</span> <span class="main">⊨</span> guard <span class="skolem">gc</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">rule</span> S5n_subjective_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> jAction_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">concat</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

Also the JKBP behaves the same on relevant generated models for all
agents:

›</span></span>

<span class="keyword1" id="KBPs-gen_model_jAction_eq"><span class="command">lemma</span></span> gen_model_jAction_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"gen_model <span class="free">M</span> <span class="free">w</span> <span class="main">=</span> gen_model <span class="free">M'</span> <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> w'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w'</span> <span class="main">∈</span> worlds <span class="main">(</span>gen_model <span class="free">M'</span> <span class="free">w</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"kripke <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> M'<span class="main">:</span> <span class="quoted"><span class="quoted">"kripke <span class="free">M'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"jAction <span class="free">M</span> <span class="free">w'</span> <span class="main">=</span> jAction <span class="free">M'</span> <span class="free">w'</span>"</span></span>
<span class="comment1">(*&lt;*)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> jAction_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> gen_model_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> M M' S w'<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

Finally, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"jAction"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is invariant under simulations:

›</span></span>

<span class="keyword1" id="KBPs-simulation_jAction_eq"><span class="command">lemma</span></span> simulation_jAction_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"kripke <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sim<span class="main">:</span> <span class="quoted"><span class="quoted">"sim <span class="free">M</span> <span class="free">M'</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> worlds <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"jAction <span class="free">M</span> <span class="free">w</span> <span class="main">=</span> jAction <span class="free">M'</span> <span class="main">(</span><span class="free">f</span> <span class="free">w</span><span class="main">)</span>"</span></span>
<span class="comment1">(*&lt;*)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> jAction_def
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> sim_semantic_equivalence<span class="main">)</span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Environments and Views›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

\label{sec:kbps-theory-environments}

The previous section showed how a JKBP can be interpreted statically,
with respect to a fixed Kripke structure. As we also wish to capture
how agents interact, we adopt the \emph{interpreted systems} and
\emph{contexts} of \cite{FHMV:1995}, which we term \emph{environments}
following \cite{Ron:1996}.

A \emph{pre-environment} consists of the following:
\begin{itemize}

\item <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">envInit</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, an arbitrary set of initial states;

\item The protocol of the environment <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">envAction</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, which
  depends on the current state;

\item A transition function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">envTrans</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, which incorporates the
  environment's action and agents' behaviour into a state change; and

\item A propositional evaluation function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">envVal</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

\end{itemize}
We extend the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"JKBP"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> locale with these constants:

›</span></span>

<span class="keyword1"><span class="command">locale</span></span> PreEnvironment <span class="main">=</span> JKBP <span class="quoted"><span class="free">jkbp</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">jkbp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'aAct</span><span class="main">)</span> JKBP"</span></span>
<span class="main">+</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">envInit</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> list"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">envAction</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'eAct</span> list"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">envTrans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'eAct</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'aAct</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">envVal</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> bool"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

\label{sec:kbps-views}

We represent the possible evolutions of the system as finite sequences
of states, represented by a left-recursive type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'s</span></span> Trace"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> with
constructors <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"tInit <span class="free"><span class="free">s</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">t</span></span> <span class="main"><span class="main">↝</span></span> <span class="free"><span class="free">s</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, equipped with
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"tFirst"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"tLast"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"tLength"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>
<span class="quoted"><span class="quoted">"tMap"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> functions.

Constructing these traces requires us to determine the agents' actions
at a given state. To do so we need to find an appropriate S$5_n$
structure for interpreting <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">jkbp</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

Given that we want the agents to make optimal use of the information
they have access to, we allow these structures to depend on the entire
history of the system, suitably conditioned by what the agents can
observe. We capture this notion of observation with a \emph{view}
\citep{Ron:1996}, which is an arbitrary function of a trace:

›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'tview</span><span class="main">)</span> View <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> Trace <span class="main">⇒</span> <span class="tfree">'tview</span>"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'tview</span><span class="main">)</span> JointView <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> Trace <span class="main">⇒</span> <span class="tfree">'tview</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

\label{sec:kbps-synchrony}

We require views to be \emph{synchronous}, i.e. that agents be able to
tell the time using their view by distinguishing two traces of
different lengths. As we will see in the next section, this guarantees
that the JKBP has an essentially unique implementation.

We extend the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"PreEnvironment"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> locale with a view:

›</span></span>

<span class="keyword1"><span class="command">locale</span></span> PreEnvironmentJView <span class="main">=</span>
  PreEnvironment <span class="quoted"><span class="free">jkbp</span></span> <span class="quoted"><span class="free">envInit</span></span> <span class="quoted"><span class="free">envAction</span></span> <span class="quoted"><span class="free">envTrans</span></span> <span class="quoted"><span class="free">envVal</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">jkbp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'aAct</span><span class="main">)</span> JKBP"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">envInit</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> list"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">envAction</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'eAct</span> list"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">envTrans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'eAct</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'aAct</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">envVal</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> bool"</span></span>
<span class="main">+</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">jview</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'tview</span><span class="main">)</span> JointView"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sync<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span> <span class="bound">t</span> <span class="bound">t'</span><span class="main">.</span> <span class="free">jview</span> <span class="bound">a</span> <span class="bound">t</span> <span class="main">=</span> <span class="free">jview</span> <span class="bound">a</span> <span class="bound">t'</span> <span class="main">⟶</span> tLength <span class="bound">t</span> <span class="main">=</span> tLength <span class="bound">t'</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The two principle synchronous views are the clock view and the
perfect-recall view which we discuss further in
\S\ref{sec:kbps-theory-views}. We will later derive an agent's
concrete view from an instantaneous observation of the global state in
\S\ref{sec:kbps-environments}.

We build a Kripke structure from a set of traces by relating traces
that yield the same view. To obtain an S$5_n$ structure we also need a
way to evaluate propositions: we apply <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">envVal</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to the final
state of a trace:

›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> PreEnvironmentJView<span class="main">)</span>
  <span class="entity">mkM</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> Trace set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'s</span> Trace<span class="main">)</span> KripkeStructure"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mkM</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">≡</span>
      <span class="main">⦇</span> worlds <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">,</span>
        relations <span class="main">=</span> <span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">{</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">t'</span><span class="main">)</span> <span class="main">.</span> <span class="main">{</span><span class="bound">t</span><span class="main">,</span> <span class="bound">t'</span><span class="main">}</span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">∧</span> <span class="free">jview</span> <span class="bound">a</span> <span class="bound">t</span> <span class="main">=</span> <span class="free">jview</span> <span class="bound">a</span> <span class="bound">t'</span> <span class="main">}</span><span class="main">,</span>
        valuation <span class="main">=</span> <span class="free">envVal</span> <span class="main">∘</span> tLast <span class="main">⦈</span>"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1"><span class="command">context</span></span> PreEnvironmentJView
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="KBPs-mkM_kripke"><span class="command">lemma</span></span> mkM_kripke<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"kripke <span class="main">(</span>mkM <span class="free">T</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mkM_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> kripkeI<span class="main">)</span> <span class="operator">fastforce</span>

<span class="keyword1" id="KBPs-mkM_S5n"><span class="command">lemma</span></span> mkM_S5n<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"S5n <span class="main">(</span>mkM <span class="free">T</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mkM_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> S5nI equivI<span class="main">)</span>
     <span class="main">(</span><span class="operator">bestsimp</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> equivI refl_onI symI transI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="KBPs-mkM_simps"><span class="command">lemma</span></span> mkM_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"worlds <span class="main">(</span>mkM <span class="free">T</span><span class="main">)</span> <span class="main">=</span> <span class="free">T</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free">t</span><span class="main">,</span> <span class="free">t'</span><span class="main">)</span> <span class="main">∈</span> relations <span class="main">(</span>mkM <span class="free">T</span><span class="main">)</span> <span class="free">a</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">jview</span> <span class="free">a</span> <span class="free">t</span> <span class="main">=</span> <span class="free">jview</span> <span class="free">a</span> <span class="free">t'</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free">t</span><span class="main">,</span> <span class="free">t'</span><span class="main">)</span> <span class="main">∈</span> relations <span class="main">(</span>mkM <span class="free">T</span><span class="main">)</span> <span class="free">a</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">∈</span> <span class="free">T</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free">t</span><span class="main">,</span> <span class="free">t'</span><span class="main">)</span> <span class="main">∈</span> relations <span class="main">(</span>mkM <span class="free">T</span><span class="main">)</span> <span class="free">a</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">t'</span> <span class="main">∈</span> <span class="free">T</span>"</span></span>
  <span class="quoted"><span class="quoted">"valuation <span class="main">(</span>mkM <span class="free">T</span><span class="main">)</span> <span class="main">=</span> <span class="free">envVal</span> <span class="main">∘</span> tLast"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mkM_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1" id="KBPs-mkM_rel_length"><span class="command">lemma</span></span> mkM_rel_length<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tt'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">t</span><span class="main">,</span> <span class="free">t'</span><span class="main">)</span> <span class="main">∈</span> relations <span class="main">(</span>mkM <span class="free">T</span><span class="main">)</span> <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"tLength <span class="free">t'</span> <span class="main">=</span> tLength <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> tt' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">jview</span> <span class="free">a</span> <span class="free">t</span> <span class="main">=</span> <span class="free">jview</span> <span class="free">a</span> <span class="free">t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">bestsimp</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> sync<span class="main"><span class="main">[</span></span><span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

This construction supplants the role of the \emph{local states} of
\citet{FHMV:1995}.

The following section shows how we can canonically interpret the JKBP
with respect to this structure.

›</span></span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Canonical Structures›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

\label{sec:kbps-canonical-kripke}

Our goal in this section is to find the canonical set of traces for a
given JKBP in a particular environment. As we will see, this always
exists with respect to synchronous views.

We inductively define an \emph{interpretation} of a JKBP with respect
to an arbitrary set of traces <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">T</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> by constructing a sequence
of sets of traces of increasing length:

›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">jkbpTn</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'s</span> Trace set <span class="main">⇒</span> <span class="tfree">'s</span> Trace set"</span></span><span class="comment1">(*&lt;*)</span><span class="main">(</span><span class="quoted">"<span class="keyword1">jkbpT⇘</span>_<span class="keyword1">⇙</span>"</span><span class="main">)</span><span class="comment1">(*&gt;*)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"jkbpT<span class="hidden">⇘</span><sub><span class="main">0</span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span>     <span class="main">=</span> <span class="main">{</span> tInit <span class="bound">s</span> <span class="main">|</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> set <span class="free">envInit</span> <span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"jkbpT<span class="hidden">⇘</span><sub>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">=</span> <span class="main">{</span> <span class="bound">t</span> <span class="main">↝</span> <span class="free">envTrans</span> <span class="bound">eact</span> <span class="bound">aact</span> <span class="main">(</span>tLast <span class="bound">t</span><span class="main">)</span> <span class="main">|</span><span class="bound">t</span> <span class="bound">eact</span> <span class="bound">aact</span><span class="main">.</span>
                             <span class="bound">t</span> <span class="main">∈</span> jkbpT<span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">n</span></span></span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">∧</span> <span class="bound">eact</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">envAction</span> <span class="main">(</span>tLast <span class="bound">t</span><span class="main">)</span><span class="main">)</span>
                          <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">aact</span> <span class="bound">a</span> <span class="main">∈</span> set <span class="main">(</span>jAction <span class="main">(</span>mkM <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="bound">t</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

This model reflects the failure of any agent to provide an action as
failure of the entire system. In general <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">envTrans</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> may
incorporate a scheduler and communication failure models.

The union of this sequence gives us a closure property:

›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">jkbpT</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> Trace set <span class="main">⇒</span> <span class="tfree">'s</span> Trace set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">jkbpT</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">≡</span> <span class="main">⋃</span><span class="bound">n</span><span class="main">.</span> jkbpT<span class="hidden">⇘</span><sub><span class="bound">n</span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span>"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1" id="KBPs-jkbpTn_length"><span class="command">lemma</span></span> jkbpTn_length<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> jkbpTn <span class="free">n</span> <span class="free">T</span> <span class="main">⟹</span> tLength <span class="free">t</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="KBPs-jkbpT_tLength_inv"><span class="command">lemma</span></span> jkbpT_tLength_inv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">t</span> <span class="main">∈</span> jkbpT <span class="free">T</span><span class="main">;</span> tLength <span class="free">t</span> <span class="main">=</span> <span class="free">n</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">∈</span> jkbpTn <span class="free">n</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> jkbpT_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> jkbpTn_length<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="KBPs-jkbpT_traces_of_length"><span class="command">lemma</span></span> jkbpT_traces_of_length<span class="main">:</span>
   <span class="quoted"><span class="quoted">"<span class="main">{</span> <span class="bound"><span class="bound">t</span></span> <span class="main">∈</span> jkbpT <span class="free">T</span> <span class="main">.</span> tLength <span class="bound">t</span> <span class="main">=</span> <span class="free">n</span> <span class="main">}</span> <span class="main">=</span> jkbpTn <span class="free">n</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> jkbpT_tLength_inv
  <span class="keyword1"><span class="command">unfolding</span></span> jkbpT_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">bestsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> jkbpTn_length<span class="main">)</span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

We say that a set of traces <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">T</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> \emph{represents} a JKBP if it
is closed under <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"jkbpT"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>:

›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">represents</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> Trace set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">represents</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">≡</span> jkbpT <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span>"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1" id="KBPs-representsI"><span class="command">lemma</span></span> representsI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"jkbpT <span class="free">T</span> <span class="main">=</span> <span class="free">T</span> <span class="main">⟹</span> represents <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> represents_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="KBPs-representsD"><span class="command">lemma</span></span> representsD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"represents <span class="free">T</span> <span class="main">⟹</span> jkbpT <span class="free">T</span> <span class="main">=</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> represents_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

This is the vicious cycle that we break using our assumption that the
view is synchronous. The key property of such views is that the
satisfaction of an epistemic formula is determined by the set of
traces in the model that have the same length. Lifted to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>
<span class="quoted"><span class="quoted">"jAction"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, we have:

›</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1" id="KBPs-sync_tLength_eq_trc"><span class="command">lemma</span></span> sync_tLength_eq_trc<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">t</span><span class="main">,</span> <span class="free">t'</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">a</span><span class="main">∈</span><span class="free">as</span><span class="main">.</span> relations <span class="main">(</span>mkM <span class="free">T</span><span class="main">)</span> <span class="bound">a</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"tLength <span class="free">t</span> <span class="main">=</span> tLength <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rtrancl_induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="KBPs-sync_gen_model_tLength"><span class="command">lemma</span></span> sync_gen_model_tLength<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> traces<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span> <span class="bound"><span class="bound">t</span></span> <span class="main">∈</span> <span class="free">T</span> <span class="main">.</span> tLength <span class="bound">t</span> <span class="main">=</span> <span class="free">n</span> <span class="main">}</span> <span class="main">=</span> <span class="main">{</span> <span class="bound"><span class="bound">t</span></span> <span class="main">∈</span> <span class="free">T'</span> <span class="main">.</span> tLength <span class="bound">t</span> <span class="main">=</span> <span class="free">n</span> <span class="main">}</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> tT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> <span class="main">{</span> <span class="bound"><span class="bound">t</span></span> <span class="main">∈</span> <span class="free">T</span> <span class="main">.</span> tLength <span class="bound">t</span> <span class="main">=</span> <span class="free">n</span> <span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"gen_model <span class="main">(</span>mkM <span class="free">T</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> gen_model <span class="main">(</span>mkM <span class="free">T'</span><span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> gen_model_subset<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> T<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">{</span></span> <span class="bound"><span class="bound"><span class="bound"><span class="bound">t</span></span></span></span> <span class="main"><span class="main">∈</span></span> <span class="free"><span class="free">T</span></span> <span class="main"><span class="main">.</span></span> tLength <span class="bound"><span class="bound">t</span></span> <span class="main"><span class="main">=</span></span> <span class="free"><span class="free">n</span></span> <span class="main"><span class="main">}</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>

  <span class="comment1">(* t ∈ T and t ∈ T' *)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 4
  <span class="keyword1"><span class="command">using</span></span> tT
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 4
  <span class="keyword1"><span class="command">using</span></span> tT traces
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> mkM_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command">using</span></span> tT traces
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>

  <span class="keyword1"><span class="command">using</span></span> tT
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> sync_tLength_eq_trc<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> as<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">UNIV</span><span class="main"><span class="main">]</span></span> kripke_rels_trc_worlds<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>

  <span class="keyword1"><span class="command">using</span></span> tT traces
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> sync_tLength_eq_trc<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> as<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">UNIV</span><span class="main"><span class="main">]</span></span> kripke_rels_trc_worlds<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1" id="KBPs-sync_jview_jAction_eq"><span class="command">lemma</span></span> sync_jview_jAction_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> traces<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span> <span class="bound"><span class="bound">t</span></span> <span class="main">∈</span> <span class="free">T</span> <span class="main">.</span> tLength <span class="bound">t</span> <span class="main">=</span> <span class="free">n</span> <span class="main">}</span> <span class="main">=</span> <span class="main">{</span> <span class="bound"><span class="bound">t</span></span> <span class="main">∈</span> <span class="free">T'</span> <span class="main">.</span> tLength <span class="bound">t</span> <span class="main">=</span> <span class="free">n</span> <span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> <span class="main">{</span> <span class="bound"><span class="bound">t</span></span> <span class="main">∈</span> <span class="free">T</span> <span class="main">.</span> tLength <span class="bound">t</span> <span class="main">=</span> <span class="free">n</span> <span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"jAction <span class="main">(</span>mkM <span class="free">T</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> jAction <span class="main">(</span>mkM <span class="free">T'</span><span class="main">)</span> <span class="free">t</span>"</span></span>
<span class="comment1">(*&lt;*)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> gen_model_jAction_eq<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> w<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">t</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sync_gen_model_tLength<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> gen_model_world_refl<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

This implies that for a synchronous view we can inductively define the
\emph{canonical traces} of a JKBP. These are the traces that a JKBP
generates when it is interpreted with respect to those very same
traces. We do this by constructing the sequence <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>jkbpC<span class="hidden">⇩</span><sub>n</sub>›</span></span></span></span> of
\emph{(canonical) temporal slices} similarly to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"jkbpT<span class="hidden">⇘</span><sub><span class="free"><span class="free">n</span></span></sub><span class="hidden">⇙</span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>:

›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">jkbpCn</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'s</span> Trace set"</span></span><span class="comment1">(*&lt;*)</span><span class="main">(</span><span class="quoted">"<span class="keyword1">jkbpC⇘</span>_<span class="keyword1">⇙</span>"</span><span class="main">)</span><span class="comment1">(*&gt;*)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"jkbpC<span class="hidden">⇘</span><sub><span class="main">0</span></sub><span class="hidden">⇙</span>      <span class="main">=</span> <span class="main">{</span> tInit <span class="bound">s</span> <span class="main">|</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> set <span class="free">envInit</span> <span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"jkbpC<span class="hidden">⇘</span><sub>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span></sub><span class="hidden">⇙</span> <span class="main">=</span> <span class="main">{</span> <span class="bound">t</span> <span class="main">↝</span> <span class="free">envTrans</span> <span class="bound">eact</span> <span class="bound">aact</span> <span class="main">(</span>tLast <span class="bound">t</span><span class="main">)</span> <span class="main">|</span><span class="bound">t</span> <span class="bound">eact</span> <span class="bound">aact</span><span class="main">.</span>
                             <span class="bound">t</span> <span class="main">∈</span> jkbpC<span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">n</span></span></span></sub><span class="hidden">⇙</span> <span class="main">∧</span> <span class="bound">eact</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">envAction</span> <span class="main">(</span>tLast <span class="bound">t</span><span class="main">)</span><span class="main">)</span>
                          <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">aact</span> <span class="bound">a</span> <span class="main">∈</span> set <span class="main">(</span>jAction <span class="main">(</span>mkM jkbpC<span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">n</span></span></span></sub><span class="hidden">⇙</span><span class="main">)</span> <span class="bound">t</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">MCn</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'s</span> Trace<span class="main">)</span> KripkeStructure"</span></span><span class="comment1">(*&lt;*)</span><span class="main">(</span><span class="quoted">"<span class="keyword1">MC⇘</span>_<span class="keyword1">⇙</span>"</span><span class="main">)</span><span class="comment1">(*&gt;*)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"MC<span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">n</span></span></span></sub><span class="hidden">⇙</span> <span class="main">≡</span> mkM jkbpC<span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">n</span></span></span></sub><span class="hidden">⇙</span>"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1" id="KBPs-jkbpCn_step_inv"><span class="command">lemma</span></span> jkbpCn_step_inv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">↝</span> <span class="free">s</span> <span class="main">∈</span> jkbpCn <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">∈</span> jkbpCn <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1" id="KBPs-jkbpCn_length"><span class="command">lemma</span></span> jkbpCn_length<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> jkbpCn <span class="free">n</span> <span class="main">⟹</span> tLength <span class="free">t</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1" id="KBPs-jkbpCn_init_inv"><span class="command">lemma</span></span> jkbpCn_init_inv<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"tInit <span class="free">s</span> <span class="main">∈</span> jkbpCn <span class="free">n</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">∈</span> set <span class="free">envInit</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">frule</span> jkbpCn_length<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="KBPs-jkbpCn_tFirst_init_inv"><span class="command">lemma</span></span> jkbpCn_tFirst_init_inv<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> jkbpCn <span class="free">n</span> <span class="main">⟹</span> tFirst <span class="free">t</span> <span class="main">∈</span> set <span class="free">envInit</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The canonical set of traces for a JKBP with respect to a joint view is
the set of canonical traces of all lengths.

›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">jkbpC</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> Trace set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">jkbpC</span> <span class="main">≡</span> <span class="main">⋃</span><span class="bound">n</span><span class="main">.</span> jkbpC<span class="hidden">⇘</span><sub><span class="bound">n</span></sub><span class="hidden">⇙</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">MC</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'s</span> Trace<span class="main">)</span> KripkeStructure"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">MC</span> <span class="main">≡</span> mkM jkbpC"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1" id="KBPs-jkbpCn_jkbpC_subset"><span class="command">lemma</span></span> jkbpCn_jkbpC_subset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"jkbpCn <span class="free">n</span> <span class="main">⊆</span> jkbpC"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> jkbpC_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="KBPs-jkbpCn_jkbpC_inc"><span class="command">lemma</span></span> jkbpCn_jkbpC_inc<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> jkbpCn <span class="free">n</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">∈</span> jkbpC"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> jkbpC_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">best</span>

<span class="keyword1" id="KBPs-jkbpC_tLength_inv"><span class="command">lemma</span></span> jkbpC_tLength_inv<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">t</span> <span class="main">∈</span> jkbpC<span class="main">;</span> tLength <span class="free">t</span> <span class="main">=</span> <span class="free">n</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">∈</span> jkbpCn <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> jkbpC_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1" id="KBPs-jkbpC_traces_of_length"><span class="command">lemma</span></span> jkbpC_traces_of_length<span class="main">:</span>
   <span class="quoted"><span class="quoted">"<span class="main">{</span> <span class="bound"><span class="bound">t</span></span> <span class="main">∈</span> jkbpC <span class="main">.</span> tLength <span class="bound">t</span> <span class="main">=</span> <span class="free">n</span> <span class="main">}</span> <span class="main">=</span> jkbpCn <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> jkbpC_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">bestsimp</span>

<span class="keyword1" id="KBPs-jkbpC_prefix_closed"><span class="command">lemma</span></span> jkbpC_prefix_closed<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">↝</span> <span class="free">s</span> <span class="main">∈</span> jkbpC <span class="main">⟹</span> <span class="free">t</span> <span class="main">∈</span> jkbpC"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> jkbpC_tLength_inv<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> Let_def jkbpC_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="KBPs-jkbpC_init"><span class="command">lemma</span></span> jkbpC_init<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"tInit <span class="free">s</span> <span class="main">∈</span> jkbpC <span class="main">⟷</span> <span class="free">s</span> <span class="main">∈</span> set <span class="free">envInit</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> jkbpC_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"tInit <span class="free">s</span> <span class="main">∈</span> jkbpCn <span class="main">0</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">0</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="KBPs-jkbpC_jkbpCn_rels"><span class="command">lemma</span></span> jkbpC_jkbpCn_rels<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">∈</span> relations MC <span class="free">a</span><span class="main">;</span> tLength <span class="free">u</span> <span class="main">=</span> <span class="free">n</span> <span class="main">⟧</span>
    <span class="main">⟹</span> <span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">∈</span> relations <span class="main">(</span>MC<span class="hidden">⇘</span><sub><span class="free">n</span></sub><span class="hidden">⇙</span><span class="main">)</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mkM_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> sync<span class="main"><span class="main">[</span></span><span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="KBPs-jkbpC_tFirst_init_inv"><span class="command">lemma</span></span> jkbpC_tFirst_init_inv<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> jkbpC <span class="main">⟹</span> tFirst <span class="free">t</span> <span class="main">∈</span> set <span class="free">envInit</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> jkbpC_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

We can show that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"jkbpC"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> represents the joint knowledge-based
program <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">jkbp</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> with respect to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">jview</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>:

›</span></span>

<span class="keyword1" id="KBPs-jkbpC_jkbpCn_jAction_eq"><span class="command">lemma</span></span> jkbpC_jkbpCn_jAction_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tCn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> jkbpC<span class="hidden">⇘</span><sub><span class="free">n</span></sub><span class="hidden">⇙</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"jAction MC <span class="free">t</span> <span class="main">=</span> jAction MC<span class="hidden">⇘</span><sub><span class="free">n</span></sub><span class="hidden">⇙</span> <span class="free">t</span>"</span></span>
<span class="comment1">(*&lt;*)</span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">rule</span> sync_jview_jAction_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> jkbpC_traces_of_length<span class="main">)</span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹›</span></span>

<span class="keyword1" id="KBPs-jkbpTn_jkbpCn_represents"><span class="command">lemma</span></span> jkbpTn_jkbpCn_represents<span class="main">:</span> <span class="quoted"><span class="quoted">"jkbpT<span class="hidden">⇘</span><sub><span class="free">n</span></sub><span class="hidden">⇙</span> jkbpC <span class="main">=</span> jkbpC<span class="hidden">⇘</span><sub><span class="free">n</span></sub><span class="hidden">⇙</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def jkbpC_jkbpCn_jAction_eq<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> jkbpC_represents<span class="main">:</span> <span class="quoted"><span class="quoted">"represents jkbpC"</span></span>
<span class="comment1">(*&lt;*)</span>
  <span class="keyword1"><span class="command">using</span></span> jkbpTn_jkbpCn_represents
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> representsI jkbpC_def jkbpT_def<span class="main">)</span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

We can show uniqueness too, by a similar argument:

›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> jkbpC_represents_uniquely<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> repT<span class="main">:</span> <span class="quoted"><span class="quoted">"represents <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">=</span> jkbpC"</span></span>
<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span> <span class="bound"><span class="bound">t</span></span> <span class="main">∈</span> <span class="free">T</span> <span class="main">.</span> tLength <span class="bound">t</span> <span class="main">=</span> <span class="skolem">n</span> <span class="main">}</span> <span class="main">=</span> <span class="main">{</span> <span class="bound"><span class="bound">t</span></span> <span class="main">∈</span> jkbpC <span class="main">.</span> tLength <span class="bound">t</span> <span class="main">=</span> <span class="skolem">n</span> <span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 0
      <span class="keyword1"><span class="command">from</span></span> repT <span class="keyword1"><span class="command">have</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">t</span></span> <span class="main">∈</span> <span class="free">T</span><span class="main">.</span> tLength <span class="bound">t</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">=</span> jkbpTn <span class="main">0</span> <span class="free">T</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">subst</span> jkbpT_traces_of_length<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> representsD<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> jkbpC_traces_of_length<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> indhyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">t</span></span> <span class="main">∈</span> <span class="free">T</span><span class="main">.</span> tLength <span class="bound">t</span> <span class="main">=</span> <span class="skolem">n</span><span class="main">}</span> <span class="main">=</span> jkbpCn <span class="skolem">n</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> jkbpC_traces_of_length<span class="main">)</span>

        <span class="comment1">(* F and H are very similar. *)</span>
      <span class="keyword1"><span class="command">from</span></span> repT <span class="keyword1"><span class="command">have</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> jkbpTn <span class="bound">n</span> <span class="free">T</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">t</span></span> <span class="main">∈</span> <span class="free">T</span><span class="main">.</span> tLength <span class="bound">t</span> <span class="main">=</span> <span class="bound">n</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">subst</span> jkbpT_traces_of_length<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> representsD<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> indhyp F <span class="keyword1"><span class="command">have</span></span> G<span class="main">:</span> <span class="quoted"><span class="quoted">"jkbpTn <span class="skolem">n</span> <span class="free">T</span> <span class="main">=</span> jkbpCn <span class="skolem">n</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> repT <span class="keyword1"><span class="command">have</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="main">{</span><span class="bound"><span class="bound">t</span></span> <span class="main">∈</span> <span class="free">T</span><span class="main">.</span> tLength <span class="bound">t</span> <span class="main">=</span> <span class="bound">n</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">t</span></span> <span class="main">∈</span> jkbpTn <span class="bound">n</span> <span class="free">T</span><span class="main">.</span> tLength <span class="bound">t</span> <span class="main">=</span> <span class="bound">n</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> representsD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> repT<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> jkbpT_traces_of_length jkbpTn_length<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> F indhyp <span class="keyword1"><span class="command">have</span></span> ACTS<span class="main">:</span>
        <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> jkbpTn <span class="skolem">n</span> <span class="free">T</span>
          <span class="main">⟹</span> jAction <span class="main">(</span>mkM <span class="free">T</span><span class="main">)</span> <span class="bound">t</span> <span class="main">=</span> jAction <span class="main">(</span>MCn <span class="skolem">n</span><span class="main">)</span> <span class="bound">t</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">rule</span> sync_jview_jAction_eq<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> n<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem"><span class="skolem">n</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> Let_def ACTS G H jkbpC_traces_of_length<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context PreEnvironmentJView *)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

Thus, at least with synchronous views, we are justified in talking
about \emph{the} representation of a JKBP in a given environment. More
generally these results are also valid for the more general notion of
\emph{provides witnesses} as shown by \citet[Lemma 7.2.4]{FHMV:1995}
and \citet{DBLP:journals/dc/FaginHMV97}: it requires only that if a
subjective knowledge formula is false on a trace then there is a trace
of the same length or less that bears witness to that effect. This is
a useful generalisation in asynchronous settings.

The next section shows how we can construct canonical representations
of JKBPs using automata.

›</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="KBPsAuto">
<div class="head">
<h1>Theory KBPsAuto</h1>
</div>
<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="comment1">(*
 * Knowledge-based programs.
 * (C)opyright 2011, Peter Gammie, peteg42 at gmail.com.
 * License: BSD
 *)</span>

<span class="keyword1"><span class="command">theory</span></span> KBPsAuto
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="#Extra">Extra</a>
  <a href="#KBPs">KBPs</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Automata Synthesis›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

\label{sec:kbps-automata-synthesis}

Our attention now shifts to showing how we can synthesise standard
automata that \emph{implement} a JKBP under certain conditions. We
proceed by defining \emph{incremental views} following
\cite{Ron:1996}, which provide the interface between the system and
these automata. The algorithm itself is presented in
\S\ref{sec:kbps-alg}.

›</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Incremental views›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

\label{sec:kbps-environments}

Intuitively an agent instantaneously observes the system state, and so
must maintain her view of the system \emph{incrementally}: her new
view must be a function of her current view and some new
observation. We allow this observation to be an arbitrary projection
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">envObs</span></span> <span class="free"><span class="free">a</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> of the system state for each agent <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">a</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>:

›</span></span>

<span class="keyword1"><span class="command">locale</span></span> Environment <span class="main">=</span>
  PreEnvironment <span class="quoted"><span class="free">jkbp</span></span> <span class="quoted"><span class="free">envInit</span></span> <span class="quoted"><span class="free">envAction</span></span> <span class="quoted"><span class="free">envTrans</span></span> <span class="quoted"><span class="free">envVal</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">jkbp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'aAct</span><span class="main">)</span> JKBP"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">envInit</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> list"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">envAction</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'eAct</span> list"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">envTrans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'eAct</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'aAct</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">envVal</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> bool"</span></span>
<span class="main">+</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">envObs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'obs</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

An incremental view therefore consists of two functions with these
types:

›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'obs</span><span class="main">,</span> <span class="tfree">'tv</span><span class="main">)</span> InitialIncrJointView <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'obs</span> <span class="main">⇒</span> <span class="tfree">'tv</span>"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'obs</span><span class="main">,</span>  <span class="tfree">'tv</span><span class="main">)</span> IncrJointView <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'obs</span> <span class="main">⇒</span> <span class="tfree">'tv</span> <span class="main">⇒</span> <span class="tfree">'tv</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

These functions are required to commute with their corresponding
trace-based joint view in the obvious way:

›</span></span>

<span class="keyword1"><span class="command">locale</span></span> IncrEnvironment <span class="main">=</span>
  Environment <span class="quoted"><span class="free">jkbp</span></span> <span class="quoted"><span class="free">envInit</span></span> <span class="quoted"><span class="free">envAction</span></span> <span class="quoted"><span class="free">envTrans</span></span> <span class="quoted"><span class="free">envVal</span></span> <span class="quoted"><span class="free">envObs</span></span>
<span class="main">+</span> PreEnvironmentJView <span class="quoted"><span class="free">jkbp</span></span> <span class="quoted"><span class="free">envInit</span></span> <span class="quoted"><span class="free">envAction</span></span> <span class="quoted"><span class="free">envTrans</span></span> <span class="quoted"><span class="free">envVal</span></span> <span class="quoted"><span class="free">jview</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">jkbp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'aAct</span><span class="main">)</span> JKBP"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">envInit</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> list"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">envAction</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'eAct</span> list"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">envTrans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'eAct</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'aAct</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">envVal</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">jview</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'tv</span><span class="main">)</span> JointView"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">envObs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'obs</span>"</span></span>
<span class="main">+</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">jviewInit</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'obs</span><span class="main">,</span> <span class="tfree">'tv</span><span class="main">)</span> InitialIncrJointView"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">jviewIncr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'obs</span><span class="main">,</span> <span class="tfree">'tv</span><span class="main">)</span> IncrJointView"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> jviewInit<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span> <span class="bound">s</span><span class="main">.</span> <span class="free">jviewInit</span> <span class="bound">a</span> <span class="main">(</span><span class="free">envObs</span> <span class="bound">a</span> <span class="bound">s</span><span class="main">)</span> <span class="main">=</span> <span class="free">jview</span> <span class="bound">a</span> <span class="main">(</span>tInit <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> jviewIncr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">.</span> <span class="free">jview</span> <span class="bound">a</span> <span class="main">(</span><span class="bound">t</span> <span class="main">↝</span> <span class="bound">s</span><span class="main">)</span>
                             <span class="main">=</span> <span class="free">jviewIncr</span> <span class="bound">a</span> <span class="main">(</span><span class="free">envObs</span> <span class="bound">a</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span><span class="free">jview</span> <span class="bound">a</span> <span class="bound">t</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

Armed with these definitions, the following sections show that there
are automata that implement a JKBP in a given environment.

›</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Automata›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

Our implementations of JKBPs take the form of deterministic Moore
automata, where transitions are labelled by observation and states
with the action to be performed. We will use the term \emph{protocols}
interchangeably with automata, following the KBP literature, and adopt
\emph{joint protocols} for the assignment of one such to each agent:

›</span></span>

<span class="keyword1"><span class="command">record</span></span> <span class="main">(</span><span class="tfree">'obs</span><span class="main">,</span> <span class="tfree">'aAct</span><span class="main">,</span> <span class="tfree">'ps</span><span class="main">)</span> Protocol <span class="main">=</span>
  pInit <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'obs</span> <span class="main">⇒</span> <span class="tfree">'ps</span>"</span></span>
  pTrans <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'obs</span> <span class="main">⇒</span> <span class="tfree">'ps</span> <span class="main">⇒</span> <span class="tfree">'ps</span>"</span></span>
  pAct <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'ps</span> <span class="main">⇒</span> <span class="tfree">'aAct</span> list"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'obs</span><span class="main">,</span> <span class="tfree">'aAct</span><span class="main">,</span> <span class="tfree">'ps</span><span class="main">)</span> JointProtocol
    <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'obs</span><span class="main">,</span> <span class="tfree">'aAct</span><span class="main">,</span> <span class="tfree">'ps</span><span class="main">)</span> Protocol"</span></span>

<span class="keyword1"><span class="command">context</span></span> IncrEnvironment
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

To ease composition with the system we adopt the function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>
<span class="quoted"><span class="quoted">"pInit"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> which maps the initial observation to an initial automaton
state.

\citet{Ron:1996} shows that even non-deterministic JKBPs can be
implemented with deterministic transition functions; intuitively all
relevant uncertainty the agent has about the system must be encoded
into each automaton state, so there is no benefit to doing this
non-deterministically. In contrast we model the non-deterministic
choice of action by making <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"pAct"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> a relation.

Running a protocol on a trace is entirely standard, as is running a
joint protocol, and determining their actions:

›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">runJP</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'obs</span><span class="main">,</span> <span class="tfree">'aAct</span><span class="main">,</span> <span class="tfree">'ps</span><span class="main">)</span> JointProtocol
           <span class="main">⇒</span> <span class="tfree">'s</span> Trace <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'ps</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">runJP</span> <span class="free"><span class="bound"><span class="entity">jp</span></span></span> <span class="main">(</span>tInit <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> pInit <span class="main">(</span><span class="free"><span class="bound"><span class="entity">jp</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">envObs</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">runJP</span> <span class="free"><span class="bound"><span class="entity">jp</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">↝</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> pTrans <span class="main">(</span><span class="free"><span class="bound"><span class="entity">jp</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">envObs</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">runJP</span> <span class="free"><span class="bound"><span class="entity">jp</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">actJP</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'obs</span><span class="main">,</span> <span class="tfree">'aAct</span><span class="main">,</span> <span class="tfree">'ps</span><span class="main">)</span> JointProtocol
                    <span class="main">⇒</span> <span class="tfree">'s</span> Trace <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'aAct</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">actJP</span> <span class="free"><span class="bound"><span class="entity">jp</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">t</span> <span class="bound">a</span><span class="main">.</span> pAct <span class="main">(</span><span class="free"><span class="bound"><span class="entity">jp</span></span></span> <span class="bound">a</span><span class="main">)</span> <span class="main">(</span>runJP <span class="free"><span class="bound"><span class="entity">jp</span></span></span> <span class="bound">t</span> <span class="bound">a</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹

Similarly to \S\ref{sec:kbps-canonical-kripke} we will reason about
the set of traces generated by a joint protocol in a fixed
environment:

›</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span>
  <span class="entity">jpTraces</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'obs</span><span class="main">,</span> <span class="tfree">'aAct</span><span class="main">,</span> <span class="tfree">'ps</span><span class="main">)</span> JointProtocol <span class="main">⇒</span> <span class="tfree">'s</span> Trace set"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">jp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'obs</span><span class="main">,</span> <span class="tfree">'aAct</span><span class="main">,</span> <span class="tfree">'ps</span><span class="main">)</span> JointProtocol"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∈</span> set <span class="free">envInit</span> <span class="main">⟹</span> tInit <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∈</span> <span class="free">jpTraces</span> <span class="free">jp</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∈</span> <span class="free">jpTraces</span> <span class="free">jp</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">eact</span></span></span> <span class="main">∈</span> set <span class="main">(</span><span class="free">envAction</span> <span class="main">(</span>tLast <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
     <span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">aact</span></span></span> <span class="bound">a</span> <span class="main">∈</span> set <span class="main">(</span>actJP <span class="free">jp</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">a</span><span class="main">)</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="free">envTrans</span> <span class="free"><span class="bound"><span class="entity">eact</span></span></span> <span class="free"><span class="bound"><span class="entity">aact</span></span></span> <span class="main">(</span>tLast <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">⟧</span>
     <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">↝</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∈</span> <span class="free">jpTraces</span> <span class="free">jp</span>"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1"><span class="command">declare</span></span> jpTraces.intros<span class="main">[</span><span class="operator">intro</span><span class="main">]</span>

<span class="keyword1" id="KBPsAuto-jpTraces_init_inv"><span class="command">lemma</span></span> jpTraces_init_inv<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"tInit <span class="free">s</span> <span class="main">∈</span> jpTraces <span class="free">jp</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">∈</span> set <span class="free">envInit</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> jpTraces.cases<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="KBPsAuto-jpTraces_step_inv"><span class="command">lemma</span></span> jpTraces_step_inv<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">↝</span> <span class="free">s</span> <span class="main">∈</span> jpTraces <span class="free">jp</span>
    <span class="main">⟹</span> <span class="free">t</span> <span class="main">∈</span> jpTraces <span class="free">jp</span>
     <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">eact</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">envAction</span> <span class="main">(</span>tLast <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
        <span class="main">(</span><span class="main">∃</span><span class="bound">aact</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">aact</span> <span class="bound">a</span> <span class="main">∈</span> set <span class="main">(</span>actJP <span class="free">jp</span> <span class="free">t</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span>
          <span class="main">∧</span> <span class="free">s</span> <span class="main">=</span> <span class="free">envTrans</span> <span class="bound">eact</span> <span class="bound">aact</span> <span class="main">(</span>tLast <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> jpTraces.cases<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="KBPsAuto-jpTraces_init_length_inv"><span class="command">lemma</span></span> jpTraces_init_length_inv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> jpTraces <span class="free">jp</span> <span class="main">⟹</span> <span class="main">(</span>tLength <span class="free">t</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> set <span class="free">envInit</span> <span class="main">∧</span> <span class="free">t</span> <span class="main">=</span> tInit <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> jpTraces.cases<span class="main">)</span>

<span class="keyword1" id="KBPsAuto-jpTraces_step_length_inv_aux"><span class="command">lemma</span></span> jpTraces_step_length_inv_aux<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> <span class="main">{</span> <span class="bound"><span class="bound">t</span></span> <span class="main">∈</span> jpTraces <span class="free">jp</span> <span class="main">.</span> tLength <span class="bound">t</span> <span class="main">=</span> Suc <span class="free">n</span> <span class="main">}</span>
    <span class="main">⟹</span> <span class="main">∃</span><span class="bound">t'</span> <span class="bound">s</span><span class="main">.</span> <span class="free">t</span> <span class="main">=</span> <span class="bound">t'</span> <span class="main">↝</span> <span class="bound">s</span>
            <span class="main">∧</span> <span class="bound">t'</span> <span class="main">∈</span> jpTraces <span class="free">jp</span>
            <span class="main">∧</span> tLength <span class="bound">t'</span> <span class="main">=</span> <span class="free">n</span>
            <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">eact</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">envAction</span> <span class="main">(</span>tLast <span class="bound">t'</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
               <span class="main">(</span><span class="main">∃</span><span class="bound">aact</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">aact</span> <span class="bound">a</span> <span class="main">∈</span> set <span class="main">(</span>actJP <span class="free">jp</span> <span class="bound">t'</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span>
                 <span class="main">∧</span> <span class="bound">s</span> <span class="main">=</span> <span class="free">envTrans</span> <span class="bound">eact</span> <span class="bound">aact</span> <span class="main">(</span>tLast <span class="bound">t'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="KBPsAuto-jpTraces_step_length_inv"><span class="command">lemma</span></span> jpTraces_step_length_inv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span> <span class="bound"><span class="bound">t</span></span> <span class="main">∈</span> jpTraces <span class="free">jp</span> <span class="main">.</span> tLength <span class="bound">t</span> <span class="main">=</span> Suc <span class="free">n</span> <span class="main">}</span>
 <span class="main">=</span> <span class="main">{</span> <span class="bound">t</span> <span class="main">↝</span> <span class="bound">s</span> <span class="main">|</span><span class="bound">eact</span> <span class="bound">aact</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="main">{</span> <span class="bound"><span class="bound">t</span></span> <span class="main">∈</span> jpTraces <span class="free">jp</span> <span class="main">.</span> tLength <span class="bound">t</span> <span class="main">=</span> <span class="free">n</span> <span class="main">}</span>
              <span class="main">∧</span> <span class="bound">eact</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">envAction</span> <span class="main">(</span>tLast <span class="bound">t</span><span class="main">)</span><span class="main">)</span>
              <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">aact</span> <span class="bound">a</span> <span class="main">∈</span> set <span class="main">(</span>actJP <span class="free">jp</span> <span class="bound">t</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span>
              <span class="main">∧</span> <span class="bound">s</span> <span class="main">=</span> <span class="free">envTrans</span> <span class="bound">eact</span> <span class="bound">aact</span> <span class="main">(</span>tLast <span class="bound">t</span><span class="main">)</span> <span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> set_eqI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> jpTraces_step_length_inv_aux<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context IncrEnvironment *)</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹The Implementation Relation›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

\label{sec:kbps-implementation}

With this machinery in hand, we now relate automata with JKBPs. We say
a joint protocol <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">jp</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> \emph{implements} a JKBP when they
perform the same actions on the canonical of traces. Note that the
behaviour of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">jp</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> on other traces is arbitrary.

›</span></span>

<span class="keyword1"><span class="command">context</span></span> IncrEnvironment
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">implements</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'obs</span><span class="main">,</span> <span class="tfree">'aAct</span><span class="main">,</span> <span class="tfree">'ps</span><span class="main">)</span> JointProtocol <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">implements</span> <span class="free"><span class="bound"><span class="entity">jp</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span> <span class="main">∈</span> jkbpC<span class="main">.</span> set <span class="main">∘</span> actJP <span class="free"><span class="bound"><span class="entity">jp</span></span></span> <span class="bound">t</span> <span class="main">=</span> set <span class="main">∘</span> jAction MC <span class="bound">t</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

Clearly there are environments where the canonical trace set <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>
<span class="quoted"><span class="quoted">"jkbpC"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> can be generated by actions that differ from those prescribed
by the JKBP. We can show that the \emph{implements} relation is a
stronger requirement than the mere trace-inclusion required by the
\emph{represents} relation of \S\ref{sec:kbps-canonical-kripke}.

›</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1" id="KBPsAuto-implementsI"><span class="command">lemma</span></span> implementsI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> jkbpC <span class="main">⟹</span> set <span class="main">∘</span> actJP <span class="free">jp</span> <span class="bound">t</span> <span class="main">=</span> set <span class="main">∘</span> jAction MC <span class="bound">t</span><span class="main">)</span>
  <span class="main">⟹</span> implements <span class="free">jp</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> implements_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="KBPsAuto-implementsE"><span class="command">lemma</span></span> implementsE<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> impl<span class="main">:</span> <span class="quoted"><span class="quoted">"implements <span class="free">jp</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> tC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> jkbpC"</span></span>
     <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">∘</span> actJP <span class="free">jp</span> <span class="free">t</span> <span class="main">=</span> set <span class="main">∘</span> jAction MC <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> implements_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="KBPsAuto-implements_actJP_jAction"><span class="command">lemma</span></span> implements_actJP_jAction<span class="main">:</span>
   <span class="keyword2"><span class="keyword">assumes</span></span> impl<span class="main">:</span> <span class="quoted"><span class="quoted">"implements <span class="free">jp</span>"</span></span>
       <span class="keyword2"><span class="keyword">and</span></span> tCn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> jkbpCn <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>actJP <span class="free">jp</span> <span class="free">t</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>jAction <span class="main">(</span>MCn <span class="free">n</span><span class="main">)</span> <span class="free">t</span> <span class="free">a</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> tCn <span class="keyword1"><span class="command">have</span></span> tC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> jkbpC"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="main">(</span>set <span class="main">∘</span> jAction MC <span class="free">t</span><span class="main">)</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> implementsE<span class="main">[</span><span class="operator">OF</span> impl<span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> set <span class="main">(</span>jAction <span class="main">(</span>MCn <span class="free">n</span><span class="main">)</span> <span class="free">t</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> jkbpC_jkbpCn_jAction_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> tCn<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1" id="KBPsAuto-implements_represents"><span class="command">lemma</span></span> implements_represents<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> impl<span class="main">:</span> <span class="quoted"><span class="quoted">"implements <span class="free">jp</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"represents <span class="main">(</span>jpTraces <span class="free">jp</span><span class="main">)</span>"</span></span>
<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span> <span class="bound"><span class="bound">t</span></span> <span class="main">∈</span> jpTraces <span class="free">jp</span> <span class="main">.</span> tLength <span class="bound">t</span> <span class="main">=</span> <span class="skolem">n</span> <span class="main">}</span>
        <span class="main">=</span> <span class="main">{</span> <span class="bound"><span class="bound">t</span></span> <span class="main">∈</span> jkbpC <span class="main">.</span> tLength <span class="bound">t</span> <span class="main">=</span> <span class="skolem">n</span> <span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> jpTraces_init_length_inv <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> jkbpC_traces_of_length<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> indhyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">t</span></span> <span class="main">∈</span> jpTraces <span class="free">jp</span> <span class="main">.</span> tLength <span class="bound">t</span> <span class="main">=</span> <span class="skolem">n</span><span class="main">}</span> <span class="main">=</span> jkbpCn <span class="skolem">n</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> jkbpC_traces_of_length<span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">t</span></span> <span class="main">∈</span> jpTraces <span class="free">jp</span><span class="main">.</span> tLength <span class="bound">t</span> <span class="main">=</span> Suc <span class="skolem">n</span><span class="main">}</span>
          <span class="main">=</span> <span class="main">{</span><span class="bound">t</span> <span class="main">↝</span> <span class="bound">s</span> <span class="main">|</span><span class="bound">eact</span> <span class="bound">aact</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> jkbpCn <span class="skolem">n</span>
                      <span class="main">∧</span> <span class="bound">eact</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">envAction</span> <span class="main">(</span>tLast <span class="bound">t</span><span class="main">)</span><span class="main">)</span>
                      <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">aact</span> <span class="bound">a</span> <span class="main">∈</span> set <span class="main">(</span>actJP <span class="free">jp</span> <span class="bound">t</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span>
                      <span class="main">∧</span> <span class="bound">s</span> <span class="main">=</span> <span class="free">envTrans</span> <span class="bound">eact</span> <span class="bound">aact</span> <span class="main">(</span>tLast <span class="bound">t</span><span class="main">)</span> <span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> indhyp <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> jpTraces_step_length_inv<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> jkbpCn <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> implements_actJP_jAction<span class="main"><span class="main">[</span></span><span class="operator">OF</span> impl<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> jkbpC_traces_of_length<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"jpTraces <span class="free">jp</span> <span class="main">=</span> jkbpC"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> R jkbpC_represents
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"represents <span class="main">(</span>jpTraces <span class="free">jp</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="KBPsAuto-implements_ind_jkbpC"><span class="command">lemma</span></span> implements_ind_jkbpC<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> acts<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">n</span> <span class="bound">t</span><span class="main">.</span>
                  <span class="main">⟦</span> <span class="main">{</span><span class="bound"><span class="bound">t</span></span> <span class="main">∈</span> jpTraces <span class="free">jp</span><span class="main">.</span> tLength <span class="bound">t</span> <span class="main">=</span> <span class="bound">n</span><span class="main">}</span> <span class="main">=</span> jkbpCn <span class="bound">n</span><span class="main">;</span> <span class="bound">t</span> <span class="main">∈</span> jkbpCn <span class="bound">n</span> <span class="main">⟧</span>
                  <span class="main">⟹</span> actJP <span class="free">jp</span> <span class="bound">t</span> <span class="bound">a</span> <span class="main">=</span> jAction MC <span class="bound">t</span> <span class="bound">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"implements <span class="free">jp</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?T</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"jpTraces <span class="free">jp</span>"</span></span>

  <span class="keyword1"><span class="command">from</span></span> acts <span class="keyword1"><span class="command">have</span></span> acts'<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span> <span class="bound">t</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">{</span><span class="bound"><span class="bound">t</span></span> <span class="main">∈</span> jpTraces <span class="free">jp</span><span class="main">.</span> tLength <span class="bound">t</span> <span class="main">=</span> <span class="bound">n</span><span class="main">}</span> <span class="main">=</span> jkbpCn <span class="bound">n</span><span class="main">;</span> <span class="bound">t</span> <span class="main">∈</span> jkbpCn <span class="bound">n</span> <span class="main">⟧</span>
          <span class="main">⟹</span> actJP <span class="free">jp</span> <span class="bound">t</span> <span class="main">=</span> jAction <span class="main">(</span>MCn <span class="bound">n</span><span class="main">)</span> <span class="bound">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> jkbpC_jkbpCn_jAction_eq<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> acts <span class="keyword1"><span class="command">have</span></span> acts'<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span> <span class="bound">t</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">{</span><span class="bound"><span class="bound">t</span></span> <span class="main">∈</span> jpTraces <span class="free">jp</span><span class="main">.</span> tLength <span class="bound">t</span> <span class="main">=</span> <span class="bound">n</span><span class="main">}</span> <span class="main">=</span> jkbpCn <span class="bound">n</span><span class="main">;</span> <span class="bound">t</span> <span class="main">∈</span> jkbpCn <span class="bound">n</span> <span class="main">⟧</span>
          <span class="main">⟹</span> actJP <span class="free">jp</span> <span class="bound">t</span> <span class="main">=</span> jAction <span class="main">(</span>MCn <span class="bound">n</span><span class="main">)</span> <span class="bound">t</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">using</span></span> jkbpC_jkbpCn_jAction_eq
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span> <span class="bound"><span class="bound">t</span></span> <span class="main">∈</span> <span class="var">?T</span> <span class="main">.</span> tLength <span class="bound">t</span> <span class="main">=</span> <span class="skolem">n</span> <span class="main">}</span> <span class="main">=</span> <span class="main">{</span> <span class="bound"><span class="bound">t</span></span> <span class="main">∈</span> jkbpC <span class="main">.</span> tLength <span class="bound">t</span> <span class="main">=</span> <span class="skolem">n</span> <span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> jpTraces_init_length_inv <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> jkbpC_traces_of_length<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> indhyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">t</span></span> <span class="main">∈</span> <span class="var">?T</span><span class="main">.</span> tLength <span class="bound">t</span> <span class="main">=</span> <span class="skolem">n</span><span class="main">}</span> <span class="main">=</span> jkbpCn <span class="skolem">n</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> jkbpC_traces_of_length<span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">t</span></span> <span class="main">∈</span> jpTraces <span class="free">jp</span><span class="main">.</span> tLength <span class="bound">t</span> <span class="main">=</span> Suc <span class="skolem">n</span><span class="main">}</span>
          <span class="main">=</span> <span class="main">{</span><span class="bound">t</span> <span class="main">↝</span> <span class="bound">s</span> <span class="main">|</span><span class="bound">eact</span> <span class="bound">aact</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> jkbpCn <span class="skolem">n</span>
                      <span class="main">∧</span> <span class="bound">eact</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">envAction</span> <span class="main">(</span>tLast <span class="bound">t</span><span class="main">)</span><span class="main">)</span>
                      <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">aact</span> <span class="bound">a</span> <span class="main">∈</span> set <span class="main">(</span>actJP <span class="free">jp</span> <span class="bound">t</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span>
                      <span class="main">∧</span> <span class="bound">s</span> <span class="main">=</span> <span class="free">envTrans</span> <span class="bound">eact</span> <span class="bound">aact</span> <span class="main">(</span>tLast <span class="bound">t</span><span class="main">)</span> <span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> indhyp <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> jpTraces_step_length_inv<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> jkbpCn <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> acts'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> indhyp<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> acts'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> indhyp<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> jkbpC_traces_of_length<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">∈</span>jkbpCn <span class="skolem">n</span><span class="main">.</span> actJP <span class="free">jp</span> <span class="bound">t</span> <span class="main">=</span> jAction <span class="main">(</span>MCn <span class="skolem">n</span><span class="main">)</span> <span class="bound">t</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> acts'<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> jkbpC_traces_of_length<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">∈</span>jkbpCn <span class="skolem">n</span><span class="main">.</span> actJP <span class="free">jp</span> <span class="bound">t</span> <span class="main">=</span> jAction MC <span class="bound">t</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span> <span class="operator">rule</span> sync_jview_jAction_eq<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> n<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem"><span class="skolem">n</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span>
         <span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> jkbpC_traces_of_length<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> implements_def jkbpC_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The proof is by a straightfoward induction over the lengths of traces
generated by the joint protocol.

Our final piece of technical machinery allows us to refine automata
definitions: we say that two joint protocols are \emph{behaviourally
equivalent} if the actions they propose coincide for each canonical
trace. The implementation relation is preserved by this relation.

›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">behaviourally_equiv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'obs</span><span class="main">,</span> <span class="tfree">'aAct</span><span class="main">,</span> <span class="tfree">'ps</span><span class="main">)</span> JointProtocol
                        <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'obs</span><span class="main">,</span> <span class="tfree">'aAct</span><span class="main">,</span> <span class="tfree">'ps'</span><span class="main">)</span> JointProtocol
                        <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">behaviourally_equiv</span> <span class="free"><span class="bound"><span class="entity">jp</span></span></span> <span class="free"><span class="bound"><span class="entity">jp'</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">t</span> <span class="main">∈</span> jkbpC<span class="main">.</span> set <span class="main">∘</span> actJP <span class="free"><span class="bound"><span class="entity">jp</span></span></span> <span class="bound">t</span> <span class="main">=</span> set <span class="main">∘</span> actJP <span class="free"><span class="bound"><span class="entity">jp'</span></span></span> <span class="bound">t</span>"</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1" id="KBPsAuto-behaviourally_equivI"><span class="command">lemma</span></span> behaviourally_equivI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> jkbpC <span class="main">⟹</span> set <span class="main">∘</span> actJP <span class="free">jp</span> <span class="bound">t</span> <span class="main">=</span> set <span class="main">∘</span> actJP <span class="free">jp'</span> <span class="bound">t</span><span class="main">)</span>
    <span class="main">⟹</span> behaviourally_equiv <span class="free">jp</span> <span class="free">jp'</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> behaviourally_equiv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1" id="KBPsAuto-behaviourally_equiv_implements"><span class="command">lemma</span></span> behaviourally_equiv_implements<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"behaviourally_equiv <span class="free">jp</span> <span class="free">jp'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"implements <span class="free">jp</span> <span class="main">⟷</span> implements <span class="free">jp'</span>"</span></span>
<span class="comment1">(*&lt;*)</span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> behaviourally_equiv_def implements_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹›</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context IncrEnvironment *)</span>

<span class="comment1">(* **************************************** *)</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Automata using Equivalence Classes›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

We now show that there is an implementation of every JKBP with respect
to every incremental synchronous view. Intuitively the states of the
automaton for agent <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">a</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> represent the equivalence classes of
traces that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">a</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> considers possible, and the transitions update
these sets according to her KBP.

›</span></span>

<span class="keyword1"><span class="command">context</span></span> IncrEnvironment
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">mkAutoEC</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'obs</span><span class="main">,</span> <span class="tfree">'aAct</span><span class="main">,</span> <span class="tfree">'s</span> Trace set<span class="main">)</span> JointProtocol"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mkAutoEC</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">a</span><span class="main">.</span>
     <span class="main">⦇</span> pInit <span class="main">=</span> <span class="main">λ</span><span class="bound">obs</span><span class="main">.</span> <span class="main">{</span> <span class="bound"><span class="bound">t</span></span> <span class="main">∈</span> jkbpC <span class="main">.</span> <span class="free">jviewInit</span> <span class="bound">a</span> <span class="bound">obs</span> <span class="main">=</span> <span class="free">jview</span> <span class="bound">a</span> <span class="bound">t</span> <span class="main">}</span><span class="main">,</span>
       pTrans <span class="main">=</span> <span class="main">λ</span><span class="bound">obs</span> <span class="bound">ps</span><span class="main">.</span> <span class="main">{</span> <span class="bound">t</span> <span class="main">|</span><span class="bound">t</span> <span class="bound">t'</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> jkbpC <span class="main">∧</span> <span class="bound">t'</span> <span class="main">∈</span> <span class="bound">ps</span>
                                 <span class="main">∧</span> <span class="free">jview</span> <span class="bound">a</span> <span class="bound">t</span> <span class="main">=</span> <span class="free">jviewIncr</span> <span class="bound">a</span> <span class="bound">obs</span> <span class="main">(</span><span class="free">jview</span> <span class="bound">a</span> <span class="bound">t'</span><span class="main">)</span> <span class="main">}</span><span class="main">,</span>
       pAct <span class="main">=</span> <span class="main">λ</span><span class="bound">ps</span><span class="main">.</span> jAction MC <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="bound">ps</span><span class="main">)</span> <span class="bound">a</span> <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The function <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>SOME›</span></span></span></span> is Hilbert's indefinite description
operator <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">ε</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, used here to choose an arbitrary trace from the
protocol state.

That this automaton maintains the correct equivalence class on a trace
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">t</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> follows from an easy induction over <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">t</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

›</span></span>

<span class="keyword1" id="KBPsAuto-mkAutoEC_ec"><span class="command">lemma</span></span> mkAutoEC_ec<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> jkbpC"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"runJP mkAutoEC <span class="free">t</span> <span class="free">a</span> <span class="main">=</span> <span class="main">{</span> <span class="bound"><span class="bound">t'</span></span> <span class="main">∈</span> jkbpC <span class="main">.</span> <span class="free">jview</span> <span class="free">a</span> <span class="bound">t'</span> <span class="main">=</span> <span class="free">jview</span> <span class="free">a</span> <span class="free">t</span> <span class="main">}</span>"</span></span>
<span class="comment1">(*&lt;*)</span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mkAutoEC_def jviewInit<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> mkAutoEC_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> Let_def jviewIncr<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

We can show that the construction yields an implementation by
appealing to the previous lemma and showing that the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"pAct"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
functions coincide.

›</span></span>

<span class="keyword1" id="KBPsAuto-mkAutoEC_implements"><span class="command">lemma</span></span> mkAutoEC_implements<span class="main">:</span> <span class="quoted"><span class="quoted">"implements mkAutoEC"</span></span>
<span class="comment1">(*&lt;*)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> implements_ind_jkbpC<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> mkAutoEC_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">t</span> <span class="main">∈</span> jkbpC"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command">using</span></span> mkAutoEC_ec
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> S5n_jAction_eq<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">t</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> someI2<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">unfolding</span></span> mkM_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

This definition leans on the canonical trace set jkbpC, and is indeed
effective: we can enumerate all canonical traces and are sure to find
one that has the view we expect. Then it is sufficient to consider
other traces of the same length due to synchrony.  We would need to do
this computation dynamically, as the automaton will (in general) have
an infinite state space.

›</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context IncrEnvironment *)</span>

<span class="comment1">(* **************************************** *)</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Simulations›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
\label{sec:kbps-theory-automata-env-sims}

Our goal now is to reduce the space required by the automaton
constructed by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">mkAutoEC</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> by \emph{simulating} the equivalence
classes (\S\ref{sec:kripke-theory-simulations}).

The following locale captures the framework of \citet{Ron:1996}:

›</span></span>

<span class="keyword1"><span class="command">locale</span></span> SimIncrEnvironment <span class="main">=</span>
  IncrEnvironment <span class="quoted"><span class="free">jkbp</span></span> <span class="quoted"><span class="free">envInit</span></span> <span class="quoted"><span class="free">envAction</span></span> <span class="quoted"><span class="free">envTrans</span></span> <span class="quoted"><span class="free">envVal</span></span> <span class="quoted"><span class="free">jview</span></span> <span class="quoted"><span class="free">envObs</span></span>
                  <span class="quoted"><span class="free">jviewInit</span></span> <span class="quoted"><span class="free">jviewIncr</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">jkbp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'aAct</span><span class="main">)</span> JKBP"</span></span>

    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">envInit</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> list"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">envAction</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'eAct</span> list"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">envTrans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'eAct</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'aAct</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">envVal</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">jview</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'tv</span><span class="main">)</span> JointView"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">envObs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'obs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">jviewInit</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'obs</span><span class="main">,</span> <span class="tfree">'tv</span><span class="main">)</span> InitialIncrJointView"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">jviewIncr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'obs</span><span class="main">,</span> <span class="tfree">'tv</span><span class="main">)</span> IncrJointView"</span></span>
<span class="main">+</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">simf</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> Trace <span class="main">⇒</span> <span class="tfree">'ss</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">simRels</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'ss</span> Relation"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">simVal</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'ss</span> <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> simf<span class="main">:</span> <span class="quoted"><span class="quoted">"sim MC <span class="main">(</span>mkKripke <span class="main">(</span><span class="free">simf</span> <span class="main">`</span> jkbpC<span class="main">)</span> <span class="free">simRels</span> <span class="free">simVal</span><span class="main">)</span> <span class="free">simf</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span> SimIncrEnvironment
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

Note that the back tick <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>`›</span></span></span></span> is Isabelle/HOL's relational image
operator. In context it says that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">simf</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> must be a simulation
from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"jkbpC"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to its image under <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">simf</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

Firstly we lift our familiar canonical trace sets and Kripke
structures through the simulation.

›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">jkbpCSn</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'ss</span> set"</span></span><span class="comment1">(*&lt;*)</span><span class="main">(</span><span class="quoted">"<span class="keyword1">jkbpCS⇘</span>_<span class="keyword1">⇙</span>"</span><span class="main">)</span><span class="comment1">(*&gt;*)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"jkbpCS<span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">n</span></span></span></sub><span class="hidden">⇙</span> <span class="main">≡</span> <span class="free">simf</span> <span class="main">`</span> jkbpC<span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">n</span></span></span></sub><span class="hidden">⇙</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">jkbpCS</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'ss</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">jkbpCS</span> <span class="main">≡</span> <span class="free">simf</span> <span class="main">`</span> jkbpC"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">MCSn</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'ss</span><span class="main">)</span> KripkeStructure"</span></span><span class="comment1">(*&lt;*)</span><span class="main">(</span><span class="quoted">"<span class="keyword1">MCS⇘</span>_<span class="keyword1">⇙</span>"</span><span class="main">)</span><span class="comment1">(*&gt;*)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"MCS<span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">n</span></span></span></sub><span class="hidden">⇙</span> <span class="main">≡</span> mkKripke jkbpCS<span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">n</span></span></span></sub><span class="hidden">⇙</span> <span class="free">simRels</span> <span class="free">simVal</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">MCS</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'ss</span><span class="main">)</span> KripkeStructure"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">MCS</span> <span class="main">≡</span> mkKripke jkbpCS <span class="free">simRels</span> <span class="free">simVal</span>"</span></span>
<span class="comment1">(*&lt;*)</span>
<span class="keyword1" id="KBPsAuto-jkbpCSn_jkbpCS_subset"><span class="command">lemma</span></span> jkbpCSn_jkbpCS_subset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"jkbpCSn <span class="free">n</span> <span class="main">⊆</span> jkbpCS"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> image_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> jkbpCn_jkbpC_subset<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

We will be often be concerned with the equivalence class of traces
generated by agent <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">a</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>'s view:

›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">sim_equiv_class</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> Trace <span class="main">⇒</span> <span class="tfree">'ss</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sim_equiv_class</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> <span class="free">simf</span> <span class="main">`</span> <span class="main">{</span> <span class="bound"><span class="bound">t'</span></span> <span class="main">∈</span> jkbpC <span class="main">.</span> <span class="free">jview</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">t'</span> <span class="main">=</span> <span class="free">jview</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">jkbpSEC</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'ss</span> set set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">jkbpSEC</span> <span class="main">≡</span> <span class="main">⋃</span><span class="bound">a</span><span class="main">.</span> sim_equiv_class <span class="bound">a</span> <span class="main">`</span> jkbpC"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

With some effort we can show that the temporal slice of the simulated
structure is adequate for determining the actions of the JKBP. The
proof is tedious and routine, exploiting the sub-model property
(\S\ref{sec:generated_models}).

›</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1" id="KBPsAuto-sim_submodel_aux"><span class="command">lemma</span></span> sim_submodel_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> worlds <span class="main">(</span>MCSn <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"gen_model MCS <span class="free">s</span> <span class="main">=</span> gen_model <span class="main">(</span>MCSn <span class="free">n</span><span class="main">)</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> gen_model_subset<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> T<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"jkbpCSn <span class="free"><span class="free">n</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> s <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> worlds MCS"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> jkbpCSn_jkbpCS_subset<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> s <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> worlds <span class="main">(</span>MCSn <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">assumption</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"relations MCS <span class="skolem">a</span> <span class="main">∩</span> jkbpCSn <span class="free">n</span> <span class="main">×</span> jkbpCSn <span class="free">n</span>
      <span class="main">=</span> relations <span class="main">(</span>MCSn <span class="free">n</span><span class="main">)</span> <span class="skolem">a</span> <span class="main">∩</span> jkbpCSn <span class="free">n</span> <span class="main">×</span> jkbpCSn <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Int_ac Int_absorb1
                  relation_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> jkbpCSn_jkbpCS_subset jkbpCSn_jkbpCS_subset<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">from</span></span> s
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">a</span><span class="main">.</span> relations <span class="main">(</span>MCSn <span class="free">n</span><span class="main">)</span> <span class="bound">a</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="main">{</span><span class="free">s</span><span class="main">}</span> <span class="main">⊆</span> jkbpCSn <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> mkKripke_simps<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> kripke_rels_trc_worlds<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">from</span></span> s <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> st<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">=</span> <span class="free">simf</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> tCn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> jkbpCn <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">from</span></span> tCn <span class="keyword1"><span class="command">have</span></span> tC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> jkbpC"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t'</span>
    <span class="keyword3"><span class="command">assume</span></span> tt'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">t'</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">a</span><span class="main">.</span> relations MC <span class="bound">a</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> tC tt' <span class="keyword1"><span class="command">have</span></span> t'C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">∈</span> jkbpC"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">erule</span> kripke_rels_trc_worlds<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> tCn tt' <span class="keyword1"><span class="command">have</span></span> t'Len<span class="main">:</span> <span class="quoted"><span class="quoted">"tLength <span class="skolem">t'</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> sync_tLength_eq_trc<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> as<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">UNIV</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> t'C t'Len <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">∈</span> jkbpCn <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">erule</span> jkbpC_tLength_inv<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">a</span><span class="main">.</span> relations MC <span class="bound">a</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="main">{</span><span class="skolem">t</span><span class="main">}</span> <span class="main">⊆</span> jkbpCn <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">simf</span> <span class="main">`</span> <span class="main">(</span><span class="main">(</span><span class="main">⋃</span><span class="bound">a</span><span class="main">.</span> relations MC <span class="bound">a</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="main">{</span><span class="skolem">t</span><span class="main">}</span><span class="main">)</span> <span class="main">⊆</span> jkbpCSn <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> image_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> st tC
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">a</span><span class="main">.</span> relations MCS <span class="bound">a</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="main">{</span><span class="free">s</span><span class="main">}</span> <span class="main">⊆</span> jkbpCSn <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sim_trc_commute<span class="main">[</span><span class="operator">OF</span> _ simf<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">t</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1" id="KBPsAuto-jkbpC_jkbpCSn_jAction_eq"><span class="command">lemma</span></span> jkbpC_jkbpCSn_jAction_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tCn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> jkbpCn <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"jAction MC <span class="free">t</span> <span class="main">=</span> jAction <span class="main">(</span>MCSn <span class="free">n</span><span class="main">)</span> <span class="main">(</span><span class="free">simf</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="comment1">(*&lt;*)</span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> jAction MCS <span class="main">(</span><span class="free">simf</span> <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> simulation_jAction_eq simf jkbpCn_jkbpC_inc<span class="main"><span class="main">[</span></span><span class="operator">OF</span> tCn<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> tCn
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span> <span class="operator">rule</span> gen_model_jAction_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sim_submodel_aux<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> w<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free"><span class="free">simf</span></span></span> <span class="free"><span class="free"><span class="free">t</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span>
         <span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> gen_model_world_refl <span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context SimIncrEnvironment *)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

It can be shown that a suitable simulation into a finite structure is
adequate to establish the existence of finite-state implementations
\citep[Theorem~2]{Ron:1996}: essentially we apply the simulation to
the states of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">mkAutoEC</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. However this result does not make it
clear how the transition function can be incrementally
constructed. One approach is to maintain <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">jkbpC</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> while
extending the automaton, which is quite space inefficient.

Intuitively we would like to compute the possible <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="free">sim_equiv_class</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> successors of a given <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">sim_equiv_class</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
without reference to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">jkbpC</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, and this should be possible as
the reachable simulated worlds must contain enough information to
differentiate themselves from every other simulated world (reachable
or not) that represents a trace that is observationally distinct to
their own.

This leads us to asking for some extra functionality of our
simulation, which we do in the following section.

›</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Automata using simulations›</span></span>

<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹
\label{sec:kbps-automata-synthesis-alg}

\begin{figure}[hp]
\begin{isabellebody}%
›</span></span>
<span class="keyword1"><span class="command">locale</span></span> AlgSimIncrEnvironment <span class="main">=</span>
  SimIncrEnvironment <span class="quoted"><span class="free">jkbp</span></span> <span class="quoted"><span class="free">envInit</span></span> <span class="quoted"><span class="free">envAction</span></span> <span class="quoted"><span class="free">envTrans</span></span> <span class="quoted"><span class="free">envVal</span></span>
                     <span class="quoted"><span class="free">jview</span></span> <span class="quoted"><span class="free">envObs</span></span> <span class="quoted"><span class="free">jviewInit</span></span> <span class="quoted"><span class="free">jviewIncr</span></span> <span class="quoted"><span class="free">simf</span></span> <span class="quoted"><span class="free">simRels</span></span> <span class="quoted"><span class="free">simVal</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">jkbp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'aAct</span><span class="main">)</span> JKBP"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">envInit</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> list"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">envAction</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'eAct</span> list"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">envTrans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'eAct</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'aAct</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">envVal</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> bool"</span></span>

    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">jview</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'tv</span><span class="main">)</span> JointView"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">envObs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'obs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">jviewInit</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'obs</span><span class="main">,</span> <span class="tfree">'tv</span><span class="main">)</span> InitialIncrJointView"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">jviewIncr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'obs</span><span class="main">,</span> <span class="tfree">'tv</span><span class="main">)</span> IncrJointView"</span></span>

    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">simf</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> Trace <span class="main">⇒</span> <span class="tfree">'ss</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">simRels</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'ss</span> Relation"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">simVal</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'ss</span> <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> bool"</span></span>

<span class="main">+</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">simAbs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'rep</span> <span class="main">⇒</span> <span class="tfree">'ss</span> set"</span></span>

    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">simObs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'rep</span> <span class="main">⇒</span> <span class="tfree">'obs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">simInit</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'obs</span> <span class="main">⇒</span> <span class="tfree">'rep</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">simTrans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'rep</span> <span class="main">⇒</span> <span class="tfree">'rep</span> list"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">simAction</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'rep</span> <span class="main">⇒</span> <span class="tfree">'aAct</span> list"</span></span>

  <span class="keyword2"><span class="keyword">assumes</span></span> simInit<span class="main">:</span>
            <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span> <span class="bound">iobs</span><span class="main">.</span> <span class="bound">iobs</span> <span class="main">∈</span> <span class="free">envObs</span> <span class="bound">a</span> <span class="main">`</span> set <span class="free">envInit</span>
                   <span class="main">⟶</span> <span class="free">simAbs</span> <span class="main">(</span><span class="free">simInit</span> <span class="bound">a</span> <span class="bound">iobs</span><span class="main">)</span>
                     <span class="main">=</span> <span class="free">simf</span> <span class="main">`</span> <span class="main">{</span> <span class="bound"><span class="bound">t'</span></span> <span class="main">∈</span> jkbpC<span class="main">.</span> <span class="free">jview</span> <span class="bound">a</span> <span class="bound">t'</span> <span class="main">=</span> <span class="free">jviewInit</span> <span class="bound">a</span> <span class="bound">iobs</span> <span class="main">}</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> simObs<span class="main">:</span>
            <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span> <span class="bound">ec</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> jkbpC <span class="main">∧</span> <span class="free">simAbs</span> <span class="bound">ec</span> <span class="main">=</span> sim_equiv_class <span class="bound">a</span> <span class="bound">t</span>
                   <span class="main">⟶</span> <span class="free">simObs</span> <span class="bound">a</span> <span class="bound">ec</span> <span class="main">=</span> <span class="free">envObs</span> <span class="bound">a</span> <span class="main">(</span>tLast <span class="bound">t</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> simAction<span class="main">:</span>
            <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span> <span class="bound">ec</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> jkbpC <span class="main">∧</span> <span class="free">simAbs</span> <span class="bound">ec</span> <span class="main">=</span> sim_equiv_class <span class="bound">a</span> <span class="bound">t</span>
                   <span class="main">⟶</span> set <span class="main">(</span><span class="free">simAction</span> <span class="bound">a</span> <span class="bound">ec</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>jAction MC <span class="bound">t</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> simTrans<span class="main">:</span>
            <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span> <span class="bound">ec</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> jkbpC <span class="main">∧</span> <span class="free">simAbs</span> <span class="bound">ec</span> <span class="main">=</span> sim_equiv_class <span class="bound">a</span> <span class="bound">t</span>
                   <span class="main">⟶</span> <span class="free">simAbs</span> <span class="main">`</span> set <span class="main">(</span><span class="free">simTrans</span> <span class="bound">a</span> <span class="bound">ec</span><span class="main">)</span>
                     <span class="main">=</span> <span class="main">{</span> sim_equiv_class <span class="bound">a</span> <span class="main">(</span><span class="bound">t'</span> <span class="main">↝</span> <span class="bound">s</span><span class="main">)</span>
                         <span class="main">|</span><span class="bound">t'</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">t'</span> <span class="main">↝</span> <span class="bound">s</span> <span class="main">∈</span> jkbpC <span class="main">∧</span> <span class="free">jview</span> <span class="bound">a</span> <span class="bound">t'</span> <span class="main">=</span> <span class="free">jview</span> <span class="bound">a</span> <span class="bound">t</span> <span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹
\end{isabellebody}%
\begin{isamarkuptext}%
\caption{The <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>SimEnvironment›</span></span></span></span> locale extends the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>
<span class="quoted"><span class="quoted">"Environment"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> locale with simulation and algorithmic operations. The
backtick <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>`›</span></span></span></span> is Isabelle/HOL's image-of-a-set-under-a-function
operator.}
\label{fig:kbps-theory-auto-SimEnvironment}
\end{isamarkuptext}%
\end{figure}
›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The locale in Figure~\ref{fig:kbps-theory-auto-SimEnvironment} captures
our extra requirements of a simulation.

Firstly we relate the concrete representation <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'rep</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> of
equivalence classes under simulation to differ from the abstract
representation <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'ss</span></span> set"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> using the abstraction function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="free">simAbs</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> \citep{EdR:cup98}; there is no one-size-fits-all concrete
representation, as we will see.

Secondly we ask for a function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">simInit</span></span> <span class="free"><span class="free">a</span></span> <span class="free"><span class="free">iobs</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> that
faithfully generates a representation of the equivalence class of
simulated initial states that are possible for agent <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">a</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> given
the valid initial observation <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">iobs</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

Thirdly the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">simObs</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> function allows us to partition the
results of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">simTrans</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> according to the recurrent observation
that agent <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">a</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> makes of the equivalence class.

Fourthly, the function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">simAction</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> computes a list of actions
enabled by the JKBP on a state that concretely represents a canonical
equivalence class.

Finally we expect to compute the list of represented <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="free">sim_equiv_class</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> successors of a given <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">sim_equiv_class</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
using <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">simTrans</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

Note that these definitions are stated relative to the environment and
the JKBP, allowing us to treat specialised cases such as broadcast
(\S\ref{sec:kbps-theory-spr-deterministic-protocols} and
\S\ref{sec:kbps-theory-spr-non-deterministic-protocols}).

With these functions in hand, we can define our desired automaton:

›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> AlgSimIncrEnvironment<span class="main">)</span>
  <span class="entity">mkAutoSim</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'obs</span><span class="main">,</span> <span class="tfree">'aAct</span><span class="main">,</span> <span class="tfree">'rep</span><span class="main">)</span> JointProtocol"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mkAutoSim</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">a</span><span class="main">.</span>
     <span class="main">⦇</span> pInit <span class="main">=</span> <span class="free">simInit</span> <span class="bound">a</span><span class="main">,</span>
       pTrans <span class="main">=</span> <span class="main">λ</span><span class="bound">obs</span> <span class="bound">ec</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">ec'</span><span class="main">.</span> <span class="bound">ec'</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">simTrans</span> <span class="bound">a</span> <span class="bound">ec</span><span class="main">)</span>
                                  <span class="main">∧</span> <span class="free">simObs</span> <span class="bound">a</span> <span class="bound">ec'</span> <span class="main">=</span> <span class="bound">obs</span><span class="main">)</span><span class="main">,</span>
       pAct <span class="main">=</span> <span class="free">simAction</span> <span class="bound">a</span> <span class="main">⦈</span>"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1"><span class="command">context</span></span> AlgSimIncrEnvironment
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="KBPsAuto-jAction_simAbs_cong"><span class="command">lemma</span></span> jAction_simAbs_cong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> jkbpC"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> ec<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">simAbs</span> <span class="free">ec</span> <span class="main">=</span> sim_equiv_class <span class="free">a</span> <span class="free">t</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> ec'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">simAbs</span> <span class="free">ec</span> <span class="main">=</span> <span class="free">simAbs</span> <span class="free">ec'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="free">simAction</span> <span class="free">a</span> <span class="free">ec</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span><span class="free">simAction</span> <span class="free">a</span> <span class="free">ec'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms simAction<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> t<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">t</span></span><span class="main">]</span> tC <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="KBPsAuto-simTrans_simAbs_cong"><span class="command">lemma</span></span> simTrans_simAbs_cong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> jkbpC"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> ec<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">simAbs</span> <span class="free">ec</span> <span class="main">=</span> sim_equiv_class <span class="free">a</span> <span class="free">t</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> ec'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">simAbs</span> <span class="free">ec</span> <span class="main">=</span> <span class="free">simAbs</span> <span class="free">ec'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">simAbs</span> <span class="main">`</span> set <span class="main">(</span><span class="free">simTrans</span> <span class="free">a</span> <span class="free">ec</span><span class="main">)</span> <span class="main">=</span> <span class="free">simAbs</span> <span class="main">`</span> set <span class="main">(</span><span class="free">simTrans</span> <span class="free">a</span> <span class="free">ec'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms simTrans<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> t<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">t</span></span><span class="main">]</span> tC <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="KBPsAuto-mkAutoSim_simps"><span class="command">lemma</span></span> mkAutoSim_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"pInit <span class="main">(</span>mkAutoSim <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="free">simInit</span> <span class="free">a</span>"</span></span>
  <span class="quoted"><span class="quoted">"pTrans <span class="main">(</span>mkAutoSim <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">obs</span> <span class="bound">ec</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">ec'</span><span class="main">.</span> <span class="bound">ec'</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">simTrans</span> <span class="free">a</span> <span class="bound">ec</span><span class="main">)</span> <span class="main">∧</span> <span class="free">simObs</span> <span class="free">a</span> <span class="bound">ec'</span> <span class="main">=</span> <span class="bound">obs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"pAct <span class="main">(</span>mkAutoSim <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="free">simAction</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mkAutoSim_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context AlgSimIncrEnvironment *)</span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The automaton faithfully constructs the simulated equivalence class of
the given trace:

›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> AlgSimIncrEnvironment<span class="main">)</span> mkAutoSim_ec<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> jkbpC"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">simAbs</span> <span class="main">(</span>runJP mkAutoSim <span class="free">t</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> sim_equiv_class <span class="free">a</span> <span class="free">t</span>"</span></span>
<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">using</span></span> tC
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tInit <span class="skolem">s</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> jviewInit<span class="main"><span class="main">[</span></span><span class="operator">rule_format</span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> simInit<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tStep <span class="skolem">t</span> <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> tC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> jkbpC"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

      <span class="keyword1"><span class="command">from</span></span> tC tStep
      <span class="keyword1"><span class="command">have</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">simAbs</span> <span class="main">`</span> set <span class="main">(</span><span class="free">simTrans</span> <span class="free">a</span> <span class="main">(</span>runJP mkAutoSim <span class="skolem">t</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>
             <span class="main">=</span> <span class="main">{</span> sim_equiv_class <span class="free">a</span> <span class="main">(</span><span class="bound">t'</span> <span class="main">↝</span> <span class="bound">s</span><span class="main">)</span>
                 <span class="main">|</span><span class="bound">t'</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">t'</span> <span class="main">↝</span> <span class="bound">s</span> <span class="main">∈</span> jkbpC <span class="main">∧</span> <span class="free">jview</span> <span class="free">a</span> <span class="bound">t'</span> <span class="main">=</span> <span class="free">jview</span> <span class="free">a</span> <span class="skolem">t</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> simTrans<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> t<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> ec<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"runJP mkAutoSim <span class="skolem">t</span> <span class="free">a</span>"</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

      <span class="keyword1"><span class="command">from</span></span> tStep
      <span class="keyword1"><span class="command">have</span></span> G<span class="main">:</span> <span class="quoted"><span class="quoted">"sim_equiv_class <span class="free">a</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">↝</span> <span class="skolem">s</span><span class="main">)</span>
             <span class="main">∈</span> <span class="main">{</span> sim_equiv_class <span class="free">a</span> <span class="main">(</span><span class="bound">t'</span> <span class="main">↝</span> <span class="bound">s</span><span class="main">)</span>
                <span class="main">|</span><span class="bound">t'</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">t'</span> <span class="main">↝</span> <span class="bound">s</span> <span class="main">∈</span> jkbpC <span class="main">∧</span> <span class="free">jview</span> <span class="free">a</span> <span class="bound">t'</span> <span class="main">=</span> <span class="free">jview</span> <span class="free">a</span> <span class="skolem">t</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">from</span></span> F G
      <span class="keyword1"><span class="command">have</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"sim_equiv_class <span class="free">a</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">↝</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">∈</span> <span class="free">simAbs</span> <span class="main">`</span> set <span class="main">(</span><span class="free">simTrans</span> <span class="free">a</span> <span class="main">(</span>runJP mkAutoSim <span class="skolem">t</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span>
        <span class="keyword2"><span class="keyword">where</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">simTrans</span> <span class="free">a</span> <span class="main">(</span>runJP mkAutoSim <span class="skolem">t</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">simAbs</span> <span class="skolem">r</span> <span class="main">=</span> sim_equiv_class <span class="free">a</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">↝</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> someI2<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> R S tStep tC
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">simTrans</span> <span class="free">a</span> <span class="main">(</span>runJP mkAutoSim <span class="skolem">t</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="free">simObs</span> <span class="free">a</span> <span class="skolem">r</span> <span class="main">=</span> <span class="free">envObs</span> <span class="free">a</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> simObs<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">t</span><span class="main">↝</span><span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">a</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">simTrans</span> <span class="free">a</span> <span class="main">(</span>runJP mkAutoSim <span class="skolem">t</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="free">simObs</span> <span class="free">a</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">envObs</span> <span class="free">a</span> <span class="skolem">s</span>"</span></span>

    <span class="keyword1"><span class="command">from</span></span> x
    <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">simObs</span> <span class="free">a</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">envObs</span> <span class="free">a</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">from</span></span> x
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">simAbs</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="free">simAbs</span> <span class="main">`</span> set <span class="main">(</span><span class="free">simTrans</span> <span class="free">a</span> <span class="main">(</span>runJP mkAutoSim <span class="skolem">t</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> tStep tC
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">simAbs</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span> sim_equiv_class <span class="free">a</span> <span class="main">(</span><span class="bound">t'</span> <span class="main">↝</span> <span class="bound">s</span><span class="main">)</span>
                         <span class="main">|</span><span class="bound">t'</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">t'</span> <span class="main">↝</span> <span class="bound">s</span> <span class="main">∈</span> jkbpC <span class="main">∧</span> <span class="free">jview</span> <span class="free">a</span> <span class="bound">t'</span> <span class="main">=</span> <span class="free">jview</span> <span class="free">a</span> <span class="skolem">t</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> simTrans<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> t<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">t</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="skolem"><span class="skolem">s'</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">simAbs</span> <span class="skolem">x</span> <span class="main">=</span> sim_equiv_class <span class="free">a</span> <span class="main">(</span><span class="skolem">t'</span> <span class="main">↝</span> <span class="skolem">s'</span><span class="main">)</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> Y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">↝</span> <span class="skolem">s'</span> <span class="main">∈</span> jkbpC"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> Z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">jview</span> <span class="free">a</span> <span class="skolem">t'</span> <span class="main">=</span> <span class="free">jview</span> <span class="free">a</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">from</span></span> A X Y Z
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">simAbs</span> <span class="skolem">x</span> <span class="main">=</span> sim_equiv_class <span class="free">a</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">↝</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> simObs<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> t<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">t'</span><span class="main">↝</span><span class="skolem">s'</span>"</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> jviewIncr<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

This follows from a simple induction on <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">t</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

The following is a version of the Theorem 2 of \citet{Ron:1996}.

›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> AlgSimIncrEnvironment<span class="main">)</span> mkAutoSim_implements<span class="main">:</span>
  <span class="quoted"><span class="quoted">"implements mkAutoSim"</span></span>
<span class="comment1">(*&lt;*)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> jkbpCn_jkbpC_inc <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> mkAutoSim_ec simAction<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The reader may care to contrast these structures with the
\emph{progression structures} of \citet{Ron:1997}, where states
contain entire Kripke structures, and expanding the automaton is
alternated with bisimulation reduction to ensure termination when a
finite-state implementation exists (see \S\ref{sec:kbps-alg-auto-min})
We also use simulations in Appendix~\ref{ch:complexity} to show the
complexity of some related model checking problems.

We now review a simple \emph{depth-first search} (DFS) theory, and an
abstraction of finite maps, before presenting the algorithm for KBP
synthesis.

\FloatBarrier

›</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="DFS">
<div class="head">
<h1>Theory DFS</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      Presburger-Automata/DFS.thy
    Author:     Toshiaki Nishihara and Yasuhiko Minamide
    Author:     Stefan Berghofer and Alex Krauss, TU Muenchen, 2008-2009
    Author:     Peter Gammie (data refinement futz), 2010
*)</span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> DFS
<span class="keyword2"><span class="keyword">imports</span></span> <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Generic DFS›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

\label{sec:dfs}

We use a generic DFS to construct the transitions and action function
of the implementation of the JKBP. This theory is largely due to
Stefan Berghofer and Alex Krauss
\citep{DBLP:conf/tphol/BerghoferR09}. All proofs are elided as the
fine details of how we explore the state space are inessential to the
synthesis algorithm.

The DFS itself is defined in the standard tail-recursive way:

›</span></span>

<span class="keyword1"><span class="command">partial_function</span></span> <span class="main">(</span>tailrec<span class="main">)</span> <span class="entity">gen_dfs</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">gen_dfs</span> <span class="free"><span class="bound"><span class="entity">succs</span></span></span> <span class="free"><span class="bound"><span class="entity">ins</span></span></span> <span class="free"><span class="bound"><span class="entity">memb</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">wl</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">wl</span></span></span> <span class="keyword1">of</span>
     <span class="main">[]</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span>
   <span class="main">|</span> <span class="main">(</span><span class="bound">x</span> <span class="main">#</span> <span class="bound">xs</span><span class="main">)</span> <span class="main">⇒</span>
       <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">memb</span></span></span> <span class="bound">x</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="keyword1">then</span> <span class="free">gen_dfs</span> <span class="free"><span class="bound"><span class="entity">succs</span></span></span> <span class="free"><span class="bound"><span class="entity">ins</span></span></span> <span class="free"><span class="bound"><span class="entity">memb</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="bound">xs</span>
       <span class="keyword1">else</span> <span class="free">gen_dfs</span> <span class="free"><span class="bound"><span class="entity">succs</span></span></span> <span class="free"><span class="bound"><span class="entity">ins</span></span></span> <span class="free"><span class="bound"><span class="entity">memb</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ins</span></span></span> <span class="bound">x</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">succs</span></span></span> <span class="bound">x</span> <span class="main">@</span> <span class="bound">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="comment1">(*&lt;*)</span>
<span class="keyword1" id="DFS-gen_dfs_simps"><span class="command">lemma</span></span> gen_dfs_simps<span class="main">[</span><span class="operator">code</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"gen_dfs <span class="free">succs</span> <span class="free">ins</span> <span class="free">memb</span> <span class="free">S</span> <span class="main">[]</span> <span class="main">=</span> <span class="free">S</span>"</span></span>
  <span class="quoted"><span class="quoted">"gen_dfs <span class="free">succs</span> <span class="free">ins</span> <span class="free">memb</span> <span class="free">S</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free">memb</span> <span class="free">x</span> <span class="free">S</span> <span class="keyword1">then</span> gen_dfs <span class="free">succs</span> <span class="free">ins</span> <span class="free">memb</span> <span class="free">S</span> <span class="free">xs</span>
     <span class="keyword1">else</span> gen_dfs <span class="free">succs</span> <span class="free">ins</span> <span class="free">memb</span> <span class="main">(</span><span class="free">ins</span> <span class="free">x</span> <span class="free">S</span><span class="main">)</span> <span class="main">(</span><span class="free">succs</span> <span class="free">x</span> <span class="main">@</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gen_dfs.simps<span class="main">)</span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹
\begin{figure}
\begin{isabellebody}%
›</span></span>
<span class="keyword1"><span class="command">locale</span></span> DFS <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">succs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">isNode</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">invariant</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ins</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">memb</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">empt</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'b</span></span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">nodeAbs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'c</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ins_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">S</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">isNode</span> <span class="bound">x</span><span class="main">;</span> <span class="free">isNode</span> <span class="bound">y</span><span class="main">;</span> <span class="free">invariant</span> <span class="bound">S</span><span class="main">;</span> <span class="main">¬</span> <span class="free">memb</span> <span class="bound">y</span> <span class="bound">S</span> <span class="main">⟧</span>
                       <span class="main">⟹</span> <span class="free">memb</span> <span class="bound">x</span> <span class="main">(</span><span class="free">ins</span> <span class="bound">y</span> <span class="bound">S</span><span class="main">)</span>
                       <span class="main">⟷</span> <span class="main">(</span><span class="main">(</span><span class="free">nodeAbs</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">nodeAbs</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∨</span> <span class="free">memb</span> <span class="bound">x</span> <span class="bound">S</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> succs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">isNode</span> <span class="bound">x</span><span class="main">;</span> <span class="free">isNode</span> <span class="bound">y</span><span class="main">;</span> <span class="free">nodeAbs</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">nodeAbs</span> <span class="bound">y</span> <span class="main">⟧</span>
                       <span class="main">⟹</span> <span class="free">nodeAbs</span> <span class="main">`</span> set <span class="main">(</span><span class="free">succs</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">nodeAbs</span> <span class="main">`</span> set <span class="main">(</span><span class="free">succs</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> empt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">isNode</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="free">memb</span> <span class="bound">x</span> <span class="free">empt</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> succs_isNode<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">isNode</span> <span class="bound">x</span> <span class="main">⟹</span> list_all <span class="free">isNode</span> <span class="main">(</span><span class="free">succs</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> empt_invariant<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">invariant</span> <span class="free">empt</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> ins_invariant<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">S</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">isNode</span> <span class="bound">x</span><span class="main">;</span> <span class="free">invariant</span> <span class="bound">S</span><span class="main">;</span> <span class="main">¬</span> <span class="free">memb</span> <span class="bound">x</span> <span class="bound">S</span> <span class="main">⟧</span>
                        <span class="main">⟹</span> <span class="free">invariant</span> <span class="main">(</span><span class="free">ins</span> <span class="bound">x</span> <span class="bound">S</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> graph_finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">nodeAbs</span> <span class="main">`</span> <span class="main">{</span> <span class="bound">x</span> <span class="main">.</span> <span class="free">isNode</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹
\end{isabellebody}%
\begin{isamarkuptext}%
\caption{The <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>DFS›</span></span></span></span> locale.}
\label{fig:kbps-theory-dfs-locale}
\end{isamarkuptext}%
\end{figure}
›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The proofs are carried out in the locale of
Figure~\ref{fig:kbps-theory-dfs-locale}, which details our
requirements on the parameters for the DFS to behave as one would
expect. Intuitively we are traversing a graph defined by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="free">succs</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> from some initial work list <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">wl</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, constructing an
object of type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'b</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> as we go. The function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">ins</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
integrates the current node into this construction. The predicate
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">isNode</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is invariant over the set of states reachable from
the initial work list, and is respected by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">empt</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="free">ins</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. We can also supply an invariant for the constructed object
(<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">invariant</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>). Inside the locale, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">dfs</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> abbreviates
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"gen_dfs"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> partially applied to the fixed parameters.

To support our data refinement
(\S\ref{sec:kbps-automata-synthesis-alg}) we also require that the
representation of nodes be adequate via the abstraction function
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">nodeAbs</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, which the transition relation <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">succs</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and
visited predicate <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">memb</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> must respect. To ensure termination
it must be the case that there are only a finite number of states,
though there might be an infinity of representations.

We characterise the DFS traversal using the reflexive
transitive closure operator:

›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> DFS<span class="main">)</span> <span class="entity">reachable</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">reachable</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">succs</span> <span class="bound">x</span><span class="main">)</span><span class="main">}</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1"><span class="command">context</span></span> DFS
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">succss</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span> <span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">.</span> set <span class="main">(</span><span class="free">succs</span> <span class="bound">x</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">set_of</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free">isNode</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">memb</span> <span class="bound">x</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dfs</span> <span class="main">≡</span> gen_dfs <span class="free">succs</span> <span class="free">ins</span> <span class="free">memb</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rel</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rel</span> <span class="main">=</span> inv_image finite_psubset <span class="main">(</span><span class="main">λ</span><span class="bound">S</span><span class="main">.</span> <span class="free">nodeAbs</span> <span class="main">`</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span>  <span class="free">isNode</span> <span class="bound">n</span> <span class="main">∧</span> <span class="main">¬</span> <span class="free">memb</span> <span class="bound">n</span> <span class="bound">S</span><span class="main">}</span><span class="main">)</span>"</span></span>

<span class="comment1">(* Yuck, something to do with Skolems broke. *)</span>
<span class="keyword1" id="DFS-nodeAbs_subset_grot"><span class="command">lemma</span></span> nodeAbs_subset_grot<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">invariant</span> <span class="free">S</span><span class="main">;</span> <span class="free">isNode</span> <span class="free">x</span><span class="main">;</span> list_all <span class="free">isNode</span> <span class="free">xs</span><span class="main">;</span> <span class="main">¬</span><span class="free">memb</span> <span class="free">x</span> <span class="free">S</span><span class="main">⟧</span>
     <span class="main">⟹</span> <span class="free">nodeAbs</span> <span class="main">`</span> <span class="main">{</span><span class="bound">n</span> <span class="main">.</span> <span class="free">isNode</span> <span class="bound">n</span> <span class="main">∧</span> <span class="main">¬</span> <span class="free">memb</span> <span class="bound">n</span> <span class="main">(</span><span class="free">ins</span> <span class="free">x</span> <span class="free">S</span><span class="main">)</span><span class="main">}</span>
       <span class="main">⊂</span> <span class="free">nodeAbs</span> <span class="main">`</span> <span class="main">{</span><span class="bound">n</span> <span class="main">.</span> <span class="free">isNode</span> <span class="bound">n</span> <span class="main">∧</span> <span class="main">¬</span> <span class="free">memb</span> <span class="bound">n</span> <span class="free">S</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ins_eq <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> conj_cong<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="free">nodeAbs</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">nodeAbs</span> <span class="main">`</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> <span class="free">isNode</span> <span class="bound">n</span> <span class="main">∧</span> <span class="main">¬</span> <span class="free">memb</span> <span class="bound">n</span> <span class="free">S</span><span class="main">}</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="free">nodeAbs</span> <span class="free">x</span> <span class="main">∉</span> <span class="free">nodeAbs</span> <span class="main">`</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> <span class="free">isNode</span> <span class="bound">n</span> <span class="main">∧</span> <span class="free">nodeAbs</span> <span class="bound">n</span> <span class="main">≠</span> <span class="free">nodeAbs</span> <span class="free">x</span> <span class="main">∧</span> <span class="main">¬</span> <span class="free">memb</span> <span class="bound">n</span> <span class="free">S</span><span class="main">}</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> imageE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">back</span></span></span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="DFS-psubsetI2"><span class="command">lemma</span></span> psubsetI2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">A</span> <span class="main">⊆</span> <span class="free">B</span><span class="main">;</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">A</span><span class="main">;</span> <span class="free">x</span> <span class="main">∉</span> <span class="free">B</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">⊂</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> less_le<span class="main">)</span> <span class="operator">blast</span>

<span class="keyword1" id="DFS-dfs_induct"><span class="command">lemma</span></span> dfs_induct<span class="main">[</span><span class="operator">consumes</span> 2<span class="main">,</span> <span class="operator">case_names</span> base step<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">invariant</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> xs<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="free">isNode</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> I1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">S</span><span class="main">.</span> <span class="free">invariant</span> <span class="bound">S</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">S</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> I2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">S</span> <span class="bound">x</span> <span class="bound">xs</span><span class="main">.</span> <span class="free">invariant</span> <span class="bound">S</span> <span class="main">⟹</span> <span class="free">isNode</span> <span class="bound">x</span> <span class="main">⟹</span> list_all <span class="free">isNode</span> <span class="bound">xs</span> <span class="main">⟹</span>
    <span class="main">(</span><span class="free">memb</span> <span class="bound">x</span> <span class="bound">S</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">S</span> <span class="bound">xs</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">¬</span> <span class="free">memb</span> <span class="bound">x</span> <span class="bound">S</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="free">ins</span> <span class="bound">x</span> <span class="bound">S</span><span class="main">)</span> <span class="main">(</span><span class="free">succs</span> <span class="bound">x</span> <span class="main">@</span> <span class="bound">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">S</span> <span class="main">(</span><span class="bound">x</span> <span class="main">#</span> <span class="bound">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">S</span> <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> I1 I2 S xs
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">induction_schema</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">atomize_elim</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">atomize_elim</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ins_invariant<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> succs_isNode<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"rel <span class="keyword1">&lt;*lex*&gt;</span> measure length"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_lex_prod rel_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI1<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def finite_psubset_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> nodeAbs_subset_grot<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ graph_finite<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="DFS-visit_subset_dfs"><span class="command">lemma</span></span> visit_subset_dfs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">invariant</span> <span class="free">S</span> <span class="main">⟹</span> list_all <span class="free">isNode</span> <span class="free">xs</span> <span class="main">⟹</span>
  <span class="free">isNode</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">memb</span> <span class="free">y</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">memb</span> <span class="free">y</span> <span class="main">(</span>dfs <span class="free">S</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> dfs_induct<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ins_eq<span class="main">)</span>

<span class="keyword1" id="DFS-next_subset_dfs"><span class="command">lemma</span></span> next_subset_dfs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">invariant</span> <span class="free">S</span> <span class="main">⟹</span> list_all <span class="free">isNode</span> <span class="free">xs</span> <span class="main">⟹</span>
  <span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> <span class="free">memb</span> <span class="free">x</span> <span class="main">(</span>dfs <span class="free">S</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> dfs_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">S</span> <span class="skolem">y</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> visit_subset_dfs ins_eq ins_invariant succs_isNode<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="DFS-succss_closed_dfs'"><span class="command">lemma</span></span> succss_closed_dfs'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">invariant</span> <span class="free">ys</span> <span class="main">⟹</span> list_all <span class="free">isNode</span> <span class="free">xs</span> <span class="main">⟹</span>
   <span class="free">nodeAbs</span> <span class="main">`</span> succss <span class="main">(</span>set_of <span class="free">ys</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">nodeAbs</span> <span class="main">`</span> <span class="main">(</span>set <span class="free">xs</span> <span class="main">∪</span> set_of <span class="free">ys</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">nodeAbs</span> <span class="main">`</span> succss <span class="main">(</span>set_of <span class="main">(</span>dfs <span class="free">ys</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">nodeAbs</span> <span class="main">`</span> set_of <span class="main">(</span>dfs <span class="free">ys</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ys</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> dfs_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>base <span class="skolem">S</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">S</span> <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> succss_def set_of_def <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> conj_cong<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="free">nodeAbs</span> <span class="improper">xa</span> <span class="main">∈</span> <span class="free">nodeAbs</span> <span class="main">`</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free">isNode</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">memb</span> <span class="bound">x</span> <span class="main">(</span>dfs <span class="skolem">S</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> set <span class="main">(</span><span class="free">succs</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="free">nodeAbs</span> <span class="main">`</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="bound">xa</span><span class="main">.</span> <span class="free">isNode</span> <span class="bound">xa</span> <span class="main">∧</span> <span class="free">memb</span> <span class="bound">xa</span> <span class="main">(</span><span class="free">ins</span> <span class="skolem">x</span> <span class="skolem">S</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> set <span class="main">(</span><span class="free">succs</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">nodeAbs</span> <span class="main">`</span> <span class="main">(</span>set <span class="main">(</span><span class="free">succs</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∪</span> set <span class="skolem">xs</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">xa</span><span class="main">.</span> <span class="free">isNode</span> <span class="bound">xa</span> <span class="main">∧</span> <span class="free">memb</span> <span class="bound">xa</span> <span class="main">(</span><span class="free">ins</span> <span class="skolem">x</span> <span class="skolem">S</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ins_eq succss_def set_of_def <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> conj_cong<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">xc'</span><span class="main">.</span> <span class="bound">xc'</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">succs</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∧</span> <span class="free">nodeAbs</span> <span class="bound">xc'</span> <span class="main">=</span> <span class="free">nodeAbs</span> <span class="improper">xc</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">xc'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> image_eqI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cut_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">xd</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> y<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> succs<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="free">nodeAbs</span> <span class="improper">xc</span> <span class="main">∈</span> <span class="free">nodeAbs</span> <span class="main">`</span> set <span class="main">(</span><span class="free">succs</span> <span class="skolem">x</span><span class="main">)</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="free">nodeAbs</span> <span class="main">`</span> set <span class="main">(</span><span class="free">succs</span> <span class="improper">xd</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">nodeAbs</span> <span class="main">`</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free">isNode</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">memb</span> <span class="bound">x</span> <span class="skolem">S</span><span class="main">}</span><span class="main">.</span> set <span class="main">(</span><span class="free">succs</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="free">nodeAbs</span> <span class="improper">xc</span> <span class="main">∈</span> <span class="free">nodeAbs</span> <span class="main">`</span> set <span class="main">(</span><span class="free">succs</span> <span class="improper">xd</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="free">nodeAbs</span> <span class="improper">xc</span> <span class="main">∈</span> insert <span class="main">(</span><span class="free">nodeAbs</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="free">nodeAbs</span> <span class="main">`</span> <span class="main">(</span>set <span class="skolem">xs</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free">isNode</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">memb</span> <span class="bound">x</span> <span class="skolem">S</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> rev_subsetD<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> subset_trans<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DFS-succss_closed_dfs"><span class="command">lemma</span></span> succss_closed_dfs<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="free">isNode</span> <span class="free">xs</span> <span class="main">⟹</span>
  <span class="free">nodeAbs</span> <span class="main">`</span> succss <span class="main">(</span>set_of <span class="main">(</span>dfs <span class="free">empt</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">nodeAbs</span> <span class="main">`</span> set_of <span class="main">(</span>dfs <span class="free">empt</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> succss_closed_dfs'<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> empt_invariant<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> succss_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command">unfolding</span></span> set_of_def
  <span class="keyword1"><span class="command">using</span></span> empt
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">succsr</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">succs</span> <span class="bound">x</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">theorem</span></span> succsr_isNode<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> xy<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> succsr<span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">isNode</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">isNode</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> xy
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">induct</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">y</span> <span class="skolem">z</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">isNode</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all <span class="free">isNode</span> <span class="main">(</span><span class="free">succs</span> <span class="skolem">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> succs_isNode<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> step <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> succsr_def list_all_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DFS-succss_closed"><span class="command">lemma</span></span> succss_closed<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">nodeAbs</span> <span class="main">`</span> succss <span class="free">X</span> <span class="main">⊆</span> <span class="free">nodeAbs</span> <span class="main">`</span> <span class="free">X</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">⊆</span> <span class="main">{</span> <span class="bound">x</span> <span class="main">.</span> <span class="free">isNode</span> <span class="bound">x</span> <span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">nodeAbs</span> <span class="main">`</span> reachable <span class="free">X</span> <span class="main">=</span> <span class="free">nodeAbs</span> <span class="main">`</span> <span class="free">X</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">nodeAbs</span> <span class="main">`</span> <span class="free">X</span> <span class="main">⊆</span> <span class="free">nodeAbs</span> <span class="main">`</span> reachable <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> reachable_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">nodeAbs</span> <span class="main">`</span> reachable <span class="free">X</span> <span class="main">⊆</span> <span class="free">nodeAbs</span> <span class="main">`</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">unfold</span> reachable_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
    <span class="keyword3"><span class="command">assume</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">y</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">succs</span> <span class="bound">x</span><span class="main">)</span><span class="main">}</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">nodeAbs</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="free">nodeAbs</span> <span class="main">`</span> <span class="free">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> y
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induct</span>
      <span class="keyword3"><span class="command">case</span></span> base <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">r</span> <span class="skolem">s</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> X step <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">isNode</span> <span class="skolem">r</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> succsr_isNode<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> y<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">r</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">unfolding</span></span> succsr_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">with</span></span> inc step <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="free">isNode</span> <span class="improper">x</span>"</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cut_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> y<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> succs<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="free">nodeAbs</span> <span class="skolem">s</span> <span class="main">∈</span> <span class="free">nodeAbs</span> <span class="main">`</span> set <span class="main">(</span><span class="free">succs</span> <span class="improper">x</span><span class="main">)</span>"</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command">using</span></span> X
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> succss_def<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
     <span class="keyword1"><span class="command">qed</span></span>
   <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DFS-dfs_isNode"><span class="command">lemma</span></span> dfs_isNode<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">invariant</span> <span class="free">S</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> xs<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="free">isNode</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set_of <span class="main">(</span>dfs <span class="free">S</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">x</span> <span class="main">.</span> <span class="free">isNode</span> <span class="bound">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> dfs_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_of_def<span class="main">)</span>

<span class="keyword1" id="DFS-reachable_closed_dfs"><span class="command">lemma</span></span> reachable_closed_dfs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> xs<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="free">isNode</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">nodeAbs</span> <span class="main">`</span> reachable <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">nodeAbs</span> <span class="main">`</span> set_of <span class="main">(</span>dfs <span class="free">empt</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> xs <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reachable <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span> <span class="main">⊆</span> reachable <span class="main">(</span>set_of <span class="main">(</span>dfs <span class="free">empt</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> reachable_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Image_mono<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_of_def next_subset_dfs empt_invariant list_all_iff<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">nodeAbs</span> <span class="main">`</span> reachable <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">nodeAbs</span> <span class="main">`</span> reachable <span class="main">(</span>set_of <span class="main">(</span>dfs <span class="free">empt</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> succss_closed_dfs<span class="main">[</span><span class="operator">OF</span> xs<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">nodeAbs</span> <span class="main">`</span> set_of <span class="main">(</span>dfs <span class="free">empt</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> succss_closed<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> dfs_isNode<span class="main"><span class="main">[</span></span><span class="operator">OF</span> empt_invariant xs<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DFS-reachable_succs"><span class="command">lemma</span></span> reachable_succs<span class="main">:</span> <span class="quoted"><span class="quoted">"reachable <span class="main">(</span>set <span class="main">(</span><span class="free">succs</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> reachable <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reachable_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> converse_rtrancl_into_rtrancl<span class="main">)</span>

<span class="keyword1" id="DFS-dfs_subset_reachable_visit_nodes"><span class="command">lemma</span></span> dfs_subset_reachable_visit_nodes<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">invariant</span> <span class="free">ys</span> <span class="main">⟹</span> list_all <span class="free">isNode</span> <span class="free">xs</span> <span class="main">⟹</span>
   <span class="free">nodeAbs</span> <span class="main">`</span> set_of <span class="main">(</span>dfs <span class="free">ys</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">nodeAbs</span> <span class="main">`</span> <span class="main">(</span>reachable <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span> <span class="main">∪</span> set_of <span class="free">ys</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ys</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> dfs_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">S</span> <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">memb</span> <span class="skolem">x</span> <span class="skolem">S</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> step <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reachable_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reachable <span class="main">(</span>set <span class="main">(</span><span class="free">succs</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> reachable <span class="main">{</span><span class="skolem">x</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> reachable_succs<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reachable <span class="main">(</span>set <span class="main">(</span><span class="free">succs</span> <span class="skolem">x</span> <span class="main">@</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> reachable <span class="main">(</span>set <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reachable_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> step
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reachable_def set_of_def <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> conj_cong<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="free">nodeAbs</span> <span class="improper">xa</span> <span class="main">∈</span> <span class="free">nodeAbs</span> <span class="main">`</span>
            <span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">succs</span> <span class="bound">x</span><span class="main">)</span><span class="main">}</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> set <span class="skolem">xs</span> <span class="main">∪</span>
             <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free">isNode</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">memb</span> <span class="bound">x</span> <span class="skolem">S</span><span class="main">}</span><span class="main">)</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="free">nodeAbs</span> <span class="improper">xa</span> <span class="main">∈</span> <span class="free">nodeAbs</span> <span class="main">`</span>
            <span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">succs</span> <span class="bound">x</span><span class="main">)</span><span class="main">}</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="main">(</span>set <span class="main">(</span><span class="free">succs</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∪</span> set <span class="skolem">xs</span><span class="main">)</span> <span class="main">∪</span>
             <span class="main">{</span><span class="bound">xa</span><span class="main">.</span> <span class="free">isNode</span> <span class="bound">xa</span> <span class="main">∧</span> <span class="free">memb</span> <span class="bound">xa</span> <span class="main">(</span><span class="free">ins</span> <span class="skolem">x</span> <span class="skolem">S</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">xb</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> image_eqI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> ins_eq<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="comment1">(* by (auto simp add: reachable_def ins_eq set_of_def cong: conj_cong) *)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reachable_def<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> dfs_imp_reachable<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">isNode</span> <span class="free">y</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> xs<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="free">isNode</span> <span class="free">xs</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">memb</span> <span class="free">y</span> <span class="main">(</span>dfs <span class="free">empt</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y'</span><span class="main">.</span> <span class="free">nodeAbs</span> <span class="bound">y'</span> <span class="main">=</span> <span class="free">nodeAbs</span> <span class="free">y</span> <span class="main">∧</span> <span class="bound">y'</span> <span class="main">∈</span> reachable <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> m dfs_subset_reachable_visit_nodes <span class="main">[</span><span class="operator">OF</span> empt_invariant xs<span class="main">]</span> y
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y'</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">nodeAbs</span> <span class="skolem">y'</span> <span class="main">=</span> <span class="free">nodeAbs</span> <span class="free">y</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y'</span> <span class="main">∈</span> reachable <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> empt set_of_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

We make use of two results about the traversal. Firstly, that some
representation of each reachable node has been incorporated into the
final construction:

›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> DFS<span class="main">)</span> reachable_imp_dfs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">isNode</span> <span class="free">y</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> xs<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="free">isNode</span> <span class="free">xs</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> reachable <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y'</span><span class="main">.</span> <span class="free">nodeAbs</span> <span class="bound">y'</span> <span class="main">=</span> <span class="free">nodeAbs</span> <span class="free">y</span> <span class="main">∧</span> <span class="free">memb</span> <span class="bound">y'</span> <span class="main">(</span>dfs <span class="free">empt</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="comment1">(*&lt;*)</span>
  <span class="keyword1"><span class="command">using</span></span> y m reachable_closed_dfs<span class="main">[</span><span class="operator">OF</span> xs<span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_of_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> subsetD<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> c<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">nodeAbs</span></span> <span class="free"><span class="free">y</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">theorem</span></span> dfs_invariant' <span class="main">[</span><span class="operator">consumes</span> 2<span class="main">,</span> <span class="operator">case_names</span> base step<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">invariant</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> xs<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="free">isNode</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">S</span> <span class="bound">x</span><span class="main">.</span> <span class="main">¬</span> <span class="free">memb</span> <span class="bound">x</span> <span class="bound">S</span> <span class="main">⟹</span> <span class="free">isNode</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">invariant</span> <span class="bound">S</span> <span class="main">⟹</span> <span class="free">I</span> <span class="bound">S</span> <span class="main">⟹</span> <span class="free">I</span> <span class="main">(</span><span class="free">ins</span> <span class="bound">x</span> <span class="bound">S</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">(</span>dfs <span class="free">S</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> S xs H
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">(</span>dfs <span class="free">S</span> <span class="free">xs</span><span class="main">)</span> <span class="main">∧</span> <span class="free">invariant</span> <span class="main">(</span>dfs <span class="free">S</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> dfs_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">S</span> <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">memb</span> <span class="skolem">x</span> <span class="skolem">S</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> step<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> I<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> step<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> step<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context DFS *)</span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

Secondly, that if an invariant holds on the initial object then it
holds on the final one:

›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> DFS<span class="main">)</span> dfs_invariant<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">invariant</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_all <span class="free">isNode</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">invariant</span> <span class="main">(</span>dfs <span class="free">S</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="comment1">(*&lt;*)</span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> dfs_induct<span class="main">)</span> <span class="operator">auto</span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

\FloatBarrier

›</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="MapOps">
<div class="head">
<h1>Theory MapOps</h1>
</div>
<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="comment1">(*
 * Knowledge-based programs.
 * (C)opyright 2011, Peter Gammie, peteg42 at gmail.com.
 * License: BSD
 *)</span>

<span class="keyword1"><span class="command">theory</span></span> MapOps
<span class="keyword2"><span class="keyword">imports</span></span> <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Finite map operations›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

\label{sec:kbps-theory-map-ops}

The algorithm represents an automaton as a pair of maps, which we
capture abstractly with a record and a predicate:

›</span></span>

<span class="keyword1"><span class="command">record</span></span> <span class="main">(</span><span class="tfree">'m</span><span class="main">,</span> <span class="tfree">'k</span><span class="main">,</span> <span class="tfree">'e</span><span class="main">)</span> MapOps <span class="main">=</span>
  empty <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'m</span>"</span></span>
  lookup <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'m</span> <span class="main">⇒</span> <span class="tfree">'k</span> <span class="main">⇀</span> <span class="tfree">'e</span>"</span></span>
  update <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'k</span> <span class="main">⇒</span> <span class="tfree">'e</span> <span class="main">⇒</span> <span class="tfree">'m</span> <span class="main">⇒</span> <span class="tfree">'m</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">MapOps</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'k</span> <span class="main">⇒</span> <span class="tfree">'kabs</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'kabs</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'m</span><span class="main">,</span> <span class="tfree">'k</span><span class="main">,</span> <span class="tfree">'e</span><span class="main">)</span> MapOps <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">MapOps</span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">ops</span></span></span> <span class="main">≡</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="bound">k</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">⟶</span> lookup <span class="free"><span class="bound"><span class="entity">ops</span></span></span> <span class="main">(</span>empty <span class="free"><span class="bound"><span class="entity">ops</span></span></span><span class="main">)</span> <span class="bound">k</span> <span class="main">=</span> None<span class="main">)</span>
    <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">e</span> <span class="bound">k</span> <span class="bound">k'</span> <span class="bound">M</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="bound">k</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="bound">k'</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span>
        <span class="main">⟶</span> lookup <span class="free"><span class="bound"><span class="entity">ops</span></span></span> <span class="main">(</span>update <span class="free"><span class="bound"><span class="entity">ops</span></span></span> <span class="bound">k</span> <span class="bound">e</span> <span class="bound">M</span><span class="main">)</span> <span class="bound">k'</span>
          <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="bound">k'</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="bound">k</span> <span class="keyword1">then</span> Some <span class="bound">e</span> <span class="keyword1">else</span> lookup <span class="free"><span class="bound"><span class="entity">ops</span></span></span> <span class="bound">M</span> <span class="bound">k'</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1" id="MapOps-MapOpsI"><span class="command">lemma</span></span> MapOpsI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">k</span><span class="main">.</span> <span class="free">α</span> <span class="bound">k</span> <span class="main">∈</span> <span class="free">d</span> <span class="main">⟹</span> lookup <span class="free">ops</span> <span class="main">(</span>empty <span class="free">ops</span><span class="main">)</span> <span class="bound">k</span> <span class="main">=</span> None<span class="main">;</span>
     <span class="main">⋀</span><span class="bound">e</span> <span class="bound">k</span> <span class="bound">k'</span> <span class="bound">M</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">α</span> <span class="bound">k</span> <span class="main">∈</span> <span class="free">d</span><span class="main">;</span> <span class="free">α</span> <span class="bound">k'</span> <span class="main">∈</span> <span class="free">d</span> <span class="main">⟧</span> <span class="main">⟹</span>
                 lookup <span class="free">ops</span> <span class="main">(</span>update <span class="free">ops</span> <span class="bound">k</span> <span class="bound">e</span> <span class="bound">M</span><span class="main">)</span> <span class="bound">k'</span>
              <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">α</span> <span class="bound">k'</span> <span class="main">=</span> <span class="free">α</span> <span class="bound">k</span> <span class="keyword1">then</span> Some <span class="bound">e</span> <span class="keyword1">else</span> lookup <span class="free">ops</span> <span class="bound">M</span> <span class="bound">k'</span><span class="main">)</span> <span class="main">⟧</span>
     <span class="main">⟹</span> MapOps <span class="free">α</span> <span class="free">d</span> <span class="free">ops</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> MapOps_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="MapOps-MapOps_emptyD"><span class="command">lemma</span></span> MapOps_emptyD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">α</span> <span class="free">k</span> <span class="main">∈</span> <span class="free">d</span><span class="main">;</span> MapOps <span class="free">α</span> <span class="free">d</span> <span class="free">ops</span> <span class="main">⟧</span> <span class="main">⟹</span> lookup <span class="free">ops</span> <span class="main">(</span>empty <span class="free">ops</span><span class="main">)</span> <span class="free">k</span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> MapOps_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="MapOps-MapOps_lookup_updateD"><span class="command">lemma</span></span> MapOps_lookup_updateD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">α</span> <span class="free">k</span> <span class="main">∈</span> <span class="free">d</span><span class="main">;</span> <span class="free">α</span> <span class="free">k'</span> <span class="main">∈</span> <span class="free">d</span><span class="main">;</span> MapOps <span class="free">α</span> <span class="free">d</span> <span class="free">ops</span> <span class="main">⟧</span> <span class="main">⟹</span> lookup <span class="free">ops</span> <span class="main">(</span>update <span class="free">ops</span> <span class="free">k</span> <span class="free">e</span> <span class="free">M</span><span class="main">)</span> <span class="free">k'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">α</span> <span class="free">k'</span> <span class="main">=</span> <span class="free">α</span> <span class="free">k</span> <span class="keyword1">then</span> Some <span class="free">e</span> <span class="keyword1">else</span> lookup <span class="free">ops</span> <span class="free">M</span> <span class="free">k'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> MapOps_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">α</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> abstracts concrete keys of type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'k</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
and the parameter <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">d</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> specifies the valid abstract keys.

This approach has the advantage over a locale that we can pass records
to functions, while for a locale we would need to pass the three
functions separately (as in the DFS theory of \S\ref{sec:dfs}).

We use the following function to test for membership in the domain of
the map:

›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">isSome</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> option <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">isSome</span> <span class="free"><span class="bound"><span class="entity">opt</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">opt</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> False <span class="main">|</span> Some <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> True"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1" id="MapOps-isSome_simps"><span class="command">lemma</span></span> isSome_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> isSome <span class="main">(</span>Some <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="main">¬</span> isSome <span class="bound">x</span> <span class="main">⟷</span> <span class="bound">x</span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> isSome_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>

<span class="keyword1" id="MapOps-isSome_eq"><span class="command">lemma</span></span> isSome_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"isSome <span class="free">x</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="free">x</span> <span class="main">=</span> Some <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> isSome_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>

<span class="keyword1" id="MapOps-isSomeE"><span class="command">lemma</span></span> isSomeE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> isSome <span class="free">x</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">x</span> <span class="main">=</span> Some <span class="bound">s</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> isSome_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="KBPsAlg">
<div class="head">
<h1>Theory KBPsAlg</h1>
</div>
<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> KBPsAlg
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#KBPsAuto">KBPsAuto</a> <a href="#DFS">DFS</a> <a href="#MapOps">MapOps</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹An algorithm for automata synthesis›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

\label{sec:kbps-alg}

We now show how to construct the automaton defined by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="free">mkAutoSim</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> (\S\ref{sec:kbps-automata-synthesis-alg}) using the DFS
of \S\ref{sec:dfs}.

From here on we assume that the environment consists of only a finite
set of states:

›</span></span>

<span class="keyword1"><span class="command">locale</span></span> FiniteEnvironment <span class="main">=</span>
  Environment <span class="quoted"><span class="free">jkbp</span></span> <span class="quoted"><span class="free">envInit</span></span> <span class="quoted"><span class="free">envAction</span></span> <span class="quoted"><span class="free">envTrans</span></span> <span class="quoted"><span class="free">envVal</span></span> <span class="quoted"><span class="free">envObs</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">jkbp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'aAct</span><span class="main">)</span> JKBP"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">envInit</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">::</span> finite<span class="main">)</span> list"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">envAction</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'eAct</span> list"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">envTrans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'eAct</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'aAct</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">envVal</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">envObs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'obs</span>"</span></span>

<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹
\begin{figure}[p]
\begin{isabellebody}%
›</span></span>
<span class="keyword1"><span class="command">locale</span></span> Algorithm <span class="main">=</span>
  FiniteEnvironment <span class="quoted"><span class="free">jkbp</span></span> <span class="quoted"><span class="free">envInit</span></span> <span class="quoted"><span class="free">envAction</span></span> <span class="quoted"><span class="free">envTrans</span></span> <span class="quoted"><span class="free">envVal</span></span> <span class="quoted"><span class="free">envObs</span></span>
<span class="main">+</span> AlgSimIncrEnvironment <span class="quoted"><span class="free">jkbp</span></span> <span class="quoted"><span class="free">envInit</span></span> <span class="quoted"><span class="free">envAction</span></span> <span class="quoted"><span class="free">envTrans</span></span> <span class="quoted"><span class="free">envVal</span></span> <span class="quoted"><span class="free">jview</span></span> <span class="quoted"><span class="free">envObs</span></span>
               <span class="quoted"><span class="free">jviewInit</span></span> <span class="quoted"><span class="free">jviewIncr</span></span>
               <span class="quoted"><span class="free">simf</span></span> <span class="quoted"><span class="free">simRels</span></span> <span class="quoted"><span class="free">simVal</span></span> <span class="quoted"><span class="free">simAbs</span></span> <span class="quoted"><span class="free">simObs</span></span> <span class="quoted"><span class="free">simInit</span></span> <span class="quoted"><span class="free">simTrans</span></span> <span class="quoted"><span class="free">simAction</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">jkbp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'aAct</span><span class="main">)</span> JKBP"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">envInit</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">::</span> finite<span class="main">)</span> list"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">envAction</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'eAct</span> list"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">envTrans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'eAct</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'aAct</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">envVal</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">jview</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'tobs</span><span class="main">)</span> JointView"</span></span>

    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">envObs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'obs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">jviewInit</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'obs</span><span class="main">,</span> <span class="tfree">'tobs</span><span class="main">)</span> InitialIncrJointView"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">jviewIncr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'obs</span><span class="main">,</span> <span class="tfree">'tobs</span><span class="main">)</span> IncrJointView"</span></span>

    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">simf</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> Trace <span class="main">⇒</span> <span class="tfree">'ss</span> <span class="main">::</span> finite"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">simRels</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'ss</span> Relation"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">simVal</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'ss</span> <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> bool"</span></span>

    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">simAbs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'rep</span> <span class="main">⇒</span> <span class="tfree">'ss</span> set"</span></span>

    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">simObs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'rep</span> <span class="main">⇒</span> <span class="tfree">'obs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">simInit</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'obs</span> <span class="main">⇒</span> <span class="tfree">'rep</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">simTrans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'rep</span> <span class="main">⇒</span> <span class="tfree">'rep</span> list"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">simAction</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'rep</span> <span class="main">⇒</span> <span class="tfree">'aAct</span> list"</span></span>

<span class="main">+</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">aOps</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'ma</span><span class="main">,</span> <span class="tfree">'rep</span><span class="main">,</span> <span class="tfree">'aAct</span> list<span class="main">)</span> MapOps"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">tOps</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'mt</span><span class="main">,</span> <span class="tfree">'rep</span> <span class="main">×</span> <span class="tfree">'obs</span><span class="main">,</span> <span class="tfree">'rep</span><span class="main">)</span> MapOps"</span></span>

  <span class="keyword2"><span class="keyword">assumes</span></span> aOps<span class="main">:</span> <span class="quoted"><span class="quoted">"MapOps <span class="free">simAbs</span> jkbpSEC <span class="free">aOps</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> tOps<span class="main">:</span> <span class="quoted"><span class="quoted">"MapOps <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="free">simAbs</span> <span class="main">(</span>fst <span class="bound">k</span><span class="main">)</span><span class="main">,</span> snd <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>jkbpSEC <span class="main">×</span> UNIV<span class="main">)</span> <span class="free">tOps</span>"</span></span>
<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹
  \end{isabellebody}%
  \caption{The <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Algorithm›</span></span></span></span> locale.}
  \label{fig:kbps-alg-alg-locale}
\end{figure}
›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> Algorithm<span class="main">)</span> <span class="quoted"><span class="plain_text">‹

The <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Algorithm"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> locale, shown in
Figure~\ref{fig:kbps-alg-alg-locale}, also extends the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>
<span class="quoted"><span class="quoted">"AlgSimIncrEnvironment"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> locale with a pair of finite map operations:
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">aOps</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is used to map automata states to lists of actions, and
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">tOps</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> handles simulated transitions. In both cases the maps
are only required to work on the abstract domain of simulated
canonical traces. Note also that the space of simulated equivalence
classes of type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'ss</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> must be finite, but there is no
restriction on the representation type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'rep</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

We develop the algorithm for a single, fixed agent, which requires us
to define a new locale <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">AlgorithmForAgent</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> that extends <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Algorithm›</span></span></span></span> with an extra parameter designating the agent:

›</span></span>

<span class="keyword1"><span class="command">locale</span></span> AlgorithmForAgent <span class="main">=</span>
  Algorithm <span class="quoted"><span class="free">jkbp</span></span> <span class="quoted"><span class="free">envInit</span></span> <span class="quoted"><span class="free">envAction</span></span> <span class="quoted"><span class="free">envTrans</span></span> <span class="quoted"><span class="free">envVal</span></span> <span class="quoted"><span class="free">jview</span></span> <span class="quoted"><span class="free">envObs</span></span>
            <span class="quoted"><span class="free">jviewInit</span></span> <span class="quoted"><span class="free">jviewIncr</span></span>
            <span class="quoted"><span class="free">simf</span></span> <span class="quoted"><span class="free">simRels</span></span> <span class="quoted"><span class="free">simVal</span></span> <span class="quoted"><span class="free">simAbs</span></span> <span class="quoted"><span class="free">simObs</span></span> <span class="quoted"><span class="free">simInit</span></span> <span class="quoted"><span class="free">simTrans</span></span> <span class="quoted"><span class="free">simAction</span></span>
            <span class="quoted"><span class="free">aOps</span></span> <span class="quoted"><span class="free">tOps</span></span><span class="comment1">(*&lt;*)</span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">jkbp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'aAct</span><span class="main">)</span> JKBP"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">envInit</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">::</span> finite<span class="main">)</span> list"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">envAction</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'eAct</span> list"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">envTrans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'eAct</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'aAct</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">envVal</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">jview</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'tobs</span><span class="main">)</span> JointView"</span></span>

    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">envObs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'obs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">jviewInit</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'obs</span><span class="main">,</span> <span class="tfree">'tobs</span><span class="main">)</span> InitialIncrJointView"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">jviewIncr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'obs</span><span class="main">,</span> <span class="tfree">'tobs</span><span class="main">)</span> IncrJointView"</span></span>

    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">simf</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> Trace <span class="main">⇒</span> <span class="tfree">'ss</span> <span class="main">::</span> finite"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">simRels</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'ss</span> Relation"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">simVal</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'ss</span> <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> bool"</span></span>

    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">simAbs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'rep</span> <span class="main">⇒</span> <span class="tfree">'ss</span> set"</span></span>

    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">simObs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'rep</span> <span class="main">⇒</span> <span class="tfree">'obs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">simInit</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'obs</span> <span class="main">⇒</span> <span class="tfree">'rep</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">simTrans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'rep</span> <span class="main">⇒</span> <span class="tfree">'rep</span> list"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">simAction</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'rep</span> <span class="main">⇒</span> <span class="tfree">'aAct</span> list"</span></span>

    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">aOps</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'ma</span><span class="main">,</span> <span class="tfree">'rep</span><span class="main">,</span> <span class="tfree">'aAct</span> list<span class="main">)</span> MapOps"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">tOps</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'mt</span><span class="main">,</span> <span class="tfree">'rep</span> <span class="main">×</span> <span class="tfree">'obs</span><span class="main">,</span> <span class="tfree">'rep</span><span class="main">)</span> MapOps"</span></span>
<span class="comment1">(*&gt;*)</span>

  <span class="comment1">― ‹...›</span>
<span class="main">+</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span>"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹DFS operations›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

We represent the automaton under construction using a record:

›</span></span>

<span class="keyword1"><span class="command">record</span></span> <span class="main">(</span><span class="tfree">'ma</span><span class="main">,</span> <span class="tfree">'mt</span><span class="main">)</span> AlgState <span class="main">=</span>
  aActs <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'ma</span>"</span></span>
  aTrans <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'mt</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span> AlgorithmForAgent
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

We instantiate the DFS theory with the following functions.

A node is an equivalence class of represented simulated traces.

›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">k_isNode</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'rep</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">k_isNode</span> <span class="free"><span class="bound"><span class="entity">ec</span></span></span> <span class="main">≡</span> <span class="free">simAbs</span> <span class="free"><span class="bound"><span class="entity">ec</span></span></span> <span class="main">∈</span> sim_equiv_class <span class="free">a</span> <span class="main">`</span> jkbpC"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The successors of a node are those produced by the simulated
transition function.

›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">k_succs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'rep</span> <span class="main">⇒</span> <span class="tfree">'rep</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">k_succs</span> <span class="main">≡</span> <span class="free">simTrans</span> <span class="free">a</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The initial automaton has no transitions and no actions.

›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">k_empt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'ma</span><span class="main">,</span> <span class="tfree">'mt</span><span class="main">)</span> AlgState"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">k_empt</span> <span class="main">≡</span> <span class="main">⦇</span> aActs <span class="main">=</span> empty <span class="free">aOps</span><span class="main">,</span> aTrans <span class="main">=</span> empty <span class="free">tOps</span> <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

We use the domain of the action map to track the set of nodes the DFS
has visited.

›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">k_memb</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'rep</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'ma</span><span class="main">,</span> <span class="tfree">'mt</span><span class="main">)</span> AlgState <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">k_memb</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> isSome <span class="main">(</span>lookup <span class="free">aOps</span> <span class="main">(</span>aActs <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

We integrate a new equivalence class into the automaton by updating
the action and transition maps:

›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">actsUpdate</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'rep</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'ma</span><span class="main">,</span> <span class="tfree">'mt</span><span class="main">)</span> AlgState <span class="main">⇒</span> <span class="tfree">'ma</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">actsUpdate</span> <span class="free"><span class="bound"><span class="entity">ec</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> update <span class="free">aOps</span> <span class="free"><span class="bound"><span class="entity">ec</span></span></span> <span class="main">(</span><span class="free">simAction</span> <span class="free">a</span> <span class="free"><span class="bound"><span class="entity">ec</span></span></span><span class="main">)</span> <span class="main">(</span>aActs <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">transUpdate</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'rep</span> <span class="main">⇒</span> <span class="tfree">'rep</span> <span class="main">⇒</span> <span class="tfree">'mt</span> <span class="main">⇒</span> <span class="tfree">'mt</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">transUpdate</span> <span class="free"><span class="bound"><span class="entity">ec</span></span></span> <span class="free"><span class="bound"><span class="entity">ec'</span></span></span> <span class="free"><span class="bound"><span class="entity">at</span></span></span> <span class="main">≡</span> update <span class="free">tOps</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ec</span></span></span><span class="main">,</span> <span class="free">simObs</span> <span class="free">a</span> <span class="free"><span class="bound"><span class="entity">ec'</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ec'</span></span></span> <span class="free"><span class="bound"><span class="entity">at</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">k_ins</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'rep</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'ma</span><span class="main">,</span> <span class="tfree">'mt</span><span class="main">)</span> AlgState <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'ma</span><span class="main">,</span> <span class="tfree">'mt</span><span class="main">)</span> AlgState"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">k_ins</span> <span class="free"><span class="bound"><span class="entity">ec</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> <span class="main">⦇</span> aActs <span class="main">=</span> actsUpdate <span class="free"><span class="bound"><span class="entity">ec</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span>
                   aTrans <span class="main">=</span> foldr <span class="main">(</span>transUpdate <span class="free"><span class="bound"><span class="entity">ec</span></span></span><span class="main">)</span> <span class="main">(</span>k_succs <span class="free"><span class="bound"><span class="entity">ec</span></span></span><span class="main">)</span> <span class="main">(</span>aTrans <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The required properties are straightforward to show.

›</span></span>

<span class="comment1">(*&lt;*)</span>

<span class="keyword1" id="KBPsAlg-k_isNode_cong"><span class="command">lemma</span></span> k_isNode_cong<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">simAbs</span> <span class="free">ec'</span> <span class="main">=</span> <span class="free">simAbs</span> <span class="free">ec</span> <span class="main">⟹</span> k_isNode <span class="free">ec'</span> <span class="main">⟷</span> k_isNode <span class="free">ec</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> k_isNode_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="KBPsAlg-alg_MapOps_empty"><span class="command">lemma</span></span> alg_MapOps_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"k_isNode <span class="free">ec</span> <span class="main">⟹</span> lookup <span class="free">aOps</span> <span class="main">(</span>empty <span class="free">aOps</span><span class="main">)</span> <span class="free">ec</span> <span class="main">=</span> None"</span></span>
  <span class="quoted"><span class="quoted">"k_isNode <span class="main">(</span>fst <span class="free">k</span><span class="main">)</span> <span class="main">⟹</span> lookup <span class="free">tOps</span> <span class="main">(</span>empty <span class="free">tOps</span><span class="main">)</span> <span class="free">k</span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> k_isNode_def
  <span class="keyword1"><span class="command">using</span></span> MapOps_emptyD<span class="main">[</span><span class="operator">OF</span> _ aOps<span class="main">]</span> MapOps_emptyD<span class="main">[</span><span class="operator">OF</span> _ tOps<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="KBPsAlg-alg_aOps_lookup_update"><span class="command">lemma</span></span> alg_aOps_lookup_update<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> k_isNode <span class="free">ec</span><span class="main">;</span> k_isNode <span class="free">ec'</span> <span class="main">⟧</span> <span class="main">⟹</span> lookup <span class="free">aOps</span> <span class="main">(</span>update <span class="free">aOps</span> <span class="free">ec</span> <span class="free">e</span> <span class="free">M</span><span class="main">)</span> <span class="free">ec'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">simAbs</span> <span class="free">ec'</span> <span class="main">=</span> <span class="free">simAbs</span> <span class="free">ec</span> <span class="keyword1">then</span> Some <span class="free">e</span> <span class="keyword1">else</span> lookup <span class="free">aOps</span> <span class="free">M</span> <span class="free">ec'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> k_isNode_def
  <span class="keyword1"><span class="command">using</span></span> MapOps_lookup_updateD<span class="main">[</span><span class="operator">OF</span> _ _ aOps<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="KBPsAlg-alg_tOps_lookup_update"><span class="command">lemma</span></span> alg_tOps_lookup_update<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> k_isNode <span class="main">(</span>fst <span class="free">k</span><span class="main">)</span><span class="main">;</span> k_isNode <span class="main">(</span>fst <span class="free">k'</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> lookup <span class="free">tOps</span> <span class="main">(</span>update <span class="free">tOps</span> <span class="free">k</span> <span class="free">e</span> <span class="free">M</span><span class="main">)</span> <span class="free">k'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="free">simAbs</span> <span class="main">(</span>fst <span class="free">k'</span><span class="main">)</span><span class="main">,</span> snd <span class="free">k'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">simAbs</span> <span class="main">(</span>fst <span class="free">k</span><span class="main">)</span><span class="main">,</span> snd <span class="free">k</span><span class="main">)</span> <span class="keyword1">then</span> Some <span class="free">e</span> <span class="keyword1">else</span> lookup <span class="free">tOps</span> <span class="free">M</span> <span class="free">k'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> k_isNode_def
  <span class="keyword1"><span class="command">using</span></span> MapOps_lookup_updateD<span class="main">[</span><span class="operator">OF</span> _ _ tOps<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="KBPsAlg-k_succs_is_node"><span class="command">lemma</span></span> k_succs_is_node<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"k_isNode <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"list_all k_isNode <span class="main">(</span>k_succs <span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> x <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> tC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> jkbpC"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> sx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">simAbs</span> <span class="free">x</span> <span class="main">=</span> sim_equiv_class <span class="free">a</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> k_isNode_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="main">(</span>k_succs <span class="free">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">simAbs</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">simAbs</span> <span class="main">`</span> set <span class="main">(</span>k_succs <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> simTrans<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> t<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">t</span></span><span class="main">]</span> tC sx
    <span class="keyword1"><span class="command">unfolding</span></span> k_isNode_def <span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> F<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="KBPsAlg-k_memb_empt"><span class="command">lemma</span></span> k_memb_empt<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"k_isNode <span class="free">x</span> <span class="main">⟹</span> <span class="main">¬</span>k_memb <span class="free">x</span> k_empt"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> k_memb_def k_empt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Algorithm invariant›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The invariant for the automata construction is straightforward, viz
that at each step of the process the state represents an automaton
that concords with <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"mkAutoSim"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> on the visited equivalence
classes. We also need to know that the state has preserved the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>
<span class="quoted"><span class="quoted">"MapOps"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> invariants.

›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">k_invariant</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'ma</span><span class="main">,</span> <span class="tfree">'mt</span><span class="main">)</span> AlgState <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">k_invariant</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">ec</span> <span class="bound">ec'</span><span class="main">.</span> k_isNode <span class="bound">ec</span> <span class="main">∧</span> k_isNode <span class="bound">ec'</span> <span class="main">∧</span> <span class="free">simAbs</span> <span class="bound">ec'</span> <span class="main">=</span> <span class="free">simAbs</span> <span class="bound">ec</span>
        <span class="main">⟶</span> lookup <span class="free">aOps</span> <span class="main">(</span>aActs <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="bound">ec</span> <span class="main">=</span> lookup <span class="free">aOps</span> <span class="main">(</span>aActs <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="bound">ec'</span><span class="main">)</span>
    <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">ec</span> <span class="bound">ec'</span> <span class="bound">obs</span><span class="main">.</span> k_isNode <span class="bound">ec</span> <span class="main">∧</span> k_isNode <span class="bound">ec'</span> <span class="main">∧</span> <span class="free">simAbs</span> <span class="bound">ec'</span> <span class="main">=</span> <span class="free">simAbs</span> <span class="bound">ec</span>
        <span class="main">⟶</span> lookup <span class="free">tOps</span> <span class="main">(</span>aTrans <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">(</span><span class="bound">ec</span><span class="main">,</span> <span class="bound">obs</span><span class="main">)</span> <span class="main">=</span> lookup <span class="free">tOps</span> <span class="main">(</span>aTrans <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">(</span><span class="bound">ec'</span><span class="main">,</span> <span class="bound">obs</span><span class="main">)</span><span class="main">)</span>
    <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">ec</span><span class="main">.</span> k_isNode <span class="bound">ec</span> <span class="main">∧</span> k_memb <span class="bound">ec</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span>
        <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">acts</span><span class="main">.</span> lookup <span class="free">aOps</span> <span class="main">(</span>aActs <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="bound">ec</span> <span class="main">=</span> Some <span class="bound">acts</span>
                   <span class="main">∧</span> set <span class="bound">acts</span> <span class="main">=</span> set <span class="main">(</span><span class="free">simAction</span> <span class="free">a</span> <span class="bound">ec</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">ec</span> <span class="bound">obs</span><span class="main">.</span> k_isNode <span class="bound">ec</span> <span class="main">∧</span> k_memb <span class="bound">ec</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span>
              <span class="main">∧</span> <span class="bound">obs</span> <span class="main">∈</span> <span class="free">simObs</span> <span class="free">a</span> <span class="main">`</span> set <span class="main">(</span><span class="free">simTrans</span> <span class="free">a</span> <span class="bound">ec</span><span class="main">)</span>
        <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">ec'</span><span class="main">.</span> lookup <span class="free">tOps</span> <span class="main">(</span>aTrans <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">(</span><span class="bound">ec</span><span class="main">,</span> <span class="bound">obs</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">ec'</span>
                  <span class="main">∧</span> <span class="free">simAbs</span> <span class="bound">ec'</span> <span class="main">∈</span> <span class="free">simAbs</span> <span class="main">`</span> set <span class="main">(</span><span class="free">simTrans</span> <span class="free">a</span> <span class="bound">ec</span><span class="main">)</span>
                  <span class="main">∧</span> <span class="free">simObs</span> <span class="free">a</span> <span class="bound">ec'</span> <span class="main">=</span> <span class="bound">obs</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1" id="KBPsAlg-k_invariantI"><span class="command">lemma</span></span> k_invariantI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">ec</span> <span class="bound">ec'</span><span class="main">.</span> <span class="main">⟦</span> k_isNode <span class="bound">ec</span><span class="main">;</span> k_isNode <span class="bound">ec'</span><span class="main">;</span> <span class="free">simAbs</span> <span class="bound">ec'</span> <span class="main">=</span> <span class="free">simAbs</span> <span class="bound">ec</span> <span class="main">⟧</span>
       <span class="main">⟹</span> lookup <span class="free">aOps</span> <span class="main">(</span>aActs <span class="free">A</span><span class="main">)</span> <span class="bound">ec</span> <span class="main">=</span> lookup <span class="free">aOps</span> <span class="main">(</span>aActs <span class="free">A</span><span class="main">)</span> <span class="bound">ec'</span><span class="main">;</span>
     <span class="main">⋀</span><span class="bound">ec</span> <span class="bound">ec'</span> <span class="bound">obs</span><span class="main">.</span> <span class="main">⟦</span> k_isNode <span class="bound">ec</span><span class="main">;</span> k_isNode <span class="bound">ec'</span><span class="main">;</span> <span class="free">simAbs</span> <span class="bound">ec'</span> <span class="main">=</span> <span class="free">simAbs</span> <span class="bound">ec</span> <span class="main">⟧</span>
       <span class="main">⟹</span> lookup <span class="free">tOps</span> <span class="main">(</span>aTrans <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="bound">ec</span><span class="main">,</span> <span class="bound">obs</span><span class="main">)</span> <span class="main">=</span> lookup <span class="free">tOps</span> <span class="main">(</span>aTrans <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="bound">ec'</span><span class="main">,</span> <span class="bound">obs</span><span class="main">)</span><span class="main">;</span>
     <span class="main">⋀</span><span class="bound">ec</span><span class="main">.</span> <span class="main">⟦</span> k_isNode <span class="bound">ec</span><span class="main">;</span> k_memb <span class="bound">ec</span> <span class="free">A</span> <span class="main">⟧</span>
       <span class="main">⟹</span> <span class="main">∃</span><span class="bound">acts</span><span class="main">.</span> lookup <span class="free">aOps</span> <span class="main">(</span>aActs <span class="free">A</span><span class="main">)</span> <span class="bound">ec</span> <span class="main">=</span> Some <span class="bound">acts</span> <span class="main">∧</span> set <span class="bound">acts</span> <span class="main">=</span> set <span class="main">(</span><span class="free">simAction</span> <span class="free">a</span> <span class="bound">ec</span><span class="main">)</span><span class="main">;</span>
     <span class="main">⋀</span><span class="bound">ec</span> <span class="bound">obs</span> <span class="bound">ecs'</span><span class="main">.</span> <span class="main">⟦</span> k_isNode <span class="bound">ec</span><span class="main">;</span> k_memb <span class="bound">ec</span> <span class="free">A</span><span class="main">;</span> <span class="bound">obs</span> <span class="main">∈</span> <span class="free">simObs</span> <span class="free">a</span> <span class="main">`</span> set <span class="main">(</span><span class="free">simTrans</span> <span class="free">a</span> <span class="bound">ec</span><span class="main">)</span> <span class="main">⟧</span>
       <span class="main">⟹</span> <span class="main">∃</span><span class="bound">ec'</span><span class="main">.</span> lookup <span class="free">tOps</span> <span class="main">(</span>aTrans <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="bound">ec</span><span class="main">,</span> <span class="bound">obs</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">ec'</span>
               <span class="main">∧</span> <span class="free">simAbs</span> <span class="bound">ec'</span> <span class="main">∈</span> <span class="free">simAbs</span> <span class="main">`</span> set <span class="main">(</span><span class="free">simTrans</span> <span class="free">a</span> <span class="bound">ec</span><span class="main">)</span>
               <span class="main">∧</span> <span class="free">simObs</span> <span class="free">a</span> <span class="bound">ec'</span> <span class="main">=</span> <span class="bound">obs</span> <span class="main">⟧</span>
  <span class="main">⟹</span> k_invariant <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> k_invariant_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_simp</span><span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="KBPsAlg-k_invariantAOD"><span class="command">lemma</span></span> k_invariantAOD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> k_isNode <span class="free">ec</span><span class="main">;</span> k_isNode <span class="free">ec'</span><span class="main">;</span> <span class="free">simAbs</span> <span class="free">ec'</span> <span class="main">=</span> <span class="free">simAbs</span> <span class="free">ec</span><span class="main">;</span> k_invariant <span class="free">A</span> <span class="main">⟧</span>
     <span class="main">⟹</span> lookup <span class="free">aOps</span> <span class="main">(</span>aActs <span class="free">A</span><span class="main">)</span> <span class="free">ec</span> <span class="main">=</span> lookup <span class="free">aOps</span> <span class="main">(</span>aActs <span class="free">A</span><span class="main">)</span> <span class="free">ec'</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> k_invariant_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="KBPsAlg-k_invariantTOD"><span class="command">lemma</span></span> k_invariantTOD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> k_isNode <span class="free">ec</span><span class="main">;</span> k_isNode <span class="free">ec'</span><span class="main">;</span> <span class="free">simAbs</span> <span class="free">ec'</span> <span class="main">=</span> <span class="free">simAbs</span> <span class="free">ec</span><span class="main">;</span> k_invariant <span class="free">A</span> <span class="main">⟧</span>
     <span class="main">⟹</span> lookup <span class="free">tOps</span> <span class="main">(</span>aTrans <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="free">ec</span><span class="main">,</span> <span class="free">obs</span><span class="main">)</span> <span class="main">=</span> lookup <span class="free">tOps</span> <span class="main">(</span>aTrans <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="free">ec'</span><span class="main">,</span> <span class="free">obs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> k_invariant_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="KBPsAlg-k_invariantAD"><span class="command">lemma</span></span> k_invariantAD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> k_isNode <span class="free">ec</span><span class="main">;</span> k_memb <span class="free">ec</span> <span class="free">A</span><span class="main">;</span> k_invariant <span class="free">A</span> <span class="main">⟧</span>
     <span class="main">⟹</span> <span class="main">∃</span><span class="bound">acts</span><span class="main">.</span> lookup <span class="free">aOps</span> <span class="main">(</span>aActs <span class="free">A</span><span class="main">)</span> <span class="free">ec</span> <span class="main">=</span> Some <span class="bound">acts</span> <span class="main">∧</span> set <span class="bound">acts</span> <span class="main">=</span> set <span class="main">(</span><span class="free">simAction</span> <span class="free">a</span> <span class="free">ec</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> k_invariant_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="KBPsAlg-k_invariantTD"><span class="command">lemma</span></span> k_invariantTD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> k_isNode <span class="free">ec</span><span class="main">;</span> k_memb <span class="free">ec</span> <span class="free">A</span><span class="main">;</span> <span class="free">obs</span> <span class="main">∈</span> <span class="free">simObs</span> <span class="free">a</span> <span class="main">`</span> set <span class="main">(</span><span class="free">simTrans</span> <span class="free">a</span> <span class="free">ec</span><span class="main">)</span><span class="main">;</span> k_invariant <span class="free">A</span> <span class="main">⟧</span>
     <span class="main">⟹</span> <span class="main">∃</span><span class="bound">ec'</span><span class="main">.</span> lookup <span class="free">tOps</span> <span class="main">(</span>aTrans <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="free">ec</span><span class="main">,</span> <span class="free">obs</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">ec'</span>
             <span class="main">∧</span> <span class="free">simAbs</span> <span class="bound">ec'</span> <span class="main">∈</span> <span class="free">simAbs</span> <span class="main">`</span> set <span class="main">(</span><span class="free">simTrans</span> <span class="free">a</span> <span class="free">ec</span><span class="main">)</span>
             <span class="main">∧</span> <span class="free">simObs</span> <span class="free">a</span> <span class="bound">ec'</span> <span class="main">=</span> <span class="free">obs</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> k_invariant_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="KBPsAlg-k_invariant_empt"><span class="command">lemma</span></span> k_invariant_empt<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"k_invariant k_empt"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> k_empt_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="KBPsAlg-k_invariant_step_new_aux"><span class="command">lemma</span></span> k_invariant_step_new_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">X</span> <span class="main">⊆</span> set <span class="main">(</span>k_succs <span class="free">x</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"k_isNode <span class="free">x</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> ec<span class="main">:</span> <span class="quoted"><span class="quoted">"k_isNode <span class="free">ec</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> ec'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">simAbs</span> <span class="free">ec'</span> <span class="main">∈</span> <span class="free">simAbs</span> <span class="main">`</span> set <span class="free">X</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">simAbs</span> <span class="free">ec</span> <span class="main">=</span> <span class="free">simAbs</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">r</span><span class="main">.</span> lookup <span class="free">tOps</span> <span class="main">(</span>foldr <span class="main">(</span>transUpdate <span class="free">x</span><span class="main">)</span> <span class="free">X</span> <span class="free">Y</span><span class="main">)</span> <span class="main">(</span><span class="free">ec</span><span class="main">,</span> <span class="free">simObs</span> <span class="free">a</span> <span class="free">ec'</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">r</span>
           <span class="main">∧</span> <span class="free">simAbs</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free">simAbs</span> <span class="main">`</span> set <span class="main">(</span>k_succs <span class="free">ec</span><span class="main">)</span>
           <span class="main">∧</span> <span class="free">simObs</span> <span class="free">a</span> <span class="bound">r</span> <span class="main">=</span> <span class="free">simObs</span> <span class="free">a</span> <span class="free">ec'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> X ec'
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">X</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Y</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">simAbs</span> <span class="free">ec'</span> <span class="main">=</span> <span class="free">simAbs</span> <span class="skolem">y</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">with</span></span> x ec S Cons <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> transUpdate_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command">unfolding</span></span> k_isNode_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> imageE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cut_tac</span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> t<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">ta</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> ec<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> ec'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">ec</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> simTrans_simAbs_cong<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> Cons <span class="keyword1"><span class="command">have</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">simAbs</span> <span class="skolem">y</span> <span class="main">∈</span> <span class="free">simAbs</span> <span class="main">`</span> set <span class="main">(</span>k_succs <span class="free">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> x <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> tC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> jkbpC"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> x'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">simAbs</span> <span class="free">x</span> <span class="main">=</span> sim_equiv_class <span class="free">a</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> k_isNode_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> F <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="skolem"><span class="skolem">s</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">simAbs</span> <span class="skolem">y</span> <span class="main">=</span> sim_equiv_class <span class="free">a</span> <span class="main">(</span><span class="skolem">t'</span> <span class="main">↝</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> tsC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">↝</span> <span class="skolem">s</span> <span class="main">∈</span> jkbpC"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> tt'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">jview</span> <span class="free">a</span> <span class="skolem">t</span> <span class="main">=</span> <span class="free">jview</span> <span class="free">a</span> <span class="skolem">t'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> simTrans<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> t<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">t</span></span><span class="main">]</span> tC x' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> Cons.hyps<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Y11<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Y</span></span><span class="main">]</span> Cons<span class="main">(</span>2<span class="main">)</span> Cons<span class="main">(</span>3<span class="main">)</span> True S x ec <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> transUpdate_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> simTrans_simAbs_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">t'</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> ec'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">x</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>

       <span class="keyword1"><span class="command">using</span></span> x' tt'
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>

       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>

       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> image_eqI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">y</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">using</span></span> simObs<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> t<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">t'</span><span class="main">↝</span><span class="skolem">s</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="KBPsAlg-k_invariant_step_new"><span class="command">lemma</span></span> k_invariant_step_new<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"k_isNode <span class="free">x</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> ec<span class="main">:</span> <span class="quoted"><span class="quoted">"k_isNode <span class="free">ec</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> ec'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ec'</span> <span class="main">∈</span> set <span class="main">(</span>k_succs <span class="free">ec</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">simAbs</span> <span class="free">ec</span> <span class="main">=</span> <span class="free">simAbs</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ec''</span><span class="main">.</span> lookup <span class="free">tOps</span> <span class="main">(</span>aTrans <span class="main">(</span>k_ins <span class="free">x</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">ec</span><span class="main">,</span> <span class="free">simObs</span> <span class="free">a</span> <span class="free">ec'</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">ec''</span>
              <span class="main">∧</span> <span class="free">simAbs</span> <span class="bound">ec''</span> <span class="main">∈</span> <span class="free">simAbs</span> <span class="main">`</span> set <span class="main">(</span>k_succs <span class="free">ec</span><span class="main">)</span>
              <span class="main">∧</span> <span class="free">simObs</span> <span class="free">a</span> <span class="bound">ec''</span> <span class="main">=</span> <span class="free">simObs</span> <span class="free">a</span> <span class="free">ec'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> x ec'
  <span class="keyword1"><span class="command">have</span></span> ec'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">simAbs</span> <span class="free">ec'</span> <span class="main">∈</span> <span class="free">simAbs</span> <span class="main">`</span> set <span class="main">(</span>k_succs <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> k_isNode_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> simTrans_simAbs_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ S<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> S
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> k_invariant_step_new_aux<span class="main">[</span><span class="operator">OF</span> subset_refl x ec _ S<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ec'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">ec'</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> k_ins_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="KBPsAlg-k_invariant_step_old_aux"><span class="command">lemma</span></span> k_invariant_step_old_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"k_isNode <span class="free">x</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> ec<span class="main">:</span> <span class="quoted"><span class="quoted">"k_isNode <span class="free">ec</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">simAbs</span> <span class="free">ec</span> <span class="main">≠</span> <span class="free">simAbs</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lookup <span class="free">tOps</span> <span class="main">(</span>foldr <span class="main">(</span>transUpdate <span class="free">x</span><span class="main">)</span> <span class="free">X</span> <span class="free">Y</span><span class="main">)</span> <span class="main">(</span><span class="free">ec</span><span class="main">,</span> <span class="free">obs</span><span class="main">)</span>
       <span class="main">=</span> lookup <span class="free">tOps</span> <span class="free">Y</span> <span class="main">(</span><span class="free">ec</span><span class="main">,</span> <span class="free">obs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">X</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">z</span> <span class="skolem">zs</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> x ec S <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"lookup <span class="free">tOps</span> <span class="free">Y</span> <span class="main">(</span><span class="free">ec</span><span class="main">,</span> <span class="free">obs</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> transUpdate_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="KBPsAlg-k_invariant_step_old"><span class="command">lemma</span></span> k_invariant_step_old<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"k_isNode <span class="free">x</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> ec<span class="main">:</span> <span class="quoted"><span class="quoted">"k_isNode <span class="free">ec</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">simAbs</span> <span class="free">ec</span> <span class="main">≠</span> <span class="free">simAbs</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lookup <span class="free">tOps</span> <span class="main">(</span>aTrans <span class="main">(</span>k_ins <span class="free">x</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">ec</span><span class="main">,</span> <span class="free">obs</span><span class="main">)</span>
       <span class="main">=</span> lookup <span class="free">tOps</span> <span class="main">(</span>aTrans <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="free">ec</span><span class="main">,</span> <span class="free">obs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> k_ins_def
  <span class="keyword1"><span class="command">using</span></span> k_invariant_step_old_aux<span class="main">[</span><span class="operator">OF</span> x ec S<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="KBPsAlg-k_invariant_frame"><span class="command">lemma</span></span> k_invariant_frame<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"lookup <span class="free">tOps</span> <span class="free">Y</span> <span class="main">(</span><span class="free">ec</span><span class="main">,</span> <span class="free">obs</span><span class="main">)</span> <span class="main">=</span> lookup <span class="free">tOps</span> <span class="free">Y</span> <span class="main">(</span><span class="free">ec'</span><span class="main">,</span> <span class="free">obs</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"k_isNode <span class="free">x</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> ec<span class="main">:</span> <span class="quoted"><span class="quoted">"k_isNode <span class="free">ec</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> ec'<span class="main">:</span> <span class="quoted"><span class="quoted">"k_isNode <span class="free">ec'</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">simAbs</span> <span class="free">ec'</span> <span class="main">=</span> <span class="free">simAbs</span> <span class="free">ec</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lookup <span class="free">tOps</span> <span class="main">(</span>foldr <span class="main">(</span>transUpdate <span class="free">x</span><span class="main">)</span> <span class="free">X</span> <span class="free">Y</span><span class="main">)</span> <span class="main">(</span><span class="free">ec</span><span class="main">,</span> <span class="free">obs</span><span class="main">)</span> <span class="main">=</span> lookup <span class="free">tOps</span> <span class="main">(</span>foldr <span class="main">(</span>transUpdate <span class="free">x</span><span class="main">)</span> <span class="free">X</span> <span class="free">Y</span><span class="main">)</span> <span class="main">(</span><span class="free">ec'</span><span class="main">,</span> <span class="free">obs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">X</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> transUpdate_def
   <span class="keyword1"><span class="command">using</span></span> B
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">using</span></span> x ec ec' S
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="KBPsAlg-k_invariant_step"><span class="command">lemma</span></span> k_invariant_step<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> N<span class="main">:</span> <span class="quoted"><span class="quoted">"k_isNode <span class="free">x</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"k_invariant <span class="free">A</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> k_memb <span class="free">x</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"k_invariant <span class="main">(</span>k_ins <span class="free">x</span> <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ec</span> <span class="skolem">ec'</span>
  <span class="keyword3"><span class="command">assume</span></span> ec<span class="main">:</span> <span class="quoted"><span class="quoted">"k_isNode <span class="skolem">ec</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ec'<span class="main">:</span> <span class="quoted"><span class="quoted">"k_isNode <span class="skolem">ec'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">simAbs</span> <span class="skolem">ec'</span> <span class="main">=</span> <span class="free">simAbs</span> <span class="skolem">ec</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> N <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lookup <span class="free">aOps</span> <span class="main">(</span>aActs <span class="main">(</span>k_ins <span class="free">x</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ec</span> <span class="main">=</span> lookup <span class="free">aOps</span> <span class="main">(</span>aActs <span class="main">(</span>k_ins <span class="free">x</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ec'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> k_ins_def actsUpdate_def
    <span class="keyword1"><span class="command">using</span></span> k_invariantAOD<span class="main">[</span><span class="operator">OF</span> ec ec' X I<span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ec</span> <span class="skolem">ec'</span> <span class="skolem">obs</span>
  <span class="keyword3"><span class="command">assume</span></span> ec<span class="main">:</span> <span class="quoted"><span class="quoted">"k_isNode <span class="skolem">ec</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ec'<span class="main">:</span> <span class="quoted"><span class="quoted">"k_isNode <span class="skolem">ec'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">simAbs</span> <span class="skolem">ec'</span> <span class="main">=</span> <span class="free">simAbs</span> <span class="skolem">ec</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lookup <span class="free">tOps</span> <span class="main">(</span>aTrans <span class="main">(</span>k_ins <span class="free">x</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ec</span><span class="main">,</span> <span class="skolem">obs</span><span class="main">)</span> <span class="main">=</span> lookup <span class="free">tOps</span> <span class="main">(</span>aTrans <span class="main">(</span>k_ins <span class="free">x</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ec'</span><span class="main">,</span> <span class="skolem">obs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> k_ins_def
    <span class="keyword1"><span class="command">using</span></span> k_invariant_frame<span class="main">[</span><span class="operator">OF</span> k_invariantTOD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ec ec' X I<span class="main"><span class="main">]</span></span> N ec ec' X<span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ec</span> <span class="skolem">obs</span> <span class="skolem">ecs'</span>
  <span class="keyword3"><span class="command">assume</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"k_isNode <span class="skolem">ec</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ec<span class="main">:</span> <span class="quoted"><span class="quoted">"k_memb <span class="skolem">ec</span> <span class="main">(</span>k_ins <span class="free">x</span> <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> obs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">obs</span> <span class="main">∈</span> <span class="free">simObs</span> <span class="free">a</span> <span class="main">`</span> set <span class="main">(</span><span class="free">simTrans</span> <span class="free">a</span> <span class="skolem">ec</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ec'</span><span class="main">.</span> lookup <span class="free">tOps</span> <span class="main">(</span>aTrans <span class="main">(</span>k_ins <span class="free">x</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ec</span><span class="main">,</span> <span class="skolem">obs</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">ec'</span>
            <span class="main">∧</span> <span class="free">simAbs</span> <span class="bound">ec'</span> <span class="main">∈</span> <span class="free">simAbs</span> <span class="main">`</span> set <span class="main">(</span>k_succs <span class="skolem">ec</span><span class="main">)</span>
            <span class="main">∧</span> <span class="free">simObs</span> <span class="free">a</span> <span class="bound">ec'</span> <span class="main">=</span> <span class="skolem">obs</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">simAbs</span> <span class="skolem">ec</span> <span class="main">=</span> <span class="free">simAbs</span> <span class="free">x</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> N n obs <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> k_invariant_step_new <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">with</span></span> I N n ec obs <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> k_invariant_step_old<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> k_invariantTD<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
      <span class="keyword1"><span class="command">unfolding</span></span> k_ins_def k_memb_def actsUpdate_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ec</span>
  <span class="keyword3"><span class="command">assume</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"k_isNode <span class="skolem">ec</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> ec<span class="main">:</span> <span class="quoted"><span class="quoted">"k_memb <span class="skolem">ec</span> <span class="main">(</span>k_ins <span class="free">x</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">acts</span><span class="main">.</span> lookup <span class="free">aOps</span> <span class="main">(</span>aActs <span class="main">(</span>k_ins <span class="free">x</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ec</span> <span class="main">=</span> Some <span class="bound">acts</span> <span class="main">∧</span> set <span class="bound">acts</span> <span class="main">=</span> set <span class="main">(</span><span class="free">simAction</span> <span class="free">a</span> <span class="skolem">ec</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">simAbs</span> <span class="skolem">ec</span> <span class="main">=</span> <span class="free">simAbs</span> <span class="free">x</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> aOps N n <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> k_ins_def actsUpdate_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command">unfolding</span></span> k_isNode_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> jAction_simAbs_cong<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">with</span></span> aOps N I M n ec <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> k_ins_def actsUpdate_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> k_invariantAD<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> k_memb_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

Showing that the invariant holds of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"k_empt"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and is respected
by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"k_ins"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is routine.

The initial frontier is the partition of the set of initial states
under the initial observation function.

›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> Algorithm<span class="main">)</span> <span class="entity">k_frontier</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'rep</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">k_frontier</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≡</span> map <span class="main">(</span><span class="free">simInit</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">∘</span> <span class="free">envObs</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="free">envInit</span>"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1" id="KBPsAlg-k_frontier_is_node"><span class="command">lemma</span></span> k_frontier_is_node<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"list_all k_isNode <span class="main">(</span>k_frontier <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> k_frontier_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> simInit list_all_iff k_isNode_def jviewInit jviewIncr<span class="main">)</span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context AlgorithmForAgent *)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

We now instantiate the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"DFS"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> locale with respect to the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>
<span class="quoted"><span class="quoted">"AlgorithmForAgent"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> locale. The instantiated lemmas are given the
mandatory prefix <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>KBPAlg›</span></span></span></span> in the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"AlgorithmForAgent"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
locale.

›</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> AlgorithmForAgent
        <span class="main">&lt;</span> KBPAlg<span class="main">:</span> DFS <span class="quoted">k_succs</span> <span class="quoted">k_isNode</span> <span class="quoted">k_invariant</span> <span class="quoted">k_ins</span> <span class="quoted">k_memb</span> <span class="quoted">k_empt</span> <span class="quoted"><span class="free">simAbs</span></span>

<span class="comment1">(*&lt;*)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>

  <span class="keyword1"><span class="command">unfolding</span></span> k_memb_def k_ins_def actsUpdate_def
  <span class="keyword1"><span class="command">using</span></span> aOps
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> isSome_eq<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>

  <span class="keyword1"><span class="command">unfolding</span></span> k_isNode_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> simTrans_simAbs_cong<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹
\begin{figure}
\begin{isabellebody}%
›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">alg_dfs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'ma</span><span class="main">,</span> <span class="tfree">'rep</span><span class="main">,</span> <span class="tfree">'aAct</span> list<span class="main">)</span> MapOps
         <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'mt</span><span class="main">,</span> <span class="tfree">'rep</span> <span class="main">×</span> <span class="tfree">'obs</span><span class="main">,</span> <span class="tfree">'rep</span><span class="main">)</span> MapOps
         <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'rep</span> <span class="main">⇒</span> <span class="tfree">'obs</span><span class="main">)</span>
         <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'rep</span> <span class="main">⇒</span> <span class="tfree">'rep</span> list<span class="main">)</span>
         <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'rep</span> <span class="main">⇒</span> <span class="tfree">'aAct</span> list<span class="main">)</span>
         <span class="main">⇒</span> <span class="tfree">'rep</span> list
         <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'ma</span><span class="main">,</span> <span class="tfree">'mt</span><span class="main">)</span> AlgState"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">alg_dfs</span> <span class="free"><span class="bound"><span class="entity">aOps</span></span></span> <span class="free"><span class="bound"><span class="entity">tOps</span></span></span> <span class="free"><span class="bound"><span class="entity">simObs</span></span></span> <span class="free"><span class="bound"><span class="entity">simTrans</span></span></span> <span class="free"><span class="bound"><span class="entity">simAction</span></span></span> <span class="main">≡</span>
    <span class="keyword1">let</span> <span class="bound">k_empt</span> <span class="main">=</span> <span class="main">⦇</span> aActs <span class="main">=</span> empty <span class="free"><span class="bound"><span class="entity">aOps</span></span></span><span class="main">,</span> aTrans <span class="main">=</span> empty <span class="free"><span class="bound"><span class="entity">tOps</span></span></span> <span class="main">⦈</span><span class="main">;</span>
       <span class="bound">k_memb</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">A</span><span class="main">.</span> isSome <span class="main">(</span>lookup <span class="free"><span class="bound"><span class="entity">aOps</span></span></span> <span class="main">(</span>aActs <span class="bound">A</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
       <span class="bound">k_succs</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">simTrans</span></span></span><span class="main">;</span>
       <span class="bound">actsUpdate</span> <span class="main">=</span> <span class="main">λ</span><span class="bound">ec</span> <span class="bound">A</span><span class="main">.</span> update <span class="free"><span class="bound"><span class="entity">aOps</span></span></span> <span class="bound">ec</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">simAction</span></span></span> <span class="bound">ec</span><span class="main">)</span> <span class="main">(</span>aActs <span class="bound">A</span><span class="main">)</span><span class="main">;</span>
       <span class="bound">transUpdate</span> <span class="main">=</span> <span class="main">λ</span><span class="bound">ec</span> <span class="bound">ec'</span> <span class="bound">at</span><span class="main">.</span> update <span class="free"><span class="bound"><span class="entity">tOps</span></span></span> <span class="main">(</span><span class="bound">ec</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">simObs</span></span></span> <span class="bound">ec'</span><span class="main">)</span> <span class="bound">ec'</span> <span class="bound">at</span><span class="main">;</span>
       <span class="bound">k_ins</span> <span class="main">=</span> <span class="main">λ</span><span class="bound">ec</span> <span class="bound">A</span><span class="main">.</span> <span class="main">⦇</span> aActs <span class="main">=</span> <span class="bound">actsUpdate</span> <span class="bound">ec</span> <span class="bound">A</span><span class="main">,</span>
                         aTrans <span class="main">=</span> foldr <span class="main">(</span><span class="bound">transUpdate</span> <span class="bound">ec</span><span class="main">)</span> <span class="main">(</span><span class="bound">k_succs</span> <span class="bound">ec</span><span class="main">)</span> <span class="main">(</span>aTrans <span class="bound">A</span><span class="main">)</span> <span class="main">⦈</span>
     <span class="keyword1">in</span> gen_dfs <span class="bound">k_succs</span> <span class="bound">k_ins</span> <span class="bound">k_memb</span> <span class="bound">k_empt</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">mkAlgAuto</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'ma</span><span class="main">,</span> <span class="tfree">'rep</span><span class="main">,</span> <span class="tfree">'aAct</span> list<span class="main">)</span> MapOps
            <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'mt</span><span class="main">,</span> <span class="tfree">'rep</span> <span class="main">×</span> <span class="tfree">'obs</span><span class="main">,</span> <span class="tfree">'rep</span><span class="main">)</span> MapOps
            <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'rep</span> <span class="main">⇒</span> <span class="tfree">'obs</span><span class="main">)</span>
            <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'obs</span> <span class="main">⇒</span> <span class="tfree">'rep</span><span class="main">)</span>
            <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'rep</span> <span class="main">⇒</span> <span class="tfree">'rep</span> list<span class="main">)</span>
            <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'rep</span> <span class="main">⇒</span> <span class="tfree">'aAct</span> list<span class="main">)</span>
            <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'rep</span> list<span class="main">)</span>
            <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'obs</span><span class="main">,</span> <span class="tfree">'aAct</span><span class="main">,</span> <span class="tfree">'rep</span><span class="main">)</span> JointProtocol"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mkAlgAuto</span> <span class="free"><span class="bound"><span class="entity">aOps</span></span></span> <span class="free"><span class="bound"><span class="entity">tOps</span></span></span> <span class="free"><span class="bound"><span class="entity">simObs</span></span></span> <span class="free"><span class="bound"><span class="entity">simInit</span></span></span> <span class="free"><span class="bound"><span class="entity">simTrans</span></span></span> <span class="free"><span class="bound"><span class="entity">simAction</span></span></span> <span class="free"><span class="bound"><span class="entity">frontier</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">a</span><span class="main">.</span>
    <span class="keyword1">let</span> <span class="bound">auto</span> <span class="main">=</span> alg_dfs <span class="free"><span class="bound"><span class="entity">aOps</span></span></span> <span class="free"><span class="bound"><span class="entity">tOps</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">simObs</span></span></span> <span class="bound">a</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">simTrans</span></span></span> <span class="bound">a</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">simAction</span></span></span> <span class="bound">a</span><span class="main">)</span>
                       <span class="main">(</span><span class="free"><span class="bound"><span class="entity">frontier</span></span></span> <span class="bound">a</span><span class="main">)</span>
     <span class="keyword1">in</span> <span class="main">⦇</span> pInit <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">simInit</span></span></span> <span class="bound">a</span><span class="main">,</span>
          pTrans <span class="main">=</span> <span class="main">λ</span><span class="bound">obs</span> <span class="bound">ec</span><span class="main">.</span> the <span class="main">(</span>lookup <span class="free"><span class="bound"><span class="entity">tOps</span></span></span> <span class="main">(</span>aTrans <span class="bound">auto</span><span class="main">)</span> <span class="main">(</span><span class="bound">ec</span><span class="main">,</span> <span class="bound">obs</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
          pAct <span class="main">=</span> <span class="main">λ</span><span class="bound">ec</span><span class="main">.</span> the <span class="main">(</span>lookup <span class="free"><span class="bound"><span class="entity">aOps</span></span></span> <span class="main">(</span>aActs <span class="bound">auto</span><span class="main">)</span> <span class="bound">ec</span><span class="main">)</span> <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹
  \end{isabellebody}%
  \caption{The algorithm. The function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"the"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> projects a value from the
    <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'a</span></span> option"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> type, diverging on <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"None"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.}
  \label{fig:kbps-alg-algorithm}
\end{figure}
›</span></span>
<span class="comment1">(*&lt;*)</span>
<span class="keyword1" id="KBPsAlg-mkAutoSim_simps"><span class="command">lemma</span></span> mkAutoSim_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"pInit <span class="main">(</span>mkAlgAuto <span class="free">aOps</span> <span class="free">tOps</span> <span class="free">simObs</span> <span class="free">simInit</span> <span class="free">simTrans</span> <span class="free">simAction</span> <span class="free">frontier</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="free">simInit</span> <span class="free">a</span>"</span></span>
  <span class="quoted"><span class="quoted">"pTrans <span class="main">(</span>mkAlgAuto <span class="free">aOps</span> <span class="free">tOps</span> <span class="free">simObs</span> <span class="free">simInit</span> <span class="free">simTrans</span> <span class="free">simAction</span> <span class="free">frontier</span> <span class="free">a</span><span class="main">)</span>
 <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">obs</span> <span class="bound">ec</span><span class="main">.</span> the <span class="main">(</span>lookup <span class="free">tOps</span> <span class="main">(</span>aTrans <span class="main">(</span>alg_dfs <span class="free">aOps</span> <span class="free">tOps</span> <span class="main">(</span><span class="free">simObs</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span><span class="free">simTrans</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span><span class="free">simAction</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span><span class="free">frontier</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="bound">ec</span><span class="main">,</span> <span class="bound">obs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"pAct <span class="main">(</span>mkAlgAuto <span class="free">aOps</span> <span class="free">tOps</span> <span class="free">simObs</span> <span class="free">simInit</span> <span class="free">simTrans</span> <span class="free">simAction</span> <span class="free">frontier</span> <span class="free">a</span><span class="main">)</span>
 <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">ec</span><span class="main">.</span> the <span class="main">(</span>lookup <span class="free">aOps</span> <span class="main">(</span>aActs <span class="main">(</span>alg_dfs <span class="free">aOps</span> <span class="free">tOps</span> <span class="main">(</span><span class="free">simObs</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span><span class="free">simTrans</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span><span class="free">simAction</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span><span class="free">frontier</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">ec</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mkAlgAuto_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">(* Later we want to show that a particular DFS implementation does the
right thing. *)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">alg_mk_auto</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'ma</span><span class="main">,</span> <span class="tfree">'rep</span><span class="main">,</span> <span class="tfree">'aAct</span> list<span class="main">)</span> MapOps
                <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'mt</span><span class="main">,</span> <span class="tfree">'rep</span> <span class="main">×</span> <span class="tfree">'obs</span><span class="main">,</span> <span class="tfree">'rep</span><span class="main">)</span> MapOps
                <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'obs</span> <span class="main">⇒</span> <span class="tfree">'rep</span><span class="main">)</span>
                <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'ma</span><span class="main">,</span> <span class="tfree">'mt</span><span class="main">)</span> AlgState
                <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'obs</span><span class="main">,</span> <span class="tfree">'aAct</span><span class="main">,</span> <span class="tfree">'rep</span><span class="main">)</span> Protocol"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">alg_mk_auto</span> <span class="free"><span class="bound"><span class="entity">aOps</span></span></span> <span class="free"><span class="bound"><span class="entity">tOps</span></span></span> <span class="free"><span class="bound"><span class="entity">simInit</span></span></span> <span class="free"><span class="bound"><span class="entity">k_dfs</span></span></span> <span class="main">≡</span>
    <span class="main">⦇</span> pInit <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">simInit</span></span></span><span class="main">,</span>
      pTrans <span class="main">=</span> <span class="main">λ</span><span class="bound">obs</span> <span class="bound">ec</span><span class="main">.</span> the <span class="main">(</span>lookup <span class="free"><span class="bound"><span class="entity">tOps</span></span></span> <span class="main">(</span>aTrans <span class="free"><span class="bound"><span class="entity">k_dfs</span></span></span><span class="main">)</span> <span class="main">(</span><span class="bound">ec</span><span class="main">,</span> <span class="bound">obs</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
      pAct <span class="main">=</span> <span class="main">λ</span><span class="bound">ec</span><span class="main">.</span> the <span class="main">(</span>lookup <span class="free"><span class="bound"><span class="entity">aOps</span></span></span> <span class="main">(</span>aActs <span class="free"><span class="bound"><span class="entity">k_dfs</span></span></span><span class="main">)</span> <span class="bound">ec</span><span class="main">)</span>
    <span class="main">⦈</span>"</span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">context</span></span> AlgorithmForAgent
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The final algorithm, with the constants inlined, is shown in
Figure~\ref{fig:kbps-alg-algorithm}. The rest of this section shows
its correctness.

Firstly it follows immediately from <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>dfs_invariant›</span></span></span></span> that the
invariant holds of the result of the DFS:

›</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">k_dfs</span> <span class="main">≡</span> KBPsAlg.alg_dfs <span class="free">aOps</span> <span class="free">tOps</span> <span class="main">(</span><span class="free">simObs</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span><span class="free">simTrans</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span><span class="free">simAction</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span>k_frontier <span class="free">a</span><span class="main">)</span>"</span></span>

<span class="comment1">(* This is a syntactic nightmare. *)</span>

<span class="keyword1" id="KBPsAlg-k_dfs_gen_dfs_unfold"><span class="command">lemma</span></span> k_dfs_gen_dfs_unfold<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"k_dfs <span class="main">=</span> gen_dfs k_succs k_ins k_memb k_empt <span class="main">(</span>k_frontier <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> alg_dfs_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fold</span> k_empt_def k_memb_def actsUpdate_def transUpdate_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> k_ins_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1" id="KBPsAlg-k_dfs_invariant"><span class="command">lemma</span></span> k_dfs_invariant<span class="main">:</span> <span class="quoted"><span class="quoted">"k_invariant k_dfs"</span></span>
<span class="comment1">(*&lt;*)</span>
  <span class="keyword1"><span class="command">using</span></span> KBPAlg.dfs_invariant<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"k_empt"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> xs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"k_frontier <span class="free">a</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

Secondly we can see that the set of reachable equivalence classes
coincides with the partition of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"jkbpC"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> under the simulation
and representation functions:

›</span></span>

<span class="keyword1" id="KBPsAlg-k_reachable"><span class="command">lemma</span></span> k_reachable<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">simAbs</span> <span class="main">`</span> KBPAlg.reachable <span class="main">(</span>set <span class="main">(</span>k_frontier <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> sim_equiv_class <span class="free">a</span> <span class="main">`</span> jkbpC"</span></span>
<span class="comment1">(*&lt;*)</span><span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">⊆</span> <span class="var">?rhs</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">sx</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sx</span> <span class="main">∈</span> <span class="var">?lhs</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> KBPAlg.reachable <span class="main">(</span>set <span class="main">(</span>k_frontier <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> sx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">simAbs</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">sx</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">{</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="main">(</span>k_succs <span class="bound">x</span><span class="main">)</span> <span class="main">}</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>
                 <span class="main">``</span> set <span class="main">(</span>map <span class="main">(</span><span class="free">simInit</span> <span class="free">a</span> <span class="main">∘</span> <span class="free">envObs</span> <span class="free">a</span><span class="main">)</span> <span class="free">envInit</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> KBPAlg.reachable_def k_frontier_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">iobs</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">simInit</span> <span class="free">a</span> <span class="skolem">iobs</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="main">{</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="main">(</span>k_succs <span class="bound">x</span><span class="main">)</span><span class="main">}</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> sI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> set <span class="free">envInit</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> iobs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">envObs</span> <span class="free">a</span> <span class="skolem">s</span> <span class="main">=</span> <span class="skolem">iobs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> R x <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">simAbs</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="var">?rhs</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">sx</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rtrancl_induct<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> base
      <span class="keyword1"><span class="command">with</span></span> sI iobs <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> jviewInit simInit<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> sI iobs
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">simAbs</span> <span class="skolem">x</span> <span class="main">∈</span> sim_equiv_class <span class="free">a</span> <span class="main">`</span> jkbpC"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> KBPAlg.reachable_def Image_def k_frontier_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span>
        <span class="keyword2"><span class="keyword">where</span></span> tC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> jkbpC"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">simAbs</span> <span class="skolem">x</span> <span class="main">=</span> sim_equiv_class <span class="free">a</span> <span class="skolem">t</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> step
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">simAbs</span> <span class="skolem">y</span> <span class="main">∈</span> <span class="free">simAbs</span> <span class="main">`</span> set <span class="main">(</span>k_succs <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span>  <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> simTrans<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> t<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">t</span></span><span class="main">]</span> tC F <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">with</span></span> sx <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sx</span> <span class="main">∈</span> <span class="var">?rhs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span> <span class="main">⊆</span> <span class="var">?lhs</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ec</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ec</span> <span class="main">∈</span> <span class="var">?rhs</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> tC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> jkbpC"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> ec<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ec</span> <span class="main">=</span> sim_equiv_class <span class="free">a</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ec</span> <span class="main">∈</span> <span class="var">?lhs</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">ec</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tInit <span class="skolem">s</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> KBPAlg.reachable_def <span class="comment1">(* FIXME ouch this is touchy *)</span>
        <span class="keyword1"><span class="command">unfolding</span></span> k_frontier_def
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> image_eqI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">simInit</span></span> <span class="free"><span class="free">a</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">envObs</span></span> <span class="free"><span class="free">a</span></span> <span class="skolem"><span class="skolem">s</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> simInit jviewInit<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ImageI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">simInit</span></span> <span class="free"><span class="free">a</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">envObs</span></span> <span class="free"><span class="free">a</span></span> <span class="skolem"><span class="skolem">s</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tStep <span class="skolem">t</span> <span class="skolem">s</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> tsC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">↝</span> <span class="skolem">s</span> <span class="main">∈</span> jkbpC"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> ec<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ec</span> <span class="main">=</span> sim_equiv_class <span class="free">a</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">↝</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"sim_equiv_class <span class="free">a</span> <span class="skolem">t</span>
           <span class="main">∈</span> <span class="free">simAbs</span> <span class="main">`</span> DFS.reachable k_succs <span class="main">(</span>set <span class="main">(</span>k_frontier <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rect</span></span>
        <span class="keyword2"><span class="keyword">where</span></span> rect<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">rect</span> <span class="main">∈</span> DFS.reachable k_succs <span class="main">(</span>set <span class="main">(</span>k_frontier <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> srect<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">simAbs</span> <span class="skolem">rect</span> <span class="main">=</span> sim_equiv_class <span class="free">a</span> <span class="skolem">t</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> tsC ec srect
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ec</span> <span class="main">∈</span> <span class="free">simAbs</span> <span class="main">`</span> set <span class="main">(</span><span class="free">simTrans</span> <span class="free">a</span> <span class="skolem">rect</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> simTrans<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> t<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> ec<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">rect</span>"</span></span><span class="main">]</span> srect <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rec</span></span>
        <span class="keyword2"><span class="keyword">where</span></span> rec<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ec</span> <span class="main">=</span> <span class="free">simAbs</span> <span class="skolem">rec</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">rec</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">simTrans</span> <span class="free">a</span> <span class="skolem">rect</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> rect <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rec0</span></span>
        <span class="keyword2"><span class="keyword">where</span></span> rec0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">rec0</span> <span class="main">∈</span> set <span class="main">(</span>k_frontier <span class="free">a</span><span class="main">)</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> rec0rect<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">rec0</span><span class="main">,</span> <span class="skolem">rect</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="main">{</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="main">(</span>k_succs <span class="bound">x</span><span class="main">)</span><span class="main">}</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> KBPAlg.reachable_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> image_eqI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">rec</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> rec<span class="main">)</span>
        <span class="keyword1"><span class="command">unfolding</span></span> KBPAlg.reachable_def
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ImageI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">rec0</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> rtrancl_into_rtrancl<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> b<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">rect</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> rec0rect<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> F<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> rec0<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
     <span class="keyword1"><span class="command">qed</span></span>
   <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

Left to right follows from an induction on the reflexive, transitive
closure, and right to left by induction over canonical traces.

This result immediately yields the same result at the level of
representations:

›</span></span>

<span class="keyword1" id="KBPsAlg-k_memb_rep"><span class="command">lemma</span></span> k_memb_rep<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> N<span class="main">:</span> <span class="quoted"><span class="quoted">"k_isNode <span class="free">rec</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"k_memb <span class="free">rec</span> k_dfs"</span></span>
<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> N <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rec'</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">rec'</span> <span class="main">∈</span> DFS.reachable k_succs <span class="main">(</span>set <span class="main">(</span>k_frontier <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> rec'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">simAbs</span> <span class="free">rec</span> <span class="main">=</span> <span class="free">simAbs</span> <span class="skolem">rec'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> k_isNode_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> k_reachable<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> N k_isNode_cong<span class="main">[</span><span class="operator">OF</span> rec'<span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> N'<span class="main">:</span> <span class="quoted"><span class="quoted">"k_isNode <span class="skolem">rec'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> k_isNode_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"k_memb <span class="free">rec</span> k_dfs"</span></span>
    <span class="keyword1"><span class="command">using</span></span> KBPAlg.reachable_imp_dfs<span class="main">[</span><span class="operator">OF</span> N' k_frontier_is_node r<span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> k_memb_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> k_memb_def<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> k_invariantAOD<span class="main">[</span><span class="operator">OF</span> N' N rec' k_dfs_invariant<span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cut_tac</span> ec<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">y'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> ec'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">rec'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> k_invariantAOD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ _ k_dfs_invariant<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>

     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cut_tac</span> ec<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">rec'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> ec'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">y'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> k_isNode_cong<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command">using</span></span> N'
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> N'<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context AlgorithmForAgent *)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

This concludes our agent-specific reasoning; we now show that the
algorithm works for all agents. The following command generalises all
our lemmas in the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"AlgorithmForAgent"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>
<span class="quoted"><span class="quoted">"Algorithm"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> locale, giving them the mandatory prefix <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>KBP›</span></span></span></span>:

›</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> Algorithm
        <span class="main">&lt;</span> KBP<span class="main">:</span> AlgorithmForAgent
            <span class="quoted"><span class="free">jkbp</span></span> <span class="quoted"><span class="free">envInit</span></span> <span class="quoted"><span class="free">envAction</span></span> <span class="quoted"><span class="free">envTrans</span></span> <span class="quoted"><span class="free">envVal</span></span> <span class="quoted"><span class="free">jview</span></span> <span class="quoted"><span class="free">envObs</span></span>
            <span class="quoted"><span class="free">jviewInit</span></span> <span class="quoted"><span class="free">jviewIncr</span></span> <span class="quoted"><span class="free">simf</span></span> <span class="quoted"><span class="free">simRels</span></span> <span class="quoted"><span class="free">simVal</span></span> <span class="quoted"><span class="free">simAbs</span></span> <span class="quoted"><span class="free">simObs</span></span>
            <span class="quoted"><span class="free">simInit</span></span> <span class="quoted"><span class="free">simTrans</span></span> <span class="quoted"><span class="free">simAction</span></span> <span class="quoted"><span class="free">aOps</span></span> <span class="quoted"><span class="free">tOps</span></span> <span class="quoted"><span class="free">a</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">a</span>
<span class="comment1">(*&lt;*)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">context</span></span> Algorithm
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">k_mkAlgAuto</span> <span class="main">≡</span>
    mkAlgAuto <span class="free">aOps</span> <span class="free">tOps</span> <span class="free">simObs</span> <span class="free">simInit</span> <span class="free">simTrans</span> <span class="free">simAction</span> k_frontier"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1" id="KBPsAlg-k_mkAlgAuto_mkAutoSim_equiv"><span class="command">lemma</span></span> k_mkAlgAuto_mkAutoSim_equiv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> jkbpC"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">simAbs</span> <span class="main">(</span>runJP k_mkAlgAuto <span class="free">t</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="free">simAbs</span> <span class="main">(</span>runJP mkAutoSim <span class="free">t</span> <span class="free">a</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> tC
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tInit <span class="skolem">s</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tStep <span class="skolem">t</span> <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> tC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> jkbpC"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">from</span></span> tStep
  <span class="keyword1"><span class="command">have</span></span> N<span class="main">:</span> <span class="quoted"><span class="quoted">"KBP.k_isNode <span class="free">a</span> <span class="main">(</span>runJP k_mkAlgAuto <span class="skolem">t</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> KBP.k_isNode_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> mkAutoSim_ec<span class="main">)</span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> tStep
  <span class="keyword1"><span class="command">have</span></span> ect<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">simAbs</span> <span class="main">(</span>runJP k_mkAlgAuto <span class="skolem">t</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> sim_equiv_class <span class="free">a</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> mkAutoSim_ec<span class="main">)</span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> tStep
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sim_equiv_class <span class="free">a</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">↝</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">∈</span> <span class="free">simAbs</span> <span class="main">`</span> set <span class="main">(</span><span class="free">simTrans</span> <span class="free">a</span> <span class="main">(</span>runJP k_mkAlgAuto <span class="skolem">t</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> simTrans<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> t<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">t</span></span><span class="main">]</span> tC ect <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ec</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> ec<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ec</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">simTrans</span> <span class="free">a</span> <span class="main">(</span>runJP k_mkAlgAuto <span class="skolem">t</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> sec<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">simAbs</span> <span class="skolem">ec</span> <span class="main">=</span> sim_equiv_class <span class="free">a</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">↝</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> tStep
  <span class="keyword1"><span class="command">have</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">envObs</span> <span class="free">a</span> <span class="skolem">s</span> <span class="main">∈</span> <span class="free">simObs</span> <span class="free">a</span> <span class="main">`</span> set <span class="main">(</span><span class="free">simTrans</span> <span class="free">a</span> <span class="main">(</span>runJP k_mkAlgAuto <span class="skolem">t</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> simObs<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> t<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">t</span><span class="main">↝</span><span class="skolem">s</span>"</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span> sec ec <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> KBP.k_memb_rep<span class="main">[</span><span class="operator">OF</span> N<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"KBP.k_memb <span class="main">(</span>runJP k_mkAlgAuto <span class="skolem">t</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span>KBP.k_dfs <span class="free">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">have</span></span> G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">simAbs</span> <span class="main">(</span>runJP k_mkAlgAuto <span class="main">(</span><span class="skolem">t</span> <span class="main">↝</span> <span class="skolem">s</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> sim_equiv_class <span class="free">a</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">↝</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> KBP.k_invariantTD<span class="main">[</span><span class="operator">OF</span> N E F KBP.k_dfs_invariant<span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> jviewIncr<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> simTrans<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> t<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> ec<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"runJP k_mkAlgAuto <span class="skolem">t</span> <span class="free">a</span>"</span></span><span class="main">]</span> tC ect
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="free">simAbs</span> <span class="improper">x</span> <span class="main">∈</span> <span class="free">simAbs</span> <span class="main">`</span> set <span class="main">(</span><span class="free">simTrans</span> <span class="free">a</span> <span class="main">(</span>runJP k_mkAlgAuto <span class="skolem">t</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> jviewIncr<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cut_tac</span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> ec<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">ec'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> t<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">t'</span><span class="main">↝</span><span class="improper">sa</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> simObs<span class="main"><span class="main">[</span></span><span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> jviewIncr<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">from</span></span> tStep <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> G mkAutoSim_ec<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

Running the automata produced by the DFS on a canonical trace <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="free">t</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> yields some representation of the expected equivalence class:

›</span></span>

<span class="keyword1" id="KBPsAlg-k_mkAlgAuto_ec"><span class="command">lemma</span></span> k_mkAlgAuto_ec<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> jkbpC"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">simAbs</span> <span class="main">(</span>runJP k_mkAlgAuto <span class="free">t</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> sim_equiv_class <span class="free">a</span> <span class="free">t</span>"</span></span>
<span class="comment1">(*&lt;*)</span>
  <span class="keyword1"><span class="command">using</span></span> k_mkAlgAuto_mkAutoSim_equiv<span class="main">[</span><span class="operator">OF</span> tC<span class="main">]</span> mkAutoSim_ec<span class="main">[</span><span class="operator">OF</span> tC<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

This involves an induction over the canonical trace <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">t</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

That the DFS and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"mkAutoSim"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> yield the same actions on
canonical traces follows immediately from this result and the
invariant:

›</span></span>

<span class="keyword1" id="KBPsAlg-k_mkAlgAuto_mkAutoSim_act_eq"><span class="command">lemma</span></span> k_mkAlgAuto_mkAutoSim_act_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> jkbpC"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">∘</span> actJP k_mkAlgAuto <span class="free">t</span> <span class="main">=</span> set <span class="main">∘</span> actJP mkAutoSim <span class="free">t</span>"</span></span>
<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ec</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"sim_equiv_class <span class="skolem">a</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?rec</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"runJP k_mkAlgAuto <span class="free">t</span> <span class="skolem">a</span>"</span></span>

  <span class="keyword1"><span class="command">from</span></span> tC <span class="keyword1"><span class="command">have</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?ec</span> <span class="main">∈</span> sim_equiv_class <span class="skolem">a</span> <span class="main">`</span> jkbpC"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> tC E <span class="keyword1"><span class="command">have</span></span> N<span class="main">:</span> <span class="quoted"><span class="quoted">"KBP.k_isNode <span class="skolem">a</span> <span class="main">(</span>runJP k_mkAlgAuto <span class="free">t</span> <span class="skolem">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> KBP.k_isNode_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> k_mkAlgAuto_ec<span class="main"><span class="main">[</span></span><span class="operator">OF</span> tC<span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> KBP.k_memb_rep<span class="main">[</span><span class="operator">OF</span> N<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"KBP.k_memb <span class="var">?rec</span> <span class="main">(</span>KBP.k_dfs <span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">acts</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"lookup <span class="free">aOps</span> <span class="main">(</span>aActs <span class="main">(</span>KBP.k_dfs <span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="var">?rec</span> <span class="main">=</span> Some <span class="skolem">acts</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">acts</span> <span class="main">=</span> set <span class="main">(</span><span class="free">simAction</span> <span class="skolem">a</span> <span class="var">?rec</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> KBP.k_invariantAD<span class="main">[</span><span class="operator">OF</span> N E KBP.k_dfs_invariant<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>set <span class="main">∘</span> actJP k_mkAlgAuto <span class="free">t</span><span class="main">)</span> <span class="skolem">a</span> <span class="main">=</span> <span class="main">(</span>set <span class="main">∘</span> actJP mkAutoSim <span class="free">t</span><span class="main">)</span> <span class="skolem">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> jAction_simAbs_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> tC<span class="main"><span class="main">]</span></span>
               <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> k_mkAlgAuto_ec<span class="main"><span class="main">[</span></span><span class="operator">OF</span> tC<span class="main"><span class="main">]</span></span> mkAutoSim_ec<span class="main"><span class="main">[</span></span><span class="operator">OF</span> tC<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

Therefore these two constructions are behaviourally equivalent, and so
the DFS generates an implementation of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">jkbp</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> in the given
environment:

›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> k_mkAlgAuto_implements<span class="main">:</span> <span class="quoted"><span class="quoted">"implements k_mkAlgAuto"</span></span>
<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"behaviourally_equiv mkAutoSim k_mkAlgAuto"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> k_mkAlgAuto_mkAutoSim_act_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> mkAutoSim_implements <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> behaviourally_equiv_implements<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context Algorithm *)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

Clearly the automata generated by this algorithm are large. We discuss
this issue in \S\ref{sec:kbps-alg-auto-min}.

\FloatBarrier

›</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="ODList">
<div class="head">
<h1>Theory ODList</h1>
</div>
<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="comment1">(*
 * Knowledge-based programs.
 * (C)opyright 2011, Peter Gammie, peteg42 at gmail.com.
 * License: BSD
 *
 * Based on Florian Haftmann's DList.thy and Tobias Nipkow's msort proofs.
 *)</span>

<span class="keyword1"><span class="command">theory</span></span> ODList
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Multiset.html">HOL-Library.Multiset</a>"</span>
  <a href="#List_local">List_local</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

Define a type of ordered distinct lists, intended to represent sets.

The advantage of this representation is that it is isomorphic to the
set of finite sets. Conversely it requires the carrier type to be a
linear order.  Note that this representation does not arise from a
quotient on lists: all the unsorted lists are junk.

›</span></span>

<span class="keyword1"><span class="command">context</span></span> linorder
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

"Absorbing" msort, a variant of Tobias Nipkow's proofs from 1992.

›</span></span>

<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">merge</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">merge</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">merge</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">merge</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span> <span class="free">merge</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span>
             <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free">merge</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span>
                           <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free">merge</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1" id="ODList-set_merge"><span class="command">lemma</span></span> set_merge<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="main">(</span>merge <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> merge.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="ODList-distinct_sorted_merge"><span class="command">lemma</span></span> distinct_sorted_merge<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> distinct <span class="free">xs</span><span class="main">;</span> distinct <span class="free">ys</span><span class="main">;</span> sorted <span class="free">xs</span><span class="main">;</span> sorted <span class="free">ys</span> <span class="main">⟧</span>
     <span class="main">⟹</span> distinct <span class="main">(</span>merge <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">∧</span> sorted <span class="main">(</span>merge <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> merge.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="ODList-mset_merge"><span class="command">lemma</span></span> mset_merge <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> distinct <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> mset <span class="main">(</span>merge <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> mset <span class="free">xs</span> <span class="main">+</span> mset <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> merge.induct<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The "absorbing" sort itself.›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">msort</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">msort</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">msort</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">msort</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> merge <span class="main">(</span><span class="free">msort</span> <span class="main">(</span>take <span class="main">(</span>size <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">)</span>
                    <span class="main">(</span><span class="free">msort</span> <span class="main">(</span>drop <span class="main">(</span>size <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1" id="ODList-msort_distinct_sorted"><span class="command">lemma</span></span> msort_distinct_sorted<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>msort <span class="free">xs</span><span class="main">)</span> <span class="main">∧</span> sorted <span class="main">(</span>msort <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> msort.induct<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="ODList-msort_set"><span class="command">lemma</span></span> msort_set<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="main">(</span>msort <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> msort.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> List.set_simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> append_take_drop_id set_append<span class="main">)</span> <span class="comment1">(* thankyou sledgehammer! *)</span>

<span class="keyword1" id="ODList-msort_remdups"><span class="command">lemma</span></span> msort_remdups<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"remdups <span class="main">(</span>msort <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> msort <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="ODList-msort_idle"><span class="command">lemma</span></span> msort_idle<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> distinct <span class="free">xs</span><span class="main">;</span> sorted <span class="free">xs</span> <span class="main">⟧</span> <span class="main">⟹</span> msort <span class="free">xs</span> <span class="main">=</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> map_sorted_distinct_set_unique<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">id</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map.id<span class="main">)</span>

<span class="keyword1" id="ODList-mset_msort"><span class="command">lemma</span></span> mset_msort<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span> <span class="main">⟹</span> mset <span class="main">(</span>msort <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> mset <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> iffD1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> set_eq_iff_mset_eq_distinct<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="ODList-msort_sort"><span class="command">lemma</span></span> msort_sort<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span> <span class="main">⟹</span> sort <span class="free">xs</span> <span class="main">=</span> msort <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> properties_for_sort<span class="main">)</span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context linorder *)</span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹The <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">odlist</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> type›</span></span>

<span class="keyword1"><span class="command">typedef</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">overloaded</span></span><span class="main">)</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> <span class="quoted">linorder</span><span class="main">)</span> odlist <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span> <span class="bound">x</span><span class="main">::</span><span class="tfree">'a</span> list <span class="main">.</span> sorted <span class="bound">x</span> <span class="main">∧</span> distinct <span class="bound">x</span> <span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">morphisms</span></span> toList odlist_Abs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> sorted.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="ODList-distinct_toList"><span class="command">lemma</span></span> distinct_toList<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>toList <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> toList <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="ODList-sorted_toList"><span class="command">lemma</span></span> sorted_toList<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>toList <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> toList <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

Code generator voodoo: this is the constructor for the abstract type.

›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">ODList</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> linorder<span class="main">)</span> list <span class="main">⇒</span> <span class="tfree">'a</span> odlist"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ODList</span> <span class="main">≡</span> odlist_Abs <span class="main">∘</span> msort"</span></span>

<span class="keyword1" id="ODList-toList_ODList"><span class="command">lemma</span></span> toList_ODList<span class="main">:</span>
  <span class="quoted"><span class="quoted">"toList <span class="main">(</span>ODList <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> msort <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ODList_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> odlist_Abs_inverse<span class="main">)</span>

<span class="keyword1" id="ODList-ODList_toList"><span class="command">lemma</span></span> ODList_toList<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">abstype</span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ODList <span class="main">(</span>toList <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ODList_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> odlist_Abs_inverse<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

Runtime cast from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'a</span></span> list"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> into <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'a</span></span> odlist"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. This is
just a renaming of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ODList"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> -- names are significant to the
code generator's abstract type machinery.

›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">fromList</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> linorder<span class="main">)</span> list <span class="main">⇒</span> <span class="tfree">'a</span> odlist"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fromList</span> <span class="main">≡</span> ODList"</span></span>

<span class="keyword1" id="ODList-toList_fromList"><span class="command">lemma</span></span> toList_fromList<span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">abstract</span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"toList <span class="main">(</span>fromList <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> msort <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fromList_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> toList_ODList<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Basic properties: equality, finiteness›</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">declare</span></span> toList_inject<span class="main">[</span><span class="operator">iff</span><span class="main">]</span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">instantiation</span></span> odlist <span class="main">::</span> <span class="main">(</span><span class="quoted">linorder</span><span class="main">)</span> <span class="quoted">equal</span>
<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"HOL.equal <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">⟷</span> odlist_equal <span class="main">(</span>toList <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">(</span>toList <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> equal_odlist_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">instance</span></span> odlist <span class="main">::</span> <span class="main">(</span><span class="quoted"><span class="quoted">"<span class="main">{</span>finite<span class="main">,</span> linorder<span class="main">}</span>"</span></span><span class="main">)</span> <span class="quoted">finite</span>
<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ol</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"UNIV <span class="main">::</span> <span class="tfree">'a</span> odlist set"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"UNIV <span class="main">::</span> <span class="tfree">'a</span> set set"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ol</span> <span class="main">⊆</span> range <span class="main">(</span>odlist_Abs <span class="main">∘</span> sorted_list_of_set<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> range <span class="main">(</span>odlist_Abs <span class="main">∘</span> sorted_list_of_set<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> range_eqI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"set <span class="main"><span class="main">(</span></span>toList <span class="skolem"><span class="skolem">x</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> odlist_Abs_inject sorted_list_of_set_sort_remdups odlist_Abs_inverse distinct_remdups_id<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?ol</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_surj<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Constants›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">empty</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> linorder<span class="main">)</span> odlist"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">empty</span> <span class="main">≡</span> ODList <span class="main">[]</span>"</span></span>

<span class="keyword1" id="ODList-toList_empty"><span class="command">lemma</span></span> toList_empty<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">abstract</span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"toList empty <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> empty_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> toList_ODList<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Operations›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹toSet›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">toSet</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> linorder<span class="main">)</span> odlist <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">toSet</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">=</span> set <span class="main">(</span>toList <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="ODList-toSet_empty"><span class="command">lemma</span></span> toSet_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"toSet empty <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> toSet_def empty_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> toList_ODList<span class="main">)</span>

<span class="keyword1" id="ODList-toSet_ODList"><span class="command">lemma</span></span> toSet_ODList<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> distinct <span class="free">xs</span><span class="main">;</span> sorted <span class="free">xs</span> <span class="main">⟧</span> <span class="main">⟹</span> toSet <span class="main">(</span>ODList <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> toSet_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> toList_ODList<span class="main">)</span>

<span class="keyword1" id="ODList-toSet_fromList_set"><span class="command">lemma</span></span> toSet_fromList_set<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"toSet <span class="main">(</span>fromList <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> toSet_def fromList_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> toList_ODList<span class="main">)</span>

<span class="keyword1" id="ODList-toSet_inj"><span class="command">lemma</span></span> toSet_inj<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"inj toSet"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> injI<span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> toSet_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">y</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> odlist_Abs_inject odlist_Abs_inverse sorted_distinct_set_unique<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="ODList-toSet_eq_iff"><span class="command">lemma</span></span> toSet_eq_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="free">Y</span> <span class="main">⟷</span> toSet <span class="free">X</span> <span class="main">=</span> toSet <span class="free">Y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> injD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> toSet_inj<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹head›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">hd</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> linorder<span class="main">)</span> odlist <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">hd</span> <span class="main">≡</span> List.hd <span class="main">∘</span> toList"</span></span>

<span class="keyword1" id="ODList-hd_toList"><span class="command">lemma</span></span> hd_toList<span class="main">:</span> <span class="quoted"><span class="quoted">"toList <span class="free">xs</span> <span class="main">=</span> <span class="free">y</span> <span class="main">#</span> <span class="free">ys</span> <span class="main">⟹</span> ODList.hd <span class="free">xs</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> hd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹member›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">member</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> linorder<span class="main">)</span> odlist <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">member</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> List.member <span class="main">(</span>toList <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword1" id="ODList-member_toSet"><span class="command">lemma</span></span> member_toSet<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"member <span class="free">xs</span> <span class="free">x</span> <span class="main">⟷</span><span class="free">x</span> <span class="main">∈</span> toSet <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> member_def toSet_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_set_member<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Filter›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">filter</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> linorder<span class="main">)</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> odlist <span class="main">⇒</span> <span class="tfree">'a</span> odlist"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">filter</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span> ODList <span class="main">(</span>List.filter <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>toList <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="ODList-toList_filter"><span class="command">lemma</span></span> toList_filter<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">abstract</span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"toList <span class="main">(</span>filter <span class="free">P</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> List.filter <span class="free">P</span> <span class="main">(</span>toList <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> filter_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> toList_ODList<span class="main">)</span>

<span class="keyword1" id="ODList-toSet_filter"><span class="command">lemma</span></span> toSet_filter<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"toSet <span class="main">(</span>filter <span class="free">P</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span> <span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> toSet <span class="free">xs</span> <span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> filter_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> toSet_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹All›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">odlist_all</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> linorder <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> odlist <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">odlist_all</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span> list_all <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>toList <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="ODList-odlist_all_iff"><span class="command">lemma</span></span> odlist_all_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"odlist_all <span class="free">P</span> <span class="free">xs</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> toSet <span class="free">xs</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> odlist_all_def toSet_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>

<span class="keyword1" id="ODList-odlist_all_cong"><span class="command">lemma</span></span> odlist_all_cong <span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="free">ys</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> toSet <span class="free">ys</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> odlist_all <span class="free">f</span> <span class="free">xs</span> <span class="main">=</span> odlist_all <span class="free">g</span> <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> odlist_all_iff<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Difference›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">difference</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> linorder<span class="main">)</span> odlist <span class="main">⇒</span> <span class="tfree">'a</span> odlist <span class="main">⇒</span> <span class="tfree">'a</span> odlist"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">difference</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">=</span> ODList <span class="main">(</span>List_local.difference <span class="main">(</span>toList <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">(</span>toList <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="ODList-toList_difference"><span class="command">lemma</span></span> toList_difference<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">abstract</span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"toList <span class="main">(</span>difference <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> List_local.difference <span class="main">(</span>toList <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>toList <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> difference_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> toList_ODList<span class="main">)</span>

<span class="keyword1" id="ODList-toSet_difference"><span class="command">lemma</span></span> toSet_difference<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"toSet <span class="main">(</span>difference <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> toSet <span class="free">xs</span> <span class="main">-</span> toSet <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> difference_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> toSet_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Intersection›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">intersect</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> linorder<span class="main">)</span> odlist <span class="main">⇒</span> <span class="tfree">'a</span> odlist <span class="main">⇒</span> <span class="tfree">'a</span> odlist"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">intersect</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">=</span> ODList <span class="main">(</span>List_local.intersection <span class="main">(</span>toList <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">(</span>toList <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="ODList-toList_intersect"><span class="command">lemma</span></span> toList_intersect<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">abstract</span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"toList <span class="main">(</span>intersect <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> List_local.intersection <span class="main">(</span>toList <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>toList <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> intersect_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> toList_ODList<span class="main">)</span>

<span class="keyword1" id="ODList-toSet_intersect"><span class="command">lemma</span></span> toSet_intersect<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"toSet <span class="main">(</span>intersect <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> toSet <span class="free">xs</span> <span class="main">∩</span> toSet <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> intersect_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> toSet_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Union›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">union</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> linorder<span class="main">)</span> odlist <span class="main">⇒</span> <span class="tfree">'a</span> odlist <span class="main">⇒</span> <span class="tfree">'a</span> odlist"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">union</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">=</span> ODList <span class="main">(</span>merge <span class="main">(</span>toList <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">(</span>toList <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="ODList-toList_union"><span class="command">lemma</span></span> toList_union<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">abstract</span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"toList <span class="main">(</span>union <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> merge <span class="main">(</span>toList <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>toList <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> union_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> toList_ODList<span class="main">)</span>

<span class="keyword1" id="ODList-toSet_union"><span class="command">lemma</span></span> toSet_union<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"toSet <span class="main">(</span>union <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> toSet <span class="free">xs</span> <span class="main">∪</span> toSet <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> union_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> toSet_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">big_union</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> linorder<span class="main">)</span> odlist<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> list <span class="main">⇒</span> <span class="tfree">'a</span> odlist"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">big_union</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">≡</span> foldr <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">A</span><span class="main">.</span> ODList.union <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">a</span><span class="main">)</span> <span class="bound">A</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> ODList.empty"</span></span>

<span class="keyword1" id="ODList-toSet_big_union"><span class="command">lemma</span></span> toSet_big_union<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"toSet <span class="main">(</span>big_union <span class="free">f</span> <span class="free">X</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">X</span><span class="main">.</span> toSet <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="skolem">Y</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"toSet <span class="main">(</span>foldr <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">A</span><span class="main">.</span> ODList.union <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">A</span><span class="main">)</span> <span class="skolem">X</span> <span class="skolem">Y</span><span class="main">)</span> <span class="main">=</span> toSet <span class="skolem">Y</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span> <span class="main">∈</span> set <span class="skolem">X</span><span class="main">.</span> toSet <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">X</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">Y</span></span><span class="main">)</span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
   <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
     <span class="keyword1"><span class="command">unfolding</span></span> big_union_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Case distinctions›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

We construct ODLists out of lists, so talk in terms of those, not a
one-step constructor we don't use.

›</span></span>

<span class="keyword1" id="ODList-distinct_sorted_induct"><span class="command">lemma</span></span> distinct_sorted_induct <span class="main">[</span><span class="operator">consumes</span> 2<span class="main">,</span> <span class="operator">case_names</span> Nil insert<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sorted <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> base<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">xs</span><span class="main">.</span> <span class="main">⟦</span> distinct <span class="main">(</span><span class="bound">x</span> <span class="main">#</span> <span class="bound">xs</span><span class="main">)</span><span class="main">;</span> sorted <span class="main">(</span><span class="bound">x</span> <span class="main">#</span> <span class="bound">xs</span><span class="main">)</span><span class="main">;</span> <span class="free">P</span> <span class="bound">xs</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">x</span> <span class="main">#</span> <span class="bound">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹distinct <span class="free">xs</span>›</span></span> <span class="quoted"><span class="quoted">‹sorted <span class="free">xs</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="main">[]</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> step <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="ODList-odlist_induct"><span class="command">lemma</span></span> odlist_induct <span class="main">[</span><span class="operator">case_names</span> empty insert<span class="main">,</span> <span class="operator">cases</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">type</span></span></span><span class="main"><span class="main"><span class="main"><span class="main">:</span></span></span></span> odlist<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">dxs</span><span class="main">.</span> <span class="bound">dxs</span> <span class="main">=</span> empty <span class="main">⟹</span> <span class="free">P</span> <span class="bound">dxs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> insrt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">dxs</span> <span class="bound">x</span> <span class="bound">xs</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">dxs</span> <span class="main">=</span> fromList <span class="main">(</span><span class="bound">x</span> <span class="main">#</span> <span class="bound">xs</span><span class="main">)</span><span class="main">;</span> distinct <span class="main">(</span><span class="bound">x</span> <span class="main">#</span> <span class="bound">xs</span><span class="main">)</span><span class="main">;</span> sorted <span class="main">(</span><span class="bound">x</span> <span class="main">#</span> <span class="bound">xs</span><span class="main">)</span><span class="main">;</span> <span class="free">P</span> <span class="main">(</span>fromList <span class="bound">xs</span><span class="main">)</span> <span class="main">⟧</span>
                            <span class="main">⟹</span> <span class="free">P</span> <span class="bound">dxs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">dxs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">dxs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>odlist_Abs <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> dxs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">dxs</span> <span class="main">=</span> ODList <span class="skolem">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> distinct<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sorted<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ODList_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹distinct <span class="skolem">xs</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹sorted <span class="skolem">xs</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>ODList <span class="skolem">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> distinct_sorted_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">from</span></span> empty <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> empty_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> insrt<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fromList_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> dxs <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">dxs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="ODList-odlist_cases"><span class="command">lemma</span></span> odlist_cases <span class="main">[</span><span class="operator">case_names</span> empty insert<span class="main">,</span> <span class="operator">cases</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">type</span></span></span><span class="main"><span class="main"><span class="main"><span class="main">:</span></span></span></span> odlist<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">dxs</span> <span class="main">=</span> empty <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> insert<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">xs</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">dxs</span> <span class="main">=</span> fromList <span class="main">(</span><span class="bound">x</span> <span class="main">#</span> <span class="bound">xs</span><span class="main">)</span><span class="main">;</span> distinct <span class="main">(</span><span class="bound">x</span> <span class="main">#</span> <span class="bound">xs</span><span class="main">)</span><span class="main">;</span> sorted <span class="main">(</span><span class="bound">x</span> <span class="main">#</span> <span class="bound">xs</span><span class="main">)</span> <span class="main">⟧</span>
                            <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="free">P</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">dxs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>odlist_Abs <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> dxs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">dxs</span> <span class="main">=</span> ODList <span class="skolem">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> distinct<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sorted<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ODList_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">P</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">with</span></span> dxs <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">dxs</span> <span class="main">=</span> empty"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> empty_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> empty <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">P</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> dxs distinct sorted insert
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">P</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fromList_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Relations›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

Relations, represented as a list of pairs.

›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> odrelation <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> odlist"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Image›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The output of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"List_local.image"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is not guaranteed to be
ordered or distinct. Also the relation need not be monomorphic.

›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">image</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> linorder <span class="main">×</span> <span class="tfree">'b</span> <span class="main">::</span> linorder<span class="main">)</span> odlist <span class="main">⇒</span> <span class="tfree">'a</span> odlist <span class="main">⇒</span> <span class="tfree">'b</span> odlist"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">image</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> ODList <span class="main">(</span>List_local.image <span class="main">(</span>toList <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> <span class="main">(</span>toList <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="ODList-toList_image"><span class="command">lemma</span></span> toList_image<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">abstract</span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"toList <span class="main">(</span>image <span class="free">R</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> msort <span class="main">(</span>List_local.image <span class="main">(</span>toList <span class="free">R</span><span class="main">)</span> <span class="main">(</span>toList <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> image_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> toList_ODList<span class="main">)</span>

<span class="keyword1" id="ODList-toSet_image"><span class="command">lemma</span></span> toSet_image<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"toSet <span class="main">(</span>image <span class="free">R</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> toSet <span class="free">R</span> <span class="main">``</span> toSet <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> image_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> toSet_def toList_ODList<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Linear order›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

Lexicographic ordering on lists. Executable, unlike in List.thy.

›</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> odlist <span class="main">::</span> <span class="main">(</span><span class="quoted">linorder</span><span class="main">)</span> <span class="quoted">linorder</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">print_context</span></span>
<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">less_eq_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">less_eq_list</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">less_eq_list</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">[]</span> <span class="main">=</span> False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">less_eq_list</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">∨</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">∧</span> <span class="free">less_eq_list</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="ODList-less_eq_list_nil_inv"><span class="command">lemma</span></span> less_eq_list_nil_inv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">xs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"less_eq_list <span class="free">xs</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="ODList-less_eq_list_cons_inv"><span class="command">lemma</span></span> less_eq_list_cons_inv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"less_eq_list <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">yys</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">y</span> <span class="bound">ys</span><span class="main">.</span> <span class="free">yys</span> <span class="main">=</span> <span class="bound">y</span> <span class="main">#</span> <span class="bound">ys</span> <span class="main">∧</span> <span class="main">(</span><span class="free">x</span> <span class="main">&lt;</span> <span class="bound">y</span> <span class="main">∨</span> <span class="main">(</span><span class="free">x</span> <span class="main">=</span> <span class="bound">y</span> <span class="main">∧</span> less_eq_list <span class="free">xs</span> <span class="bound">ys</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">yys</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="ODList-less_eq_list_refl"><span class="command">lemma</span></span> less_eq_list_refl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">xs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"less_eq_list <span class="free">xs</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="ODList-less_eq_list_trans"><span class="command">lemma</span></span> less_eq_list_trans<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">xs</span> <span class="free">ys</span> <span class="free">zs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> less_eq_list <span class="free">xs</span> <span class="free">ys</span><span class="main">;</span> less_eq_list <span class="free">ys</span> <span class="free">zs</span> <span class="main">⟧</span> <span class="main">⟹</span> less_eq_list <span class="free">xs</span> <span class="free">zs</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">zs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_eq_list.induct<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> less_eq_list_cons_inv<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> less_eq_list_cons_inv<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="ODList-less_eq_list_antisym"><span class="command">lemma</span></span> less_eq_list_antisym<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">xs</span> <span class="free">ys</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> less_eq_list <span class="free">xs</span> <span class="free">ys</span><span class="main">;</span> less_eq_list <span class="free">ys</span> <span class="free">xs</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_eq_list.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> less_eq_list_nil_inv<span class="main">)</span>

<span class="keyword1" id="ODList-less_eq_list_linear"><span class="command">lemma</span></span> less_eq_list_linear<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">xs</span> <span class="free">ys</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"less_eq_list <span class="free">xs</span> <span class="free">ys</span> <span class="main">∨</span> less_eq_list <span class="free">ys</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_eq_list.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity"><span class="class_parameter">less_eq_odlist</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> odlist <span class="main">⇒</span> <span class="tfree">'a</span> odlist <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">≡</span> less_eq_list <span class="main">(</span>toList <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">(</span>toList <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">less_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">less_list</span> <span class="main">[]</span> <span class="main">[]</span> <span class="main">=</span> False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">less_list</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">less_list</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">[]</span> <span class="main">=</span> False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">less_list</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">∨</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">∧</span> <span class="free">less_list</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity"><span class="class_parameter">less_odlist</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> odlist <span class="main">⇒</span> <span class="tfree">'a</span> odlist <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">≡</span> less_list <span class="main">(</span>toList <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">(</span>toList <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="ODList-less_eq_list_not_le"><span class="command">lemma</span></span> less_eq_list_not_le<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">xs</span> <span class="free">ys</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>less_list <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>less_eq_list <span class="free">xs</span> <span class="free">ys</span> <span class="main">∧</span> <span class="main">¬</span> less_eq_list <span class="free">ys</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_list.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">intro_classes</span>
  <span class="keyword1"><span class="command">unfolding</span></span> less_eq_odlist_def less_odlist_def
  <span class="keyword1"><span class="command">using</span></span> less_eq_list_not_le less_eq_list_refl less_eq_list_trans less_eq_list_antisym
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">using</span></span> less_eq_list_not_le less_eq_list_refl less_eq_list_trans less_eq_list_antisym
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">using</span></span> less_eq_list_not_le less_eq_list_refl less_eq_list_trans less_eq_list_antisym
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">using</span></span> less_eq_list_not_le less_eq_list_refl less_eq_list_trans less_eq_list_antisym
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> less_eq_list_linear<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Finite maps›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

A few operations on finite maps.

Unlike the AssocList theory, ODLists give us canonical
representations, so we can order them. Our tabulate has the wrong type
(we want to take an odlist, not a list) so we can't use that
part of the framework.

›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">lookup</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> linorder <span class="main">×</span> <span class="tfree">'b</span> <span class="main">::</span> linorder<span class="main">)</span> odlist <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇀</span> <span class="tfree">'b</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">lookup</span> <span class="main">=</span> map_of <span class="main">∘</span> toList"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Specific to ODLists.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">tabulate</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> linorder<span class="main">)</span> odlist <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">::</span> linorder<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> odlist"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">tabulate</span> <span class="free"><span class="bound"><span class="entity">ks</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> ODList <span class="main">(</span>List.map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>toList <span class="free"><span class="bound"><span class="entity">ks</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> order<span class="main">)</span> <span class="entity">mono_on</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>order<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mono_on</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">.</span> <span class="bound">x</span> <span class="main">≤</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">y</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> order<span class="main">)</span> mono_onI <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">?</span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>order"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">≤</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">y</span><span class="main">)</span> <span class="main">⟹</span> mono_on <span class="free">f</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mono_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> order<span class="main">)</span> mono_onD <span class="main">[</span><span class="operator">dest</span><span class="main"><span class="main"><span class="main">?</span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>order"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mono_on <span class="free">f</span> <span class="free">X</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">f</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">f</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mono_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> order<span class="main">)</span> mono_on_subset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>order"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mono_on <span class="free">f</span> <span class="free">X</span> <span class="main">⟹</span> <span class="free">Y</span> <span class="main">⊆</span> <span class="free">X</span> <span class="main">⟹</span> mono_on <span class="free">f</span> <span class="free">Y</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mono_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="ODList-sorted_mono_map"><span class="command">lemma</span></span> sorted_mono_map<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> sorted <span class="free">xs</span><span class="main">;</span> mono_on <span class="free">f</span> <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> sorted <span class="main">(</span>List.map <span class="free">f</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cut_tac</span> X<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"insert <span class="improper">a</span> <span class="main">(</span>set <span class="improper">xs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Y<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"set <span class="improper">xs</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> mono_on_subset<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> mono_onD<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="ODList-msort_map"><span class="command">lemma</span></span> msort_map<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> distinct <span class="free">xs</span><span class="main">;</span> sorted <span class="free">xs</span><span class="main">;</span> inj_on <span class="free">f</span> <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span><span class="main">;</span> mono_on <span class="free">f</span> <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> msort <span class="main">(</span>List.map <span class="free">f</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> List.map <span class="free">f</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> msort_idle<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distinct_map<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_mono_map<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="ODList-tabulate_toList"><span class="command">lemma</span></span> tabulate_toList<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">abstract</span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"toList <span class="main">(</span>tabulate <span class="free">ks</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> List.map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="free">f</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>toList <span class="free">ks</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> tabulate_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> toList_ODList<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> msort_map<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> inj_onI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> mono_onI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_eq_prod_def less_le<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="ODList-lookup_tabulate"><span class="command">lemma</span></span> lookup_tabulate<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"lookup <span class="main">(</span>tabulate <span class="free">ks</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Some <span class="keyword1">o</span> <span class="free">f</span><span class="main">)</span> <span class="main">|`</span> toSet <span class="free">ks</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ks</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> odlist_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>empty <span class="skolem">dxs</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> tabulate_def lookup_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> toList_ODList<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">dxs</span> <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> insert <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_of <span class="main">(</span>List.map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="free">f</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> map_of <span class="main">(</span>msort <span class="main">(</span>List.map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="free">f</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> msort_map<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> inj_onI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> mono_onI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_eq_prod_def less_le<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> insert <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> lookup <span class="main">(</span>tabulate <span class="main">(</span>fromList <span class="skolem">xs</span><span class="main">)</span> <span class="free">f</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> tabulate_def lookup_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> toList_ODList toList_fromList<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> insert <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span>Some <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="main">|`</span> toSet <span class="main">(</span>fromList <span class="skolem">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> toSet_fromList_set<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"map_of <span class="main">(</span>List.map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="free">f</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Some <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="main">|`</span> toSet <span class="main">(</span>fromList <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> insert <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lookup <span class="main">(</span>tabulate <span class="skolem">dxs</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> map_of <span class="main">(</span>toList <span class="main">(</span>ODList <span class="main">(</span>List.map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="free">f</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> tabulate_def lookup_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> toList_fromList<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> map_of <span class="main">(</span>msort <span class="main">(</span>List.map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="free">f</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> toList_ODList<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> insert <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> map_of <span class="main">(</span>List.map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="free">f</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> msort_map<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> inj_onI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> mono_onI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_eq_prod_def less_le<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> insert IH <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span>Some <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="main">|`</span> toSet <span class="skolem">dxs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> restrict_map_def fun_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="Eval">
<div class="head">
<h1>Theory Eval</h1>
</div>
<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="comment1">(*
 * Knowledge-based programs.
 * (C)opyright 2011, Peter Gammie, peteg42 at gmail.com.
 * License: BSD
 *)</span>

<span class="keyword1"><span class="command">theory</span></span> Eval
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="#Extra">Extra</a>
  <a href="#Kripke">Kripke</a>
  <a href="#ODList">ODList</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Algorithmic evaluation›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

\label{sec:kbps-theory-eval}

Generically evaluate a knowledge formula with respect to a few
operations.

Intuition: Tableau, returns the subset of X where the formula
holds. Could generalise that to the set of \emph{all} states where the
formula holds, at least for the propositional part. This is closer to
the BDD interpretation. However in an explicit-state setup we want the
smallest sets that work.

Given an implementation of the relations, compute the subset of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="free">X</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> where <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">X</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> holds. Here we reduce space consumption by
only considering the reachable states at the cost of possible
reevaluation... BDDs give us some better primitives in some cases (but
not all). Something to ponder.

›</span></span>

<span class="keyword1"><span class="command">function</span></span>
  <span class="entity">eval_rec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'rep</span> <span class="main">::</span> linorder<span class="main">)</span> odlist <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> <span class="tfree">'rep</span> odlist<span class="main">)</span>
             <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'rep</span> <span class="main">⇒</span> <span class="tfree">'rep</span> odlist<span class="main">)</span>
             <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'rep</span> <span class="main">⇒</span> <span class="tfree">'rep</span> odlist<span class="main">)</span>
             <span class="main">⇒</span> <span class="tfree">'rep</span> odlist
             <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">)</span> Kform
             <span class="main">⇒</span> <span class="tfree">'rep</span> odlist"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eval_rec</span> <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">CR</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">(</span>Kprop <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>     <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eval_rec</span> <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">CR</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">(</span>Knot <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>      <span class="main">=</span> ODList.difference <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">(</span><span class="free">eval_rec</span> <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">CR</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eval_rec</span> <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">CR</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">(</span>Kand <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>    <span class="main">=</span> ODList.intersect <span class="main">(</span><span class="free">eval_rec</span> <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">CR</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">eval_rec</span> <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">CR</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eval_rec</span> <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">CR</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">(</span>Kknows <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>  <span class="main">=</span> ODList.filter <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">eval_rec</span> <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">CR</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>Knot <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> ODList.empty<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eval_rec</span> <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">CR</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">(</span>Kcknows <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="keyword1">else</span> ODList.filter <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">eval_rec</span> <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">CR</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">CR</span></span></span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>Knot <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> ODList.empty<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span>"</span></span>
<span class="comment1">(*&lt;*)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">kf_k_measure</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">)</span> Kform <span class="main">⇒</span> nat"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">kf_k_measure</span> <span class="main">(</span>Kprop <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>  <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">kf_k_measure</span> <span class="main">(</span>Knot <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>   <span class="main">=</span> <span class="free">kf_k_measure</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">kf_k_measure</span> <span class="main">(</span>Kand <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">kf_k_measure</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">+</span> <span class="free">kf_k_measure</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">kf_k_measure</span> <span class="main">(</span>Kknows <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="free">kf_k_measure</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">kf_k_measure</span> <span class="main">(</span>Kcknows <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="free">kf_k_measure</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">termination</span></span> <span class="quoted">eval_rec</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measures <span class="main">[</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">φ</span><span class="main">)</span><span class="main">.</span> size <span class="bound">φ</span><span class="main">,</span> <span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">φ</span><span class="main">)</span><span class="main">.</span> kf_k_measure <span class="bound">φ</span><span class="main">]</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

This function terminates because (recursively) either the formula
decreases in size or it contains fewer knowledge modalities.

We need to work a bit to interpret subjective formulas.

Expect <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">X</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to be the set of states we need to evaluate <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="free">φ</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> at for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">K</span></span> <span class="free"><span class="free">a</span></span> <span class="free"><span class="free">φ</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to be true.

Kcknows can be treated the same as Kknows... Just deals with top-level
boolean combinations of knowledge formulas.

The K cases are terrible. For CK we actually show <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">K</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">CK</span></span>
<span class="free"><span class="free">φ</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. might be easier to futz that here.

›</span></span>

<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">evalS</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'rep</span> <span class="main">::</span> linorder<span class="main">)</span> odlist <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> <span class="tfree">'rep</span> odlist<span class="main">)</span>
          <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'rep</span> <span class="main">⇒</span> <span class="tfree">'rep</span> odlist<span class="main">)</span>
          <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'rep</span> <span class="main">⇒</span> <span class="tfree">'rep</span> odlist<span class="main">)</span>
          <span class="main">⇒</span> <span class="tfree">'rep</span> odlist
          <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">)</span> Kform <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">evalS</span> <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">CR</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">(</span>Kprop <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>      <span class="main">=</span> undefined"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">evalS</span> <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">CR</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">(</span>Knot <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>       <span class="main">=</span> <span class="main">(</span><span class="main">¬</span><span class="free">evalS</span> <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">CR</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">evalS</span> <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">CR</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">(</span>Kand <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>     <span class="main">=</span> <span class="main">(</span><span class="free">evalS</span> <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">CR</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span> <span class="free">evalS</span> <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">CR</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">evalS</span> <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">CR</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">(</span>Kknows <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>   <span class="main">=</span> <span class="main">(</span>eval_rec <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">CR</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">(</span>Knot <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> ODList.empty<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">evalS</span> <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">CR</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">(</span>Kcknows <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>eval_rec <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">CR</span></span></span> <span class="main">(</span>ODList.big_union <span class="main">(</span><span class="free"><span class="bound"><span class="entity">CR</span></span></span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span> <span class="main">(</span>toList <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Knot <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> ODList.empty<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

We'd like some generic proofs about these functions but it's simpler
just to prove concrete instances.

The K cases are inefficient -- we'd like to memoise them,
etc. However it is suggestive of the ``real'' BDD
implementations. Compare with Halpern/Moses who do it more efficiently
in time (linear?) at the cost of space. In practice the knowledge
formulas are not deeply nested, so it is not worth trying too hard
here.

In general this is less efficient than the tableau approach of
\citet[Proposition~3.2.1]{FHMV:1995}, which labels all states with all
formulas. However it is often the case that the set of relevant worlds
is much smaller than the set of all system states.

›</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="Trie2">
<div class="head">
<h1>Theory Trie2</h1>
</div>
<pre class="source"><span class="comment1">(* Title: Adaptation of Trie Implementation
   Author: Peter Gammie &lt; peteg42 at gmail dot com &gt;
*)</span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Trie2 <span class="keyword2"><span class="keyword">imports</span></span>
  <a href="#MapOps">MapOps</a>
  <a href="#ODList">ODList</a>
  <a href="../../trie/theories/#Trie">Trie.Trie</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">trie_update_with</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'key</span> list <span class="main">⇒</span> <span class="tfree">'val</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'val</span> <span class="main">⇒</span> <span class="tfree">'val</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'key</span><span class="main">,</span> <span class="tfree">'val</span><span class="main">)</span> trie <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'key</span><span class="main">,</span> <span class="tfree">'val</span><span class="main">)</span> trie"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">trie_update_with</span> <span class="free"><span class="bound"><span class="entity">ks</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> update_with_trie <span class="free"><span class="bound"><span class="entity">ks</span></span></span> <span class="main">(</span><span class="main">%</span><span class="bound">vo</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">(</span><span class="keyword1">case</span> <span class="bound">vo</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">|</span> Some <span class="bound">v</span> <span class="main">⇒</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"trie_update_with <span class="main">[]</span> <span class="free">v</span> <span class="free">f</span> <span class="main">(</span>Trie <span class="free">vo</span> <span class="free">ts</span><span class="main">)</span> <span class="main">=</span>
    Trie <span class="main">(</span>Some <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">vo</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="free">v</span> <span class="main">|</span> Some <span class="bound">v'</span> <span class="main">⇒</span> <span class="bound">v'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">ts</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> trie_update_with_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"trie_update_with <span class="main">(</span><span class="free">k</span><span class="main">#</span><span class="free">ks</span><span class="main">)</span> <span class="free">v</span> <span class="free">f</span> <span class="main">(</span>Trie <span class="free">vo</span> <span class="free">ts</span><span class="main">)</span> <span class="main">=</span>
    Trie <span class="free">vo</span> <span class="main">(</span>AList.update_with_aux empty_trie <span class="free">k</span> <span class="main">(</span>trie_update_with <span class="free">ks</span> <span class="free">v</span> <span class="free">f</span><span class="main">)</span> <span class="free">ts</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> trie_update_with_def empty_trie_def<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">trie_update_with'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'k</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'k</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> trie <span class="main">⇒</span> <span class="tfree">'v</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'v</span> <span class="main">⇒</span> <span class="tfree">'v</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'k</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> trie"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">trie_update_with'</span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">k</span> <span class="bound">m</span> <span class="bound">v</span> <span class="bound">f</span><span class="main">.</span> trie_update_with <span class="bound">k</span> <span class="bound">v</span> <span class="bound">f</span> <span class="bound">m</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">trie_update</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'key</span> list <span class="main">⇒</span> <span class="tfree">'val</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'key</span><span class="main">,</span> <span class="tfree">'val</span><span class="main">)</span> trie <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'key</span><span class="main">,</span> <span class="tfree">'val</span><span class="main">)</span> trie"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">trie_update</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> trie_update_with <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">v'</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">trie_lookup</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1" id="Trie2-lookup_empty_trie"><span class="command">lemma</span></span> lookup_empty_trie <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lookup_trie empty_trie <span class="free">ks</span> <span class="main">=</span> None"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ks</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1" id="Trie2-lookup_trie_update_with"><span class="command">lemma</span></span> lookup_trie_update_with<span class="main">:</span>
  <span class="quoted"><span class="quoted">"lookup_trie <span class="main">(</span>trie_update_with <span class="free">ks</span> <span class="free">v</span> <span class="free">f</span> <span class="free">t</span><span class="main">)</span> <span class="free">ks'</span>
 <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">ks</span> <span class="main">=</span> <span class="free">ks'</span> <span class="keyword1">then</span> Some <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="keyword1">case</span> lookup_trie <span class="free">t</span> <span class="free">ks</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="free">v</span> <span class="main">|</span> Some <span class="bound">v'</span> <span class="main">⇒</span> <span class="bound">v'</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> lookup_trie <span class="free">t</span> <span class="free">ks'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ks</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">%</span><span class="bound">vo</span><span class="main">.</span> <span class="free">f</span><span class="main">(</span><span class="keyword1">case</span> <span class="bound">vo</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="free">v</span> <span class="main">|</span> Some <span class="bound">v</span> <span class="main">⇒</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">ks'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> update_with_trie.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">v</span> <span class="skolem">ps</span> <span class="skolem">vo</span> <span class="skolem">ks'</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> neq_Nil_conv <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> not_sym<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">k</span> <span class="skolem">ks</span> <span class="skolem">v</span> <span class="skolem">ps</span> <span class="skolem">vo</span> <span class="skolem">ks'</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ks'</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_of_update_with_aux <span class="quoted">"2"</span> empty_trie_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Trie2-lookup_trie_update"><span class="command">lemma</span></span> lookup_trie_update<span class="main">:</span>
  <span class="quoted"><span class="quoted">"lookup_trie <span class="main">(</span>trie_update <span class="free">ks</span> <span class="free">v</span> <span class="free">t</span><span class="main">)</span> <span class="free">ks'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">ks</span> <span class="main">=</span> <span class="free">ks'</span> <span class="keyword1">then</span> Some <span class="free">v</span> <span class="keyword1">else</span> lookup_trie <span class="free">t</span> <span class="free">ks'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> trie_update_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_trie_update_with<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"MapOps"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">trie_MapOps</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'k</span><span class="main">,</span> <span class="tfree">'e</span><span class="main">)</span> trie<span class="main">,</span> <span class="tfree">'k</span> list<span class="main">,</span> <span class="tfree">'e</span><span class="main">)</span> MapOps"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">trie_MapOps</span> <span class="main">≡</span>
     <span class="main">⦇</span> MapOps.empty <span class="main">=</span> empty_trie<span class="main">,</span>
       lookup <span class="main">=</span> lookup_trie<span class="main">,</span>
       update <span class="main">=</span> trie_update <span class="main">⦈</span>"</span></span>

<span class="keyword1" id="Trie2-trie_MapOps"><span class="command">lemma</span></span> trie_MapOps<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"inj_on <span class="free">α</span> <span class="main">{</span> <span class="bound">x</span> <span class="main">.</span> <span class="free">α</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">d</span> <span class="main">}</span> <span class="main">⟹</span> MapOps <span class="free">α</span> <span class="free">d</span> trie_MapOps"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
  <span class="keyword1"><span class="command">unfolding</span></span> trie_MapOps_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> inj_onD <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_trie_update<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">trie_odlist_lookup</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">M</span><span class="main">.</span> lookup_trie <span class="bound">M</span> <span class="main">∘</span> toList<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">trie_odlist_update</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">k</span> <span class="bound">v</span><span class="main">.</span> trie_update <span class="main">(</span>toList <span class="bound">k</span><span class="main">)</span> <span class="bound">v</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">trie_odlist_update_with</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'k</span> <span class="main">::</span> linorder<span class="main">)</span> odlist <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'k</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> trie <span class="main">⇒</span> <span class="tfree">'v</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'v</span> <span class="main">⇒</span> <span class="tfree">'v</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'k</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> trie"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">trie_odlist_update_with</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">k</span> <span class="bound">m</span> <span class="bound">v</span> <span class="bound">f</span><span class="main">.</span> trie_update_with <span class="main">(</span>toList <span class="bound">k</span><span class="main">)</span> <span class="bound">v</span> <span class="bound">f</span> <span class="bound">m</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">trie_odlist_MapOps</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'k</span><span class="main">,</span> <span class="tfree">'e</span><span class="main">)</span> trie<span class="main">,</span> <span class="main">(</span><span class="tfree">'k</span> <span class="main">::</span>linorder<span class="main">)</span> odlist<span class="main">,</span> <span class="tfree">'e</span><span class="main">)</span> MapOps"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">trie_odlist_MapOps</span> <span class="main">≡</span>
     <span class="main">⦇</span> MapOps.empty <span class="main">=</span> empty_trie<span class="main">,</span>
       lookup <span class="main">=</span> trie_odlist_lookup<span class="main">,</span>
       update <span class="main">=</span> trie_odlist_update <span class="main">⦈</span>"</span></span>

<span class="keyword1" id="Trie2-trie_odlist_MapOps"><span class="command">lemma</span></span> trie_odlist_MapOps<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"inj_on <span class="free">α</span> <span class="main">{</span> <span class="bound">x</span> <span class="main">.</span> <span class="free">α</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">d</span> <span class="main">}</span> <span class="main">⟹</span> MapOps <span class="free">α</span> <span class="free">d</span> trie_odlist_MapOps"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
  <span class="keyword1"><span class="command">unfolding</span></span> trie_odlist_MapOps_def trie_odlist_lookup_def trie_odlist_update_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> inj_onD <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_trie_update<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="ClockView">
<div class="head">
<h1>Theory ClockView</h1>
</div>
<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="comment1">(*
 * Knowledge-based programs.
 * (C)opyright 2011, Peter Gammie, peteg42 at gmail.com.
 * License: BSD
 *)</span>

<span class="keyword1"><span class="command">theory</span></span> ClockView
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="#KBPsAlg">KBPsAlg</a>
  <a href="#Eval">Eval</a>
  <a href="#List_local">List_local</a>
  <a href="#ODList">ODList</a>
  <a href="#Trie2">Trie2</a>
  <span class="quoted">"<a href="../Transitive-Closure/Transitive_Closure_List_Impl.html">Transitive-Closure.Transitive_Closure_List_Impl</a>"</span>
  <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Mapping.html">HOL-Library.Mapping</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹The Clock View›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

\label{sec:kbps-theory-clock-view}

The \emph{clock view} records the current time and the observation for
the most recent state:

›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> Environment<span class="main">)</span>
  <span class="entity">clock_jview</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">,</span> nat <span class="main">×</span> <span class="tfree">'obs</span><span class="main">)</span> JointView"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">clock_jview</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">a</span> <span class="bound">t</span><span class="main">.</span> <span class="main">(</span>tLength <span class="bound">t</span><span class="main">,</span> <span class="free">envObs</span> <span class="bound">a</span> <span class="main">(</span>tLast <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1"><span class="command">context</span></span> Environment
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="ClockView-clock_jview_tInit"><span class="command">lemma</span></span> clock_jview_tInit<span class="main">:</span>
  <span class="quoted"><span class="quoted">"clock_jview <span class="free">a</span> <span class="main">(</span>tInit <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="free">envObs</span> <span class="free">a</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> clock_jview_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="ClockView-clock_jview_tStep"><span class="command">lemma</span></span> clock_jview_tStep<span class="main">:</span>
  <span class="quoted"><span class="quoted">"clock_jview <span class="free">a</span> <span class="main">(</span><span class="free">t</span> <span class="main">↝</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Suc <span class="main">(</span>tLength <span class="free">t</span><span class="main">)</span><span class="main">,</span> <span class="free">envObs</span> <span class="free">a</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> clock_jview_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="ClockView-clock_jview_tStepI"><span class="command">lemma</span></span> clock_jview_tStepI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> tLength <span class="free">t</span> <span class="main">=</span> Suc <span class="free">n</span><span class="main">;</span> <span class="free">envObs</span> <span class="free">a</span> <span class="main">(</span>tLast <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">obs</span> <span class="main">⟧</span>
     <span class="main">⟹</span> clock_jview <span class="free">a</span> <span class="free">t</span> <span class="main">=</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">,</span> <span class="free">obs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> clock_jview_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="ClockView-clock_jview_inv"><span class="command">lemma</span></span> clock_jview_inv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"clock_jview <span class="free">a</span> <span class="free">t</span> <span class="main">=</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="free">obs</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">envObs</span> <span class="free">a</span> <span class="main">(</span>tLast <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">obs</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> clock_jview_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemmas</span></span> clock_jview_simps <span class="main">=</span>
  clock_jview_tInit
  clock_jview_tStep
  clock_jview_inv

<span class="keyword1" id="ClockView-clock_jview_eq_inv"><span class="command">lemma</span></span> clock_jview_eq_inv<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"clock_jview <span class="free">a</span> <span class="free">t'</span> <span class="main">=</span> clock_jview <span class="free">a</span> <span class="free">t</span>
    <span class="main">⟷</span> tLength <span class="free">t'</span> <span class="main">=</span> tLength <span class="free">t</span> <span class="main">∧</span> <span class="free">envObs</span> <span class="free">a</span> <span class="main">(</span>tLast <span class="free">t'</span><span class="main">)</span> <span class="main">=</span> <span class="free">envObs</span> <span class="free">a</span> <span class="main">(</span>tLast <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> clock_jview_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span><span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

This is the least-information synchronous view, given the requirements
of \S\ref{sec:kbps-views}. We show that finite-state implementations
exist for all environments with respect to this view as per
\citet{Ron:1996}.

The corresponding incremental view simply increments the counter
records the new observation.

›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> Environment<span class="main">)</span>
  <span class="entity">clock_jviewInit</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'obs</span> <span class="main">⇒</span> nat <span class="main">×</span> <span class="tfree">'obs</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">clock_jviewInit</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">a</span> <span class="bound">obs</span><span class="main">.</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="bound">obs</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> Environment<span class="main">)</span>
  <span class="entity">clock_jviewIncr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'obs</span> <span class="main">⇒</span> nat <span class="main">×</span> <span class="tfree">'obs</span> <span class="main">⇒</span> nat <span class="main">×</span> <span class="tfree">'obs</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">clock_jviewIncr</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">a</span> <span class="bound">obs'</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">obs</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">l</span> <span class="main">+</span> <span class="main">1</span><span class="main">,</span> <span class="bound">obs'</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

It is straightforward to demonstrate the assumptions of the
incremental environment locale (\S\ref{sec:kbps-environments}) with
respect to an arbitrary environment.

›</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> Environment
        <span class="main">&lt;</span> Clock<span class="main">:</span> IncrEnvironment <span class="quoted"><span class="free">jkbp</span></span> <span class="quoted"><span class="free">envInit</span></span> <span class="quoted"><span class="free">envAction</span></span> <span class="quoted"><span class="free">envTrans</span></span> <span class="quoted"><span class="free">envVal</span></span>
                        <span class="quoted">clock_jview</span> <span class="quoted"><span class="free">envObs</span></span> <span class="quoted">clock_jviewInit</span> <span class="quoted">clock_jviewIncr</span>
<span class="comment1">(*&lt;*)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> clock_jviewInit_def clock_jviewIncr_def clock_jview_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

As we later show, satisfaction of a formula at a trace <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>t ∈
Clock.jkbpC<span class="hidden">⇘</span><sub>n</sub><span class="hidden">⇙</span>›</span></span></span></span> is determined by the set of final states of traces in
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Clock.jkbpCn›</span></span></span></span>:

›</span></span>

<span class="keyword1"><span class="command">context</span></span> Environment
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">clock_commonAbs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> Trace <span class="main">⇒</span> <span class="tfree">'s</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">clock_commonAbs</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> tLast <span class="main">`</span> Clock.jkbpCn <span class="main">(</span>tLength <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

Intuitively this set contains the states that the agents commonly
consider possible at time <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">n</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, which is sufficient for
determining knowledge as the clock view ignores paths. Therefore we
can simulate trace <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">t</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> by pairing this abstraction of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="free">t</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> with its final state:

›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> -<span class="main">)</span> <span class="tfree">'s</span> clock_simWorlds <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> set <span class="main">×</span> <span class="tfree">'s</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">clock_sim</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> Trace <span class="main">⇒</span> <span class="tfree">'s</span> clock_simWorlds"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">clock_sim</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span>clock_commonAbs <span class="bound">t</span><span class="main">,</span> tLast <span class="bound">t</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

In the Kripke structure for our simulation, we relate worlds for
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">a</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> if the sets of commonly-held states coincide, and the
observation of the final states of the traces is the
same. Propositions are evaluated at the final state.

›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">clock_simRels</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> clock_simWorlds Relation"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">clock_simRels</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">{</span> <span class="main">(</span><span class="main">(</span><span class="bound">X</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">X'</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span><span class="bound">X</span> <span class="bound">X'</span> <span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span>
                          <span class="bound">X</span> <span class="main">=</span> <span class="bound">X'</span> <span class="main">∧</span> <span class="main">{</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">}</span> <span class="main">⊆</span> <span class="bound">X</span> <span class="main">∧</span> <span class="free">envObs</span> <span class="bound">a</span> <span class="bound">s</span> <span class="main">=</span> <span class="free">envObs</span> <span class="bound">a</span> <span class="bound">s'</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">clock_simVal</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> clock_simWorlds <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">clock_simVal</span> <span class="main">≡</span> <span class="free">envVal</span> <span class="main">∘</span> snd"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">clock_simMC</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'s</span> clock_simWorlds<span class="main">)</span> KripkeStructure"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">clock_simMC</span> <span class="main">≡</span> mkKripke <span class="main">(</span>clock_sim <span class="main">`</span> Clock.jkbpC<span class="main">)</span> clock_simRels clock_simVal"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1" id="ClockView-clock_simVal_def2"><span class="command">lemma</span></span> clock_simVal_def2<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"clock_simVal <span class="main">(</span>clock_sim <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">envVal</span> <span class="main">(</span>tLast <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> clock_sim_def clock_simVal_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="ClockView-clock_sim_range"><span class="command">lemma</span></span> clock_sim_range<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sim_range Clock.MC clock_simMC clock_sim"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sim_rangeI<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> clock_sim_def<span class="main">)</span>

<span class="keyword1" id="ClockView-clock_simVal"><span class="command">lemma</span></span> clock_simVal<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sim_val Clock.MC clock_simMC clock_sim"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sim_valI<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> clock_simVal_def clock_sim_def<span class="main">)</span>

<span class="keyword1" id="ClockView-clock_sim_f"><span class="command">lemma</span></span> clock_sim_f<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sim_f Clock.MC clock_simMC clock_sim"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sim_fI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> clock_simRels_def clock_sim_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> imageI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> imageI<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Clock.mkM_simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">v</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> image_eqI<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="ClockView-clock_sim_r"><span class="command">lemma</span></span> clock_sim_r<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sim_r Clock.MC clock_simMC clock_sim"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sim_rI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> clock_simRels_def clock_sim_def <span class="quasi_keyword">cong</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> image_cong_simp<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">xa</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> Clock.mkM_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

That this is in fact a simulation
(\S\ref{sec:kripke-theory-simulations}) is entirely straightforward.

›</span></span>

<span class="keyword1" id="ClockView-clock_sim"><span class="command">lemma</span></span> clock_sim<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sim Clock.MC clock_simMC clock_sim"</span></span>
<span class="comment1">(*&lt;*)</span>
  <span class="keyword1"><span class="command">using</span></span> clock_sim_range clock_simVal clock_sim_f clock_sim_r
  <span class="keyword1"><span class="command">unfolding</span></span> sim_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context Environment *)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>SimIncrEnvironment›</span></span></span></span> of
\S\ref{sec:kbps-theory-automata-env-sims} only requires that we
provide it an <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Environment"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and a simulation.

›</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> Environment
        <span class="main">&lt;</span> Clock<span class="main">:</span> SimIncrEnvironment <span class="quoted"><span class="free">jkbp</span></span> <span class="quoted"><span class="free">envInit</span></span> <span class="quoted"><span class="free">envAction</span></span> <span class="quoted"><span class="free">envTrans</span></span> <span class="quoted"><span class="free">envVal</span></span>
                  <span class="quoted">clock_jview</span> <span class="quoted"><span class="free">envObs</span></span> <span class="quoted">clock_jviewInit</span> <span class="quoted">clock_jviewIncr</span>
                  <span class="quoted">clock_sim</span> <span class="quoted">clock_simRels</span> <span class="quoted">clock_simVal</span>
<span class="comment1">(*&lt;*)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> clock_sim<span class="main">)</span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

We next consider algorithmic issues.

›</span></span>

<span class="comment1">(* **************************************** *)</span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Representations›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

\label{sec:kbps-theory-clock-view-rep}

We now turn to the issue of how to represent equivalence classes of
states. As these are used as map keys, it is easiest to represent them
canonically. A simple approach is to use \emph{ordered distinct lists}
of type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'a</span></span> odlist"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> for the sets and \emph{tries} for the
maps. Therefore we ask that environment states <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'s</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> belong to
the class <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>linorder›</span></span></span></span> of linearly-ordered types, and moreover
that the set <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>agents›</span></span></span></span> be effectively presented. We introduce a
new locale capturing these requirements:

›</span></span>

<span class="keyword1"><span class="command">locale</span></span> FiniteLinorderEnvironment <span class="main">=</span>
  Environment <span class="quoted"><span class="free">jkbp</span></span> <span class="quoted"><span class="free">envInit</span></span> <span class="quoted"><span class="free">envAction</span></span> <span class="quoted"><span class="free">envTrans</span></span> <span class="quoted"><span class="free">envVal</span></span> <span class="quoted"><span class="free">envObs</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">jkbp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>finite<span class="main">,</span> linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'aAct</span><span class="main">)</span> JKBP"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">envInit</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">::</span><span class="main">{</span>finite<span class="main">,</span> linorder<span class="main">}</span><span class="main">)</span> list"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">envAction</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'eAct</span> list"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">envTrans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'eAct</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'aAct</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">envVal</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">envObs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'obs</span>"</span></span>
<span class="main">+</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">agents</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> odlist"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> agents<span class="main">:</span> <span class="quoted"><span class="quoted">"ODList.toSet <span class="free">agents</span> <span class="main">=</span> UNIV"</span></span>

<span class="keyword1"><span class="command">context</span></span> FiniteLinorderEnvironment
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

\label{sec:kbps-theory-clock-view-algops}

For a fixed agent <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">a</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, we can reduce the number of worlds in
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"clock_simMC"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> by taking its quotient with respect to the
equivalence relation for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">a</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. In other words, we represent a
simulated equivalence class by a pair of the set of all states
reachable at a particular time, and the subset of these that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="free">a</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> considers possible. The worlds in our representational Kripke
structure are therefore a pair of ordered, distinct lists:

›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> -<span class="main">)</span> <span class="tfree">'s</span> clock_simWorldsRep <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> odlist <span class="main">×</span> <span class="tfree">'s</span> odlist"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

We can readily abstract a representation to a set of simulated
equivalence classes:

›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> -<span class="main">)</span>
  <span class="entity">clock_simAbs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span><span class="main">::</span>linorder clock_simWorldsRep <span class="main">⇒</span> <span class="tfree">'s</span> clock_simWorlds set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">clock_simAbs</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">≡</span> <span class="main">{</span> <span class="main">(</span>ODList.toSet <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">|</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> ODList.toSet <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

Assuming <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">X</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> represents a simulated equivalence class for
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">t</span></span> <span class="main"><span class="main">∈</span></span> <span class="free"><span class="free">jkbpC</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"clock_simAbs <span class="free"><span class="free">X</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> decomposes into these
two functions:

›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">agent_abs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> Trace <span class="main">⇒</span> <span class="tfree">'s</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">agent_abs</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span>
     <span class="main">{</span> tLast <span class="bound">t'</span> <span class="main">|</span><span class="bound">t'</span><span class="main">.</span> <span class="bound">t'</span> <span class="main">∈</span> Clock.jkbpC <span class="main">∧</span> clock_jview <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">t'</span> <span class="main">=</span> clock_jview <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">common_abs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> Trace <span class="main">⇒</span> <span class="tfree">'s</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">common_abs</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> tLast <span class="main">`</span> Clock.jkbpCn <span class="main">(</span>tLength <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1" id="ClockView-aec_refl"><span class="command">lemma</span></span> aec_refl<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> Clock.jkbpC <span class="main">⟹</span> tLast <span class="free">t</span> <span class="main">∈</span> agent_abs <span class="free">a</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> agent_abs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="ClockView-aec_cec_subset"><span class="command">lemma</span></span> aec_cec_subset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> Clock.jkbpC"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> aec<span class="main">:</span> <span class="quoted"><span class="quoted">"ODList.toSet <span class="free">aec</span> <span class="main">=</span> agent_abs <span class="free">a</span> <span class="free">t</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> cec<span class="main">:</span> <span class="quoted"><span class="quoted">"ODList.toSet <span class="free">cec</span> <span class="main">=</span> common_abs <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> ODList.toSet <span class="free">aec</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> ODList.toSet <span class="free">cec</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">unfolding</span></span> agent_abs_def common_abs_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="ClockView-clock_simAbs_refl"><span class="command">lemma</span></span> clock_simAbs_refl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> Clock.jkbpC"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> ec<span class="main">:</span> <span class="quoted"><span class="quoted">"clock_simAbs <span class="free">ec</span> <span class="main">=</span> Clock.sim_equiv_class <span class="free">a</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"clock_sim <span class="free">t</span> <span class="main">∈</span> clock_simAbs <span class="free">ec</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="ClockView-common_abs"><span class="command">lemma</span></span> common_abs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> Clock.jkbpC"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ec<span class="main">:</span> <span class="quoted"><span class="quoted">"clock_simAbs <span class="free">ec</span> <span class="main">=</span> Clock.sim_equiv_class <span class="free">a</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ODList.toSet <span class="main">(</span>fst <span class="free">ec</span><span class="main">)</span> <span class="main">=</span> common_abs <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> tC clock_simAbs_refl<span class="main">[</span><span class="operator">OF</span> tC ec<span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> clock_sim_def clock_simAbs_def common_abs_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ODList.toSet_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="ClockView-agent_abs"><span class="command">lemma</span></span> agent_abs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> Clock.jkbpC"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ec<span class="main">:</span> <span class="quoted"><span class="quoted">"clock_simAbs <span class="free">ec</span> <span class="main">=</span> Clock.sim_equiv_class <span class="free">a</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ODList.toSet <span class="main">(</span>snd <span class="free">ec</span><span class="main">)</span> <span class="main">=</span> agent_abs <span class="free">a</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">unfolding</span></span> clock_sim_def clock_simAbs_def agent_abs_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ODList.toSet <span class="main">(</span>fst <span class="free">ec</span><span class="main">)</span><span class="main">,</span> <span class="improper">x</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">(</span>ODList.toSet <span class="main">(</span>fst <span class="free">ec</span><span class="main">)</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">|</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> ODList.toSet <span class="main">(</span>snd <span class="free">ec</span><span class="main">)</span><span class="main">}</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="comment1">(* FIXME filthy *)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

This representation is canonical on the domain of interest (though not
in general):

›</span></span>

<span class="keyword1" id="ClockView-clock_simAbs_inj_on"><span class="command">lemma</span></span> clock_simAbs_inj_on<span class="main">:</span>
  <span class="quoted"><span class="quoted">"inj_on clock_simAbs <span class="main">{</span> <span class="bound">x</span> <span class="main">.</span> clock_simAbs <span class="bound">x</span> <span class="main">∈</span> Clock.jkbpSEC <span class="main">}</span>"</span></span>
<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> inj_onI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
  <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span> <span class="bound">x</span> <span class="main">.</span> clock_simAbs <span class="bound">x</span> <span class="main">∈</span> Clock.jkbpSEC <span class="main">}</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="main">{</span> <span class="bound">x</span> <span class="main">.</span> clock_simAbs <span class="bound">x</span> <span class="main">∈</span> Clock.jkbpSEC <span class="main">}</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> xy<span class="main">:</span> <span class="quoted"><span class="quoted">"clock_simAbs <span class="skolem">x</span> <span class="main">=</span> clock_simAbs <span class="skolem">y</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> x <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">t</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> tC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> Clock.jkbpC"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> ec<span class="main">:</span> <span class="quoted"><span class="quoted">"clock_simAbs <span class="skolem">x</span> <span class="main">=</span> Clock.sim_equiv_class <span class="skolem">a</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> common_abs<span class="main">[</span><span class="operator">OF</span> tC ec<span class="main">]</span> common_abs<span class="main">[</span><span class="operator">OF</span> tC trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> xy<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> ec<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">x</span> <span class="main">=</span> fst <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> injD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> toSet_inj<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> agent_abs<span class="main">[</span><span class="operator">OF</span> tC ec<span class="main">]</span> agent_abs<span class="main">[</span><span class="operator">OF</span> tC trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> xy<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> ec<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">x</span> <span class="main">=</span> snd <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> injD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> toSet_inj<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod_eqI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

We could further compress this representation by labelling each
element of the set of states reachable at time $n$ with a bit to
indicate whether the agent considers that state possible.  Note,
however, that the representation would be non-canonical: if <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>(s, True)›</span></span></span></span> is in the representation, indicating that the agent
considers <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>s›</span></span></span></span> possible, then <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>(s, False)›</span></span></span></span> may or may
not be. The associated abstraction function is not injective and hence
would obfuscate the following. Repairing this would entail introducing
a new type, which would again complicate this development.



The following lemmas make use of this Kripke structure, constructed
from the set of final states of a temporal slice <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">X</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>:

›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">clock_repRels</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">×</span> <span class="tfree">'s</span><span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">clock_repRels</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">{</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span> <span class="free">envObs</span> <span class="bound">a</span> <span class="bound">s</span> <span class="main">=</span> <span class="free">envObs</span> <span class="bound">a</span> <span class="bound">s'</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">clock_repMC</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> KripkeStructure"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">clock_repMC</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">X</span><span class="main">.</span> mkKripke <span class="bound">X</span> clock_repRels <span class="free">envVal</span>"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1" id="ClockView-clock_repMC_kripke"><span class="command">lemma</span></span> clock_repMC_kripke<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"kripke <span class="main">(</span>clock_repMC <span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> kripkeI<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1" id="ClockView-clock_repMC_S5n"><span class="command">lemma</span></span> clock_repMC_S5n<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"S5n <span class="main">(</span>clock_repMC <span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> clock_repRels_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> S5nI equivI refl_onI symI transI<span class="main">)</span> <span class="operator">auto</span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

We can show that this Kripke structure retains sufficient information
from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Clock.MCS"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> by showing simulation. This is eased by
introducing an intermediary structure that focusses on a particular
trace:

›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">clock_jkbpCSt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> Trace <span class="main">⇒</span> <span class="tfree">'s</span> clock_simWorlds set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">clock_jkbpCSt</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> clock_sim <span class="main">`</span> Clock.jkbpCn <span class="main">(</span>tLength <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">clock_simMCt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> Trace <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'s</span> clock_simWorlds<span class="main">)</span> KripkeStructure"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">clock_simMCt</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> mkKripke <span class="main">(</span>clock_jkbpCSt <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> clock_simRels clock_simVal"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">clock_repSim</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> clock_simWorlds <span class="main">⇒</span> <span class="tfree">'s</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">clock_repSim</span> <span class="main">≡</span> snd"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1" id="ClockView-jkbpCSt_jkbpCS_subset"><span class="command">lemma</span></span> jkbpCSt_jkbpCS_subset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"clock_jkbpCSt <span class="free">t</span> <span class="main">⊆</span> clock_sim <span class="main">`</span> Clock.jkbpC"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="ClockView-jkbpCSt_refl"><span class="command">lemma</span></span> jkbpCSt_refl<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> Clock.jkbpC <span class="main">⟹</span> clock_sim <span class="free">t</span> <span class="main">∈</span> clock_jkbpCSt <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="ClockView-fst_clock_sim"><span class="command">lemma</span></span> fst_clock_sim<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> Clock.jkbpC <span class="main">⟹</span> fst <span class="main">(</span>clock_sim <span class="free">t</span><span class="main">)</span> <span class="main">=</span> tLast <span class="main">`</span> Clock.jkbpCn <span class="main">(</span>tLength <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> clock_sim_def<span class="main">)</span>

<span class="keyword1" id="ClockView-clock_repSim_simps"><span class="command">lemma</span></span> clock_repSim_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"clock_repSim <span class="main">`</span> clock_sim <span class="main">`</span> <span class="free">T</span> <span class="main">=</span> tLast <span class="main">`</span> <span class="free">T</span>"</span></span>
  <span class="quoted"><span class="quoted">"clock_repSim <span class="main">(</span>clock_sim <span class="free">t</span><span class="main">)</span> <span class="main">=</span> tLast <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> clock_repSim_def clock_sim_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> image_eqI<span class="main">)</span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹›</span></span>

<span class="keyword1" id="ClockView-clock_repSim"><span class="command">lemma</span></span> clock_repSim<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> Clock.jkbpC"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sim <span class="main">(</span>clock_simMCt <span class="free">t</span><span class="main">)</span>
             <span class="main">(</span><span class="main">(</span>clock_repMC <span class="main">∘</span> fst<span class="main">)</span> <span class="main">(</span>clock_sim <span class="free">t</span><span class="main">)</span><span class="main">)</span>
             clock_repSim"</span></span>
<span class="comment1">(*&lt;*)</span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"sim <span class="var">?M</span> <span class="var">?M'</span> <span class="var">?f</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sim_range <span class="var">?M</span> <span class="var">?M'</span> <span class="var">?f</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"worlds <span class="var">?M'</span> <span class="main">=</span> <span class="var">?f</span> <span class="main">`</span> worlds <span class="var">?M</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> clock_sim_def clock_repSim_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"relations <span class="var">?M'</span> <span class="skolem">a</span> <span class="main">⊆</span> worlds <span class="var">?M'</span> <span class="main">×</span> worlds <span class="var">?M'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> clock_sim_def clock_repSim_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sim_val <span class="var">?M</span> <span class="var">?M'</span> <span class="var">?f</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> clock_sim_def clock_simVal_def clock_repSim_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sim_f <span class="var">?M</span> <span class="var">?M'</span> <span class="var">?f</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command">unfolding</span></span> clock_repRels_def clock_repSim_def clock_simRels_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> clock_sim_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sim_r <span class="var">?M</span> <span class="var">?M'</span> <span class="var">?f</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command">unfolding</span></span> clock_repRels_def clock_repSim_def clock_simRels_def clock_sim_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The following sections show how we satisfy the remaining requirements
of the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Algorithm›</span></span></span></span> locale of
Figure~\ref{fig:kbps-alg-alg-locale}. Where the proof is routine, we
simply present the lemma without proof or comment.

Due to a limitation in the code generator in the present version of
Isabelle (2011), we need to define the equations we wish to execute
outside of a locale; the syntax <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>(in -)›</span></span></span></span> achieves this by
making definitons at the theory top-level. We then define (but elide)
locale-local abbreviations that supply the locale-bound variables to
these definitions.

›</span></span>

<span class="comment1">(* **************************************** *)</span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Initial states›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The initial states of the automaton for an agent is simply <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="free">envInit</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> paired with the partition of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">envInit</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> under the
agent's observation.

›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> -<span class="main">)</span>
  <span class="entity">clock_simInit</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">::</span>linorder<span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'obs</span><span class="main">)</span>
                <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'obs</span> <span class="main">⇒</span> <span class="tfree">'s</span> clock_simWorldsRep"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">clock_simInit</span> <span class="free"><span class="bound"><span class="entity">envInit</span></span></span> <span class="free"><span class="bound"><span class="entity">envObs</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">a</span> <span class="bound">iobs</span><span class="main">.</span>
    <span class="keyword1">let</span> <span class="bound">cec</span> <span class="main">=</span> ODList.fromList <span class="free"><span class="bound"><span class="entity">envInit</span></span></span>
     <span class="keyword1">in</span> <span class="main">(</span><span class="bound">cec</span><span class="main">,</span> ODList.filter <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">envObs</span></span></span> <span class="bound">a</span> <span class="bound">s</span> <span class="main">=</span> <span class="bound">iobs</span><span class="main">)</span> <span class="bound">cec</span><span class="main">)</span>"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">clock_simInit</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'obs</span> <span class="main">⇒</span> <span class="tfree">'s</span> clock_simWorldsRep"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">clock_simInit</span> <span class="main">≡</span> ClockView.clock_simInit <span class="free">envInit</span> <span class="free">envObs</span>"</span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹›</span></span>

<span class="keyword1" id="ClockView-clock_simInit"><span class="command">lemma</span></span> clock_simInit<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">iobs</span> <span class="main">∈</span> <span class="free">envObs</span> <span class="free">a</span> <span class="main">`</span> set <span class="free">envInit</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"clock_simAbs <span class="main">(</span>clock_simInit <span class="free">a</span> <span class="free">iobs</span><span class="main">)</span>
       <span class="main">=</span> clock_sim <span class="main">`</span> <span class="main">{</span> <span class="bound"><span class="bound">t'</span></span> <span class="main">∈</span> Clock.jkbpC<span class="main">.</span>
                       clock_jview <span class="free">a</span> <span class="bound">t'</span> <span class="main">=</span> clock_jviewInit <span class="free">a</span> <span class="free">iobs</span> <span class="main">}</span>"</span></span>
<span class="comment1">(*&lt;*)</span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">unfolding</span></span> clock_simInit_def clock_simAbs_def clock_sim_def <span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> Let_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"tInit <span class="improper">s</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> image_eqI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Set.image_def Clock.jviewInit<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">xa</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"tInit <span class="improper">xa</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> image_eqI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> image_eqI <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Clock.jviewInit<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="comment1">(*&gt;*)</span>

<span class="comment1">(* **************************************** *)</span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Simulated observations›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

Agent <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">a</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> will make the same observation at any of the worlds
that it considers possible, so we choose the first one in the list:

›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> -<span class="main">)</span>
  <span class="entity">clock_simObs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">::</span> linorder<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'obs</span><span class="main">)</span>
                <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> clock_simWorldsRep <span class="main">⇒</span> <span class="tfree">'obs</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">clock_simObs</span> <span class="free"><span class="bound"><span class="entity">envObs</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">envObs</span></span></span> <span class="bound">a</span> <span class="main">∘</span> ODList.hd <span class="main">∘</span> snd"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">clock_simObs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> clock_simWorldsRep <span class="main">⇒</span> <span class="tfree">'obs</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">clock_simObs</span> <span class="main">≡</span> ClockView.clock_simObs <span class="free">envObs</span>"</span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹›</span></span>

<span class="keyword1" id="ClockView-clock_simObs"><span class="command">lemma</span></span> clock_simObs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> Clock.jkbpC"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> ec<span class="main">:</span> <span class="quoted"><span class="quoted">"clock_simAbs <span class="free">ec</span> <span class="main">=</span> Clock.sim_equiv_class <span class="free">a</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"clock_simObs <span class="free">a</span> <span class="free">ec</span> <span class="main">=</span> <span class="free">envObs</span> <span class="free">a</span> <span class="main">(</span>tLast <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="main">∈</span> set <span class="main">(</span>toList <span class="main">(</span>snd <span class="free">ec</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="free">envObs</span> <span class="free">a</span> <span class="bound">s</span> <span class="main">=</span> <span class="free">envObs</span> <span class="free">a</span> <span class="main">(</span>tLast <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> agent_abs<span class="main">[</span><span class="operator">OF</span> tC ec<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> agent_abs_def toSet_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"tLast <span class="free">t</span> <span class="main">∈</span> set <span class="main">(</span>toList <span class="main">(</span>snd <span class="free">ec</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> clock_simAbs_refl<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> clock_simAbs_def clock_sim_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> toSet_def snd_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> clock_simObs_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_choose_hd<span class="main"><span class="main">[</span></span><span class="operator">OF</span> A B<span class="main"><span class="main">]</span></span> ODList.hd_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="comment1">(* **************************************** *)</span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Evaluation›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

\label{sec:kbps-theory-clock-view-eval}

We define our <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>eval›</span></span></span></span> function in terms of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"evalS"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
which implements boolean logic over <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'s</span></span> odlist"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> in the usual
way -- see \S\ref{sec:kbps-spr-single-agent-eval} for the relevant
clauses. It requires three functions specific to the representation:
one each for propositions, knowledge and common knowledge.

Propositions define subsets of the worlds considered possible:

›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> -<span class="main">)</span>
  <span class="entity">clock_evalProp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'s</span><span class="main">::</span>linorder<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> bool<span class="main">)</span>
                  <span class="main">⇒</span> <span class="tfree">'s</span> odlist <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> <span class="tfree">'s</span> odlist"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">clock_evalProp</span> <span class="free"><span class="bound"><span class="entity">envVal</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">X</span> <span class="bound">p</span><span class="main">.</span> ODList.filter <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">envVal</span></span></span> <span class="bound">s</span> <span class="bound">p</span><span class="main">)</span> <span class="bound">X</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The knowledge relation computes the subset of the
commonly-held-possible worlds <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>cec›</span></span></span></span> that agent <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">a</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
considers possible at world <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">s</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>:

›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> -<span class="main">)</span>
  <span class="entity">clock_knowledge</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">::</span> linorder<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'obs</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'s</span> odlist
                  <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span> odlist"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">clock_knowledge</span> <span class="free"><span class="bound"><span class="entity">envObs</span></span></span> <span class="free"><span class="bound"><span class="entity">cec</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">a</span> <span class="bound">s</span><span class="main">.</span>
     ODList.filter <span class="main">(</span><span class="main">λ</span><span class="bound">s'</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">envObs</span></span></span> <span class="bound">a</span> <span class="bound">s</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">envObs</span></span></span> <span class="bound">a</span> <span class="bound">s'</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">cec</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹


Similarly the common knowledge operation computes the transitive
closure of the union of the knowledge relations for the agents <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>as›</span></span></span></span>:

›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> -<span class="main">)</span>
  <span class="entity">clock_commonKnowledge</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">::</span> linorder<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'obs</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'s</span> odlist
           <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span> odlist"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">clock_commonKnowledge</span> <span class="free"><span class="bound"><span class="entity">envObs</span></span></span> <span class="free"><span class="bound"><span class="entity">cec</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">as</span> <span class="bound">s</span><span class="main">.</span>
     <span class="keyword1">let</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">λ</span><span class="bound">a</span><span class="main">.</span> ODList.fromList <span class="main">[</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="bound">s''</span><span class="main">)</span> <span class="main">.</span> s' <span class="main">←</span> toList <span class="free"><span class="bound"><span class="entity">cec</span></span></span><span class="main">,</span> s'' <span class="main">←</span> toList <span class="free"><span class="bound"><span class="entity">cec</span></span></span><span class="main">,</span>
                                   <span class="free"><span class="bound"><span class="entity">envObs</span></span></span> <span class="bound">a</span> <span class="bound">s'</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">envObs</span></span></span> <span class="bound">a</span> <span class="bound">s''</span> <span class="main">]</span><span class="main">;</span>
         <span class="bound">R</span> <span class="main">=</span> toList <span class="main">(</span>ODList.big_union <span class="bound">r</span> <span class="bound">as</span><span class="main">)</span>
      <span class="keyword1">in</span> ODList.fromList <span class="main">(</span>memo_list_trancl <span class="bound">R</span> <span class="bound">s</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The function <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>memo_list_trancl›</span></span></span></span> comes from the executable
transitive closure theory of \citep{AFP:TRANCL}.

The evaluation function evaluates a subjective knowledge formula on
the representation of an equivalence class:

›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> -<span class="main">)</span>
  <span class="entity">eval</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'s</span> <span class="main">::</span> linorder<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> bool<span class="main">)</span>
        <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'obs</span><span class="main">)</span>
        <span class="main">⇒</span> <span class="tfree">'s</span> clock_simWorldsRep <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">)</span> Kform <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eval</span> <span class="free"><span class="bound"><span class="entity">envVal</span></span></span> <span class="free"><span class="bound"><span class="entity">envObs</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">cec</span><span class="main">,</span> <span class="bound">aec</span><span class="main">)</span><span class="main">.</span> evalS <span class="main">(</span>clock_evalProp <span class="free"><span class="bound"><span class="entity">envVal</span></span></span><span class="main">)</span>
                                      <span class="main">(</span>clock_knowledge <span class="free"><span class="bound"><span class="entity">envObs</span></span></span> <span class="bound">cec</span><span class="main">)</span>
                                      <span class="main">(</span>clock_commonKnowledge <span class="free"><span class="bound"><span class="entity">envObs</span></span></span> <span class="bound">cec</span><span class="main">)</span>
                                      <span class="bound">aec</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

This function corresponds with the standard semantics:

›</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1" id="ClockView-clock_coEC_relation_image"><span class="command">lemma</span></span> clock_coEC_relation_image<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> ODList.toSet <span class="free">Y</span>
    <span class="main">⟹</span> ODList.toSet <span class="main">(</span>clock_knowledge <span class="free">envObs</span> <span class="free">Y</span> <span class="free">a</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> relations <span class="main">(</span>clock_repMC <span class="main">(</span>ODList.toSet <span class="free">Y</span><span class="main">)</span><span class="main">)</span> <span class="free">a</span> <span class="main">``</span> <span class="main">{</span><span class="free">s</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> clock_knowledge_def clock_repRels_def Image_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="ClockView-clock_commonKnowledge_relation_image_aux"><span class="command">lemma</span></span> clock_commonKnowledge_relation_image_aux<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span>set <span class="free">as</span><span class="main">.</span> <span class="main">⋃</span><span class="bound">a</span><span class="main">∈</span>ODList.toSet <span class="free">Y</span><span class="main">.</span> <span class="main">⋃</span><span class="bound">aa</span><span class="main">∈</span>ODList.toSet <span class="free">Y</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">s''</span><span class="main">.</span> <span class="free">envObs</span> <span class="bound">x</span> <span class="bound">a</span> <span class="main">=</span> <span class="free">envObs</span> <span class="bound">x</span> <span class="bound">s''</span><span class="main">}</span><span class="main">.</span> <span class="main">{</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">aa</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>
 <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">⋃</span><span class="bound">a</span><span class="main">∈</span>set <span class="free">as</span><span class="main">.</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span> <span class="free">envObs</span> <span class="bound">a</span> <span class="bound">s</span> <span class="main">=</span> <span class="free">envObs</span> <span class="bound">a</span> <span class="bound">s'</span><span class="main">}</span><span class="main">)</span> <span class="main">∩</span> ODList.toSet <span class="free">Y</span> <span class="main">×</span> ODList.toSet <span class="free">Y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="ClockView-clock_commonKnowledge_relation_image"><span class="command">lemma</span></span> clock_commonKnowledge_relation_image<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> ODList.toSet <span class="free">Y</span>
    <span class="main">⟹</span> ODList.toSet <span class="main">(</span>clock_commonKnowledge <span class="free">envObs</span> <span class="free">Y</span> <span class="free">as</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">a</span> <span class="main">∈</span> set <span class="free">as</span><span class="main">.</span> relations <span class="main">(</span>clock_repMC <span class="main">(</span>ODList.toSet <span class="free">Y</span><span class="main">)</span><span class="main">)</span> <span class="bound">a</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span> <span class="main">``</span> <span class="main">{</span><span class="free">s</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> clock_commonKnowledge_def clock_repRels_def Let_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> memo_list_trancl toSet_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> Image_def clock_commonKnowledge_relation_image_aux<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="ClockView-eval_rec_models"><span class="command">lemma</span></span> eval_rec_models<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> XY<span class="main">:</span> <span class="quoted"><span class="quoted">"ODList.toSet <span class="free">X</span> <span class="main">⊆</span> ODList.toSet <span class="free">Y</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> ODList.toSet <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> ODList.toSet <span class="main">(</span>eval_rec <span class="main">(</span>clock_evalProp <span class="free">envVal</span><span class="main">)</span> <span class="main">(</span>clock_knowledge <span class="free">envObs</span> <span class="free">Y</span><span class="main">)</span> <span class="main">(</span>clock_commonKnowledge <span class="free">envObs</span> <span class="free">Y</span><span class="main">)</span> <span class="free">X</span> <span class="free">φ</span><span class="main">)</span>
     <span class="main">⟷</span> clock_repMC <span class="main">(</span>ODList.toSet <span class="free">Y</span><span class="main">)</span><span class="main">,</span> <span class="free">s</span> <span class="main">⊨</span> <span class="free">φ</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> XY s
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">X</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Kknows <span class="skolem">a'</span> <span class="skolem">φ</span> <span class="skolem">X</span> <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">∈</span> ODList.toSet <span class="skolem">X</span>›</span></span> clock_coEC_relation_image<span class="main">[</span><span class="operator">OF</span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Kknows<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Kknows<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">a'</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"ODList.toSet"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> odlist_all_iff<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cut_tac</span> s3<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">w'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> X3<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"clock_knowledge <span class="free">envObs</span> <span class="free">Y</span> <span class="skolem">a'</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> Kknows.hyps<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> Kknows<span class="main">(</span>2<span class="main">)</span> Kknows<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S5n_rels_closed<span class="main"><span class="main">[</span></span><span class="operator">OF</span> clock_repMC_S5n<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>3<span class="main"><span class="keyword3">]</span></span>

    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> toSet_eq_iff odlist_all_iff<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> Kknows.hyps<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> Kknows<span class="main">(</span>2<span class="main">)</span> Kknows<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S5n_rels_closed<span class="main"><span class="main">[</span></span><span class="operator">OF</span> clock_repMC_S5n<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Kcknows <span class="skolem">as</span> <span class="skolem">φ</span> <span class="skolem">X</span> <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">=</span> Nil"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">∈</span> ODList.toSet <span class="skolem">X</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">∈</span> ODList.toSet <span class="skolem">X</span>›</span></span> clock_commonKnowledge_relation_image<span class="main">[</span><span class="operator">OF</span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Kcknows<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Kcknows<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> as<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">as</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"ODList.toSet"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> odlist_all_iff<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cut_tac</span> s3<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">w'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> X3<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"clock_commonKnowledge <span class="free">envObs</span> <span class="free">Y</span> <span class="skolem">as</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> Kcknows.hyps<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> Kcknows<span class="main">(</span>2<span class="main">)</span> Kcknows<span class="main">(</span>3<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S5n_rels_closed<span class="main"><span class="main">[</span></span><span class="operator">OF</span> clock_repMC_S5n<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>3<span class="main"><span class="keyword3">]</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> trancl_unfold<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">back</span></span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">back</span></span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">back</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span> <span class="comment1">(* FIXME disgusting *)</span>

      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> toSet_eq_iff odlist_all_iff<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> Kcknows.hyps<span class="main">)</span>
       <span class="keyword1"><span class="command">using</span></span> Kcknows<span class="main">(</span>2<span class="main">)</span> Kcknows<span class="main">(</span>3<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S5n_rels_closed<span class="main"><span class="main">[</span></span><span class="operator">OF</span> clock_repMC_S5n<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> trancl_unfold<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">back</span></span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">back</span></span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">back</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span> <span class="comment1">(* FIXME disgusting *)</span>

      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1" id="ClockView-trc_aux"><span class="command">lemma</span></span> trc_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> Clock.jkbpC"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> aec<span class="main">:</span> <span class="quoted"><span class="quoted">"ODList.toSet <span class="free">aec</span> <span class="main">=</span> agent_abs <span class="free">a</span> <span class="free">t</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> cec<span class="main">:</span> <span class="quoted"><span class="quoted">"ODList.toSet <span class="free">cec</span> <span class="main">=</span> common_abs <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ODList.toSet <span class="main">(</span>big_union <span class="main">(</span>clock_commonKnowledge <span class="free">envObs</span> <span class="free">cec</span> <span class="free">as</span><span class="main">)</span> <span class="main">(</span>toList <span class="free">aec</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> ODList.toSet <span class="free">cec</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> toSet_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> clock_commonKnowledge_relation_image<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> aec_cec_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> tC aec cec<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> trancl_unfold<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> agent_abs_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="ClockView-clock_repMC_aec"><span class="command">lemma</span></span> clock_repMC_aec<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> Clock.jkbpC"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> aec<span class="main">:</span> <span class="quoted"><span class="quoted">"ODList.toSet <span class="free">aec</span> <span class="main">=</span> agent_abs <span class="free">a</span> <span class="free">t</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> cec<span class="main">:</span> <span class="quoted"><span class="quoted">"ODList.toSet <span class="free">cec</span> <span class="main">=</span> common_abs <span class="free">t</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> ODList.toSet <span class="free">aec</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> xy<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> relations <span class="main">(</span>clock_repMC <span class="main">(</span>ODList.toSet <span class="free">cec</span><span class="main">)</span><span class="main">)</span> <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> ODList.toSet <span class="free">aec</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">unfolding</span></span> clock_repRels_def agent_abs_def common_abs_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="ClockView-clock_repMC_cec"><span class="command">lemma</span></span> clock_repMC_cec<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> Clock.jkbpC"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> aec<span class="main">:</span> <span class="quoted"><span class="quoted">"ODList.toSet <span class="free">aec</span> <span class="main">=</span> agent_abs <span class="free">a</span> <span class="free">t</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> cec<span class="main">:</span> <span class="quoted"><span class="quoted">"ODList.toSet <span class="free">cec</span> <span class="main">=</span> common_abs <span class="free">t</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> ODList.toSet <span class="free">aec</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> ODList.toSet <span class="free">aec</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> relations <span class="main">(</span>clock_repMC <span class="main">(</span>ODList.toSet <span class="free">cec</span><span class="main">)</span><span class="main">)</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">unfolding</span></span> clock_repRels_def agent_abs_def common_abs_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="ClockView-evalS_models"><span class="command">lemma</span></span> evalS_models<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> Clock.jkbpC"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> aec<span class="main">:</span> <span class="quoted"><span class="quoted">"ODList.toSet <span class="free">aec</span> <span class="main">=</span> agent_abs <span class="free">a</span> <span class="free">t</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> cec<span class="main">:</span> <span class="quoted"><span class="quoted">"ODList.toSet <span class="free">cec</span> <span class="main">=</span> common_abs <span class="free">t</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> subj_phi<span class="main">:</span> <span class="quoted"><span class="quoted">"subjective <span class="free">a</span> <span class="free">φ</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> ODList.toSet <span class="free">aec</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"evalS <span class="main">(</span>clock_evalProp <span class="free">envVal</span><span class="main">)</span> <span class="main">(</span>clock_knowledge <span class="free">envObs</span> <span class="free">cec</span><span class="main">)</span> <span class="main">(</span>clock_commonKnowledge <span class="free">envObs</span> <span class="free">cec</span><span class="main">)</span> <span class="free">aec</span> <span class="free">φ</span>
     <span class="main">⟷</span> clock_repMC <span class="main">(</span>ODList.toSet <span class="free">cec</span><span class="main">)</span><span class="main">,</span> <span class="free">s</span> <span class="main">⊨</span> <span class="free">φ</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="free">φ</span> <span class="main">=</span> <span class="var">?rhs</span> <span class="free">φ</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">using</span></span> subj_phi s aec cec
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> subjective.induct<span class="main"><span class="main">[</span></span><span class="operator">case_names</span> Kprop Knot Kand Kknows Kcknows<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Kknows <span class="skolem">a</span> <span class="skolem">a'</span> <span class="skolem">ψ</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> toSet_eq_iff<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">w'</span> <span class="main">∈</span> ODList.toSet <span class="free">aec</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> c<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">w'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> subsetD<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eval_rec_models<span class="main"><span class="main">[</span></span><span class="operator">OF</span> subsetI<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> aec_cec_subset<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> tC aec cec<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> clock_repMC_aec<span class="main"><span class="main">[</span></span><span class="operator">OF</span> tC Kknows<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> Kknows<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">s</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command">using</span></span> Kknows
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">using</span></span> Kknows
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eval_rec_models<span class="main"><span class="main">[</span></span><span class="operator">OF</span> subsetI<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> aec_cec_subset<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> tC aec cec<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> tC Kknows
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> agent_abs_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> ballE<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> Kknows
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cut_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"tLast <span class="improper">t'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> y<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"tLast <span class="improper">t'a</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> clock_repMC_cec<span class="main"><span class="main">[</span></span><span class="operator">OF</span> tC Kknows<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> Kknows<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> clock_repRels_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Kcknows <span class="skolem">a</span> <span class="skolem">as</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">(</span>Kcknows <span class="skolem">as</span> <span class="skolem">ψ</span><span class="main">)</span>
      <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span><span class="main">∈</span>ODList.toSet <span class="free">aec</span><span class="main">.</span>
           <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="main">(</span><span class="main">⋃</span><span class="bound">a</span><span class="main">∈</span>set <span class="skolem">as</span><span class="main">.</span> relations <span class="main">(</span>clock_repMC <span class="main">(</span>ODList.toSet <span class="free">cec</span><span class="main">)</span><span class="main">)</span> <span class="bound">a</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span> <span class="main">``</span> <span class="main">{</span><span class="bound">y</span><span class="main">}</span><span class="main">.</span>
              <span class="bound">x</span> <span class="main">∈</span> ODList.toSet <span class="main">(</span>eval_rec <span class="main">(</span>clock_evalProp <span class="free">envVal</span><span class="main">)</span> <span class="main">(</span>clock_knowledge <span class="free">envObs</span> <span class="free">cec</span><span class="main">)</span> <span class="main">(</span>clock_commonKnowledge <span class="free">envObs</span> <span class="free">cec</span><span class="main">)</span>
                       <span class="main">(</span>big_union <span class="main">(</span>clock_commonKnowledge <span class="free">envObs</span> <span class="free">cec</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">(</span>toList <span class="free">aec</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ψ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="comment1">(* FIXME dreaming of a cong rule here. *)</span>
    <span class="keyword1"><span class="command">using</span></span> toSet_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> toSet_eq_iff toSet_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> subset_eq<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ball_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ball_cong<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> clock_commonKnowledge_relation_image<span class="main"><span class="main">[</span></span><span class="operator">OF</span> aec_cec_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> tC Kcknows<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> Kcknows<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span><span class="main">∈</span>ODList.toSet <span class="free">aec</span><span class="main">.</span> clock_repMC <span class="main">(</span>ODList.toSet <span class="free">cec</span><span class="main">)</span><span class="main">,</span> <span class="bound">s</span> <span class="main">⊨</span> Kcknows <span class="skolem">as</span> <span class="skolem">ψ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ball_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ball_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> eval_rec_models<span class="main"><span class="main">[</span></span><span class="operator">OF</span> trc_aux<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> tC Kcknows<span class="main"><span class="main"><span class="main">(</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span> Kcknows<span class="main"><span class="main"><span class="main">(</span></span></span>4<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> as<span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">as</span></span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> toSet_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">y</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> bexI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> clock_commonKnowledge_relation_image<span class="main"><span class="main">[</span></span><span class="operator">OF</span> aec_cec_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> tC Kcknows<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> Kcknows<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> clock_repMC <span class="main">(</span>ODList.toSet <span class="free">cec</span><span class="main">)</span><span class="main">,</span> <span class="free">s</span> <span class="main">⊨</span> Kknows <span class="skolem">a</span> <span class="main">(</span>Kcknows <span class="skolem">as</span> <span class="skolem">ψ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> clock_repMC_aec<span class="main">[</span><span class="operator">OF</span> tC Kcknows<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> Kcknows<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> Kcknows<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
          clock_repMC_cec<span class="main">[</span><span class="operator">OF</span> tC Kcknows<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> Kcknows<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> Kcknows<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> ball_cong<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> clock_repMC <span class="main">(</span>ODList.toSet <span class="free">cec</span><span class="main">)</span><span class="main">,</span> <span class="free">s</span> <span class="main">⊨</span> Kcknows <span class="skolem">as</span> <span class="skolem">ψ</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> S5n_common_knowledge_fixed_point_simpler<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> Kcknows
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> aec_cec_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> tC Kcknows<span class="main"><span class="main"><span class="main">(</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span> Kcknows<span class="main"><span class="main"><span class="main">(</span></span></span>4<span class="main"><span class="main"><span class="main">)</span></span></span> Kcknows<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1" id="ClockView-eval_models"><span class="command">lemma</span></span> eval_models<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> Clock.jkbpC"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> aec<span class="main">:</span> <span class="quoted"><span class="quoted">"ODList.toSet <span class="free">aec</span> <span class="main">=</span> agent_abs <span class="free">a</span> <span class="free">t</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> cec<span class="main">:</span> <span class="quoted"><span class="quoted">"ODList.toSet <span class="free">cec</span> <span class="main">=</span> common_abs <span class="free">t</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> subj_phi<span class="main">:</span> <span class="quoted"><span class="quoted">"subjective <span class="free">a</span> <span class="free">φ</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> ODList.toSet <span class="free">aec</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval <span class="free">envVal</span> <span class="free">envObs</span> <span class="main">(</span><span class="free">cec</span><span class="main">,</span> <span class="free">aec</span><span class="main">)</span> <span class="free">φ</span>
     <span class="main">⟷</span> clock_repMC <span class="main">(</span>ODList.toSet <span class="free">cec</span><span class="main">)</span><span class="main">,</span> <span class="free">s</span> <span class="main">⊨</span> <span class="free">φ</span>"</span></span>
<span class="comment1">(*&lt;*)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> eval_def
  <span class="keyword1"><span class="command">using</span></span> evalS_models<span class="main">[</span><span class="operator">OF</span> tC aec cec subj_phi s<span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">(*&gt;*)</span>

<span class="comment1">(* **************************************** *)</span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Simulated actions›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

From a common equivalence class and a subjective equivalence class for
agent <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">a</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, we can compute the actions enabled for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">a</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>:

›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> -<span class="main">)</span>
  <span class="entity">clock_simAction</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'aAct</span><span class="main">)</span> JKBP <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'s</span> <span class="main">::</span> linorder<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> bool<span class="main">)</span>
                  <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'obs</span><span class="main">)</span>
                  <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> clock_simWorldsRep <span class="main">⇒</span> <span class="tfree">'aAct</span> list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">clock_simAction</span> <span class="free"><span class="bound"><span class="entity">jkbp</span></span></span> <span class="free"><span class="bound"><span class="entity">envVal</span></span></span> <span class="free"><span class="bound"><span class="entity">envObs</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">a</span> <span class="main">(</span><span class="bound">Y</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">.</span>
     <span class="main">[</span> action <span class="bound">gc</span><span class="main">.</span> gc <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">jkbp</span></span></span> <span class="bound">a</span><span class="main">,</span> eval <span class="free"><span class="bound"><span class="entity">envVal</span></span></span> <span class="free"><span class="bound"><span class="entity">envObs</span></span></span> <span class="main">(</span><span class="bound">Y</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">(</span>guard <span class="bound">gc</span><span class="main">)</span> <span class="main">]</span>"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">clock_simAction</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> clock_simWorldsRep <span class="main">⇒</span> <span class="tfree">'aAct</span> list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">clock_simAction</span> <span class="main">≡</span> ClockView.clock_simAction <span class="free">jkbp</span> <span class="free">envVal</span> <span class="free">envObs</span>"</span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

Using the above result about evaluation, we can relate <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>clock_simAction›</span></span></span></span> to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"jAction"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Firstly, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>clock_simAction›</span></span></span></span> behaves the same as <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"jAction"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> using the
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"clock_repMC"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> structure:

›</span></span>

<span class="keyword1" id="ClockView-clock_simAction_jAction"><span class="command">lemma</span></span> clock_simAction_jAction<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> Clock.jkbpC"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> aec<span class="main">:</span> <span class="quoted"><span class="quoted">"ODList.toSet <span class="free">aec</span> <span class="main">=</span> agent_abs <span class="free">a</span> <span class="free">t</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> cec<span class="main">:</span> <span class="quoted"><span class="quoted">"ODList.toSet <span class="free">cec</span> <span class="main">=</span> common_abs <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>clock_simAction <span class="free">a</span> <span class="main">(</span><span class="free">cec</span><span class="main">,</span> <span class="free">aec</span><span class="main">)</span><span class="main">)</span>
       <span class="main">=</span> set <span class="main">(</span>jAction <span class="main">(</span>clock_repMC <span class="main">(</span>ODList.toSet <span class="free">cec</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>tLast <span class="free">t</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span>"</span></span>
<span class="comment1">(*&lt;*)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> clock_simAction_def jAction_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">xa</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> bexI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> eval_models<span class="main"><span class="main">[</span></span><span class="operator">OF</span> tC aec cec<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command">using</span></span> tC aec cec subj
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">xa</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> bexI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> refl<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> eval_models<span class="main"><span class="main">[</span></span><span class="operator">OF</span> tC aec cec<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> tC aec cec subj
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="ClockView-clock_submodel_aux"><span class="command">lemma</span></span> clock_submodel_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> Clock.jkbpC"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> worlds <span class="main">(</span>clock_simMCt <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"gen_model Clock.MCS <span class="free">s</span> <span class="main">=</span> gen_model <span class="main">(</span>clock_simMCt <span class="free">t</span><span class="main">)</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> gen_model_subset<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> T<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"clock_jkbpCSt <span class="free"><span class="free">t</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?X</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"clock_sim <span class="main">`</span> Clock.jkbpCn <span class="main">(</span>tLength <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"relations Clock.MCS <span class="skolem">a</span> <span class="main">∩</span> <span class="var">?X</span> <span class="main">×</span> <span class="var">?X</span>
      <span class="main">=</span> relations <span class="main">(</span>clock_simMCt <span class="free">t</span><span class="main">)</span> <span class="skolem">a</span> <span class="main">∩</span> <span class="var">?X</span> <span class="main">×</span> <span class="var">?X</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Int_ac Int_absorb1
                  relation_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> jkbpCSt_jkbpCS_subset jkbpCSt_jkbpCS_subset<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?X</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"clock_sim <span class="main">`</span> Clock.jkbpCn <span class="main">(</span>tLength <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> s <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">a</span><span class="main">.</span> relations <span class="main">(</span>clock_simMCt <span class="free">t</span><span class="main">)</span> <span class="bound">a</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="main">{</span><span class="free">s</span><span class="main">}</span> <span class="main">⊆</span> <span class="var">?X</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> mkKripke_simps<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> kripke_rels_trc_worlds<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Y</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Clock.jkbpCn <span class="main">(</span>tLength <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?X</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"clock_sim <span class="main">`</span> <span class="var">?Y</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> s <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> st'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">=</span> clock_sim <span class="skolem">t'</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> t'C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">∈</span> Clock.jkbpC"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> t'O<span class="main">:</span> <span class="quoted"><span class="quoted">"tLength <span class="free">t</span> <span class="main">=</span> tLength <span class="skolem">t'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t''</span>
    <span class="keyword3"><span class="command">assume</span></span> tt'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t'</span><span class="main">,</span> <span class="skolem">t''</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">a</span><span class="main">.</span> relations Clock.MC <span class="bound">a</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> t'C tt' <span class="keyword1"><span class="command">have</span></span> t''C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t''</span> <span class="main">∈</span> Clock.jkbpC"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">erule</span> kripke_rels_trc_worlds<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> t'O tt' <span class="keyword1"><span class="command">have</span></span> t''O<span class="main">:</span> <span class="quoted"><span class="quoted">"tLength <span class="free">t</span> <span class="main">=</span> tLength <span class="skolem">t''</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Clock.sync_tLength_eq_trc<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> t''C t''O <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t''</span> <span class="main">∈</span> <span class="var">?Y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">a</span><span class="main">.</span> relations Clock.MC <span class="bound">a</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="main">{</span><span class="skolem">t'</span><span class="main">}</span> <span class="main">⊆</span> <span class="var">?Y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"clock_sim <span class="main">`</span> <span class="main">(</span><span class="main">(</span><span class="main">⋃</span><span class="bound">a</span><span class="main">.</span> relations Clock.MC <span class="bound">a</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="main">{</span><span class="skolem">t'</span><span class="main">}</span><span class="main">)</span> <span class="main">⊆</span> <span class="var">?X</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> image_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> st' t'C
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">a</span><span class="main">.</span> relations Clock.MCS <span class="bound">a</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="main">{</span><span class="free">s</span><span class="main">}</span> <span class="main">⊆</span> <span class="var">?X</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sim_trc_commute<span class="main">[</span><span class="operator">OF</span> Clock.mkM_kripke clock_sim<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">t'</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> s<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

We can connect the agent's choice of actions on the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>clock_repMC›</span></span></span></span> structure to those on the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Clock.MC›</span></span></span></span>
structure using our earlier results about actions being preserved by
generated models and simulations.

›</span></span>

<span class="keyword1" id="ClockView-clock_simAction'"><span class="command">lemma</span></span> clock_simAction'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> Clock.jkbpC"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> aec<span class="main">:</span> <span class="quoted"><span class="quoted">"ODList.toSet <span class="free">aec</span> <span class="main">=</span> agent_abs <span class="free">a</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> cec<span class="main">:</span> <span class="quoted"><span class="quoted">"ODList.toSet <span class="free">cec</span> <span class="main">=</span> common_abs <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>clock_simAction <span class="free">a</span> <span class="main">(</span><span class="free">cec</span><span class="main">,</span> <span class="free">aec</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>jAction Clock.MC <span class="free">t</span> <span class="free">a</span><span class="main">)</span>"</span></span>
<span class="comment1">(*&lt;*)</span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> tC aec cec
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> set <span class="main">(</span>jAction <span class="main">(</span>clock_repMC <span class="main">(</span>ODList.toSet <span class="free">cec</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>tLast <span class="free">t</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> clock_simAction_jAction<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> tC aec cec
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> set <span class="main">(</span>jAction <span class="main">(</span>clock_simMCt <span class="free">t</span><span class="main">)</span> <span class="main">(</span>clock_sim <span class="free">t</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> simulation_jAction_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ clock_repSim<span class="main"><span class="main">]</span></span> common_abs_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> tC
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> set <span class="main">(</span>jAction Clock.MCS <span class="main">(</span>clock_sim <span class="free">t</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> gen_model_jAction_eq<span class="main">[</span><span class="operator">OF</span> clock_submodel_aux<span class="main"><span class="main">[</span></span><span class="operator">OF</span> tC<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> s<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"clock_sim <span class="free">t</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> w'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"clock_sim <span class="free">t</span>"</span></span><span class="main">]</span>
          gen_model_world_refl<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> w<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"clock_sim <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> M<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"clock_simMCt <span class="free">t</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> tC <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> set <span class="main">(</span>jAction Clock.MC <span class="free">t</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> simulation_jAction_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ clock_sim<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Algorithm"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> locale requires a specialisation of this
lemma:

›</span></span>

<span class="keyword1" id="ClockView-clock_simAction"><span class="command">lemma</span></span> clock_simAction<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> Clock.jkbpC"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ec<span class="main">:</span> <span class="quoted"><span class="quoted">"clock_simAbs <span class="free">ec</span> <span class="main">=</span> Clock.sim_equiv_class <span class="free">a</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>clock_simAction <span class="free">a</span> <span class="free">ec</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>jAction Clock.MC <span class="free">t</span> <span class="free">a</span><span class="main">)</span>"</span></span>
<span class="comment1">(*&lt;*)</span>
  <span class="keyword1"><span class="command">using</span></span> assms clock_simAction'<span class="main">[</span><span class="operator">OF</span> tC<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> cec<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"fst <span class="free">ec</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> aec<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"snd <span class="free">ec</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> common_abs agent_abs<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="comment1">(*&gt;*)</span>

<span class="comment1">(* **************************************** *)</span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Simulated transitions›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

We need to determine the image of the set of commonly-held-possible
states under the transition function, and also for the agent's
subjective equivalence class. We do this with the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>clock_trans›</span></span></span></span> function:

›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> -<span class="main">)</span>
  <span class="entity">clock_trans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> linorder<span class="main">)</span> odlist <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'aAct</span><span class="main">)</span> JKBP
              <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'s</span> <span class="main">::</span> linorder<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'eAct</span> list<span class="main">)</span>
              <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'eAct</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'aAct</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span><span class="main">)</span>
              <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'obs</span><span class="main">)</span>
              <span class="main">⇒</span> <span class="tfree">'s</span> odlist <span class="main">⇒</span> <span class="tfree">'s</span> odlist <span class="main">⇒</span> <span class="tfree">'s</span> odlist"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">clock_trans</span> <span class="free"><span class="bound"><span class="entity">agents</span></span></span> <span class="free"><span class="bound"><span class="entity">jkbp</span></span></span> <span class="free"><span class="bound"><span class="entity">envAction</span></span></span> <span class="free"><span class="bound"><span class="entity">envTrans</span></span></span> <span class="free"><span class="bound"><span class="entity">envVal</span></span></span> <span class="free"><span class="bound"><span class="entity">envObs</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">cec</span> <span class="bound">X</span><span class="main">.</span>
     ODList.fromList <span class="main">(</span>concat
       <span class="main">[</span> <span class="main">[</span> <span class="free"><span class="bound"><span class="entity">envTrans</span></span></span> <span class="bound">eact</span> <span class="bound">aact</span> <span class="bound">s</span> <span class="main">.</span>
                     eact <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">envAction</span></span></span> <span class="bound">s</span><span class="main">,</span>
                     aact <span class="main">←</span> listToFuns <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> clock_simAction <span class="free"><span class="bound"><span class="entity">jkbp</span></span></span> <span class="free"><span class="bound"><span class="entity">envVal</span></span></span> <span class="free"><span class="bound"><span class="entity">envObs</span></span></span> <span class="bound">a</span>
                                        <span class="main">(</span><span class="bound">cec</span><span class="main">,</span> clock_knowledge <span class="free"><span class="bound"><span class="entity">envObs</span></span></span> <span class="bound">cec</span> <span class="bound">a</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>
                                        <span class="main">(</span>toList <span class="free"><span class="bound"><span class="entity">agents</span></span></span><span class="main">)</span> <span class="main">]</span> <span class="main">.</span>
                   s <span class="main">←</span> toList <span class="bound">X</span> <span class="main">]</span><span class="main">)</span>"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">clock_trans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> odlist <span class="main">⇒</span> <span class="tfree">'s</span> odlist <span class="main">⇒</span> <span class="tfree">'s</span> odlist"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">clock_trans</span> <span class="main">≡</span> ClockView.clock_trans <span class="free">agents</span> <span class="free">jkbp</span> <span class="free">envAction</span> <span class="free">envTrans</span> <span class="free">envVal</span> <span class="free">envObs</span>"</span></span>

<span class="keyword1" id="ClockView-clock_trans_aux"><span class="command">lemma</span></span> clock_trans_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> t'C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t'</span> <span class="main">∈</span> Clock.jkbpC"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> ec<span class="main">:</span> <span class="quoted"><span class="quoted">"clock_simAbs <span class="free">ec</span> <span class="main">=</span> Clock.sim_equiv_class <span class="free">a'</span> <span class="free">t'</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> tC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> Clock.jkbpCn <span class="main">(</span>tLength <span class="free">t'</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> eact<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">eact</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">envAction</span> <span class="main">(</span>tLast <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">aact</span> <span class="main">∈</span> set <span class="main">(</span>listToFuns <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> clock_simAction <span class="bound">a</span> <span class="main">(</span>fst <span class="free">ec</span><span class="main">,</span> clock_knowledge <span class="free">envObs</span> <span class="main">(</span>fst <span class="free">ec</span><span class="main">)</span> <span class="bound">a</span> <span class="main">(</span>tLast <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                            <span class="main">(</span>toList <span class="free">agents</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
     <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">.</span> <span class="free">aact</span> <span class="bound">a</span> <span class="main">∈</span> set <span class="main">(</span>jAction <span class="main">(</span>Clock.MCn <span class="main">(</span>tLength <span class="free">t'</span><span class="main">)</span><span class="main">)</span> <span class="free">t</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> Clock.jkbpCn_jkbpC_inc<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> listToFuns_ext<span class="main"><span class="main">[</span></span><span class="operator">OF</span> agents<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">unfolded</span> toSet_def<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> clock_simAction'<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> Clock.jkbpCn_jkbpC_inc<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> clock_coEC_relation_image<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> common_abs common_abs_def toSet_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> common_abs agent_abs_def common_abs_def clock_repRels_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> common_abs common_abs_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Clock.jkbpC_jkbpCn_jAction_eq<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"listToFuns"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> exhibits the isomorphism between <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span>
<span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="tfree"><span class="tfree">'a</span></span> <span class="main"><span class="main">×</span></span> <span class="tfree"><span class="tfree">'b</span></span> list<span class="main"><span class="main">)</span></span> list"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="tfree"><span class="tfree">'a</span></span> <span class="main"><span class="main">⇒</span></span> <span class="tfree"><span class="tfree">'b</span></span><span class="main"><span class="main">)</span></span> list"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> for finite types
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'a</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

We can show that the transition function works for both the
commonly-held set of states and the agent subjective one. The proofs
are  straightforward.

›</span></span>

<span class="keyword1" id="ClockView-clock_trans_common"><span class="command">lemma</span></span> clock_trans_common<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> Clock.jkbpC"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ec<span class="main">:</span> <span class="quoted"><span class="quoted">"clock_simAbs <span class="free">ec</span> <span class="main">=</span> Clock.sim_equiv_class <span class="free">a</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ODList.toSet <span class="main">(</span>clock_trans <span class="main">(</span>fst <span class="free">ec</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">ec</span><span class="main">)</span><span class="main">)</span>
       <span class="main">=</span> <span class="main">{</span> <span class="bound">s</span> <span class="main">|</span><span class="bound">t'</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">t'</span> <span class="main">↝</span> <span class="bound">s</span> <span class="main">∈</span> Clock.jkbpC <span class="main">∧</span> tLength <span class="bound">t'</span> <span class="main">=</span> tLength <span class="free">t</span> <span class="main">}</span>"</span></span>
<span class="comment1">(*&lt;*)</span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">⊆</span> <span class="var">?rhs</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> clock_trans_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> toSet_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> common_abs<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span> common_abs_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">xa</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Clock.jkbpCn_jkbpC_inc<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> n<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"Suc <span class="main"><span class="main">(</span></span>tLength <span class="free"><span class="free">t</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> clock_trans_aux<span class="main"><span class="main">[</span></span><span class="operator">OF</span> tC ec<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span> <span class="main">⊆</span> <span class="var">?lhs</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> clock_trans_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> toSet_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> common_abs<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span> common_abs_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> Clock.jkbpC_tLength_inv<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> n<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"Suc <span class="main"><span class="main">(</span></span>tLength <span class="free"><span class="free">t</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> clock_trans_aux<span class="main"><span class="main">[</span></span><span class="operator">OF</span> tC ec<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹›</span></span>

<span class="keyword1" id="ClockView-clock_trans_agent"><span class="command">lemma</span></span> clock_trans_agent<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> Clock.jkbpC"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ec<span class="main">:</span> <span class="quoted"><span class="quoted">"clock_simAbs <span class="free">ec</span> <span class="main">=</span> Clock.sim_equiv_class <span class="free">a</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ODList.toSet <span class="main">(</span>clock_trans <span class="main">(</span>fst <span class="free">ec</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">ec</span><span class="main">)</span><span class="main">)</span>
       <span class="main">=</span> <span class="main">{</span> <span class="bound">s</span> <span class="main">|</span><span class="bound">t'</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">t'</span> <span class="main">↝</span> <span class="bound">s</span> <span class="main">∈</span> Clock.jkbpC <span class="main">∧</span> clock_jview <span class="free">a</span> <span class="bound">t'</span> <span class="main">=</span> clock_jview <span class="free">a</span> <span class="free">t</span> <span class="main">}</span>"</span></span>
<span class="comment1">(*&lt;*)</span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">⊆</span> <span class="var">?rhs</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> clock_trans_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> toSet_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> common_abs<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span> agent_abs<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span> common_abs_def agent_abs_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">t'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Clock.jkbpCn_jkbpC_inc<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> n<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"Suc <span class="main"><span class="main">(</span></span>tLength <span class="free"><span class="free">t</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> clock_trans_aux<span class="main"><span class="main">[</span></span><span class="operator">OF</span> tC ec<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span> <span class="main">⊆</span> <span class="var">?lhs</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> clock_trans_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> toSet_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> common_abs<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span> agent_abs<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span> common_abs_def agent_abs_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> Clock.jkbpC_tLength_inv<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> n<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"Suc <span class="main"><span class="main">(</span></span>tLength <span class="free"><span class="free">t</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> clock_trans_aux<span class="main"><span class="main">[</span></span><span class="operator">OF</span> tC ec<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

Note that the clock semantics disregards paths, so we simply compute
the successors of the temporal slice and partition that. Similarly the
successors of the agent's subjective equivalence class tell us what
the set of possible observations are:

›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> -<span class="main">)</span>
  <span class="entity">clock_mkSuccs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">::</span> linorder <span class="main">⇒</span> <span class="tfree">'obs</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'obs</span> <span class="main">⇒</span> <span class="tfree">'s</span> odlist
                <span class="main">⇒</span> <span class="tfree">'s</span> clock_simWorldsRep"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">clock_mkSuccs</span> <span class="free"><span class="bound"><span class="entity">envObs</span></span></span> <span class="free"><span class="bound"><span class="entity">obs</span></span></span> <span class="free"><span class="bound"><span class="entity">Y'</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Y'</span></span></span><span class="main">,</span> ODList.filter <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">envObs</span></span></span> <span class="bound">s</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">obs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Y'</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

Finally we can define our transition function on simulated states:

›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> -<span class="main">)</span>
  <span class="entity">clock_simTrans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> linorder<span class="main">)</span> odlist <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'aAct</span><span class="main">)</span> JKBP
              <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'s</span> <span class="main">::</span> linorder<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'eAct</span> list<span class="main">)</span>
              <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'eAct</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'aAct</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span><span class="main">)</span>
              <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'obs</span><span class="main">)</span>
              <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> clock_simWorldsRep <span class="main">⇒</span> <span class="tfree">'s</span> clock_simWorldsRep list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">clock_simTrans</span> <span class="free"><span class="bound"><span class="entity">agents</span></span></span> <span class="free"><span class="bound"><span class="entity">jkbp</span></span></span> <span class="free"><span class="bound"><span class="entity">envAction</span></span></span> <span class="free"><span class="bound"><span class="entity">envTrans</span></span></span> <span class="free"><span class="bound"><span class="entity">envVal</span></span></span> <span class="free"><span class="bound"><span class="entity">envObs</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">a</span> <span class="main">(</span><span class="bound">Y</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">.</span>
     <span class="keyword1">let</span> <span class="bound">X'</span> <span class="main">=</span> clock_trans <span class="free"><span class="bound"><span class="entity">agents</span></span></span> <span class="free"><span class="bound"><span class="entity">jkbp</span></span></span> <span class="free"><span class="bound"><span class="entity">envAction</span></span></span> <span class="free"><span class="bound"><span class="entity">envTrans</span></span></span> <span class="free"><span class="bound"><span class="entity">envVal</span></span></span> <span class="free"><span class="bound"><span class="entity">envObs</span></span></span> <span class="bound">Y</span> <span class="bound">X</span><span class="main">;</span>
        <span class="bound">Y'</span> <span class="main">=</span> clock_trans <span class="free"><span class="bound"><span class="entity">agents</span></span></span> <span class="free"><span class="bound"><span class="entity">jkbp</span></span></span> <span class="free"><span class="bound"><span class="entity">envAction</span></span></span> <span class="free"><span class="bound"><span class="entity">envTrans</span></span></span> <span class="free"><span class="bound"><span class="entity">envVal</span></span></span> <span class="free"><span class="bound"><span class="entity">envObs</span></span></span> <span class="bound">Y</span> <span class="bound">Y</span>
      <span class="keyword1">in</span> <span class="main">[</span> clock_mkSuccs <span class="main">(</span><span class="free"><span class="bound"><span class="entity">envObs</span></span></span> <span class="bound">a</span><span class="main">)</span> <span class="bound">obs</span> <span class="bound">Y'</span> <span class="main">.</span>
             obs <span class="main">←</span> map <span class="main">(</span><span class="free"><span class="bound"><span class="entity">envObs</span></span></span> <span class="bound">a</span><span class="main">)</span> <span class="main">(</span>toList <span class="bound">X'</span><span class="main">)</span> <span class="main">]</span>"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">clock_simTrans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> clock_simWorldsRep <span class="main">⇒</span> <span class="tfree">'s</span> clock_simWorldsRep list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">clock_simTrans</span> <span class="main">≡</span> ClockView.clock_simTrans <span class="free">agents</span> <span class="free">jkbp</span> <span class="free">envAction</span> <span class="free">envTrans</span> <span class="free">envVal</span> <span class="free">envObs</span>"</span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

Showing that this respects the property asked of it by the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>
<span class="quoted"><span class="quoted">"Algorithm"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> locale is straightforward:

›</span></span>

<span class="keyword1" id="ClockView-clock_simTrans"><span class="command">lemma</span></span> clock_simTrans<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> Clock.jkbpC"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> ec<span class="main">:</span> <span class="quoted"><span class="quoted">"clock_simAbs <span class="free">ec</span> <span class="main">=</span> Clock.sim_equiv_class <span class="free">a</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"clock_simAbs <span class="main">`</span> set <span class="main">(</span>clock_simTrans <span class="free">a</span> <span class="free">ec</span><span class="main">)</span>
      <span class="main">=</span> <span class="main">{</span> Clock.sim_equiv_class <span class="free">a</span> <span class="main">(</span><span class="bound">t'</span> <span class="main">↝</span> <span class="bound">s</span><span class="main">)</span>
          <span class="main">|</span><span class="bound">t'</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">t'</span> <span class="main">↝</span> <span class="bound">s</span> <span class="main">∈</span> Clock.jkbpC <span class="main">∧</span> clock_jview <span class="free">a</span> <span class="bound">t'</span> <span class="main">=</span> clock_jview <span class="free">a</span> <span class="free">t</span> <span class="main">}</span>"</span></span>
<span class="comment1">(*&lt;*)</span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">note</span></span> image_cong_simp <span class="main">[</span><span class="operator">cong</span> <span class="quasi_keyword">del</span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">⊆</span> <span class="var">?rhs</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> clock_simTrans_def clock_mkSuccs_def
    <span class="keyword1"><span class="command">using</span></span> clock_trans_common<span class="main">[</span><span class="operator">OF</span> tC ec<span class="main">]</span> clock_trans_agent<span class="main">[</span><span class="operator">OF</span> tC ec<span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> toSet_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> clock_simAbs_def Let_def<span class="main">)</span>

    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">t'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">xa</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>

    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> clock_sim_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>

     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">t'a</span> <span class="main">↝</span> <span class="improper">s</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> image_eqI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def Set.image_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">t'b</span> <span class="main">↝</span> <span class="improper">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def Set.image_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> t<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">t'b</span> <span class="main">↝</span> <span class="improper">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> Clock.jkbpC_tLength_inv<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">ta</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Clock.jkbpCn_jkbpC_inc<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> n<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"Suc <span class="main"><span class="main">(</span></span>tLength <span class="free"><span class="free">t</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>3<span class="main"><span class="keyword3">]</span></span>

    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"tLast <span class="improper">ta</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def Set.image_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">taa</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Clock.jkbpCn_jkbpC_inc<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> n<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"Suc <span class="main"><span class="main">(</span></span>tLength <span class="free"><span class="free">t</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> t<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">t'a</span> <span class="main">↝</span> <span class="improper">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> Clock.jkbpC_tLength_inv<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">t'a</span> <span class="main">↝</span> <span class="improper">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> t<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">ta</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> Clock.jkbpC_tLength_inv<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">ta</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Clock.jkbpCn_jkbpC_inc<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> n<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"Suc <span class="main"><span class="main">(</span></span>tLength <span class="free"><span class="free">t</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span> <span class="main">⊆</span> <span class="var">?lhs</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> clock_simTrans_def Let_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ec</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> clock_trans_common<span class="main">[</span><span class="operator">OF</span> tC ec<span class="main">]</span> clock_trans_agent<span class="main">[</span><span class="operator">OF</span> tC ec<span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> toSet_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> Set.image_def clock_simAbs_def
                <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> split_paired_Ex<span class="main">)</span>

    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"clock_mkSuccs <span class="main">(</span><span class="free">envObs</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span><span class="free">envObs</span> <span class="free">a</span> <span class="improper">s</span><span class="main">)</span> <span class="main">(</span>clock_trans <span class="improper">aa</span> <span class="improper">aa</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"tLast <span class="improper">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> clock_trans_common<span class="main"><span class="main">[</span></span><span class="operator">OF</span> tC ec<span class="main"><span class="main">]</span></span> clock_mkSuccs_def<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> clock_sim_def <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> Clock.jkbpCn.simps<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">ta</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Clock.jkbpCn_jkbpC_inc<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> n<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"Suc <span class="main"><span class="main">(</span></span>tLength <span class="free"><span class="free">t</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">eact</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">aact</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def Set.image_def<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> t<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">t'a</span> <span class="main">↝</span> <span class="improper">xa</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> Clock.jkbpC_tLength_inv<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">t'a</span> <span class="main">↝</span> <span class="improper">xa</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> t<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> Clock.jkbpC_tLength_inv<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> Let_def Clock.jkbpCn.simps<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">ta</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Clock.jkbpCn_jkbpC_inc<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> n<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"Suc <span class="main"><span class="main">(</span></span>tLength <span class="free"><span class="free">t</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> clock_trans_common<span class="main"><span class="main">[</span></span><span class="operator">OF</span> tC ec<span class="main"><span class="main">]</span></span> clock_mkSuccs_def<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">t'a</span> <span class="main">↝</span> <span class="improper">sa</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> clock_sim_def Let_def<span class="main">)</span>
     <span class="comment1">(* FIXME similar to above *)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Set.image_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">t'b</span> <span class="main">↝</span> <span class="improper">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> t<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">t'b</span> <span class="main">↝</span> <span class="improper">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> Clock.jkbpC_tLength_inv<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">ta</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Clock.jkbpCn_jkbpC_inc<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> n<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"Suc <span class="main"><span class="main">(</span></span>tLength <span class="free"><span class="free">t</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context FiniteLinorderEnvironment *)</span>

<span class="comment1">(* **************************************** *)</span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Maps›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

\label{sec:kbps-theory-clock-view-maps}

As mentioned above, the canonicity of our ordered, distinct list
representation of automaton states allows us to use them as keys in a
digital trie; a value of type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="tfree"><span class="tfree">'key</span></span><span class="main"><span class="main">,</span></span> <span class="tfree"><span class="tfree">'val</span></span><span class="main"><span class="main">)</span></span> trie"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> maps keys of
type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'key</span></span> list"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to values of type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'val</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

In this specific case we track automaton transitions using a two-level
structure mapping sets of states to an association list mapping
observations to sets of states, and for actions automaton states map
directly to agent actions.

›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'obs</span><span class="main">)</span> clock_trans_trie
  <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="main">(</span><span class="tfree">'obs</span><span class="main">,</span> <span class="tfree">'s</span> clock_simWorldsRep<span class="main">)</span> mapping<span class="main">)</span> trie<span class="main">)</span> trie"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'aAct</span><span class="main">)</span> clock_acts_trie <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'aAct</span><span class="main">)</span> trie<span class="main">)</span> trie"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">trans_MapOps_lookup</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">::</span> linorder<span class="main">,</span> <span class="tfree">'obs</span><span class="main">)</span> clock_trans_trie
                        <span class="main">⇒</span> <span class="tfree">'s</span> clock_simWorldsRep <span class="main">×</span> <span class="tfree">'obs</span>
                        <span class="main">⇀</span> <span class="tfree">'s</span> clock_simWorldsRep"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">trans_MapOps_lookup</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">m</span> <span class="bound">k</span><span class="main">.</span>
     Option.bind <span class="main">(</span>trie_odlist_lookup <span class="bound">m</span> <span class="main">(</span>fst <span class="main">(</span>fst <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">.</span>
       <span class="main">(</span>Option.bind <span class="main">(</span>trie_odlist_lookup <span class="bound">m</span> <span class="main">(</span>snd <span class="main">(</span>fst <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">.</span>
         Mapping.lookup <span class="bound">m</span> <span class="main">(</span>snd <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">trans_MapOps_update</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">::</span> linorder<span class="main">)</span> clock_simWorldsRep <span class="main">×</span> <span class="tfree">'obs</span> <span class="main">⇒</span> <span class="tfree">'s</span> clock_simWorldsRep
                        <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">::</span> linorder<span class="main">,</span> <span class="tfree">'obs</span><span class="main">)</span> clock_trans_trie
                        <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">::</span> linorder<span class="main">,</span> <span class="tfree">'obs</span><span class="main">)</span> clock_trans_trie"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">trans_MapOps_update</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">k</span> <span class="bound">v</span> <span class="bound">m</span><span class="main">.</span>
     trie_odlist_update_with <span class="main">(</span>fst <span class="main">(</span>fst <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="bound">m</span> empty_trie <span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">.</span>
       trie_odlist_update_with <span class="main">(</span>snd <span class="main">(</span>fst <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="bound">m</span> Mapping.empty <span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">.</span>
          Mapping.update <span class="main">(</span>snd <span class="bound">k</span><span class="main">)</span> <span class="bound">v</span> <span class="bound">m</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">trans_MapOps</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'s</span> <span class="main">::</span> linorder<span class="main">,</span> <span class="tfree">'obs</span><span class="main">)</span> clock_trans_trie<span class="main">,</span>
                    <span class="tfree">'s</span> clock_simWorldsRep <span class="main">×</span> <span class="tfree">'obs</span><span class="main">,</span> <span class="tfree">'s</span> clock_simWorldsRep<span class="main">)</span> MapOps"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">trans_MapOps</span> <span class="main">≡</span>
     <span class="main">⦇</span> MapOps.empty <span class="main">=</span> empty_trie<span class="main">,</span>
       lookup <span class="main">=</span> trans_MapOps_lookup<span class="main">,</span>
       update <span class="main">=</span> trans_MapOps_update <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> FiniteLinorderEnvironment<span class="main">)</span> trans_MapOps<span class="main">:</span>
  <span class="quoted"><span class="quoted">"MapOps <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span>clock_simAbs <span class="main">(</span>fst <span class="bound">k</span><span class="main">)</span><span class="main">,</span> snd <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Clock.jkbpSEC <span class="main">×</span> UNIV<span class="main">)</span> trans_MapOps"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"MapOps.lookup trans_MapOps <span class="main">(</span>MapOps.empty trans_MapOps<span class="main">)</span> <span class="skolem">k</span> <span class="main">=</span> None"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> trans_MapOps_def trans_MapOps_lookup_def trie_odlist_lookup_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">e</span> <span class="skolem">k</span> <span class="skolem">k'</span> <span class="skolem">M</span>
  <span class="keyword3"><span class="command">assume</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>clock_simAbs <span class="main">(</span>fst <span class="skolem">k</span><span class="main">)</span><span class="main">,</span> snd <span class="skolem">k</span><span class="main">)</span> <span class="main">∈</span> Clock.jkbpSEC <span class="main">×</span> <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'z</span> set<span class="main">)</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> k'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>clock_simAbs <span class="main">(</span>fst <span class="skolem">k'</span><span class="main">)</span><span class="main">,</span> snd <span class="skolem">k'</span><span class="main">)</span> <span class="main">∈</span> Clock.jkbpSEC <span class="main">×</span> <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'z</span> set<span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"MapOps.lookup trans_MapOps <span class="main">(</span>MapOps.update trans_MapOps <span class="skolem">k</span> <span class="skolem">e</span> <span class="skolem">M</span><span class="main">)</span> <span class="skolem">k'</span>
         <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span>clock_simAbs <span class="main">(</span>fst <span class="skolem">k'</span><span class="main">)</span><span class="main">,</span> snd <span class="skolem">k'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>clock_simAbs <span class="main">(</span>fst <span class="skolem">k</span><span class="main">)</span><span class="main">,</span> snd <span class="skolem">k</span><span class="main">)</span>
             <span class="keyword1">then</span> Some <span class="skolem">e</span> <span class="keyword1">else</span> MapOps.lookup trans_MapOps <span class="skolem">M</span> <span class="skolem">k'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>clock_simAbs <span class="main">(</span>fst <span class="skolem">k'</span><span class="main">)</span><span class="main">,</span> snd <span class="skolem">k'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>clock_simAbs <span class="main">(</span>fst <span class="skolem">k</span><span class="main">)</span><span class="main">,</span> snd <span class="skolem">k</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="skolem">k'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> inj_onD<span class="main">[</span><span class="operator">OF</span> clock_simAbs_inj_on<span class="main">]</span> k k' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> prod_eqI<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> trans_MapOps_def trans_MapOps_lookup_def trans_MapOps_update_def trie_odlist_lookup_def trie_odlist_update_with_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_trie_update_with lookup_update <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split prod.split<span class="main">)</span> 
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> trans_MapOps_def trans_MapOps_lookup_def trans_MapOps_update_def trie_odlist_lookup_def trie_odlist_update_with_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">k</span> <span class="main">=</span> fst <span class="skolem">k'</span>"</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_empty lookup_update_neq prod_eq_iff lookup_trie_update_with <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split prod.split<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* A map for the agent actions. *)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">acts_MapOps_lookup</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">::</span> linorder<span class="main">,</span> <span class="tfree">'aAct</span><span class="main">)</span> clock_acts_trie
                      <span class="main">⇒</span> <span class="tfree">'s</span> clock_simWorldsRep
                      <span class="main">⇀</span> <span class="tfree">'aAct</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">acts_MapOps_lookup</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">m</span> <span class="bound">k</span><span class="main">.</span>
     Option.bind <span class="main">(</span>trie_odlist_lookup <span class="bound">m</span> <span class="main">(</span>fst <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">.</span>
       <span class="main">(</span>trie_odlist_lookup <span class="bound">m</span> <span class="main">(</span>snd <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">acts_MapOps_update</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">::</span> linorder<span class="main">)</span> clock_simWorldsRep <span class="main">⇒</span> <span class="tfree">'aAct</span>
                      <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">::</span> linorder<span class="main">,</span> <span class="tfree">'aAct</span><span class="main">)</span> clock_acts_trie
                      <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">::</span> linorder<span class="main">,</span> <span class="tfree">'aAct</span><span class="main">)</span> clock_acts_trie"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">acts_MapOps_update</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">k</span> <span class="bound">v</span> <span class="bound">m</span><span class="main">.</span>
     trie_odlist_update_with <span class="main">(</span>fst <span class="bound">k</span><span class="main">)</span> <span class="bound">m</span> empty_trie <span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">.</span>
       trie_odlist_update <span class="main">(</span>snd <span class="bound">k</span><span class="main">)</span> <span class="bound">v</span> <span class="bound">m</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">acts_MapOps</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'s</span> <span class="main">::</span> linorder<span class="main">,</span> <span class="tfree">'aAct</span><span class="main">)</span> clock_acts_trie<span class="main">,</span> <span class="tfree">'s</span> clock_simWorldsRep<span class="main">,</span> <span class="tfree">'aAct</span><span class="main">)</span> MapOps"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">acts_MapOps</span> <span class="main">≡</span>
     <span class="main">⦇</span> MapOps.empty <span class="main">=</span> empty_trie<span class="main">,</span>
       lookup <span class="main">=</span> acts_MapOps_lookup<span class="main">,</span>
       update <span class="main">=</span> acts_MapOps_update <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> FiniteLinorderEnvironment<span class="main">)</span> acts_MapOps<span class="main">:</span>
  <span class="quoted"><span class="quoted">"MapOps clock_simAbs Clock.jkbpSEC acts_MapOps"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"MapOps.lookup acts_MapOps <span class="main">(</span>MapOps.empty acts_MapOps<span class="main">)</span> <span class="skolem">k</span> <span class="main">=</span> None"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> acts_MapOps_def acts_MapOps_lookup_def trie_odlist_lookup_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">e</span> <span class="skolem">k</span> <span class="skolem">k'</span> <span class="skolem">M</span>
  <span class="keyword3"><span class="command">assume</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"clock_simAbs <span class="skolem">k</span> <span class="main">∈</span> Clock.jkbpSEC"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> k'<span class="main">:</span> <span class="quoted"><span class="quoted">"clock_simAbs <span class="skolem">k'</span> <span class="main">∈</span> Clock.jkbpSEC"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"MapOps.lookup acts_MapOps <span class="main">(</span>MapOps.update acts_MapOps <span class="skolem">k</span> <span class="skolem">e</span> <span class="skolem">M</span><span class="main">)</span> <span class="skolem">k'</span>
         <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> clock_simAbs <span class="skolem">k'</span> <span class="main">=</span> clock_simAbs <span class="skolem">k</span>
             <span class="keyword1">then</span> Some <span class="skolem">e</span> <span class="keyword1">else</span> MapOps.lookup acts_MapOps <span class="skolem">M</span> <span class="skolem">k'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"clock_simAbs <span class="skolem">k'</span> <span class="main">=</span> clock_simAbs <span class="skolem">k</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="skolem">k'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> inj_onD<span class="main">[</span><span class="operator">OF</span> clock_simAbs_inj_on<span class="main">]</span> k k' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> prod_eqI<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> acts_MapOps_def acts_MapOps_lookup_def acts_MapOps_update_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lookup_trie_update lookup_trie_update_with
                     trie_odlist_update_with_def trie_odlist_update_def trie_odlist_lookup_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> acts_MapOps_def acts_MapOps_lookup_def acts_MapOps_update_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lookup_trie_update lookup_trie_update_with
                     trie_odlist_update_with_def trie_odlist_update_def trie_odlist_lookup_def
               <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> prod_eqI
              <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

We define two records <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"acts_MapOps"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"trans_MapOps"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
satisfying the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"MapOps"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> predicate
(\S\ref{sec:kbps-theory-map-ops}). Discharging the obligations in the
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Algorithm"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> locale is routine, leaning on the work of
\citet{DBLP:conf/itp/LammichL10}.

›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Locale instantiation›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

Finally we assemble the algorithm and discharge the proof obligations.

›</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> FiniteLinorderEnvironment
        <span class="main">&lt;</span> Clock<span class="main">:</span> Algorithm
            <span class="quoted"><span class="free">jkbp</span></span> <span class="quoted"><span class="free">envInit</span></span> <span class="quoted"><span class="free">envAction</span></span> <span class="quoted"><span class="free">envTrans</span></span> <span class="quoted"><span class="free">envVal</span></span>
            <span class="quoted">clock_jview</span> <span class="quoted"><span class="free">envObs</span></span> <span class="quoted">clock_jviewInit</span> <span class="quoted">clock_jviewIncr</span>
            <span class="quoted">clock_sim</span> <span class="quoted">clock_simRels</span> <span class="quoted">clock_simVal</span>
            <span class="quoted">clock_simAbs</span> <span class="quoted">clock_simObs</span> <span class="quoted">clock_simInit</span> <span class="quoted">clock_simTrans</span> <span class="quoted">clock_simAction</span>
            <span class="quoted">acts_MapOps</span> <span class="quoted">trans_MapOps</span>
<span class="comment1">(*&lt;*)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> clock_simInit<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> clock_simObs<span class="main">)</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> clock_simAction<span class="main">)</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> clock_simTrans<span class="main">)</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> acts_MapOps<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> trans_MapOps<span class="main">)</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

Explicitly, the algorithm for this case is:

›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mkClockAuto</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">agents</span> <span class="bound">jkbp</span> <span class="bound">envInit</span> <span class="bound">envAction</span> <span class="bound">envTrans</span> <span class="bound">envVal</span> <span class="bound">envObs</span><span class="main">.</span>
    mkAlgAuto acts_MapOps
              trans_MapOps
              <span class="main">(</span>clock_simObs <span class="bound">envObs</span><span class="main">)</span>
              <span class="main">(</span>clock_simInit <span class="bound">envInit</span> <span class="bound">envObs</span><span class="main">)</span>
              <span class="main">(</span>clock_simTrans <span class="bound">agents</span> <span class="bound">jkbp</span> <span class="bound">envAction</span> <span class="bound">envTrans</span> <span class="bound">envVal</span> <span class="bound">envObs</span><span class="main">)</span>
              <span class="main">(</span>clock_simAction <span class="bound">jkbp</span> <span class="bound">envVal</span> <span class="bound">envObs</span><span class="main">)</span>
              <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> map <span class="main">(</span>clock_simInit <span class="bound">envInit</span> <span class="bound">envObs</span> <span class="bound">a</span> <span class="main">∘</span> <span class="bound">envObs</span> <span class="bound">a</span><span class="main">)</span> <span class="bound">envInit</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> FiniteLinorderEnvironment<span class="main">)</span> mkClockAuto_implements<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Clock.implements
    <span class="main">(</span>mkClockAuto <span class="free">agents</span> <span class="free">jkbp</span> <span class="free">envInit</span> <span class="free">envAction</span> <span class="free">envTrans</span> <span class="free">envVal</span> <span class="free">envObs</span><span class="main">)</span>"</span></span>
<span class="comment1">(*&lt;*)</span>
  <span class="keyword1"><span class="command">using</span></span> Clock.k_mkAlgAuto_implements
  <span class="keyword1"><span class="command">unfolding</span></span> mkClockAuto_def mkAlgAuto_def Clock.k_frontier_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="comment1">(*

We actually run this unfolding of the algorithm. The lemma is keeping
us honest.

*)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ClockAutoDFS</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">agents</span> <span class="bound">jkbp</span> <span class="bound">envInit</span> <span class="bound">envAction</span> <span class="bound">envTrans</span> <span class="bound">envVal</span> <span class="bound">envObs</span><span class="main">.</span> <span class="main">λ</span><span class="bound">a</span><span class="main">.</span>
    alg_dfs acts_MapOps
            trans_MapOps
            <span class="main">(</span>clock_simObs <span class="bound">envObs</span> <span class="bound">a</span><span class="main">)</span>
            <span class="main">(</span>clock_simTrans <span class="bound">agents</span> <span class="bound">jkbp</span> <span class="bound">envAction</span> <span class="bound">envTrans</span> <span class="bound">envVal</span> <span class="bound">envObs</span> <span class="bound">a</span><span class="main">)</span>
            <span class="main">(</span>clock_simAction <span class="bound">jkbp</span> <span class="bound">envVal</span> <span class="bound">envObs</span> <span class="bound">a</span><span class="main">)</span>
            <span class="main">(</span>map <span class="main">(</span>clock_simInit <span class="bound">envInit</span> <span class="bound">envObs</span> <span class="bound">a</span> <span class="main">∘</span> <span class="bound">envObs</span> <span class="bound">a</span><span class="main">)</span> <span class="bound">envInit</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> FiniteLinorderEnvironment<span class="main">)</span>
  <span class="quoted"><span class="quoted">"mkClockAuto <span class="free">agents</span> <span class="free">jkbp</span> <span class="free">envInit</span> <span class="free">envAction</span> <span class="free">envTrans</span> <span class="free">envVal</span> <span class="free">envObs</span>
 <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> alg_mk_auto acts_MapOps trans_MapOps <span class="main">(</span>clock_simInit <span class="bound">a</span><span class="main">)</span> <span class="main">(</span>ClockAutoDFS <span class="free">agents</span> <span class="free">jkbp</span> <span class="free">envInit</span> <span class="free">envAction</span> <span class="free">envTrans</span> <span class="free">envVal</span> <span class="free">envObs</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mkClockAuto_def ClockAutoDFS_def mkAlgAuto_def alg_mk_auto_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

We discuss the clock semantics further in \S\ref{sec:kbps-alg-clock}.

›</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="SPRView">
<div class="head">
<h1>Theory SPRView</h1>
</div>
<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> SPRView
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="#KBPsAuto">KBPsAuto</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹The Synchronous Perfect-Recall View›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

\label{sec:kbps-theory-pr-view}

The synchronous perfect-recall (SPR) view records all observations the
agent has made on a given trace. This is the canonical
full-information synchronous view; all others are functions of this
one.

Intuitively it maintains a list of all observations made on the trace,
with the length of the list recording the time:

›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> Environment<span class="main">)</span> <span class="entity">spr_jview</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'obs</span> Trace<span class="main">)</span> JointView"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">spr_jview</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> tMap <span class="main">(</span><span class="free">envObs</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1"><span class="command">context</span></span> Environment
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="SPRView-spr_jview_length_eq"><span class="command">lemma</span></span> spr_jview_length_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"tLength <span class="main">(</span>spr_jview <span class="free">a</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> tLength <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spr_jview_def<span class="main">)</span>

<span class="keyword1" id="SPRView-spr_jview_tInit_inv"><span class="command">lemma</span></span> spr_jview_tInit_inv<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"spr_jview <span class="free">a</span> <span class="free">t</span> <span class="main">=</span> tInit <span class="free">obs</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">s</span><span class="main">.</span> <span class="free">t</span> <span class="main">=</span> tInit <span class="bound">s</span> <span class="main">∧</span> <span class="free">envObs</span> <span class="free">a</span> <span class="bound">s</span> <span class="main">=</span> <span class="free">obs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spr_jview_def<span class="main">)</span>

<span class="keyword1" id="SPRView-spr_jview_tStep_eq_inv"><span class="command">lemma</span></span> spr_jview_tStep_eq_inv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"spr_jview <span class="free">a</span> <span class="free">t'</span> <span class="main">=</span> spr_jview <span class="free">a</span> <span class="main">(</span><span class="free">t</span> <span class="main">↝</span> <span class="free">s</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">t''</span> <span class="bound">s'</span><span class="main">.</span> <span class="free">t'</span> <span class="main">=</span> <span class="bound">t''</span> <span class="main">↝</span> <span class="bound">s'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t'</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spr_jview_def<span class="main">)</span>

<span class="keyword1" id="SPRView-spr_jview_prefix_closed"><span class="command">lemma</span></span> spr_jview_prefix_closed<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"spr_jview <span class="free">a</span> <span class="main">(</span><span class="free">t</span> <span class="main">↝</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> spr_jview <span class="free">a</span> <span class="main">(</span><span class="free">t'</span> <span class="main">↝</span> <span class="free">s'</span><span class="main">)</span> <span class="main">⟹</span> spr_jview <span class="free">a</span> <span class="free">t</span> <span class="main">=</span> spr_jview <span class="free">a</span> <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spr_jview_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The corresponding incremental view appends a new observation to the
existing ones:

›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> Environment<span class="main">)</span> <span class="entity">spr_jviewInit</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'obs</span> <span class="main">⇒</span> <span class="tfree">'obs</span> Trace"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">spr_jviewInit</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">a</span> <span class="bound">obs</span><span class="main">.</span> tInit <span class="bound">obs</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> Environment<span class="main">)</span>
  <span class="entity">spr_jviewIncr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'obs</span> <span class="main">⇒</span> <span class="tfree">'obs</span> Trace <span class="main">⇒</span> <span class="tfree">'obs</span> Trace"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">spr_jviewIncr</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">a</span> <span class="bound">obs'</span> <span class="bound">tobs</span><span class="main">.</span> <span class="bound">tobs</span> <span class="main">↝</span> <span class="bound">obs'</span>"</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> Environment
        <span class="main">&lt;</span> SPR<span class="main">:</span> IncrEnvironment <span class="quoted"><span class="free">jkbp</span></span> <span class="quoted"><span class="free">envInit</span></span> <span class="quoted"><span class="free">envAction</span></span> <span class="quoted"><span class="free">envTrans</span></span> <span class="quoted"><span class="free">envVal</span></span>
                <span class="quoted">spr_jview</span> <span class="quoted"><span class="free">envObs</span></span> <span class="quoted">spr_jviewInit</span> <span class="quoted">spr_jviewIncr</span>
<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">t</span> <span class="skolem">t'</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"spr_jview <span class="skolem">a</span> <span class="skolem">t</span> <span class="main">=</span> spr_jview <span class="skolem">a</span> <span class="skolem">t'</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"tLength <span class="skolem">t</span> <span class="main">=</span> tLength <span class="skolem">t'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> spr_jview_length_eq<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">a</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span> <span class="bound">t</span> <span class="bound">t'</span><span class="main">.</span> spr_jview <span class="bound">a</span> <span class="bound">t</span> <span class="main">=</span> spr_jview <span class="bound">a</span> <span class="bound">t'</span> <span class="main">⟶</span> tLength <span class="bound">t</span> <span class="main">=</span> tLength <span class="bound">t'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span> <span class="bound">s</span><span class="main">.</span> spr_jviewInit <span class="bound">a</span> <span class="main">(</span><span class="free">envObs</span> <span class="bound">a</span> <span class="bound">s</span><span class="main">)</span> <span class="main">=</span> spr_jview <span class="bound">a</span> <span class="main">(</span>tInit <span class="bound">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> spr_jviewInit_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spr_jview_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">.</span> spr_jview <span class="bound">a</span> <span class="main">(</span><span class="bound">t</span> <span class="main">↝</span> <span class="bound">s</span><span class="main">)</span> <span class="main">=</span> spr_jviewIncr <span class="bound">a</span> <span class="main">(</span><span class="free">envObs</span> <span class="bound">a</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>spr_jview <span class="bound">a</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> spr_jviewIncr_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spr_jview_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* These need to follow the locale instantiation as we appeal to
sync. *)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> Environment<span class="main">)</span> spr_tFirst<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"spr_jview <span class="free">a</span> <span class="free">t</span> <span class="main">=</span> spr_jview <span class="free">a</span> <span class="free">t'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">envObs</span> <span class="free">a</span> <span class="main">(</span>tFirst <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">envObs</span> <span class="free">a</span> <span class="main">(</span>tFirst <span class="free">t'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> SPR.sync<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> v<span class="main">]</span> v
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trace_induct2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spr_jview_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> Environment<span class="main">)</span> spr_tLast<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"spr_jview <span class="free">a</span> <span class="free">t</span> <span class="main">=</span> spr_jview <span class="free">a</span> <span class="free">t'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">envObs</span> <span class="free">a</span> <span class="main">(</span>tLast <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">envObs</span> <span class="free">a</span> <span class="main">(</span>tLast <span class="free">t'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> SPR.sync<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> v<span class="main">]</span> v
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trace_induct2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spr_jview_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

\citet[Theorem~5]{Ron:1996} showed that it is not the case that
finite-state implementations always exist with respect to the SPR
view, and so we consider three special cases:
\begin{itemize}

\item[\S\ref{sec:kbps-spr-single-agent}] where there is a single
agent;

\item[\S\ref{sec:kbps-theory-spr-deterministic-protocols}] when the
protocols of the agents are deterministic and communication is by
broadcast; and

\item[\S\ref{sec:kbps-theory-spr-non-deterministic-protocols}] when
the agents use non-deterministic protocols and again use broadcast to
communicate.

\end{itemize}
Note that these cases do overlap but none is wholly
contained in another.

›</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="SPRViewDet">
<div class="head">
<h1>Theory SPRViewDet</h1>
</div>
<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="comment1">(*
 * Knowledge-based programs.
 * (C)opyright 2011, Peter Gammie, peteg42 at gmail.com.
 * License: BSD
 *)</span>

<span class="keyword1"><span class="command">theory</span></span> SPRViewDet
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="#SPRView">SPRView</a>
  <a href="#KBPsAlg">KBPsAlg</a>
  <a href="#Eval">Eval</a>
  <a href="#List_local">List_local</a>
  <a href="#ODList">ODList</a> <a href="#Trie2">Trie2</a>
  <span class="quoted">"<a href="../Transitive-Closure/Transitive_Closure_List_Impl.html">Transitive-Closure.Transitive_Closure_List_Impl</a>"</span>
  <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Mapping.html">HOL-Library.Mapping</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Perfect Recall in Deterministic Broadcast Environments›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

\label{sec:kbps-theory-spr-deterministic-protocols}

It is well known that simultaneous broadcast has the effect of making
information \emph{common knowledge}; roughly put, the agents all learn
the same things at the same time as the system evolves, so the
relation amongst the agents' states of knowledge never becomes more
complex than it is in the initial state
\citep[Chapter~6]{FHMV:1995}. For this reason we might hope to find
finite-state implementations of JKBPs in broadcast environments.

The broadcast assumption by itself is insufficient in general, however
\citep[\S7]{Ron:1996}, and so we need to further constrain the
scenario. Here we require that for each canonical trace the JKBP
prescribes at most one action. In practice this constraint is easier
to verify than the circularity would suggest; we return to this point
at the end of this section.

›</span></span>

<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹
\begin{figure}[tb]
\begin{isabellebody}%
›</span></span>

<span class="keyword1"><span class="command">record</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">overloaded</span></span><span class="main">)</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'ps</span><span class="main">)</span> BEState <span class="main">=</span>
  es <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'es</span>"</span></span>
  ps <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'ps</span><span class="main">)</span> odlist"</span></span>

<span class="keyword1"><span class="command">locale</span></span> FiniteDetBroadcastEnvironment <span class="main">=</span>
  Environment <span class="quoted"><span class="free">jkbp</span></span> <span class="quoted"><span class="free">envInit</span></span> <span class="quoted"><span class="free">envAction</span></span> <span class="quoted"><span class="free">envTrans</span></span> <span class="quoted"><span class="free">envVal</span></span> <span class="quoted"><span class="free">envObs</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">jkbp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>finite<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'aAct</span><span class="main">)</span> KBP"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">envInit</span>
         <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span> <span class="main">::</span> <span class="main">{</span>finite<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'as</span> <span class="main">::</span> <span class="main">{</span>finite<span class="main">,</span>linorder<span class="main">}</span><span class="main">)</span> BEState list"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">envAction</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> BEState <span class="main">⇒</span> <span class="tfree">'eAct</span> list"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">envTrans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'eAct</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'aAct</span><span class="main">)</span>
                     <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> BEState <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> BEState"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">envVal</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> BEState <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">envObs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> BEState <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'cobs</span> <span class="main">×</span> <span class="tfree">'as</span> option<span class="main">)</span>"</span></span>

<span class="main">+</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">agents</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> odlist"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">envObsC</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'es</span> <span class="main">⇒</span> <span class="tfree">'cobs</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">envObs</span> <span class="free">a</span> <span class="free">s</span> <span class="main">≡</span> <span class="main">(</span><span class="free">envObsC</span> <span class="main">(</span>es <span class="free">s</span><span class="main">)</span><span class="main">,</span> ODList.lookup <span class="main">(</span>ps <span class="free">s</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> agents<span class="main">:</span> <span class="quoted"><span class="quoted">"ODList.toSet <span class="free">agents</span> <span class="main">=</span> UNIV"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> envTrans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">s'</span> <span class="bound">a</span> <span class="bound">eact</span> <span class="bound">eact'</span> <span class="bound">aact</span> <span class="bound">aact'</span><span class="main">.</span>
            ODList.lookup <span class="main">(</span>ps <span class="bound">s</span><span class="main">)</span> <span class="bound">a</span> <span class="main">=</span> ODList.lookup <span class="main">(</span>ps <span class="bound">s'</span><span class="main">)</span> <span class="bound">a</span> <span class="main">∧</span> <span class="bound">aact</span> <span class="bound">a</span> <span class="main">=</span> <span class="bound">aact'</span> <span class="bound">a</span>
             <span class="main">⟶</span> ODList.lookup <span class="main">(</span>ps <span class="main">(</span><span class="free">envTrans</span> <span class="bound">eact</span> <span class="bound">aact</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="bound">a</span>
               <span class="main">=</span> ODList.lookup <span class="main">(</span>ps <span class="main">(</span><span class="free">envTrans</span> <span class="bound">eact'</span> <span class="bound">aact'</span> <span class="bound">s'</span><span class="main">)</span><span class="main">)</span> <span class="bound">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> jkbpDet<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span><span class="main">.</span> <span class="main">∀</span><span class="bound">t</span> <span class="main">∈</span> SPR.jkbpC<span class="main">.</span> length <span class="main">(</span>jAction SPR.MC <span class="bound">t</span> <span class="bound">a</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹
  \end{isabellebody}%
  \caption{Finite broadcast environments with a deterministic JKBP.}
  \label{fig:kbps-theory-det-broadcast-envs}
\end{figure}
›</span></span><span class="comment1">(*&lt;*)</span>

<span class="keyword1"><span class="command">instantiation</span></span> BEState_ext <span class="main">::</span> <span class="main">(</span><span class="quoted">linorder</span><span class="main">,</span> <span class="quoted">linorder</span><span class="main">,</span> <span class="quoted">linorder</span><span class="main">,</span> <span class="quoted">linorder</span><span class="main">)</span> <span class="quoted">linorder</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">less_eq_BEState_ext</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> es <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> es <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">∨</span> <span class="main">(</span>es <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> es <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">∧</span> <span class="main">(</span>ps <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> ps <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">∨</span> <span class="main">(</span>ps <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> ps <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">∧</span> more <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≤</span> more <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">less_BEState_ext</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> es <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> es <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">∨</span> <span class="main">(</span>es <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> es <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">∧</span> <span class="main">(</span>ps <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> ps <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">∨</span> <span class="main">(</span>ps <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> ps <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">∧</span> more <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> more <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">intro_classes</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> less_eq_BEState_ext_def less_BEState_ext_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instance</span></span> BEState_ext <span class="main">::</span> <span class="main">(</span><span class="quoted"><span class="quoted">"<span class="main">{</span>finite<span class="main">,</span> linorder<span class="main">}</span>"</span></span><span class="main">,</span> <span class="quoted">finite</span><span class="main">,</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>finite<span class="main">,</span> linorder<span class="main">}</span>"</span></span><span class="main">,</span> <span class="quoted">finite</span><span class="main">)</span> <span class="quoted">finite</span>
<span class="keyword1"><span class="command">proof</span></span>
 <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?U</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"UNIV <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> BEState_ext set"</span></span>
 <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> BEState_scheme"</span></span>
   <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">=</span> BEState_ext <span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span> <span class="operator">simp</span>
 <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> U<span class="main">:</span>
   <span class="quoted"><span class="quoted">"<span class="var">?U</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span><span class="main">.</span> BEState_ext <span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="main">(</span>UNIV <span class="main">×</span> UNIV<span class="main">)</span> <span class="main">×</span> UNIV<span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Set.image_def<span class="main">)</span>
 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?U</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> U<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

We encode our expectations of the scenario in the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="free">FiniteBroadcastEnvironment</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> locale of
Figure~\ref{fig:kbps-theory-det-broadcast-envs}. The broadcast is
modelled by having all agents make the same common observation of the
shared state of type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'es</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. We also allow each agent to
maintain a private state of type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'ps</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>; that other agents
cannot influence it or directly observe it is enforced by the
constraint <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>envTrans›</span></span></span></span> and the definition of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">envObs</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

We do however allow the environment's protocol to be non-deterministic
and a function of the entire system state, including private states.

›</span></span>

<span class="keyword1"><span class="command">context</span></span> FiniteDetBroadcastEnvironment
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="comment1">(* ouch *)</span>
<span class="keyword1" id="SPRViewDet-envObs_def_raw"><span class="command">lemma</span></span> envObs_def_raw<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">envObs</span> <span class="free">a</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="free">envObsC</span> <span class="main">(</span>es <span class="bound">s</span><span class="main">)</span><span class="main">,</span> ODList.lookup <span class="main">(</span>ps <span class="bound">s</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> envObs_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

We seek a suitable simulation space by considering what determines an
agent's knowledge. Intuitively any set of traces that is relevant to
the agents' states of knowledge with respect to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">t</span></span> <span class="main"><span class="main">∈</span></span> <span class="free"><span class="free">jkbpC</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
need include only those with the same common observation as <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="free">t</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>:

›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">tObsC</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> BEState Trace <span class="main">⇒</span> <span class="tfree">'cobs</span> Trace"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">tObsC</span> <span class="main">≡</span> tMap <span class="main">(</span><span class="free">envObsC</span> <span class="main">∘</span> es<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

Clearly this is an abstraction of the SPR jview of the given trace.

›</span></span>

<span class="keyword1" id="SPRViewDet-spr_jview_tObsC"><span class="command">lemma</span></span> spr_jview_tObsC<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"spr_jview <span class="free">a</span> <span class="free">t</span> <span class="main">=</span> spr_jview <span class="free">a</span> <span class="free">t'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"tObsC <span class="free">t</span> <span class="main">=</span> tObsC <span class="free">t'</span>"</span></span>
<span class="comment1">(*&lt;*)</span>
  <span class="keyword1"><span class="command">using</span></span> SPR.sync<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> assms<span class="main">]</span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trace_induct2<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> envObs_def tObsC_def<span class="main">)</span>

<span class="keyword1" id="SPRViewDet-tObsC_tLength"><span class="command">lemma</span></span> tObsC_tLength<span class="main">:</span>
  <span class="quoted"><span class="quoted">"tObsC <span class="free">t</span> <span class="main">=</span> tObsC <span class="free">t'</span> <span class="main">⟹</span> tLength <span class="free">t</span> <span class="main">=</span> tLength <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> tObsC_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> tMap_eq_imp_tLength_eq<span class="main">)</span>

<span class="keyword1" id="SPRViewDet-tObsC_tStep_eq_inv"><span class="command">lemma</span></span> tObsC_tStep_eq_inv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"tObsC <span class="free">t'</span> <span class="main">=</span> tObsC <span class="main">(</span><span class="free">t</span> <span class="main">↝</span> <span class="free">s</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">t''</span> <span class="bound">s'</span><span class="main">.</span> <span class="free">t'</span> <span class="main">=</span> <span class="bound">t''</span> <span class="main">↝</span> <span class="bound">s'</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> tObsC_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="SPRViewDet-tObsC_prefix_closed"><span class="command">lemma</span></span> tObsC_prefix_closed<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"tObsC <span class="main">(</span><span class="free">t</span> <span class="main">↝</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> tObsC <span class="main">(</span><span class="free">t'</span> <span class="main">↝</span> <span class="free">s'</span><span class="main">)</span> <span class="main">⟹</span> tObsC <span class="free">t</span> <span class="main">=</span> tObsC <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> tObsC_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="SPRViewDet-tObsC_tLast"><span class="command">lemma</span></span> tObsC_tLast<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"tLast <span class="main">(</span>tObsC <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">envObsC</span> <span class="main">(</span>es <span class="main">(</span>tLast <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> tObsC_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="SPRViewDet-tObsC_initial"><span class="command">lemma</span></span> tObsC_initial<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"tFirst <span class="main">(</span>tObsC <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">envObsC</span> <span class="main">(</span>es <span class="main">(</span>tFirst <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"tObsC <span class="main">(</span>tInit <span class="free">s</span><span class="main">)</span> <span class="main">=</span> tInit <span class="main">(</span><span class="free">envObsC</span> <span class="main">(</span>es <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"tObsC <span class="free">t</span> <span class="main">=</span> tInit <span class="free">cobs</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">s</span><span class="main">.</span> <span class="free">t</span> <span class="main">=</span> tInit <span class="bound">s</span> <span class="main">∧</span> <span class="free">envObsC</span> <span class="main">(</span>es <span class="bound">s</span><span class="main">)</span> <span class="main">=</span> <span class="free">cobs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> tObsC_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1" id="SPRViewDet-spr_tObsC_trc_aux"><span class="command">lemma</span></span> spr_tObsC_trc_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">t</span><span class="main">,</span> <span class="free">t'</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">a</span><span class="main">.</span> relations SPR.MC <span class="bound">a</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"tObsC <span class="free">t</span> <span class="main">=</span> tObsC <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spr_jview_tObsC<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="SPRViewDet-spr_jview_tObsC_trans"><span class="command">lemma</span></span> spr_jview_tObsC_trans<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>spr_jview <span class="free">a</span> <span class="free">t</span> <span class="main">=</span> spr_jview <span class="free">a</span> <span class="free">t'</span><span class="main">;</span> spr_jview <span class="free">a'</span> <span class="free">t'</span> <span class="main">=</span> spr_jview <span class="free">a'</span> <span class="free">t''</span><span class="main">⟧</span>
     <span class="main">⟹</span> tObsC <span class="free">t</span> <span class="main">=</span> tObsC <span class="free">t''</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> spr_jview_tObsC<span class="main">)</span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

Unlike the single-agent case of \S\ref{sec:kbps-spr-single-agent}, it
is not sufficient for a simulation to record only the final states; we
need to relate the initial private states of the agents with the final
states they consider possible, as the initial states may contain
information that is not common knowledge. This motivates the following
abstraction:

›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">tObsC_abs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> BEState Trace <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> BEState Relation"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">tObsC_abs</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> <span class="main">{</span> <span class="main">(</span>tFirst <span class="bound">t'</span><span class="main">,</span> tLast <span class="bound">t'</span><span class="main">)</span>
                    <span class="main">|</span><span class="bound">t'</span><span class="main">.</span> <span class="bound">t'</span> <span class="main">∈</span> SPR.jkbpC <span class="main">∧</span> tObsC <span class="bound">t'</span> <span class="main">=</span> tObsC <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">}</span>"</span></span>
<span class="comment1">(*&lt;*)</span>
<span class="keyword1" id="SPRViewDet-tObsC_abs_jview_eq"><span class="command">lemma</span></span> tObsC_abs_jview_eq<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"spr_jview <span class="free">a</span> <span class="free">t'</span> <span class="main">=</span> spr_jview <span class="free">a</span> <span class="free">t</span>
    <span class="main">⟹</span> tObsC_abs <span class="free">t</span> <span class="main">=</span> tObsC_abs <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> tObsC_abs_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> spr_jview_tObsC<span class="main">)</span>

<span class="keyword1" id="SPRViewDet-tObsC_abs_tObsC_eq"><span class="command">lemma</span></span> tObsC_abs_tObsC_eq<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"tObsC <span class="free">t'</span> <span class="main">=</span> tObsC <span class="free">t</span>
    <span class="main">⟹</span> tObsC_abs <span class="free">t</span> <span class="main">=</span> tObsC_abs <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> tObsC_abs_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> spr_jview_tObsC<span class="main">)</span>

<span class="keyword1" id="SPRViewDet-spr_jview_tObsCI"><span class="command">lemma</span></span> spr_jview_tObsCI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tt'<span class="main">:</span> <span class="quoted"><span class="quoted">"tObsC <span class="free">t</span> <span class="main">=</span> tObsC <span class="free">t'</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> first<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">envObs</span> <span class="free">a</span> <span class="main">(</span>tFirst <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">envObs</span> <span class="free">a</span> <span class="main">(</span>tFirst <span class="free">t'</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"tMap <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> ODList.lookup <span class="main">(</span>ps <span class="bound">s</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> tMap <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> ODList.lookup <span class="main">(</span>ps <span class="bound">s</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span> <span class="free">t'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"spr_jview <span class="free">a</span> <span class="free">t</span> <span class="main">=</span> spr_jview <span class="free">a</span> <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> tObsC_tLength<span class="main">[</span><span class="operator">OF</span> tt'<span class="main">]</span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trace_induct2<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> tObsC_def envObs_def spr_jview_def<span class="main">)</span>

<span class="keyword1" id="SPRViewDet-tObsC_absI"><span class="command">lemma</span></span> tObsC_absI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">t'</span> <span class="main">∈</span> SPR.jkbpC<span class="main">;</span> tObsC <span class="free">t'</span> <span class="main">=</span> tObsC <span class="free">t</span><span class="main">;</span> <span class="free">u</span> <span class="main">=</span> tFirst <span class="free">t'</span><span class="main">;</span> <span class="free">v</span> <span class="main">=</span> tLast <span class="free">t'</span> <span class="main">⟧</span>
    <span class="main">⟹</span> <span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">∈</span> tObsC_abs <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> tObsC_abs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="SPRViewDet-tObsC_abs_conv"><span class="command">lemma</span></span> tObsC_abs_conv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">∈</span> tObsC_abs <span class="free">t</span>
    <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="bound">t'</span> <span class="main">∈</span> SPR.jkbpC <span class="main">∧</span> tObsC <span class="bound">t'</span> <span class="main">=</span> tObsC <span class="free">t</span> <span class="main">∧</span> <span class="free">u</span> <span class="main">=</span> tFirst <span class="bound">t'</span> <span class="main">∧</span> <span class="free">v</span> <span class="main">=</span> tLast <span class="bound">t'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> tObsC_abs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="SPRViewDet-tObsC_abs_tLast"><span class="command">lemma</span></span> tObsC_abs_tLast<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">∈</span> tObsC_abs <span class="free">t</span> <span class="main">⟹</span> <span class="free">envObsC</span> <span class="main">(</span>es <span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="free">envObsC</span> <span class="main">(</span>es <span class="main">(</span>tLast <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> tObsC_abs_def tObsC_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> o_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> tMap_tLast_inv<span class="main">)</span>

<span class="keyword1" id="SPRViewDet-tObsC_abs_tInit"><span class="command">lemma</span></span> tObsC_abs_tInit<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"tObsC_abs <span class="main">(</span>tInit <span class="free">s</span><span class="main">)</span>
 <span class="main">=</span> <span class="main">{</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">|</span><span class="bound">s'</span><span class="main">.</span> <span class="bound">s'</span> <span class="main">∈</span> set <span class="free">envInit</span> <span class="main">∧</span> <span class="free">envObsC</span> <span class="main">(</span>es <span class="bound">s'</span><span class="main">)</span> <span class="main">=</span> <span class="free">envObsC</span> <span class="main">(</span>es <span class="free">s</span><span class="main">)</span> <span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> tObsC_abs_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"tInit <span class="improper">s'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹›</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context FiniteDetBroadcastEnvironment *)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

We use the following record to represent the worlds of the simulated
Kripke structure:

›</span></span>

<span class="keyword1"><span class="command">record</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">overloaded</span></span><span class="main">)</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> spr_simWorld <span class="main">=</span>
  sprFst <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> BEState"</span></span>
  sprLst <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> BEState"</span></span>
  sprCRel <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> BEState Relation"</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">instance</span></span> spr_simWorld_ext <span class="main">::</span> <span class="main">(</span><span class="quoted"><span class="quoted">"<span class="main">{</span>finite<span class="main">,</span> linorder<span class="main">}</span>"</span></span><span class="main">,</span> <span class="quoted">finite</span><span class="main">,</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>finite<span class="main">,</span> linorder<span class="main">}</span>"</span></span><span class="main">,</span> <span class="quoted">finite</span><span class="main">)</span> <span class="quoted">finite</span>
<span class="keyword1"><span class="command">proof</span></span>
 <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?U</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"UNIV <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> spr_simWorld_ext set"</span></span>
 <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> spr_simWorld_scheme"</span></span>
   <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span> <span class="bound">d</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">=</span> spr_simWorld_ext <span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span> <span class="bound">d</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span> <span class="operator">simp</span>
 <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> U<span class="main">:</span>
   <span class="quoted"><span class="quoted">"<span class="var">?U</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="main">(</span><span class="bound">c</span><span class="main">,</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> spr_simWorld_ext <span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span> <span class="bound">d</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>UNIV <span class="main">×</span> <span class="main">(</span>UNIV <span class="main">×</span> <span class="main">(</span>UNIV <span class="main">×</span> UNIV<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Set.image_def<span class="main">)</span>
 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?U</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> U<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">context</span></span> FiniteDetBroadcastEnvironment
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The simulation of a trace <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">t</span></span> <span class="main"><span class="main">∈</span></span> <span class="free"><span class="free">jkbpC</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> records its initial and
final states, and the relation between initial and final states of all
commonly-plausible traces:

›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">spr_sim</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> BEState Trace <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> spr_simWorld"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">spr_sim</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">⦇</span> sprFst <span class="main">=</span> tFirst <span class="bound">t</span><span class="main">,</span> sprLst <span class="main">=</span> tLast <span class="bound">t</span><span class="main">,</span> sprCRel <span class="main">=</span> tObsC_abs <span class="bound">t</span> <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The associated Kripke structure relates two worlds for an agent if the
agent's observation on the the first and last states corresponds, and
the worlds have the same common observation relation. As always, we
evaluate propositions on the final state of the trace.

›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">spr_simRels</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> spr_simWorld Relation"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">spr_simRels</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">{</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">|</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span>
                         <span class="free">envObs</span> <span class="bound">a</span> <span class="main">(</span>sprFst <span class="bound">s</span><span class="main">)</span> <span class="main">=</span> <span class="free">envObs</span> <span class="bound">a</span> <span class="main">(</span>sprFst <span class="bound">s'</span><span class="main">)</span>
                       <span class="main">∧</span> <span class="free">envObs</span> <span class="bound">a</span> <span class="main">(</span>sprLst <span class="bound">s</span><span class="main">)</span> <span class="main">=</span> <span class="free">envObs</span> <span class="bound">a</span> <span class="main">(</span>sprLst <span class="bound">s'</span><span class="main">)</span>
                       <span class="main">∧</span> sprCRel <span class="bound">s</span> <span class="main">=</span> sprCRel <span class="bound">s'</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">spr_simVal</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> spr_simWorld <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">spr_simVal</span> <span class="main">≡</span> <span class="free">envVal</span> <span class="main">∘</span> sprLst"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">spr_simMC</span> <span class="main">≡</span> mkKripke <span class="main">(</span>spr_sim <span class="main">`</span> SPR.jkbpC<span class="main">)</span> spr_simRels spr_simVal"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1" id="SPRViewDet-spr_sim_tFirst_tLast"><span class="command">lemma</span></span> spr_sim_tFirst_tLast<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> spr_sim <span class="free">t</span> <span class="main">=</span> <span class="free">s</span><span class="main">;</span> <span class="free">t</span> <span class="main">∈</span> SPR.jkbpC <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span>sprFst <span class="free">s</span><span class="main">,</span> sprLst <span class="free">s</span><span class="main">)</span> <span class="main">∈</span> sprCRel <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> spr_sim_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="SPRViewDet-spr_sim_tObsC_abs"><span class="command">lemma</span></span> spr_sim_tObsC_abs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"tObsC_abs <span class="free">t</span> <span class="main">=</span> sprCRel <span class="main">(</span>spr_sim <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> tObsC_abs_def spr_sim_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="SPRViewDet-spr_simVal_eq"><span class="command">lemma</span></span> spr_simVal_eq<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"spr_simVal <span class="main">(</span>spr_sim <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">envVal</span> <span class="main">(</span>tLast <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> spr_sim_def spr_simVal_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="SPRViewDet-spr_sim_range"><span class="command">lemma</span></span> spr_sim_range<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sim_range SPR.MC spr_simMC spr_sim"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sim_rangeI<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spr_sim_def<span class="main">)</span>

<span class="keyword1" id="SPRViewDet-spr_simVal"><span class="command">lemma</span></span> spr_simVal<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sim_val SPR.MC spr_simMC spr_sim"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sim_valI<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1" id="SPRViewDet-spr_sim_f"><span class="command">lemma</span></span> spr_sim_f<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sim_f SPR.MC spr_simMC spr_sim"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> spr_simRels_def spr_sim_def mkKripke_def SPR.mkM_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sim_fI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="SPRViewDet-envDetJKBP'"><span class="command">lemma</span></span> envDetJKBP'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tCn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> SPR.jkbpCn <span class="free">n</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> aact<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">act</span> <span class="main">∈</span> set <span class="main">(</span>jAction <span class="main">(</span>SPR.MCn <span class="free">n</span><span class="main">)</span> <span class="free">t</span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"jAction <span class="main">(</span>SPR.MCn <span class="free">n</span><span class="main">)</span> <span class="free">t</span> <span class="free">a</span> <span class="main">=</span> <span class="main">[</span><span class="free">act</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> jkbpDet<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">t</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">a</span></span><span class="main">]</span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"jAction SPR.MC <span class="free">t</span> <span class="free">a</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> SPR.jkbpC_jkbpCn_jAction_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> tCn<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> SPR.jkbpCn_jkbpC_inc<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

All the properties of a simulation are easy to show for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>
<span class="quoted"><span class="quoted">"spr_sim"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> except for reverse simulation.

The critical lemma states that if we have two traces that yield the
same common observations, and an agent makes the same observation on
their initial states, then that agent's private states at each point
on the two traces are identical.

›</span></span>

<span class="keyword1" id="SPRViewDet-spr_jview_det_ps"><span class="command">lemma</span></span> spr_jview_det_ps<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tt'C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">t</span><span class="main">,</span> <span class="free">t'</span><span class="main">}</span> <span class="main">⊆</span> SPR.jkbpC"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> obsCtt'<span class="main">:</span> <span class="quoted"><span class="quoted">"tObsC <span class="free">t</span> <span class="main">=</span> tObsC <span class="free">t'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> first<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">envObs</span> <span class="free">a</span> <span class="main">(</span>tFirst <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">envObs</span> <span class="free">a</span> <span class="main">(</span>tFirst <span class="free">t'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"tMap <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> ODList.lookup <span class="main">(</span>ps <span class="bound">s</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span> <span class="free">t</span>
       <span class="main">=</span> tMap <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> ODList.lookup <span class="main">(</span>ps <span class="bound">s</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span> <span class="free">t'</span>"</span></span>
<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">using</span></span> tObsC_tLength<span class="main">[</span><span class="operator">OF</span> obsCtt'<span class="main">]</span> first tt'C obsCtt'
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trace_induct2<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tInit <span class="skolem">s</span> <span class="skolem">s'</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> envObs_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tStep <span class="skolem">s</span> <span class="skolem">s'</span> <span class="skolem">t</span> <span class="skolem">t'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> tStep
  <span class="keyword1"><span class="command">have</span></span> ts<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">↝</span> <span class="skolem">s</span> <span class="main">∈</span> SPR.jkbpCn <span class="main">(</span>tLength <span class="main">(</span><span class="skolem">t</span> <span class="main">↝</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> t's'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">↝</span> <span class="skolem">s'</span> <span class="main">∈</span> SPR.jkbpCn <span class="main">(</span>tLength <span class="main">(</span><span class="skolem">t'</span> <span class="main">↝</span> <span class="skolem">s'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">from</span></span> tStep <span class="keyword1"><span class="command">have</span></span> jvtt'<span class="main">:</span> <span class="quoted"><span class="quoted">"spr_jview <span class="free">a</span> <span class="skolem">t</span> <span class="main">=</span> spr_jview <span class="free">a</span> <span class="skolem">t'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">rule</span> spr_jview_tObsCI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> tStep <span class="keyword1"><span class="command">have</span></span> jatt'<span class="main">:</span>
    <span class="quoted"><span class="quoted">"jAction <span class="main">(</span>SPR.MCn <span class="main">(</span>tLength <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t</span> <span class="free">a</span>
   <span class="main">=</span> jAction <span class="main">(</span>SPR.MCn <span class="main">(</span>tLength <span class="skolem">t'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t'</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> S5n_jAction_eq<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">unfolding</span></span> SPR.mkM_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">from</span></span> jvtt'
  <span class="keyword1"><span class="command">have</span></span> tt'Last<span class="main">:</span> <span class="quoted"><span class="quoted">"ODList.lookup <span class="main">(</span>ps <span class="main">(</span>tLast <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="free">a</span>
               <span class="main">=</span> ODList.lookup <span class="main">(</span>ps <span class="main">(</span>tLast <span class="skolem">t'</span><span class="main">)</span><span class="main">)</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> envObs_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> ts <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">eact</span></span> <span class="skolem"><span class="skolem">aact</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> aact<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span><span class="main">.</span> <span class="skolem">aact</span> <span class="bound">a</span> <span class="main">∈</span> set <span class="main">(</span>jAction <span class="main">(</span>SPR.MCn <span class="main">(</span>tLength <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> <span class="free">envTrans</span> <span class="skolem">eact</span> <span class="skolem">aact</span> <span class="main">(</span>tLast <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> t's' <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">eact'</span></span> <span class="skolem"><span class="skolem">aact'</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> aact'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span><span class="main">.</span> <span class="skolem">aact'</span> <span class="bound">a</span> <span class="main">∈</span> set <span class="main">(</span>jAction <span class="main">(</span>SPR.MCn <span class="main">(</span>tLength <span class="skolem">t'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t'</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> s'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s'</span> <span class="main">=</span> <span class="free">envTrans</span> <span class="skolem">eact'</span> <span class="skolem">aact'</span> <span class="main">(</span>tLast <span class="skolem">t'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> tStep <span class="keyword1"><span class="command">have</span></span> tCn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> SPR.jkbpCn <span class="main">(</span>tLength <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> aact
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">act</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"jAction <span class="main">(</span>SPR.MCn <span class="main">(</span>tLength <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t</span> <span class="free">a</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">act</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> envDetJKBP'<span class="main">[</span><span class="operator">OF</span> tCn<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> act<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">aact</span> <span class="free">a</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"jAction <span class="main">(</span>SPR.MCn <span class="main">(</span>tLength <span class="skolem">t'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t'</span> <span class="free">a</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">act</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> jatt'<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> act aact aact'
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">aact</span> <span class="free">a</span> <span class="main">=</span> <span class="skolem">aact'</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> allE<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">a</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> agents tt'Last s s'
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ODList.lookup <span class="main">(</span>ps <span class="skolem">s</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> ODList.lookup <span class="main">(</span>ps <span class="skolem">s'</span><span class="main">)</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> envTrans<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> tStep <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tMap <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> ODList.lookup <span class="main">(</span>ps <span class="bound">s</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">=</span> tMap <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> ODList.lookup <span class="main">(</span>ps <span class="bound">s</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span> <span class="skolem">t'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> tStep <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">envObsC</span> <span class="main">(</span>es <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span> <span class="free">envObsC</span> <span class="main">(</span>es <span class="skolem">s'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> tObsC_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SPRViewDet-spr_sim_r"><span class="command">lemma</span></span> spr_sim_r<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sim_r SPR.MC spr_simMC spr_sim"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> sim_rI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">p</span> <span class="skolem">q'</span>
  <span class="keyword3"><span class="command">assume</span></span> pT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> worlds SPR.MC"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> fpq'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>spr_sim <span class="skolem">p</span><span class="main">,</span> <span class="skolem">q'</span><span class="main">)</span> <span class="main">∈</span> relations spr_simMC <span class="skolem">a</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> fpq' <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">uq</span></span> <span class="skolem"><span class="skolem">fq</span></span> <span class="skolem"><span class="skolem">vq</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> q'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span> <span class="main">=</span> <span class="main">⦇</span> sprFst <span class="main">=</span> <span class="skolem">uq</span><span class="main">,</span> sprLst <span class="main">=</span> <span class="skolem">vq</span><span class="main">,</span> sprCRel <span class="main">=</span> tObsC_abs <span class="skolem">p</span> <span class="main">⦈</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> uq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">envObs</span> <span class="skolem">a</span> <span class="main">(</span>tFirst <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> <span class="free">envObs</span> <span class="skolem">a</span> <span class="skolem">uq</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> vq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">envObs</span> <span class="skolem">a</span> <span class="main">(</span>tLast <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> <span class="free">envObs</span> <span class="skolem">a</span> <span class="skolem">vq</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mkKripke_def spr_sim_def spr_simRels_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

  <span class="keyword1"><span class="command">from</span></span> fpq' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span> <span class="main">∈</span> worlds spr_simMC"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> q' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">uq</span><span class="main">,</span> <span class="skolem">vq</span><span class="main">)</span> <span class="main">∈</span> tObsC_abs <span class="skolem">p</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> spr_sim_tFirst_tLast<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> s<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">q'</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> tT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> SPR.jkbpC"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> tp<span class="main">:</span> <span class="quoted"><span class="quoted">"tObsC <span class="skolem">t</span> <span class="main">=</span> tObsC <span class="skolem">p</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> tuq<span class="main">:</span> <span class="quoted"><span class="quoted">"tFirst <span class="skolem">t</span> <span class="main">=</span> <span class="skolem">uq</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> tvq<span class="main">:</span> <span class="quoted"><span class="quoted">"tLast <span class="skolem">t</span> <span class="main">=</span> <span class="skolem">vq</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> tObsC_abs_conv<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> pT tT tp tuq uq
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tMap <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> ODList.lookup <span class="main">(</span>ps <span class="bound">s</span><span class="main">)</span> <span class="skolem">a</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">=</span> tMap <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> ODList.lookup <span class="main">(</span>ps <span class="bound">s</span><span class="main">)</span> <span class="skolem">a</span><span class="main">)</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> spr_jview_det_ps<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> tp tuq uq
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"spr_jview <span class="skolem">a</span> <span class="skolem">p</span> <span class="main">=</span> spr_jview <span class="skolem">a</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> spr_jview_tObsCI<span class="main">)</span>

  <span class="keyword1"><span class="command">with</span></span> pT tT <span class="keyword1"><span class="command">have</span></span> pt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> relations SPR.MC <span class="skolem">a</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> SPR.mkM_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> q' uq vq tp tuq tvq <span class="keyword1"><span class="command">have</span></span> ftq'<span class="main">:</span> <span class="quoted"><span class="quoted">"spr_sim <span class="skolem">t</span> <span class="main">=</span> <span class="skolem">q'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> spr_sim_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> pt ftq'
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span> <span class="main">∈</span> relations SPR.MC <span class="skolem">a</span> <span class="main">∧</span> spr_sim <span class="bound">q</span> <span class="main">=</span> <span class="skolem">q'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The proof proceeds by lock-step induction over <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">t</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="free">t'</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, appealing to the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">jkbpDet</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> assumption, the definition
of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">envObs</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and the constraint <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">envTrans</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

It is then a short step to showing reverse simulation, and hence
simulation:

›</span></span>

<span class="keyword1" id="SPRViewDet-spr_sim"><span class="command">lemma</span></span> spr_sim<span class="main">:</span> <span class="quoted"><span class="quoted">"sim SPR.MC spr_simMC spr_sim"</span></span>
<span class="comment1">(*&lt;*)</span>
  <span class="keyword1"><span class="command">using</span></span> spr_sim_range spr_simVal spr_sim_f spr_sim_r
  <span class="keyword1"><span class="command">unfolding</span></span> sim_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context FiniteDetBroadcastEnvironment *)</span>

<span class="keyword1"><span class="command">sublocale</span></span> FiniteDetBroadcastEnvironment
        <span class="main">&lt;</span> SPRdet<span class="main">:</span> SimIncrEnvironment <span class="quoted"><span class="free">jkbp</span></span> <span class="quoted"><span class="free">envInit</span></span> <span class="quoted"><span class="free">envAction</span></span> <span class="quoted"><span class="free">envTrans</span></span> <span class="quoted"><span class="free">envVal</span></span>
                                     <span class="quoted">spr_jview</span> <span class="quoted"><span class="free">envObs</span></span> <span class="quoted">spr_jviewInit</span> <span class="quoted">spr_jviewIncr</span>
                                     <span class="quoted">spr_sim</span> <span class="quoted">spr_simRels</span> <span class="quoted">spr_simVal</span>
<span class="comment1">(*&lt;*)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">rule</span> spr_sim<span class="main">)</span>
<span class="comment1">(*&gt;*)</span>

<span class="comment1">(* **************************************** *)</span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Representations›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

As before we canonically represent the quotient of the simulated
worlds <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="tfree"><span class="tfree">'a</span></span><span class="main"><span class="main">,</span></span> <span class="tfree"><span class="tfree">'es</span></span><span class="main"><span class="main">,</span></span> <span class="tfree"><span class="tfree">'as</span></span><span class="main"><span class="main">)</span></span> spr_simWorld"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> under <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="free">spr_simRels</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> using ordered, distinct lists. In particular, we use
the type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="tfree"><span class="tfree">'a</span></span> <span class="main"><span class="main">×</span></span> <span class="tfree"><span class="tfree">'a</span></span><span class="main"><span class="main">)</span></span> odlist"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> (abbreviated <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'a</span></span>
odrelation"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>) to canonically represent relations.

›</span></span>

<span class="keyword1"><span class="command">context</span></span> FiniteDetBroadcastEnvironment
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> -<span class="main">)</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> spr_simWorldsECRep
  <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> BEState odrelation"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> -<span class="main">)</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> spr_simWorldsRep
  <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> spr_simWorldsECRep <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> spr_simWorldsECRep"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

We can abstract such a representation into a set of simulated
equivalence classes:

›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">spr_simAbs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> spr_simWorldsRep
              <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> spr_simWorld set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">spr_simAbs</span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">cec</span><span class="main">,</span> <span class="bound">aec</span><span class="main">)</span><span class="main">.</span> <span class="main">{</span> <span class="main">⦇</span> sprFst <span class="main">=</span> <span class="bound">s</span><span class="main">,</span> sprLst <span class="main">=</span> <span class="bound">s'</span><span class="main">,</span> sprCRel <span class="main">=</span> toSet <span class="bound">cec</span> <span class="main">⦈</span>
                                <span class="main">|</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">∈</span> toSet <span class="bound">aec</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

Assuming <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">X</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> represents a simulated equivalence class for
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">t</span></span> <span class="main"><span class="main">∈</span></span> <span class="free"><span class="free">jkbpC</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, we can decompose <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"spr_simAbs <span class="free"><span class="free">X</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> in terms
of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"tObsC_abs <span class="free"><span class="free">t</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">agent_abs</span></span> <span class="free"><span class="free">t</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>:

›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">agent_abs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> BEState Trace
             <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> BEState Relation"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">agent_abs</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> <span class="main">{</span> <span class="main">(</span>tFirst <span class="bound">t'</span><span class="main">,</span> tLast <span class="bound">t'</span><span class="main">)</span>
                     <span class="main">|</span><span class="bound">t'</span><span class="main">.</span> <span class="bound">t'</span> <span class="main">∈</span> SPR.jkbpC <span class="main">∧</span> spr_jview <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">t'</span> <span class="main">=</span> spr_jview <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">}</span>"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1" id="SPRViewDet-agent_absI"><span class="command">lemma</span></span> agent_absI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> spr_jview <span class="free">a</span> <span class="free">t'</span> <span class="main">=</span> spr_jview <span class="free">a</span> <span class="free">t</span><span class="main">;</span> <span class="free">t'</span> <span class="main">∈</span> SPR.jkbpC<span class="main">;</span> <span class="free">t</span> <span class="main">∈</span> SPR.jkbpC <span class="main">⟧</span>
      <span class="main">⟹</span> <span class="main">(</span>tFirst <span class="free">t'</span><span class="main">,</span> tLast <span class="free">t'</span><span class="main">)</span> <span class="main">∈</span> agent_abs <span class="free">a</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> agent_abs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="SPRViewDet-spr_simAbs_refl"><span class="command">lemma</span></span> spr_simAbs_refl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> SPR.jkbpC"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> ec<span class="main">:</span> <span class="quoted"><span class="quoted">"spr_simAbs <span class="free">ec</span> <span class="main">=</span> SPRdet.sim_equiv_class <span class="free">a</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"spr_sim <span class="free">t</span> <span class="main">∈</span> spr_simAbs <span class="free">ec</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="SPRViewDet-spr_simAbs_tObsC_abs"><span class="command">lemma</span></span> spr_simAbs_tObsC_abs<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> SPR.jkbpC"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> ec<span class="main">:</span> <span class="quoted"><span class="quoted">"spr_simAbs <span class="free">ec</span> <span class="main">=</span> SPRdet.sim_equiv_class <span class="free">a</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"toSet <span class="main">(</span>fst <span class="free">ec</span><span class="main">)</span> <span class="main">=</span> tObsC_abs <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> tC spr_simAbs_refl<span class="main">[</span><span class="operator">OF</span> tC ec<span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> spr_sim_def spr_simAbs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="SPRViewDet-spr_simAbs_agent_abs"><span class="command">lemma</span></span> spr_simAbs_agent_abs<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> SPR.jkbpC"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> ec<span class="main">:</span> <span class="quoted"><span class="quoted">"spr_simAbs <span class="free">ec</span> <span class="main">=</span> SPRdet.sim_equiv_class <span class="free">a</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"toSet <span class="main">(</span>snd <span class="free">ec</span><span class="main">)</span> <span class="main">=</span> agent_abs <span class="free">a</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> tC ec
  <span class="keyword1"><span class="command">unfolding</span></span> spr_sim_def spr_simAbs_def agent_abs_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ec</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">⦇</span>sprFst <span class="main">=</span> <span class="improper">aaa</span><span class="main">,</span> sprLst <span class="main">=</span> <span class="improper">ba</span><span class="main">,</span> sprCRel <span class="main">=</span> toSet <span class="improper">aa</span><span class="main">⦈</span> <span class="main">∈</span> <span class="main">{</span><span class="main">⦇</span>sprFst <span class="main">=</span> <span class="bound">s</span><span class="main">,</span> sprLst <span class="main">=</span> <span class="bound">s'</span><span class="main">,</span> sprCRel <span class="main">=</span> toSet <span class="improper">aa</span><span class="main">⦈</span> <span class="main">|</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">∈</span> toSet <span class="improper">b</span><span class="main">}</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

This representation is canonical on the domain of interest (though not
in general):

›</span></span>

<span class="keyword1" id="SPRViewDet-spr_simAbs_inj_on"><span class="command">lemma</span></span> spr_simAbs_inj_on<span class="main">:</span>
  <span class="quoted"><span class="quoted">"inj_on spr_simAbs <span class="main">{</span> <span class="bound">x</span> <span class="main">.</span> spr_simAbs <span class="bound">x</span> <span class="main">∈</span> SPRdet.jkbpSEC <span class="main">}</span>"</span></span>
<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> inj_onI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
  <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span> <span class="bound">x</span> <span class="main">.</span> spr_simAbs <span class="bound">x</span> <span class="main">∈</span> SPRdet.jkbpSEC <span class="main">}</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="main">{</span> <span class="bound">x</span> <span class="main">.</span> spr_simAbs <span class="bound">x</span> <span class="main">∈</span> SPRdet.jkbpSEC <span class="main">}</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> xy<span class="main">:</span> <span class="quoted"><span class="quoted">"spr_simAbs <span class="skolem">x</span> <span class="main">=</span> spr_simAbs <span class="skolem">y</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> x <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">t</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> tC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> SPR.jkbpC"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> ec<span class="main">:</span> <span class="quoted"><span class="quoted">"spr_simAbs <span class="skolem">x</span> <span class="main">=</span> SPRdet.sim_equiv_class <span class="skolem">a</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> spr_simAbs_tObsC_abs<span class="main">[</span><span class="operator">OF</span> tC ec<span class="main">]</span> spr_simAbs_tObsC_abs<span class="main">[</span><span class="operator">OF</span> tC trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> xy<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> ec<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">x</span> <span class="main">=</span> fst <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> injD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> toSet_inj<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> spr_simAbs_agent_abs<span class="main">[</span><span class="operator">OF</span> tC ec<span class="main">]</span> spr_simAbs_agent_abs<span class="main">[</span><span class="operator">OF</span> tC trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> xy<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> ec<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">x</span> <span class="main">=</span> snd <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> injD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> toSet_inj<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod_eqI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The following sections make use of a Kripke structure constructed over
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"tObsC_abs <span class="free"><span class="free">t</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> for some canonical trace <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">t</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Note that
we use the relation in the generated code.

›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> -<span class="main">)</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> spr_simWorlds
  <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> BEState <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> BEState"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> -<span class="main">)</span>
  <span class="entity">spr_repRels</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> BEState <span class="main">⇒</span> <span class="tfree">'cobs</span> <span class="main">×</span> <span class="tfree">'as</span> option<span class="main">)</span>
                 <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> spr_simWorlds Relation"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">spr_repRels</span> <span class="free"><span class="bound"><span class="entity">envObs</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">{</span> <span class="main">(</span><span class="main">(</span><span class="bound">u</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">u'</span><span class="main">,</span> <span class="bound">v'</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
        <span class="free"><span class="bound"><span class="entity">envObs</span></span></span> <span class="bound">a</span> <span class="bound">u</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">envObs</span></span></span> <span class="bound">a</span> <span class="bound">u'</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">envObs</span></span></span> <span class="bound">a</span> <span class="bound">v</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">envObs</span></span></span> <span class="bound">a</span> <span class="bound">v'</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">spr_repVal</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> spr_simWorlds <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">spr_repVal</span> <span class="main">≡</span> <span class="free">envVal</span> <span class="main">∘</span> snd"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">spr_repMC</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> BEState Relation
               <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> spr_simWorlds<span class="main">)</span> KripkeStructure"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">spr_repMC</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">tcobsR</span><span class="main">.</span> mkKripke <span class="bound">tcobsR</span> <span class="main">(</span>spr_repRels <span class="free">envObs</span><span class="main">)</span> spr_repVal"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">spr_repRels</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> spr_simWorlds Relation"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">spr_repRels</span> <span class="main">≡</span> SPRViewDet.spr_repRels <span class="free">envObs</span>"</span></span>

<span class="keyword1" id="SPRViewDet-spr_repMC_kripke"><span class="command">lemma</span></span> spr_repMC_kripke<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"kripke <span class="main">(</span>spr_repMC <span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> kripkeI<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1" id="SPRViewDet-spr_repMC_S5n"><span class="command">lemma</span></span> spr_repMC_S5n<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"S5n <span class="main">(</span>spr_repMC <span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> spr_repRels_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> S5nI equivI refl_onI symI transI<span class="main">)</span> <span class="operator">auto</span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

As before we can show that this Kripke structure is adequate for a
particular canonical trace <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">t</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> by showing that it simulates
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"spr_repMC"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> We introduce an intermediate structure:

›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">spr_jkbpCSt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> BEState Trace <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> spr_simWorld set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">spr_jkbpCSt</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> spr_sim <span class="main">`</span> <span class="main">{</span> <span class="bound">t'</span> <span class="main">.</span> <span class="bound">t'</span> <span class="main">∈</span> SPR.jkbpC <span class="main">∧</span> tObsC <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> tObsC <span class="bound">t'</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">spr_simMCt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> BEState Trace
                <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> spr_simWorld<span class="main">)</span> KripkeStructure"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">spr_simMCt</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> mkKripke <span class="main">(</span>spr_jkbpCSt <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> spr_simRels spr_simVal"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">spr_repSim</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> spr_simWorld <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> spr_simWorlds"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">spr_repSim</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span>sprFst <span class="bound">s</span><span class="main">,</span> sprLst <span class="bound">s</span><span class="main">)</span>"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1" id="SPRViewDet-spr_repSim_simps"><span class="command">lemma</span></span> spr_repSim_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"spr_repSim <span class="main">`</span> spr_sim <span class="main">`</span> <span class="free">T</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span>tFirst <span class="bound">t</span><span class="main">,</span> tLast <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="free">T</span>"</span></span>
  <span class="quoted"><span class="quoted">"spr_repSim <span class="main">(</span>spr_sim <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>tFirst <span class="free">t</span><span class="main">,</span> tLast <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> spr_repSim_def spr_sim_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">⦇</span> sprFst <span class="main">=</span> tFirst <span class="improper">t</span><span class="main">,</span> sprLst <span class="main">=</span> tLast <span class="improper">t</span><span class="main">,</span> sprCRel <span class="main">=</span> tObsC_abs <span class="improper">t</span> <span class="main">⦈</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> image_eqI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="SPRViewDet-jkbpCSt_jkbpCS_subset"><span class="command">lemma</span></span> jkbpCSt_jkbpCS_subset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"spr_jkbpCSt <span class="free">t</span> <span class="main">⊆</span> spr_sim <span class="main">`</span> SPR.jkbpC"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹›</span></span>

<span class="keyword1" id="SPRViewDet-spr_repSim"><span class="command">lemma</span></span> spr_repSim<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> SPR.jkbpC"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sim <span class="main">(</span>spr_simMCt <span class="free">t</span><span class="main">)</span>
             <span class="main">(</span><span class="main">(</span>spr_repMC <span class="main">∘</span> sprCRel<span class="main">)</span> <span class="main">(</span>spr_sim <span class="free">t</span><span class="main">)</span><span class="main">)</span>
             spr_repSim"</span></span>
<span class="comment1">(*&lt;*)</span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"sim <span class="var">?M</span> <span class="var">?M'</span> <span class="var">?f</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sim_range <span class="var">?M</span> <span class="var">?M'</span> <span class="var">?f</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"worlds <span class="var">?M'</span> <span class="main">=</span> <span class="var">?f</span> <span class="main">`</span> worlds <span class="var">?M</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spr_sim_def spr_repSim_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> tObsC_abs_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">⦇</span> sprFst <span class="main">=</span> tFirst <span class="improper">t'</span><span class="main">,</span> sprLst <span class="main">=</span> tLast <span class="improper">t'</span><span class="main">,</span> sprCRel <span class="main">=</span> tObsC_abs <span class="free">t</span> <span class="main">⦈</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> image_eqI<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">t'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> image_eqI<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tObsC_abs_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"relations <span class="var">?M'</span> <span class="skolem">a</span> <span class="main">⊆</span> worlds <span class="var">?M'</span> <span class="main">×</span> worlds <span class="var">?M'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spr_sim_def spr_repSim_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sim_val <span class="var">?M</span> <span class="var">?M'</span> <span class="var">?f</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spr_sim_def spr_simVal_def spr_repSim_def spr_repVal_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sim_f <span class="var">?M</span> <span class="var">?M'</span> <span class="var">?f</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> spr_sim_def <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> spr_simRels_def spr_repRels_def spr_repSim_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sim_r <span class="var">?M</span> <span class="var">?M'</span> <span class="var">?f</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command">unfolding</span></span> spr_repRels_def spr_repSim_def spr_simRels_def spr_sim_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">⦇</span> sprFst <span class="main">=</span> <span class="improper">aa</span><span class="main">,</span> sprLst <span class="main">=</span> <span class="improper">b</span><span class="main">,</span> sprCRel <span class="main">=</span> tObsC_abs <span class="improper">ta</span> <span class="main">⦈</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> tObsC_abs_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">t'a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> image_eqI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

As before we define a set of constants that satisfy the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Algorithm›</span></span></span></span> locale given the assumptions of the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>
<span class="quoted"><span class="quoted">"FiniteDetBroadcastEnvironment"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> locale.

›</span></span>

<span class="comment1">(* **************************************** *)</span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Initial states›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The initial states for agent <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">a</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> given an initial observation
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">iobs</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> consist of the set of states that yield a common
observation consonant with <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">iobs</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> paired with the set of
states where <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">a</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> observes <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">iobs</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>:

›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> -<span class="main">)</span>
  <span class="entity">spr_simInit</span> <span class="main">::</span>
        <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> BEState list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'es</span> <span class="main">⇒</span> <span class="tfree">'cobs</span><span class="main">)</span>
      <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> BEState <span class="main">⇒</span> <span class="tfree">'cobs</span> <span class="main">×</span> <span class="tfree">'obs</span><span class="main">)</span>
       <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'cobs</span> <span class="main">×</span> <span class="tfree">'obs</span><span class="main">)</span>
       <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> linorder<span class="main">,</span> <span class="tfree">'es</span> <span class="main">::</span> linorder<span class="main">,</span> <span class="tfree">'as</span> <span class="main">::</span> linorder<span class="main">)</span> spr_simWorldsRep"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">spr_simInit</span> <span class="free"><span class="bound"><span class="entity">envInit</span></span></span> <span class="free"><span class="bound"><span class="entity">envObsC</span></span></span> <span class="free"><span class="bound"><span class="entity">envObs</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">a</span> <span class="bound">iobs</span><span class="main">.</span>
    <span class="main">(</span>ODList.fromList <span class="main">[</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">.</span> s <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">envInit</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">envObsC</span></span></span> <span class="main">(</span>es <span class="bound">s</span><span class="main">)</span> <span class="main">=</span> fst <span class="bound">iobs</span> <span class="main">]</span><span class="main">,</span>
     ODList.fromList <span class="main">[</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">.</span> s <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">envInit</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">envObs</span></span></span> <span class="bound">a</span> <span class="bound">s</span> <span class="main">=</span> <span class="bound">iobs</span> <span class="main">]</span><span class="main">)</span>"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">spr_simInit</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'cobs</span> <span class="main">×</span> <span class="tfree">'as</span> option<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> spr_simWorldsRep"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">spr_simInit</span> <span class="main">≡</span> SPRViewDet.spr_simInit <span class="free">envInit</span> <span class="free">envObsC</span> <span class="free">envObs</span>"</span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹›</span></span>

<span class="keyword1" id="SPRViewDet-spr_simInit"><span class="command">lemma</span></span> spr_simInit<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">iobs</span> <span class="main">∈</span> <span class="free">envObs</span> <span class="free">a</span> <span class="main">`</span> set <span class="free">envInit</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"spr_simAbs <span class="main">(</span>spr_simInit <span class="free">a</span> <span class="free">iobs</span><span class="main">)</span>
       <span class="main">=</span> spr_sim <span class="main">`</span> <span class="main">{</span> <span class="bound"><span class="bound">t'</span></span> <span class="main">∈</span> SPR.jkbpC<span class="main">.</span> spr_jview <span class="free">a</span> <span class="bound">t'</span> <span class="main">=</span> spr_jviewInit <span class="free">a</span> <span class="free">iobs</span> <span class="main">}</span>"</span></span>
<span class="comment1">(*&lt;*)</span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">unfolding</span></span> spr_simInit_def spr_simAbs_def spr_sim_def <span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def SPR.jviewInit <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"tInit <span class="improper">s</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> image_eqI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> spr_jview_def envObs_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="comment1">(*&gt;*)</span>

<span class="comment1">(* **************************************** *)</span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Simulated observations›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

An observation can be made at any element of the representation of a
simulated equivalence class of a canonical trace:

›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> -<span class="main">)</span>
  <span class="entity">spr_simObs</span> <span class="main">::</span>
        <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'es</span> <span class="main">⇒</span> <span class="tfree">'cobs</span><span class="main">)</span>
      <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> linorder<span class="main">,</span> <span class="tfree">'es</span> <span class="main">::</span> linorder<span class="main">,</span> <span class="tfree">'as</span> <span class="main">::</span> linorder<span class="main">)</span> spr_simWorldsRep
      <span class="main">⇒</span> <span class="tfree">'cobs</span> <span class="main">×</span> <span class="tfree">'as</span> option"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">spr_simObs</span> <span class="free"><span class="bound"><span class="entity">envObsC</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">envObsC</span></span></span> <span class="main">(</span>es <span class="bound">s</span><span class="main">)</span><span class="main">,</span> ODList.lookup <span class="main">(</span>ps <span class="bound">s</span><span class="main">)</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span>
                           <span class="main">∘</span> snd <span class="main">∘</span> ODList.hd <span class="main">∘</span> snd"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">spr_simObs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> spr_simWorldsRep <span class="main">⇒</span> <span class="tfree">'cobs</span> <span class="main">×</span> <span class="tfree">'as</span> option"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">spr_simObs</span> <span class="main">≡</span> SPRViewDet.spr_simObs <span class="free">envObsC</span>"</span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹›</span></span>

<span class="keyword1" id="SPRViewDet-spr_simObs"><span class="command">lemma</span></span> spr_simObs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> SPR.jkbpC"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ec<span class="main">:</span> <span class="quoted"><span class="quoted">"spr_simAbs <span class="free">ec</span> <span class="main">=</span> SPRdet.sim_equiv_class <span class="free">a</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"spr_simObs <span class="free">a</span> <span class="free">ec</span> <span class="main">=</span> <span class="free">envObs</span> <span class="free">a</span> <span class="main">(</span>tLast <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="main">∈</span> set <span class="main">(</span>toList <span class="main">(</span>snd <span class="free">ec</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="free">envObs</span> <span class="free">a</span> <span class="main">(</span>snd <span class="bound">s</span><span class="main">)</span> <span class="main">=</span> <span class="free">envObs</span> <span class="free">a</span> <span class="main">(</span>tLast <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> spr_simAbs_agent_abs<span class="main">[</span><span class="operator">OF</span> tC ec<span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> toSet_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> agent_abs_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">from</span></span> tC ec <span class="keyword1"><span class="command">have</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>tFirst <span class="free">t</span><span class="main">,</span> tLast <span class="free">t</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>toList <span class="main">(</span>snd <span class="free">ec</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> spr_simAbs_def spr_sim_def toSet_def split_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> spr_simObs_def
    <span class="keyword1"><span class="command">using</span></span> list_choose_hd<span class="main">[</span><span class="operator">OF</span> A B<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ODList.hd_def envObs_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="comment1">(* **************************************** *)</span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Evaluation›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

As for the clock semantics (\S\ref{sec:kbps-theory-clock-view-eval}),
we use the general evalation function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"evalS"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

Once again we propositions are used to filter the set of possible
worlds <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">X</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>:

›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> -<span class="main">)</span>
  <span class="entity">spr_evalProp</span> <span class="main">::</span>
        <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">,</span> <span class="tfree">'es</span><span class="main">::</span>linorder<span class="main">,</span> <span class="tfree">'as</span><span class="main">::</span>linorder<span class="main">)</span> BEState <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> bool<span class="main">)</span>
      <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> BEState odrelation
      <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> BEState odrelation"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">spr_evalProp</span> <span class="free"><span class="bound"><span class="entity">envVal</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">X</span> <span class="bound">p</span><span class="main">.</span> ODList.filter <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">envVal</span></span></span> <span class="main">(</span>snd <span class="bound">s</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span> <span class="bound">X</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The knowledge operation computes the subset of possible worlds <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="free">cec</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> that yield the same observation as <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">s</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> for agent <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="free">a</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>:

›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> -<span class="main">)</span>
  <span class="entity">spr_knowledge</span> <span class="main">::</span>
     <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">,</span> <span class="tfree">'es</span><span class="main">::</span>linorder<span class="main">,</span> <span class="tfree">'as</span><span class="main">::</span>linorder<span class="main">)</span> BEState
          <span class="main">⇒</span> <span class="tfree">'cobs</span> <span class="main">×</span> <span class="tfree">'as</span> option<span class="main">)</span>
       <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> BEState odrelation
       <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> spr_simWorlds
       <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> spr_simWorldsECRep"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">spr_knowledge</span> <span class="free"><span class="bound"><span class="entity">envObs</span></span></span> <span class="free"><span class="bound"><span class="entity">cec</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">a</span> <span class="bound">s</span><span class="main">.</span>
    ODList.fromList <span class="main">[</span> <span class="bound">s'</span> <span class="main">.</span> s' <span class="main">←</span> toList <span class="free"><span class="bound"><span class="entity">cec</span></span></span><span class="main">,</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">∈</span> spr_repRels <span class="free"><span class="bound"><span class="entity">envObs</span></span></span> <span class="bound">a</span> <span class="main">]</span>"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="comment1">(* We need to avoid the explicit enumeration of the set in spr_repRels. *)</span>

<span class="keyword1"><span class="command">declare</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> -<span class="main">)</span> spr_knowledge_def<span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> -<span class="main">)</span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"spr_knowledge <span class="free">envObs</span> <span class="free">cec</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">s</span><span class="main">.</span>
     ODList.fromList <span class="main">[</span> <span class="bound">s'</span> <span class="main">.</span> s' <span class="main">←</span> toList <span class="free">cec</span><span class="main">,</span>
                               <span class="free">envObs</span> <span class="bound">a</span> <span class="main">(</span>fst <span class="bound">s</span><span class="main">)</span> <span class="main">=</span> <span class="free">envObs</span> <span class="bound">a</span> <span class="main">(</span>fst <span class="bound">s'</span><span class="main">)</span> <span class="main">∧</span> <span class="free">envObs</span> <span class="bound">a</span> <span class="main">(</span>snd <span class="bound">s</span><span class="main">)</span> <span class="main">=</span> <span class="free">envObs</span> <span class="bound">a</span> <span class="main">(</span>snd <span class="bound">s'</span><span class="main">)</span> <span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> spr_knowledge_def spr_repRels_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_def<span class="main">)</span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

Similarly the common knowledge operation computes the transitive
closure \citep{AFP:TRANCL} of the union of the knowledge relations for
the agents <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>as›</span></span></span></span>:

›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> -<span class="main">)</span>
  <span class="entity">spr_commonKnowledge</span> <span class="main">::</span>
     <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">,</span> <span class="tfree">'es</span><span class="main">::</span>linorder<span class="main">,</span> <span class="tfree">'as</span><span class="main">::</span>linorder<span class="main">)</span> BEState
          <span class="main">⇒</span> <span class="tfree">'cobs</span> <span class="main">×</span> <span class="tfree">'as</span> option<span class="main">)</span>
        <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> BEState odrelation
        <span class="main">⇒</span> <span class="tfree">'a</span> list
        <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> spr_simWorlds
        <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> spr_simWorldsECRep"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">spr_commonKnowledge</span> <span class="free"><span class="bound"><span class="entity">envObs</span></span></span> <span class="free"><span class="bound"><span class="entity">cec</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">as</span> <span class="bound">s</span><span class="main">.</span>
    <span class="keyword1">let</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">λ</span><span class="bound">a</span><span class="main">.</span> ODList.fromList
               <span class="main">[</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="bound">s''</span><span class="main">)</span> <span class="main">.</span> s' <span class="main">←</span> toList <span class="free"><span class="bound"><span class="entity">cec</span></span></span><span class="main">,</span> s'' <span class="main">←</span> toList <span class="free"><span class="bound"><span class="entity">cec</span></span></span><span class="main">,</span>
                             <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="bound">s''</span><span class="main">)</span> <span class="main">∈</span> spr_repRels <span class="free"><span class="bound"><span class="entity">envObs</span></span></span> <span class="bound">a</span> <span class="main">]</span><span class="main">;</span>
        <span class="bound">R</span> <span class="main">=</span> toList <span class="main">(</span>ODList.big_union <span class="bound">r</span> <span class="bound">as</span><span class="main">)</span>
     <span class="keyword1">in</span> ODList.fromList <span class="main">(</span>memo_list_trancl <span class="bound">R</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="comment1">(* We need to avoid the explicit enumeration of the set in spr_repRels. *)</span>

<span class="keyword1"><span class="command">declare</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> -<span class="main">)</span> spr_commonKnowledge_def<span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> -<span class="main">)</span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"spr_commonKnowledge <span class="free">envObs</span> <span class="free">cec</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">as</span> <span class="bound">s</span><span class="main">.</span>
    <span class="keyword1">let</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">λ</span><span class="bound">a</span><span class="main">.</span> ODList.fromList
               <span class="main">[</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="bound">s''</span><span class="main">)</span> <span class="main">.</span> s' <span class="main">←</span> toList <span class="free">cec</span><span class="main">,</span> s'' <span class="main">←</span> toList <span class="free">cec</span><span class="main">,</span>
                             <span class="free">envObs</span> <span class="bound">a</span> <span class="main">(</span>fst <span class="bound">s'</span><span class="main">)</span> <span class="main">=</span> <span class="free">envObs</span> <span class="bound">a</span> <span class="main">(</span>fst <span class="bound">s''</span><span class="main">)</span> <span class="main">∧</span> <span class="free">envObs</span> <span class="bound">a</span> <span class="main">(</span>snd <span class="bound">s'</span><span class="main">)</span> <span class="main">=</span> <span class="free">envObs</span> <span class="bound">a</span> <span class="main">(</span>snd <span class="bound">s''</span><span class="main">)</span> <span class="main">]</span><span class="main">;</span>
        <span class="bound">R</span> <span class="main">=</span> toList <span class="main">(</span>ODList.big_union <span class="bound">r</span> <span class="bound">as</span><span class="main">)</span>
     <span class="keyword1">in</span> ODList.fromList <span class="main">(</span>memo_list_trancl <span class="bound">R</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> spr_commonKnowledge_def spr_repRels_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_def<span class="main">)</span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The evaluation function evaluates a subjective knowledge formula on
the representation of an equivalence class:

›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> -<span class="main">)</span>
  <span class="quoted"><span class="quoted">"<span class="free">eval</span> <span class="free"><span class="bound"><span class="entity">envVal</span></span></span> <span class="free"><span class="bound"><span class="entity">envObs</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">cec</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">.</span>
     evalS <span class="main">(</span>spr_evalProp <span class="free"><span class="bound"><span class="entity">envVal</span></span></span><span class="main">)</span>
           <span class="main">(</span>spr_knowledge <span class="free"><span class="bound"><span class="entity">envObs</span></span></span> <span class="bound">cec</span><span class="main">)</span>
           <span class="main">(</span>spr_commonKnowledge <span class="free"><span class="bound"><span class="entity">envObs</span></span></span> <span class="bound">cec</span><span class="main">)</span>
           <span class="bound">X</span>"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1" id="SPRViewDet-spr_knowledge"><span class="command">lemma</span></span> spr_knowledge<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> toSet <span class="free">cec</span>
    <span class="main">⟹</span> toSet <span class="main">(</span>spr_knowledge <span class="free">envObs</span> <span class="free">cec</span> <span class="free">a</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> relations <span class="main">(</span>spr_repMC <span class="main">(</span>toSet <span class="free">cec</span><span class="main">)</span><span class="main">)</span> <span class="free">a</span> <span class="main">``</span> <span class="main">{</span><span class="free">s</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> spr_knowledge_def spr_repRels_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> toSet_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="SPRViewDet-spr_commonKnowledge_relation_image"><span class="command">lemma</span></span> spr_commonKnowledge_relation_image<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> toSet <span class="free">cec</span>
    <span class="main">⟹</span> toSet <span class="main">(</span>spr_commonKnowledge <span class="free">envObs</span> <span class="free">cec</span> <span class="free">as</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">a</span> <span class="main">∈</span> set <span class="free">as</span><span class="main">.</span> relations <span class="main">(</span>spr_repMC <span class="main">(</span>toSet <span class="free">cec</span><span class="main">)</span><span class="main">)</span> <span class="bound">a</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span> <span class="main">``</span> <span class="main">{</span><span class="free">s</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> spr_commonKnowledge_def Let_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> memo_list_trancl toSet_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> Image_def split_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Collect_cong<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> f<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="improper">b</span><span class="main">)</span> <span class="main">∈</span> <span class="bound">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> arg_cong<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">trancl</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="SPRViewDet-eval_rec_models"><span class="command">lemma</span></span> eval_rec_models<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> XY<span class="main">:</span> <span class="quoted"><span class="quoted">"toSet <span class="free">X</span> <span class="main">⊆</span> toSet <span class="free">Y</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> toSet <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> toSet <span class="main">(</span>eval_rec <span class="main">(</span>spr_evalProp <span class="free">envVal</span><span class="main">)</span> <span class="main">(</span>spr_knowledge <span class="free">envObs</span> <span class="free">Y</span><span class="main">)</span> <span class="main">(</span>spr_commonKnowledge <span class="free">envObs</span> <span class="free">Y</span><span class="main">)</span> <span class="free">X</span> <span class="free">φ</span><span class="main">)</span>
     <span class="main">⟷</span> spr_repMC <span class="main">(</span>toSet <span class="free">Y</span><span class="main">)</span><span class="main">,</span> <span class="free">s</span> <span class="main">⊨</span> <span class="free">φ</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> XY s
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">X</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Kknows <span class="skolem">a'</span> <span class="skolem">φ</span> <span class="skolem">X</span> <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">∈</span> toSet <span class="skolem">X</span>›</span></span> spr_knowledge<span class="main">[</span><span class="operator">OF</span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Kknows<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Kknows<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">a'</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"toSet"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> odlist_all_iff<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cut_tac</span> s1<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="improper">a</span><span class="main">,</span> <span class="improper">b</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> X1<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"spr_knowledge <span class="free">envObs</span> <span class="free">Y</span> <span class="skolem">a'</span> <span class="main">(</span><span class="improper">aa</span><span class="main">,</span> <span class="improper">ba</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> Kknows.hyps<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> Kknows<span class="main">(</span>2<span class="main">)</span> Kknows<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S5n_rels_closed<span class="main"><span class="main">[</span></span><span class="operator">OF</span> spr_repMC_S5n<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>3<span class="main"><span class="keyword3">]</span></span>

    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> toSet_eq_iff odlist_all_iff<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> Kknows.hyps<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> Kknows<span class="main">(</span>2<span class="main">)</span> Kknows<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S5n_rels_closed<span class="main"><span class="main">[</span></span><span class="operator">OF</span> spr_repMC_S5n<span class="main"><span class="main">]</span></span> o_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Kcknows <span class="skolem">as</span> <span class="skolem">φ</span> <span class="skolem">X</span> <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">=</span> Nil"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">∈</span> toSet <span class="skolem">X</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">∈</span> toSet <span class="skolem">X</span>›</span></span> spr_commonKnowledge_relation_image<span class="main">[</span><span class="operator">OF</span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Kcknows<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Kcknows<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> as<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">as</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"toSet"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> odlist_all_iff<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cut_tac</span> s1<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="improper">a</span><span class="main">,</span> <span class="improper">b</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> X1<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"spr_commonKnowledge <span class="free">envObs</span> <span class="free">Y</span> <span class="skolem">as</span> <span class="main">(</span><span class="improper">aa</span><span class="main">,</span> <span class="improper">ba</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> Kcknows.hyps<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> Kcknows<span class="main">(</span>2<span class="main">)</span> Kcknows<span class="main">(</span>3<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S5n_rels_closed<span class="main"><span class="main">[</span></span><span class="operator">OF</span> spr_repMC_S5n<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> trancl_unfold<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">back</span></span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">back</span></span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">back</span></span></span></span> <span class="comment1">(* FIXME clunky, why did this break? *)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S5n_rels_closed<span class="main"><span class="main">[</span></span><span class="operator">OF</span> spr_repMC_S5n<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span>

      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> toSet_eq_iff odlist_all_iff<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> Kcknows.hyps<span class="main">)</span>
       <span class="keyword1"><span class="command">using</span></span> Kcknows<span class="main">(</span>2<span class="main">)</span> Kcknows<span class="main">(</span>3<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S5n_rels_closed<span class="main"><span class="main">[</span></span><span class="operator">OF</span> spr_repMC_S5n<span class="main"><span class="main">]</span></span> o_def<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> trancl_unfold<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">back</span></span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">back</span></span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">back</span></span></span></span> <span class="comment1">(* FIXME clunky, why did this break? *)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spr_repVal_def<span class="main">)</span>

<span class="keyword1" id="SPRViewDet-agent_abs_tObsC_abs_subset"><span class="command">lemma</span></span> agent_abs_tObsC_abs_subset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"tObsC <span class="free">t'</span> <span class="main">=</span> tObsC <span class="free">t</span> <span class="main">⟹</span> agent_abs <span class="free">a</span> <span class="free">t</span> <span class="main">⊆</span> tObsC_abs <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> agent_abs_def tObsC_abs_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> spr_jview_tObsC<span class="main">)</span>

<span class="keyword1" id="SPRViewDet-spr_simAbs_fst_snd"><span class="command">lemma</span></span> spr_simAbs_fst_snd<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> SPR.jkbpC"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> ec<span class="main">:</span> <span class="quoted"><span class="quoted">"spr_simAbs <span class="free">ec</span> <span class="main">=</span> SPRdet.sim_equiv_class <span class="free">a</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"toSet <span class="main">(</span>snd <span class="free">ec</span><span class="main">)</span> <span class="main">⊆</span> toSet <span class="main">(</span>fst <span class="free">ec</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> agent_abs_tObsC_abs_subset<span class="main">)</span>

<span class="keyword1" id="SPRViewDet-tObsC_abs_rel"><span class="command">lemma</span></span> tObsC_abs_rel<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> SPR.jkbpC"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> ec<span class="main">:</span> <span class="quoted"><span class="quoted">"spr_simAbs <span class="free">ec</span> <span class="main">=</span> SPRdet.sim_equiv_class <span class="free">a</span> <span class="free">t</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span>relations <span class="main">(</span>spr_repMC <span class="main">(</span>tObsC_abs <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> set <span class="free">as</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> tObsC_abs <span class="free">t</span> <span class="main">⟷</span><span class="free">y</span> <span class="main">∈</span> tObsC_abs <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> trancl_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="SPRViewDet-spr_simAbs_fst_snd_trc"><span class="command">lemma</span></span> spr_simAbs_fst_snd_trc<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> SPR.jkbpC"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> ec<span class="main">:</span> <span class="quoted"><span class="quoted">"spr_simAbs <span class="free">ec</span> <span class="main">=</span> SPRdet.sim_equiv_class <span class="free">a</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"toSet <span class="main">(</span>big_union <span class="main">(</span>spr_commonKnowledge <span class="free">envObs</span> <span class="main">(</span>fst <span class="free">ec</span><span class="main">)</span> <span class="free">as</span><span class="main">)</span> <span class="main">(</span>toList <span class="main">(</span>snd <span class="free">ec</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> toSet <span class="main">(</span>fst <span class="free">ec</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> toSet_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="improper">ab</span><span class="main">,</span><span class="improper">ba</span><span class="main">)</span> <span class="main">∈</span> toSet <span class="main">(</span>fst <span class="free">ec</span><span class="main">)</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spr_commonKnowledge_relation_image tObsC_abs_rel<span class="main"><span class="main">[</span></span><span class="operator">OF</span> tC ec<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> agent_abs_tObsC_abs_subset<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> refl<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="SPRViewDet-agent_abs_rel_inv"><span class="command">lemma</span></span> agent_abs_rel_inv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> SPR.jkbpC"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> ec<span class="main">:</span> <span class="quoted"><span class="quoted">"spr_simAbs <span class="free">ec</span> <span class="main">=</span> SPRdet.sim_equiv_class <span class="free">a</span> <span class="free">t</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> agent_abs <span class="free">a</span> <span class="free">t</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> xy<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> relations <span class="main">(</span>spr_repMC <span class="main">(</span>toSet <span class="main">(</span>fst <span class="free">ec</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> agent_abs <span class="free">a</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">unfolding</span></span> agent_abs_def tObsC_abs_def spr_repRels_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">t'b</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> spr_jview_tObsCI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> spr_jview_det_ps<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> tC
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="SPRViewDet-agent_abs_tObsC_abs"><span class="command">lemma</span></span> agent_abs_tObsC_abs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> SPR.jkbpC"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> agent_abs <span class="free">a</span> <span class="free">t</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> agent_abs <span class="free">a</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> relations <span class="main">(</span>spr_repMC <span class="main">(</span>tObsC_abs <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">unfolding</span></span> agent_abs_def spr_repRels_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 3
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> tObsC_absI<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">back</span></span></span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> spr_jview_tObsC<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 3
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> tObsC_absI<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">back</span></span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">back</span></span></span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> spr_jview_tObsC<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> spr_tFirst<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> spr_tLast<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="SPRViewDet-agent_abs_spr_repRels"><span class="command">lemma</span></span> agent_abs_spr_repRels<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> SPR.jkbpC"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> agent_abs <span class="free">a</span> <span class="free">t</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> agent_abs <span class="free">a</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> spr_repRels <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">unfolding</span></span> agent_abs_def spr_repRels_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> spr_tFirst spr_tLast<span class="main">)</span>

<span class="keyword1" id="SPRViewDet-evalS_models"><span class="command">lemma</span></span> evalS_models<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> SPR.jkbpC"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> ec<span class="main">:</span> <span class="quoted"><span class="quoted">"spr_simAbs <span class="free">ec</span> <span class="main">=</span> SPRdet.sim_equiv_class <span class="free">a</span> <span class="free">t</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> subj_phi<span class="main">:</span> <span class="quoted"><span class="quoted">"subjective <span class="free">a</span> <span class="free">φ</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> toSet <span class="main">(</span>snd <span class="free">ec</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"evalS <span class="main">(</span>spr_evalProp <span class="free">envVal</span><span class="main">)</span> <span class="main">(</span>spr_knowledge <span class="free">envObs</span> <span class="main">(</span>fst <span class="free">ec</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>spr_commonKnowledge <span class="free">envObs</span> <span class="main">(</span>fst <span class="free">ec</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">ec</span><span class="main">)</span> <span class="free">φ</span>
     <span class="main">⟷</span> spr_repMC <span class="main">(</span>toSet <span class="main">(</span>fst <span class="free">ec</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="free">s</span> <span class="main">⊨</span> <span class="free">φ</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="free">φ</span> <span class="main">=</span> <span class="var">?rhs</span> <span class="free">φ</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">using</span></span> subj_phi s ec
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> subjective.induct<span class="main"><span class="main">[</span></span><span class="operator">case_names</span> Kprop Knot Kand Kknows Kcknows<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Kknows <span class="skolem">a</span> <span class="skolem">a'</span> <span class="skolem">ψ</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> toSet_eq_iff<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="improper">a</span><span class="main">,</span> <span class="improper">b</span><span class="main">)</span> <span class="main">∈</span> toSet <span class="main">(</span>snd <span class="free">ec</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> subsetD<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">back</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> eval_rec_models<span class="main"><span class="main">[</span></span><span class="operator">OF</span> spr_simAbs_fst_snd<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> tC ec<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> tC Kknows
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command">using</span></span> tC ec
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> agent_abs_rel_inv<span class="main"><span class="main">[</span></span><span class="operator">OF</span> tC<span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> eval_rec_models<span class="main"><span class="main">[</span></span><span class="operator">OF</span> spr_simAbs_fst_snd<span class="main"><span class="main">[</span></span><span class="operator">OF</span> tC ec<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">using</span></span> agent_abs_tObsC_abs<span class="main">[</span><span class="operator">OF</span> tC<span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Kcknows <span class="skolem">a</span> <span class="skolem">as</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">(</span>Kcknows <span class="skolem">as</span> <span class="skolem">ψ</span><span class="main">)</span>
      <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span><span class="main">∈</span>agent_abs <span class="skolem">a</span> <span class="free">t</span><span class="main">.</span>
           <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="main">(</span><span class="main">(</span><span class="main">⋃</span><span class="bound">a</span><span class="main">∈</span>set <span class="skolem">as</span><span class="main">.</span> relations <span class="main">(</span>spr_repMC <span class="main">(</span>toSet <span class="main">(</span>fst <span class="free">ec</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">a</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span> <span class="main">``</span> <span class="main">{</span><span class="bound">y</span><span class="main">}</span><span class="main">)</span><span class="main">.</span>
              <span class="bound">x</span> <span class="main">∈</span> toSet <span class="main">(</span>eval_rec <span class="main">(</span>spr_evalProp <span class="free">envVal</span><span class="main">)</span> <span class="main">(</span>spr_knowledge <span class="free">envObs</span> <span class="main">(</span>fst <span class="free">ec</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>spr_commonKnowledge <span class="free">envObs</span> <span class="main">(</span>fst <span class="free">ec</span><span class="main">)</span><span class="main">)</span>
                       <span class="main">(</span>big_union <span class="main">(</span>spr_commonKnowledge <span class="free">envObs</span> <span class="main">(</span>fst <span class="free">ec</span><span class="main">)</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">(</span>toList <span class="main">(</span>snd <span class="free">ec</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ψ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="comment1">(* FIXME dreaming of a cong rule here. *)</span>
    <span class="keyword1"><span class="command">using</span></span> toSet_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> spr_simAbs_agent_abs<span class="main">[</span><span class="operator">OF</span> tC Kcknows<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> spr_simAbs_tObsC_abs<span class="main">[</span><span class="operator">OF</span> tC Kcknows<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> toSet_eq_iff toSet_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> subset_eq<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ball_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ball_cong<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> spr_commonKnowledge_relation_image<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> agent_abs_tObsC_abs_subset<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> refl<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span><span class="main">∈</span>agent_abs <span class="skolem">a</span> <span class="free">t</span><span class="main">.</span> spr_repMC <span class="main">(</span>toSet <span class="main">(</span>fst <span class="free">ec</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="bound">s</span> <span class="main">⊨</span> Kcknows <span class="skolem">as</span> <span class="skolem">ψ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ball_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ball_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> eval_rec_models<span class="main"><span class="main">[</span></span><span class="operator">OF</span> spr_simAbs_fst_snd_trc<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> tC Kcknows<span class="main"><span class="main"><span class="main">(</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> as<span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">as</span></span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command">using</span></span> spr_simAbs_agent_abs<span class="main">[</span><span class="operator">OF</span> tC Kcknows<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> spr_simAbs_tObsC_abs<span class="main">[</span><span class="operator">OF</span> tC Kcknows<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> toSet_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">y</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> bexI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> spr_commonKnowledge_relation_image<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> agent_abs_tObsC_abs_subset<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> refl<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> refl<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> spr_repMC <span class="main">(</span>toSet <span class="main">(</span>fst <span class="free">ec</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="free">s</span> <span class="main">⊨</span> Kknows <span class="skolem">a</span> <span class="main">(</span>Kcknows <span class="skolem">as</span> <span class="skolem">ψ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> spr_simAbs_agent_abs<span class="main">[</span><span class="operator">OF</span> tC Kcknows<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> spr_simAbs_tObsC_abs<span class="main">[</span><span class="operator">OF</span> tC Kcknows<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
          Kcknows<span class="main">(</span>2<span class="main">)</span> tC
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ball_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> agent_abs_tObsC_abs_subset<span class="main"><span class="main">]</span></span> agent_abs_spr_repRels<span class="main"><span class="main">[</span></span><span class="operator">OF</span> tC<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> agent_abs_rel_inv<span class="main"><span class="main">[</span></span><span class="operator">OF</span> tC Kcknows<span class="main"><span class="main"><span class="main">(</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> spr_repMC <span class="main">(</span>toSet <span class="main">(</span>fst <span class="free">ec</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="free">s</span> <span class="main">⊨</span> Kcknows <span class="skolem">as</span> <span class="skolem">ψ</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> S5n_common_knowledge_fixed_point_simpler<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> spr_simAbs_agent_abs<span class="main">[</span><span class="operator">OF</span> tC Kcknows<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> spr_simAbs_tObsC_abs<span class="main">[</span><span class="operator">OF</span> tC Kcknows<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
          Kcknows<span class="main">(</span>1<span class="main">)</span> Kcknows<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> agent_abs_tObsC_abs_subset<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> refl<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

This function corresponds with the standard semantics:

›</span></span>

<span class="keyword1" id="SPRViewDet-eval_models"><span class="command">lemma</span></span> eval_models<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> SPR.jkbpC"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ec<span class="main">:</span> <span class="quoted"><span class="quoted">"spr_simAbs <span class="free">ec</span> <span class="main">=</span> SPRdet.sim_equiv_class <span class="free">a</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> subj_phi<span class="main">:</span> <span class="quoted"><span class="quoted">"subjective <span class="free">a</span> <span class="free">φ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> toSet <span class="main">(</span>snd <span class="free">ec</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval <span class="free">envVal</span> <span class="free">envObs</span> <span class="free">ec</span> <span class="free">φ</span> <span class="main">⟷</span> spr_repMC <span class="main">(</span>toSet <span class="main">(</span>fst <span class="free">ec</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="free">s</span> <span class="main">⊨</span> <span class="free">φ</span>"</span></span>
<span class="comment1">(*&lt;*)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> eval_def
  <span class="keyword1"><span class="command">using</span></span> evalS_models<span class="main">[</span><span class="operator">OF</span> tC ec subj_phi s<span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="comment1">(*&gt;*)</span>

<span class="comment1">(* **************************************** *)</span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Simulated actions›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

From a common equivalence class and a subjective equivalence class for
agent <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">a</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, we can compute the actions enabled for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">a</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>:

›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> -<span class="main">)</span>
  <span class="entity">spr_simAction</span> <span class="main">::</span>
       <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'aAct</span><span class="main">)</span> JKBP <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> BEState <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> bool<span class="main">)</span>
     <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> BEState <span class="main">⇒</span> <span class="tfree">'cobs</span> <span class="main">×</span> <span class="tfree">'as</span> option<span class="main">)</span>
     <span class="main">⇒</span> <span class="tfree">'a</span>
     <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">,</span> <span class="tfree">'es</span><span class="main">::</span>linorder<span class="main">,</span> <span class="tfree">'as</span><span class="main">::</span>linorder<span class="main">)</span> spr_simWorldsRep
     <span class="main">⇒</span> <span class="tfree">'aAct</span> list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">spr_simAction</span> <span class="free"><span class="bound"><span class="entity">jkbp</span></span></span> <span class="free"><span class="bound"><span class="entity">envVal</span></span></span> <span class="free"><span class="bound"><span class="entity">envObs</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">a</span> <span class="bound">ec</span><span class="main">.</span>
    <span class="main">[</span> action <span class="bound">gc</span><span class="main">.</span> gc <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">jkbp</span></span></span> <span class="bound">a</span><span class="main">,</span> eval <span class="free"><span class="bound"><span class="entity">envVal</span></span></span> <span class="free"><span class="bound"><span class="entity">envObs</span></span></span> <span class="bound">ec</span> <span class="main">(</span>guard <span class="bound">gc</span><span class="main">)</span> <span class="main">]</span>"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">spr_simAction</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> spr_simWorldsRep <span class="main">⇒</span> <span class="tfree">'aAct</span> list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">spr_simAction</span> <span class="main">≡</span> SPRViewDet.spr_simAction <span class="free">jkbp</span> <span class="free">envVal</span> <span class="free">envObs</span>"</span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

Using the above result about evaluation, we can relate <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>spr_simAction›</span></span></span></span> to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"jAction"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Firstly, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>spr_simAction›</span></span></span></span> behaves the same as <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"jAction"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> using the
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"spr_repMC"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> structure:

›</span></span>

<span class="keyword1" id="SPRViewDet-spr_action_jaction"><span class="command">lemma</span></span> spr_action_jaction<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> SPR.jkbpC"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ec<span class="main">:</span> <span class="quoted"><span class="quoted">"spr_simAbs <span class="free">ec</span> <span class="main">=</span> SPRdet.sim_equiv_class <span class="free">a</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>spr_simAction <span class="free">a</span> <span class="free">ec</span><span class="main">)</span>
       <span class="main">=</span> set <span class="main">(</span>jAction <span class="main">(</span>spr_repMC <span class="main">(</span>toSet <span class="main">(</span>fst <span class="free">ec</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>tFirst <span class="free">t</span><span class="main">,</span> tLast <span class="free">t</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span>"</span></span>
<span class="comment1">(*&lt;*)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> spr_simAction_def jAction_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">xa</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> bexI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> eval_models<span class="main"><span class="main">[</span></span><span class="operator">OF</span> tC ec<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> tC ec subj
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> agent_absI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">xa</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> bexI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> eval_models<span class="main"><span class="main">[</span></span><span class="operator">OF</span> tC ec<span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command">using</span></span> tC ec subj
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> agent_absI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="SPRViewDet-spr_submodel_aux"><span class="command">lemma</span></span> spr_submodel_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> SPR.jkbpC"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> worlds <span class="main">(</span>spr_simMCt <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"gen_model SPRdet.MCS <span class="free">s</span> <span class="main">=</span> gen_model <span class="main">(</span>spr_simMCt <span class="free">t</span><span class="main">)</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> gen_model_subset<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> T<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"spr_jkbpCSt <span class="free"><span class="free">t</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?X</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"spr_sim <span class="main">`</span> <span class="main">{</span> <span class="bound">t'</span> <span class="main">.</span> <span class="bound">t'</span> <span class="main">∈</span> SPR.jkbpC <span class="main">∧</span> tObsC <span class="free">t</span> <span class="main">=</span> tObsC <span class="bound">t'</span> <span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"relations SPRdet.MCS <span class="skolem">a</span> <span class="main">∩</span> <span class="var">?X</span> <span class="main">×</span> <span class="var">?X</span>
      <span class="main">=</span> relations <span class="main">(</span>spr_simMCt <span class="free">t</span><span class="main">)</span> <span class="skolem">a</span> <span class="main">∩</span> <span class="var">?X</span> <span class="main">×</span> <span class="var">?X</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Int_ac Int_absorb1
                  relation_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> jkbpCSt_jkbpCS_subset jkbpCSt_jkbpCS_subset<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?X</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"spr_sim <span class="main">`</span> <span class="main">{</span> <span class="bound">t'</span> <span class="main">.</span> <span class="bound">t'</span> <span class="main">∈</span> SPR.jkbpC <span class="main">∧</span> tObsC <span class="free">t</span> <span class="main">=</span> tObsC <span class="bound">t'</span> <span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> s <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">a</span><span class="main">.</span> relations <span class="main">(</span>spr_simMCt <span class="free">t</span><span class="main">)</span> <span class="bound">a</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="main">{</span><span class="free">s</span><span class="main">}</span> <span class="main">⊆</span> <span class="var">?X</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> mkKripke_simps<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> kripke_rels_trc_worlds<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Y</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span> <span class="bound">t'</span> <span class="main">.</span> <span class="bound">t'</span> <span class="main">∈</span> SPR.jkbpC <span class="main">∧</span> tObsC <span class="free">t</span> <span class="main">=</span> tObsC <span class="bound">t'</span> <span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?X</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"spr_sim <span class="main">`</span> <span class="var">?Y</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> s <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> st'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">=</span> spr_sim <span class="skolem">t'</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> t'C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">∈</span> SPR.jkbpC"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> t'O<span class="main">:</span> <span class="quoted"><span class="quoted">"tObsC <span class="free">t</span> <span class="main">=</span> tObsC <span class="skolem">t'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t''</span>
    <span class="keyword3"><span class="command">assume</span></span> tt'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t'</span><span class="main">,</span> <span class="skolem">t''</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">a</span><span class="main">.</span> relations SPR.MC <span class="bound">a</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> t'C tt' <span class="keyword1"><span class="command">have</span></span> t''C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t''</span> <span class="main">∈</span> SPR.jkbpC"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">erule</span> kripke_rels_trc_worlds<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> t'O tt' <span class="keyword1"><span class="command">have</span></span> t''O<span class="main">:</span> <span class="quoted"><span class="quoted">"tObsC <span class="free">t</span> <span class="main">=</span> tObsC <span class="skolem">t''</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spr_tObsC_trc_aux<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> t''C t''O <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t''</span> <span class="main">∈</span> <span class="var">?Y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">a</span><span class="main">.</span> relations SPR.MC <span class="bound">a</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="main">{</span><span class="skolem">t'</span><span class="main">}</span> <span class="main">⊆</span> <span class="var">?Y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"spr_sim <span class="main">`</span> <span class="main">(</span><span class="main">(</span><span class="main">⋃</span><span class="bound">a</span><span class="main">.</span> relations SPR.MC <span class="bound">a</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="main">{</span><span class="skolem">t'</span><span class="main">}</span><span class="main">)</span> <span class="main">⊆</span> <span class="var">?X</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> image_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> st' t'C
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">a</span><span class="main">.</span> relations SPRdet.MCS <span class="bound">a</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="main">{</span><span class="free">s</span><span class="main">}</span> <span class="main">⊆</span> <span class="var">?X</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sim_trc_commute<span class="main">[</span><span class="operator">OF</span> SPR.mkM_kripke spr_sim<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">t'</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> s<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

We can connect the agent's choice of actions on the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>spr_repMC›</span></span></span></span> structure to those on the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>SPR.MC›</span></span></span></span> structure
using our earlier results about actions being preserved by generated
models and simulations.

›</span></span>

<span class="keyword1" id="SPRViewDet-spr_simAction"><span class="command">lemma</span></span> spr_simAction<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> SPR.jkbpC"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ec<span class="main">:</span> <span class="quoted"><span class="quoted">"spr_simAbs <span class="free">ec</span> <span class="main">=</span> SPRdet.sim_equiv_class <span class="free">a</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>spr_simAction <span class="free">a</span> <span class="free">ec</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>jAction SPR.MC <span class="free">t</span> <span class="free">a</span><span class="main">)</span>"</span></span>
<span class="comment1">(*&lt;*)</span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> tC ec
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> set <span class="main">(</span>jAction <span class="main">(</span>spr_repMC <span class="main">(</span>toSet <span class="main">(</span>fst <span class="free">ec</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>tFirst <span class="free">t</span><span class="main">,</span> tLast <span class="free">t</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> spr_action_jaction<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> tC ec <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> set <span class="main">(</span>jAction <span class="main">(</span>spr_simMCt <span class="free">t</span><span class="main">)</span> <span class="main">(</span>spr_sim <span class="free">t</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> simulation_jAction_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ spr_repSim<span class="main"><span class="main">]</span></span> spr_sim_tObsC_abs<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> tC <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> set <span class="main">(</span>jAction SPRdet.MCS <span class="main">(</span>spr_sim <span class="free">t</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> gen_model_jAction_eq<span class="main">[</span><span class="operator">OF</span> spr_submodel_aux<span class="main"><span class="main">[</span></span><span class="operator">OF</span> tC<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> s<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"spr_sim <span class="free">t</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> w'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"spr_sim <span class="free">t</span>"</span></span><span class="main">]</span>
          gen_model_world_refl<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> w<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"spr_sim <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> M<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"spr_simMCt <span class="free">t</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> tC <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> set <span class="main">(</span>jAction SPR.MC <span class="free">t</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> simulation_jAction_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ spr_sim<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="comment1">(* **************************************** *)</span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Simulated transitions›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The story of simulated transitions takes some doing. We begin by
computing the successor relation of a given equivalence class <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="free">X</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> with respect to the common equivalence class <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">cec</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>:

›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> -<span class="main">)</span>
  <span class="quoted"><span class="quoted">"<span class="free">spr_jAction</span> <span class="free"><span class="bound"><span class="entity">jkbp</span></span></span> <span class="free"><span class="bound"><span class="entity">envVal</span></span></span> <span class="free"><span class="bound"><span class="entity">envObs</span></span></span> <span class="free"><span class="bound"><span class="entity">cec</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">a</span><span class="main">.</span>
     spr_simAction <span class="free"><span class="bound"><span class="entity">jkbp</span></span></span> <span class="free"><span class="bound"><span class="entity">envVal</span></span></span> <span class="free"><span class="bound"><span class="entity">envObs</span></span></span> <span class="bound">a</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cec</span></span></span><span class="main">,</span> spr_knowledge <span class="free"><span class="bound"><span class="entity">envObs</span></span></span> <span class="free"><span class="bound"><span class="entity">cec</span></span></span> <span class="bound">a</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> -<span class="main">)</span>
  <span class="entity">spr_trans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> odlist
              <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'aAct</span><span class="main">)</span> JKBP
              <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">,</span> <span class="tfree">'es</span><span class="main">::</span>linorder<span class="main">,</span> <span class="tfree">'as</span><span class="main">::</span>linorder<span class="main">)</span> BEState <span class="main">⇒</span> <span class="tfree">'eAct</span> list<span class="main">)</span>
              <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'eAct</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'aAct</span><span class="main">)</span>
                  <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> BEState <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> BEState<span class="main">)</span>
              <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> BEState <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> bool<span class="main">)</span>
              <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> BEState <span class="main">⇒</span> <span class="tfree">'cobs</span> <span class="main">×</span> <span class="tfree">'as</span> option<span class="main">)</span>
                <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> spr_simWorldsECRep
                <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> spr_simWorldsECRep
                  <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> BEState <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> BEState<span class="main">)</span> list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">spr_trans</span> <span class="free"><span class="bound"><span class="entity">agents</span></span></span> <span class="free"><span class="bound"><span class="entity">jkbp</span></span></span> <span class="free"><span class="bound"><span class="entity">envAction</span></span></span> <span class="free"><span class="bound"><span class="entity">envTrans</span></span></span> <span class="free"><span class="bound"><span class="entity">envVal</span></span></span> <span class="free"><span class="bound"><span class="entity">envObs</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">cec</span> <span class="bound">X</span><span class="main">.</span>
    <span class="main">[</span> <span class="main">(</span><span class="bound">initialS</span><span class="main">,</span> <span class="bound">succS</span><span class="main">)</span> <span class="main">.</span>
       <span class="main">(</span>initialS<span class="main">,</span> finalS<span class="main">)</span> <span class="main">←</span> toList <span class="bound">X</span><span class="main">,</span>
       eact <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">envAction</span></span></span> <span class="bound">finalS</span><span class="main">,</span>
       succS <span class="main">←</span> <span class="main">[</span> <span class="free"><span class="bound"><span class="entity">envTrans</span></span></span> <span class="bound">eact</span> <span class="bound">aact</span> <span class="bound">finalS</span> <span class="main">.</span>
                   aact <span class="main">←</span> listToFuns <span class="main">(</span>spr_jAction <span class="free"><span class="bound"><span class="entity">jkbp</span></span></span> <span class="free"><span class="bound"><span class="entity">envVal</span></span></span> <span class="free"><span class="bound"><span class="entity">envObs</span></span></span> <span class="bound">cec</span>
                                                <span class="main">(</span><span class="bound">initialS</span><span class="main">,</span> <span class="bound">finalS</span><span class="main">)</span><span class="main">)</span>
                                   <span class="main">(</span>toList <span class="free"><span class="bound"><span class="entity">agents</span></span></span><span class="main">)</span> <span class="main">]</span> <span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

We will split the result of this function according to the common
observation and also agent <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">a</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>'s observation, where <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="free">a</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is the agent we are constructing the automaton for.

›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> -<span class="main">)</span>
  <span class="entity">spr_simObsC</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'es</span> <span class="main">⇒</span> <span class="tfree">'cobs</span><span class="main">)</span>
               <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">,</span> <span class="tfree">'es</span><span class="main">::</span>linorder<span class="main">,</span> <span class="tfree">'as</span><span class="main">::</span>linorder<span class="main">)</span> BEState
                 <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> BEState<span class="main">)</span> odlist
               <span class="main">⇒</span> <span class="tfree">'cobs</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">spr_simObsC</span> <span class="free"><span class="bound"><span class="entity">envObsC</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">envObsC</span></span></span> <span class="main">∘</span> es <span class="main">∘</span> snd <span class="main">∘</span> ODList.hd"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> -<span class="main">)</span>
  <span class="entity">envObs_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> BEState <span class="main">⇒</span> <span class="tfree">'cobs</span> <span class="main">×</span> <span class="tfree">'as</span> option<span class="main">)</span>
              <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> spr_simWorlds <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> spr_simWorlds <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">envObs_rel</span> <span class="free"><span class="bound"><span class="entity">envObs</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">envObs</span></span></span> <span class="main">(</span>snd <span class="bound">s'</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">envObs</span></span></span> <span class="main">(</span>snd <span class="bound">s</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The above combine to yield the successor equivalence classes like so:

›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> -<span class="main">)</span>
  <span class="entity">spr_simTrans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> odlist
              <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'aAct</span><span class="main">)</span> JKBP
              <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">,</span> <span class="tfree">'es</span><span class="main">::</span>linorder<span class="main">,</span> <span class="tfree">'as</span><span class="main">::</span>linorder<span class="main">)</span> BEState <span class="main">⇒</span> <span class="tfree">'eAct</span> list<span class="main">)</span>
              <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'eAct</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'aAct</span><span class="main">)</span>
                  <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> BEState <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> BEState<span class="main">)</span>
              <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> BEState <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> bool<span class="main">)</span>
              <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'es</span> <span class="main">⇒</span> <span class="tfree">'cobs</span><span class="main">)</span>
              <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> BEState <span class="main">⇒</span> <span class="tfree">'cobs</span> <span class="main">×</span> <span class="tfree">'as</span> option<span class="main">)</span>
               <span class="main">⇒</span> <span class="tfree">'a</span>
               <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> spr_simWorldsRep
               <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> spr_simWorldsRep list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">spr_simTrans</span> <span class="free"><span class="bound"><span class="entity">agents</span></span></span> <span class="free"><span class="bound"><span class="entity">jkbp</span></span></span> <span class="free"><span class="bound"><span class="entity">envAction</span></span></span> <span class="free"><span class="bound"><span class="entity">envTrans</span></span></span> <span class="free"><span class="bound"><span class="entity">envVal</span></span></span> <span class="free"><span class="bound"><span class="entity">envObsC</span></span></span> <span class="free"><span class="bound"><span class="entity">envObs</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">a</span> <span class="bound">ec</span><span class="main">.</span>
    <span class="keyword1">let</span> <span class="bound">aSuccs</span> <span class="main">=</span> spr_trans <span class="free"><span class="bound"><span class="entity">agents</span></span></span> <span class="free"><span class="bound"><span class="entity">jkbp</span></span></span> <span class="free"><span class="bound"><span class="entity">envAction</span></span></span> <span class="free"><span class="bound"><span class="entity">envTrans</span></span></span> <span class="free"><span class="bound"><span class="entity">envVal</span></span></span> <span class="free"><span class="bound"><span class="entity">envObs</span></span></span>
                           <span class="main">(</span>fst <span class="bound">ec</span><span class="main">)</span> <span class="main">(</span>snd <span class="bound">ec</span><span class="main">)</span><span class="main">;</span>
        <span class="bound">cec'</span> <span class="main">=</span> ODList.fromList
                 <span class="main">(</span>spr_trans <span class="free"><span class="bound"><span class="entity">agents</span></span></span> <span class="free"><span class="bound"><span class="entity">jkbp</span></span></span> <span class="free"><span class="bound"><span class="entity">envAction</span></span></span> <span class="free"><span class="bound"><span class="entity">envTrans</span></span></span> <span class="free"><span class="bound"><span class="entity">envVal</span></span></span> <span class="free"><span class="bound"><span class="entity">envObs</span></span></span>
                            <span class="main">(</span>fst <span class="bound">ec</span><span class="main">)</span> <span class="main">(</span>fst <span class="bound">ec</span><span class="main">)</span><span class="main">)</span>
     <span class="keyword1">in</span> <span class="main">[</span> <span class="main">(</span>ODList.filter <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">envObsC</span></span></span> <span class="main">(</span>es <span class="main">(</span>snd <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> spr_simObsC <span class="free"><span class="bound"><span class="entity">envObsC</span></span></span> <span class="bound">aec'</span><span class="main">)</span> <span class="bound">cec'</span><span class="main">,</span>
           <span class="bound">aec'</span><span class="main">)</span> <span class="main">.</span>
          aec' <span class="main">←</span> map ODList.fromList <span class="main">(</span>partition <span class="main">(</span>envObs_rel <span class="main">(</span><span class="free"><span class="bound"><span class="entity">envObs</span></span></span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="bound">aSuccs</span><span class="main">)</span> <span class="main">]</span>"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">spr_trans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> spr_simWorldsECRep
              <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> spr_simWorldsECRep
              <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> spr_simWorlds<span class="main">)</span> list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">spr_trans</span> <span class="main">≡</span> SPRViewDet.spr_trans <span class="free">agents</span> <span class="free">jkbp</span> <span class="free">envAction</span> <span class="free">envTrans</span> <span class="free">envVal</span> <span class="free">envObs</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">spr_simTrans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> spr_simWorldsRep <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> spr_simWorldsRep list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">spr_simTrans</span> <span class="main">≡</span> SPRViewDet.spr_simTrans <span class="free">agents</span> <span class="free">jkbp</span> <span class="free">envAction</span> <span class="free">envTrans</span> <span class="free">envVal</span> <span class="free">envObsC</span> <span class="free">envObs</span>"</span></span>

<span class="keyword1" id="SPRViewDet-spr_trans_aec"><span class="command">lemma</span></span> spr_trans_aec<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> SPR.jkbpC"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> ec<span class="main">:</span> <span class="quoted"><span class="quoted">"spr_simAbs <span class="free">ec</span> <span class="main">=</span> SPRdet.sim_equiv_class <span class="free">a</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>spr_trans <span class="main">(</span>fst <span class="free">ec</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">ec</span><span class="main">)</span><span class="main">)</span>
       <span class="main">=</span> <span class="main">{</span> <span class="main">(</span>tFirst <span class="bound">t'</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">|</span><span class="bound">t'</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">t'</span> <span class="main">↝</span> <span class="bound">s</span> <span class="main">∈</span> SPR.jkbpC <span class="main">∧</span> spr_jview <span class="free">a</span> <span class="bound">t'</span> <span class="main">=</span> spr_jview <span class="free">a</span> <span class="free">t</span> <span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">⊆</span> <span class="var">?rhs</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?lhs</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?rhs</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> spr_trans_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> split_paired_Ex split_paired_All <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> toSet_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> agent_abs_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">t'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> n<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Suc <span class="main">(</span>tLength <span class="improper">t'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> SPR.jkbpCn_jkbpC_inc<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> split_paired_Ex split_paired_All<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> listToFuns_ext<span class="main"><span class="main">[</span></span><span class="operator">OF</span> agents<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">unfolded</span> toSet_def<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">xa</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> spr_simAction<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> spr_simAbs_def<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> spr_knowledge<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ec<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> tObsC_absI<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> spr_jview_tObsC<span class="main">)</span>
         <span class="keyword1"><span class="command">using</span></span> ec
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span> <span class="comment1">(* FIXME *)</span>

         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> spr_repRels_def tObsC_abs_conv<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">t'b</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> image_eqI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> spr_sim_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> spr_jview_tObsCI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ spr_jview_det_ps<span class="main"><span class="main">]</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> spr_jview_tObsC<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> spr_jview_tObsC<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> spr_simAbs_def<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> spr_knowledge<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ec<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> tObsC_absI<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> spr_jview_tObsC<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"tFirst <span class="improper">xc</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"tLast <span class="improper">xc</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spr_sim_def<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> tObsC_abs_jview_eq<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> tObsC_abs_jview_eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> spr_repRels_def tObsC_abs_conv<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> spr_tFirst<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> spr_tLast<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">t'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> spr_jview_tObsC<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">xc</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> spr_jview_tObsC<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> spr_jview_tObsC<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> SPR.jkbpC_jkbpCn_jAction_eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span> <span class="main">⊆</span> <span class="var">?lhs</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?rhs</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="skolem"><span class="skolem">s</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> x'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span>tFirst <span class="skolem">t'</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> t'sC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">↝</span> <span class="skolem">s</span> <span class="main">∈</span> SPR.jkbpC"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"spr_jview <span class="free">a</span> <span class="skolem">t'</span> <span class="main">=</span> spr_jview <span class="free">a</span> <span class="free">t</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> t'sC <span class="keyword1"><span class="command">have</span></span> t'Cn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">∈</span> SPR.jkbpCn <span class="main">(</span>tLength <span class="skolem">t'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> t'sC <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">eact</span></span> <span class="skolem"><span class="skolem">aact</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> eact<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">eact</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">envAction</span> <span class="main">(</span>tLast <span class="skolem">t'</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> aact<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span><span class="main">.</span> <span class="skolem">aact</span> <span class="bound">a</span> <span class="main">∈</span> set <span class="main">(</span>jAction <span class="main">(</span>SPR.mkM <span class="main">(</span>SPR.jkbpCn <span class="main">(</span>tLength <span class="skolem">t'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t'</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> <span class="free">envTrans</span> <span class="skolem">eact</span> <span class="skolem">aact</span> <span class="main">(</span>tLast <span class="skolem">t'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> SPR.jkbpC_tLength_inv<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">↝</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> n<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Suc <span class="main">(</span>tLength <span class="skolem">t'</span><span class="main">)</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> tC t'sC ec F x' s eact aact
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?lhs</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> spr_trans_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> split_paired_Ex split_paired_All <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> toSet_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> bexI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span>tFirst <span class="skolem"><span class="skolem">t'</span></span><span class="main"><span class="main">,</span></span> tLast <span class="skolem"><span class="skolem">t'</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> bexI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">eact</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">aact</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> image_eqI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> listToFuns_ext<span class="main"><span class="main">[</span></span><span class="operator">OF</span> agents<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">unfolded</span> toSet_def<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> spr_simAction<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">t'</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> SPR.jkbpC_jkbpCn_jAction_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> t'Cn<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>

      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> spr_simAbs_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> spr_knowledge<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ec<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> tObsC_absI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">t</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> t'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">t'</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> spr_jview_tObsC<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> spr_repRels_def tObsC_abs_conv<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">t'aa</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> image_eqI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> spr_sim_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> spr_jview_tObsCI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ spr_jview_det_ps<span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> spr_jview_tObsC<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> spr_jview_tObsC<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> spr_sim_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> tObsC_abs_jview_eq<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> tObsC_abs_jview_eq<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> spr_tFirst<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> spr_tLast<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> spr_jview_tObsC <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> spr_jview_tObsC_trans<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SPRViewDet-spr_trans_cec"><span class="command">lemma</span></span> spr_trans_cec<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> SPR.jkbpC"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> ec<span class="main">:</span> <span class="quoted"><span class="quoted">"spr_simAbs <span class="free">ec</span> <span class="main">=</span> SPRdet.sim_equiv_class <span class="free">a</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>spr_trans <span class="main">(</span>fst <span class="free">ec</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">ec</span><span class="main">)</span><span class="main">)</span>
       <span class="main">=</span> <span class="main">{</span> <span class="main">(</span>tFirst <span class="bound">t'</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">|</span><span class="bound">t'</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">t'</span> <span class="main">↝</span> <span class="bound">s</span> <span class="main">∈</span> SPR.jkbpC <span class="main">∧</span> tObsC <span class="bound">t'</span> <span class="main">=</span> tObsC <span class="free">t</span> <span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">⊆</span> <span class="var">?rhs</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?lhs</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?rhs</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> spr_trans_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> split_paired_Ex split_paired_All <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> toSet_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> tObsC_abs_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">t'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> n<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Suc <span class="main">(</span>tLength <span class="improper">t'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> SPR.jkbpCn_jkbpC_inc<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> split_paired_Ex split_paired_All<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> listToFuns_ext<span class="main"><span class="main">[</span></span><span class="operator">OF</span> agents<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">unfolded</span> toSet_def<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">xa</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> spr_simAction<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> spr_simAbs_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> spr_knowledge<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ec<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> tObsC_absI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> spr_repRels_def tObsC_abs_conv ec<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">t'b</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> image_eqI<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> spr_sim_def ec<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> spr_jview_tObsCI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ spr_jview_det_ps<span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> spr_simAbs_def<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> spr_knowledge<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ec<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> tObsC_absI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"tFirst <span class="improper">xc</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"tLast <span class="improper">xc</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spr_sim_def<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> tObsC_abs_jview_eq<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> spr_repRels_def tObsC_abs_conv<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> spr_tFirst<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> spr_tLast<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">t'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">xc</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> spr_jview_tObsC<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> SPR.jkbpC_jkbpCn_jAction_eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span> <span class="main">⊆</span> <span class="var">?lhs</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?rhs</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="skolem"><span class="skolem">s</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> x'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span>tFirst <span class="skolem">t'</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> t'sC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">↝</span> <span class="skolem">s</span> <span class="main">∈</span> SPR.jkbpC"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"tObsC <span class="skolem">t'</span> <span class="main">=</span> tObsC <span class="free">t</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> t'sC <span class="keyword1"><span class="command">have</span></span> t'Cn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">∈</span> SPR.jkbpCn <span class="main">(</span>tLength <span class="skolem">t'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> t'sC <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">eact</span></span> <span class="skolem"><span class="skolem">aact</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> eact<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">eact</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">envAction</span> <span class="main">(</span>tLast <span class="skolem">t'</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> aact<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span><span class="main">.</span> <span class="skolem">aact</span> <span class="bound">a</span> <span class="main">∈</span> set <span class="main">(</span>jAction <span class="main">(</span>SPR.mkM <span class="main">(</span>SPR.jkbpCn <span class="main">(</span>tLength <span class="skolem">t'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t'</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> <span class="free">envTrans</span> <span class="skolem">eact</span> <span class="skolem">aact</span> <span class="main">(</span>tLast <span class="skolem">t'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> SPR.jkbpC_tLength_inv<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">↝</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> n<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Suc <span class="main">(</span>tLength <span class="skolem">t'</span><span class="main">)</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> tC t'sC ec F x' s eact aact
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?lhs</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> spr_trans_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> split_paired_Ex split_paired_All <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> toSet_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> bexI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span>tFirst <span class="skolem"><span class="skolem">t'</span></span><span class="main"><span class="main">,</span></span> tLast <span class="skolem"><span class="skolem">t'</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> bexI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">eact</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">aact</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> image_eqI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> listToFuns_ext<span class="main"><span class="main">[</span></span><span class="operator">OF</span> agents<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">unfolded</span> toSet_def<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> spr_simAction<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">t'</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> SPR.jkbpC_jkbpCn_jAction_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> t'Cn<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>

      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> spr_simAbs_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> spr_knowledge<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ec<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> tObsC_absI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">t</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> t'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">t'</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> spr_repRels_def tObsC_abs_conv<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">t'aa</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> image_eqI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> spr_sim_def <span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> spr_jview_tObsCI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ spr_jview_det_ps<span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> spr_sim_def <span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> tObsC_abs_jview_eq <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> spr_tFirst spr_tLast<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> spr_tFirst<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> spr_tLast<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> spr_tLast<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">xb</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> spr_jview_tObsC <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> spr_jview_tObsC_trans<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SPRViewDet-spr_simObsC"><span class="command">lemma</span></span> spr_simObsC<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> t'sC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">↝</span> <span class="free">s</span> <span class="main">∈</span> SPR.jkbpC"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> aec'<span class="main">:</span> <span class="quoted"><span class="quoted">"toSet <span class="free">aec</span> <span class="main">=</span> <span class="main">(</span>rel_ext <span class="main">(</span>envObs_rel <span class="main">(</span><span class="free">envObs</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> <span class="free">X</span> <span class="main">×</span> <span class="free">X</span><span class="main">)</span> <span class="main">``</span> <span class="main">{</span><span class="main">(</span>tFirst <span class="free">t</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span><span class="main">}</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span>tFirst <span class="bound">t'</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">|</span><span class="bound">t'</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">t'</span> <span class="main">↝</span> <span class="bound">s</span> <span class="main">∈</span> SPR.jkbpC <span class="main">∧</span> spr_jview <span class="free">a</span> <span class="bound">t'</span> <span class="main">=</span> spr_jview <span class="free">a</span> <span class="free">t</span><span class="main">}</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"spr_simObsC <span class="free">envObsC</span> <span class="free">aec</span> <span class="main">=</span> <span class="free">envObsC</span> <span class="main">(</span>es <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> spr_simObsC_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">aec</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command">using</span></span> assms
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ODList.hd_def toList_fromList<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">x</span> <span class="main">∈</span> insert <span class="improper">x</span> <span class="main">(</span>set <span class="improper">xs</span><span class="main">)</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> envObs_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="SPRViewDet-envObs_rel_equiv"><span class="command">lemma</span></span> envObs_rel_equiv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"equiv UNIV <span class="main">(</span>rel_ext <span class="main">(</span>envObs_rel <span class="main">(</span><span class="free">envObs</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> equivI refl_onI symI transI<span class="main">)</span> <span class="operator">auto</span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

Showing that <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>spr_simTrans›</span></span></span></span> works requires a series of
auxiliary lemmas that show we do in fact compute the correct successor
equivalence classes. We elide the unedifying details, skipping
straight to the lemma that the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Algorithm"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> locale expects:

›</span></span>

<span class="keyword1" id="SPRViewDet-spr_simTrans"><span class="command">lemma</span></span> spr_simTrans<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> SPR.jkbpC"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ec<span class="main">:</span> <span class="quoted"><span class="quoted">"spr_simAbs <span class="free">ec</span> <span class="main">=</span> SPRdet.sim_equiv_class <span class="free">a</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"spr_simAbs <span class="main">`</span> set <span class="main">(</span>spr_simTrans <span class="free">a</span> <span class="free">ec</span><span class="main">)</span>
      <span class="main">=</span> <span class="main">{</span> SPRdet.sim_equiv_class <span class="free">a</span> <span class="main">(</span><span class="bound">t'</span> <span class="main">↝</span> <span class="bound">s</span><span class="main">)</span>
          <span class="main">|</span><span class="bound">t'</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">t'</span> <span class="main">↝</span> <span class="bound">s</span> <span class="main">∈</span> SPR.jkbpC <span class="main">∧</span> spr_jview <span class="free">a</span> <span class="bound">t'</span> <span class="main">=</span> spr_jview <span class="free">a</span> <span class="free">t</span><span class="main">}</span>"</span></span>
<span class="comment1">(*&lt;*)</span><span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">⊆</span> <span class="var">?rhs</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?lhs</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rx</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> xrx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> spr_simAbs <span class="skolem">rx</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> rx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">rx</span> <span class="main">∈</span> set <span class="main">(</span>spr_simTrans <span class="free">a</span> <span class="free">ec</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> tC ec <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cec'</span></span> <span class="skolem"><span class="skolem">aec'</span></span> <span class="skolem"><span class="skolem">UV'</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="skolem"><span class="skolem">s</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> rxp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">rx</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">cec'</span><span class="main">,</span> <span class="skolem">aec'</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> t'sC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">↝</span> <span class="skolem">s</span> <span class="main">∈</span> SPR.jkbpC"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> tt'<span class="main">:</span> <span class="quoted"><span class="quoted">"spr_jview <span class="free">a</span> <span class="skolem">t'</span> <span class="main">=</span> spr_jview <span class="free">a</span> <span class="free">t</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> aec'<span class="main">:</span> <span class="quoted"><span class="quoted">"toSet <span class="skolem">aec'</span> <span class="main">=</span> <span class="main">(</span>rel_ext <span class="main">(</span>envObs_rel <span class="main">(</span><span class="free">envObs</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> set <span class="main">(</span>spr_trans <span class="main">(</span>fst <span class="free">ec</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">ec</span><span class="main">)</span><span class="main">)</span>
                                                       <span class="main">×</span> set <span class="main">(</span>spr_trans <span class="main">(</span>fst <span class="free">ec</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">ec</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">``</span> <span class="main">{</span><span class="main">(</span>tFirst <span class="skolem">t'</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span><span class="main">}</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> cec'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">cec'</span> <span class="main">=</span> ODList.filter <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">envObsC</span> <span class="main">(</span>es <span class="main">(</span>snd <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> spr_simObsC <span class="free">envObsC</span> <span class="skolem">aec'</span><span class="main">)</span> <span class="main">(</span>fromList <span class="main">(</span>spr_trans <span class="main">(</span>fst <span class="free">ec</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">ec</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> spr_simTrans_def
      <span class="keyword1"><span class="command">using</span></span> spr_trans_aec<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split_asm<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> imageI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">set</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partition<span class="main"><span class="main">[</span></span><span class="operator">OF</span> envObs_rel_equiv subset_UNIV<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> quotientE<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">from</span></span> t'sC tt' aec' cec'
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"spr_simAbs <span class="main">(</span><span class="skolem">cec'</span><span class="main">,</span> <span class="skolem">aec'</span><span class="main">)</span> <span class="main">=</span> SPRdet.sim_equiv_class <span class="free">a</span> <span class="main">(</span><span class="skolem">t'</span> <span class="main">↝</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> spr_simAbs_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
       <span class="keyword1"><span class="command">using</span></span> spr_trans_aec<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> spr_trans_cec<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">t'aa</span> <span class="main">↝</span> <span class="improper">s'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> image_eqI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spr_sim_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cut_tac</span> aec<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">aec'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> t<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> s<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spr_simObsC<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">a</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> t'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">t'b</span> <span class="main">↝</span> <span class="improper">sa</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> tObsC_absI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> spr_jview_tObsC <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> tObsC_def envObs_def_raw<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> envObs_def_raw tObsC_abs_conv<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">t'b</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tObsC_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> Trace State<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">Trace</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> spr_jview_tObsC <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tObsC_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spr_jview_def<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> spr_trans_aec<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> spr_trans_cec<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> spr_sim_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cut_tac</span> aec<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">aec'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> t<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> s<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spr_simObsC<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">a</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> spr_jview_tStep_eq_inv<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tObsC_abs_conv<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">t'a</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tObsC_def<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> Trace State<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">Trace</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> spr_jview_prefix_closed<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> spr_jview_tObsC <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tObsC_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>

       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> spr_jview_def Let_def envObs_def_raw<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>

       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> t'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">t'a</span> <span class="main">↝</span> <span class="improper">sa</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> tObsC_absI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>

        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> spr_jview_tObsC<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> spr_jview_prefix_closed<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> spr_jview_tObsC <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tObsC_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>

        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spr_jview_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">t''</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> spr_jview_prefix_closed<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">with</span></span> xrx rxp t'sC tt'
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?rhs</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">note</span></span> image_cong_simp <span class="main">[</span><span class="operator">cong</span> <span class="quasi_keyword">del</span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span> <span class="main">⊆</span> <span class="var">?lhs</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?rhs</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="skolem"><span class="skolem">s</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> t'sC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">↝</span> <span class="skolem">s</span> <span class="main">∈</span> SPR.jkbpC"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> tt'<span class="main">:</span> <span class="quoted"><span class="quoted">"spr_jview <span class="free">a</span> <span class="skolem">t'</span> <span class="main">=</span> spr_jview <span class="free">a</span> <span class="free">t</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> xt's<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> SPRdet.sim_equiv_class <span class="free">a</span> <span class="main">(</span><span class="skolem">t'</span> <span class="main">↝</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span>sprFst <span class="bound">s</span><span class="main">,</span> sprLst <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">x</span> <span class="main">∈</span> set <span class="main">`</span> set <span class="main">(</span>partition <span class="main">(</span>envObs_rel <span class="main">(</span><span class="free">envObs</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>spr_trans <span class="main">(</span>fst <span class="free">ec</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">ec</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partition<span class="main"><span class="main">[</span></span><span class="operator">OF</span> envObs_rel_equiv<span class="main"><span class="main">]</span></span> spr_trans_aec<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span> spr_sim_def <span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span>tFirst <span class="skolem">t'</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> quotientI2<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> spr_jview_tStep_eq_inv<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> spr_jview_tStep_eq_inv<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> spr_jview_prefix_closed<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">⦇</span>sprFst <span class="main">=</span> tFirst <span class="improper">t'aa</span><span class="main">,</span> sprLst <span class="main">=</span> <span class="improper">sa</span><span class="main">,</span> sprCRel <span class="main">=</span> tObsC_abs <span class="main">(</span><span class="improper">t'aa</span> <span class="main">↝</span> <span class="improper">sa</span><span class="main">)</span><span class="main">⦈</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> image_eqI<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">t'aa</span> <span class="main">↝</span> <span class="improper">sa</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> image_eqI<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spr_jview_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rx</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rx</span> <span class="main">∈</span> set <span class="main">(</span>partition <span class="main">(</span>envObs_rel <span class="main">(</span><span class="free">envObs</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>spr_trans <span class="main">(</span>fst <span class="free">ec</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">ec</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">rx</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span>sprFst <span class="bound">s</span><span class="main">,</span> sprLst <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> t'sC tt' xt's <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?lhs</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> spr_simTrans_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span>ODList.filter <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">envObsC</span> <span class="main">(</span>es <span class="main">(</span>snd <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> spr_simObsC <span class="free">envObsC</span> <span class="main">(</span>fromList <span class="skolem">rx</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fromList <span class="main">(</span>spr_trans <span class="main">(</span>fst <span class="free">ec</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">ec</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> fromList <span class="skolem">rx</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> image_eqI<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">rx</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> image_eqI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>

       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> spr_simObsC<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">a</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> t<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">t'</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> s<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">s</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ _ refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> spr_jview_tStep_eq_inv<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> spr_jview_def spr_sim_def <span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"spr_sim <span class="main">(</span><span class="improper">t'aa</span> <span class="main">↝</span> <span class="improper">sa</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> image_eqI<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spr_sim_def <span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">t'aa</span> <span class="main">↝</span> <span class="improper">sa</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> image_eqI<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spr_jview_def<span class="main">)</span>

       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> spr_trans_cec<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span> spr_sim_def <span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span> spr_simAbs_def<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> tObsC_abs_conv<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> spr_jview_tStep_eq_inv<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> tObsC_tStep_eq_inv<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> spr_jview_prefix_closed<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> spr_jview_tObsC<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> spr_jview_tObsC<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> tObsC_prefix_closed<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">t''a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>

         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> spr_jview_tStep_eq_inv<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> tObsC_tStep_eq_inv<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> spr_jview_tObsC<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">back</span></span></span></span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tObsC_def<span class="main">)</span>

         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">t'a</span> <span class="main">↝</span> <span class="improper">sa</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> spr_jview_tStep_eq_inv<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> spr_jview_tObsC<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> spr_jview_tObsC<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tObsC_def<span class="main">)</span>

         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"spr_sim <span class="improper">ta</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> image_eqI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spr_sim_def <span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">ta</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> image_eqI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spr_sim_def <span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">ta</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> image_eqI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tObsC_abs_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>

        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">t'a</span> <span class="main">↝</span> <span class="improper">sa</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> spr_jview_tStep_eq_inv<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> spr_jview_tObsC<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> spr_jview_tObsC<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tObsC_def<span class="main">)</span>

        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> spr_jview_tStep_eq_inv<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> tObsC_tStep_eq_inv<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">t''a</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> spr_jview_tObsC<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> spr_jview_tObsC<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tObsC_def<span class="main">)</span>

        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> spr_jview_tStep_eq_inv<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> tObsC_tStep_eq_inv<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> spr_jview_tObsC<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">back</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tObsC_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The explicit-state approach sketched above is quite inefficient, and
also some distance from the symbolic techniques we use in
\S\ref{sec:kbps-prag-algorithmics}. However it does suffice to
demonstrate the theory on the muddy children example in
\S\ref{sec:kbps-theory-mc}.

›</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context FiniteDetBroadcastEnvironment *)</span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Maps›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

As always we use a pair of tries. The domain of these maps is the pair
of relations.

›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'obs</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> trans_trie
    <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> BEState<span class="main">,</span>
        <span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> BEState<span class="main">,</span>
          <span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> BEState<span class="main">,</span>
           <span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> BEState<span class="main">,</span>
            <span class="main">(</span><span class="tfree">'obs</span><span class="main">,</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> spr_simWorldsRep<span class="main">)</span> mapping<span class="main">)</span> trie<span class="main">)</span> trie<span class="main">)</span> trie<span class="main">)</span> trie"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span>
  <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'aAct</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> acts_trie
    <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> BEState<span class="main">,</span>
        <span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> BEState<span class="main">,</span>
          <span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> BEState<span class="main">,</span>
           <span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> BEState<span class="main">,</span> <span class="tfree">'aAct</span><span class="main">)</span> trie<span class="main">)</span> trie<span class="main">)</span> trie<span class="main">)</span> trie"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">trans_MapOps_lookup</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> linorder<span class="main">,</span> <span class="tfree">'es</span> <span class="main">::</span> linorder<span class="main">,</span> <span class="tfree">'obs</span><span class="main">,</span> <span class="tfree">'as</span> <span class="main">::</span> linorder<span class="main">)</span> trans_trie
                        <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> spr_simWorldsRep <span class="main">×</span> <span class="tfree">'obs</span>
                        <span class="main">⇀</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> spr_simWorldsRep"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">trans_MapOps_lookup</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">m</span> <span class="main">(</span><span class="main">(</span><span class="bound">cec</span><span class="main">,</span> <span class="bound">aec</span><span class="main">)</span><span class="main">,</span> <span class="bound">obs</span><span class="main">)</span><span class="main">.</span>
     Option.bind <span class="main">(</span>lookup_trie <span class="bound">m</span> <span class="main">(</span>map fst <span class="main">(</span>toList <span class="bound">cec</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">.</span> Option.bind <span class="main">(</span>lookup_trie <span class="bound">m</span> <span class="main">(</span>map snd <span class="main">(</span>toList <span class="bound">cec</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
       <span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">.</span> Option.bind <span class="main">(</span>lookup_trie <span class="bound">m</span> <span class="main">(</span>map fst <span class="main">(</span>toList <span class="bound">aec</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
        <span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">.</span> Option.bind <span class="main">(</span>lookup_trie <span class="bound">m</span> <span class="main">(</span>map snd <span class="main">(</span>toList <span class="bound">aec</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
         <span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">.</span> Mapping.lookup <span class="bound">m</span> <span class="bound">obs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">trans_MapOps_update</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> spr_simWorldsRep <span class="main">×</span> <span class="tfree">'obs</span>
                        <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> spr_simWorldsRep
                        <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> linorder<span class="main">,</span> <span class="tfree">'es</span> <span class="main">::</span> linorder<span class="main">,</span> <span class="tfree">'obs</span><span class="main">,</span> <span class="tfree">'as</span> <span class="main">::</span> linorder<span class="main">)</span> trans_trie
                        <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'obs</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> trans_trie"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">trans_MapOps_update</span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">cec</span><span class="main">,</span> <span class="bound">aec</span><span class="main">)</span><span class="main">,</span> <span class="bound">obs</span><span class="main">)</span> <span class="bound">v</span> <span class="bound">m</span><span class="main">.</span>
     trie_update_with' <span class="main">(</span>map fst <span class="main">(</span>toList <span class="bound">cec</span><span class="main">)</span><span class="main">)</span> <span class="bound">m</span> empty_trie
      <span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">.</span> trie_update_with' <span class="main">(</span>map snd <span class="main">(</span>toList <span class="bound">cec</span><span class="main">)</span><span class="main">)</span> <span class="bound">m</span> empty_trie
       <span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">.</span> trie_update_with' <span class="main">(</span>map fst <span class="main">(</span>toList <span class="bound">aec</span><span class="main">)</span><span class="main">)</span> <span class="bound">m</span> empty_trie
        <span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">.</span> trie_update_with' <span class="main">(</span>map snd <span class="main">(</span>toList <span class="bound">aec</span><span class="main">)</span><span class="main">)</span> <span class="bound">m</span> Mapping.empty
         <span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">.</span> Mapping.update <span class="bound">obs</span> <span class="bound">v</span> <span class="bound">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">trans_MapOps</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> linorder<span class="main">,</span> <span class="tfree">'es</span> <span class="main">::</span> linorder<span class="main">,</span> <span class="tfree">'obs</span><span class="main">,</span> <span class="tfree">'as</span> <span class="main">::</span> linorder<span class="main">)</span> trans_trie<span class="main">,</span>
                    <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> spr_simWorldsRep <span class="main">×</span> <span class="tfree">'obs</span><span class="main">,</span>
                    <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> spr_simWorldsRep<span class="main">)</span> MapOps"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">trans_MapOps</span> <span class="main">≡</span>
     <span class="main">⦇</span> MapOps.empty <span class="main">=</span> empty_trie<span class="main">,</span>
       lookup <span class="main">=</span> trans_MapOps_lookup<span class="main">,</span>
       update <span class="main">=</span> trans_MapOps_update <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> FiniteDetBroadcastEnvironment<span class="main">)</span> trans_MapOps<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"MapOps <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span>spr_simAbs <span class="main">(</span>fst <span class="bound">k</span><span class="main">)</span><span class="main">,</span> snd <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>SPRdet.jkbpSEC <span class="main">×</span> UNIV<span class="main">)</span> trans_MapOps"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"MapOps.lookup trans_MapOps <span class="main">(</span>MapOps.empty trans_MapOps<span class="main">)</span> <span class="skolem">k</span> <span class="main">=</span> None"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> trans_MapOps_def trans_MapOps_lookup_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">e</span> <span class="skolem">k</span> <span class="skolem">k'</span> <span class="skolem">M</span>
  <span class="keyword3"><span class="command">assume</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>spr_simAbs <span class="main">(</span>fst <span class="skolem">k</span><span class="main">)</span><span class="main">,</span> snd <span class="skolem">k</span><span class="main">)</span> <span class="main">∈</span> SPRdet.jkbpSEC <span class="main">×</span> <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'z</span> set<span class="main">)</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> k'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>spr_simAbs <span class="main">(</span>fst <span class="skolem">k'</span><span class="main">)</span><span class="main">,</span> snd <span class="skolem">k'</span><span class="main">)</span> <span class="main">∈</span> SPRdet.jkbpSEC <span class="main">×</span> <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'z</span> set<span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"MapOps.lookup trans_MapOps <span class="main">(</span>MapOps.update trans_MapOps <span class="skolem">k</span> <span class="skolem">e</span> <span class="skolem">M</span><span class="main">)</span> <span class="skolem">k'</span>
         <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span>spr_simAbs <span class="main">(</span>fst <span class="skolem">k'</span><span class="main">)</span><span class="main">,</span> snd <span class="skolem">k'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>spr_simAbs <span class="main">(</span>fst <span class="skolem">k</span><span class="main">)</span><span class="main">,</span> snd <span class="skolem">k</span><span class="main">)</span>
             <span class="keyword1">then</span> Some <span class="skolem">e</span> <span class="keyword1">else</span> MapOps.lookup trans_MapOps <span class="skolem">M</span> <span class="skolem">k'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>spr_simAbs <span class="main">(</span>fst <span class="skolem">k'</span><span class="main">)</span><span class="main">,</span> snd <span class="skolem">k'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>spr_simAbs <span class="main">(</span>fst <span class="skolem">k</span><span class="main">)</span><span class="main">,</span> snd <span class="skolem">k</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="skolem">k'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> inj_onD<span class="main">[</span><span class="operator">OF</span> spr_simAbs_inj_on<span class="main">]</span> k k' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> prod_eqI<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> trans_MapOps_def trans_MapOps_lookup_def trans_MapOps_update_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lookup_update lookup_trie_update_with <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split prod.split<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">y</span> <span class="bound">ya</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≠</span> <span class="bound">ya</span> <span class="main">⟹</span> Mapping.lookup <span class="main">(</span>Mapping.update <span class="bound">y</span> <span class="skolem">e</span> Mapping.empty<span class="main">)</span> <span class="bound">ya</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> trans_MapOps_def trans_MapOps_lookup_def trans_MapOps_update_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> map_prod_eq <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lookup_trie_update_with <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split prod.split <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> lookup_update_neq *<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* A map for the agent actions. *)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">acts_MapOps_lookup</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> linorder<span class="main">,</span> <span class="tfree">'es</span> <span class="main">::</span> linorder<span class="main">,</span> <span class="tfree">'aAct</span><span class="main">,</span> <span class="tfree">'as</span> <span class="main">::</span> linorder<span class="main">)</span> acts_trie
                       <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> spr_simWorldsRep
                       <span class="main">⇀</span> <span class="tfree">'aAct</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">acts_MapOps_lookup</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">m</span> <span class="main">(</span><span class="bound">cec</span><span class="main">,</span> <span class="bound">aec</span><span class="main">)</span><span class="main">.</span>
     Option.bind <span class="main">(</span>lookup_trie <span class="bound">m</span> <span class="main">(</span>map fst <span class="main">(</span>toList <span class="bound">cec</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">.</span> Option.bind <span class="main">(</span>lookup_trie <span class="bound">m</span> <span class="main">(</span>map snd <span class="main">(</span>toList <span class="bound">cec</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
       <span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">.</span> Option.bind <span class="main">(</span>lookup_trie <span class="bound">m</span> <span class="main">(</span>map fst <span class="main">(</span>toList <span class="bound">aec</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
        <span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">.</span> lookup_trie <span class="bound">m</span> <span class="main">(</span>map snd <span class="main">(</span>toList <span class="bound">aec</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">acts_MapOps_update</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> spr_simWorldsRep
                       <span class="main">⇒</span> <span class="tfree">'aAct</span>
                       <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> linorder<span class="main">,</span> <span class="tfree">'es</span> <span class="main">::</span> linorder<span class="main">,</span> <span class="tfree">'aAct</span><span class="main">,</span> <span class="tfree">'as</span> <span class="main">::</span> linorder<span class="main">)</span> acts_trie
                       <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'aAct</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> acts_trie"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">acts_MapOps_update</span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">cec</span><span class="main">,</span> <span class="bound">aec</span><span class="main">)</span> <span class="bound">pAct</span> <span class="bound">m</span><span class="main">.</span>
     trie_update_with' <span class="main">(</span>map fst <span class="main">(</span>toList <span class="bound">cec</span><span class="main">)</span><span class="main">)</span> <span class="bound">m</span> empty_trie
      <span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">.</span> trie_update_with' <span class="main">(</span>map snd <span class="main">(</span>toList <span class="bound">cec</span><span class="main">)</span><span class="main">)</span> <span class="bound">m</span> empty_trie
       <span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">.</span> trie_update_with' <span class="main">(</span>map fst <span class="main">(</span>toList <span class="bound">aec</span><span class="main">)</span><span class="main">)</span> <span class="bound">m</span> empty_trie
        <span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">.</span> trie_update <span class="main">(</span>map snd <span class="main">(</span>toList <span class="bound">aec</span><span class="main">)</span><span class="main">)</span> <span class="bound">pAct</span> <span class="bound">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">acts_MapOps</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> linorder<span class="main">,</span> <span class="tfree">'es</span> <span class="main">::</span> linorder<span class="main">,</span> <span class="tfree">'aAct</span><span class="main">,</span> <span class="tfree">'as</span> <span class="main">::</span> linorder<span class="main">)</span> acts_trie<span class="main">,</span>
                   <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'as</span><span class="main">)</span> spr_simWorldsRep<span class="main">,</span>
                   <span class="tfree">'aAct</span><span class="main">)</span> MapOps"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">acts_MapOps</span> <span class="main">≡</span>
     <span class="main">⦇</span> MapOps.empty <span class="main">=</span> empty_trie<span class="main">,</span>
       lookup <span class="main">=</span> acts_MapOps_lookup<span class="main">,</span>
       update <span class="main">=</span> acts_MapOps_update <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> FiniteDetBroadcastEnvironment<span class="main">)</span> acts_MapOps<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"MapOps spr_simAbs SPRdet.jkbpSEC acts_MapOps"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"MapOps.lookup acts_MapOps <span class="main">(</span>MapOps.empty acts_MapOps<span class="main">)</span> <span class="skolem">k</span> <span class="main">=</span> None"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> acts_MapOps_def acts_MapOps_lookup_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">e</span> <span class="skolem">k</span> <span class="skolem">k'</span> <span class="skolem">M</span>
  <span class="keyword3"><span class="command">assume</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"spr_simAbs <span class="skolem">k</span> <span class="main">∈</span> SPRdet.jkbpSEC"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> k'<span class="main">:</span> <span class="quoted"><span class="quoted">"spr_simAbs <span class="skolem">k'</span> <span class="main">∈</span> SPRdet.jkbpSEC"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"MapOps.lookup acts_MapOps <span class="main">(</span>MapOps.update acts_MapOps <span class="skolem">k</span> <span class="skolem">e</span> <span class="skolem">M</span><span class="main">)</span> <span class="skolem">k'</span>
         <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> spr_simAbs <span class="skolem">k'</span> <span class="main">=</span> spr_simAbs <span class="skolem">k</span>
             <span class="keyword1">then</span> Some <span class="skolem">e</span> <span class="keyword1">else</span> MapOps.lookup acts_MapOps <span class="skolem">M</span> <span class="skolem">k'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"spr_simAbs <span class="skolem">k'</span> <span class="main">=</span> spr_simAbs <span class="skolem">k</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="skolem">k'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> inj_onD<span class="main">[</span><span class="operator">OF</span> spr_simAbs_inj_on<span class="main">]</span> k k' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> prod_eqI<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> acts_MapOps_def acts_MapOps_lookup_def acts_MapOps_update_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lookup_trie_update_with lookup_trie_update <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split prod.split<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> acts_MapOps_def acts_MapOps_lookup_def acts_MapOps_update_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> map_prod_eq <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lookup_trie_update_with lookup_trie_update <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split prod.split<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

This suffices to placate the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Algorithm"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> locale.

›</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> FiniteDetBroadcastEnvironment
        <span class="main">&lt;</span> SPRdet<span class="main">:</span> Algorithm
            <span class="quoted"><span class="free">jkbp</span></span> <span class="quoted"><span class="free">envInit</span></span> <span class="quoted"><span class="free">envAction</span></span> <span class="quoted"><span class="free">envTrans</span></span> <span class="quoted"><span class="free">envVal</span></span>
            <span class="quoted">spr_jview</span> <span class="quoted"><span class="free">envObs</span></span> <span class="quoted">spr_jviewInit</span> <span class="quoted">spr_jviewIncr</span>
            <span class="quoted">spr_sim</span> <span class="quoted">spr_simRels</span> <span class="quoted">spr_simVal</span>
            <span class="quoted">spr_simAbs</span> <span class="quoted">spr_simObs</span> <span class="quoted">spr_simInit</span> <span class="quoted">spr_simTrans</span> <span class="quoted">spr_simAction</span>
            <span class="quoted">acts_MapOps</span> <span class="quoted">trans_MapOps</span>
<span class="comment1">(*&lt;*)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>

  <span class="keyword1"><span class="command">using</span></span> spr_simInit
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>

  <span class="keyword1"><span class="command">using</span></span> spr_simObs
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>

  <span class="keyword1"><span class="command">using</span></span> spr_simAction
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>

  <span class="keyword1"><span class="command">using</span></span> spr_simTrans
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> acts_MapOps<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> trans_MapOps<span class="main">)</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mkSPRDetAuto</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">agents</span> <span class="bound">jkbp</span> <span class="bound">envInit</span> <span class="bound">envAction</span> <span class="bound">envTrans</span> <span class="bound">envVal</span> <span class="bound">envObsC</span> <span class="bound">envObs</span><span class="main">.</span>
    mkAlgAuto acts_MapOps
              trans_MapOps
              <span class="main">(</span>spr_simObs <span class="bound">envObsC</span><span class="main">)</span>
              <span class="main">(</span>spr_simInit <span class="bound">envInit</span> <span class="bound">envObsC</span> <span class="bound">envObs</span><span class="main">)</span>
              <span class="main">(</span>spr_simTrans <span class="bound">agents</span> <span class="bound">jkbp</span> <span class="bound">envAction</span> <span class="bound">envTrans</span> <span class="bound">envVal</span> <span class="bound">envObsC</span> <span class="bound">envObs</span><span class="main">)</span>
              <span class="main">(</span>spr_simAction <span class="bound">jkbp</span> <span class="bound">envVal</span> <span class="bound">envObs</span><span class="main">)</span>
              <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> map <span class="main">(</span>spr_simInit <span class="bound">envInit</span> <span class="bound">envObsC</span> <span class="bound">envObs</span> <span class="bound">a</span> <span class="main">∘</span> <span class="bound">envObs</span> <span class="bound">a</span><span class="main">)</span> <span class="bound">envInit</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> FiniteDetBroadcastEnvironment<span class="main">)</span> mkSPRDetAuto_implements<span class="main">:</span>
  <span class="quoted"><span class="quoted">"SPR.implements <span class="main">(</span>mkSPRDetAuto <span class="free">agents</span> <span class="free">jkbp</span> <span class="free">envInit</span> <span class="free">envAction</span> <span class="free">envTrans</span> <span class="free">envVal</span> <span class="free">envObsC</span> <span class="free">envObs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> SPRdet.k_mkAlgAuto_implements
  <span class="keyword1"><span class="command">unfolding</span></span> mkSPRDetAuto_def mkAlgAuto_def SPRdet.k_frontier_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="comment1">(*

We actually run this unfolding of the algorithm. The lemma is keeping
us honest.

*)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">SPRDetAutoDFS</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">agents</span> <span class="bound">jkbp</span> <span class="bound">envInit</span> <span class="bound">envAction</span> <span class="bound">envTrans</span> <span class="bound">envVal</span> <span class="bound">envObsC</span> <span class="bound">envObs</span><span class="main">.</span> <span class="main">λ</span><span class="bound">a</span><span class="main">.</span>
    alg_dfs acts_MapOps
            trans_MapOps
            <span class="main">(</span>spr_simObs <span class="bound">envObsC</span> <span class="bound">a</span><span class="main">)</span>
            <span class="main">(</span>spr_simTrans <span class="bound">agents</span> <span class="bound">jkbp</span> <span class="bound">envAction</span> <span class="bound">envTrans</span> <span class="bound">envVal</span> <span class="bound">envObsC</span> <span class="bound">envObs</span> <span class="bound">a</span><span class="main">)</span>
            <span class="main">(</span>spr_simAction <span class="bound">jkbp</span> <span class="bound">envVal</span> <span class="bound">envObs</span> <span class="bound">a</span><span class="main">)</span>
            <span class="main">(</span>map <span class="main">(</span>spr_simInit <span class="bound">envInit</span> <span class="bound">envObsC</span> <span class="bound">envObs</span> <span class="bound">a</span> <span class="main">∘</span> <span class="bound">envObs</span> <span class="bound">a</span><span class="main">)</span> <span class="bound">envInit</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> FiniteDetBroadcastEnvironment<span class="main">)</span>
  <span class="quoted"><span class="quoted">"mkSPRDetAuto <span class="free">agents</span> <span class="free">jkbp</span> <span class="free">envInit</span> <span class="free">envAction</span> <span class="free">envTrans</span> <span class="free">envVal</span> <span class="free">envObsC</span> <span class="free">envObs</span>
 <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> alg_mk_auto acts_MapOps trans_MapOps
           <span class="main">(</span>spr_simInit <span class="bound">a</span><span class="main">)</span>
           <span class="main">(</span>SPRDetAutoDFS <span class="free">agents</span> <span class="free">jkbp</span> <span class="free">envInit</span> <span class="free">envAction</span> <span class="free">envTrans</span> <span class="free">envVal</span> <span class="free">envObsC</span> <span class="free">envObs</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mkSPRDetAuto_def mkAlgAuto_def SPRDetAutoDFS_def alg_mk_auto_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

As we remarked earlier in this section, in general it may be difficult
to establish the determinacy of a KBP as it is a function of the
environment. However in many cases determinism is syntactically
manifest as the guards are logically disjoint, independently of the
knowledge subformulas. The following lemma generates the required
proof obligations for this case:

›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> PreEnvironmentJView<span class="main">)</span> jkbpDetI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> jkbpC"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> jkbpSynDet<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span><span class="main">.</span> distinct <span class="main">(</span>map guard <span class="main">(</span><span class="free">jkbp</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> jkbpSemDet<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span> <span class="bound">gc</span> <span class="bound">gc'</span><span class="main">.</span>
        <span class="bound">gc</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">jkbp</span> <span class="bound">a</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">gc'</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">jkbp</span> <span class="bound">a</span><span class="main">)</span> <span class="main">∧</span> <span class="free">t</span> <span class="main">∈</span> jkbpC
    <span class="main">⟶</span> guard <span class="bound">gc</span> <span class="main">=</span> guard <span class="bound">gc'</span> <span class="main">∨</span> <span class="main">¬</span><span class="main">(</span>MC<span class="main">,</span> <span class="free">t</span> <span class="main">⊨</span> guard <span class="bound">gc</span> <span class="main">∧</span> MC<span class="main">,</span> <span class="free">t</span> <span class="main">⊨</span> guard <span class="bound">gc'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>jAction MC <span class="free">t</span> <span class="free">a</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">X</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">X</span> <span class="main">⊆</span> set <span class="main">(</span><span class="free">jkbp</span> <span class="skolem">a</span><span class="main">)</span>"</span></span>
       <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map guard <span class="skolem">X</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> tC <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">[</span> action <span class="bound">gc</span> <span class="main">.</span> gc <span class="main">←</span> <span class="skolem">X</span><span class="main">,</span> MC<span class="main">,</span> <span class="free">t</span> <span class="main">⊨</span> guard <span class="bound">gc</span> <span class="main">]</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">X</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> jkbpSemDet<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">a</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">OF</span> subset_refl jkbpSynDet<span class="main"><span class="main">[</span></span><span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> jAction_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The scenario presented here is a variant of the broadcast environments
treated by \citet{Ron:1996}, which we cover in the next section.

\FloatBarrier

›</span></span>
<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="SPRViewNonDet">
<div class="head">
<h1>Theory SPRViewNonDet</h1>
</div>
<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> SPRViewNonDet
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="#SPRView">SPRView</a>
  <a href="#KBPsAuto">KBPsAuto</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Perfect Recall in Non-deterministic Broadcast Environments›</span></span>

<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹
\begin{figure}[ht]
\begin{isabellebody}%
›</span></span>
<span class="keyword1"><span class="command">record</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'ePubAct</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'pPubAct</span><span class="main">,</span> <span class="tfree">'ps</span><span class="main">)</span> BEState <span class="main">=</span>
  es <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'es</span>"</span></span>
  ps <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'ps</span>"</span></span>
  pubActs <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'ePubAct</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'pPubAct</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> FiniteBroadcastEnvironment <span class="main">=</span>
  Environment <span class="quoted"><span class="free">jkbp</span></span> <span class="quoted"><span class="free">envInit</span></span> <span class="quoted"><span class="free">envAction</span></span> <span class="quoted"><span class="free">envTrans</span></span> <span class="quoted"><span class="free">envVal</span></span> <span class="quoted"><span class="free">envObs</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">jkbp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> finite<span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="main">(</span><span class="tfree">'pPubAct</span> <span class="main">::</span> finite <span class="main">×</span> <span class="tfree">'ps</span> <span class="main">::</span> finite<span class="main">)</span><span class="main">)</span> JKBP"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">envInit</span>
         <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'ePubAct</span> <span class="main">::</span> finite<span class="main">,</span> <span class="tfree">'es</span> <span class="main">::</span> finite<span class="main">,</span> <span class="tfree">'pPubAct</span><span class="main">,</span> <span class="tfree">'ps</span><span class="main">)</span> BEState list"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">envAction</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'ePubAct</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'pPubAct</span><span class="main">,</span> <span class="tfree">'ps</span><span class="main">)</span> BEState
                   <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'ePubAct</span> <span class="main">×</span> <span class="tfree">'ePrivAct</span><span class="main">)</span> list"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">envTrans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'ePubAct</span> <span class="main">×</span> <span class="tfree">'ePrivAct</span><span class="main">)</span>
                  <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'pPubAct</span> <span class="main">×</span> <span class="tfree">'ps</span><span class="main">)</span><span class="main">)</span>
                  <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'ePubAct</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'pPubAct</span><span class="main">,</span> <span class="tfree">'ps</span><span class="main">)</span> BEState
                  <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'ePubAct</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'pPubAct</span><span class="main">,</span> <span class="tfree">'ps</span><span class="main">)</span> BEState"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">envVal</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'ePubAct</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'pPubAct</span><span class="main">,</span> <span class="tfree">'ps</span><span class="main">)</span> BEState <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">envObs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'ePubAct</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'pPubAct</span><span class="main">,</span> <span class="tfree">'ps</span><span class="main">)</span> BEState
                <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'cobs</span> <span class="main">×</span> <span class="tfree">'ps</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'ePubAct</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'pPubAct</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="main">+</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">envObsC</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'es</span> <span class="main">⇒</span> <span class="tfree">'cobs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">envActionES</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'es</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'ePubAct</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'pPubAct</span><span class="main">)</span><span class="main">)</span>
                            <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'ePubAct</span> <span class="main">×</span> <span class="tfree">'ePrivAct</span><span class="main">)</span> list"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">envTransES</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'ePubAct</span> <span class="main">×</span> <span class="tfree">'ePrivAct</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'pPubAct</span><span class="main">)</span>
                    <span class="main">⇒</span> <span class="tfree">'es</span> <span class="main">⇒</span> <span class="tfree">'es</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> envObs_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">envObs</span> <span class="free">a</span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="free">envObsC</span> <span class="main">(</span>es <span class="bound">s</span><span class="main">)</span><span class="main">,</span> ps <span class="bound">s</span> <span class="free">a</span><span class="main">,</span> pubActs <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> envAction_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">envAction</span> <span class="free">s</span> <span class="main">≡</span> <span class="free">envActionES</span> <span class="main">(</span>es <span class="free">s</span><span class="main">)</span> <span class="main">(</span>pubActs <span class="free">s</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> envTrans_def<span class="main">:</span>
           <span class="quoted"><span class="quoted">"<span class="free">envTrans</span> <span class="free">eact</span> <span class="free">aact</span> <span class="free">s</span> <span class="main">≡</span> <span class="main">⦇</span> es <span class="main">=</span> <span class="free">envTransES</span> <span class="free">eact</span> <span class="main">(</span>fst <span class="main">∘</span> <span class="free">aact</span><span class="main">)</span> <span class="main">(</span>es <span class="free">s</span><span class="main">)</span>
                                    <span class="main">,</span> ps <span class="main">=</span> snd <span class="main">∘</span> <span class="free">aact</span>
                                    <span class="main">,</span> pubActs <span class="main">=</span> <span class="main">(</span>fst <span class="free">eact</span><span class="main">,</span> fst <span class="main">∘</span> <span class="free">aact</span><span class="main">)</span> <span class="main">⦈</span>"</span></span>
<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹
  \end{isabellebody}%
  \caption{Finite broadcast environments with non-deterministic KBPs.}
  \label{fig:kbps-theory-broadcast-envs}
\end{figure}
›</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">instance</span></span> BEState_ext <span class="main">::</span> <span class="main">(</span><span class="quoted">finite</span><span class="main">,</span> <span class="quoted">finite</span><span class="main">,</span> <span class="quoted">finite</span><span class="main">,</span> <span class="quoted">finite</span><span class="main">,</span> <span class="quoted">finite</span><span class="main">,</span> <span class="quoted">finite</span><span class="main">)</span> <span class="quoted">finite</span>
<span class="keyword1"><span class="command">proof</span></span>
 <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?U</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"UNIV <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">,</span> <span class="tfree">'e</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> BEState_ext set"</span></span>
 <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">,</span> <span class="tfree">'e</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> BEState_scheme"</span></span>
   <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span> <span class="bound">d</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">=</span> BEState_ext <span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span> <span class="bound">d</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span> <span class="operator">simp</span>
 <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> U<span class="main">:</span>
   <span class="quoted"><span class="quoted">"<span class="var">?U</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span><span class="main">,</span> <span class="bound">d</span><span class="main">)</span><span class="main">.</span> BEState_ext <span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span> <span class="bound">d</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>UNIV <span class="main">×</span> UNIV<span class="main">)</span> <span class="main">×</span> UNIV<span class="main">)</span> <span class="main">×</span> UNIV<span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_def<span class="main">)</span>
 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?U</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> U<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

\label{sec:kbps-theory-spr-non-deterministic-protocols}

For completeness we reproduce the results of \citet{Ron:1996}
regarding non-deterministic KBPs in broadcast environments.

The determinism requirement is replaced by the constraint that actions
be split into public and private components, where the private part
influences the agents' private states, and the public part is
broadcast and recorded in the system state. Moreover the protocol of
the environment is only a function of the environment state, and not
the agents' private states. Once again an agent's view consists of the
common observation and their private state. The situation is described
by the locale in Figure~\ref{fig:kbps-theory-broadcast-envs}. Note
that as we do not intend to generate code for this case, we adopt more
transparent but less effective representations.

Our goal in the following is to instantiate the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>
<span class="quoted"><span class="quoted">"SimIncrEnvironment"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> locale with respect to the assumptions made in
the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"FiniteBroadcastEnvironment"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> locale. We begin by defining
similar simulation machinery to the previous section.

›</span></span>

<span class="keyword1"><span class="command">context</span></span> FiniteBroadcastEnvironment
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

As for the deterministic variant, we abstract traces using the common
observation. Note that this now includes the public part of the
agents' actions.

›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">tObsC</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'ePubAct</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'pPubAct</span><span class="main">,</span> <span class="tfree">'ps</span><span class="main">)</span> BEState Trace
         <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'cobs</span> <span class="main">×</span> <span class="tfree">'ePubAct</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'pPubAct</span><span class="main">)</span><span class="main">)</span> Trace"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">tObsC</span> <span class="main">≡</span> tMap <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="free">envObsC</span> <span class="main">(</span>es <span class="bound">s</span><span class="main">)</span><span class="main">,</span> pubActs <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1" id="SPRViewNonDet-spr_jview_tObsC"><span class="command">lemma</span></span> spr_jview_tObsC<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"spr_jview <span class="free">a</span> <span class="free">t</span> <span class="main">=</span> spr_jview <span class="free">a</span> <span class="free">t'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"tObsC <span class="free">t</span> <span class="main">=</span> tObsC <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> SPR.sync<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> assms<span class="main">]</span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trace_induct2<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> envObs_def tObsC_def<span class="main">)</span>

<span class="keyword1" id="SPRViewNonDet-tObsC_tLength"><span class="command">lemma</span></span> tObsC_tLength<span class="main">:</span>
  <span class="quoted"><span class="quoted">"tObsC <span class="free">t</span> <span class="main">=</span> tObsC <span class="free">t'</span> <span class="main">⟹</span> tLength <span class="free">t</span> <span class="main">=</span> tLength <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> tObsC_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> tMap_eq_imp_tLength_eq<span class="main">)</span>

<span class="keyword1" id="SPRViewNonDet-tObsC_tStep_eq_inv"><span class="command">lemma</span></span> tObsC_tStep_eq_inv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"tObsC <span class="free">t'</span> <span class="main">=</span> tObsC <span class="main">(</span><span class="free">t</span> <span class="main">↝</span> <span class="free">s</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">t''</span> <span class="bound">s'</span><span class="main">.</span> <span class="free">t'</span> <span class="main">=</span> <span class="bound">t''</span> <span class="main">↝</span> <span class="bound">s'</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> tObsC_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="SPRViewNonDet-tObsC_prefix_closed"><span class="command">lemma</span></span> tObsC_prefix_closed<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"tObsC <span class="main">(</span><span class="free">t</span> <span class="main">↝</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> tObsC <span class="main">(</span><span class="free">t'</span> <span class="main">↝</span> <span class="free">s'</span><span class="main">)</span> <span class="main">⟹</span> tObsC <span class="free">t</span> <span class="main">=</span> tObsC <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> tObsC_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="SPRViewNonDet-tObsC_tLast"><span class="command">lemma</span></span> tObsC_tLast<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"tLast <span class="main">(</span>tObsC <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">envObsC</span> <span class="main">(</span>es <span class="main">(</span>tLast <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> pubActs <span class="main">(</span>tLast <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> tObsC_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="SPRViewNonDet-tObsC_tStep"><span class="command">lemma</span></span> tObsC_tStep<span class="main">:</span>
  <span class="quoted"><span class="quoted">"tObsC <span class="main">(</span><span class="free">t</span> <span class="main">↝</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> tObsC <span class="free">t</span> <span class="main">↝</span> <span class="main">(</span><span class="free">envObsC</span> <span class="main">(</span>es <span class="free">s</span><span class="main">)</span><span class="main">,</span> pubActs <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> tObsC_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="SPRViewNonDet-tObsC_initial"><span class="command">lemma</span></span> tObsC_initial<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"tFirst <span class="main">(</span>tObsC <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">envObsC</span> <span class="main">(</span>es <span class="main">(</span>tFirst <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> pubActs <span class="main">(</span>tFirst <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"tObsC <span class="main">(</span>tInit <span class="free">s</span><span class="main">)</span> <span class="main">=</span> tInit <span class="main">(</span><span class="free">envObsC</span> <span class="main">(</span>es <span class="free">s</span><span class="main">)</span><span class="main">,</span> pubActs <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"tObsC <span class="free">t</span> <span class="main">=</span> tInit <span class="free">cobs</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">s</span><span class="main">.</span> <span class="free">t</span> <span class="main">=</span> tInit <span class="bound">s</span> <span class="main">∧</span> <span class="free">envObsC</span> <span class="main">(</span>es <span class="bound">s</span><span class="main">)</span> <span class="main">=</span> fst <span class="free">cobs</span> <span class="main">∧</span> pubActs <span class="bound">s</span> <span class="main">=</span> snd <span class="free">cobs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> tObsC_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="SPRViewNonDet-spr_tObsC_trc_aux"><span class="command">lemma</span></span> spr_tObsC_trc_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">t</span><span class="main">,</span> <span class="free">t'</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">a</span><span class="main">.</span> relations SPR.MC <span class="bound">a</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"tObsC <span class="free">t</span> <span class="main">=</span> tObsC <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spr_jview_tObsC<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

Similarly we introduce common and agent-specific abstraction functions:

›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">tObsC_abs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'ePubAct</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'pPubAct</span><span class="main">,</span> <span class="tfree">'ps</span><span class="main">)</span> BEState Trace
             <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'ePubAct</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'pPubAct</span><span class="main">,</span> <span class="tfree">'ps</span><span class="main">)</span> BEState Relation"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">tObsC_abs</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> <span class="main">{</span> <span class="main">(</span>tFirst <span class="bound">t'</span><span class="main">,</span> tLast <span class="bound">t'</span><span class="main">)</span>
                   <span class="main">|</span><span class="bound">t'</span><span class="main">.</span> <span class="bound">t'</span> <span class="main">∈</span> SPR.jkbpC <span class="main">∧</span> tObsC <span class="bound">t'</span> <span class="main">=</span> tObsC <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">agent_abs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'ePubAct</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'pPubAct</span><span class="main">,</span> <span class="tfree">'ps</span><span class="main">)</span> BEState Trace
             <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'ePubAct</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'pPubAct</span><span class="main">,</span> <span class="tfree">'ps</span><span class="main">)</span> BEState Relation"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">agent_abs</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> <span class="main">{</span> <span class="main">(</span>tFirst <span class="bound">t'</span><span class="main">,</span> tLast <span class="bound">t'</span><span class="main">)</span>
                     <span class="main">|</span><span class="bound">t'</span><span class="main">.</span> <span class="bound">t'</span> <span class="main">∈</span> SPR.jkbpC <span class="main">∧</span> spr_jview <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">t'</span> <span class="main">=</span> spr_jview <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">}</span>"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1" id="SPRViewNonDet-tObsC_abs_jview_eq"><span class="command">lemma</span></span> tObsC_abs_jview_eq<span class="main">[</span><span class="operator">dest</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"spr_jview <span class="free">a</span> <span class="free">t'</span> <span class="main">=</span> spr_jview <span class="free">a</span> <span class="free">t</span>
    <span class="main">⟹</span> tObsC_abs <span class="free">t</span> <span class="main">=</span> tObsC_abs <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> tObsC_abs_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> spr_jview_tObsC<span class="main">)</span>

<span class="keyword1" id="SPRViewNonDet-tObsC_absI"><span class="command">lemma</span></span> tObsC_absI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">t'</span> <span class="main">∈</span> SPR.jkbpC<span class="main">;</span> tObsC <span class="free">t'</span> <span class="main">=</span> tObsC <span class="free">t</span><span class="main">;</span> <span class="free">u</span> <span class="main">=</span> tFirst <span class="free">t'</span><span class="main">;</span> <span class="free">v</span> <span class="main">=</span> tLast <span class="free">t'</span> <span class="main">⟧</span>
    <span class="main">⟹</span> <span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">∈</span> tObsC_abs <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> tObsC_abs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="SPRViewNonDet-tObsC_abs_conv"><span class="command">lemma</span></span> tObsC_abs_conv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">∈</span> tObsC_abs <span class="free">t</span>
    <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="bound">t'</span> <span class="main">∈</span> SPR.jkbpC <span class="main">∧</span> tObsC <span class="bound">t'</span> <span class="main">=</span> tObsC <span class="free">t</span> <span class="main">∧</span> <span class="free">u</span> <span class="main">=</span> tFirst <span class="bound">t'</span> <span class="main">∧</span> <span class="free">v</span> <span class="main">=</span> tLast <span class="bound">t'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> tObsC_abs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="SPRViewNonDet-agent_absI"><span class="command">lemma</span></span> agent_absI<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">t'</span> <span class="main">∈</span> SPR.jkbpC<span class="main">;</span> spr_jview <span class="free">a</span> <span class="free">t'</span> <span class="main">=</span> spr_jview <span class="free">a</span> <span class="free">t</span><span class="main">;</span> <span class="free">u</span> <span class="main">=</span> tFirst <span class="free">t'</span><span class="main">;</span> <span class="free">v</span> <span class="main">=</span> tLast <span class="free">t'</span> <span class="main">⟧</span>
    <span class="main">⟹</span> <span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">∈</span> agent_abs <span class="free">a</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> agent_abs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="SPRViewNonDet-agent_abs_tLastD"><span class="command">lemma</span></span> agent_abs_tLastD<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">∈</span> agent_abs <span class="free">a</span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">envObs</span> <span class="free">a</span> <span class="free">v</span> <span class="main">=</span> <span class="free">envObs</span> <span class="free">a</span> <span class="main">(</span>tLast <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> agent_abs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="SPRViewNonDet-agent_abs_inv"><span class="command">lemma</span></span> agent_abs_inv<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">∈</span> agent_abs <span class="free">a</span> <span class="free">t</span>
    <span class="main">⟹</span> <span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="bound">t'</span> <span class="main">∈</span> SPR.jkbpC <span class="main">∧</span> spr_jview <span class="free">a</span> <span class="bound">t'</span> <span class="main">=</span> spr_jview <span class="free">a</span> <span class="free">t</span>
           <span class="main">∧</span> <span class="free">u</span> <span class="main">=</span> tFirst <span class="bound">t'</span> <span class="main">∧</span> <span class="free">v</span> <span class="main">=</span> tLast <span class="bound">t'</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> agent_abs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="comment1">(*&gt;*)</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context FiniteBroadcastEnvironment *)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The simulation is identical to that in the previous section:

›</span></span>

<span class="keyword1"><span class="command">record</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'ePubAct</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'pPubAct</span><span class="main">,</span> <span class="tfree">'ps</span><span class="main">)</span> SPRstate <span class="main">=</span>
  sprFst <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'ePubAct</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'pPubAct</span><span class="main">,</span> <span class="tfree">'ps</span><span class="main">)</span> BEState"</span></span>
  sprLst <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'ePubAct</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'pPubAct</span><span class="main">,</span> <span class="tfree">'ps</span><span class="main">)</span> BEState"</span></span>
  sprCRel <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'ePubAct</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'pPubAct</span><span class="main">,</span> <span class="tfree">'ps</span><span class="main">)</span> BEState Relation"</span></span>

<span class="keyword1"><span class="command">context</span></span> FiniteBroadcastEnvironment
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">spr_sim</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'ePubAct</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'pPubAct</span><span class="main">,</span> <span class="tfree">'ps</span><span class="main">)</span> BEState Trace
           <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'ePubAct</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'pPubAct</span><span class="main">,</span> <span class="tfree">'ps</span><span class="main">)</span> SPRstate"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">spr_sim</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">⦇</span> sprFst <span class="main">=</span> tFirst <span class="bound">t</span><span class="main">,</span> sprLst <span class="main">=</span> tLast <span class="bound">t</span><span class="main">,</span> sprCRel <span class="main">=</span> tObsC_abs <span class="bound">t</span> <span class="main">⦈</span>"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1" id="SPRViewNonDet-spr_sim_tFirst_tLast"><span class="command">lemma</span></span> spr_sim_tFirst_tLast<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> spr_sim <span class="free">t</span> <span class="main">=</span> <span class="free">s</span><span class="main">;</span> <span class="free">t</span> <span class="main">∈</span> SPR.jkbpC <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span>sprFst <span class="free">s</span><span class="main">,</span> sprLst <span class="free">s</span><span class="main">)</span> <span class="main">∈</span> sprCRel <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> spr_sim_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The Kripke structure over simulated traces is also the same:

›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">spr_simRels</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'ePubAct</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'pPubAct</span><span class="main">,</span> <span class="tfree">'ps</span><span class="main">)</span> SPRstate Relation"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">spr_simRels</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">{</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">|</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span>
                         <span class="free">envObs</span> <span class="bound">a</span> <span class="main">(</span>sprFst <span class="bound">s</span><span class="main">)</span> <span class="main">=</span> <span class="free">envObs</span> <span class="bound">a</span> <span class="main">(</span>sprFst <span class="bound">s'</span><span class="main">)</span>
                       <span class="main">∧</span> <span class="free">envObs</span> <span class="bound">a</span> <span class="main">(</span>sprLst <span class="bound">s</span><span class="main">)</span> <span class="main">=</span> <span class="free">envObs</span> <span class="bound">a</span> <span class="main">(</span>sprLst <span class="bound">s'</span><span class="main">)</span>
                       <span class="main">∧</span> sprCRel <span class="bound">s</span> <span class="main">=</span> sprCRel <span class="bound">s'</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">spr_simVal</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'ePubAct</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'pPubAct</span><span class="main">,</span> <span class="tfree">'ps</span><span class="main">)</span> SPRstate <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">spr_simVal</span> <span class="main">≡</span> <span class="free">envVal</span> <span class="main">∘</span> sprLst"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">spr_simMC</span> <span class="main">≡</span> mkKripke <span class="main">(</span>spr_sim <span class="main">`</span> SPR.jkbpC<span class="main">)</span> spr_simRels spr_simVal"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1" id="SPRViewNonDet-spr_simVal_def2"><span class="command">lemma</span></span> spr_simVal_def2<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"spr_simVal <span class="main">(</span>spr_sim <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">envVal</span> <span class="main">(</span>tLast <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> spr_sim_def spr_simVal_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>


<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

As usual, showing that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"spr_sim"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is in fact a simulation is
routine for all properties except for reverse simulation. For that we
use proof techniques similar to those of
\citet{DBLP:journals/tocl/LomuscioMR00}: the goal is to show that,
given <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">t</span></span> <span class="main"><span class="main">∈</span></span> <span class="free"><span class="free">jkbpC</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, we can construct a trace <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">t'</span></span> <span class="main"><span class="main">∈</span></span>
<span class="free"><span class="free">jkbpC</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> indistinguishable from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">t</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> by agent <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">a</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, based
on the public actions, the common observation and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">a</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>'s
private and initial states.

To do this we define a splicing operation:

›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">sSplice</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span>
           <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'ePubAct</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'pPubAct</span><span class="main">,</span> <span class="tfree">'ps</span><span class="main">)</span> BEState
           <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'ePubAct</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'pPubAct</span><span class="main">,</span> <span class="tfree">'ps</span><span class="main">)</span> BEState
           <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'ePubAct</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'pPubAct</span><span class="main">,</span> <span class="tfree">'ps</span><span class="main">)</span> BEState"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sSplice</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">⦇</span> ps <span class="main">:=</span> <span class="main">(</span>ps <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">:=</span> ps <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">⦈</span>"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1" id="SPRViewNonDet-sSplice_es"><span class="command">lemma</span></span> sSplice_es<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"es <span class="main">(</span>sSplice <span class="free">a</span> <span class="free">s</span> <span class="free">s'</span><span class="main">)</span> <span class="main">=</span> es <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sSplice_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="SPRViewNonDet-sSplice_pubActs"><span class="command">lemma</span></span> sSplice_pubActs<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"pubActs <span class="main">(</span>sSplice <span class="free">a</span> <span class="free">s</span> <span class="free">s'</span><span class="main">)</span> <span class="main">=</span> pubActs <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sSplice_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="SPRViewNonDet-sSplice_envObs"><span class="command">lemma</span></span> sSplice_envObs<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> init<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">envObs</span> <span class="free">a</span> <span class="free">s</span> <span class="main">=</span> <span class="free">envObs</span> <span class="free">a</span> <span class="free">s'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sSplice <span class="free">a</span> <span class="free">s</span> <span class="free">s'</span> <span class="main">=</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> init <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ps <span class="free">s</span> <span class="free">a</span> <span class="main">=</span> ps <span class="free">s'</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> envObs_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> sSplice_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_upd_idem_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SPRViewNonDet-sSplice_envObs_a"><span class="command">lemma</span></span> sSplice_envObs_a<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">envObsC</span> <span class="main">(</span>es <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="free">envObsC</span> <span class="main">(</span>es <span class="free">s'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"pubActs <span class="free">s</span> <span class="main">=</span> pubActs <span class="free">s'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">envObs</span> <span class="free">a</span> <span class="main">(</span>sSplice <span class="free">a</span> <span class="free">s</span> <span class="free">s'</span><span class="main">)</span> <span class="main">=</span> <span class="free">envObs</span> <span class="free">a</span> <span class="free">s'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">unfolding</span></span> sSplice_def envObs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="SPRViewNonDet-sSplice_envObs_not_a"><span class="command">lemma</span></span> sSplice_envObs_not_a<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a'</span> <span class="main">≠</span> <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">envObs</span> <span class="free">a'</span> <span class="main">(</span>sSplice <span class="free">a</span> <span class="free">s</span> <span class="free">s'</span><span class="main">)</span> <span class="main">=</span> <span class="free">envObs</span> <span class="free">a'</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">unfolding</span></span> sSplice_def envObs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The effect of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"sSplice <span class="free"><span class="free">a</span></span> <span class="free"><span class="free">s</span></span> <span class="free"><span class="free">s'</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is to update <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">s</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> with
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">a</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>'s private state in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">s'</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. The key properties are
that provided the common observation on <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">s</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">s'</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
are the same, then agent <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">a</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>'s observation on <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"sSplice
<span class="free"><span class="free">a</span></span> <span class="free"><span class="free">s</span></span> <span class="free"><span class="free">s'</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is the same as
 at <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">s'</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, while everyone else's is the
same as at <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">s</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

We hoist this operation pointwise to traces:

›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">tSplice</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'ePubAct</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'pPubAct</span><span class="main">,</span> <span class="tfree">'ps</span><span class="main">)</span> BEState Trace
            <span class="main">⇒</span> <span class="tfree">'a</span>
            <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'ePubAct</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'pPubAct</span><span class="main">,</span> <span class="tfree">'ps</span><span class="main">)</span> BEState Trace
            <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'ePubAct</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'pPubAct</span><span class="main">,</span> <span class="tfree">'ps</span><span class="main">)</span> BEState Trace"</span></span>
      <span class="main">(</span><span class="quoted">"_ <span class="keyword1">⇘⇙⨝⇘</span>_<span class="keyword1">⇙</span> _"</span> <span class="main">[</span>55<span class="main">,</span> 1000<span class="main">,</span> 56<span class="main">]</span> 55<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="hidden">⇘</span><sub></sub><span class="hidden">⇙</span>⨝<span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">a</span></span></span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main">≡</span> tZip <span class="main">(</span>sSplice <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span>"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1"><span class="command">declare</span></span> sSplice_envObs_a<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> sSplice_envObs_not_a<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1" id="SPRViewNonDet-tSplice_tObsC"><span class="command">lemma</span></span> tSplice_tObsC<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tObsC<span class="main">:</span> <span class="quoted"><span class="quoted">"tObsC <span class="free">t</span> <span class="main">=</span> tObsC <span class="free">t'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"tObsC <span class="main">(</span><span class="free">t</span> <span class="hidden">⇘</span><sub></sub><span class="hidden">⇙</span>⨝<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="free">t'</span><span class="main">)</span> <span class="main">=</span> tObsC <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> tObsC_tLength<span class="main">[</span><span class="operator">OF</span> tObsC<span class="main">]</span> tObsC
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trace_induct2<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tObsC_tStep<span class="main">)</span>

<span class="keyword1" id="SPRViewNonDet-tSplice_spr_jview_a"><span class="command">lemma</span></span> tSplice_spr_jview_a<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tObsC<span class="main">:</span> <span class="quoted"><span class="quoted">"tObsC <span class="free">t</span> <span class="main">=</span> tObsC <span class="free">t'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"spr_jview <span class="free">a</span> <span class="main">(</span><span class="free">t</span> <span class="hidden">⇘</span><sub></sub><span class="hidden">⇙</span>⨝<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="free">t'</span><span class="main">)</span> <span class="main">=</span> spr_jview <span class="free">a</span> <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> tObsC_tLength<span class="main">[</span><span class="operator">OF</span> tObsC<span class="main">]</span> tObsC
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trace_induct2<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tObsC_tStep spr_jview_def<span class="main">)</span>

<span class="keyword1" id="SPRViewNonDet-tSplice_spr_jview_not_a"><span class="command">lemma</span></span> tSplice_spr_jview_not_a<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tObsC<span class="main">:</span> <span class="quoted"><span class="quoted">"tObsC <span class="free">t</span> <span class="main">=</span> tObsC <span class="free">t'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> aa'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="free">a'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"spr_jview <span class="free">a'</span> <span class="main">(</span><span class="free">t</span> <span class="hidden">⇘</span><sub></sub><span class="hidden">⇙</span>⨝<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="free">t'</span><span class="main">)</span> <span class="main">=</span> spr_jview <span class="free">a'</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> tObsC_tLength<span class="main">[</span><span class="operator">OF</span> tObsC<span class="main">]</span> tObsC aa'
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trace_induct2<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tObsC_tStep spr_jview_def<span class="main">)</span>

<span class="keyword1" id="SPRViewNonDet-tSplice_es"><span class="command">lemma</span></span> tSplice_es<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tLen<span class="main">:</span> <span class="quoted"><span class="quoted">"tLength <span class="free">t</span> <span class="main">=</span> tLength <span class="free">t'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"es <span class="main">(</span>tLast <span class="main">(</span><span class="free">t</span> <span class="hidden">⇘</span><sub></sub><span class="hidden">⇙</span>⨝<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="free">t'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> es <span class="main">(</span>tLast <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> tLen <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trace_induct2<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="SPRViewNonDet-tSplice_pubActs"><span class="command">lemma</span></span> tSplice_pubActs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tLen<span class="main">:</span> <span class="quoted"><span class="quoted">"tLength <span class="free">t</span> <span class="main">=</span> tLength <span class="free">t'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pubActs <span class="main">(</span>tLast <span class="main">(</span><span class="free">t</span> <span class="hidden">⇘</span><sub></sub><span class="hidden">⇙</span>⨝<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="free">t'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> pubActs <span class="main">(</span>tLast <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> tLen <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trace_induct2<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="SPRViewNonDet-tSplice_envAction"><span class="command">lemma</span></span> tSplice_envAction<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tLen<span class="main">:</span> <span class="quoted"><span class="quoted">"tLength <span class="free">t</span> <span class="main">=</span> tLength <span class="free">t'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">envAction</span> <span class="main">(</span>tLast <span class="main">(</span><span class="free">t</span> <span class="hidden">⇘</span><sub></sub><span class="hidden">⇙</span>⨝<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="free">t'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">envAction</span> <span class="main">(</span>tLast <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> envAction_def
  <span class="keyword1"><span class="command">using</span></span> tSplice_es<span class="main">[</span><span class="operator">OF</span> tLen<span class="main">]</span> tSplice_pubActs<span class="main">[</span><span class="operator">OF</span> tLen<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="SPRViewNonDet-tSplice_tFirst"><span class="command">lemma</span></span> tSplice_tFirst<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tLen<span class="main">:</span> <span class="quoted"><span class="quoted">"tLength <span class="free">t</span> <span class="main">=</span> tLength <span class="free">t'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> init<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">envObs</span> <span class="free">a</span> <span class="main">(</span>tFirst <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">envObs</span> <span class="free">a</span> <span class="main">(</span>tFirst <span class="free">t'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"tFirst <span class="main">(</span><span class="free">t</span> <span class="hidden">⇘</span><sub></sub><span class="hidden">⇙</span>⨝<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="free">t'</span><span class="main">)</span> <span class="main">=</span> tFirst <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> tLen init <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trace_induct2<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="SPRViewNonDet-tSplice_tLast"><span class="command">lemma</span></span> tSplice_tLast<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tLen<span class="main">:</span> <span class="quoted"><span class="quoted">"tLength <span class="free">t</span> <span class="main">=</span> tLength <span class="free">t'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> last<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">envObs</span> <span class="free">a</span> <span class="main">(</span>tLast <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">envObs</span> <span class="free">a</span> <span class="main">(</span>tLast <span class="free">t'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"tLast <span class="main">(</span><span class="free">t</span> <span class="hidden">⇘</span><sub></sub><span class="hidden">⇙</span>⨝<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="free">t'</span><span class="main">)</span> <span class="main">=</span> tLast <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> tLen last
  <span class="keyword1"><span class="command">unfolding</span></span> envObs_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trace_induct2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> sSplice_def fun_upd_idem_iff<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The key properties are that after splicing, if <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">t</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="free">t'</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> have the same common observation, then so does <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">t</span></span> <span class="hidden">⇘</span><sub></sub><span class="hidden">⇙</span>⨝<span class="hidden">⇘</span><sub><span class="free"><span class="free">a</span></span></sub><span class="hidden">⇙</span>
<span class="free"><span class="free">t'</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, and for all agents <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">a'</span></span> <span class="main"><span class="main">≠</span></span> <span class="free"><span class="free">a</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, the view <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">a'</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> has
of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">t</span></span> <span class="hidden">⇘</span><sub></sub><span class="hidden">⇙</span>⨝<span class="hidden">⇘</span><sub><span class="free"><span class="free">a</span></span></sub><span class="hidden">⇙</span> <span class="free"><span class="free">t'</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is the same as it has of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">t</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, while for
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">a</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> it is the same as <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">t'</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

We can conclude that provided the two traces are initially
indistinguishable to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">a</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, and not commonly distinguishable,
then <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">t</span></span> <span class="hidden">⇘</span><sub></sub><span class="hidden">⇙</span>⨝<span class="hidden">⇘</span><sub><span class="free"><span class="free">a</span></span></sub><span class="hidden">⇙</span> <span class="free"><span class="free">t'</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is a canonical trace:

›</span></span>

<span class="keyword1" id="SPRViewNonDet-tSplice_jkbpC"><span class="command">lemma</span></span> tSplice_jkbpC<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tt'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">t</span><span class="main">,</span> <span class="free">t'</span><span class="main">}</span> <span class="main">⊆</span> SPR.jkbpC"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> init<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">envObs</span> <span class="free">a</span> <span class="main">(</span>tFirst <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">envObs</span> <span class="free">a</span> <span class="main">(</span>tFirst <span class="free">t'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tObsC<span class="main">:</span> <span class="quoted"><span class="quoted">"tObsC <span class="free">t</span> <span class="main">=</span> tObsC <span class="free">t'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="hidden">⇘</span><sub></sub><span class="hidden">⇙</span>⨝<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="free">t'</span> <span class="main">∈</span> SPR.jkbpC"</span></span>
<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">using</span></span> tObsC_tLength<span class="main">[</span><span class="operator">OF</span> tObsC<span class="main">]</span> tt' init tObsC
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trace_induct2<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tInit <span class="skolem">s</span> <span class="skolem">s'</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tStep <span class="skolem">s</span> <span class="skolem">s'</span> <span class="skolem">t</span> <span class="skolem">t'</span><span class="main">)</span>

  <span class="keyword1"><span class="command">hence</span></span> tt'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="hidden">⇘</span><sub></sub><span class="hidden">⇙</span>⨝<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="skolem">t'</span> <span class="main">∈</span> SPR.jkbpC"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> tLen<span class="main">:</span> <span class="quoted"><span class="quoted">"tLength <span class="skolem">t'</span> <span class="main">=</span> tLength <span class="skolem">t</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> tObsC<span class="main">:</span> <span class="quoted"><span class="quoted">"tObsC <span class="main">(</span><span class="skolem">t</span> <span class="main">↝</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span> tObsC <span class="main">(</span><span class="skolem">t'</span> <span class="main">↝</span> <span class="skolem">s'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">hence</span></span> tt'n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="hidden">⇘</span><sub></sub><span class="hidden">⇙</span>⨝<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="skolem">t'</span> <span class="main">∈</span> SPR.jkbpCn <span class="main">(</span>tLength <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> tStep
  <span class="keyword1"><span class="command">have</span></span> ts<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">↝</span> <span class="skolem">s</span> <span class="main">∈</span> SPR.jkbpCn <span class="main">(</span>Suc <span class="main">(</span>tLength <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> t's'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">↝</span> <span class="skolem">s'</span> <span class="main">∈</span> SPR.jkbpCn <span class="main">(</span>Suc <span class="main">(</span>tLength <span class="skolem">t'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="main">(</span><span class="operator">rule</span> SPR.jkbpC_tLength_inv<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">from</span></span> ts <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">eact</span></span> <span class="skolem"><span class="skolem">aact</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> eact<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">eact</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">envAction</span> <span class="main">(</span>tLast <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> aact<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span><span class="main">.</span> <span class="skolem">aact</span> <span class="bound">a</span> <span class="main">∈</span> set <span class="main">(</span>jAction <span class="main">(</span>SPR.mkM <span class="main">(</span>SPR.jkbpCn <span class="main">(</span>tLength <span class="skolem">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">envTrans</span> <span class="skolem">eact</span> <span class="skolem">aact</span> <span class="main">(</span>tLast <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">from</span></span> t's' <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">eact'</span></span> <span class="skolem"><span class="skolem">aact'</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> eact'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">eact'</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">envAction</span> <span class="main">(</span>tLast <span class="skolem">t'</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> aact'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span><span class="main">.</span> <span class="skolem">aact'</span> <span class="bound">a</span> <span class="main">∈</span> set <span class="main">(</span>jAction <span class="main">(</span>SPR.mkM <span class="main">(</span>SPR.jkbpCn <span class="main">(</span>tLength <span class="skolem">t'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t'</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> trans'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">envTrans</span> <span class="skolem">eact'</span> <span class="skolem">aact'</span> <span class="main">(</span>tLast <span class="skolem">t'</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">s'</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">aact''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">aact''</span> <span class="main">=</span> <span class="skolem">aact</span> <span class="main">(</span><span class="free">a</span> <span class="main">:=</span> <span class="skolem">aact'</span> <span class="free">a</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">from</span></span> tObsC trans trans'
  <span class="keyword1"><span class="command">have</span></span> aact''_fst<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">∘</span> <span class="skolem">aact''</span> <span class="main">=</span> fst <span class="main">∘</span> <span class="skolem">aact</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> envTrans_def aact''_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> tObsC_tStep<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> o_eq_elim<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">from</span></span> tObsC trans trans'
  <span class="keyword1"><span class="command">have</span></span> aact''_snd<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">∘</span> <span class="skolem">aact''</span> <span class="main">=</span> <span class="main">(</span>snd <span class="main">∘</span> <span class="skolem">aact</span><span class="main">)</span><span class="main">(</span><span class="free">a</span> <span class="main">:=</span> ps <span class="skolem">s'</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> envTrans_def aact''_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">envTrans</span> <span class="skolem">eact</span> <span class="skolem">aact''</span> <span class="main">(</span>tLast <span class="main">(</span><span class="skolem">t</span> <span class="hidden">⇘</span><sub></sub><span class="hidden">⇙</span>⨝<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="skolem">t'</span><span class="main">)</span><span class="main">)</span>
      <span class="main">=</span> sSplice <span class="free">a</span> <span class="main">(</span><span class="free">envTrans</span> <span class="skolem">eact</span> <span class="skolem">aact</span> <span class="main">(</span>tLast <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s'</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> envTrans_def sSplice_def<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> tSplice_es<span class="main">[</span><span class="operator">OF</span> tLen<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span> aact''_fst aact''_snd
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">moreover</span></span>

  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a'</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">aact''</span> <span class="skolem">a'</span> <span class="main">∈</span> set <span class="main">(</span>jAction <span class="main">(</span>SPR.mkM <span class="main">(</span>SPR.jkbpCn <span class="main">(</span>tLength <span class="skolem">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">t</span> <span class="hidden">⇘</span><sub></sub><span class="hidden">⇙</span>⨝<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="skolem">t'</span><span class="main">)</span> <span class="skolem">a'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">a'</span> <span class="main">=</span> <span class="free">a</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> tStep <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"jAction <span class="main">(</span>SPR.mkM <span class="main">(</span>SPR.jkbpCn <span class="main">(</span>tLength <span class="skolem">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">t</span> <span class="hidden">⇘</span><sub></sub><span class="hidden">⇙</span>⨝<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="skolem">t'</span><span class="main">)</span> <span class="skolem">a'</span>
                     <span class="main">=</span> jAction <span class="main">(</span>SPR.mkM <span class="main">(</span>SPR.jkbpCn <span class="main">(</span>tLength <span class="skolem">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t</span> <span class="skolem">a'</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> S5n_jAction_eq<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">unfolding</span></span> SPR.mkM_def
        <span class="keyword1"><span class="command">using</span></span> tSplice_spr_jview_not_a tt'
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">with</span></span> False aact <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> aact''_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">with</span></span> tStep <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"jAction <span class="main">(</span>SPR.mkM <span class="main">(</span>SPR.jkbpCn <span class="main">(</span>tLength <span class="skolem">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">t</span> <span class="hidden">⇘</span><sub></sub><span class="hidden">⇙</span>⨝<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="skolem">t'</span><span class="main">)</span> <span class="free">a</span>
                     <span class="main">=</span> jAction <span class="main">(</span>SPR.mkM <span class="main">(</span>SPR.jkbpCn <span class="main">(</span>tLength <span class="skolem">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t'</span> <span class="free">a</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> S5n_jAction_eq<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">unfolding</span></span> SPR.mkM_def
        <span class="keyword1"><span class="command">using</span></span> tSplice_spr_jview_a tt'
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">with</span></span> True aact' tLen <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> aact''_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="keyword1"><span class="command">}</span></span>

  <span class="keyword1"><span class="command">moreover</span></span>

  <span class="keyword1"><span class="command">from</span></span> tStep <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">envAction</span> <span class="main">(</span>tLast <span class="main">(</span><span class="skolem">t</span> <span class="hidden">⇘</span><sub></sub><span class="hidden">⇙</span>⨝<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="skolem">t'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">envAction</span> <span class="main">(</span>tLast <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> tSplice_envAction <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> eact trans tt'n

  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span> <span class="hidden">⇘</span><sub></sub><span class="hidden">⇙</span>⨝<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="skolem">t'</span><span class="main">)</span> <span class="main">↝</span> sSplice <span class="free">a</span> <span class="skolem">s</span> <span class="skolem">s'</span> <span class="main">∈</span> SPR.jkbpCn <span class="main">(</span>Suc <span class="main">(</span>tLength <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> split_paired_Ex<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">eact</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">aact''</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> tZip.simps<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SPRViewNonDet-spr_sim_r"><span class="command">lemma</span></span> spr_sim_r<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sim_r SPR.MC spr_simMC spr_sim"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> sim_rI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">p</span> <span class="skolem">q'</span>
  <span class="keyword3"><span class="command">assume</span></span> pT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> worlds SPR.MC"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> fpq'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>spr_sim <span class="skolem">p</span><span class="main">,</span> <span class="skolem">q'</span><span class="main">)</span> <span class="main">∈</span> relations spr_simMC <span class="skolem">a</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> fpq' <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">uq</span></span> <span class="skolem"><span class="skolem">fq</span></span> <span class="skolem"><span class="skolem">vq</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> q'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span> <span class="main">=</span> <span class="main">⦇</span> sprFst <span class="main">=</span> <span class="skolem">uq</span><span class="main">,</span> sprLst <span class="main">=</span> <span class="skolem">vq</span><span class="main">,</span> sprCRel <span class="main">=</span> tObsC_abs <span class="skolem">p</span> <span class="main">⦈</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> uq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">envObs</span> <span class="skolem">a</span> <span class="main">(</span>tFirst <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> <span class="free">envObs</span> <span class="skolem">a</span> <span class="skolem">uq</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> vq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">envObs</span> <span class="skolem">a</span> <span class="main">(</span>tLast <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> <span class="free">envObs</span> <span class="skolem">a</span> <span class="skolem">vq</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mkKripke_def spr_sim_def spr_simRels_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

  <span class="keyword1"><span class="command">from</span></span> fpq' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span> <span class="main">∈</span> worlds spr_simMC"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> q' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">uq</span><span class="main">,</span> <span class="skolem">vq</span><span class="main">)</span> <span class="main">∈</span> tObsC_abs <span class="skolem">p</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> spr_sim_tFirst_tLast<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> s<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">q'</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> tT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> SPR.jkbpC"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> tp<span class="main">:</span> <span class="quoted"><span class="quoted">"tObsC <span class="skolem">t</span> <span class="main">=</span> tObsC <span class="skolem">p</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> tuq<span class="main">:</span> <span class="quoted"><span class="quoted">"tFirst <span class="skolem">t</span> <span class="main">=</span> <span class="skolem">uq</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> tvq<span class="main">:</span> <span class="quoted"><span class="quoted">"tLast <span class="skolem">t</span> <span class="main">=</span> <span class="skolem">vq</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> tObsC_abs_conv<span class="main">)</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> <span class="skolem">t</span> <span class="hidden">⇘</span><sub></sub><span class="hidden">⇙</span>⨝<span class="hidden">⇘</span><sub><span class="skolem">a</span></sub><span class="hidden">⇙</span> <span class="skolem">p</span>"</span></span>

  <span class="keyword1"><span class="command">from</span></span> tp tuq uq
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"spr_jview <span class="skolem">a</span> <span class="skolem">p</span> <span class="main">=</span> spr_jview <span class="skolem">a</span> <span class="skolem">q</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> q_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tSplice_spr_jview_a<span class="main">)</span>

  <span class="keyword1"><span class="command">with</span></span> pT tT tp tuq uq
  <span class="keyword1"><span class="command">have</span></span> pt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">∈</span> relations SPR.MC <span class="skolem">a</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> SPR.mkM_def q_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tSplice_jkbpC<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> q' uq vq tp tuq tvq
  <span class="keyword1"><span class="command">have</span></span> ftq'<span class="main">:</span> <span class="quoted"><span class="quoted">"spr_sim <span class="skolem">q</span> <span class="main">=</span> <span class="skolem">q'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> spr_sim_def q_def
    <span class="keyword1"><span class="command">using</span></span> tSplice_tObsC<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> t<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> t'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">p</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> tObsC_tLength<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> tObsC_abs_def <span class="comment1">(* FIXME abstract *)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">from</span></span> pt ftq'
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span> <span class="main">∈</span> relations SPR.MC <span class="skolem">a</span> <span class="main">∧</span> spr_sim <span class="bound">q</span> <span class="main">=</span> <span class="skolem">q'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The proof is by induction over <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">t</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">t'</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, and
depends crucially on the public actions being recorded in the state
and commonly observed. Showing the reverse simulation property is then
straightforward.

›</span></span>

<span class="keyword1" id="SPRViewNonDet-spr_sim"><span class="command">lemma</span></span> spr_sim<span class="main">:</span> <span class="quoted"><span class="quoted">"sim SPR.MC spr_simMC spr_sim"</span></span>
<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sim_range SPR.MC spr_simMC spr_sim"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sim_rangeI<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spr_sim_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sim_val SPR.MC spr_simMC spr_sim"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sim_valI<span class="main">)</span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sim_f SPR.MC spr_simMC spr_sim"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> spr_simRels_def spr_sim_def mkKripke_def SPR.mkM_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sim_fI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> split_paired_Ex<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sim_r SPR.MC spr_simMC spr_sim"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> spr_sim_r<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context FiniteBroadcastEnvironment *)</span>

<span class="keyword1"><span class="command">sublocale</span></span> FiniteBroadcastEnvironment
        <span class="main">&lt;</span> SPR<span class="main">:</span> SimIncrEnvironment <span class="quoted"><span class="free">jkbp</span></span> <span class="quoted"><span class="free">envInit</span></span> <span class="quoted"><span class="free">envAction</span></span> <span class="quoted"><span class="free">envTrans</span></span> <span class="quoted"><span class="free">envVal</span></span>
                                       <span class="quoted">spr_jview</span> <span class="quoted"><span class="free">envObs</span></span> <span class="quoted">spr_jviewInit</span> <span class="quoted">spr_jviewIncr</span>
                                       <span class="quoted">spr_sim</span> <span class="quoted">spr_simRels</span> <span class="quoted">spr_simVal</span>
<span class="comment1">(*&lt;*)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spr_sim<span class="main">)</span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The algorithmic representations and machinery of the deterministic
JKBP case suffice for this one too, and so we omit the details.

\FloatBarrier

›</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="SPRViewNonDetIndInit">
<div class="head">
<h1>Theory SPRViewNonDetIndInit</h1>
</div>
<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="comment1">(*
 * Knowledge-based programs.
 * (C)opyright 2011, Peter Gammie, peteg42 at gmail.com.
 * License: BSD
 *)</span>

<span class="keyword1"><span class="command">theory</span></span> SPRViewNonDetIndInit
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="#SPRView">SPRView</a>
  <a href="#KBPsAuto">KBPsAuto</a>
  <a href="#SPRViewNonDet">SPRViewNonDet</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Perfect Recall in Independently-Initialised Non-deterministic Broadcast Environments›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

\label{sec:kbps-theory-spr-non-deterministic-protocols-ind-init}

If the private and environment parts of the initial states are
independent we can simplify the construction of the previous section
and consider only sets of states rather than relations. This greatly
reduces the state space that the algorithm traverses.

We capture this independence by adding some assumptions to the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>
<span class="quoted"><span class="quoted">"FiniteBroadcastEnvironment"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> locale of
Figure~\ref{fig:kbps-theory-broadcast-envs}; the result is the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="free">FiniteBroadcastEnvironmentIndependentInit</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> locale shown in
Figure~\ref{fig:kbps-theory-broadcast-envs-ind-init}. We ask that the
initial states be the Cartesian product of possible private and
environment states; in other words there is nothing for the agents to
learn about correlations amongst the initial states. As there are
initially no public actions from the previous round, we use the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>
<span class="quoted"><span class="quoted">"default"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> class to indicate that there is a fixed but arbitrary
choice to be made here.

Again we introduce common and agent-specific abstraction functions:


›</span></span>

<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹
\begin{figure}[ht]
\begin{isabellebody}%
›</span></span>
<span class="keyword1"><span class="command">locale</span></span> FiniteBroadcastEnvironmentIndependentInit <span class="main">=</span>
  FiniteBroadcastEnvironment <span class="quoted"><span class="free">jkbp</span></span> <span class="quoted"><span class="free">envInit</span></span> <span class="quoted"><span class="free">envAction</span></span> <span class="quoted"><span class="free">envTrans</span></span> <span class="quoted"><span class="free">envVal</span></span> <span class="quoted"><span class="free">envObs</span></span>
                             <span class="quoted"><span class="free">envObsC</span></span> <span class="quoted"><span class="free">envActionES</span></span> <span class="quoted"><span class="free">envTransES</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">jkbp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>finite<span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="main">(</span><span class="tfree">'pPubAct</span><span class="main">::</span><span class="main">{</span>default<span class="main">,</span>finite<span class="main">}</span> <span class="main">×</span> <span class="tfree">'ps</span><span class="main">::</span>finite<span class="main">)</span><span class="main">)</span> JKBP"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">envInit</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'ePubAct</span> <span class="main">::</span> <span class="main">{</span>default<span class="main">,</span> finite<span class="main">}</span><span class="main">,</span> <span class="tfree">'es</span> <span class="main">::</span> finite<span class="main">,</span>
                     <span class="tfree">'pPubAct</span><span class="main">,</span> <span class="tfree">'ps</span><span class="main">)</span> BEState list"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">envAction</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'ePubAct</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'pPubAct</span><span class="main">,</span> <span class="tfree">'ps</span><span class="main">)</span> BEState
                   <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'ePubAct</span> <span class="main">×</span> <span class="tfree">'ePrivAct</span><span class="main">)</span> list"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">envTrans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'ePubAct</span> <span class="main">×</span> <span class="tfree">'ePrivAct</span><span class="main">)</span>
                  <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'pPubAct</span> <span class="main">×</span> <span class="tfree">'ps</span><span class="main">)</span><span class="main">)</span>
                  <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'ePubAct</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'pPubAct</span><span class="main">,</span> <span class="tfree">'ps</span><span class="main">)</span> BEState
                  <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'ePubAct</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'pPubAct</span><span class="main">,</span> <span class="tfree">'ps</span><span class="main">)</span> BEState"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">envVal</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'ePubAct</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'pPubAct</span><span class="main">,</span> <span class="tfree">'ps</span><span class="main">)</span> BEState <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">envObs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'ePubAct</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'pPubAct</span><span class="main">,</span> <span class="tfree">'ps</span><span class="main">)</span> BEState
                <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'cobs</span> <span class="main">×</span> <span class="tfree">'ps</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'ePubAct</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'pPubAct</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">envObsC</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'es</span> <span class="main">⇒</span> <span class="tfree">'cobs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">envActionES</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'es</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'ePubAct</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'pPubAct</span><span class="main">)</span><span class="main">)</span>
                            <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'ePubAct</span> <span class="main">×</span> <span class="tfree">'ePrivAct</span><span class="main">)</span> list"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">envTransES</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'ePubAct</span> <span class="main">×</span> <span class="tfree">'ePrivAct</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'pPubAct</span><span class="main">)</span>
                    <span class="main">⇒</span> <span class="tfree">'es</span> <span class="main">⇒</span> <span class="tfree">'es</span>"</span></span>

<span class="main">+</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">agents</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">envInitBits</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'es</span> list <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'ps</span> list<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> envInit_def<span class="main">:</span>
     <span class="quoted"><span class="quoted">"<span class="free">envInit</span> <span class="main">≡</span> <span class="main">[</span> <span class="main">⦇</span> es <span class="main">=</span> <span class="bound">esf</span><span class="main">,</span> ps <span class="main">=</span> <span class="bound">psf</span><span class="main">,</span> pubActs <span class="main">=</span> <span class="main">(</span>default<span class="main">,</span> <span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> default<span class="main">)</span> <span class="main">⦈</span>
                 <span class="main">.</span> psf <span class="main">←</span> listToFuns <span class="main">(</span>snd <span class="free">envInitBits</span><span class="main">)</span> <span class="free">agents</span>
                 <span class="main">,</span> esf <span class="main">←</span> fst <span class="free">envInitBits</span> <span class="main">]</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> agents<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">agents</span> <span class="main">=</span> UNIV"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">agents</span>"</span></span>

<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹
  \end{isabellebody}%
  \caption{Finite broadcast environments with non-deterministic
  KBPs, where the initial private and environment states are
  independent.}
  \label{fig:kbps-theory-broadcast-envs-ind-init}
\end{figure}
›</span></span>

<span class="keyword1"><span class="command">context</span></span> FiniteBroadcastEnvironmentIndependentInit
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">tObsC_ii_abs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'ePubAct</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'pPubAct</span><span class="main">,</span> <span class="tfree">'ps</span><span class="main">)</span> BEState Trace
             <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'ePubAct</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'pPubAct</span><span class="main">,</span> <span class="tfree">'ps</span><span class="main">)</span> BEState set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">tObsC_ii_abs</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span>
  <span class="main">{</span> tLast <span class="bound">t'</span> <span class="main">|</span><span class="bound">t'</span><span class="main">.</span> <span class="bound">t'</span> <span class="main">∈</span> SPR.jkbpC <span class="main">∧</span> tObsC <span class="bound">t'</span> <span class="main">=</span> tObsC <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">agent_ii_abs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'ePubAct</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'pPubAct</span><span class="main">,</span> <span class="tfree">'ps</span><span class="main">)</span> BEState Trace
             <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'ePubAct</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'pPubAct</span><span class="main">,</span> <span class="tfree">'ps</span><span class="main">)</span> BEState set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">agent_ii_abs</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span>
  <span class="main">{</span> tLast <span class="bound">t'</span> <span class="main">|</span><span class="bound">t'</span><span class="main">.</span> <span class="bound">t'</span> <span class="main">∈</span> SPR.jkbpC <span class="main">∧</span> spr_jview <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">t'</span> <span class="main">=</span> spr_jview <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">}</span>"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1" id="SPRViewNonDetIndInit-tObsC_ii_abs_jview_eq"><span class="command">lemma</span></span> tObsC_ii_abs_jview_eq<span class="main">[</span><span class="operator">dest</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"spr_jview <span class="free">a</span> <span class="free">t'</span> <span class="main">=</span> spr_jview <span class="free">a</span> <span class="free">t</span>
    <span class="main">⟹</span> tObsC_ii_abs <span class="free">t</span> <span class="main">=</span> tObsC_ii_abs <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> tObsC_ii_abs_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> spr_jview_tObsC<span class="main">)</span>

<span class="keyword1" id="SPRViewNonDetIndInit-tObsC_ii_absI"><span class="command">lemma</span></span> tObsC_ii_absI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">t'</span> <span class="main">∈</span> SPR.jkbpC<span class="main">;</span> tObsC <span class="free">t'</span> <span class="main">=</span> tObsC <span class="free">t</span><span class="main">;</span> <span class="free">v</span> <span class="main">=</span> tLast <span class="free">t'</span> <span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">v</span> <span class="main">∈</span> tObsC_ii_abs <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> tObsC_ii_abs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="SPRViewNonDetIndInit-tObsC_ii_abs_conv"><span class="command">lemma</span></span> tObsC_ii_abs_conv<span class="main">:</span>
  <span class="quoted"><span class="quoted">" <span class="free">v</span> <span class="main">∈</span> tObsC_ii_abs <span class="free">t</span>
    <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="bound">t'</span> <span class="main">∈</span> SPR.jkbpC <span class="main">∧</span> tObsC <span class="bound">t'</span> <span class="main">=</span> tObsC <span class="free">t</span> <span class="main">∧</span> <span class="free">v</span> <span class="main">=</span> tLast <span class="bound">t'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> tObsC_ii_abs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="SPRViewNonDetIndInit-agent_ii_absI"><span class="command">lemma</span></span> agent_ii_absI<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">t'</span> <span class="main">∈</span> SPR.jkbpC<span class="main">;</span> spr_jview <span class="free">a</span> <span class="free">t'</span> <span class="main">=</span> spr_jview <span class="free">a</span> <span class="free">t</span><span class="main">;</span> <span class="free">v</span> <span class="main">=</span> tLast <span class="free">t'</span> <span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">v</span> <span class="main">∈</span> agent_ii_abs <span class="free">a</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> agent_ii_abs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="SPRViewNonDetIndInit-agent_ii_abs_tLastD"><span class="command">lemma</span></span> agent_ii_abs_tLastD<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> agent_ii_abs <span class="free">a</span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">envObs</span> <span class="free">a</span> <span class="free">v</span> <span class="main">=</span> <span class="free">envObs</span> <span class="free">a</span> <span class="main">(</span>tLast <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> agent_ii_abs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="SPRViewNonDetIndInit-agent_ii_abs_inv"><span class="command">lemma</span></span> agent_ii_abs_inv<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> agent_ii_abs <span class="free">a</span> <span class="free">t</span>
    <span class="main">⟹</span> <span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="bound">t'</span> <span class="main">∈</span> SPR.jkbpC <span class="main">∧</span> spr_jview <span class="free">a</span> <span class="bound">t'</span> <span class="main">=</span> spr_jview <span class="free">a</span> <span class="free">t</span>
           <span class="main">∧</span> <span class="free">v</span> <span class="main">=</span> tLast <span class="bound">t'</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> agent_ii_abs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The simulation is similar to the single-agent case
(\S\ref{sec:kbps-spr-single-agent}); for a given canonical trace
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">t</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> it pairs the set of worlds that any agent considers
possible with the final state of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">t</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>:

›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> -<span class="main">)</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'ePubAct</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'pPubAct</span><span class="main">,</span> <span class="tfree">'ps</span><span class="main">)</span> SPRstate <span class="main">=</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'ePubAct</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'pPubAct</span><span class="main">,</span> <span class="tfree">'ps</span><span class="main">)</span> BEState set
 <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'ePubAct</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'pPubAct</span><span class="main">,</span> <span class="tfree">'ps</span><span class="main">)</span> BEState"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">spr_ii_sim</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'ePubAct</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'pPubAct</span><span class="main">,</span> <span class="tfree">'ps</span><span class="main">)</span> BEState Trace
           <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'ePubAct</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'pPubAct</span><span class="main">,</span> <span class="tfree">'ps</span><span class="main">)</span> SPRstate"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">spr_ii_sim</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span>tObsC_ii_abs <span class="bound">t</span><span class="main">,</span> tLast <span class="bound">t</span><span class="main">)</span>"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1" id="SPRViewNonDetIndInit-spr_ii_sim_tFirst_tLast"><span class="command">lemma</span></span> spr_ii_sim_tFirst_tLast<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> spr_ii_sim <span class="free">t</span> <span class="main">=</span> <span class="free">s</span><span class="main">;</span> <span class="free">t</span> <span class="main">∈</span> SPR.jkbpC <span class="main">⟧</span> <span class="main">⟹</span> snd <span class="free">s</span> <span class="main">∈</span> fst <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> spr_ii_sim_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The Kripke structure over simulated traces is also quite similar:

›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">spr_ii_simRels</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'ePubAct</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'pPubAct</span><span class="main">,</span> <span class="tfree">'ps</span><span class="main">)</span> SPRstate Relation"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">spr_ii_simRels</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">a</span><span class="main">.</span>
  <span class="main">{</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">|</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="free">envObs</span> <span class="bound">a</span> <span class="main">(</span>snd <span class="bound">s</span><span class="main">)</span> <span class="main">=</span> <span class="free">envObs</span> <span class="bound">a</span> <span class="main">(</span>snd <span class="bound">s'</span><span class="main">)</span> <span class="main">∧</span> fst <span class="bound">s</span> <span class="main">=</span> fst <span class="bound">s'</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">spr_ii_simVal</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'ePubAct</span><span class="main">,</span> <span class="tfree">'es</span><span class="main">,</span> <span class="tfree">'pPubAct</span><span class="main">,</span> <span class="tfree">'ps</span><span class="main">)</span> SPRstate <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">spr_ii_simVal</span> <span class="main">≡</span> <span class="free">envVal</span> <span class="main">∘</span> snd"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">spr_ii_simMC</span> <span class="main">≡</span> mkKripke <span class="main">(</span>spr_ii_sim <span class="main">`</span> SPR.jkbpC<span class="main">)</span> spr_ii_simRels spr_ii_simVal"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1" id="SPRViewNonDetIndInit-spr_ii_simVal_def2"><span class="command">lemma</span></span> spr_ii_simVal_def2<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"spr_ii_simVal <span class="main">(</span>spr_ii_sim <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">envVal</span> <span class="main">(</span>tLast <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> spr_ii_sim_def spr_ii_simVal_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="comment1">(* Same as for SPRViewNonDet but different base case. *)</span>

<span class="keyword1" id="SPRViewNonDetIndInit-tSplice_jkbpC"><span class="command">lemma</span></span> tSplice_jkbpC<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tt'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">t</span><span class="main">,</span> <span class="free">t'</span><span class="main">}</span> <span class="main">⊆</span> SPR.jkbpC"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tObsC<span class="main">:</span> <span class="quoted"><span class="quoted">"tObsC <span class="free">t</span> <span class="main">=</span> tObsC <span class="free">t'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="hidden">⇘</span><sub></sub><span class="hidden">⇙</span>⨝<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="free">t'</span> <span class="main">∈</span> SPR.jkbpC"</span></span>
<span class="keyword1"><span class="command">using</span></span> tObsC_tLength<span class="main">[</span><span class="operator">OF</span> tObsC<span class="main">]</span> tt' tObsC
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trace_induct2<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tInit <span class="skolem">s</span> <span class="skolem">s'</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command">unfolding</span></span> envInit_def sSplice_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">x</span><span class="main">(</span><span class="free">a</span> <span class="main">:=</span> <span class="improper">xa</span> <span class="free">a</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> bexI<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> listToFun_splice<span class="main">[</span><span class="operator">OF</span> agents<span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tStep <span class="skolem">s</span> <span class="skolem">s'</span> <span class="skolem">t</span> <span class="skolem">t'</span><span class="main">)</span>

  <span class="keyword1"><span class="command">hence</span></span> tt'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="hidden">⇘</span><sub></sub><span class="hidden">⇙</span>⨝<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="skolem">t'</span> <span class="main">∈</span> SPR.jkbpC"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> tLen<span class="main">:</span> <span class="quoted"><span class="quoted">"tLength <span class="skolem">t'</span> <span class="main">=</span> tLength <span class="skolem">t</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> tObsC<span class="main">:</span> <span class="quoted"><span class="quoted">"tObsC <span class="main">(</span><span class="skolem">t</span> <span class="main">↝</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span> tObsC <span class="main">(</span><span class="skolem">t'</span> <span class="main">↝</span> <span class="skolem">s'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">hence</span></span> tt'n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="hidden">⇘</span><sub></sub><span class="hidden">⇙</span>⨝<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="skolem">t'</span> <span class="main">∈</span> SPR.jkbpCn <span class="main">(</span>tLength <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> tStep
  <span class="keyword1"><span class="command">have</span></span> ts<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">↝</span> <span class="skolem">s</span> <span class="main">∈</span> SPR.jkbpCn <span class="main">(</span>Suc <span class="main">(</span>tLength <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> t's'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">↝</span> <span class="skolem">s'</span> <span class="main">∈</span> SPR.jkbpCn <span class="main">(</span>Suc <span class="main">(</span>tLength <span class="skolem">t'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="main">(</span><span class="operator">rule</span> SPR.jkbpC_tLength_inv<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">from</span></span> ts <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">eact</span></span> <span class="skolem"><span class="skolem">aact</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> eact<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">eact</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">envAction</span> <span class="main">(</span>tLast <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> aact<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span><span class="main">.</span> <span class="skolem">aact</span> <span class="bound">a</span> <span class="main">∈</span> set <span class="main">(</span>jAction <span class="main">(</span>SPR.mkM <span class="main">(</span>SPR.jkbpCn <span class="main">(</span>tLength <span class="skolem">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">envTrans</span> <span class="skolem">eact</span> <span class="skolem">aact</span> <span class="main">(</span>tLast <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">from</span></span> t's' <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">eact'</span></span> <span class="skolem"><span class="skolem">aact'</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> eact'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">eact'</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">envAction</span> <span class="main">(</span>tLast <span class="skolem">t'</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> aact'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span><span class="main">.</span> <span class="skolem">aact'</span> <span class="bound">a</span> <span class="main">∈</span> set <span class="main">(</span>jAction <span class="main">(</span>SPR.mkM <span class="main">(</span>SPR.jkbpCn <span class="main">(</span>tLength <span class="skolem">t'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t'</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> trans'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">envTrans</span> <span class="skolem">eact'</span> <span class="skolem">aact'</span> <span class="main">(</span>tLast <span class="skolem">t'</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">s'</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">aact''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">aact''</span> <span class="main">=</span> <span class="skolem">aact</span> <span class="main">(</span><span class="free">a</span> <span class="main">:=</span> <span class="skolem">aact'</span> <span class="free">a</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">from</span></span> tObsC trans trans'
  <span class="keyword1"><span class="command">have</span></span> aact''_fst<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">∘</span> <span class="skolem">aact''</span> <span class="main">=</span> fst <span class="main">∘</span> <span class="skolem">aact</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> envTrans_def aact''_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> tObsC_tStep<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> o_eq_elim<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">from</span></span> tObsC trans trans'
  <span class="keyword1"><span class="command">have</span></span> aact''_snd<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">∘</span> <span class="skolem">aact''</span> <span class="main">=</span> <span class="main">(</span>snd <span class="main">∘</span> <span class="skolem">aact</span><span class="main">)</span><span class="main">(</span><span class="free">a</span> <span class="main">:=</span> ps <span class="skolem">s'</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> envTrans_def aact''_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">envTrans</span> <span class="skolem">eact</span> <span class="skolem">aact''</span> <span class="main">(</span>tLast <span class="main">(</span><span class="skolem">t</span> <span class="hidden">⇘</span><sub></sub><span class="hidden">⇙</span>⨝<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="skolem">t'</span><span class="main">)</span><span class="main">)</span>
      <span class="main">=</span> sSplice <span class="free">a</span> <span class="main">(</span><span class="free">envTrans</span> <span class="skolem">eact</span> <span class="skolem">aact</span> <span class="main">(</span>tLast <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s'</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> envTrans_def sSplice_def<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> tSplice_es<span class="main">[</span><span class="operator">OF</span> tLen<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span> aact''_fst aact''_snd
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">moreover</span></span>

  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a'</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">aact''</span> <span class="skolem">a'</span> <span class="main">∈</span> set <span class="main">(</span>jAction <span class="main">(</span>SPR.mkM <span class="main">(</span>SPR.jkbpCn <span class="main">(</span>tLength <span class="skolem">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">t</span> <span class="hidden">⇘</span><sub></sub><span class="hidden">⇙</span>⨝<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="skolem">t'</span><span class="main">)</span> <span class="skolem">a'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">a'</span> <span class="main">=</span> <span class="free">a</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> tStep <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"jAction <span class="main">(</span>SPR.mkM <span class="main">(</span>SPR.jkbpCn <span class="main">(</span>tLength <span class="skolem">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">t</span> <span class="hidden">⇘</span><sub></sub><span class="hidden">⇙</span>⨝<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="skolem">t'</span><span class="main">)</span> <span class="skolem">a'</span>
                     <span class="main">=</span> jAction <span class="main">(</span>SPR.mkM <span class="main">(</span>SPR.jkbpCn <span class="main">(</span>tLength <span class="skolem">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t</span> <span class="skolem">a'</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> S5n_jAction_eq<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">unfolding</span></span> SPR.mkM_def
        <span class="keyword1"><span class="command">using</span></span> tSplice_spr_jview_not_a tt'
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">with</span></span> False aact <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> aact''_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">with</span></span> tStep <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"jAction <span class="main">(</span>SPR.mkM <span class="main">(</span>SPR.jkbpCn <span class="main">(</span>tLength <span class="skolem">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">t</span> <span class="hidden">⇘</span><sub></sub><span class="hidden">⇙</span>⨝<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="skolem">t'</span><span class="main">)</span> <span class="free">a</span>
                     <span class="main">=</span> jAction <span class="main">(</span>SPR.mkM <span class="main">(</span>SPR.jkbpCn <span class="main">(</span>tLength <span class="skolem">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t'</span> <span class="free">a</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> S5n_jAction_eq<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">unfolding</span></span> SPR.mkM_def
        <span class="keyword1"><span class="command">using</span></span> tSplice_spr_jview_a tt'
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">with</span></span> True aact' tLen <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> aact''_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="keyword1"><span class="command">}</span></span>

  <span class="keyword1"><span class="command">moreover</span></span>

  <span class="keyword1"><span class="command">from</span></span> tStep <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">envAction</span> <span class="main">(</span>tLast <span class="main">(</span><span class="skolem">t</span> <span class="hidden">⇘</span><sub></sub><span class="hidden">⇙</span>⨝<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="skolem">t'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">envAction</span> <span class="main">(</span>tLast <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> tSplice_envAction <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> eact trans tt'n

  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span> <span class="hidden">⇘</span><sub></sub><span class="hidden">⇙</span>⨝<span class="hidden">⇘</span><sub><span class="free">a</span></sub><span class="hidden">⇙</span> <span class="skolem">t'</span><span class="main">)</span> <span class="main">↝</span> sSplice <span class="free">a</span> <span class="skolem">s</span> <span class="skolem">s'</span> <span class="main">∈</span> SPR.jkbpCn <span class="main">(</span>Suc <span class="main">(</span>tLength <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> split_paired_Ex<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">eact</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">aact''</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> tZip.simps<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SPRViewNonDetIndInit-spr_ii_sim_r"><span class="command">lemma</span></span> spr_ii_sim_r<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sim_r SPR.MC spr_ii_simMC spr_ii_sim"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> sim_rI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">p</span> <span class="skolem">q'</span>
  <span class="keyword3"><span class="command">assume</span></span> pT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> worlds SPR.MC"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> fpq'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>spr_ii_sim <span class="skolem">p</span><span class="main">,</span> <span class="skolem">q'</span><span class="main">)</span> <span class="main">∈</span> relations spr_ii_simMC <span class="skolem">a</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> fpq' <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">vq</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> q'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span> <span class="main">=</span> <span class="main">(</span>tObsC_ii_abs <span class="skolem">p</span><span class="main">,</span> <span class="skolem">vq</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> vq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">envObs</span> <span class="skolem">a</span> <span class="main">(</span>tLast <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> <span class="free">envObs</span> <span class="skolem">a</span> <span class="skolem">vq</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mkKripke_def spr_ii_sim_def spr_ii_simRels_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

  <span class="keyword1"><span class="command">from</span></span> fpq' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span> <span class="main">∈</span> worlds spr_ii_simMC"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> q' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vq</span> <span class="main">∈</span> tObsC_ii_abs <span class="skolem">p</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> spr_ii_sim_tFirst_tLast<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> s<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">q'</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> tT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> SPR.jkbpC"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> tp<span class="main">:</span> <span class="quoted"><span class="quoted">"tObsC <span class="skolem">t</span> <span class="main">=</span> tObsC <span class="skolem">p</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> tvq<span class="main">:</span> <span class="quoted"><span class="quoted">"tLast <span class="skolem">t</span> <span class="main">=</span> <span class="skolem">vq</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> tObsC_ii_abs_conv<span class="main">)</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> <span class="skolem">t</span> <span class="hidden">⇘</span><sub></sub><span class="hidden">⇙</span>⨝<span class="hidden">⇘</span><sub><span class="skolem">a</span></sub><span class="hidden">⇙</span> <span class="skolem">p</span>"</span></span>

  <span class="keyword1"><span class="command">from</span></span> tp
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"spr_jview <span class="skolem">a</span> <span class="skolem">p</span> <span class="main">=</span> spr_jview <span class="skolem">a</span> <span class="skolem">q</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> q_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tSplice_spr_jview_a<span class="main">)</span>

  <span class="keyword1"><span class="command">with</span></span> pT tT tp
  <span class="keyword1"><span class="command">have</span></span> pt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">∈</span> relations SPR.MC <span class="skolem">a</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> SPR.mkM_def q_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tSplice_jkbpC<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> q' vq tp tvq
  <span class="keyword1"><span class="command">have</span></span> ftq'<span class="main">:</span> <span class="quoted"><span class="quoted">"spr_ii_sim <span class="skolem">q</span> <span class="main">=</span> <span class="skolem">q'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> spr_ii_sim_def q_def
    <span class="keyword1"><span class="command">using</span></span> tSplice_tObsC<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> t<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> t'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">p</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> tObsC_tLength<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> tObsC_ii_abs_def <span class="comment1">(* FIXME abstract *)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">from</span></span> pt ftq'
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span> <span class="main">∈</span> relations SPR.MC <span class="skolem">a</span> <span class="main">∧</span> spr_ii_sim <span class="bound">q</span> <span class="main">=</span> <span class="skolem">q'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The proofs that this simulation is adequate are similar to those in
the previous section. We elide the details.

›</span></span>

<span class="keyword1" id="SPRViewNonDetIndInit-spr_ii_sim"><span class="command">lemma</span></span> spr_ii_sim<span class="main">:</span> <span class="quoted"><span class="quoted">"sim SPR.MC spr_ii_simMC spr_ii_sim"</span></span>
<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sim_range SPR.MC spr_ii_simMC spr_ii_sim"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sim_rangeI<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spr_ii_sim_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sim_val SPR.MC spr_ii_simMC spr_ii_sim"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sim_valI<span class="main">)</span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sim_f SPR.MC spr_ii_simMC spr_ii_sim"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> spr_ii_simRels_def spr_ii_sim_def mkKripke_def SPR.mkM_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sim_fI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> split_paired_Ex<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sim_r SPR.MC spr_ii_simMC spr_ii_sim"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> spr_ii_sim_r<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context FiniteBroadcastEnvironment *)</span>

<span class="keyword1"><span class="command">sublocale</span></span> FiniteBroadcastEnvironmentIndependentInit
        <span class="main">&lt;</span> SPRii<span class="main">:</span> SimIncrEnvironment <span class="quoted"><span class="free">jkbp</span></span> <span class="quoted"><span class="free">envInit</span></span> <span class="quoted"><span class="free">envAction</span></span> <span class="quoted"><span class="free">envTrans</span></span> <span class="quoted"><span class="free">envVal</span></span>
                                       <span class="quoted">spr_jview</span> <span class="quoted"><span class="free">envObs</span></span> <span class="quoted">spr_jviewInit</span> <span class="quoted">spr_jviewIncr</span>
                                       <span class="quoted">spr_ii_sim</span> <span class="quoted">spr_ii_simRels</span> <span class="quoted">spr_ii_simVal</span>
<span class="comment1">(*&lt;*)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spr_ii_sim<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="SPRViewSingle">
<div class="head">
<h1>Theory SPRViewSingle</h1>
</div>
<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="comment1">(*
 * Knowledge-based programs.
 * (C)opyright 2011, Peter Gammie, peteg42 at gmail.com.
 * License: BSD
 *)</span>

<span class="keyword1"><span class="command">theory</span></span> SPRViewSingle
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="#KBPsAlg">KBPsAlg</a>
  <a href="#SPRView">SPRView</a>
  <a href="#List_local">List_local</a>
  <a href="#ODList">ODList</a>
  <a href="#Trie2">Trie2</a>
  <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Mapping.html">HOL-Library.Mapping</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Perfect Recall for a Single Agent›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

\label{sec:kbps-spr-single-agent}

We capture our expectations of a single-agent scenario in the
following locale:

›</span></span>

<span class="keyword1"><span class="command">locale</span></span> FiniteSingleAgentEnvironment <span class="main">=</span>
  FiniteEnvironment <span class="quoted"><span class="free">jkbp</span></span> <span class="quoted"><span class="free">envInit</span></span> <span class="quoted"><span class="free">envAction</span></span> <span class="quoted"><span class="free">envTrans</span></span> <span class="quoted"><span class="free">envVal</span></span> <span class="quoted"><span class="free">envObs</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">jkbp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'aAct</span><span class="main">)</span> JKBP"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">envInit</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">::</span> <span class="main">{</span>finite<span class="main">,</span> linorder<span class="main">}</span><span class="main">)</span> list"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">envAction</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'eAct</span> list"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">envTrans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'eAct</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'aAct</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">envVal</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">envObs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'obs</span>"</span></span>
<span class="main">+</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">agent</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> envSingleAgent<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="free">agent</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

As per the clock semantics of \S\ref{sec:kbps-theory-clock-view}, we
assume that the set of states is finite and linearly ordered. We give
the sole agent the name <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>agent›</span></span></span></span>.

Our simulation is quite similar to the one for the clock semantics of
\S\ref{sec:kbps-theory-clock-view}: it records the set of worlds that
the agent considers possible relative to a trace and the SPR view. The
key difference is that it is path-sensitive:

›</span></span>

<span class="keyword1"><span class="command">context</span></span> FiniteSingleAgentEnvironment
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">spr_abs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> Trace <span class="main">⇒</span> <span class="tfree">'s</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">spr_abs</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span>
    tLast <span class="main">`</span> <span class="main">{</span> <span class="bound"><span class="bound">t'</span></span> <span class="main">∈</span> SPR.jkbpC <span class="main">.</span> spr_jview <span class="free">agent</span> <span class="bound">t'</span> <span class="main">=</span> spr_jview <span class="free">agent</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> -<span class="main">)</span> <span class="tfree">'s</span> spr_simWorlds <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> set <span class="main">×</span> <span class="tfree">'s</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">spr_sim</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> Trace <span class="main">⇒</span> <span class="tfree">'s</span> spr_simWorlds"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">spr_sim</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span>spr_abs <span class="bound">t</span><span class="main">,</span> tLast <span class="bound">t</span><span class="main">)</span>"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1" id="SPRViewSingle-spr_absI"><span class="command">lemma</span></span> spr_absI<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">t'</span> <span class="main">∈</span> SPR.jkbpC<span class="main">;</span> spr_jview <span class="free">a</span> <span class="free">t'</span> <span class="main">=</span> spr_jview <span class="free">a</span> <span class="free">t</span><span class="main">;</span> <span class="free">v</span> <span class="main">=</span> tLast <span class="free">t'</span> <span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">v</span> <span class="main">∈</span> spr_abs <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> spr_abs_def
  <span class="keyword1"><span class="command">using</span></span> envSingleAgent<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">a</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="SPRViewSingle-spr_abs_tLastD"><span class="command">lemma</span></span> spr_abs_tLastD<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> spr_abs <span class="free">t</span> <span class="main">⟹</span> <span class="free">envObs</span> <span class="free">a</span> <span class="free">v</span> <span class="main">=</span> <span class="free">envObs</span> <span class="free">a</span> <span class="main">(</span>tLast <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> spr_abs_def
  <span class="keyword1"><span class="command">using</span></span> envSingleAgent<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">a</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="SPRViewSingle-spr_abs_conv"><span class="command">lemma</span></span> spr_abs_conv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> spr_abs <span class="free">t</span>
    <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="bound">t'</span> <span class="main">∈</span> SPR.jkbpC <span class="main">∧</span> spr_jview <span class="free">a</span> <span class="bound">t'</span> <span class="main">=</span> spr_jview <span class="free">a</span> <span class="free">t</span> <span class="main">∧</span> <span class="free">v</span> <span class="main">=</span> tLast <span class="bound">t'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> spr_abs_def
  <span class="keyword1"><span class="command">using</span></span> envSingleAgent<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">a</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="SPRViewSingle-spr_abs_eq"><span class="command">lemma</span></span> spr_abs_eq<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"spr_jview <span class="free">a</span> <span class="free">t</span> <span class="main">=</span> spr_jview <span class="free">a</span> <span class="free">t'</span> <span class="main">⟹</span> spr_abs <span class="free">t</span> <span class="main">=</span> spr_abs <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> spr_abs_def
  <span class="keyword1"><span class="command">using</span></span> envSingleAgent<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">a</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="SPRViewSingle-spr_abs_refl"><span class="command">lemma</span></span> spr_abs_refl<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> SPR.jkbpC <span class="main">⟹</span> tLast <span class="free">t</span> <span class="main">∈</span> spr_abs <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> spr_abs_def
  <span class="keyword1"><span class="command">using</span></span> envSingleAgent<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">a</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="SPRViewSingle-spr_sim_simps"><span class="command">lemma</span></span> spr_sim_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"fst <span class="main">(</span>spr_sim <span class="free">t</span><span class="main">)</span> <span class="main">=</span> spr_abs <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> spr_sim_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The Kripke structure for this simulation relates worlds for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="free">agent</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> if the sets of states it considers possible coincide, and the
observation of the final states of the trace is the same. Propositions
are evaluated at the final state.

›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">spr_simRels</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> spr_simWorlds Relation"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">spr_simRels</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">{</span> <span class="main">(</span><span class="main">(</span><span class="bound">U</span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">V</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span><span class="bound">U</span> <span class="bound">u</span> <span class="bound">V</span> <span class="bound">v</span><span class="main">.</span>
                         <span class="bound">U</span> <span class="main">=</span> <span class="bound">V</span> <span class="main">∧</span> <span class="main">{</span><span class="bound">u</span><span class="main">,</span> <span class="bound">v</span><span class="main">}</span> <span class="main">⊆</span> <span class="bound">U</span> <span class="main">∧</span> <span class="free">envObs</span> <span class="bound">a</span> <span class="bound">u</span> <span class="main">=</span> <span class="free">envObs</span> <span class="bound">a</span> <span class="bound">v</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">spr_simVal</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> spr_simWorlds <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">spr_simVal</span> <span class="main">≡</span> <span class="free">envVal</span> <span class="main">∘</span> snd"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">spr_simMC</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'s</span> spr_simWorlds<span class="main">)</span> KripkeStructure"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">spr_simMC</span> <span class="main">≡</span> mkKripke <span class="main">(</span>spr_sim <span class="main">`</span> SPR.jkbpC<span class="main">)</span> spr_simRels spr_simVal"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1" id="SPRViewSingle-spr_simVal"><span class="command">lemma</span></span> spr_simVal<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"spr_simVal <span class="main">(</span>spr_sim <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">envVal</span> <span class="main">(</span>tLast <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> spr_sim_def spr_simVal_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="SPRViewSingle-spr_sim_r"><span class="command">lemma</span></span> spr_sim_r<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sim_r SPR.MC spr_simMC spr_sim"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">t</span> <span class="skolem">v'</span>
  <span class="keyword3"><span class="command">assume</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> worlds SPR.MC"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> tv'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>spr_sim <span class="skolem">t</span><span class="main">,</span> <span class="skolem">v'</span><span class="main">)</span> <span class="main">∈</span> relations spr_simMC <span class="skolem">a</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> tv' <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> vv'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">=</span> <span class="main">(</span>spr_abs <span class="skolem">t</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> st<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> spr_abs <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> spr_simRels_def spr_sim_def mkKripke_def SPR.mkM_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> st <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> SPR.jkbpC"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"spr_jview <span class="skolem">a</span> <span class="skolem">v</span> <span class="main">=</span> spr_jview <span class="skolem">a</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"tLast <span class="skolem">v</span> <span class="main">=</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="comment1">(*&lt;*)</span><span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> spr_abs_conv<span class="comment1">(*&gt;*)</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> t vv'
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">∈</span> relations SPR.MC <span class="skolem">a</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"spr_sim <span class="skolem">v</span> <span class="main">=</span> <span class="skolem">v'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> spr_simRels_def spr_sim_def mkKripke_def SPR.mkM_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> relations SPR.MC <span class="skolem">a</span> <span class="main">∧</span> spr_sim <span class="bound">v</span> <span class="main">=</span> <span class="skolem">v'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

Demonstrating that this is a simulation
(\S\ref{sec:kripke-theory-simulations}) is straightforward.

›</span></span>

<span class="keyword1" id="SPRViewSingle-spr_sim"><span class="command">lemma</span></span> spr_sim<span class="main">:</span> <span class="quoted"><span class="quoted">"sim SPR.MC spr_simMC spr_sim"</span></span>
<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sim_f SPR.MC spr_simMC spr_sim"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> spr_simRels_def spr_sim_def mkKripke_def SPR.mkM_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sim_r SPR.MC spr_simMC spr_sim"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> spr_sim_r<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹›</span></span>
<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context FiniteSingleAgentEnvironment *)</span>

<span class="keyword1"><span class="command">sublocale</span></span> FiniteSingleAgentEnvironment
        <span class="main">&lt;</span> SPRsingle<span class="main">:</span> SimIncrEnvironment <span class="quoted"><span class="free">jkbp</span></span> <span class="quoted"><span class="free">envInit</span></span> <span class="quoted"><span class="free">envAction</span></span> <span class="quoted"><span class="free">envTrans</span></span> <span class="quoted"><span class="free">envVal</span></span>
                                       <span class="quoted">spr_jview</span> <span class="quoted"><span class="free">envObs</span></span> <span class="quoted">spr_jviewInit</span> <span class="quoted">spr_jviewIncr</span>
                                       <span class="quoted">spr_sim</span> <span class="quoted">spr_simRels</span> <span class="quoted">spr_simVal</span>
<span class="comment1">(*&lt;*)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">rule</span> spr_sim<span class="main">)</span>
<span class="comment1">(*&gt;*)</span>

<span class="comment1">(* **************************************** *)</span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Representations›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

\label{sec:kbps-theory-spr-single-rep}

As in \S\ref{sec:kbps-theory-clock-view-algops}, we quotient <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'s</span></span>
spr_simWorlds"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">spr_simRels</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Because there is only a
single agent, an element of this quotient corresponding to a cononical
trace <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">t</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is isomorphic to the set of states that are possible
given the sequence of observations made by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">agent</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> on <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="free">t</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Therefore we have a very simple representation:

›</span></span>

<span class="keyword1"><span class="command">context</span></span> FiniteSingleAgentEnvironment
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> -<span class="main">)</span> <span class="tfree">'s</span> spr_simWorldsRep <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> odlist"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

It is very easy to map these representations back to simulated
equivalence classes:

›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">spr_simAbs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> spr_simWorldsRep <span class="main">⇒</span> <span class="tfree">'s</span> spr_simWorlds set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">spr_simAbs</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">ss</span><span class="main">.</span> <span class="main">{</span> <span class="main">(</span>toSet <span class="bound">ss</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">|</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> toSet <span class="bound">ss</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

This time our representation is unconditionally canonical:

›</span></span>

<span class="keyword1" id="SPRViewSingle-spr_simAbs_inj"><span class="command">lemma</span></span> spr_simAbs_inj<span class="main">:</span> <span class="quoted"><span class="quoted">"inj spr_simAbs"</span></span>
<span class="comment1">(*&lt;*)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> injI<span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> spr_simAbs_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"toSet <span class="improper">x</span> <span class="main">=</span> toSet <span class="improper">y</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">using</span></span> toSet_inj
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> injD<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="SPRViewSingle-spr_sim_rep_abs"><span class="command">lemma</span></span> spr_sim_rep_abs<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ec<span class="main">:</span> <span class="quoted"><span class="quoted">"spr_simAbs <span class="free">ec</span> <span class="main">=</span> SPRsingle.sim_equiv_class <span class="free">a</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"toSet <span class="free">ec</span> <span class="main">=</span> spr_abs <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"toSet <span class="free">ec</span> <span class="main">⊆</span> spr_abs <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> toSet <span class="free">ec</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>toSet <span class="free">ec</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> spr_simAbs <span class="free">ec</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> spr_simAbs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> ec <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>toSet <span class="free">ec</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> SPRsingle.sim_equiv_class <span class="free">a</span> <span class="free">t</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> x envSingleAgent<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">a</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> spr_abs <span class="free">t</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> spr_sim_def spr_abs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"spr_abs <span class="free">t</span> <span class="main">⊆</span> toSet <span class="free">ec</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> spr_abs <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> ec envSingleAgent<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">a</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> toSet <span class="free">ec</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> spr_simAbs_def spr_sim_def spr_abs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SPRViewSingle-spr_sim_rep_abs_syn"><span class="command">lemma</span></span> spr_sim_rep_abs_syn<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ec<span class="main">:</span> <span class="quoted"><span class="quoted">"spr_simAbs <span class="free">ec</span> <span class="main">=</span> SPRsingle.sim_equiv_class <span class="free">agent</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>toList <span class="free">ec</span><span class="main">)</span> <span class="main">=</span> spr_abs <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> spr_sim_rep_abs<span class="main">[</span><span class="operator">OF</span> ec<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> toSet_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="SPRViewSingle-spr_simAbs_list"><span class="command">lemma</span></span> spr_simAbs_list<span class="main">:</span>
  <span class="quoted"><span class="quoted">"spr_simAbs <span class="main">`</span> fromList <span class="main">`</span> <span class="free">X</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">ss</span><span class="main">.</span> <span class="main">{</span> <span class="main">(</span><span class="bound">ss</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">|</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="bound">ss</span> <span class="main">}</span><span class="main">)</span> <span class="main">`</span> set <span class="main">`</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> spr_simAbs_def Set.image_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

We again make use of the following Kripke structure, where the worlds
are the final states of the subset of the temporal slice that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="free">agent</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> believes possible:

›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">spr_repRels</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">×</span> <span class="tfree">'s</span><span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">spr_repRels</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">{</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span> <span class="free">envObs</span> <span class="bound">a</span> <span class="bound">s'</span> <span class="main">=</span> <span class="free">envObs</span> <span class="bound">a</span> <span class="bound">s</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">spr_repMC</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> KripkeStructure"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">spr_repMC</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">X</span><span class="main">.</span> mkKripke <span class="bound">X</span> spr_repRels <span class="free">envVal</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

Similarly we show that this Kripke structure is adequate by
introducing an intermediate structure and connecting them all with a
tower of simulations:

›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">spr_jkbpCSt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> Trace <span class="main">⇒</span> <span class="tfree">'s</span> spr_simWorlds set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">spr_jkbpCSt</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> SPRsingle.sim_equiv_class <span class="free">agent</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">spr_simMCt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> Trace <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'s</span> spr_simWorlds<span class="main">)</span> KripkeStructure"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">spr_simMCt</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> mkKripke <span class="main">(</span>spr_jkbpCSt <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> spr_simRels spr_simVal"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">spr_repSim</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> spr_simWorlds <span class="main">⇒</span> <span class="tfree">'s</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">spr_repSim</span> <span class="main">≡</span> snd"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1" id="SPRViewSingle-spr_repMC_kripke"><span class="command">lemma</span></span> spr_repMC_kripke<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"kripke <span class="main">(</span>spr_repMC <span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> kripkeI<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1" id="SPRViewSingle-spr_repMC_S5n"><span class="command">lemma</span></span> spr_repMC_S5n<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"S5n <span class="main">(</span>spr_repMC <span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> spr_repRels_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> S5nI equivI refl_onI symI transI<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="SPRViewSingle-jkbpCSt_jkbpCS_subset"><span class="command">lemma</span></span> jkbpCSt_jkbpCS_subset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"SPRsingle.sim_equiv_class <span class="free">agent</span> <span class="free">t</span> <span class="main">⊆</span> spr_sim <span class="main">`</span> SPR.jkbpC"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="SPRViewSingle-spr_simRep_sim_simps"><span class="command">lemma</span></span> spr_simRep_sim_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"spr_repSim <span class="main">`</span> spr_sim <span class="main">`</span> <span class="free">T</span> <span class="main">=</span> tLast <span class="main">`</span> <span class="free">T</span>"</span></span>
  <span class="quoted"><span class="quoted">"spr_repSim <span class="main">(</span>spr_sim <span class="free">t</span><span class="main">)</span> <span class="main">=</span> tLast <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> spr_repSim_def spr_sim_def Set.image_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹›</span></span>

<span class="keyword1" id="SPRViewSingle-spr_repSim"><span class="command">lemma</span></span> spr_repSim<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> SPR.jkbpC"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sim <span class="main">(</span>spr_simMCt <span class="free">t</span><span class="main">)</span>
             <span class="main">(</span><span class="main">(</span>spr_repMC <span class="main">∘</span> fst<span class="main">)</span> <span class="main">(</span>spr_sim <span class="free">t</span><span class="main">)</span><span class="main">)</span>
             spr_repSim"</span></span>
<span class="comment1">(*&lt;*)</span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"sim <span class="var">?M</span> <span class="var">?M'</span> <span class="var">?f</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sim_range <span class="var">?M</span> <span class="var">?M'</span> <span class="var">?f</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"worlds <span class="var">?M'</span> <span class="main">=</span> <span class="var">?f</span> <span class="main">`</span> worlds <span class="var">?M</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> spr_sim_def spr_repSim_def spr_abs_def Set.image_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"relations <span class="var">?M'</span> <span class="skolem">a</span> <span class="main">⊆</span> worlds <span class="var">?M'</span> <span class="main">×</span> worlds <span class="var">?M'</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> spr_sim_def spr_repSim_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sim_val <span class="var">?M</span> <span class="var">?M'</span> <span class="var">?f</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> spr_sim_def spr_simVal_def spr_repSim_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">from</span></span> tC
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sim_f <span class="var">?M</span> <span class="var">?M'</span> <span class="var">?f</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> spr_sim_def spr_simVal_def spr_repSim_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cut_tac</span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> envSingleAgent<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> spr_sim_def spr_repRels_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> spr_tLast<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sim_r <span class="var">?M</span> <span class="var">?M'</span> <span class="var">?f</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> spr_sim_def spr_simVal_def spr_repSim_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cut_tac</span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> envSingleAgent<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> spr_abs_def spr_sim_def spr_repRels_def spr_simRels_def Set.image_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

As before, the following sections discharge the requirements of the
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Algorithm›</span></span></span></span> locale of Figure~\ref{fig:kbps-alg-alg-locale}.

›</span></span>

<span class="comment1">(* **************************************** *)</span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Initial states›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The initial states of the automaton for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">agent</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is simply the
partition of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">envInit</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> under <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">agent</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>'s observation.

›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> -<span class="main">)</span>
  <span class="entity">spr_simInit</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">::</span> linorder<span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'obs</span><span class="main">)</span>
                     <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'obs</span> <span class="main">⇒</span> <span class="tfree">'s</span> spr_simWorldsRep"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">spr_simInit</span> <span class="free"><span class="bound"><span class="entity">envInit</span></span></span> <span class="free"><span class="bound"><span class="entity">envObs</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">a</span> <span class="bound">iobs</span><span class="main">.</span>
    ODList.fromList <span class="main">[</span> <span class="bound">s</span><span class="main">.</span> s <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">envInit</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">envObs</span></span></span> <span class="bound">a</span> <span class="bound">s</span> <span class="main">=</span> <span class="bound">iobs</span> <span class="main">]</span>"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">spr_simInit</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'obs</span> <span class="main">⇒</span> <span class="tfree">'s</span> spr_simWorldsRep"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">spr_simInit</span> <span class="main">≡</span> SPRViewSingle.spr_simInit <span class="free">envInit</span> <span class="free">envObs</span>"</span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹›</span></span>

<span class="keyword1" id="SPRViewSingle-spr_simInit"><span class="command">lemma</span></span> spr_simInit<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">iobs</span> <span class="main">∈</span> <span class="free">envObs</span> <span class="free">a</span> <span class="main">`</span> set <span class="free">envInit</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"spr_simAbs <span class="main">(</span>spr_simInit <span class="free">a</span> <span class="free">iobs</span><span class="main">)</span>
       <span class="main">=</span> spr_sim <span class="main">`</span> <span class="main">{</span> <span class="bound"><span class="bound">t'</span></span> <span class="main">∈</span> SPR.jkbpC<span class="main">.</span> spr_jview <span class="free">a</span> <span class="bound">t'</span> <span class="main">=</span> spr_jviewInit <span class="free">a</span> <span class="free">iobs</span> <span class="main">}</span>"</span></span>
<span class="comment1">(*&lt;*)</span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">unfolding</span></span> spr_simInit_def
  <span class="keyword1"><span class="command">using</span></span> envSingleAgent<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">a</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> spr_simAbs_def spr_sim_def <span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> spr_abs_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> spr_jview_def SPR.jviewInit<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"tInit <span class="improper">s</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> image_eqI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> spr_jview_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"tInit <span class="improper">xa</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> image_eqI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"tInit <span class="improper">xb</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> image_eqI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="comment1">(*&gt;*)</span>

<span class="comment1">(* **************************************** *)</span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Simulated observations›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

As the agent makes the same observation on the entire equivalence
class, we arbitrarily choose the first element of the representation:

›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> -<span class="main">)</span>
  <span class="entity">spr_simObs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'obs</span><span class="main">)</span>
               <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">::</span> linorder<span class="main">)</span> spr_simWorldsRep <span class="main">⇒</span> <span class="tfree">'obs</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">spr_simObs</span> <span class="free"><span class="bound"><span class="entity">envObs</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">envObs</span></span></span> <span class="bound">a</span> <span class="main">∘</span> ODList.hd"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">spr_simObs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> spr_simWorldsRep <span class="main">⇒</span> <span class="tfree">'obs</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">spr_simObs</span> <span class="main">≡</span> SPRViewSingle.spr_simObs <span class="free">envObs</span>"</span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹›</span></span>

<span class="keyword1" id="SPRViewSingle-spr_simObs"><span class="command">lemma</span></span> spr_simObs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> SPR.jkbpC"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ec<span class="main">:</span> <span class="quoted"><span class="quoted">"spr_simAbs <span class="free">ec</span> <span class="main">=</span> SPRsingle.sim_equiv_class <span class="free">a</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"spr_simObs <span class="free">a</span> <span class="free">ec</span> <span class="main">=</span> <span class="free">envObs</span> <span class="free">a</span> <span class="main">(</span>tLast <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="main">∈</span> set <span class="main">(</span>toList <span class="free">ec</span><span class="main">)</span><span class="main">.</span> <span class="free">envObs</span> <span class="free">a</span> <span class="bound">s</span> <span class="main">=</span> <span class="free">envObs</span> <span class="free">a</span> <span class="main">(</span>tLast <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> spr_sim_rep_abs<span class="main">[</span><span class="operator">OF</span> ec<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> toSet_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> tC ec <span class="keyword1"><span class="command">have</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"tLast <span class="free">t</span> <span class="main">∈</span> set <span class="main">(</span>toList <span class="free">ec</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> envSingleAgent<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">a</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> spr_simObs_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_choose_hd<span class="main"><span class="main">[</span></span><span class="operator">OF</span> A B<span class="main"><span class="main">]</span></span> ODList.hd_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="comment1">(* **************************************** *)</span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Evaluation›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

\label{sec:kbps-spr-single-agent-eval}

As the single-agent case is much simpler than the multi-agent ones, we
define an evaluation function specialised to its representation.

Intuitively <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">eval</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> yields the subset of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">X</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> where the
formula holds, where <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">X</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is taken to be a representation of a
canonical equivalence class for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">agent</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> -<span class="main">)</span>
  <span class="entity">eval</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'s</span> <span class="main">::</span> linorder<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> bool<span class="main">)</span>
        <span class="main">⇒</span> <span class="tfree">'s</span> odlist <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">)</span> Kform <span class="main">⇒</span> <span class="tfree">'s</span> odlist"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eval</span> <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">(</span>Kprop <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>      <span class="main">=</span> ODList.filter <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eval</span> <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">(</span>Knot <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>       <span class="main">=</span> ODList.difference <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">(</span><span class="free">eval</span> <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eval</span> <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">(</span>Kand <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>     <span class="main">=</span> ODList.intersect <span class="main">(</span><span class="free">eval</span> <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">eval</span> <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eval</span> <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">(</span>Kknows <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>   <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">eval</span> <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="keyword1">else</span> ODList.empty<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eval</span> <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">(</span>Kcknows <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span>
                     <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∨</span> <span class="free">eval</span> <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="keyword1">else</span> ODList.empty<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

In general this is less efficient than the tableau approach of
\citet[Proposition~3.2.1]{FHMV:1995}, which labels all states with all
formulas. However it is often the case that the set of relevant worlds
is much smaller than the set of all system states.

Showing that this corresponds with the standard models relation is
routine.

›</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1" id="SPRViewSingle-eval_ec_subseteq"><span class="command">lemma</span></span> eval_ec_subseteq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"toSet <span class="main">(</span>eval <span class="free">envVal</span> <span class="free">ec</span> <span class="free">φ</span><span class="main">)</span> <span class="main">⊆</span> toSet <span class="free">ec</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="SPRViewSingle-eval_models_aux"><span class="command">lemma</span></span> eval_models_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ec<span class="main">:</span> <span class="quoted"><span class="quoted">"spr_simAbs <span class="free">ec</span> <span class="main">=</span> SPRsingle.sim_equiv_class <span class="free">agent</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> toSet <span class="free">ec</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> toSet <span class="main">(</span>eval <span class="free">envVal</span> <span class="free">ec</span> <span class="free">φ</span><span class="main">)</span> <span class="main">⟷</span> spr_repMC <span class="main">(</span>toSet <span class="free">ec</span><span class="main">)</span><span class="main">,</span> <span class="free">s</span> <span class="main">⊨</span> <span class="free">φ</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> s
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Kknows <span class="skolem">a</span> <span class="skolem">φ</span> <span class="skolem">s</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> ec envSingleAgent<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">a</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> spr_repRels_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inj_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> toSet_inj<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> eval_ec_subseteq<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Kcknows <span class="skolem">as</span> <span class="skolem">φ</span> <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> ec <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">as</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">with</span></span> Kcknows <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">as</span> <span class="main">=</span> <span class="main">{</span><span class="free">agent</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">as</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> envSingleAgent<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>spr_repRels <span class="free">agent</span> <span class="main">∩</span> toSet <span class="free">ec</span> <span class="main">×</span> toSet <span class="free">ec</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span> <span class="main">=</span> <span class="main">(</span>spr_repRels <span class="free">agent</span> <span class="main">∩</span> toSet <span class="free">ec</span> <span class="main">×</span> toSet <span class="free">ec</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> trancl_id<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spr_repRels_def trans_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> Kcknows ec
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> spr_repRels_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inj_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> toSet_inj<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> eval_ec_subseteq<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1" id="SPRViewSingle-eval_all_or_nothing"><span class="command">lemma</span></span> eval_all_or_nothing<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> subj_phi<span class="main">:</span> <span class="quoted"><span class="quoted">"subjective <span class="free">agent</span> <span class="free">φ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"toSet <span class="main">(</span>eval <span class="free">envVal</span> <span class="free">ec</span> <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∨</span> toSet <span class="main">(</span>eval <span class="free">envVal</span> <span class="free">ec</span> <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> toSet <span class="free">ec</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> subj_phi <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> subjective.induct<span class="main">)</span> <span class="operator">auto</span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1" id="SPRViewSingle-eval_models"><span class="command">lemma</span></span> eval_models<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ec<span class="main">:</span> <span class="quoted"><span class="quoted">"spr_simAbs <span class="free">ec</span> <span class="main">=</span> SPRsingle.sim_equiv_class <span class="free">agent</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> subj<span class="main">:</span> <span class="quoted"><span class="quoted">"subjective <span class="free">agent</span> <span class="free">φ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> toSet <span class="free">ec</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"toSet <span class="main">(</span>eval <span class="free">envVal</span> <span class="free">ec</span> <span class="free">φ</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟷</span> spr_repMC <span class="main">(</span>toSet <span class="free">ec</span><span class="main">)</span><span class="main">,</span> <span class="free">s</span> <span class="main">⊨</span> <span class="free">φ</span>"</span></span>
<span class="comment1">(*&lt;*)</span>
  <span class="keyword1"><span class="command">using</span></span> eval_models_aux<span class="main">[</span><span class="operator">OF</span> ec s<span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span> eval_all_or_nothing<span class="main">[</span><span class="operator">OF</span> subj<span class="main">]</span> s
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="comment1">(*&gt;*)</span>

<span class="comment1">(* **************************************** *)</span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Simulated actions›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The actions enabled on a canonical equivalence class are those for
which <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"eval"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> yields a non-empty set of states:

›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> -<span class="main">)</span>
  <span class="entity">spr_simAction</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'aAct</span><span class="main">)</span> KBP <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'s</span> <span class="main">::</span> linorder<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> bool<span class="main">)</span>
                     <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> spr_simWorldsRep <span class="main">⇒</span> <span class="tfree">'aAct</span> list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">spr_simAction</span> <span class="free"><span class="bound"><span class="entity">kbp</span></span></span> <span class="free"><span class="bound"><span class="entity">envVal</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">a</span> <span class="bound">X</span><span class="main">.</span>
    <span class="main">[</span> action <span class="bound">gc</span><span class="main">.</span> gc <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">kbp</span></span></span><span class="main">,</span> eval <span class="free"><span class="bound"><span class="entity">envVal</span></span></span> <span class="bound">X</span> <span class="main">(</span>guard <span class="bound">gc</span><span class="main">)</span> <span class="main">≠</span> ODList.empty <span class="main">]</span>"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">spr_simAction</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> spr_simWorldsRep <span class="main">⇒</span> <span class="tfree">'aAct</span> list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">spr_simAction</span> <span class="main">≡</span> SPRViewSingle.spr_simAction <span class="main">(</span><span class="free">jkbp</span> <span class="free">agent</span><span class="main">)</span> <span class="free">envVal</span>"</span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The key lemma relates the agent's behaviour on an equivalence class to
that on its representation:

›</span></span>

<span class="keyword1" id="SPRViewSingle-spr_simAction_jAction"><span class="command">lemma</span></span> spr_simAction_jAction<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> SPR.jkbpC"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ec<span class="main">:</span> <span class="quoted"><span class="quoted">"spr_simAbs <span class="free">ec</span> <span class="main">=</span> SPRsingle.sim_equiv_class <span class="free">agent</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>spr_simAction <span class="free">agent</span> <span class="free">ec</span><span class="main">)</span>
       <span class="main">=</span> set <span class="main">(</span>jAction <span class="main">(</span>spr_repMC <span class="main">(</span>toSet <span class="free">ec</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>tLast <span class="free">t</span><span class="main">)</span> <span class="free">agent</span><span class="main">)</span>"</span></span>
<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> <span class="main">(</span>set <span class="main">(</span><span class="free">jkbp</span> <span class="free">agent</span><span class="main">)</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">gc</span><span class="main">.</span> <span class="bound">P</span> <span class="bound">gc</span><span class="main">}</span><span class="main">)</span>
      <span class="main">=</span> <span class="main">{</span> <span class="bound"><span class="bound">gc</span></span> <span class="main">∈</span> set <span class="main">(</span><span class="free">jkbp</span> <span class="free">agent</span><span class="main">)</span><span class="main">.</span> <span class="bound">P</span> <span class="bound">gc</span> <span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> spr_simAction_def jAction_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> SUP_cong<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Collect_cong<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> eval_models<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ec<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> toSet_eq_iff<span class="main">)</span>
       <span class="keyword1"><span class="command">using</span></span> subj tC ec
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> eval_models<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ec<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> subj tC ec
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span> <span class="comment1">(* FIXME improve *)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SPRViewSingle-spr_submodel_aux"><span class="command">lemma</span></span> spr_submodel_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> SPR.jkbpC"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> worlds <span class="main">(</span>spr_simMCt <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"gen_model SPRsingle.MCS <span class="free">s</span> <span class="main">=</span> gen_model <span class="main">(</span>spr_simMCt <span class="free">t</span><span class="main">)</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> gen_model_subset<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> T<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"SPRsingle.sim_equiv_class <span class="free"><span class="free">agent</span></span> <span class="free"><span class="free">t</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?X</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"SPRsingle.sim_equiv_class <span class="free">agent</span> <span class="free">t</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"relations SPRsingle.MCS <span class="skolem">a</span> <span class="main">∩</span> <span class="var">?X</span> <span class="main">×</span> <span class="var">?X</span>
      <span class="main">=</span> relations <span class="main">(</span>spr_simMCt <span class="free">t</span><span class="main">)</span> <span class="skolem">a</span> <span class="main">∩</span> <span class="var">?X</span> <span class="main">×</span> <span class="var">?X</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Int_ac Int_absorb1
                  relation_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> jkbpCSt_jkbpCS_subset jkbpCSt_jkbpCS_subset<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?X</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"SPRsingle.sim_equiv_class <span class="free">agent</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> s <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">a</span><span class="main">.</span> relations <span class="main">(</span>spr_simMCt <span class="free">t</span><span class="main">)</span> <span class="bound">a</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="main">{</span><span class="free">s</span><span class="main">}</span> <span class="main">⊆</span> <span class="var">?X</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> mkKripke_simps<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> kripke_rels_trc_worlds<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Y</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span> <span class="bound"><span class="bound">t'</span></span> <span class="main">∈</span> SPR.jkbpC <span class="main">.</span> spr_jview <span class="free">agent</span> <span class="bound">t'</span> <span class="main">=</span> spr_jview <span class="free">agent</span> <span class="free">t</span> <span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?X</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"spr_sim <span class="main">`</span> <span class="var">?Y</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> s <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> st'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">=</span> spr_sim <span class="skolem">t'</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> t'C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">∈</span> SPR.jkbpC"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> t'O<span class="main">:</span> <span class="quoted"><span class="quoted">"spr_jview <span class="free">agent</span> <span class="free">t</span> <span class="main">=</span> spr_jview <span class="free">agent</span> <span class="skolem">t'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t''</span>
    <span class="keyword3"><span class="command">assume</span></span> tt'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t'</span><span class="main">,</span> <span class="skolem">t''</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">a</span><span class="main">.</span> relations SPR.MC <span class="bound">a</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> t'C tt' <span class="keyword1"><span class="command">have</span></span> t''C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t''</span> <span class="main">∈</span> SPR.jkbpC"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">erule</span> kripke_rels_trc_worlds<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> tt' t'O <span class="keyword1"><span class="command">have</span></span> t''O<span class="main">:</span> <span class="quoted"><span class="quoted">"spr_jview <span class="free">agent</span> <span class="free">t</span> <span class="main">=</span> spr_jview <span class="free">agent</span> <span class="skolem">t''</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">induct</span>
      <span class="keyword1"><span class="command">unfolding</span></span> SPR.mkM_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cut_tac</span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> envSingleAgent<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">from</span></span> t''C t''O <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t''</span> <span class="main">∈</span> <span class="var">?Y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">a</span><span class="main">.</span> relations SPR.MC <span class="bound">a</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="main">{</span><span class="skolem">t'</span><span class="main">}</span> <span class="main">⊆</span> <span class="var">?Y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"spr_sim <span class="main">`</span> <span class="main">(</span><span class="main">(</span><span class="main">⋃</span><span class="bound">a</span><span class="main">.</span> relations SPR.MC <span class="bound">a</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="main">{</span><span class="skolem">t'</span><span class="main">}</span><span class="main">)</span> <span class="main">⊆</span> <span class="var">?X</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> image_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> st' t'C
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">a</span><span class="main">.</span> relations SPRsingle.MCS <span class="bound">a</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="main">{</span><span class="free">s</span><span class="main">}</span> <span class="main">⊆</span> <span class="var">?X</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sim_trc_commute<span class="main">[</span><span class="operator">OF</span> SPR.mkM_kripke spr_sim<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">t'</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> s<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Algorithm›</span></span></span></span> locale requires the following lemma, which is
a straightforward chaining of the above simulations.

›</span></span>

<span class="keyword1" id="SPRViewSingle-spr_simAction"><span class="command">lemma</span></span> spr_simAction<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> SPR.jkbpC"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> ec<span class="main">:</span> <span class="quoted"><span class="quoted">"spr_simAbs <span class="free">ec</span> <span class="main">=</span> SPRsingle.sim_equiv_class <span class="free">a</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>spr_simAction <span class="free">a</span> <span class="free">ec</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>jAction SPR.MC <span class="free">t</span> <span class="free">a</span><span class="main">)</span>"</span></span>
<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> ec
  <span class="keyword1"><span class="command">have</span></span> ec'<span class="main">:</span> <span class="quoted"><span class="quoted">"spr_simAbs <span class="free">ec</span> <span class="main">=</span> SPRsingle.sim_equiv_class <span class="free">agent</span> <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> envSingleAgent<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">a</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>spr_simAction <span class="free">a</span> <span class="free">ec</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>spr_simAction <span class="free">agent</span> <span class="free">ec</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> envSingleAgent<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">a</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> tC ec' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> set <span class="main">(</span>jAction <span class="main">(</span>spr_repMC <span class="main">(</span>toSet <span class="free">ec</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>tLast <span class="free">t</span><span class="main">)</span> <span class="free">agent</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> spr_simAction_jAction<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> tC ec' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> set <span class="main">(</span>jAction <span class="main">(</span>spr_simMCt <span class="free">t</span><span class="main">)</span> <span class="main">(</span>spr_sim <span class="free">t</span><span class="main">)</span> <span class="free">agent</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> simulation_jAction_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ spr_repSim<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> tC <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> set <span class="main">(</span>jAction SPRsingle.MCS <span class="main">(</span>spr_sim <span class="free">t</span><span class="main">)</span> <span class="free">agent</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> gen_model_jAction_eq<span class="main">[</span><span class="operator">OF</span> spr_submodel_aux<span class="main"><span class="main">[</span></span><span class="operator">OF</span> tC<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> s<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"spr_sim <span class="free">t</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> w'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"spr_sim <span class="free">t</span>"</span></span><span class="main">]</span>
          gen_model_world_refl<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> w<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"spr_sim <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> M<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"spr_simMCt <span class="free">t</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> tC <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> set <span class="main">(</span>jAction SPR.MC <span class="free">t</span> <span class="free">agent</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> simulation_jAction_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ spr_sim<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> envSingleAgent<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">a</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="comment1">(* **************************************** *)</span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Simulated transitions›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

It is straightforward to determine the possible successor states of a
given canonical equivalence class <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">X</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>:

›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> -<span class="main">)</span>
  <span class="entity">spr_trans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'aAct</span><span class="main">)</span> KBP
              <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'eAct</span> list<span class="main">)</span>
              <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'eAct</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'aAct</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span><span class="main">)</span>
              <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> bool<span class="main">)</span>
              <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">::</span> linorder<span class="main">)</span> spr_simWorldsRep <span class="main">⇒</span> <span class="tfree">'s</span> list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">spr_trans</span> <span class="free"><span class="bound"><span class="entity">kbp</span></span></span> <span class="free"><span class="bound"><span class="entity">envAction</span></span></span> <span class="free"><span class="bound"><span class="entity">envTrans</span></span></span> <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">a</span> <span class="bound">X</span><span class="main">.</span>
    <span class="main">[</span> <span class="free"><span class="bound"><span class="entity">envTrans</span></span></span> <span class="bound">eact</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a'</span><span class="main">.</span> <span class="bound">aact</span><span class="main">)</span> <span class="bound">s</span> <span class="main">.</span>
       s <span class="main">←</span> toList <span class="bound">X</span><span class="main">,</span> eact <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">envAction</span></span></span> <span class="bound">s</span><span class="main">,</span> aact <span class="main">←</span> spr_simAction <span class="free"><span class="bound"><span class="entity">kbp</span></span></span> <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="bound">a</span> <span class="bound">X</span> <span class="main">]</span>"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">spr_trans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> spr_simWorldsRep <span class="main">⇒</span> <span class="tfree">'s</span> list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">spr_trans</span> <span class="main">≡</span> SPRViewSingle.spr_trans <span class="main">(</span><span class="free">jkbp</span> <span class="free">agent</span><span class="main">)</span> <span class="free">envAction</span> <span class="free">envTrans</span> <span class="free">envVal</span>"</span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

Using this function we can determine the set of possible successor
equivalence classes from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">X</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>:

›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> -<span class="main">)</span> <span class="entity">envObs_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'obs</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">×</span> <span class="tfree">'s</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">envObs_rel</span> <span class="free"><span class="bound"><span class="entity">envObs</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">envObs</span></span></span> <span class="bound">s'</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">envObs</span></span></span> <span class="bound">s</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> -<span class="main">)</span>
  <span class="entity">spr_simTrans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'aAct</span><span class="main">)</span> KBP
                 <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'s</span><span class="main">::</span>linorder<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'eAct</span> list<span class="main">)</span>
                 <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'eAct</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'aAct</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span><span class="main">)</span>
                 <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> bool<span class="main">)</span>
                 <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'obs</span><span class="main">)</span>
                 <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> spr_simWorldsRep <span class="main">⇒</span> <span class="tfree">'s</span> spr_simWorldsRep list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">spr_simTrans</span> <span class="free"><span class="bound"><span class="entity">kbp</span></span></span> <span class="free"><span class="bound"><span class="entity">envAction</span></span></span> <span class="free"><span class="bound"><span class="entity">envTrans</span></span></span> <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="free"><span class="bound"><span class="entity">envObs</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">a</span> <span class="bound">X</span><span class="main">.</span>
    map ODList.fromList <span class="main">(</span>partition <span class="main">(</span>envObs_rel <span class="main">(</span><span class="free"><span class="bound"><span class="entity">envObs</span></span></span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span>
                                   <span class="main">(</span>spr_trans <span class="free"><span class="bound"><span class="entity">kbp</span></span></span> <span class="free"><span class="bound"><span class="entity">envAction</span></span></span> <span class="free"><span class="bound"><span class="entity">envTrans</span></span></span> <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="bound">a</span> <span class="bound">X</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">spr_simTrans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> spr_simWorldsRep <span class="main">⇒</span> <span class="tfree">'s</span> spr_simWorldsRep list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">spr_simTrans</span> <span class="main">≡</span> SPRViewSingle.spr_simTrans <span class="main">(</span><span class="free">jkbp</span> <span class="free">agent</span><span class="main">)</span> <span class="free">envAction</span> <span class="free">envTrans</span> <span class="free">envVal</span> <span class="free">envObs</span>"</span></span>

<span class="keyword1" id="SPRViewSingle-envObs_rel_equiv"><span class="command">lemma</span></span> envObs_rel_equiv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"equiv UNIV <span class="main">(</span>rel_ext <span class="main">(</span>envObs_rel <span class="main">(</span><span class="free">envObs</span> <span class="free">agent</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> equivI refl_onI symI transI<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="SPRViewSingle-spr_trans"><span class="command">lemma</span></span> spr_trans<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> SPR.jkbpC"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ec<span class="main">:</span> <span class="quoted"><span class="quoted">"spr_simAbs <span class="free">ec</span> <span class="main">=</span> SPRsingle.sim_equiv_class <span class="free">agent</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>spr_trans <span class="free">agent</span> <span class="free">ec</span><span class="main">)</span>
       <span class="main">=</span> <span class="main">{</span> <span class="bound">s</span> <span class="main">|</span><span class="bound">t'</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">t'</span> <span class="main">↝</span> <span class="bound">s</span> <span class="main">∈</span> SPR.jkbpC <span class="main">∧</span> spr_jview <span class="free">agent</span> <span class="bound">t'</span> <span class="main">=</span> spr_jview <span class="free">agent</span> <span class="free">t</span> <span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">⊆</span> <span class="var">?rhs</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?lhs</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?rhs</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> spr_trans_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> split_paired_Ex split_paired_All<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> spr_sim_rep_abs<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> toSet_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>

      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> spr_abs_conv<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">agent</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>

      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">t'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> n<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Suc <span class="main">(</span>tLength <span class="improper">t'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> SPR.jkbpCn_jkbpC_inc<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> split_paired_Ex split_paired_All<span class="main">)</span>

      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">xa</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">a'</span><span class="main">.</span> <span class="improper">aact</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> envSingleAgent<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spr_simAction<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">agent</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> SPR.jkbpC_jkbpCn_jAction_eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> S5n_jAction_eq<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> w'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">t</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
      <span class="keyword1"><span class="command">unfolding</span></span> SPR.mkM_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span> <span class="main">⊆</span> <span class="var">?lhs</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="keyword3"><span class="command">assume</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> <span class="var">?rhs</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> t'sC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">↝</span> <span class="skolem">s</span> <span class="main">∈</span> SPR.jkbpC"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> tt'<span class="main">:</span> <span class="quoted"><span class="quoted">"spr_jview <span class="free">agent</span> <span class="skolem">t'</span> <span class="main">=</span> spr_jview <span class="free">agent</span> <span class="free">t</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> t'sC <span class="keyword1"><span class="command">have</span></span> t'Cn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">∈</span> SPR.jkbpCn <span class="main">(</span>tLength <span class="skolem">t'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> t'sC <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">eact</span></span> <span class="skolem"><span class="skolem">aact</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> eact<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">eact</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">envAction</span> <span class="main">(</span>tLast <span class="skolem">t'</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> aact<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span><span class="main">.</span> <span class="skolem">aact</span> <span class="bound">a</span> <span class="main">∈</span> set <span class="main">(</span>jAction <span class="main">(</span>SPR.mkM <span class="main">(</span>SPR.jkbpCn <span class="main">(</span>tLength <span class="skolem">t'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t'</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> <span class="free">envTrans</span> <span class="skolem">eact</span> <span class="skolem">aact</span> <span class="main">(</span>tLast <span class="skolem">t'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> SPR.jkbpC_tLength_inv<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">↝</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> n<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Suc <span class="main">(</span>tLength <span class="skolem">t'</span><span class="main">)</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> tC ec s eact aact tt' t'sC
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> <span class="var">?lhs</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> spr_trans_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> bexI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"tLast <span class="skolem"><span class="skolem">t'</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> bexI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">eact</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> spr_absI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spr_simAction<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">agent</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> image_eqI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">aact</span></span> <span class="free"><span class="free">agent</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">a'</span><span class="main">.</span> <span class="skolem">aact</span> <span class="free">agent</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">aact</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cut_tac</span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">a'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> envSingleAgent<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> allE<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">agent</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> SPR.jkbpC_jkbpCn_jAction_eq<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> S5n_jAction_eq<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> w<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">t</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> w'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">t'</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> SPR.mkM_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> SPR.sync<span class="main"><span class="main">[</span></span><span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> SPR.sync<span class="main"><span class="main">[</span></span><span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>partition›</span></span></span></span> function splits a list into equivalence
classes under the given equivalence relation.

The property asked for by the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Algorithm›</span></span></span></span> locale follows from
the properties of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>partition›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>spr_trans›</span></span></span></span>:

›</span></span>

<span class="keyword1" id="SPRViewSingle-spr_simTrans"><span class="command">lemma</span></span> spr_simTrans<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> SPR.jkbpC"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ec<span class="main">:</span> <span class="quoted"><span class="quoted">"spr_simAbs <span class="free">ec</span> <span class="main">=</span> SPRsingle.sim_equiv_class <span class="free">a</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"spr_simAbs <span class="main">`</span> set <span class="main">(</span>spr_simTrans <span class="free">a</span> <span class="free">ec</span><span class="main">)</span>
      <span class="main">=</span> <span class="main">{</span> SPRsingle.sim_equiv_class <span class="free">a</span> <span class="main">(</span><span class="bound">t'</span> <span class="main">↝</span> <span class="bound">s</span><span class="main">)</span>
          <span class="main">|</span><span class="bound">t'</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">t'</span> <span class="main">↝</span> <span class="bound">s</span> <span class="main">∈</span> SPR.jkbpC <span class="main">∧</span> spr_jview <span class="free">a</span> <span class="bound">t'</span> <span class="main">=</span> spr_jview <span class="free">a</span> <span class="free">t</span><span class="main">}</span>"</span></span>
<span class="comment1">(*&lt;*)</span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="free">a</span> <span class="main">=</span> <span class="var">?rhs</span> <span class="free">a</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> ec <span class="keyword1"><span class="command">have</span></span> ec'<span class="main">:</span> <span class="quoted"><span class="quoted">"spr_simAbs <span class="free">ec</span> <span class="main">=</span> SPRsingle.sim_equiv_class <span class="free">agent</span> <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> envSingleAgent<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">a</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> ec' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="free">agent</span> <span class="main">=</span> <span class="var">?rhs</span> <span class="free">agent</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> spr_simTrans_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> spr_simAbs_list partition<span class="main"><span class="main">[</span></span><span class="operator">OF</span> envObs_rel_equiv subset_UNIV<span class="main"><span class="main">]</span></span> spr_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> tC ec'<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>

     <span class="comment1">(* left to right *)</span>

     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> quotientE<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">t'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">t'a</span> <span class="main">↝</span> <span class="improper">s</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> image_eqI<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> spr_sim_def <span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span> spr_abs_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> spr_jview_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">t'c</span> <span class="main">↝</span> <span class="improper">xa</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> image_eqI<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spr_jview_def<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> spr_jview_tStep_eq_inv<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">s'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> spr_sim_def <span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span> spr_abs_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> spr_jview_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">t'b</span> <span class="main">↝</span> <span class="improper">xa</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> image_eqI<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>

     <span class="comment1">(* right to left *)</span>

     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"spr_abs <span class="main">(</span><span class="improper">t'</span> <span class="main">↝</span> <span class="improper">s</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> image_eqI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> spr_jview_tStep_eq_inv<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> spr_sim_def <span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> spr_abs_eq<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> spr_absI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">agent</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">back</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> spr_abs_conv<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">agent</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> spr_jview_tStep_eq_inv<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">t''</span> <span class="main">↝</span> <span class="improper">s'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> image_eqI<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> spr_sim_def <span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">s</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> quotientI2<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cut_tac</span> v<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> t<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">t'</span> <span class="main">↝</span> <span class="improper">s</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spr_abs_conv<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">agent</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> spr_jview_tStep_eq_inv<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">t''</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def spr_jview_def<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> spr_absI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">agent</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">back</span></span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">back</span></span></span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> spr_jview_def<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
   <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="free">a</span> <span class="main">=</span> <span class="var">?rhs</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> envSingleAgent<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">a</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹›</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context FiniteSingleAgentEnvironment *)</span>

<span class="comment1">(* **************************************** *)</span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Maps›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

\label{sec:kbps-theory-spr-single-maps}

As in \S\ref{sec:kbps-theory-clock-view-maps}, we use a pair of tries
and an association list to handle the automata representation. Recall
that the keys of these tries are lists of system states.

›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'obs</span><span class="main">)</span> spr_trans_trie <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="main">(</span><span class="tfree">'obs</span><span class="main">,</span> <span class="tfree">'s</span> odlist<span class="main">)</span> mapping<span class="main">)</span> trie"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'aAct</span><span class="main">)</span> spr_acts_trie <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'aAct</span><span class="main">)</span> trie<span class="main">)</span> trie"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">trans_MapOps_lookup</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">::</span>linorder<span class="main">,</span> <span class="tfree">'obs</span><span class="main">)</span> spr_trans_trie
                        <span class="main">⇒</span> <span class="tfree">'s</span> odlist <span class="main">×</span> <span class="tfree">'obs</span> <span class="main">⇀</span> <span class="tfree">'s</span> odlist"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">trans_MapOps_lookup</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">m</span> <span class="bound">k</span><span class="main">.</span>
     Option.bind <span class="main">(</span>trie_odlist_lookup <span class="bound">m</span> <span class="main">(</span>fst <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">m'</span><span class="main">.</span> Mapping.lookup <span class="bound">m'</span> <span class="main">(</span>snd <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">trans_MapOps_update</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> odlist <span class="main">×</span> <span class="tfree">'obs</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">::</span> linorder<span class="main">)</span> odlist
                        <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="main">(</span><span class="tfree">'obs</span><span class="main">,</span> <span class="tfree">'s</span> odlist<span class="main">)</span> mapping<span class="main">)</span> trie
                        <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="main">(</span><span class="tfree">'obs</span><span class="main">,</span> <span class="tfree">'s</span> odlist<span class="main">)</span> mapping<span class="main">)</span> trie"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">trans_MapOps_update</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">k</span> <span class="bound">v</span> <span class="bound">m</span><span class="main">.</span>
     trie_odlist_update_with <span class="main">(</span>fst <span class="bound">k</span><span class="main">)</span> <span class="bound">m</span> Mapping.empty
      <span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">.</span> Mapping.update <span class="main">(</span>snd <span class="bound">k</span><span class="main">)</span> <span class="bound">v</span> <span class="bound">m</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">trans_MapOps</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'s</span> <span class="main">::</span> linorder<span class="main">,</span> <span class="main">(</span><span class="tfree">'obs</span><span class="main">,</span> <span class="tfree">'s</span> odlist<span class="main">)</span> mapping<span class="main">)</span> trie<span class="main">,</span> <span class="tfree">'s</span> odlist <span class="main">×</span> <span class="tfree">'obs</span><span class="main">,</span> <span class="tfree">'s</span> odlist<span class="main">)</span> MapOps"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">trans_MapOps</span> <span class="main">≡</span>
     <span class="main">⦇</span> MapOps.empty <span class="main">=</span> empty_trie<span class="main">,</span>
       lookup <span class="main">=</span> trans_MapOps_lookup<span class="main">,</span>
       update <span class="main">=</span> trans_MapOps_update <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> FiniteSingleAgentEnvironment<span class="main">)</span> trans_MapOps<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"MapOps <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span>spr_simAbs <span class="main">(</span>fst <span class="bound">k</span><span class="main">)</span><span class="main">,</span> snd <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>SPRsingle.jkbpSEC <span class="main">×</span> UNIV<span class="main">)</span> trans_MapOps"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"MapOps.lookup trans_MapOps <span class="main">(</span>MapOps.empty trans_MapOps<span class="main">)</span> <span class="skolem">k</span> <span class="main">=</span> None"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> trans_MapOps_def trans_MapOps_lookup_def trie_odlist_lookup_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">e</span> <span class="skolem">k</span> <span class="skolem">k'</span> <span class="skolem">M</span>
  <span class="keyword3"><span class="command">assume</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>spr_simAbs <span class="main">(</span>fst <span class="skolem">k</span><span class="main">)</span><span class="main">,</span> snd <span class="skolem">k</span><span class="main">)</span> <span class="main">∈</span> SPRsingle.jkbpSEC <span class="main">×</span> <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'z</span> set<span class="main">)</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> k'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>spr_simAbs <span class="main">(</span>fst <span class="skolem">k'</span><span class="main">)</span><span class="main">,</span> snd <span class="skolem">k'</span><span class="main">)</span> <span class="main">∈</span> SPRsingle.jkbpSEC <span class="main">×</span> <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'z</span> set<span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"MapOps.lookup trans_MapOps <span class="main">(</span>MapOps.update trans_MapOps <span class="skolem">k</span> <span class="skolem">e</span> <span class="skolem">M</span><span class="main">)</span> <span class="skolem">k'</span>
         <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span>spr_simAbs <span class="main">(</span>fst <span class="skolem">k'</span><span class="main">)</span><span class="main">,</span> snd <span class="skolem">k'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>spr_simAbs <span class="main">(</span>fst <span class="skolem">k</span><span class="main">)</span><span class="main">,</span> snd <span class="skolem">k</span><span class="main">)</span>
             <span class="keyword1">then</span> Some <span class="skolem">e</span> <span class="keyword1">else</span> MapOps.lookup trans_MapOps <span class="skolem">M</span> <span class="skolem">k'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>spr_simAbs <span class="main">(</span>fst <span class="skolem">k'</span><span class="main">)</span><span class="main">,</span> snd <span class="skolem">k'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>spr_simAbs <span class="main">(</span>fst <span class="skolem">k</span><span class="main">)</span><span class="main">,</span> snd <span class="skolem">k</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="skolem">k'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> injD<span class="main">[</span><span class="operator">OF</span> spr_simAbs_inj<span class="main">]</span> k k' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> prod_eqI<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> trans_MapOps_def trans_MapOps_lookup_def trans_MapOps_update_def trie_odlist_lookup_def trie_odlist_update_with_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_trie_update_with lookup_update <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split prod.split<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> trans_MapOps_def trans_MapOps_lookup_def trans_MapOps_update_def trie_odlist_lookup_def trie_odlist_update_with_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lookup_empty lookup_update_neq lookup_trie_update_with <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split prod.split<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Locale instantiation›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The above is sufficient to instantiate the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Algorithm"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> locale.

›</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> FiniteSingleAgentEnvironment
        <span class="main">&lt;</span> SPRsingle<span class="main">:</span> Algorithm
            <span class="quoted"><span class="free">jkbp</span></span> <span class="quoted"><span class="free">envInit</span></span> <span class="quoted"><span class="free">envAction</span></span> <span class="quoted"><span class="free">envTrans</span></span> <span class="quoted"><span class="free">envVal</span></span>
            <span class="quoted">spr_jview</span> <span class="quoted"><span class="free">envObs</span></span> <span class="quoted">spr_jviewInit</span> <span class="quoted">spr_jviewIncr</span>
            <span class="quoted">spr_sim</span> <span class="quoted">spr_simRels</span> <span class="quoted">spr_simVal</span>
            <span class="quoted">spr_simAbs</span> <span class="quoted">spr_simObs</span> <span class="quoted">spr_simInit</span> <span class="quoted">spr_simTrans</span> <span class="quoted">spr_simAction</span>
            <span class="quoted">trie_odlist_MapOps</span> <span class="quoted">trans_MapOps</span>
<span class="comment1">(*&lt;*)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>

  <span class="keyword1"><span class="command">using</span></span> spr_simInit
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>

  <span class="keyword1"><span class="command">using</span></span> spr_simObs
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>

  <span class="keyword1"><span class="command">using</span></span> spr_simAction
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">using</span></span> spr_simTrans
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> trie_odlist_MapOps<span class="main"><span class="main">[</span></span><span class="operator">OF</span> subset_inj_on<span class="main"><span class="main">[</span></span><span class="operator">OF</span> spr_simAbs_inj subset_UNIV<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> trans_MapOps<span class="main">)</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">mkSPRSingleAuto</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'aAct</span><span class="main">)</span> KBP
                    <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">::</span> linorder<span class="main">)</span> list
                    <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'eAct</span> list<span class="main">)</span>
                    <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'eAct</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'aAct</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span><span class="main">)</span>
                    <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> bool<span class="main">)</span>
                    <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'obs</span><span class="main">)</span>
                    <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'obs</span><span class="main">,</span> <span class="tfree">'aAct</span><span class="main">,</span> <span class="tfree">'s</span> odlist<span class="main">)</span> Protocol"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mkSPRSingleAuto</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">kbp</span> <span class="bound">envInit</span> <span class="bound">envAction</span> <span class="bound">envTrans</span> <span class="bound">envVal</span> <span class="bound">envObs</span><span class="main">.</span>
    mkAlgAuto trie_odlist_MapOps
              trans_MapOps
              <span class="main">(</span>spr_simObs <span class="bound">envObs</span><span class="main">)</span>
              <span class="main">(</span>spr_simInit <span class="bound">envInit</span> <span class="bound">envObs</span><span class="main">)</span>
              <span class="main">(</span>spr_simTrans <span class="bound">kbp</span> <span class="bound">envAction</span> <span class="bound">envTrans</span> <span class="bound">envVal</span> <span class="bound">envObs</span><span class="main">)</span>
              <span class="main">(</span>spr_simAction <span class="bound">kbp</span> <span class="bound">envVal</span><span class="main">)</span>
              <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> map <span class="main">(</span>spr_simInit <span class="bound">envInit</span> <span class="bound">envObs</span> <span class="bound">a</span> <span class="main">∘</span> <span class="bound">envObs</span> <span class="bound">a</span><span class="main">)</span> <span class="bound">envInit</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> FiniteSingleAgentEnvironment<span class="main">)</span> mkSPRSingleAuto_implements<span class="main">:</span>
  <span class="quoted"><span class="quoted">"SPR.implements <span class="main">(</span>mkSPRSingleAuto <span class="main">(</span><span class="free">jkbp</span> <span class="free">agent</span><span class="main">)</span> <span class="free">envInit</span> <span class="free">envAction</span> <span class="free">envTrans</span> <span class="free">envVal</span> <span class="free">envObs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> SPRsingle.k_mkAlgAuto_implements
  <span class="keyword1"><span class="command">unfolding</span></span> mkSPRSingleAuto_def mkAlgAuto_def alg_dfs_def SPRsingle.KBP.k_ins_def SPRsingle.KBP.k_empt_def SPRsingle.k_frontier_def SPRsingle.KBP.k_memb_def SPRsingle.KBP.transUpdate_def SPRsingle.KBP.actsUpdate_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">(*

We actually run this unfolding of the algorithm. The lemma is keeping
us honest.

*)</span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> -<span class="main">)</span>
  <span class="main">(</span><span class="tfree">'aAct</span><span class="main">,</span> <span class="tfree">'obs</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> SPRSingleAutoDFS <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'aAct</span> list<span class="main">)</span> trie<span class="main">,</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="main">(</span><span class="tfree">'obs</span><span class="main">,</span> <span class="tfree">'s</span> odlist<span class="main">)</span> mapping<span class="main">)</span> trie<span class="main">)</span><span class="main">)</span> AlgState"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">SPRSingleAutoDFS</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'aAct</span><span class="main">)</span> KBP
                     <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">::</span> linorder<span class="main">)</span> list
                     <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'eAct</span> list<span class="main">)</span>
                     <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'eAct</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'aAct</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span><span class="main">)</span>
                     <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> bool<span class="main">)</span>
                     <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'obs</span><span class="main">)</span>
                     <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'aAct</span><span class="main">,</span> <span class="tfree">'obs</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> SPRSingleAutoDFS"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">SPRSingleAutoDFS</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">kbp</span> <span class="bound">envInit</span> <span class="bound">envAction</span> <span class="bound">envTrans</span> <span class="bound">envVal</span> <span class="bound">envObs</span><span class="main">.</span> <span class="main">λ</span><span class="bound">a</span><span class="main">.</span>
    alg_dfs trie_odlist_MapOps
            trans_MapOps
            <span class="main">(</span>spr_simObs <span class="bound">envObs</span> <span class="bound">a</span><span class="main">)</span>
            <span class="main">(</span>spr_simTrans <span class="bound">kbp</span> <span class="bound">envAction</span> <span class="bound">envTrans</span> <span class="bound">envVal</span> <span class="bound">envObs</span> <span class="bound">a</span><span class="main">)</span>
            <span class="main">(</span>spr_simAction <span class="bound">kbp</span> <span class="bound">envVal</span> <span class="bound">a</span><span class="main">)</span>
            <span class="main">(</span>map <span class="main">(</span>spr_simInit <span class="bound">envInit</span> <span class="bound">envObs</span> <span class="bound">a</span> <span class="main">∘</span> <span class="bound">envObs</span> <span class="bound">a</span><span class="main">)</span> <span class="bound">envInit</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> FiniteSingleAgentEnvironment<span class="main">)</span>
  <span class="quoted"><span class="quoted">"mkSPRSingleAuto <span class="free">kbp</span> <span class="free">envInit</span> <span class="free">envAction</span> <span class="free">envTrans</span> <span class="free">envVal</span> <span class="free">envObs</span>
 <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> alg_mk_auto trie_odlist_MapOps trans_MapOps <span class="main">(</span>spr_simInit <span class="bound">a</span><span class="main">)</span> <span class="main">(</span>SPRSingleAutoDFS <span class="free">kbp</span> <span class="free">envInit</span> <span class="free">envAction</span> <span class="free">envTrans</span> <span class="free">envVal</span> <span class="free">envObs</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mkSPRSingleAuto_def SPRSingleAutoDFS_def mkAlgAuto_def alg_mk_auto_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

We use this theory to synthesise a solution to the robot of
\S\ref{sec:kbps-robot-intro} in \S\ref{sec:kbps-theory-robot}.

›</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="Views">
<div class="head">
<h1>Theory Views</h1>
</div>
<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Views
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="#ClockView">ClockView</a>
  <a href="#SPRViewDet">SPRViewDet</a>
  <a href="#SPRViewNonDet">SPRViewNonDet</a>
  <a href="#SPRViewNonDetIndInit">SPRViewNonDetIndInit</a>
  <a href="#SPRViewSingle">SPRViewSingle</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Concrete views›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

\label{sec:kbps-theory-views}

Following \citet{Ron:1996}, we provide two concrete synchronous views
that illustrate how the theory works. For each view we give  a
simulation and a representation that satisfy the requirements of the
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Algorithm›</span></span></span></span> locale in Figure~\ref{fig:kbps-alg-alg-locale}.

›</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="MuddyChildren">
<div class="head">
<h1>Theory MuddyChildren</h1>
</div>
<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="comment1">(*
 * Knowledge-based programs.
 * (C)opyright 2011, Peter Gammie, peteg42 at gmail.com.
 * License: BSD
 *)</span>

<span class="keyword1"><span class="command">theory</span></span> MuddyChildren
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#ClockView">ClockView</a> <a href="#SPRViewDet">SPRViewDet</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹The Muddy Children›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

\label{sec:kbps-theory-mc}

Our first example of a multi-agent broadcast scenario is the classic
muddy children puzzle, one of a class of such puzzles that exemplify
non-obvious reasoning about mutual states of knowledge. It goes as
follows \citep[\S1.1, Example~7.2.5]{FHMV:1995}:
\begin{quotation}

  $N$ children are playing together, $k$ of whom get mud on their
  foreheads. Each can see the mud on the others' foreheads but not
  their own.

  A parental figure appears and says ``At least one of you has mud on your
  forehead.'', expressing something already known to each of them if $k &gt;
  1$.

  The parental figure then asks ``Does any of you know whether you have mud
  on your own forehead?'' over and over.

  Assuming the children are perceptive, intelligent, truthful and they
  answer simultaneously, what will happen?
\end{quotation}
This puzzle relies essentially on \emph{synchronous public broadcasts}
making particular facts \emph{common knowledge}, and that agents are
capable of the requisite logical inference.

As the mother has complete knowledge of the situation, we integrate
her behaviour into the environment. Each agent $\mbox{child}_i$
reasons with the following KBP:
\begin{center}
  \begin{tabular}{lll}
    $\mathbf{do}$\\
     &amp; $\gcalt\ \hat{\mathbf{K}}_{\mbox{child}_i} \mbox{muddy}_i$ &amp; $<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>→›</span></span></span></span>$ Say ``I know if my forehead is muddy''\\
     &amp; $\gcalt\ <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>¬›</span></span></span></span>\hat{\mathbf{K}}_{\mbox{child}_i} \mbox{muddy}_i$ &amp; $<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>→›</span></span></span></span>$ Say nothing\\
    $\mathbf{od}$\\
  \end{tabular}
\end{center}
where $\hat{\mathbf{K}}_a <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>φ›</span></span></span></span>$ abbreviates $\mathbf{K}_a
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>φ›</span></span></span></span>\ <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>∨›</span></span></span></span>\ \mathbf{K}_a <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>¬φ›</span></span></span></span>$.

As this protocol is deterministic, we use the SPR algorithm of
\S\ref{sec:kbps-theory-spr-deterministic-protocols}.

\begin{wrapfigure}{r}{0.5\textwidth}
  \vspace{-20pt}
  \includegraphics[width=0.48\textwidth]{MC}
  \vspace{-10pt}
  \caption{The protocol of $\mbox{child}_0$.}
  \label{fig:mc}
\end{wrapfigure}

The model records a child's initial observation of the mother's
pronouncement and the muddiness of the other children in her initial
private state, and these states are not changed by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="free">envTrans</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. The recurring common observation is all of the children's
public responses to the mother's questions. Being able to distinguish
these observations is crucial to making this a broadcast scenario.

Running the algorithm for three children and minimising using
Hopcroft's algorithm yields the automaton in Figure~\ref{fig:mc} for
$\mbox{child}_0$. The initial transitions are labelled with the
initial observation, i.e., the cleanliness ``C'' or muddiness ``M'' of
the other two children. The dashed initial transition covers the case
where everyone is clean; in the others the mother has announced that
someone is dirty. Later transitions simply record the actions
performed by each of the agents, where ``K'' is the first action in
the above KBP, and ``N'' the second. Double-circled states are those
in which $\mbox{child}_0$ knows whether she is muddy, and
single-circled where she does not.

In essence the child counts the number of muddy foreheads she sees and
waits that many rounds before announcing that she knows.

Note that a solution to this puzzle is beyond the reach of the clock
semantics as it requires (in general) remembering the sequence of
previous broadcasts of length proportional to the number of
children. We discuss this further in \S\ref{sec:kbps-muddychildren}.

›</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1"><span class="command">datatype</span></span> Agent <span class="main">=</span> Child0 <span class="main">|</span> Child1 <span class="main">|</span> Child2
<span class="keyword1"><span class="command">datatype</span></span> Proposition <span class="main">=</span> Dirty <span class="quoted">Agent</span>

<span class="keyword1"><span class="command">datatype</span></span> ChildAct <span class="main">=</span> SayIKnow <span class="main">|</span> SayNothing

<span class="keyword1" id="MuddyChildren-Agent_univ"><span class="command">lemma</span></span> Agent_univ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>UNIV <span class="main">::</span> Agent set<span class="main">)</span> <span class="main">=</span> <span class="main">{</span>Child0<span class="main">,</span> Child1<span class="main">,</span> Child2<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> UNIV_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">instance</span></span> Agent <span class="main">::</span> <span class="quoted">finite</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">intro_classes</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> Agent_univ<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">instantiation</span></span> Agent <span class="main">::</span> <span class="quoted">linorder</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity"><span class="class_parameter">less_Agent</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">less_Agent</span> Child0 Child0 <span class="main">=</span> False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">less_Agent</span> Child0 <span class="main"><span class="bound"><span class="entity">_</span></span></span>      <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">less_Agent</span> Child1 Child2 <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">less_Agent</span> Child1 <span class="main"><span class="bound"><span class="entity">_</span></span></span>      <span class="main">=</span> False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">less_Agent</span> Child2 <span class="main"><span class="bound"><span class="entity">_</span></span></span>      <span class="main">=</span> False"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity"><span class="class_parameter">less_eq_Agent</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Agent <span class="main">⇒</span> Agent <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">less_eq_Agent</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">intro_classes</span>
  <span class="keyword1"><span class="command">unfolding</span></span> less_eq_Agent_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">z</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">z</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> Agent <span class="main">::</span> <span class="quoted">enum</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"enum_class.enum <span class="main">=</span> <span class="main">[</span>Child0<span class="main">,</span> Child1<span class="main">,</span> Child2<span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"enum_class.enum_all <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> Child0 <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> Child1 <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> Child2<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"enum_class.enum_ex <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> Child0 <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> Child1 <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> Child2<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
  <span class="keyword1"><span class="command">unfolding</span></span> enum_Agent_def enum_all_Agent_def enum_ex_Agent_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper">x</span></span></span></span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="MuddyChildren-Act_univ"><span class="command">lemma</span></span> Act_univ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>UNIV <span class="main">::</span> ChildAct set<span class="main">)</span> <span class="main">=</span> <span class="main">{</span>SayIKnow<span class="main">,</span> SayNothing<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> UNIV_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">instance</span></span> ChildAct <span class="main">::</span> <span class="quoted">finite</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> Act_univ<span class="main">)</span>

<span class="keyword1"><span class="command">instantiation</span></span> ChildAct <span class="main">::</span> <span class="quoted">enum</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"enum_class.enum <span class="main">=</span> <span class="main">[</span>SayIKnow<span class="main">,</span> SayNothing<span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"enum_class.enum_all <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> SayIKnow <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> SayNothing<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"enum_class.enum_ex <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> SayIKnow <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> SayNothing<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
  <span class="keyword1"><span class="command">unfolding</span></span> enum_ChildAct_def enum_all_ChildAct_def enum_ex_ChildAct_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper">x</span></span></span></span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> ChildAct <span class="main">::</span> <span class="quoted">linorder</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity"><span class="class_parameter">less_ChildAct</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">less_ChildAct</span> SayIKnow SayNothing <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">less_ChildAct</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> False"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity"><span class="class_parameter">less_eq_ChildAct</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ChildAct <span class="main">⇒</span> ChildAct <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">less_eq_ChildAct</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">intro_classes</span>
  <span class="keyword1"><span class="command">unfolding</span></span> less_eq_ChildAct_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> EnvAct <span class="main">=</span> <span class="quoted"><span class="quoted">"unit"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> EnvState <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bool <span class="main">×</span> bool <span class="main">×</span> bool<span class="main">)</span> <span class="main">×</span> <span class="main">(</span>ChildAct <span class="main">×</span> ChildAct <span class="main">×</span> ChildAct<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> AgentState <span class="main">=</span> <span class="quoted"><span class="quoted">"bool <span class="main">×</span> bool <span class="main">×</span> bool"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> GlobalState <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Agent<span class="main">,</span> EnvState<span class="main">,</span> AgentState<span class="main">)</span> BEState"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">agents</span> <span class="main">≡</span> fromList <span class="main">[</span>Child0<span class="main">,</span> Child1<span class="main">,</span> Child2<span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">aChildIsDirty</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool <span class="main">⇒</span> bool <span class="main">⇒</span> bool <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">aChildIsDirty</span> False False False <span class="main">=</span> False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">aChildIsDirty</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> True"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">initPS</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool <span class="main">⇒</span> bool <span class="main">⇒</span> bool <span class="main">⇒</span> <span class="main">(</span>Agent <span class="main">×</span> <span class="main">(</span>bool <span class="main">×</span> bool <span class="main">×</span> bool<span class="main">)</span><span class="main">)</span> odlist"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">initPS</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="main">≡</span>
     <span class="keyword1">let</span> <span class="bound">acid</span> <span class="main">=</span> aChildIsDirty <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span>
      <span class="keyword1">in</span> fromList <span class="main">[</span> <span class="main">(</span>Child0<span class="main">,</span> <span class="main">(</span><span class="bound">acid</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>Child1<span class="main">,</span> <span class="main">(</span><span class="bound">acid</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>Child2<span class="main">,</span> <span class="main">(</span><span class="bound">acid</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">envInit</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"GlobalState list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">envInit</span> <span class="main">≡</span>
    <span class="keyword1">let</span> <span class="bound">bu</span> <span class="main">=</span> <span class="main">[</span>False<span class="main">,</span> True<span class="main">]</span>
     <span class="keyword1">in</span> <span class="main">[</span> <span class="main">⦇</span> es <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="bound">c0</span><span class="main">,</span> <span class="bound">c1</span><span class="main">,</span> <span class="bound">c2</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>SayNothing<span class="main">,</span> SayNothing<span class="main">,</span> SayNothing<span class="main">)</span><span class="main">)</span><span class="main">,</span> ps <span class="main">=</span> initPS <span class="bound">c0</span> <span class="bound">c1</span> <span class="bound">c2</span> <span class="main">⦈</span> <span class="main">.</span>
             c0 <span class="main">←</span> <span class="bound">bu</span><span class="main">,</span> c1 <span class="main">←</span> <span class="bound">bu</span><span class="main">,</span> c2 <span class="main">←</span> <span class="bound">bu</span> <span class="main">]</span>"</span></span>

<span class="comment1">(* The environment is passive, but it still needs to do something in
   each round for the system as a whole to evolve. *)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">envAction</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"GlobalState <span class="main">⇒</span> EnvAct list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">envAction</span> <span class="main">≡</span> <span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">[</span><span class="main">()</span><span class="main">]</span>"</span></span>

<span class="comment1">(* Transitions involve broadcasting the children's private actions,
leaving their private states unchanged. *)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">envTransES</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"EnvAct <span class="main">⇒</span> <span class="main">(</span>Agent <span class="main">⇒</span> ChildAct<span class="main">)</span> <span class="main">⇒</span> EnvState <span class="main">⇒</span> EnvState"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">envTransES</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">eAct</span> <span class="bound">aAct</span> <span class="bound">s</span><span class="main">.</span> <span class="main">(</span>fst <span class="bound">s</span><span class="main">,</span> <span class="bound">aAct</span> Child0<span class="main">,</span> <span class="bound">aAct</span> Child1<span class="main">,</span> <span class="bound">aAct</span> Child2<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">envTrans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"EnvAct <span class="main">⇒</span> <span class="main">(</span>Agent <span class="main">⇒</span> ChildAct<span class="main">)</span> <span class="main">⇒</span> GlobalState <span class="main">⇒</span> GlobalState"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">envTrans</span> <span class="free"><span class="bound"><span class="entity">eact</span></span></span> <span class="free"><span class="bound"><span class="entity">aact</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⦇</span> es <span class="main">:=</span> envTransES <span class="free"><span class="bound"><span class="entity">eact</span></span></span> <span class="free"><span class="bound"><span class="entity">aact</span></span></span> <span class="main">(</span>es <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">⦈</span>"</span></span>

<span class="comment1">(* Common observation: the actions of the agents. *)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">envObsC</span> <span class="main">≡</span> snd"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">envVal</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"GlobalState <span class="main">⇒</span> Proposition <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">envVal</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span>
     <span class="keyword1">case</span> <span class="bound">p</span> <span class="keyword1">of</span> Dirty <span class="bound">a</span> <span class="main">⇒</span>
       <span class="main">(</span><span class="keyword1">case</span> es <span class="bound">s</span> <span class="keyword1">of</span> <span class="main">(</span><span class="main">(</span><span class="bound">c0</span><span class="main">,</span> <span class="bound">c1</span><span class="main">,</span> <span class="bound">c2</span><span class="main">)</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span>
         <span class="main">(</span><span class="keyword1">case</span> <span class="bound">a</span> <span class="keyword1">of</span>
            Child0 <span class="main">⇒</span> <span class="bound">c0</span>
          <span class="main">|</span> Child1 <span class="main">⇒</span> <span class="bound">c1</span>
          <span class="main">|</span> Child2 <span class="main">⇒</span> <span class="bound">c2</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">(* FIXME This is a bit grot, this definition is already made for us in the locale. *)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">envObs</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">a</span> <span class="bound">s</span><span class="main">.</span> <span class="main">(</span>envObsC <span class="main">(</span>es <span class="bound">s</span><span class="main">)</span><span class="main">,</span> ODList.lookup <span class="main">(</span>ps <span class="bound">s</span><span class="main">)</span> <span class="bound">a</span><span class="main">)</span>"</span></span>

<span class="comment1">(* The KBP. Clearly subjective and deterministic. *)</span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Kor</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">≡</span> Knot <span class="main">(</span>Kand <span class="main">(</span>Knot <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span>Knot <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">jkbp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Agent <span class="main">⇒</span> <span class="main">(</span>Agent<span class="main">,</span> Proposition<span class="main">,</span> ChildAct<span class="main">)</span> KBP"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">jkbp</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="main">[</span> <span class="main">⦇</span> guard <span class="main">=</span> Kor <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>K</b>⇩</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>Kprop <span class="main">(</span>Dirty <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                            <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>K</b>⇩</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>Knot <span class="main">(</span>Kprop <span class="main">(</span>Dirty <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> action <span class="main">=</span> SayIKnow <span class="main">⦈</span><span class="main">,</span>
              <span class="main">⦇</span> guard <span class="main">=</span> Kand <span class="main">(</span>Knot <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>K</b>⇩</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>Kprop <span class="main">(</span>Dirty <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                             <span class="main">(</span>Knot <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>K</b>⇩</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>Knot <span class="main">(</span>Kprop <span class="main">(</span>Dirty <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> action <span class="main">=</span> SayNothing <span class="main">⦈</span> <span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Locale instantiations›</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> MC<span class="main">:</span> Environment <span class="quoted">jkbp</span> <span class="quoted">envInit</span> <span class="quoted">envAction</span> <span class="quoted">envTrans</span> <span class="quoted">envVal</span> <span class="quoted">envObs</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> jkbp_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹The Clock view implementation›</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> MC_Clock<span class="main">:</span>
  FiniteLinorderEnvironment <span class="quoted">jkbp</span> <span class="quoted">envInit</span> <span class="quoted">envAction</span> <span class="quoted">envTrans</span> <span class="quoted">envVal</span> <span class="quoted">envObs</span> <span class="quoted">agents</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Agent_univ agents_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">mc_ClockDFS</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mc_ClockDFS</span> <span class="main">≡</span> ClockAutoDFS agents jkbp envInit envAction envTrans envVal envObs"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">mc_ClockAlg</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mc_ClockAlg</span> <span class="main">≡</span> mkClockAuto agents jkbp envInit envAction envTrans envVal envObs"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> FiniteLinorderEnvironment<span class="main">)</span>
  <span class="quoted"><span class="quoted">"MC.Clock.implements mc_ClockAlg"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mc_ClockAlg_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> MC_Clock.mkClockAuto_implements<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹The SPR view implementation›</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> MC_SPR<span class="main">:</span>
  FiniteDetBroadcastEnvironment <span class="quoted">jkbp</span> <span class="quoted">envInit</span> <span class="quoted">envAction</span> <span class="quoted">envTrans</span> <span class="quoted">envVal</span> <span class="quoted">envObs</span> <span class="quoted">agents</span> <span class="quoted">envObsC</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 3
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fold</span> envObs_def envAction_def envTrans_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> MC.SPR.jkbpDetI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> jkbp_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> jkbp_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>

  <span class="keyword1"><span class="command">unfolding</span></span> envAction_def envTrans_def envObs_def agents_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Agent_univ jkbp_def<span class="main">)</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">mc_SPRDFS</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mc_SPRDFS</span> <span class="main">≡</span> SPRDetAutoDFS agents jkbp envInit envAction envTrans envVal envObsC envObs"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">mc_SPRAlg</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mc_SPRAlg</span> <span class="main">≡</span> mkSPRDetAuto agents jkbp envInit envAction envTrans envVal envObsC envObs"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> FiniteDetBroadcastEnvironment<span class="main">)</span>
  <span class="quoted"><span class="quoted">"MC.SPR.implements mc_SPRAlg"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mc_SPRAlg_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> MC_SPR.mkSPRDetAuto_implements<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="Robot">
<div class="head">
<h1>Theory Robot</h1>
</div>
<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="comment1">(*
 * Knowledge-based programs.
 * (C)opyright 2011, Peter Gammie, peteg42 at gmail.com.
 * License: BSD
 *)</span>

<span class="keyword1"><span class="command">theory</span></span> Robot
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="#ClockView">ClockView</a>
  <a href="#SPRViewSingle">SPRViewSingle</a>
  <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Saturated.html">HOL-Library.Saturated</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹The Robot›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
\label{sec:kbps-theory-robot}

\begin{figure}[tb]
 \includegraphics[width=\textwidth]{robot_clock}
 \caption{The implementation of the robot using the clock semantics.}
 \label{fig:kbps-theory-robot-clock}
\end{figure}

\begin{figure}[tb]
 \includegraphics[width=\textwidth]{robot_spr}
 \caption{The implementation of the robot using the SPR semantics.}
 \label{fig:kbps-theory-robot-spr}
\end{figure}

Recall the autonomous robot of \S\ref{sec:kbps-robot-intro}: we are
looking for an implementation of the KBP:
\begin{center}
  \begin{tabular}{lll}
    $\mathbf{do}$\\
     &amp; $\gcalt$ $\mathbf{K}_{\mbox{robot}}$ \textsf{goal} &amp; $\rightarrow$ \textsf{Halt}\\
     &amp; $\gcalt$ $\lnot\mathbf{K}_{\mbox{robot}}$ \textsf{goal} &amp; $\rightarrow$ \textsf{Nothing}\\
    $\mathbf{od}$\\
  \end{tabular}
\end{center}
in an environment where positions are identified with the natural
numbers, the robot's sensor is within one of the position, and the
proposition \textsf{goal} is true when the position is in
$\{2,3,4\}$. The robot is initially at position zero, and the effect
of its \textsf{Halt} action is to cause the robot to instantaneously
stop at its current position. A later \textsf{Nothing}
action may allow the environment to move the robot further to the
right.

To obtain a finite environment, we truncate the number line at 5,
which is intuitively sound for determinining the robot's behaviour due
to the synchronous view, and the fact that if it reaches this
rightmost position then it can never satisfy its objective.  Running
the Haskell code generated by Isabelle yields the automata shown in
Figure~\ref{fig:kbps-theory-robot-clock} and
Figure~\ref{fig:kbps-theory-robot-spr} for the clock and synchronous
perfect recall semantics respectively. These have been minimised using
Hopcroft's algorithm \citep{DBLP:journals/acta/Gries73}.

The (inessential) labels on the states are an upper bound on the set
of positions that the robot considers possible when it is in that
state. Transitions are annotated with the observations yielded by the
sensor. Double-circled states are those in which the robot performs
the \textsf{Halt} action, the others \textsf{Nothing}. We observe that
the synchronous perfect-recall view yields a ``ratchet'' protocol,
i.e. if the robot learns that it is in the goal region then it halts
for all time, and that it never overshoots the goal region. Conversely
the clock semantics allows the robot to infinitely alternate its
actions depending on the sensor reading. This is effectively the
behaviour of the intuitive implementation that halts iff the sensor
reads three or more.

We can also see that minimisation does not yield the smallest automata
we could hope for; in particular there are a lot of redundant states
where the prescribed behaviour is the same but the robot's state of
knowledge different. This is because our implementations do not
specify what happens on invalid observations, which we have modelled
as errors instead of don't-cares, and these extraneous distinctions
are preserved by bisimulation reduction. We discuss this further in
\S\ref{sec:kbps-alg-auto-min}.

›</span></span><span class="comment1">(*&lt;*)</span>

<span class="comment1">(*

The environment protocol does nothing if the robot has signalled halt,
or chooses a new position and sensor reading if it hasn't.

We need a finite type to represent positions and observations. It is
sufficient to go to 5, for by then we are either halted in the goal
region or have gone past it.

*)</span>

<span class="keyword1"><span class="command">type_synonym</span></span> digit <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="numeral">5</span> sat"</span></span>

<span class="keyword1"><span class="command">datatype</span></span> Agent <span class="main">=</span> Robot
<span class="keyword1"><span class="command">datatype</span></span> EnvAct <span class="main">=</span> Stay <span class="main">|</span> MoveRight
<span class="keyword1"><span class="command">datatype</span></span> ObsError <span class="main">=</span> Left <span class="main">|</span> On <span class="main">|</span> Right
<span class="keyword1"><span class="command">datatype</span></span> Proposition <span class="main">=</span> Halted <span class="main">|</span> InGoal
<span class="keyword1"><span class="command">datatype</span></span> RobotAct <span class="main">=</span> NOP <span class="main">|</span> Halt

<span class="keyword1"><span class="command">type_synonym</span></span> Halted <span class="main">=</span> <span class="quoted">bool</span>
<span class="keyword1"><span class="command">type_synonym</span></span> Pos <span class="main">=</span> <span class="quoted">digit</span>
<span class="keyword1"><span class="command">type_synonym</span></span> Obs <span class="main">=</span> <span class="quoted">digit</span>
<span class="keyword1"><span class="command">type_synonym</span></span> EnvState <span class="main">=</span> <span class="quoted"><span class="quoted">"Pos <span class="main">×</span> Obs <span class="main">×</span> Halted"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">envInit</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"EnvState list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">envInit</span> <span class="main">≡</span> <span class="main">[</span><span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span> False<span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">1</span><span class="main">,</span> False<span class="main">)</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">envAction</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"EnvState <span class="main">⇒</span> <span class="main">(</span>EnvAct <span class="main">×</span> ObsError<span class="main">)</span> list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">envAction</span> <span class="main">≡</span> <span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">[</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">.</span> x <span class="main">←</span> <span class="main">[</span>Stay<span class="main">,</span> MoveRight<span class="main">]</span><span class="main">,</span> y <span class="main">←</span> <span class="main">[</span>Left<span class="main">,</span> On<span class="main">,</span> Right<span class="main">]</span> <span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">newObs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"digit <span class="main">⇒</span> ObsError <span class="main">⇒</span> digit"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">newObs</span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="free"><span class="bound"><span class="entity">obserr</span></span></span> <span class="main">≡</span>
              <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">obserr</span></span></span> <span class="keyword1">of</span> Left <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="main">-</span> <span class="main">1</span> <span class="main">|</span> On <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="main">|</span> Right <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="main">+</span> <span class="main">1</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">envTrans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"EnvAct <span class="main">×</span> ObsError <span class="main">⇒</span> <span class="main">(</span>Agent <span class="main">⇒</span> RobotAct<span class="main">)</span> <span class="main">⇒</span> EnvState <span class="main">⇒</span> EnvState"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">envTrans</span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">move</span><span class="main">,</span> <span class="bound">obserr</span><span class="main">)</span> <span class="bound">aact</span> <span class="main">(</span><span class="bound">pos</span><span class="main">,</span> <span class="bound">obs</span><span class="main">,</span> <span class="bound">halted</span><span class="main">)</span><span class="main">.</span>
    <span class="keyword1">if</span> <span class="bound">halted</span>
      <span class="keyword1">then</span> <span class="main">(</span><span class="bound">pos</span><span class="main">,</span> newObs <span class="bound">pos</span> <span class="bound">obserr</span><span class="main">,</span> <span class="bound">halted</span><span class="main">)</span>
      <span class="keyword1">else</span>
        <span class="keyword1">case</span> <span class="bound">aact</span> Robot <span class="keyword1">of</span>
           NOP <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">move</span> <span class="keyword1">of</span>
                      Stay <span class="main">⇒</span> <span class="main">(</span><span class="bound">pos</span><span class="main">,</span> newObs <span class="bound">pos</span> <span class="bound">obserr</span><span class="main">,</span> False<span class="main">)</span>
                    <span class="main">|</span> MoveRight <span class="main">⇒</span> <span class="main">(</span><span class="bound">pos</span> <span class="main">+</span> <span class="main">1</span><span class="main">,</span> newObs <span class="main">(</span><span class="bound">pos</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="bound">obserr</span><span class="main">,</span> False<span class="main">)</span><span class="main">)</span>
         <span class="main">|</span> Halt <span class="main">⇒</span> <span class="main">(</span><span class="bound">pos</span><span class="main">,</span> newObs <span class="bound">pos</span> <span class="bound">obserr</span><span class="main">,</span> True<span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">envObs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"EnvState <span class="main">⇒</span> Obs"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">envObs</span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">pos</span><span class="main">,</span> <span class="bound">obs</span><span class="main">,</span> <span class="bound">halted</span><span class="main">)</span><span class="main">.</span> <span class="bound">obs</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">envVal</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"EnvState <span class="main">⇒</span> Proposition <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">envVal</span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">pos</span><span class="main">,</span> <span class="bound">obs</span><span class="main">,</span> <span class="bound">halted</span><span class="main">)</span> <span class="bound">p</span><span class="main">.</span>
     <span class="keyword1">case</span> <span class="bound">p</span> <span class="keyword1">of</span> Halted <span class="main">⇒</span> <span class="bound">halted</span>
             <span class="main">|</span> InGoal <span class="main">⇒</span> <span class="numeral">2</span> <span class="main">≤</span> <span class="bound">pos</span> <span class="main">∧</span> <span class="bound">pos</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">::</span> <span class="numeral">5</span> sat<span class="main">)</span>"</span></span>

<span class="comment1">(* The KBP, clearly subjective. *)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">kbp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Agent<span class="main">,</span> Proposition<span class="main">,</span> RobotAct<span class="main">)</span> KBP"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">kbp</span> <span class="main">≡</span> <span class="main">[</span> <span class="main">⦇</span> guard <span class="main">=</span> <span class="keyword1"><span class="hidden">❙</span><b>K</b>⇩</span>Robot <span class="main">(</span>Kprop InGoal<span class="main">)</span><span class="main">,</span>        action <span class="main">=</span> Halt <span class="main">⦈</span><span class="main">,</span>
           <span class="main">⦇</span> guard <span class="main">=</span> Knot <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>K</b>⇩</span>Robot <span class="main">(</span>Kprop InGoal<span class="main">)</span><span class="main">)</span><span class="main">,</span> action <span class="main">=</span> NOP <span class="main">⦈</span> <span class="main">]</span>"</span></span>

<span class="comment1">(*&lt;*)</span>

<span class="keyword1" id="Robot-Agent_univ"><span class="command">lemma</span></span> Agent_univ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>UNIV <span class="main">::</span> Agent set<span class="main">)</span> <span class="main">=</span> <span class="main">{</span>Robot<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> UNIV_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">instance</span></span> Agent <span class="main">::</span> <span class="quoted">finite</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">intro_classes</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> Agent_univ<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">instantiation</span></span> Agent <span class="main">::</span> <span class="quoted">linorder</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  less_Agent_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">::</span>Agent<span class="main">)</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> False"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  less_eq_Agent_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">::</span>Agent<span class="main">)</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">intro_classes</span>
  <span class="keyword1"><span class="command">unfolding</span></span> less_Agent_def less_eq_Agent_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">y</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Locale instantiations›</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> Robot<span class="main">:</span>
  Environment <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> kbp"</span></span> <span class="quoted">envInit</span> <span class="quoted">envAction</span> <span class="quoted">envTrans</span> <span class="quoted">envVal</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> envObs"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> kbp_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper">a</span></span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹The Clock view implementation›</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> Robot_Clock<span class="main">:</span>
  FiniteLinorderEnvironment <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> kbp"</span></span> <span class="quoted">envInit</span> <span class="quoted">envAction</span> <span class="quoted">envTrans</span> <span class="quoted">envVal</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> envObs"</span></span> <span class="quoted"><span class="quoted">"fromList <span class="main">[</span>Robot<span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Agent_univ<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">Agents</span> <span class="main">≡</span> ODList.fromList <span class="main">[</span>Robot<span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">robot_ClockDFS</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>EnvState<span class="main">,</span> RobotAct list<span class="main">)</span> clock_acts_trie<span class="main">,</span> <span class="main">(</span>EnvState<span class="main">,</span> digit<span class="main">)</span> clock_trans_trie<span class="main">)</span> AlgState"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">robot_ClockDFS</span> <span class="main">≡</span> ClockAutoDFS Agents <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> kbp<span class="main">)</span> envInit envAction envTrans envVal <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> envObs<span class="main">)</span> Robot"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">robot_ClockAlg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Agent <span class="main">⇒</span> <span class="main">(</span>digit<span class="main">,</span> RobotAct<span class="main">,</span> EnvState odlist <span class="main">×</span> EnvState odlist<span class="main">)</span> Protocol"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">robot_ClockAlg</span> <span class="main">≡</span> mkClockAuto Agents <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> kbp<span class="main">)</span> envInit envAction envTrans envVal <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> envObs<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> FiniteLinorderEnvironment<span class="main">)</span>
  <span class="quoted"><span class="quoted">"Robot.Clock.implements robot_ClockAlg"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> robot_ClockAlg_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Robot_Clock.mkClockAuto_implements<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹The SPR view implementation›</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> Robot_SPR<span class="main">:</span>
  FiniteSingleAgentEnvironment <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> kbp"</span></span> <span class="quoted">envInit</span> <span class="quoted">envAction</span> <span class="quoted">envTrans</span> <span class="quoted">envVal</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> envObs"</span></span> <span class="quoted"><span class="quoted">"Robot"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">a</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">robot_SPRSingleDFS</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>RobotAct<span class="main">,</span> digit<span class="main">,</span> EnvState<span class="main">)</span> SPRSingleAutoDFS"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">robot_SPRSingleDFS</span> <span class="main">≡</span> SPRSingleAutoDFS kbp envInit envAction envTrans envVal <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> envObs<span class="main">)</span> Robot"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">robot_SPRSingleAlg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Agent <span class="main">⇒</span> <span class="main">(</span>digit<span class="main">,</span> RobotAct<span class="main">,</span> EnvState odlist<span class="main">)</span> Protocol"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">robot_SPRSingleAlg</span> <span class="main">≡</span> mkSPRSingleAuto kbp envInit envAction envTrans envVal <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> envObs<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> FiniteSingleAgentEnvironment<span class="main">)</span>
  <span class="quoted"><span class="quoted">"Robot.Robot.SPR.implements robot_SPRSingleAlg"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> robot_SPRSingleAlg_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Robot.Robot_SPR.mkSPRSingleAuto_implements<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="Examples">
<div class="head">
<h1>Theory Examples</h1>
</div>
<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="comment1">(*
 * Knowledge-based programs.
 * (C)opyright 2011, Peter Gammie, peteg42 at gmail.com.
 * License: BSD
 *)</span>

<span class="keyword1"><span class="command">theory</span></span> Examples
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="#MuddyChildren">MuddyChildren</a>
  <a href="#Robot">Robot</a>
  <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/AList_Mapping.html">HOL-Library.AList_Mapping</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(* Just verify that code generation works. *)</span>

<span class="keyword1"><span class="command">export_code</span></span>
  <span class="quoted"><span class="quoted"><span class="quoted">"mc_ClockDFS"</span></span></span>
  <span class="quoted"><span class="quoted"><span class="quoted">"mc_ClockAlg"</span></span></span>
  <span class="quoted"><span class="quoted"><span class="quoted">"mc_SPRDFS"</span></span></span>
  <span class="quoted"><span class="quoted"><span class="quoted">"mc_SPRAlg"</span></span></span>

  <span class="quoted"><span class="quoted"><span class="quoted">"robot_ClockDFS"</span></span></span>
  <span class="quoted"><span class="quoted"><span class="quoted">"robot_ClockAlg"</span></span></span>
  <span class="quoted"><span class="quoted"><span class="quoted">"robot_SPRSingleDFS"</span></span></span>
  <span class="quoted"><span class="quoted"><span class="quoted">"robot_SPRSingleAlg"</span></span></span>
<span class="keyword2"><span class="keyword">in</span></span> Haskell <span class="main">(</span>string_classes<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="KBPs_Main">
<div class="head">
<h1>Theory KBPs_Main</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> KBPs_Main
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="#Views">Views</a>
  <a href="#Examples">Examples</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>