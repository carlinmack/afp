<div id="IMAP-def">
<div class="head">
<h1>Theory IMAP-def</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹IMAP-CRDT Definitions›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹We begin by defining the operations on a mailbox state. In addition to the interpretation of 
the operations, we define valid behaviours for the operations as assumptions for the network.
We use the \texttt{network\_with\_constrained\_ops} locale from the framework.›</span></span>

<span class="keyword1"><span class="command">theory</span></span>
  <span class="quoted">"IMAP-def"</span>
  <span class="keyword2"><span class="keyword">imports</span></span>
    <span class="quoted">"<a href="../../crdt/theories/#Network">CRDT.Network</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'id</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> operation <span class="main">=</span> 
  Create <span class="quoted"><span class="quoted">"<span class="tfree">'id</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span>"</span></span> <span class="main">|</span> 
  Delete <span class="quoted"><span class="quoted">"<span class="tfree">'id</span> set"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span>"</span></span> <span class="main">|</span> 
  Append <span class="quoted"><span class="quoted">"<span class="tfree">'id</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span>"</span></span> <span class="main">|</span> 
  Expunge <span class="quoted"><span class="quoted">"<span class="tfree">'a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'id</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'id</span>"</span></span> <span class="main">|</span> 
  Store <span class="quoted"><span class="quoted">"<span class="tfree">'a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'id</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'id</span>"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'id</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> state <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'id</span> set <span class="main">×</span> <span class="tfree">'id</span> set<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">op_elem</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'id</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> operation <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">op_elem</span> <span class="free"><span class="bound"><span class="entity">oper</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">oper</span></span></span> <span class="keyword1">of</span> 
    Create <span class="bound">i</span> <span class="bound">e</span> <span class="main">⇒</span> <span class="bound">e</span> <span class="main">|</span> 
    Delete <span class="bound">is</span> <span class="bound">e</span> <span class="main">⇒</span> <span class="bound">e</span> <span class="main">|</span> 
    Append <span class="bound">i</span> <span class="bound">e</span> <span class="main">⇒</span> <span class="bound">e</span> <span class="main">|</span> 
    Expunge <span class="bound">e</span> <span class="bound">mo</span> <span class="bound">i</span> <span class="main">⇒</span> <span class="bound">e</span> <span class="main">|</span> 
    Store <span class="bound">e</span> <span class="bound">mo</span> <span class="bound">i</span> <span class="main">⇒</span> <span class="bound">e</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">interpret_op</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'id</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> operation <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'id</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> state <span class="main">⇀</span> <span class="main">(</span><span class="tfree">'id</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> state"</span></span> 
  <span class="main">(</span><span class="quoted">"<span class="keyword1">⟨</span>_<span class="keyword1">⟩</span>"</span> <span class="main">[</span>0<span class="main">]</span> 1000<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">interpret_op</span> <span class="free"><span class="bound"><span class="entity">oper</span></span></span> <span class="free"><span class="bound"><span class="entity">state</span></span></span> <span class="main">≡</span>
    <span class="keyword1">let</span> <span class="bound">metadata</span> <span class="main">=</span> fst <span class="main">(</span><span class="free"><span class="bound"><span class="entity">state</span></span></span> <span class="main">(</span>op_elem <span class="free"><span class="bound"><span class="entity">oper</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
        <span class="bound">files</span> <span class="main">=</span> snd <span class="main">(</span><span class="free"><span class="bound"><span class="entity">state</span></span></span> <span class="main">(</span>op_elem <span class="free"><span class="bound"><span class="entity">oper</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
        <span class="bound">after</span>  <span class="main">=</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">oper</span></span></span> <span class="keyword1">of</span> 
          Create <span class="bound">i</span> <span class="bound">e</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">metadata</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">i</span><span class="main">}</span><span class="main">,</span> <span class="bound">files</span><span class="main">)</span> <span class="main">|</span>
          Delete <span class="bound">is</span> <span class="bound">e</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">metadata</span> <span class="main">-</span> <span class="bound">is</span><span class="main">,</span> <span class="bound">files</span> <span class="main">-</span> <span class="bound">is</span><span class="main">)</span> <span class="main">|</span>
          Append <span class="bound">i</span> <span class="bound">e</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">metadata</span><span class="main">,</span> <span class="bound">files</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">i</span><span class="main">}</span><span class="main">)</span> <span class="main">|</span>
          Expunge <span class="bound">e</span> <span class="bound">mo</span> <span class="bound">i</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">metadata</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">i</span><span class="main">}</span><span class="main">,</span> <span class="bound">files</span> <span class="main">-</span> <span class="main">{</span><span class="bound">mo</span><span class="main">}</span><span class="main">)</span> <span class="main">|</span>
          Store <span class="bound">e</span> <span class="bound">mo</span> <span class="bound">i</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">metadata</span><span class="main">,</span> insert <span class="bound">i</span> <span class="main">(</span><span class="bound">files</span> <span class="main">-</span> <span class="main">{</span><span class="bound">mo</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1">in</span>  Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">state</span></span></span> <span class="main">(</span><span class="main">(</span>op_elem <span class="free"><span class="bound"><span class="entity">oper</span></span></span><span class="main">)</span> <span class="main">:=</span> <span class="bound">after</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹In the definition of the valid behaviours of the operations, we define additional assumption 
the state where the operation is executed. In essence, a the tag of a \create, \append, \expunge,  
and \store\ operation is identical to the message number and therefore unique. A \delete\ operation 
deletes all metadata and the content of a folder. The \store\ and \expunge\ operations must refer 
to an existing message.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">valid_behaviours</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'id</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> state <span class="main">⇒</span> <span class="tfree">'id</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'id</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> operation <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">valid_behaviours</span> <span class="free"><span class="bound"><span class="entity">state</span></span></span> <span class="free"><span class="bound"><span class="entity">msg</span></span></span> <span class="main">≡</span>
    <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">msg</span></span></span> <span class="keyword1">of</span>
      <span class="main">(</span><span class="bound">i</span><span class="main">,</span> Create <span class="bound">j</span> <span class="bound">e</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">j</span> <span class="main">|</span>
      <span class="main">(</span><span class="bound">i</span><span class="main">,</span> Delete <span class="bound">is</span> <span class="bound">e</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">is</span> <span class="main">=</span> fst <span class="main">(</span><span class="free"><span class="bound"><span class="entity">state</span></span></span> <span class="bound">e</span><span class="main">)</span> <span class="main">∪</span> snd <span class="main">(</span><span class="free"><span class="bound"><span class="entity">state</span></span></span> <span class="bound">e</span><span class="main">)</span> <span class="main">|</span>
      <span class="main">(</span><span class="bound">i</span><span class="main">,</span> Append <span class="bound">j</span> <span class="bound">e</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">j</span> <span class="main">|</span>
      <span class="main">(</span><span class="bound">i</span><span class="main">,</span> Expunge <span class="bound">e</span> <span class="bound">mo</span> <span class="bound">j</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">j</span> <span class="main">∧</span> <span class="bound">mo</span> <span class="main">∈</span> snd <span class="main">(</span><span class="free"><span class="bound"><span class="entity">state</span></span></span> <span class="bound">e</span><span class="main">)</span> <span class="main">|</span>
      <span class="main">(</span><span class="bound">i</span><span class="main">,</span> Store <span class="bound">e</span> <span class="bound">mo</span> <span class="bound">j</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">j</span> <span class="main">∧</span> <span class="bound">mo</span> <span class="main">∈</span> snd <span class="main">(</span><span class="free"><span class="bound"><span class="entity">state</span></span></span> <span class="bound">e</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> imap <span class="main">=</span> network_with_constrained_ops _ <span class="quoted">interpret_op</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">{}</span><span class="main">,</span><span class="main">{}</span><span class="main">)</span>"</span></span> <span class="quoted">valid_behaviours</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="IMAP-proof-commute">
<div class="head">
<h1>Theory IMAP-proof-commute</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Commutativity of IMAP Commands›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹In this section we prove the commutativity of operations and identify the edge cases.›</span></span>

<span class="keyword1"><span class="command">theory</span></span>
  <span class="quoted">"IMAP-proof-commute"</span>
  <span class="keyword2"><span class="keyword">imports</span></span>
    <span class="quoted">"<a href="IMAP-def.html">IMAP-def</a>"</span>  
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> imap<span class="main">)</span> create_create_commute<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>Create <span class="free">i1</span> <span class="free">e1</span><span class="main">⟩</span> <span class="main">⊳</span> <span class="main">⟨</span>Create <span class="free">i2</span> <span class="free">e2</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">⟨</span>Create <span class="free">i2</span> <span class="free">e2</span><span class="main">⟩</span> <span class="main">⊳</span> <span class="main">⟨</span>Create <span class="free">i1</span> <span class="free">e1</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interpret_op_def op_elem_def kleisli_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> imap<span class="main">)</span> create_delete_commute<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∉</span> <span class="free">is</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>Create <span class="free">i</span> <span class="free">e1</span><span class="main">⟩</span> <span class="main">⊳</span> <span class="main">⟨</span>Delete <span class="free">is</span> <span class="free">e2</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">⟨</span>Delete <span class="free">is</span> <span class="free">e2</span><span class="main">⟩</span> <span class="main">⊳</span> <span class="main">⟨</span>Create <span class="free">i</span> <span class="free">e1</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interpret_op_def kleisli_def op_elem_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> imap<span class="main">)</span> create_append_commute<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>Create <span class="free">i1</span> <span class="free">e1</span><span class="main">⟩</span> <span class="main">⊳</span> <span class="main">⟨</span>Append <span class="free">i2</span> <span class="free">e2</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">⟨</span>Append <span class="free">i2</span> <span class="free">e2</span><span class="main">⟩</span> <span class="main">⊳</span> <span class="main">⟨</span>Create <span class="free">i1</span> <span class="free">e1</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interpret_op_def op_elem_def kleisli_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> imap<span class="main">)</span> create_expunge_commute<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>Create <span class="free">i1</span> <span class="free">e1</span><span class="main">⟩</span> <span class="main">⊳</span> <span class="main">⟨</span>Expunge <span class="free">e2</span> <span class="free">mo</span> <span class="free">i2</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">⟨</span>Expunge <span class="free">e2</span> <span class="free">mo</span> <span class="free">i2</span><span class="main">⟩</span> <span class="main">⊳</span> <span class="main">⟨</span>Create <span class="free">i1</span> <span class="free">e1</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interpret_op_def op_elem_def kleisli_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> imap<span class="main">)</span> create_store_commute<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>Create <span class="free">i1</span> <span class="free">e1</span><span class="main">⟩</span> <span class="main">⊳</span> <span class="main">⟨</span>Store <span class="free">e2</span> <span class="free">mo</span> <span class="free">i2</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">⟨</span>Store <span class="free">e2</span> <span class="free">mo</span> <span class="free">i2</span><span class="main">⟩</span> <span class="main">⊳</span> <span class="main">⟨</span>Create <span class="free">i1</span> <span class="free">e1</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interpret_op_def op_elem_def kleisli_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> imap<span class="main">)</span> delete_delete_commute<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>Delete <span class="free">i1</span> <span class="free">e1</span><span class="main">⟩</span> <span class="main">⊳</span> <span class="main">⟨</span>Delete <span class="free">i2</span> <span class="free">e2</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">⟨</span>Delete <span class="free">i2</span> <span class="free">e2</span><span class="main">⟩</span> <span class="main">⊳</span> <span class="main">⟨</span>Delete <span class="free">i1</span> <span class="free">e1</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">unfold</span> interpret_op_def op_elem_def kleisli_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> imap<span class="main">)</span> delete_append_commute<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∉</span> <span class="free">is</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>Delete <span class="free">is</span> <span class="free">e1</span><span class="main">⟩</span> <span class="main">⊳</span> <span class="main">⟨</span>Append <span class="free">i</span> <span class="free">e2</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">⟨</span>Append <span class="free">i</span> <span class="free">e2</span><span class="main">⟩</span> <span class="main">⊳</span> <span class="main">⟨</span>Delete <span class="free">is</span> <span class="free">e1</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interpret_op_def kleisli_def op_elem_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> imap<span class="main">)</span> delete_expunge_commute<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∉</span> <span class="free">is</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>Delete <span class="free">is</span> <span class="free">e1</span><span class="main">⟩</span> <span class="main">⊳</span> <span class="main">⟨</span>Expunge <span class="free">e2</span> <span class="free">mo</span> <span class="free">i</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">⟨</span>Expunge <span class="free">e2</span> <span class="free">mo</span> <span class="free">i</span><span class="main">⟩</span> <span class="main">⊳</span> <span class="main">⟨</span>Delete <span class="free">is</span> <span class="free">e1</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interpret_op_def kleisli_def op_elem_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> imap<span class="main">)</span> delete_store_commute<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∉</span> <span class="free">is</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>Delete <span class="free">is</span> <span class="free">e1</span><span class="main">⟩</span> <span class="main">⊳</span> <span class="main">⟨</span>Store <span class="free">e2</span> <span class="free">mo</span> <span class="free">i</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">⟨</span>Store <span class="free">e2</span> <span class="free">mo</span> <span class="free">i</span><span class="main">⟩</span> <span class="main">⊳</span> <span class="main">⟨</span>Delete <span class="free">is</span> <span class="free">e1</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interpret_op_def kleisli_def op_elem_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> imap<span class="main">)</span> append_append_commute<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>Append <span class="free">i1</span> <span class="free">e1</span><span class="main">⟩</span> <span class="main">⊳</span> <span class="main">⟨</span>Append <span class="free">i2</span> <span class="free">e2</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">⟨</span>Append <span class="free">i2</span> <span class="free">e2</span><span class="main">⟩</span> <span class="main">⊳</span> <span class="main">⟨</span>Append <span class="free">i1</span> <span class="free">e1</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interpret_op_def op_elem_def kleisli_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> imap<span class="main">)</span> append_expunge_commute<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i1</span> <span class="main">≠</span> <span class="free">mo</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⟨</span>Append <span class="free">i1</span> <span class="free">e1</span><span class="main">⟩</span> <span class="main">⊳</span> <span class="main">⟨</span>Expunge <span class="free">e2</span> <span class="free">mo</span> <span class="free">i2</span><span class="main">⟩</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⟨</span>Expunge <span class="free">e2</span> <span class="free">mo</span> <span class="free">i2</span><span class="main">⟩</span> <span class="main">⊳</span> <span class="main">⟨</span>Append <span class="free">i1</span> <span class="free">e1</span><span class="main">⟩</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⟨</span>Append <span class="free">i1</span> <span class="free">e1</span><span class="main">⟩</span> <span class="main">⊳</span> <span class="main">⟨</span>Expunge <span class="free">e2</span> <span class="free">mo</span> <span class="free">i2</span><span class="main">⟩</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">⟨</span>Expunge <span class="free">e2</span> <span class="free">mo</span> <span class="free">i2</span><span class="main">⟩</span> <span class="main">⊳</span> <span class="main">⟨</span>Append <span class="free">i1</span> <span class="free">e1</span><span class="main">⟩</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interpret_op_def kleisli_def op_elem_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> imap<span class="main">)</span> append_store_commute<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i1</span> <span class="main">≠</span> <span class="free">mo</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⟨</span>Append <span class="free">i1</span> <span class="free">e1</span><span class="main">⟩</span> <span class="main">⊳</span> <span class="main">⟨</span>Store <span class="free">e2</span> <span class="free">mo</span> <span class="free">i2</span><span class="main">⟩</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⟨</span>Store <span class="free">e2</span> <span class="free">mo</span> <span class="free">i2</span><span class="main">⟩</span> <span class="main">⊳</span> <span class="main">⟨</span>Append <span class="free">i1</span> <span class="free">e1</span><span class="main">⟩</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⟨</span>Append <span class="free">i1</span> <span class="free">e1</span><span class="main">⟩</span> <span class="main">⊳</span> <span class="main">⟨</span>Store <span class="free">e2</span> <span class="free">mo</span> <span class="free">i2</span><span class="main">⟩</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">⟨</span>Store <span class="free">e2</span> <span class="free">mo</span> <span class="free">i2</span><span class="main">⟩</span> <span class="main">⊳</span> <span class="main">⟨</span>Append <span class="free">i1</span> <span class="free">e1</span><span class="main">⟩</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interpret_op_def kleisli_def op_elem_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> imap<span class="main">)</span> expunge_expunge_commute<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⟨</span>Expunge <span class="free">e1</span> <span class="free">mo1</span> <span class="free">i1</span><span class="main">⟩</span> <span class="main">⊳</span> <span class="main">⟨</span>Expunge <span class="free">e2</span> <span class="free">mo2</span> <span class="free">i2</span><span class="main">⟩</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⟨</span>Expunge <span class="free">e2</span> <span class="free">mo2</span> <span class="free">i2</span><span class="main">⟩</span> <span class="main">⊳</span> <span class="main">⟨</span>Expunge <span class="free">e1</span> <span class="free">mo1</span> <span class="free">i1</span><span class="main">⟩</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⟨</span>Expunge <span class="free">e1</span> <span class="free">mo1</span> <span class="free">i1</span><span class="main">⟩</span> <span class="main">⊳</span> <span class="main">⟨</span>Expunge <span class="free">e2</span> <span class="free">mo2</span> <span class="free">i2</span><span class="main">⟩</span><span class="main">)</span> <span class="skolem">x</span> 
       <span class="main">=</span> <span class="main">(</span><span class="main">⟨</span>Expunge <span class="free">e2</span> <span class="free">mo2</span> <span class="free">i2</span><span class="main">⟩</span> <span class="main">⊳</span> <span class="main">⟨</span>Expunge <span class="free">e1</span> <span class="free">mo1</span> <span class="free">i1</span><span class="main">⟩</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interpret_op_def kleisli_def op_elem_def<span class="main">)</span> <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> imap<span class="main">)</span> expunge_store_commute<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i1</span> <span class="main">≠</span> <span class="free">mo2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i2</span> <span class="main">≠</span> <span class="free">mo1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⟨</span>Expunge <span class="free">e1</span> <span class="free">mo1</span> <span class="free">i1</span><span class="main">⟩</span> <span class="main">⊳</span> <span class="main">⟨</span>Store <span class="free">e2</span> <span class="free">mo2</span> <span class="free">i2</span><span class="main">⟩</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⟨</span>Store <span class="free">e2</span> <span class="free">mo2</span> <span class="free">i2</span><span class="main">⟩</span> <span class="main">⊳</span> <span class="main">⟨</span>Expunge <span class="free">e1</span> <span class="free">mo1</span> <span class="free">i1</span><span class="main">⟩</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⟨</span>Expunge <span class="free">e1</span> <span class="free">mo1</span> <span class="free">i1</span><span class="main">⟩</span> <span class="main">⊳</span> <span class="main">⟨</span>Store <span class="free">e2</span> <span class="free">mo2</span> <span class="free">i2</span><span class="main">⟩</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">⟨</span>Store <span class="free">e2</span> <span class="free">mo2</span> <span class="free">i2</span><span class="main">⟩</span> <span class="main">⊳</span> <span class="main">⟨</span>Expunge <span class="free">e1</span> <span class="free">mo1</span> <span class="free">i1</span><span class="main">⟩</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span>  interpret_op_def kleisli_def op_elem_def <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> imap<span class="main">)</span> store_store_commute<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i1</span> <span class="main">≠</span> <span class="free">mo2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i2</span> <span class="main">≠</span> <span class="free">mo1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⟨</span>Store <span class="free">e1</span> <span class="free">mo1</span> <span class="free">i1</span><span class="main">⟩</span> <span class="main">⊳</span> <span class="main">⟨</span>Store <span class="free">e2</span> <span class="free">mo2</span> <span class="free">i2</span><span class="main">⟩</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⟨</span>Store <span class="free">e2</span> <span class="free">mo2</span> <span class="free">i2</span><span class="main">⟩</span> <span class="main">⊳</span> <span class="main">⟨</span>Store <span class="free">e1</span> <span class="free">mo1</span> <span class="free">i1</span><span class="main">⟩</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⟨</span>Store <span class="free">e1</span> <span class="free">mo1</span> <span class="free">i1</span><span class="main">⟩</span> <span class="main">⊳</span> <span class="main">⟨</span>Store <span class="free">e2</span> <span class="free">mo2</span> <span class="free">i2</span><span class="main">⟩</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">⟨</span>Store <span class="free">e2</span> <span class="free">mo2</span> <span class="free">i2</span><span class="main">⟩</span> <span class="main">⊳</span> <span class="main">⟨</span>Store <span class="free">e1</span> <span class="free">mo1</span> <span class="free">i1</span><span class="main">⟩</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span>  interpret_op_def kleisli_def op_elem_def <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="IMAP-proof-helpers">
<div class="head">
<h1>Theory IMAP-proof-helpers</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Proof Helpers›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹In this section we define and prove lemmas that help to show that all identified critical 
conditions hold for concurrent operations. Many of the following parts are derivations from the 
definitions and lemmas of Gomes et al.›</span></span>

<span class="keyword1"><span class="command">theory</span></span>
  <span class="quoted">"IMAP-proof-helpers"</span>
  <span class="keyword2"><span class="keyword">imports</span></span>
    <span class="quoted">"<a href="IMAP-def.html">IMAP-def</a>"</span>  

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> imap<span class="main">)</span> apply_operations_never_fails<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"apply_operations <span class="free">xs</span> <span class="main">≠</span> None"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Broadcast <span class="skolem">e</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> snoc <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Deliver <span class="skolem">e</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> snoc <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span> <span class="keyword1"><span class="command">unfolding</span></span> interp_msg_def apply_operations_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> bind.bind_lunit interpret_op_def prefix_of_appendD<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> imap<span class="main">)</span> create_id_valid<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">j</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Deliver <span class="main">(</span><span class="free">i1</span><span class="main">,</span> Create <span class="free">i2</span> <span class="free">e</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">i1</span> <span class="main">=</span> <span class="free">i2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s</span><span class="main">.</span> valid_behaviours <span class="bound">s</span> <span class="main">(</span><span class="free">i1</span><span class="main">,</span> Create <span class="free">i2</span> <span class="free">e</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms deliver_in_prefix_is_valid <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_behaviours_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> imap<span class="main">)</span> append_id_valid<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">j</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Deliver <span class="main">(</span><span class="free">i1</span><span class="main">,</span> Append <span class="free">i2</span> <span class="free">e</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">i1</span> <span class="main">=</span> <span class="free">i2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s</span><span class="main">.</span> valid_behaviours <span class="bound">s</span> <span class="main">(</span><span class="free">i1</span><span class="main">,</span> Append <span class="free">i2</span> <span class="free">e</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms deliver_in_prefix_is_valid <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_behaviours_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> imap<span class="main">)</span> expunge_id_valid<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">j</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Deliver <span class="main">(</span><span class="free">i1</span><span class="main">,</span> Expunge <span class="free">e</span> <span class="free">mo</span> <span class="free">i2</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">i1</span> <span class="main">=</span> <span class="free">i2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s</span><span class="main">.</span> valid_behaviours <span class="bound">s</span> <span class="main">(</span><span class="free">i1</span><span class="main">,</span> Expunge <span class="free">e</span> <span class="free">mo</span> <span class="free">i2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms deliver_in_prefix_is_valid <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_behaviours_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> imap<span class="main">)</span> store_id_valid<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">j</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Deliver <span class="main">(</span><span class="free">i1</span><span class="main">,</span> Store <span class="free">e</span> <span class="free">mo</span> <span class="free">i2</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">i1</span> <span class="main">=</span> <span class="free">i2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s</span><span class="main">.</span> valid_behaviours <span class="bound">s</span> <span class="main">(</span><span class="free">i1</span><span class="main">,</span> Store <span class="free">e</span> <span class="free">mo</span> <span class="free">i2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms deliver_in_prefix_is_valid <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_behaviours_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> imap<span class="main">)</span> <span class="entity">added_ids</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'id</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'id</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> operation<span class="main">)</span> event list <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'id</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">added_ids</span> <span class="free"><span class="bound"><span class="entity">es</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≡</span> List.map_filter <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> 
    Deliver <span class="main">(</span><span class="bound">i</span><span class="main">,</span> Create <span class="bound">j</span> <span class="bound">e</span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">e</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">then</span> Some <span class="bound">j</span> <span class="keyword1">else</span> None <span class="main">|</span> 
    Deliver <span class="main">(</span><span class="bound">i</span><span class="main">,</span> Expunge <span class="bound">e</span> <span class="bound">mo</span> <span class="bound">j</span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">e</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">then</span> Some <span class="bound">j</span> <span class="keyword1">else</span> None <span class="main">|</span>
    <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> None<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">es</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> imap<span class="main">)</span> <span class="entity">added_files</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'id</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'id</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> operation<span class="main">)</span> event list <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'id</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">added_files</span> <span class="free"><span class="bound"><span class="entity">es</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≡</span> List.map_filter <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> 
    Deliver <span class="main">(</span><span class="bound">i</span><span class="main">,</span> Append <span class="bound">j</span> <span class="bound">e</span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">e</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">then</span> Some <span class="bound">j</span> <span class="keyword1">else</span> None <span class="main">|</span>
    Deliver <span class="main">(</span><span class="bound">i</span><span class="main">,</span> Store <span class="bound">e</span> <span class="bound">mo</span> <span class="bound">j</span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">e</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">then</span> Some <span class="bound">j</span> <span class="keyword1">else</span> None <span class="main">|</span>
    <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> None<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">es</span></span></span>"</span></span>

<span class="comment1">― ‹added files simplifier›</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> imap<span class="main">)</span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"added_files <span class="main">[]</span> <span class="free">e</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> added_files_def map_filter_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> imap<span class="main">)</span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"added_files <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="free">e</span> <span class="main">=</span> added_files <span class="free">xs</span> <span class="free">e</span> <span class="main">@</span> added_files <span class="free">ys</span> <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> added_files_def map_filter_append<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> imap<span class="main">)</span> added_files_Broadcast_collapse <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"added_files <span class="main">(</span><span class="main">[</span>Broadcast <span class="free">e</span><span class="main">]</span><span class="main">)</span> <span class="free">e'</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> added_files_def map_filter_append map_filter_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> imap<span class="main">)</span> added_files_Deliver_Delete_collapse <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"added_files <span class="main">(</span><span class="main">[</span>Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Delete <span class="free">is</span> <span class="free">e</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free">e'</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> added_files_def map_filter_append map_filter_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> imap<span class="main">)</span> added_files_Deliver_Create_collapse <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"added_files <span class="main">(</span><span class="main">[</span>Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Create <span class="free">j</span> <span class="free">e</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free">e'</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> added_files_def map_filter_append map_filter_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> imap<span class="main">)</span> added_files_Deliver_Expunge_collapse <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"added_files <span class="main">(</span><span class="main">[</span>Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Expunge <span class="free">e</span> <span class="free">mo</span> <span class="free">j</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free">e'</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> added_files_def map_filter_append map_filter_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> imap<span class="main">)</span> added_files_Deliver_Append_diff_collapse <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">≠</span> <span class="free">e'</span> <span class="main">⟹</span> added_files <span class="main">(</span><span class="main">[</span>Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Append <span class="free">j</span> <span class="free">e</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free">e'</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> added_files_def map_filter_append map_filter_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> imap<span class="main">)</span> added_files_Deliver_Append_same_collapse <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"added_files <span class="main">(</span><span class="main">[</span>Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Append <span class="free">j</span> <span class="free">e</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free">e</span> <span class="main">=</span> <span class="main">[</span><span class="free">j</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> added_files_def map_filter_append map_filter_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> imap<span class="main">)</span> added_files_Deliver_Store_diff_collapse <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">≠</span> <span class="free">e'</span> <span class="main">⟹</span> added_files <span class="main">(</span><span class="main">[</span>Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Store <span class="free">e</span> <span class="free">mo</span> <span class="free">j</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free">e'</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> added_files_def map_filter_append map_filter_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> imap<span class="main">)</span> added_files_Deliver_Store_same_collapse <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"added_files <span class="main">(</span><span class="main">[</span>Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Store <span class="free">e</span> <span class="free">mo</span> <span class="free">j</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free">e</span> <span class="main">=</span> <span class="main">[</span><span class="free">j</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> added_files_def map_filter_append map_filter_def<span class="main">)</span>


<span class="comment1">― ‹added ids simplifier›</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> imap<span class="main">)</span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"added_ids <span class="main">[]</span> <span class="free">e</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> added_ids_def map_filter_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> imap<span class="main">)</span> split_ids <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"added_ids <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="free">e</span> <span class="main">=</span> added_ids <span class="free">xs</span> <span class="free">e</span> <span class="main">@</span> added_ids <span class="free">ys</span> <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> added_ids_def map_filter_append<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> imap<span class="main">)</span> added_ids_Broadcast_collapse <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"added_ids <span class="main">(</span><span class="main">[</span>Broadcast <span class="free">e</span><span class="main">]</span><span class="main">)</span> <span class="free">e'</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> added_ids_def map_filter_append map_filter_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> imap<span class="main">)</span> added_ids_Deliver_Delete_collapse <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"added_ids <span class="main">(</span><span class="main">[</span>Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Delete <span class="free">is</span> <span class="free">e</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free">e'</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> added_ids_def map_filter_append map_filter_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> imap<span class="main">)</span> added_ids_Deliver_Append_collapse <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"added_ids <span class="main">(</span><span class="main">[</span>Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Append <span class="free">j</span> <span class="free">e</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free">e'</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> added_ids_def map_filter_append map_filter_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> imap<span class="main">)</span> added_ids_Deliver_Store_collapse <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"added_ids <span class="main">(</span><span class="main">[</span>Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Store <span class="free">e</span> <span class="free">mo</span> <span class="free">j</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free">e'</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> added_ids_def map_filter_append map_filter_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> imap<span class="main">)</span> added_ids_Deliver_Create_diff_collapse <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">≠</span> <span class="free">e'</span> <span class="main">⟹</span> added_ids <span class="main">(</span><span class="main">[</span>Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Create <span class="free">j</span> <span class="free">e</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free">e'</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> added_ids_def map_filter_append map_filter_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> imap<span class="main">)</span> added_ids_Deliver_Expunge_diff_collapse <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">≠</span> <span class="free">e'</span> <span class="main">⟹</span> added_ids <span class="main">(</span><span class="main">[</span>Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Expunge <span class="free">e</span> <span class="free">mo</span> <span class="free">j</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free">e'</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> added_ids_def map_filter_append map_filter_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> imap<span class="main">)</span> added_ids_Deliver_Create_same_collapse <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"added_ids <span class="main">(</span><span class="main">[</span>Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Create <span class="free">j</span> <span class="free">e</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free">e</span> <span class="main">=</span> <span class="main">[</span><span class="free">j</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> added_ids_def map_filter_append map_filter_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> imap<span class="main">)</span> added_ids_Deliver_Expunge_same_collapse <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"added_ids <span class="main">(</span><span class="main">[</span>Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Expunge <span class="free">e</span> <span class="free">mo</span> <span class="free">j</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free">e</span> <span class="main">=</span> <span class="main">[</span><span class="free">j</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> added_ids_def map_filter_append map_filter_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> imap<span class="main">)</span> expunge_id_not_in_set<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i1</span> <span class="main">∉</span> set <span class="main">(</span>added_ids <span class="main">[</span>Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Expunge <span class="free">e</span> <span class="free">mo</span> <span class="free">i2</span><span class="main">)</span><span class="main">]</span> <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">i1</span> <span class="main">≠</span> <span class="free">i2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> imap<span class="main">)</span> apply_operations_added_ids<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">es</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">j</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"apply_operations <span class="free">es</span> <span class="main">=</span> Some <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">⊆</span> set <span class="main">(</span>added_ids <span class="free">es</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">es</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Deliver <span class="skolem">e</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> snoc <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="skolem">b</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> interp_msg_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> bind_splits<span class="main"><span class="keyword3">,</span></span>
          <span class="operator">force</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> op_elem_def interpret_op_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> imap<span class="main">)</span> apply_operations_added_files<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">es</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">j</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"apply_operations <span class="free">es</span> <span class="main">=</span> Some <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">⊆</span> set <span class="main">(</span>added_files <span class="free">es</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">es</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Deliver <span class="skolem">e</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> snoc <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="skolem">b</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> interp_msg_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> bind_splits<span class="main"><span class="keyword3">,</span></span>
          <span class="operator">force</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> op_elem_def interpret_op_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> imap<span class="main">)</span> Deliver_added_files<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">j</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> set <span class="main">(</span>added_files <span class="free">xs</span> <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Append <span class="free">i</span> <span class="free">e</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">mo</span> <span class="main">.</span> Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Store <span class="free">e</span> <span class="bound">mo</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> X<span class="main">:</span> <span class="main">(</span>Deliver <span class="skolem">e'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">e'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> snoc 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="skolem">b</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">clarify</span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span><span class="operator">metis</span> prefix_of_appendD<span class="main"><span class="keyword3">,</span></span><span class="operator">force</span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> append_id_valid <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> 
      <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> 
          added_files_Deliver_Append_diff_collapse added_files_Deliver_Append_same_collapse 
          empty_iff in_set_conv_decomp list.set<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> prefix_of_appendD set_ConsD<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> E apply_operations_added_files <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main">)</span> 
      <span class="keyword1"><span class="command">using</span></span> E apply_operations_added_files 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Un_iff 
          added_files_Deliver_Store_diff_collapse added_files_Deliver_Store_same_collapse empty_iff 
          empty_set list.set_intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> prefix_of_appendD set_ConsD set_append store_id_valid<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="IMAP-proof-independent">
<div class="head">
<h1>Theory IMAP-proof-independent</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Independence of IMAP Commands›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹In this section we show that two concurrent operations that reference to the same tag must be 
identical.›</span></span>

<span class="keyword1"><span class="command">theory</span></span>
  <span class="quoted">"IMAP-proof-independent"</span>
  <span class="keyword2"><span class="keyword">imports</span></span>
    <span class="quoted">"<a href="IMAP-def.html">IMAP-def</a>"</span>
    <span class="quoted">"<a href="IMAP-proof-helpers.html">IMAP-proof-helpers</a>"</span>  
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> imap<span class="main">)</span> Broadcast_Expunge_Deliver_prefix_closed<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">@</span> <span class="main">[</span>Broadcast <span class="main">(</span><span class="free">i</span><span class="main">,</span> Expunge <span class="free">e</span> <span class="free">mo</span> <span class="free">i</span><span class="main">)</span><span class="main">]</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Deliver <span class="main">(</span><span class="free">mo</span><span class="main">,</span> Append <span class="free">mo</span> <span class="free">e</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">∨</span> 
    <span class="main">(</span><span class="main">∃</span> <span class="bound">mo2</span> <span class="main">.</span> Deliver <span class="main">(</span><span class="free">mo</span><span class="main">,</span> Store <span class="free">e</span> <span class="bound">mo2</span> <span class="free">mo</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>  
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"apply_operations <span class="free">xs</span> <span class="main">=</span> Some <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms broadcast_only_valid_msgs <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="free">mo</span> <span class="main">∈</span> snd <span class="main">(</span><span class="skolem">y</span> <span class="free">e</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> broadcast_only_valid_msgs<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span><span class="main">,</span> Expunge <span class="free">e</span> <span class="free">mo</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">j</span></span><span class="main">]</span> 
      valid_behaviours_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span><span class="main">,</span> Expunge <span class="free">e</span> <span class="free">mo</span> <span class="free">i</span><span class="main">)</span>"</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms Deliver_added_files apply_operations_added_files <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> imap<span class="main">)</span> Broadcast_Store_Deliver_prefix_closed<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">@</span> <span class="main">[</span>Broadcast <span class="main">(</span><span class="free">i</span><span class="main">,</span> Store <span class="free">e</span> <span class="free">mo</span> <span class="free">i</span><span class="main">)</span><span class="main">]</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Deliver <span class="main">(</span><span class="free">mo</span><span class="main">,</span> Append <span class="free">mo</span> <span class="free">e</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">∨</span> 
    <span class="main">(</span><span class="main">∃</span> <span class="bound">mo2</span> <span class="main">.</span> Deliver <span class="main">(</span><span class="free">mo</span><span class="main">,</span> Store <span class="free">e</span> <span class="bound">mo2</span> <span class="free">mo</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>  
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"apply_operations <span class="free">xs</span> <span class="main">=</span> Some <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms broadcast_only_valid_msgs <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="free">mo</span> <span class="main">∈</span> snd <span class="main">(</span><span class="skolem">y</span> <span class="free">e</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> broadcast_only_valid_msgs<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span><span class="main">,</span> Store <span class="free">e</span> <span class="free">mo</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">j</span></span><span class="main">]</span> 
      valid_behaviours_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span><span class="main">,</span> Store <span class="free">e</span> <span class="free">mo</span> <span class="free">i</span><span class="main">)</span>"</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms Deliver_added_files apply_operations_added_files <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> imap<span class="main">)</span> Deliver_added_ids<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">j</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> set <span class="main">(</span>added_ids <span class="free">xs</span> <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Create <span class="free">i</span> <span class="free">e</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">∨</span> 
    <span class="main">(</span><span class="main">∃</span> <span class="bound">mo</span> <span class="main">.</span> Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Expunge <span class="free">e</span> <span class="bound">mo</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> X<span class="main">:</span> <span class="main">(</span>Deliver <span class="skolem">e'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> snoc <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="skolem">b</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">clarify</span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> added_ids_Deliver_Create_diff_collapse 
          added_ids_Deliver_Create_same_collapse empty_iff list.set<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> set_ConsD create_id_valid 
          in_set_conv_decomp prefix_of_appendD<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> append_id_valid <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span>  prefix_of_appendD<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> 
          Un_iff added_ids_Deliver_Expunge_diff_collapse added_ids_Deliver_Expunge_same_collapse 
          empty_iff expunge_id_valid list.set<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list.set_intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> prefix_of_appendD set_ConsD 
          set_append<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> imap<span class="main">)</span> Broadcast_Deliver_prefix_closed<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">@</span> <span class="main">[</span>Broadcast <span class="main">(</span><span class="free">r</span><span class="main">,</span> Delete <span class="free">ix</span> <span class="free">e</span><span class="main">)</span><span class="main">]</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">j</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">ix</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Create <span class="free">i</span> <span class="free">e</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">∨</span> 
    Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Append <span class="free">i</span> <span class="free">e</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">∨</span> 
    <span class="main">(</span><span class="main">∃</span> <span class="bound">mo</span> <span class="main">.</span> Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Expunge <span class="free">e</span> <span class="bound">mo</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">)</span> <span class="main">∨</span> 
    <span class="main">(</span><span class="main">∃</span> <span class="bound">mo</span> <span class="main">.</span> Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Store <span class="free">e</span> <span class="bound">mo</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>  
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"apply_operations <span class="free">xs</span> <span class="main">=</span> Some <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms broadcast_only_valid_msgs <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="free">ix</span> <span class="main">=</span> fst <span class="main">(</span><span class="skolem">y</span> <span class="free">e</span><span class="main">)</span> <span class="main">∪</span> snd <span class="main">(</span><span class="skolem">y</span> <span class="free">e</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> broadcast_only_valid_msgs operation.case<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span>
        option.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> valid_behaviours_def case_prodD<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms Deliver_added_ids apply_operations_added_ids
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Deliver_added_files Un_iff apply_operations_added_files le_iff_sup prefix_of_appendD<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> imap<span class="main">)</span> concurrent_create_delete_independent_technical<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">is</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">j</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span><span class="main">,</span> Create <span class="free">i</span> <span class="free">e</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>node_deliver_messages <span class="free">xs</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ir</span><span class="main">,</span> Delete <span class="free">is</span> <span class="free">e</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>node_deliver_messages <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"hb <span class="main">(</span><span class="free">i</span><span class="main">,</span> Create <span class="free">i</span> <span class="free">e</span><span class="main">)</span> <span class="main">(</span><span class="free">ir</span><span class="main">,</span> Delete <span class="free">is</span> <span class="free">e</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Create <span class="free">i</span> <span class="free">e</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">history</span> <span class="free">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms prefix_msg_in_history <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pre</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pre</span><span class="main">@</span><span class="main">[</span>Broadcast <span class="main">(</span><span class="free">ir</span><span class="main">,</span> Delete <span class="free">is</span> <span class="free">e</span><span class="main">)</span><span class="main">]</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms delivery_has_a_cause events_before_exist prefix_msg_in_history <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> f2<span class="main">:</span> <span class="quoted"><span class="quoted">"Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Create <span class="free">i</span> <span class="free">e</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">pre</span> <span class="main">∨</span> 
                  Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Append <span class="free">i</span> <span class="free">e</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">pre</span> <span class="main">∨</span> 
                  <span class="main">(</span><span class="main">∃</span> <span class="bound">mo</span> <span class="main">.</span> Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Expunge <span class="free">e</span> <span class="bound">mo</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">pre</span><span class="main">)</span> <span class="main">∨</span> 
                  <span class="main">(</span><span class="main">∃</span> <span class="bound">mo</span> <span class="main">.</span> Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Store <span class="free">e</span> <span class="bound">mo</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">pre</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Broadcast_Deliver_prefix_closed assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> f3<span class="main">:</span> <span class="quoted"><span class="quoted">"Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Append <span class="free">i</span> <span class="free">e</span><span class="main">)</span> <span class="main">∉</span> set <span class="skolem">pre</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> f1 P 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> Pair_inject fst_conv network.delivery_has_a_cause network.msg_id_unique 
        network_axioms operation.simps<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span> prefix_elem_to_carriers prefix_of_appendD<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> f4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">mo</span> <span class="main">.</span> Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Expunge <span class="free">e</span> <span class="bound">mo</span> <span class="free">i</span><span class="main">)</span> <span class="main">∉</span> set <span class="skolem">pre</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> f1 P
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> delivery_has_a_cause fst_conv msg_id_unique old.prod.inject operation.simps<span class="main"><span class="main">(</span></span>11<span class="main"><span class="main">)</span></span>
        prefix_elem_to_carriers prefix_of_appendD<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">mo</span> <span class="main">.</span> Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Store <span class="free">e</span> <span class="bound">mo</span> <span class="free">i</span><span class="main">)</span> <span class="main">∉</span> set <span class="skolem">pre</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> f1 P
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> delivery_has_a_cause fst_conv msg_id_unique old.prod.inject operation.simps<span class="main"><span class="main">(</span></span>13<span class="main"><span class="main">)</span></span>
        prefix_elem_to_carriers prefix_of_appendD<span class="main">)</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> f2 f3 f4  P events_in_local_order hb_deliver <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> imap<span class="main">)</span> concurrent_store_expunge_independent_technical<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">j</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span><span class="main">,</span> Store <span class="free">e</span> <span class="free">mo</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>node_deliver_messages <span class="free">xs</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span><span class="main">,</span> Expunge <span class="free">e</span> <span class="free">i</span> <span class="free">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>node_deliver_messages <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"hb <span class="main">(</span><span class="free">i</span><span class="main">,</span> Store <span class="free">e</span> <span class="free">mo</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="free">r</span><span class="main">,</span> Expunge <span class="free">e</span> <span class="free">i</span> <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pre</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pre</span><span class="main">@</span><span class="main">[</span>Broadcast <span class="main">(</span><span class="free">r</span><span class="main">,</span> Expunge <span class="free">e</span> <span class="free">i</span> <span class="free">r</span><span class="main">)</span><span class="main">]</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms delivery_has_a_cause events_before_exist prefix_msg_in_history <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Append <span class="free">i</span> <span class="free">e</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">pre</span> <span class="main">∨</span> 
  <span class="main">(</span><span class="main">∃</span> <span class="bound">mo2</span> <span class="main">.</span> Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Store <span class="free">e</span> <span class="bound">mo2</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">pre</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Broadcast_Expunge_Deliver_prefix_closed assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> f2<span class="main">:</span> <span class="quoted"><span class="quoted">"Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Append <span class="free">i</span> <span class="free">e</span><span class="main">)</span> <span class="main">∉</span> set <span class="main">(</span><span class="free">history</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pair_inject assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> fst_conv msg_id_unique network.delivery_has_a_cause 
        network_axioms operation.distinct<span class="main"><span class="main">(</span></span>17<span class="main"><span class="main">)</span></span> prefix_msg_in_history<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> f1 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">mo2</span></span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Store <span class="free">e</span> <span class="skolem">mo2</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">history</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> f2
    <span class="keyword1"><span class="command">using</span></span> P prefix_elem_to_carriers <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>  
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Store <span class="free">e</span> <span class="free">mo</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">history</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms f1 f2 P 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fst_conv msg_id_unique network.delivery_has_a_cause network_axioms 
        prefix_msg_in_history<span class="main">)</span>    
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> hb.intros<span class="main">(</span>2<span class="main">)</span> events_in_local_order f1 f2 P
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> delivery_has_a_cause fst_conv msg_id_unique node_histories.prefix_of_appendD 
        node_histories_axioms prefix_elem_to_carriers<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> imap<span class="main">)</span> concurrent_store_expunge_independent_technical2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">j</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span><span class="main">,</span> Store <span class="free">e1</span> <span class="free">mo2</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>node_deliver_messages <span class="free">xs</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span><span class="main">,</span> Expunge <span class="free">e</span> <span class="free">mo</span> <span class="free">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>node_deliver_messages <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">mo2</span> <span class="main">≠</span> <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">oid</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> operation <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    oid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="bound">n</span><span class="main">.</span> Deliver <span class="bound">p</span> <span class="main">∉</span> set <span class="main">(</span><span class="free">history</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∨</span> Broadcast <span class="bound">p</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">history</span> <span class="main">(</span><span class="skolem">oid</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> delivery_has_a_cause<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"Broadcast <span class="main">(</span><span class="free">r</span><span class="main">,</span> Expunge <span class="free">e</span> <span class="free">mo</span> <span class="free">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">history</span> <span class="main">(</span><span class="skolem">oid</span> <span class="main">(</span><span class="free">r</span><span class="main">,</span> Expunge <span class="free">e</span> <span class="free">mo</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> prefix_msg_in_history <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> operation<span class="main">)</span> event list <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span> k<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="bound">e</span> <span class="bound">pre</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">mo</span><span class="main">.</span> Deliver <span class="main">(</span><span class="bound">i</span><span class="main">,</span> Store <span class="bound">e</span> <span class="bound">mo</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="bound">pre</span><span class="main">)</span> <span class="main">=</span> 
    <span class="main">(</span>Deliver <span class="main">(</span><span class="bound">i</span><span class="main">,</span> Store <span class="bound">e</span> <span class="main">(</span><span class="skolem">k</span> <span class="bound">i</span> <span class="bound">e</span> <span class="bound">pre</span><span class="main">)</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="bound">pre</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">moura</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pre</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> operation<span class="main">)</span> event <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> operation<span class="main">)</span> event list"</span></span> 
    <span class="keyword2"><span class="keyword">where</span></span> pre<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span> <span class="bound">op1</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">op2</span><span class="main">.</span> <span class="bound">op2</span> <span class="main">@</span> <span class="main">[</span><span class="bound">op1</span><span class="main">]</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="bound">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">pre</span> <span class="bound">k</span> <span class="bound">op1</span> <span class="main">@</span> <span class="main">[</span><span class="bound">op1</span><span class="main">]</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">moura</span>
  <span class="keyword1"><span class="command">hence</span></span> f2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">e</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">e</span> <span class="main">∉</span> set <span class="main">(</span><span class="free">history</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∨</span> <span class="skolem">pre</span> <span class="bound">n</span> <span class="bound">e</span> <span class="main">@</span> <span class="main">[</span><span class="bound">e</span><span class="main">]</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="bound">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> events_before_exist <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> f3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pre</span> <span class="main">(</span><span class="skolem">oid</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> Store <span class="free">e1</span> <span class="free">mo2</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Broadcast <span class="main">(</span><span class="free">i</span><span class="main">,</span> Store <span class="free">e1</span> <span class="free">mo2</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="skolem">oid</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> Store <span class="free">e1</span> <span class="free">mo2</span> <span class="free">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> oid  assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> prefix_msg_in_history <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> f4<span class="main">:</span> <span class="quoted"><span class="quoted">"Deliver <span class="main">(</span><span class="free">r</span><span class="main">,</span> Append <span class="free">r</span> <span class="free">e1</span><span class="main">)</span> <span class="main">∉</span> set <span class="main">(</span><span class="free">history</span> <span class="main">(</span><span class="skolem">oid</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> Store <span class="free">e1</span> <span class="free">mo2</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> oid f1 fst_conv msg_id_unique old.prod.inject operation.distinct<span class="main"><span class="main">(</span></span>15<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Deliver <span class="main">(</span><span class="free">r</span><span class="main">,</span> Store <span class="free">e1</span> <span class="main">(</span><span class="skolem">k</span> <span class="free">r</span> <span class="free">e1</span> <span class="main">(</span><span class="skolem">pre</span> <span class="main">(</span><span class="skolem">oid</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> Store <span class="free">e1</span> <span class="free">mo2</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> 
  <span class="main">(</span>Broadcast <span class="main">(</span><span class="free">i</span><span class="main">,</span> Store <span class="free">e1</span> <span class="free">mo2</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">r</span><span class="main">)</span> <span class="main">∉</span> set <span class="main">(</span><span class="free">history</span> <span class="main">(</span><span class="skolem">oid</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> Store <span class="free">e1</span> <span class="free">mo2</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> oid f1 fst_conv msg_id_unique old.prod.inject operation.distinct<span class="main"><span class="main">(</span></span>19<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> oid k f2 f3 f4 assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Broadcast_Store_Deliver_prefix_closed 
        network.prefix_msg_in_history network_axioms prefix_elem_to_carriers<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> imap<span class="main">)</span> concurrent_store_delete_independent_technical<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">is</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">j</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span><span class="main">,</span> Store <span class="free">e</span> <span class="free">mo</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>node_deliver_messages <span class="free">xs</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ir</span><span class="main">,</span> Delete <span class="free">is</span> <span class="free">e</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>node_deliver_messages <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"hb <span class="main">(</span><span class="free">i</span><span class="main">,</span> Store <span class="free">e</span> <span class="free">mo</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="free">ir</span><span class="main">,</span> Delete <span class="free">is</span> <span class="free">e</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Store <span class="free">e</span> <span class="free">mo</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">history</span> <span class="free">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms prefix_msg_in_history <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pre</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pre</span><span class="main">@</span><span class="main">[</span>Broadcast <span class="main">(</span><span class="free">ir</span><span class="main">,</span> Delete <span class="free">is</span> <span class="free">e</span><span class="main">)</span><span class="main">]</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms delivery_has_a_cause events_before_exist prefix_msg_in_history <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> f2<span class="main">:</span> <span class="quoted"><span class="quoted">"Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Create <span class="free">i</span> <span class="free">e</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">pre</span> <span class="main">∨</span> 
  Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Append <span class="free">i</span> <span class="free">e</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">pre</span> <span class="main">∨</span>
  <span class="main">(</span><span class="main">∃</span> <span class="bound">mo</span> <span class="main">.</span> Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Expunge <span class="free">e</span> <span class="bound">mo</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">pre</span><span class="main">)</span> <span class="main">∨</span> 
  <span class="main">(</span><span class="main">∃</span> <span class="bound">mo</span> <span class="main">.</span> Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Store <span class="free">e</span> <span class="bound">mo</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">pre</span><span class="main">)</span>"</span></span>  
    <span class="keyword1"><span class="command">using</span></span> Broadcast_Deliver_prefix_closed assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>    
  <span class="keyword1"><span class="command">have</span></span> f3<span class="main">:</span> <span class="quoted"><span class="quoted">"Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Create <span class="free">i</span> <span class="free">e</span><span class="main">)</span> <span class="main">∉</span> set <span class="skolem">pre</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> f1 P 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pair_inject delivery_has_a_cause fst_conv msg_id_unique operation.distinct<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span> 
        prefix_elem_to_carriers prefix_of_appendD<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> f4<span class="main">:</span> <span class="quoted"><span class="quoted">"Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Append <span class="free">i</span> <span class="free">e</span><span class="main">)</span> <span class="main">∉</span> set <span class="skolem">pre</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> f1 P
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> delivery_has_a_cause fst_conv msg_id_unique operation.distinct<span class="main"><span class="main">(</span></span>17<span class="main"><span class="main">)</span></span> 
        prefix_elem_to_carriers prefix_of_appendD prod.inject<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">mo</span> <span class="main">.</span> Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Expunge <span class="free">e</span> <span class="bound">mo</span> <span class="free">i</span><span class="main">)</span> <span class="main">∉</span> set <span class="skolem">pre</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> f1 P
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pair_inject delivery_has_a_cause fst_conv msg_id_unique operation.simps<span class="main"><span class="main">(</span></span>25<span class="main"><span class="main">)</span></span> 
        prefix_elem_to_carriers prefix_of_appendD<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Store <span class="free">e</span> <span class="free">mo</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">pre</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> f1 f2 f3 f4 P
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> delivery_has_a_cause fst_conv msg_id_unique node_histories.prefix_of_appendD 
        node_histories_axioms prefix_elem_to_carriers<span class="main">)</span>     
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> P events_in_local_order hb_deliver <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> imap<span class="main">)</span> concurrent_append_delete_independent_technical<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">is</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">j</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span><span class="main">,</span> Append <span class="free">i</span> <span class="free">e</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>node_deliver_messages <span class="free">xs</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ir</span><span class="main">,</span> Delete <span class="free">is</span> <span class="free">e</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>node_deliver_messages <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"hb <span class="main">(</span><span class="free">i</span><span class="main">,</span> Append <span class="free">i</span> <span class="free">e</span><span class="main">)</span> <span class="main">(</span><span class="free">ir</span><span class="main">,</span> Delete <span class="free">is</span> <span class="free">e</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pre</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pre</span><span class="main">@</span><span class="main">[</span>Broadcast <span class="main">(</span><span class="free">ir</span><span class="main">,</span> Delete <span class="free">is</span> <span class="free">e</span><span class="main">)</span><span class="main">]</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms delivery_has_a_cause events_before_exist prefix_msg_in_history <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Create <span class="free">i</span> <span class="free">e</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">pre</span> <span class="main">∨</span> 
  Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Append <span class="free">i</span> <span class="free">e</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">pre</span> <span class="main">∨</span> 
  <span class="main">(</span><span class="main">∃</span> <span class="bound">mo</span> <span class="main">.</span> Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Expunge <span class="free">e</span> <span class="bound">mo</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">pre</span><span class="main">)</span> <span class="main">∨</span> 
  <span class="main">(</span><span class="main">∃</span> <span class="bound">mo</span> <span class="main">.</span> Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Store <span class="free">e</span> <span class="bound">mo</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">pre</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Broadcast_Deliver_prefix_closed assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Append <span class="free">i</span> <span class="free">e</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">pre</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms P f1
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> delivery_has_a_cause events_in_local_order fst_conv 
        hb_broadcast_exists1 hb_deliver msg_id_unique prefix_msg_in_history<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> P events_in_local_order hb_deliver <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> imap<span class="main">)</span> concurrent_append_expunge_independent_technical<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="free">mo</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">j</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span><span class="main">,</span> Append <span class="free">i</span> <span class="free">e</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>node_deliver_messages <span class="free">xs</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span><span class="main">,</span> Expunge <span class="free">e</span> <span class="free">mo</span> <span class="free">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>node_deliver_messages <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"hb <span class="main">(</span><span class="free">i</span><span class="main">,</span> Append <span class="free">i</span> <span class="free">e</span><span class="main">)</span> <span class="main">(</span><span class="free">r</span><span class="main">,</span> Expunge <span class="free">e</span> <span class="free">mo</span> <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pre</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pre</span><span class="main">@</span><span class="main">[</span>Broadcast <span class="main">(</span><span class="free">r</span><span class="main">,</span> Expunge <span class="free">e</span> <span class="free">mo</span> <span class="free">r</span><span class="main">)</span><span class="main">]</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms delivery_has_a_cause events_before_exist prefix_msg_in_history <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"Deliver <span class="main">(</span><span class="free">mo</span><span class="main">,</span> Append <span class="free">mo</span> <span class="free">e</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">pre</span> <span class="main">∨</span> 
  <span class="main">(</span><span class="main">∃</span> <span class="bound">mo2</span> <span class="main">.</span> Deliver <span class="main">(</span><span class="free">mo</span><span class="main">,</span> Store <span class="free">e</span> <span class="bound">mo2</span> <span class="free">mo</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">pre</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Broadcast_Expunge_Deliver_prefix_closed assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span> <span class="bound">mo2</span> <span class="main">.</span> Deliver <span class="main">(</span><span class="free">mo</span><span class="main">,</span> Store <span class="free">e</span> <span class="bound">mo2</span> <span class="free">mo</span><span class="main">)</span> <span class="main">∉</span> set <span class="skolem">pre</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> P assms 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Deliver <span class="main">(</span><span class="free">mo</span><span class="main">,</span> Append <span class="free">mo</span> <span class="free">e</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">history</span> <span class="free">j</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> prefix_msg_in_history <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> P Pair_inject delivery_has_a_cause fst_conv msg_id_unique 
          operation.simps<span class="main"><span class="main">(</span></span>23<span class="main"><span class="main">)</span></span> prefix_elem_to_carriers prefix_of_appendD<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> hb.intros<span class="main">(</span>2<span class="main">)</span> events_in_local_order assms<span class="main">(</span>1<span class="main">)</span> P f1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> imap<span class="main">)</span> concurrent_append_store_independent_technical<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="free">mo</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">j</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span><span class="main">,</span> Append <span class="free">i</span> <span class="free">e</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>node_deliver_messages <span class="free">xs</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span><span class="main">,</span> Store <span class="free">e</span> <span class="free">mo</span> <span class="free">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>node_deliver_messages <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"hb <span class="main">(</span><span class="free">i</span><span class="main">,</span> Append <span class="free">i</span> <span class="free">e</span><span class="main">)</span> <span class="main">(</span><span class="free">r</span><span class="main">,</span> Store <span class="free">e</span> <span class="free">mo</span> <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pre</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> pre<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pre</span><span class="main">@</span><span class="main">[</span>Broadcast <span class="main">(</span><span class="free">r</span><span class="main">,</span> Store <span class="free">e</span> <span class="free">mo</span> <span class="free">r</span><span class="main">)</span><span class="main">]</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms delivery_has_a_cause events_before_exist prefix_msg_in_history <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"Deliver <span class="main">(</span><span class="free">mo</span><span class="main">,</span> Append <span class="free">mo</span> <span class="free">e</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">pre</span> <span class="main">∨</span> 
  <span class="main">(</span><span class="main">∃</span> <span class="bound">mo2</span> <span class="main">.</span> Deliver <span class="main">(</span><span class="free">mo</span><span class="main">,</span> Store <span class="free">e</span> <span class="bound">mo2</span> <span class="free">mo</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">pre</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Broadcast_Store_Deliver_prefix_closed assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> f2<span class="main">:</span> <span class="quoted"><span class="quoted">"Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Append <span class="free">i</span> <span class="free">e</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">history</span> <span class="free">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms network.prefix_msg_in_history network_axioms<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms f1 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span>  pre delivery_has_a_cause events_in_local_order fst_conv hb_deliver 
        msg_id_unique node_histories.prefix_of_appendD node_histories_axioms 
        prefix_elem_to_carriers<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> imap<span class="main">)</span> concurrent_expunge_delete_independent_technical<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">is</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">j</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span><span class="main">,</span> Expunge <span class="free">e</span> <span class="free">mo</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>node_deliver_messages <span class="free">xs</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ir</span><span class="main">,</span> Delete <span class="free">is</span> <span class="free">e</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>node_deliver_messages <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"hb <span class="main">(</span><span class="free">i</span><span class="main">,</span> Expunge <span class="free">e</span> <span class="free">mo</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="free">ir</span><span class="main">,</span> Delete <span class="free">is</span> <span class="free">e</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pre</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> pre<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pre</span><span class="main">@</span><span class="main">[</span>Broadcast <span class="main">(</span><span class="free">ir</span><span class="main">,</span> Delete <span class="free">is</span> <span class="free">e</span><span class="main">)</span><span class="main">]</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms delivery_has_a_cause events_before_exist prefix_msg_in_history <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Create <span class="free">i</span> <span class="free">e</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">pre</span> <span class="main">∨</span> 
  Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Append <span class="free">i</span> <span class="free">e</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">pre</span> <span class="main">∨</span> 
  <span class="main">(</span><span class="main">∃</span> <span class="bound">mo</span> <span class="main">.</span> Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Expunge <span class="free">e</span> <span class="bound">mo</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">pre</span><span class="main">)</span> <span class="main">∨</span> 
  <span class="main">(</span><span class="main">∃</span> <span class="bound">mo</span> <span class="main">.</span> Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Store <span class="free">e</span> <span class="bound">mo</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">pre</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Broadcast_Deliver_prefix_closed assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>      
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Expunge <span class="free">e</span> <span class="free">mo</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">pre</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">e</span><span class="main">.</span> <span class="bound">e</span> <span class="main">∉</span> set <span class="skolem">pre</span> <span class="main">∨</span> <span class="bound">e</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">history</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> pre prefix_elem_to_carriers <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> f2<span class="main">:</span> <span class="quoted"><span class="quoted">"Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Expunge <span class="free">e</span> <span class="free">mo</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">history</span> <span class="free">j</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms network.prefix_msg_in_history network_axioms<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> f1 A 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> fst_conv msg_id_unique network.delivery_has_a_cause 
          network_axioms<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>     
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> hb.intros<span class="main">(</span>2<span class="main">)</span> events_in_local_order <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> imap<span class="main">)</span> concurrent_store_store_independent_technical<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">j</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span><span class="main">,</span> Store <span class="free">e</span> <span class="free">mo</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>node_deliver_messages <span class="free">xs</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span><span class="main">,</span> Store <span class="free">e</span> <span class="free">i</span> <span class="free">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>node_deliver_messages <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"hb <span class="main">(</span><span class="free">i</span><span class="main">,</span> Store <span class="free">e</span> <span class="free">mo</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="free">r</span><span class="main">,</span> Store <span class="free">e</span> <span class="free">i</span> <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pre</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pre</span><span class="main">@</span><span class="main">[</span>Broadcast <span class="main">(</span><span class="free">r</span><span class="main">,</span> Store <span class="free">e</span> <span class="free">i</span> <span class="free">r</span><span class="main">)</span><span class="main">]</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms delivery_has_a_cause events_before_exist prefix_msg_in_history <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">e</span><span class="main">.</span> <span class="bound">e</span> <span class="main">∉</span> set <span class="skolem">pre</span> <span class="main">∨</span> <span class="bound">e</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">history</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prefix_elem_to_carriers <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> f2<span class="main">:</span> <span class="quoted"><span class="quoted">"Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Append <span class="free">i</span> <span class="free">e</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">pre</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">mo2</span> <span class="main">.</span> Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Store <span class="free">e</span> <span class="bound">mo2</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">pre</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Broadcast_Store_Deliver_prefix_closed assms<span class="main">(</span>1<span class="main">)</span> P <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>     
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Store <span class="free">e</span> <span class="free">mo</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">pre</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms f1 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> delivery_has_a_cause fst_conv msg_id_unique prefix_msg_in_history<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> hb.intros<span class="main">(</span>2<span class="main">)</span> events_in_local_order P <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> imap<span class="main">)</span> expunge_delete_tag_causality<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">is</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">j</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span><span class="main">,</span> Expunge <span class="free">e1</span> <span class="free">mo</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>node_deliver_messages <span class="free">xs</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ir</span><span class="main">,</span> Delete <span class="free">is</span> <span class="free">e2</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>node_deliver_messages <span class="free">xs</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">pre</span><span class="main">@</span><span class="main">[</span>Broadcast <span class="main">(</span><span class="free">ir</span><span class="main">,</span> Delete <span class="free">is</span> <span class="free">e2</span><span class="main">)</span><span class="main">]</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Expunge <span class="free">e2</span> <span class="free">mo</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">history</span> <span class="free">k</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Append <span class="free">i</span> <span class="free">e2</span><span class="main">)</span> <span class="main">∉</span> set <span class="main">(</span><span class="free">history</span> <span class="free">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fst_conv msg_id_unique network.delivery_has_a_cause network_axioms old.prod.inject 
        operation.distinct<span class="main"><span class="main">(</span></span>15<span class="main"><span class="main">)</span></span> prefix_msg_in_history<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> f2<span class="main">:</span> <span class="quoted"><span class="quoted">"Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Create <span class="free">i</span> <span class="free">e2</span><span class="main">)</span> <span class="main">∉</span> set <span class="main">(</span><span class="free">history</span> <span class="free">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fst_conv msg_id_unique network.delivery_has_a_cause network_axioms old.prod.inject 
        operation.distinct<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> prefix_msg_in_history<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> f3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">mo</span><span class="main">.</span> Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Store <span class="free">e2</span> <span class="bound">mo</span> <span class="free">i</span><span class="main">)</span> <span class="main">∉</span> set <span class="main">(</span><span class="free">history</span> <span class="free">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pair_inject fst_conv msg_id_unique network.delivery_has_a_cause network_axioms 
        operation.simps<span class="main"><span class="main">(</span></span>25<span class="main"><span class="main">)</span></span> prefix_msg_in_history<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">mo1</span><span class="main">.</span> Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Expunge <span class="free">e2</span> <span class="bound">mo1</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">history</span> <span class="free">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms f1 f2 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> imap.Broadcast_Deliver_prefix_closed imap_axioms node_histories.prefix_of_appendD 
        node_histories_axioms prefix_elem_to_carriers<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">mo1</span></span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Expunge <span class="free">e2</span> <span class="skolem">mo1</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">history</span> <span class="free">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>  <span class="keyword1"><span class="command">using</span></span> assms f1 f2 f3
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fst_conv msg_id_unique network.delivery_has_a_cause network_axioms old.prod.inject 
        operation.inject<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> prefix_msg_in_history<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> imap<span class="main">)</span> expunge_delete_ids_imply_messages_same<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">is</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">j</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span><span class="main">,</span> Expunge <span class="free">e1</span> <span class="free">mo</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>node_deliver_messages <span class="free">xs</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ir</span><span class="main">,</span> Delete <span class="free">is</span> <span class="free">e2</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>node_deliver_messages <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">e1</span> <span class="main">=</span> <span class="free">e2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pre</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pre</span><span class="main">@</span><span class="main">[</span>Broadcast <span class="main">(</span><span class="free">ir</span><span class="main">,</span> Delete <span class="free">is</span> <span class="free">e2</span><span class="main">)</span><span class="main">]</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms delivery_has_a_cause events_before_exist prefix_msg_in_history <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>  
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Expunge <span class="free">e2</span> <span class="free">mo</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">history</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms expunge_delete_tag_causality
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> delivery_has_a_cause fst_conv network.msg_id_unique network_axioms 
        operation.inject<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> prefix_msg_in_history prod.inject<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> imap<span class="main">)</span> store_delete_ids_imply_messages_same<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">is</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">j</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span><span class="main">,</span> Store <span class="free">e1</span> <span class="free">mo</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>node_deliver_messages <span class="free">xs</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ir</span><span class="main">,</span> Delete <span class="free">is</span> <span class="free">e2</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>node_deliver_messages <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">e1</span> <span class="main">=</span> <span class="free">e2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pre</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pre</span><span class="main">@</span><span class="main">[</span>Broadcast <span class="main">(</span><span class="free">ir</span><span class="main">,</span> Delete <span class="free">is</span> <span class="free">e2</span><span class="main">)</span><span class="main">]</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms delivery_has_a_cause events_before_exist prefix_msg_in_history <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">have</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Append <span class="free">i</span> <span class="free">e2</span><span class="main">)</span> <span class="main">∉</span> set <span class="main">(</span><span class="free">history</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fst_conv msg_id_unique network.delivery_has_a_cause network_axioms old.prod.inject 
        operation.distinct<span class="main"><span class="main">(</span></span>17<span class="main"><span class="main">)</span></span> prefix_msg_in_history<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> f2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">mo</span><span class="main">.</span> Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Expunge <span class="free">e2</span> <span class="bound">mo</span> <span class="free">i</span><span class="main">)</span> <span class="main">∉</span> set <span class="main">(</span><span class="free">history</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pair_inject fst_conv msg_id_unique network.delivery_has_a_cause network_axioms 
        operation.distinct<span class="main"><span class="main">(</span></span>19<span class="main"><span class="main">)</span></span> prefix_msg_in_history<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> f3<span class="main">:</span> <span class="quoted"><span class="quoted">"Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Create <span class="free">i</span> <span class="free">e2</span><span class="main">)</span> <span class="main">∉</span> set <span class="main">(</span><span class="free">history</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fst_conv msg_id_unique network.delivery_has_a_cause network_axioms old.prod.inject 
        operation.distinct<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span> prefix_msg_in_history<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span> <span class="bound">mo1</span><span class="main">.</span> Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Store <span class="free">e2</span> <span class="bound">mo1</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">pre</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms P f1 f2 imap_axioms 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> imap.Broadcast_Deliver_prefix_closed prefix_elem_to_carriers prefix_of_appendD<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">mo1</span></span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
    f3<span class="main">:</span> <span class="quoted"><span class="quoted">"Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Store <span class="free">e2</span> <span class="skolem">mo1</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">pre</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> f4<span class="main">:</span> <span class="quoted"><span class="quoted">"Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Store <span class="free">e2</span> <span class="skolem">mo1</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">history</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> P prefix_elem_to_carriers <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Store <span class="free">e2</span> <span class="free">mo</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">pre</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> f2 f3 assms 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fst_conv msg_id_unique network.delivery_has_a_cause network_axioms old.prod.inject 
        operation.inject<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> prefix_msg_in_history<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Deliver<span class="main">(</span><span class="free">i</span><span class="main">,</span> Store <span class="free">e1</span> <span class="free">mo</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">history</span> <span class="free">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> prefix_msg_in_history <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> f4
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> delivery_has_a_cause fst_conv msg_id_unique old.prod.inject operation.inject<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> imap<span class="main">)</span> create_delete_ids_imply_messages_same<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">is</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">j</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span><span class="main">,</span> Create <span class="free">i</span> <span class="free">e1</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>node_deliver_messages <span class="free">xs</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ir</span><span class="main">,</span> Delete <span class="free">is</span> <span class="free">e2</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>node_deliver_messages <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">e1</span> <span class="main">=</span> <span class="free">e2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pre</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pre</span><span class="main">@</span><span class="main">[</span>Broadcast <span class="main">(</span><span class="free">ir</span><span class="main">,</span> Delete <span class="free">is</span> <span class="free">e2</span><span class="main">)</span><span class="main">]</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms delivery_has_a_cause events_before_exist prefix_msg_in_history <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Append <span class="free">i</span> <span class="free">e2</span><span class="main">)</span> <span class="main">∉</span> set <span class="main">(</span><span class="free">history</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> delivery_has_a_cause fst_conv network.msg_id_unique 
        network.prefix_msg_in_history network_axioms operation.distinct<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> prod.inject<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> f2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">mo</span><span class="main">.</span> Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Expunge <span class="free">e2</span> <span class="bound">mo</span> <span class="free">i</span><span class="main">)</span> <span class="main">∉</span> set <span class="main">(</span><span class="free">history</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> fst_conv msg_id_unique network.delivery_has_a_cause network_axioms 
        old.prod.inject operation.distinct<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> prefix_msg_in_history<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> f3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">mo</span><span class="main">.</span> Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Store <span class="free">e2</span> <span class="bound">mo</span> <span class="free">i</span><span class="main">)</span> <span class="main">∉</span> set <span class="main">(</span><span class="free">history</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pair_inject assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> delivery_has_a_cause fst_conv msg_id_unique 
        operation.distinct<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span> prefix_msg_in_history<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Create <span class="free">i</span> <span class="free">e2</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">pre</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms P f2 f1 imap_axioms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> imap.Broadcast_Deliver_prefix_closed  prefix_elem_to_carriers prefix_of_appendD<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> f1 f2 f3
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> P assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> delivery_has_a_cause fst_conv msg_id_unique 
        node_histories.prefix_of_appendD node_histories_axioms old.prod.inject operation.inject<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> 
        prefix_elem_to_carriers prefix_msg_in_history<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> imap<span class="main">)</span> append_delete_ids_imply_messages_same<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">is</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">j</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span><span class="main">,</span> Append <span class="free">i</span> <span class="free">e1</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>node_deliver_messages <span class="free">xs</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ir</span><span class="main">,</span> Delete <span class="free">is</span> <span class="free">e2</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>node_deliver_messages <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">e1</span> <span class="main">=</span> <span class="free">e2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pre</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pre</span><span class="main">@</span><span class="main">[</span>Broadcast <span class="main">(</span><span class="free">ir</span><span class="main">,</span> Delete <span class="free">is</span> <span class="free">e2</span><span class="main">)</span><span class="main">]</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms delivery_has_a_cause events_before_exist prefix_msg_in_history <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>  
  <span class="keyword1"><span class="command">hence</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">e</span><span class="main">.</span> <span class="bound">e</span> <span class="main">∈</span> set <span class="skolem">pre</span> <span class="main">⟹</span> <span class="bound">e</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">history</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prefix_elem_to_carriers <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> f2<span class="main">:</span> <span class="quoted"><span class="quoted">"Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Create <span class="free">i</span> <span class="free">e2</span><span class="main">)</span> <span class="main">∉</span> set <span class="skolem">pre</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> P f1
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> fst_conv msg_id_unique network.delivery_has_a_cause network_axioms 
        old.prod.inject operation.distinct<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> prefix_msg_in_history<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> D1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">mo</span><span class="main">.</span> Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Expunge <span class="free">e2</span> <span class="bound">mo</span> <span class="free">i</span><span class="main">)</span> <span class="main">∉</span> set <span class="skolem">pre</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> P f1
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pair_inject assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> fst_conv msg_id_unique network.delivery_has_a_cause 
        network_axioms operation.distinct<span class="main"><span class="main">(</span></span>15<span class="main"><span class="main">)</span></span> prefix_msg_in_history<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> D2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">mo</span><span class="main">.</span> Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Store <span class="free">e2</span> <span class="bound">mo</span> <span class="free">i</span><span class="main">)</span> <span class="main">∉</span> set <span class="skolem">pre</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> P f1
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pair_inject assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> fst_conv msg_id_unique network.delivery_has_a_cause 
        network_axioms operation.simps<span class="main"><span class="main">(</span></span>23<span class="main"><span class="main">)</span></span> prefix_msg_in_history<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Append <span class="free">i</span> <span class="free">e2</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">pre</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> P D1 D2 f2 assms<span class="main">(</span>1<span class="main">)</span> Broadcast_Deliver_prefix_closed <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Append <span class="free">i</span> <span class="free">e1</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">history</span> <span class="free">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> prefix_msg_in_history <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> f1 msg_id_unique network.delivery_has_a_cause network_axioms old.prod.inject 
        operation.inject<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> prod.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> imap<span class="main">)</span> append_expunge_ids_imply_messages_same<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="free">mo</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">j</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span><span class="main">,</span> Append <span class="free">i</span> <span class="free">e1</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>node_deliver_messages <span class="free">xs</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span><span class="main">,</span> Expunge <span class="free">e2</span> <span class="free">mo</span> <span class="free">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>node_deliver_messages <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">e1</span> <span class="main">=</span> <span class="free">e2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pre</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> pre<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pre</span><span class="main">@</span><span class="main">[</span>Broadcast <span class="main">(</span><span class="free">r</span><span class="main">,</span> Expunge <span class="free">e2</span> <span class="free">mo</span> <span class="free">r</span><span class="main">)</span><span class="main">]</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms delivery_has_a_cause events_before_exist prefix_msg_in_history <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>  
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"Deliver <span class="main">(</span><span class="free">mo</span><span class="main">,</span> Append <span class="free">mo</span> <span class="free">e2</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">pre</span> <span class="main">∨</span> 
  <span class="main">(</span><span class="main">∃</span> <span class="bound">mo2</span> <span class="main">.</span> Deliver <span class="main">(</span><span class="free">mo</span><span class="main">,</span> Store <span class="free">e2</span> <span class="bound">mo2</span> <span class="free">mo</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">pre</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Broadcast_Expunge_Deliver_prefix_closed assms<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> imap.Broadcast_Deliver_prefix_closed imap_axioms<span class="main">)</span>      
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Append <span class="free">i</span> <span class="free">e2</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">pre</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> pre delivery_has_a_cause fst_conv hb_broadcast_exists1 
        msg_id_unique network.hb_deliver network.prefix_msg_in_history network_axioms 
        node_histories.events_in_local_order node_histories_axioms operation.distinct<span class="main"><span class="main">(</span></span>17<span class="main"><span class="main">)</span></span> 
        prod.inject<span class="main">)</span>     
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Append <span class="free">i</span> <span class="free">e1</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">history</span> <span class="free">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> prefix_msg_in_history <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> fst_conv network.delivery_has_a_cause network.msg_id_unique 
        network_axioms operation.inject<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> prefix_elem_to_carriers prefix_of_appendD prod.inject<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> imap<span class="main">)</span> append_store_ids_imply_messages_same<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="free">mo</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">j</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span><span class="main">,</span> Append <span class="free">i</span> <span class="free">e1</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>node_deliver_messages <span class="free">xs</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span><span class="main">,</span> Store <span class="free">e2</span> <span class="free">mo</span> <span class="free">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>node_deliver_messages <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">e1</span> <span class="main">=</span> <span class="free">e2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pre</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pre</span><span class="main">@</span><span class="main">[</span>Broadcast <span class="main">(</span><span class="free">r</span><span class="main">,</span> Store <span class="free">e2</span> <span class="free">mo</span> <span class="free">r</span><span class="main">)</span><span class="main">]</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms delivery_has_a_cause events_before_exist prefix_msg_in_history <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>  
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"Deliver <span class="main">(</span><span class="free">mo</span><span class="main">,</span> Append <span class="free">mo</span> <span class="free">e2</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">pre</span> <span class="main">∨</span> 
  <span class="main">(</span><span class="main">∃</span> <span class="bound">mo2</span> <span class="main">.</span> Deliver <span class="main">(</span><span class="free">mo</span><span class="main">,</span> Store <span class="free">e2</span> <span class="bound">mo2</span> <span class="free">mo</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">pre</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Broadcast_Store_Deliver_prefix_closed assms<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> imap.Broadcast_Deliver_prefix_closed imap_axioms<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Append <span class="free">i</span> <span class="free">e1</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">history</span> <span class="free">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> prefix_msg_in_history <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Append <span class="free">i</span> <span class="free">e2</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">pre</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms P A
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pair_inject assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> P delivery_has_a_cause fst_conv msg_id_unique 
        operation.simps<span class="main"><span class="main">(</span></span>23<span class="main"><span class="main">)</span></span> prefix_elem_to_carriers prefix_of_appendD<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> f1
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> P delivery_has_a_cause fst_conv msg_id_unique 
        node_histories.prefix_of_appendD node_histories_axioms operation.inject<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> 
        prefix_elem_to_carriers prod.inject<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> imap<span class="main">)</span> expunge_store_ids_imply_messages_same<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">j</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span><span class="main">,</span> Store <span class="free">e1</span> <span class="free">mo</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>node_deliver_messages <span class="free">xs</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span><span class="main">,</span> Expunge <span class="free">e2</span> <span class="free">i</span> <span class="free">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>node_deliver_messages <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">e1</span> <span class="main">=</span> <span class="free">e2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pre</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pre</span><span class="main">@</span><span class="main">[</span>Broadcast <span class="main">(</span><span class="free">r</span><span class="main">,</span> Expunge <span class="free">e2</span> <span class="free">i</span> <span class="free">r</span><span class="main">)</span><span class="main">]</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms delivery_has_a_cause events_before_exist prefix_msg_in_history <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">hence</span></span> pprefix<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pre</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> P <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Append <span class="free">i</span> <span class="free">e2</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">pre</span> <span class="main">∨</span> 
  <span class="main">(</span><span class="main">∃</span> <span class="bound">mo2</span> <span class="main">.</span> Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Store <span class="free">e2</span> <span class="bound">mo2</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">pre</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Broadcast_Expunge_Deliver_prefix_closed assms<span class="main">(</span>1<span class="main">)</span> P <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>      
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Store <span class="free">e2</span> <span class="free">mo</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">pre</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms A P
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">op1</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> operation <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      f1<span class="main">:</span> <span class="quoted"><span class="quoted">"Broadcast <span class="main">(</span><span class="free">i</span><span class="main">,</span> Store <span class="free">e1</span> <span class="free">mo</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">history</span> <span class="main">(</span><span class="skolem">op1</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> Store <span class="free">e1</span> <span class="free">mo</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> delivery_has_a_cause prefix_msg_in_history<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">using</span></span> f1 A pprefix delivery_has_a_cause network.msg_id_unique network_axioms 
        node_histories.prefix_to_carriers node_histories_axioms 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Store <span class="free">e1</span> <span class="free">mo</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">history</span> <span class="free">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> prefix_msg_in_history <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms P
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> delivery_has_a_cause fst_conv msg_id_unique operation.inject<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> 
        prefix_elem_to_carriers prefix_of_appendD prod.inject<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> imap<span class="main">)</span> store_store_ids_imply_messages_same<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">j</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span><span class="main">,</span> Store <span class="free">e1</span> <span class="free">mo</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>node_deliver_messages <span class="free">xs</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span><span class="main">,</span> Store <span class="free">e2</span> <span class="free">i</span> <span class="free">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>node_deliver_messages <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">e1</span> <span class="main">=</span> <span class="free">e2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pre</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pre</span><span class="main">@</span><span class="main">[</span>Broadcast <span class="main">(</span><span class="free">r</span><span class="main">,</span> Store <span class="free">e2</span> <span class="free">i</span> <span class="free">r</span><span class="main">)</span><span class="main">]</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms delivery_has_a_cause events_before_exist prefix_msg_in_history <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>  
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Append <span class="free">i</span> <span class="free">e2</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">pre</span> <span class="main">∨</span>
    <span class="main">(</span><span class="main">∃</span> <span class="bound">mo2</span> <span class="main">.</span> Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Store <span class="free">e2</span> <span class="bound">mo2</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">pre</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Broadcast_Store_Deliver_prefix_closed assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">e</span><span class="main">.</span> <span class="bound">e</span> <span class="main">∉</span> set <span class="skolem">pre</span> <span class="main">∨</span> <span class="bound">e</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">history</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> P prefix_elem_to_carriers <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Store <span class="free">e2</span> <span class="free">mo</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">pre</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> A assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> delivery_has_a_cause fst_conv msg_id_unique 
        operation.distinct<span class="main"><span class="main">(</span></span>17<span class="main"><span class="main">)</span></span> operation.inject<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> prefix_msg_in_history prod.inject<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Deliver <span class="main">(</span><span class="free">i</span><span class="main">,</span> Store <span class="free">e1</span> <span class="free">mo</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">history</span> <span class="free">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> prefix_msg_in_history <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pair_inject delivery_has_a_cause msg_id_unique operation.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> 
        prefix_elem_to_carriers prefix_of_appendD prod.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> 

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="IMAP-proof">
<div class="head">
<h1>Theory IMAP-proof</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Convergence of the IMAP-CRDT›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹In this final section show that concurrent updates commute and thus Strong Eventual 
Convergence is achieved.›</span></span>

<span class="keyword1"><span class="command">theory</span></span>
  <span class="quoted">"IMAP-proof"</span>
  <span class="keyword2"><span class="keyword">imports</span></span>
    <span class="quoted">"<a href="IMAP-def.html">IMAP-def</a>"</span>
    <span class="quoted">"<a href="IMAP-proof-commute.html">IMAP-proof-commute</a>"</span>
    <span class="quoted">"<a href="IMAP-proof-helpers.html">IMAP-proof-helpers</a>"</span>
    <span class="quoted">"<a href="IMAP-proof-independent.html">IMAP-proof-independent</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">corollary</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> imap<span class="main">)</span> concurrent_create_delete_independent<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> hb <span class="main">(</span><span class="free">i</span><span class="main">,</span> Create <span class="free">i</span> <span class="free">e1</span><span class="main">)</span> <span class="main">(</span><span class="free">ir</span><span class="main">,</span> Delete <span class="free">is</span> <span class="free">e2</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> hb <span class="main">(</span><span class="free">ir</span><span class="main">,</span> Delete <span class="free">is</span> <span class="free">e2</span><span class="main">)</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> Create <span class="free">i</span> <span class="free">e1</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">j</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span><span class="main">,</span> Create <span class="free">i</span> <span class="free">e1</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>node_deliver_messages <span class="free">xs</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ir</span><span class="main">,</span> Delete <span class="free">is</span> <span class="free">e2</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>node_deliver_messages <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∉</span> <span class="free">is</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms create_delete_ids_imply_messages_same concurrent_create_delete_independent_technical 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">corollary</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> imap<span class="main">)</span> concurrent_append_delete_independent<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> hb <span class="main">(</span><span class="free">i</span><span class="main">,</span> Append <span class="free">i</span> <span class="free">e1</span><span class="main">)</span> <span class="main">(</span><span class="free">ir</span><span class="main">,</span> Delete <span class="free">is</span> <span class="free">e2</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> hb <span class="main">(</span><span class="free">ir</span><span class="main">,</span> Delete <span class="free">is</span> <span class="free">e2</span><span class="main">)</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> Append <span class="free">i</span> <span class="free">e1</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">j</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span><span class="main">,</span> Append <span class="free">i</span> <span class="free">e1</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>node_deliver_messages <span class="free">xs</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ir</span><span class="main">,</span> Delete <span class="free">is</span> <span class="free">e2</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>node_deliver_messages <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∉</span> <span class="free">is</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms append_delete_ids_imply_messages_same concurrent_append_delete_independent_technical 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">corollary</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> imap<span class="main">)</span> concurrent_append_expunge_independent<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> hb <span class="main">(</span><span class="free">i</span><span class="main">,</span> Append <span class="free">i</span> <span class="free">e1</span><span class="main">)</span> <span class="main">(</span><span class="free">r</span><span class="main">,</span> Expunge <span class="free">e2</span> <span class="free">mo</span> <span class="free">r</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> hb <span class="main">(</span><span class="free">r</span><span class="main">,</span> Expunge <span class="free">e2</span> <span class="free">mo</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> Append <span class="free">i</span> <span class="free">e1</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">j</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span><span class="main">,</span> Append <span class="free">i</span> <span class="free">e1</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>node_deliver_messages <span class="free">xs</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span><span class="main">,</span> Expunge <span class="free">e2</span> <span class="free">mo</span> <span class="free">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>node_deliver_messages <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≠</span> <span class="free">mo</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms append_expunge_ids_imply_messages_same concurrent_append_expunge_independent_technical 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">corollary</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> imap<span class="main">)</span> concurrent_append_store_independent<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> hb <span class="main">(</span><span class="free">i</span><span class="main">,</span> Append <span class="free">i</span> <span class="free">e1</span><span class="main">)</span> <span class="main">(</span><span class="free">r</span><span class="main">,</span> Store <span class="free">e2</span> <span class="free">mo</span> <span class="free">r</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> hb <span class="main">(</span><span class="free">r</span><span class="main">,</span> Store <span class="free">e2</span> <span class="free">mo</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> Append <span class="free">i</span> <span class="free">e1</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">j</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span><span class="main">,</span> Append <span class="free">i</span> <span class="free">e1</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>node_deliver_messages <span class="free">xs</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span><span class="main">,</span> Store <span class="free">e2</span> <span class="free">mo</span> <span class="free">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>node_deliver_messages <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≠</span> <span class="free">mo</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms append_store_ids_imply_messages_same concurrent_append_store_independent_technical 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">corollary</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> imap<span class="main">)</span> concurrent_expunge_delete_independent<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> hb <span class="main">(</span><span class="free">i</span><span class="main">,</span> Expunge <span class="free">e1</span> <span class="free">mo</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="free">ir</span><span class="main">,</span> Delete <span class="free">is</span> <span class="free">e2</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> hb <span class="main">(</span><span class="free">ir</span><span class="main">,</span> Delete <span class="free">is</span> <span class="free">e2</span><span class="main">)</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> Expunge <span class="free">e1</span> <span class="free">mo</span> <span class="free">i</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">j</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span><span class="main">,</span> Expunge <span class="free">e1</span> <span class="free">mo</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>node_deliver_messages <span class="free">xs</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ir</span><span class="main">,</span> Delete <span class="free">is</span> <span class="free">e2</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>node_deliver_messages <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∉</span> <span class="free">is</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms expunge_delete_ids_imply_messages_same concurrent_expunge_delete_independent_technical 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">corollary</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> imap<span class="main">)</span> concurrent_store_delete_independent<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> hb <span class="main">(</span><span class="free">i</span><span class="main">,</span> Store <span class="free">e1</span> <span class="free">mo</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="free">ir</span><span class="main">,</span> Delete <span class="free">is</span> <span class="free">e2</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> hb <span class="main">(</span><span class="free">ir</span><span class="main">,</span> Delete <span class="free">is</span> <span class="free">e2</span><span class="main">)</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> Store <span class="free">e1</span> <span class="free">mo</span> <span class="free">i</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">j</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span><span class="main">,</span> Store <span class="free">e1</span> <span class="free">mo</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>node_deliver_messages <span class="free">xs</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ir</span><span class="main">,</span> Delete <span class="free">is</span> <span class="free">e2</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>node_deliver_messages <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∉</span> <span class="free">is</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms store_delete_ids_imply_messages_same concurrent_store_delete_independent_technical 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">corollary</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> imap<span class="main">)</span> concurrent_store_expunge_independent<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> hb <span class="main">(</span><span class="free">i</span><span class="main">,</span> Store <span class="free">e1</span> <span class="free">mo</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="free">r</span><span class="main">,</span> Expunge <span class="free">e2</span> <span class="free">mo2</span> <span class="free">r</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> hb <span class="main">(</span><span class="free">r</span><span class="main">,</span> Expunge <span class="free">e2</span> <span class="free">mo2</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> Store <span class="free">e1</span> <span class="free">mo</span> <span class="free">i</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">j</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span><span class="main">,</span> Store <span class="free">e1</span> <span class="free">mo</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>node_deliver_messages <span class="free">xs</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span><span class="main">,</span> Expunge <span class="free">e2</span> <span class="free">mo2</span> <span class="free">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>node_deliver_messages <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≠</span> <span class="free">mo2</span> <span class="main">∧</span> <span class="free">r</span> <span class="main">≠</span> <span class="free">mo</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms expunge_store_ids_imply_messages_same concurrent_store_expunge_independent_technical2 
    concurrent_store_expunge_independent_technical <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>


<span class="keyword1"><span class="command">corollary</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> imap<span class="main">)</span> concurrent_store_store_independent<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> hb <span class="main">(</span><span class="free">i</span><span class="main">,</span> Store <span class="free">e1</span> <span class="free">mo</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="free">r</span><span class="main">,</span> Store <span class="free">e2</span> <span class="free">mo2</span> <span class="free">r</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> hb <span class="main">(</span><span class="free">r</span><span class="main">,</span> Store <span class="free">e2</span> <span class="free">mo2</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> Store <span class="free">e1</span> <span class="free">mo</span> <span class="free">i</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">j</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span><span class="main">,</span> Store <span class="free">e1</span> <span class="free">mo</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>node_deliver_messages <span class="free">xs</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span><span class="main">,</span> Store <span class="free">e2</span> <span class="free">mo2</span> <span class="free">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>node_deliver_messages <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≠</span> <span class="free">mo2</span> <span class="main">∧</span> <span class="free">r</span> <span class="main">≠</span> <span class="free">mo</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms store_store_ids_imply_messages_same concurrent_store_store_independent_technical 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> imap<span class="main">)</span> concurrent_operations_commute<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"hb.concurrent_ops_commute <span class="main">(</span>node_deliver_messages <span class="free">xs</span><span class="main">)</span>"</span></span>                     
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">x</span> <span class="skolem">y</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>node_deliver_messages <span class="free">xs</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>node_deliver_messages <span class="free">xs</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"hb.concurrent <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"interp_msg <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">⊳</span> interp_msg <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">=</span> interp_msg <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">⊳</span> interp_msg <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold</span> interp_msg_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem">y</span></span></span></span></span>"</span></span></span></span></span></span><span class="main"><span class="keyword3">;</span></span> 
          <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> create_create_commute delete_delete_commute append_append_commute 
          create_append_commute create_expunge_commute create_store_commute 
          expunge_expunge_commute hb.concurrent_def<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> assms prefix_contains_msg <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> 
          create_id_valid create_delete_commute concurrent_create_delete_independent<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> assms prefix_contains_msg <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> 
          create_id_valid create_delete_commute concurrent_create_delete_independent<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> assms prefix_contains_msg <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> 
          append_id_valid append_delete_ids_imply_messages_same 
          concurrent_append_delete_independent_technical delete_append_commute<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> assms prefix_contains_msg <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> 
          concurrent_expunge_delete_independent expunge_id_valid imap.delete_expunge_commute 
          imap_axioms<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> assms prefix_contains_msg <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> 
          concurrent_store_delete_independent delete_store_commute store_id_valid<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> assms prefix_contains_msg <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> 
          append_id_valid append_delete_ids_imply_messages_same 
          concurrent_append_delete_independent_technical delete_append_commute<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> assms prefix_contains_msg <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> 
          append_id_valid expunge_id_valid append_expunge_ids_imply_messages_same 
          concurrent_append_expunge_independent_technical append_expunge_commute<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> assms prefix_contains_msg <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> 
          append_id_valid append_store_commute concurrent_append_store_independent store_id_valid<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> assms prefix_contains_msg <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> 
          concurrent_expunge_delete_independent expunge_id_valid delete_expunge_commute<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> assms prefix_contains_msg <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> 
          append_expunge_commute append_id_valid concurrent_append_expunge_independent 
          expunge_id_valid<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> assms prefix_contains_msg <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> 
          expunge_id_valid expunge_store_commute imap.concurrent_store_expunge_independent 
          imap_axioms store_id_valid<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> assms prefix_contains_msg <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> 
          concurrent_store_delete_independent delete_store_commute store_id_valid<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> assms prefix_contains_msg <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> 
          append_id_valid append_store_commute imap.concurrent_append_store_independent imap_axioms 
          store_id_valid<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> assms prefix_contains_msg <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> 
          expunge_id_valid expunge_store_commute imap.concurrent_store_expunge_independent 
          imap_axioms store_id_valid<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> assms prefix_contains_msg <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> concurrent_store_store_independent store_id_valid 
          store_store_commute<span class="main">)</span>   
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> hb.concurrent_ops_commute_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> imap<span class="main">)</span> convergence<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>node_deliver_messages <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>node_deliver_messages <span class="free">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">i</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"apply_operations <span class="free">xs</span> <span class="main">=</span> apply_operations <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> apply_operations_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> hb.convergence_ext 
      concurrent_operations_commute node_deliver_messages_distinct hb_consistent_prefix<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span> imap <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> sec<span class="main">:</span> strong_eventual_consistency <span class="quoted">weak_hb</span> <span class="quoted">hb</span> <span class="quoted">interp_msg</span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">ops</span><span class="main">.</span><span class="main">∃</span><span class="bound">xs</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">xs</span> <span class="keyword1">prefix</span> <span class="keyword1">of</span> <span class="bound">i</span> <span class="main">∧</span> node_deliver_messages <span class="bound">xs</span> <span class="main">=</span> <span class="bound">ops</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span><span class="main">(</span><span class="main">{}</span><span class="main">,</span><span class="main">{}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hb_consistent_prefix node_deliver_messages_distinct
      concurrent_operations_commute<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> apply_operations_def bind.bind_lunit not_None_eq
      hb.apply_operations_Snoc kleisli_def apply_operations_never_fails interp_msg_def<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> drop_last_message <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div>