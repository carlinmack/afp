<div id="Imperative_Loops">
<div class="head">
<h1>Theory Imperative_Loops</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      Imperative_Loops
    Author:     Christian Sternagel
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Looping Constructs for Imperative HOL›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Imperative_Loops
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Imperative_HOL/Imperative_HOL.html">HOL-Imperative_HOL.Imperative_HOL</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹While Loops›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We would have liked to restrict to read-only loop conditions using a condition of
  type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"heap <span class="main"><span class="main">⇒</span></span> bool"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> together with <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> tap<span class="antiquote"><span class="antiquote">}</span></span></span></span>. However, this does not allow
  for code generation due to breaking the heap-abstraction.
›</span></span>
<span class="keyword1"><span class="command">partial_function</span></span> <span class="main">(</span>heap<span class="main">)</span> <span class="entity">while</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool Heap <span class="main">⇒</span> <span class="tfree">'b</span> Heap <span class="main">⇒</span> unit Heap"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">while</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">b</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">;</span>
    <span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">⪢</span> <span class="free">while</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>
    <span class="keyword1">else</span> return <span class="main">()</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">cond</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">⟷</span> fst <span class="main">(</span>the <span class="main">(</span>execute <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A locale that restricts to read-only loop conditions.›</span></span>
<span class="keyword1"><span class="command">locale</span></span> ro_cond <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool Heap"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> read_only<span class="main">:</span> <span class="quoted"><span class="quoted">"success <span class="free">p</span> <span class="free">h</span> <span class="main">⟹</span> snd <span class="main">(</span>the <span class="main">(</span>execute <span class="free">p</span> <span class="free">h</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">h</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Imperative_Loops-ro_cond"><span class="command">lemma</span></span> ro_cond<span class="main">:</span> <span class="quoted"><span class="quoted">"ro_cond <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> read_only <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ro_cond_def<span class="main">)</span>

<span class="keyword1" id="Imperative_Loops-cond_cases"><span class="command">lemma</span></span> cond_cases <span class="main">[</span><span class="operator">execute_simps</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"success <span class="free">p</span> <span class="free">h</span> <span class="main">⟹</span> cond <span class="free">p</span> <span class="free">h</span> <span class="main">⟹</span> execute <span class="free">p</span> <span class="free">h</span> <span class="main">=</span> Some <span class="main">(</span>True<span class="main">,</span> <span class="free">h</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"success <span class="free">p</span> <span class="free">h</span> <span class="main">⟹</span> <span class="main">¬</span> cond <span class="free">p</span> <span class="free">h</span> <span class="main">⟹</span> execute <span class="free">p</span> <span class="free">h</span> <span class="main">=</span> Some <span class="main">(</span>False<span class="main">,</span> <span class="free">h</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> read_only <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">h</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cond_def success_def<span class="main">)</span>

<span class="keyword1" id="Imperative_Loops-execute_while_unfolds"><span class="command">lemma</span></span> execute_while_unfolds <span class="main">[</span><span class="operator">execute_simps</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"success <span class="free">p</span> <span class="free">h</span> <span class="main">⟹</span> cond <span class="free">p</span> <span class="free">h</span> <span class="main">⟹</span> execute <span class="main">(</span>while <span class="free">p</span> <span class="free">f</span><span class="main">)</span> <span class="free">h</span> <span class="main">=</span> execute <span class="main">(</span><span class="free">f</span> <span class="main">⪢</span> while <span class="free">p</span> <span class="free">f</span><span class="main">)</span> <span class="free">h</span>"</span></span>
  <span class="quoted"><span class="quoted">"success <span class="free">p</span> <span class="free">h</span> <span class="main">⟹</span> <span class="main">¬</span> cond <span class="free">p</span> <span class="free">h</span> <span class="main">⟹</span> execute <span class="main">(</span>while <span class="free">p</span> <span class="free">f</span><span class="main">)</span> <span class="free">h</span> <span class="main">=</span> execute <span class="main">(</span>return <span class="main">()</span><span class="main">)</span> <span class="free">h</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> while.simps <span class="dynamic"><span class="dynamic">execute_simps</span></span><span class="main">)</span>

<span class="keyword1" id="Imperative_Loops-success_while_cond"><span class="command">lemma</span></span>
  success_while_cond<span class="main">:</span> <span class="quoted"><span class="quoted">"success <span class="free">p</span> <span class="free">h</span> <span class="main">⟹</span> cond <span class="free">p</span> <span class="free">h</span> <span class="main">⟹</span> effect <span class="free">f</span> <span class="free">h</span> <span class="free">h'</span> <span class="free">r</span> <span class="main">⟹</span> success <span class="main">(</span>while <span class="free">p</span> <span class="free">f</span><span class="main">)</span> <span class="free">h'</span> <span class="main">⟹</span>
    success <span class="main">(</span>while <span class="free">p</span> <span class="free">f</span><span class="main">)</span> <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  success_while_not_cond<span class="main">:</span> <span class="quoted"><span class="quoted">"success <span class="free">p</span> <span class="free">h</span> <span class="main">⟹</span> <span class="main">¬</span> cond <span class="free">p</span> <span class="free">h</span> <span class="main">⟹</span> success <span class="main">(</span>while <span class="free">p</span> <span class="free">f</span><span class="main">)</span> <span class="free">h</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> while.simps effect_def <span class="dynamic"><span class="dynamic">execute_simps</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">success_intros</span></span><span class="main">)</span>

<span class="keyword1" id="Imperative_Loops-success_cond_effect"><span class="command">lemma</span></span> success_cond_effect<span class="main">:</span>
  <span class="quoted"><span class="quoted">"success <span class="free">p</span> <span class="free">h</span> <span class="main">⟹</span> cond <span class="free">p</span> <span class="free">h</span> <span class="main">⟹</span> effect <span class="free">p</span> <span class="free">h</span> <span class="free">h</span> True"</span></span>
  <span class="keyword1"><span class="command">using</span></span> read_only <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">h</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> effect_def <span class="dynamic"><span class="dynamic">execute_simps</span></span><span class="main">)</span>

<span class="keyword1" id="Imperative_Loops-success_not_cond_effect"><span class="command">lemma</span></span> success_not_cond_effect<span class="main">:</span>
  <span class="quoted"><span class="quoted">"success <span class="free">p</span> <span class="free">h</span> <span class="main">⟹</span> <span class="main">¬</span> cond <span class="free">p</span> <span class="free">h</span> <span class="main">⟹</span> effect <span class="free">p</span> <span class="free">h</span> <span class="free">h</span> False"</span></span>
  <span class="keyword1"><span class="command">using</span></span> read_only <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">h</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> effect_def <span class="dynamic"><span class="dynamic">execute_simps</span></span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The loop-condition does no longer hold after the loop is finished.›</span></span>
<span class="keyword1" id="Imperative_Loops-ro_cond_effect_while_post"><span class="command">lemma</span></span> ro_cond_effect_while_post<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ro_cond <span class="free">p</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"effect <span class="main">(</span>while <span class="free">p</span> <span class="free">f</span><span class="main">)</span> <span class="free">h</span> <span class="free">h'</span> <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"success <span class="free">p</span> <span class="free">h'</span> <span class="main">∧</span> <span class="main">¬</span> cond <span class="free">p</span> <span class="free">h'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> while.raw_induct <span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">effect_elims</span></span> effect_ifE <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cond_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> effectE ro_cond.read_only<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A rule for proving partial correctness of while loops.›</span></span>
<span class="keyword1" id="Imperative_Loops-ro_cond_effect_while_induct"><span class="command">lemma</span></span> ro_cond_effect_while_induct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ro_cond <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"effect <span class="main">(</span>while <span class="free">p</span> <span class="free">f</span><span class="main">)</span> <span class="free">h</span> <span class="free">h'</span> <span class="free">u</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">h</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">h</span> <span class="bound">h'</span> <span class="bound">u</span><span class="main">.</span> <span class="free">I</span> <span class="bound">h</span> <span class="main">⟹</span> success <span class="free">p</span> <span class="bound">h</span> <span class="main">⟹</span> cond <span class="free">p</span> <span class="bound">h</span> <span class="main">⟹</span> effect <span class="free">f</span> <span class="bound">h</span> <span class="bound">h'</span> <span class="bound">u</span> <span class="main">⟹</span> <span class="free">I</span> <span class="bound">h'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">h'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span> 3-<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">h</span></span> <span class="quoted"><span class="free">h'</span></span> <span class="quoted"><span class="free">u</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> while.raw_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">w</span> <span class="skolem">p</span> <span class="skolem">f</span> <span class="skolem">h</span> <span class="skolem">h'</span> <span class="skolem">u</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"effect <span class="skolem">p</span> <span class="skolem">h</span> <span class="skolem">h</span> <span class="skolem">b</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"effect <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">b</span> <span class="keyword1">then</span> <span class="skolem">f</span> <span class="main">⪢</span> <span class="skolem">w</span> <span class="skolem">p</span> <span class="skolem">f</span> <span class="keyword1">else</span> return <span class="main">()</span><span class="main">)</span> <span class="skolem">h</span> <span class="skolem">h'</span> <span class="skolem">u</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.hyps"</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹ro_cond <span class="skolem">p</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">effect_elims</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">effect_intros</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> effectE ro_cond.read_only<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> cond<span class="main">:</span> <span class="quoted"><span class="quoted">"success <span class="skolem">p</span> <span class="skolem">h</span>"</span></span> <span class="quoted"><span class="quoted">"cond <span class="skolem">p</span> <span class="skolem">h</span> <span class="main">=</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cond_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">effect_elims</span></span> effectE<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">b</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">I</span> <span class="skolem">h</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">effect_elims</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> * <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">h''</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">r</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"effect <span class="skolem">f</span> <span class="skolem">h</span> <span class="skolem">h''</span> <span class="skolem">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"effect <span class="main">(</span><span class="skolem">w</span> <span class="skolem">p</span> <span class="skolem">f</span><span class="main">)</span> <span class="skolem">h''</span> <span class="skolem">h'</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">effect_elims</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command"><span class="improper">ultimately</span></span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword2"><span class="keyword">and</span></span> cond <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">fact</span>

<span class="keyword1" id="Imperative_Loops-effect_success_conv"><span class="command">lemma</span></span> effect_success_conv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">h'</span><span class="main">.</span> effect <span class="free">c</span> <span class="free">h</span> <span class="bound">h'</span> <span class="main">()</span> <span class="main">∧</span> <span class="free">I</span> <span class="bound">h'</span><span class="main">)</span> <span class="main">⟷</span> success <span class="free">c</span> <span class="free">h</span> <span class="main">∧</span> <span class="free">I</span> <span class="main">(</span>snd <span class="main">(</span>the <span class="main">(</span>execute <span class="free">c</span> <span class="free">h</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> success_def effect_def<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span> ro_cond
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemmas</span></span>
  effect_while_post <span class="main">=</span> ro_cond_effect_while_post <span class="main">[</span><span class="operator">OF</span> ro_cond<span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span>
  effect_while_induct <span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> base step<span class="main">]</span> <span class="main">=</span> ro_cond_effect_while_induct <span class="main">[</span><span class="operator">OF</span> ro_cond<span class="main">]</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A rule for proving total correctness of while loops.›</span></span>
<span class="keyword1" id="Imperative_Loops-wf_while_induct"><span class="command">lemma</span></span> wf_while_induct <span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> success_cond success_body base step<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf <span class="free">R</span>"</span></span> <span class="comment1">― ‹a well-founded relation on heaps proving termination of the loop›</span>
    <span class="keyword2"><span class="keyword">and</span></span> success_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">h</span><span class="main">.</span> <span class="free">I</span> <span class="bound">h</span> <span class="main">⟹</span> success <span class="free">p</span> <span class="bound">h</span>"</span></span> <span class="comment1">― ‹the loop-condition terminates›</span>
    <span class="keyword2"><span class="keyword">and</span></span> success_f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">h</span><span class="main">.</span> <span class="free">I</span> <span class="bound">h</span> <span class="main">⟹</span> success <span class="free">p</span> <span class="bound">h</span> <span class="main">⟹</span> cond <span class="free">p</span> <span class="bound">h</span> <span class="main">⟹</span> success <span class="free">f</span> <span class="bound">h</span>"</span></span> <span class="comment1">― ‹the loop-body terminates›</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">h</span>"</span></span> <span class="comment1">― ‹the invariant holds before the loop is entered›</span>
    <span class="keyword2"><span class="keyword">and</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">h</span> <span class="bound">h'</span> <span class="bound">r</span><span class="main">.</span> <span class="free">I</span> <span class="bound">h</span> <span class="main">⟹</span> success <span class="free">p</span> <span class="bound">h</span> <span class="main">⟹</span> cond <span class="free">p</span> <span class="bound">h</span> <span class="main">⟹</span> effect <span class="free">f</span> <span class="bound">h</span> <span class="bound">h'</span> <span class="bound">r</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">h'</span><span class="main">,</span> <span class="bound">h</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">∧</span> <span class="free">I</span> <span class="bound">h'</span>"</span></span>
       <span class="comment1">― ‹the invariant is preserved by iterating the loop›</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">h'</span><span class="main">.</span> effect <span class="main">(</span>while <span class="free">p</span> <span class="free">f</span><span class="main">)</span> <span class="free">h</span> <span class="bound">h'</span> <span class="main">()</span> <span class="main">∧</span> <span class="free">I</span> <span class="bound">h'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹wf <span class="free">R</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">I</span> <span class="free">h</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">h</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">h</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"cond <span class="free">p</span> <span class="skolem">h</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> cond <span class="free">p</span> <span class="skolem">h</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">I</span> <span class="skolem">h</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> success_p <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">h</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> effect_def <span class="dynamic"><span class="dynamic">execute_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"cond <span class="free">p</span> <span class="skolem">h</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">I</span> <span class="skolem">h</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> success_f <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">h</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> step <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">h</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> success_p <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">h</span></span><span class="main">]</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">h'</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"effect <span class="free">f</span> <span class="skolem">h</span> <span class="skolem">h'</span> <span class="skolem">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">h'</span><span class="main">,</span> <span class="skolem">h</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="skolem">h'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"success <span class="free">p</span> <span class="skolem">h</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> success_def effect_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> less.IH <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">h'</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹cond <span class="free">p</span> <span class="skolem">h</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">execute_simps</span></span> effect_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A rule for proving termination of while loops.›</span></span>
<span class="keyword1"><span class="command">lemmas</span></span>
  success_while_induct <span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> success_cond success_body base step<span class="main">]</span> <span class="main">=</span>
    wf_while_induct <span class="main">[</span><span class="operator">unfolded</span> effect_success_conv<span class="main">,</span> <span class="operator">THEN</span> conjunct1<span class="main">]</span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹For Loops›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="quoted">"<span class="entity">for</span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> Heap<span class="main">)</span> <span class="main">⇒</span> unit Heap"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">for</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> return <span class="main">()</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">for</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⪢</span> <span class="free">for</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A rule for proving partial correctness of for loops.›</span></span>
<span class="keyword1" id="Imperative_Loops-effect_for_induct"><span class="command">lemma</span></span> effect_for_induct <span class="main">[</span><span class="operator">consumes</span> 2<span class="main">,</span> <span class="operator">case_names</span> base step<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"effect <span class="main">(</span>for <span class="main">[</span><span class="free">i</span> <span class="main">..&lt;</span> <span class="free">j</span><span class="main">]</span> <span class="free">f</span><span class="main">)</span> <span class="free">h</span> <span class="free">h'</span> <span class="free">u</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">i</span> <span class="free">h</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span> <span class="bound">h</span> <span class="bound">h'</span> <span class="bound">r</span><span class="main">.</span> <span class="free">i</span> <span class="main">≤</span> <span class="bound">k</span> <span class="main">⟹</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">⟹</span> <span class="free">I</span> <span class="bound">k</span> <span class="bound">h</span> <span class="main">⟹</span> effect <span class="main">(</span><span class="free">f</span> <span class="bound">k</span><span class="main">)</span> <span class="bound">h</span> <span class="bound">h'</span> <span class="bound">r</span> <span class="main">⟹</span> <span class="free">I</span> <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="bound">h'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">j</span> <span class="free">h'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">-</span> <span class="free">i</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">h</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">effect_elims</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> Suc <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">≤</span> <span class="free">j</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹Suc <span class="skolem">k</span> <span class="main">=</span> <span class="free">j</span> <span class="main">-</span> <span class="skolem">i</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="free">j</span> <span class="main">-</span> Suc <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span> <span class="main">≤</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">i</span> <span class="main">..&lt;</span> <span class="free">j</span><span class="main">]</span> <span class="main">=</span> <span class="skolem">i</span> <span class="main">#</span> <span class="main">[</span>Suc <span class="skolem">i</span> <span class="main">..&lt;</span> <span class="free">j</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> upt_rec<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹effect <span class="main">(</span>for <span class="main">[</span><span class="skolem">i</span> <span class="main">..&lt;</span> <span class="free">j</span><span class="main">]</span> <span class="free">f</span><span class="main">)</span> <span class="skolem">h</span> <span class="free">h'</span> <span class="free">u</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">h''</span></span> <span class="skolem"><span class="skolem">r</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"effect <span class="main">(</span><span class="free">f</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">h</span> <span class="skolem">h''</span> <span class="skolem">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"effect <span class="main">(</span>for <span class="main">[</span>Suc <span class="skolem">i</span> <span class="main">..&lt;</span> <span class="free">j</span><span class="main">]</span> <span class="free">f</span><span class="main">)</span> <span class="skolem">h''</span> <span class="free">h'</span> <span class="free">u</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">effect_elims</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Suc<span class="main">(</span>6<span class="main">)</span> <span class="main">[</span><span class="operator">OF</span> _ _ <span class="quoted"><span class="quoted">‹<span class="free">I</span> <span class="skolem">i</span> <span class="skolem">h</span>›</span></span> *<span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">j</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="skolem">h''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Suc<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">=</span> <span class="free">j</span> <span class="main">-</span> Suc <span class="skolem">i</span>›</span></span> <span class="quoted"><span class="quoted">‹Suc <span class="skolem">i</span> <span class="main">≤</span> <span class="free">j</span>›</span></span> ** <span class="quoted"><span class="quoted">‹<span class="free">I</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="skolem">h''</span>›</span></span> Suc<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A rule for proving total correctness of for loops.›</span></span>
<span class="keyword1" id="Imperative_Loops-for_induct"><span class="command">lemma</span></span> for_induct <span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> succeed base step<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span> <span class="bound">h</span><span class="main">.</span> <span class="free">I</span> <span class="bound">k</span> <span class="bound">h</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">≤</span> <span class="bound">k</span> <span class="main">⟹</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">⟹</span> success <span class="main">(</span><span class="free">f</span> <span class="bound">k</span><span class="main">)</span> <span class="bound">h</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">i</span> <span class="free">h</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span> <span class="bound">h</span> <span class="bound">h'</span> <span class="bound">r</span><span class="main">.</span> <span class="free">I</span> <span class="bound">k</span> <span class="bound">h</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">≤</span> <span class="bound">k</span> <span class="main">⟹</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">⟹</span> effect <span class="main">(</span><span class="free">f</span> <span class="bound">k</span><span class="main">)</span> <span class="bound">h</span> <span class="bound">h'</span> <span class="bound">r</span> <span class="main">⟹</span> <span class="free">I</span> <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="bound">h'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">h'</span><span class="main">.</span> effect <span class="main">(</span>for <span class="main">[</span><span class="free">i</span> <span class="main">..&lt;</span> <span class="free">j</span><span class="main">]</span> <span class="free">f</span><span class="main">)</span> <span class="free">h</span> <span class="bound">h'</span> <span class="main">()</span> <span class="main">∧</span> <span class="free">I</span> <span class="free">j</span> <span class="bound">h'</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">i</span> <span class="free">h</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">-</span> <span class="free">i</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">h</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> effect_def <span class="dynamic"><span class="dynamic">execute_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> Suc <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≠</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">≤</span> <span class="free">j</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹Suc <span class="skolem">k</span> <span class="main">=</span> <span class="free">j</span> <span class="main">-</span> <span class="skolem">i</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="free">j</span> <span class="main">-</span> Suc <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span> <span class="main">≤</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">i</span> <span class="main">..&lt;</span> <span class="free">j</span><span class="main">]</span> <span class="main">=</span> <span class="skolem">i</span> <span class="main">#</span> <span class="main">[</span>Suc <span class="skolem">i</span> <span class="main">..&lt;</span> <span class="free">j</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> upt_rec<span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">h'</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"effect <span class="main">(</span><span class="free">f</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">h</span> <span class="skolem">h'</span> <span class="skolem">r</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>4<span class="main">)</span> <span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">I</span> <span class="skolem">i</span> <span class="skolem">h</span>›</span></span> le_refl <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">j</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> success_effectE<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="skolem">h'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="skolem">h'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Suc<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">=</span> <span class="free">j</span> <span class="main">-</span> Suc <span class="skolem">i</span>›</span></span> <span class="quoted"><span class="quoted">‹Suc <span class="skolem">i</span> <span class="main">≤</span> <span class="free">j</span>›</span></span> Suc<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="free">I</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="skolem">h'</span>›</span></span> Suc<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> effect_def <span class="dynamic"><span class="dynamic">execute_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A rule for proving termination of for loops.›</span></span>
<span class="keyword1"><span class="command">lemmas</span></span>
  success_for_induct <span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> succeed base step<span class="main">]</span> <span class="main">=</span>
    for_induct <span class="main">[</span><span class="operator">unfolded</span> effect_success_conv<span class="main">,</span> <span class="operator">THEN</span> conjunct1<span class="main">]</span>

<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div><div id="Imperative_Insertion_Sort">
<div class="head">
<h1>Theory Imperative_Insertion_Sort</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      Imperative_Insertion_Sort
    Author:     Christian Sternagel
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Insertion Sort›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Imperative_Insertion_Sort
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="#Imperative_Loops">Imperative_Loops</a>
  <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Multiset.html">HOL-Library.Multiset</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The Algorithm›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">array_update</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>heap array <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> array Heap"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span>_<span class="keyword1">.'(</span>_<span class="keyword1">')</span> <span class="keyword1">←</span><span class="keyword3">/ </span>_<span class="keyword3">)</span>"</span> <span class="main">[</span>1000<span class="main">,</span> 0<span class="main">,</span> 13<span class="main">]</span> 14<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main"><span class="free">.(</span></span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main"><span class="free">)</span></span> <span class="main"><span class="free">←</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> Array.upd <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">array_nth</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>heap array <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> Heap"</span></span> <span class="main">(</span><span class="quoted">"_<span class="keyword1">.'(</span>_<span class="keyword1">')</span>"</span> <span class="main">[</span>1000<span class="main">,</span> 0<span class="main">]</span> 14<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main"><span class="free">.(</span></span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main"><span class="free">)</span></span> <span class="main">≡</span> Array.nth <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  A definition of insertion sort as given by Cormen et al.\ in \emph{Introduction to Algorithms}.
  Compared to the informal textbook version the variant below is a bit unwieldy due to explicit
  dereferencing of variables on the heap.

  To avoid ambiguities with existing syntax we use OCaml's notation for accessing (<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">a</span></span><span class="main"><span class="main">.(</span></span><span class="free"><span class="free">i</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>)
  and updating (<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">a</span></span><span class="main"><span class="main">.(</span></span><span class="free"><span class="free">i</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">←</span></span> <span class="free"><span class="free">x</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>) an array <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">a</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> at position <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">i</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">insertion_sort</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">l</span> <span class="main">←</span> Array.len <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">;</span>
    for <span class="main">[</span><span class="main">1</span> <span class="main">..&lt;</span> <span class="bound">l</span><span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="comment1">― ‹Insert <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>a[j]›</span></span> into the sorted subarray <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>a[1 .. j - 1].›</span></span>›</span>
      <span class="bound">key</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">.(</span><span class="bound">j</span><span class="main">)</span><span class="main">;</span>
      <span class="bound">i</span> <span class="main">←</span> ref <span class="bound">j</span><span class="main">;</span>
      while <span class="main">(</span><span class="keyword1">do</span> <span class="main">{</span>
        <span class="bound">i'</span> <span class="main">←</span> <span class="main">!</span> <span class="bound">i</span><span class="main">;</span>
        <span class="keyword1">if</span> <span class="bound">i'</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span><span class="bound">x</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">.(</span><span class="bound">i'</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">;</span> return <span class="main">(</span><span class="bound">x</span> <span class="main">&gt;</span> <span class="bound">key</span><span class="main">)</span><span class="main">}</span>
        <span class="keyword1">else</span> return False<span class="main">}</span><span class="main">)</span>
      <span class="main">(</span><span class="keyword1">do</span> <span class="main">{</span>
        <span class="bound">i'</span> <span class="main">←</span> <span class="main">!</span> <span class="bound">i</span><span class="main">;</span>
        <span class="bound">x</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">.(</span><span class="bound">i'</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">;</span>
        <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">.(</span><span class="bound">i'</span><span class="main">)</span> <span class="main">←</span> <span class="bound">x</span><span class="main">;</span>
        <span class="bound">i</span> <span class="main">:=</span> <span class="bound">i'</span> <span class="main">-</span> <span class="main">1</span>
      <span class="main">}</span><span class="main">)</span><span class="main">;</span>
      <span class="bound">i'</span> <span class="main">←</span> <span class="main">!</span> <span class="bound">i</span><span class="main">;</span>
      <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">.(</span><span class="bound">i'</span><span class="main">)</span> <span class="main">←</span> <span class="bound">key</span>
    <span class="main">}</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following definitions decompose the nested loops of the algorithm into more manageable chunks.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">shiftr_p</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">key</span></span></span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>heap<span class="main">,</span> linorder<span class="main">}</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">do</span> <span class="main">{</span><span class="bound">i'</span> <span class="main">←</span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">;</span> <span class="keyword1">if</span> <span class="bound">i'</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span><span class="bound">x</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">.(</span><span class="bound">i'</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">;</span> return <span class="main">(</span><span class="bound">x</span> <span class="main">&gt;</span> <span class="free"><span class="bound"><span class="entity">key</span></span></span><span class="main">)</span><span class="main">}</span> <span class="keyword1">else</span> return False<span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">shiftr_f</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
  <span class="bound">i'</span> <span class="main">←</span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">;</span>
  <span class="bound">x</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">.(</span><span class="bound">i'</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">;</span>
  <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">.(</span><span class="bound">i'</span><span class="main">)</span> <span class="main">←</span> <span class="bound">x</span><span class="main">;</span>
  <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">:=</span> <span class="bound">i'</span> <span class="main">-</span> <span class="main">1</span>
<span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">shiftr</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> while <span class="main">(</span>shiftr_p <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">(</span>shiftr_f <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">insert_elt</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
  <span class="bound">key</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">.(</span><span class="bound">j</span><span class="main">)</span><span class="main">;</span>
  <span class="bound">i</span> <span class="main">←</span> ref <span class="bound">j</span><span class="main">;</span>
  shiftr <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">key</span> <span class="bound">i</span><span class="main">;</span>
  <span class="bound">i'</span> <span class="main">←</span> <span class="main">!</span> <span class="bound">i</span><span class="main">;</span>
  <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">.(</span><span class="bound">i'</span><span class="main">)</span> <span class="main">←</span> <span class="bound">key</span>
<span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">sort_upto</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">l</span><span class="main">.</span> for <span class="main">[</span><span class="main">1</span> <span class="main">..&lt;</span> <span class="bound">l</span><span class="main">]</span> <span class="main">(</span>insert_elt <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Imperative_Insertion_Sort-insertion_sort_alt_def"><span class="command">lemma</span></span> insertion_sort_alt_def<span class="main">:</span>
  <span class="quoted"><span class="quoted">"insertion_sort <span class="free">a</span> <span class="main">=</span> <span class="main">(</span>Array.len <span class="free">a</span> <span class="main">⤜</span> sort_upto <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insertion_sort_def sort_upto_def shiftr_def shiftr_p_def shiftr_f_def insert_elt_def<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Partial Correctness›</span></span>

<span class="keyword1" id="Imperative_Insertion_Sort-effect_shiftr_f"><span class="command">lemma</span></span> effect_shiftr_f<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"effect <span class="main">(</span>shiftr_f <span class="free">a</span> <span class="free">i</span><span class="main">)</span> <span class="free">h</span> <span class="free">h'</span> <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Ref.get <span class="free">h'</span> <span class="free">i</span> <span class="main">=</span> Ref.get <span class="free">h</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span> <span class="main">∧</span>
    Array.get <span class="free">h'</span> <span class="free">a</span> <span class="main">=</span> list_update <span class="main">(</span>Array.get <span class="free">h</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span>Ref.get <span class="free">h</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span>Array.get <span class="free">h</span> <span class="free">a</span> <span class="main">!</span> <span class="main">(</span>Ref.get <span class="free">h</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> shiftr_f_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">effect_elims</span></span><span class="main">)</span>

<span class="keyword1" id="Imperative_Insertion_Sort-success_shiftr_p"><span class="command">lemma</span></span> success_shiftr_p<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Ref.get <span class="free">h</span> <span class="free">i</span> <span class="main">&lt;</span> Array.length <span class="free">h</span> <span class="free">a</span> <span class="main">⟹</span> success <span class="main">(</span>shiftr_p <span class="free">a</span> <span class="free">key</span> <span class="free">i</span><span class="main">)</span> <span class="free">h</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> success_def shiftr_p_def <span class="dynamic"><span class="dynamic">execute_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> ro_shiftr_p<span class="main">:</span> ro_cond <span class="quoted"><span class="quoted">"shiftr_p <span class="free">a</span> <span class="free">key</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">a</span> <span class="free">key</span> <span class="free">i</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> shiftr_p_def success_def <span class="dynamic"><span class="dynamic">execute_simps</span></span> execute_bind_case <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> effectI effect_nthE<span class="main">)</span>

<span class="comment1">(*[0 .. j - 1]*)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ini</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> take <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">(</span>Array.get <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>"</span></span>
<span class="comment1">(*[0 .. i - 1]*)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">left</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> take <span class="main">(</span>Ref.get <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">(</span>Array.get <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>"</span></span>
<span class="comment1">(*[i+1 .. j]*)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">right</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> take <span class="main">(</span><span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">-</span> Ref.get <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span>Ref.get <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>Array.get <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="comment1">(*[0 .. i - 1, i + 1 .. j]*)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">both</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> left <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">@</span> right <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span>"</span></span>

<span class="keyword1" id="Imperative_Insertion_Sort-effect_shiftr"><span class="command">lemma</span></span> effect_shiftr<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Ref.get <span class="free">h</span> <span class="free">i</span> <span class="main">=</span> <span class="free">j</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?i</span> <span class="free">h</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> Array.length <span class="free">h</span> <span class="free">a</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>take <span class="free">j</span> <span class="main">(</span>Array.get <span class="free">h</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"effect <span class="main">(</span>while <span class="main">(</span>shiftr_p <span class="free">a</span> <span class="free">key</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span>shiftr_f <span class="free">a</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="free">h</span> <span class="free">h'</span> <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Array.length <span class="free">h</span> <span class="free">a</span> <span class="main">=</span> Array.length <span class="free">h'</span> <span class="free">a</span> <span class="main">∧</span>
    <span class="var">?i</span> <span class="free">h'</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">∧</span>
    mset <span class="main">(</span>list_update <span class="main">(</span>Array.get <span class="free">h</span> <span class="free">a</span><span class="main">)</span> <span class="free">j</span> <span class="free">key</span><span class="main">)</span> <span class="main">=</span>
      mset <span class="main">(</span>list_update <span class="main">(</span>Array.get <span class="free">h'</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span><span class="var">?i</span> <span class="free">h'</span><span class="main">)</span> <span class="free">key</span><span class="main">)</span> <span class="main">∧</span>
    ini <span class="free">h</span> <span class="free">a</span> <span class="free">j</span> <span class="main">=</span> both <span class="free">h'</span> <span class="free">a</span> <span class="free">j</span> <span class="free">i</span> <span class="main">∧</span>
    sorted <span class="main">(</span>both <span class="free">h'</span> <span class="free">a</span> <span class="free">j</span> <span class="free">i</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>right <span class="free">h'</span> <span class="free">a</span> <span class="free">j</span> <span class="free">i</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="free">key</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">,</span> 2<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ro_shiftr_p.effect_while_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> base
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">h'</span> <span class="skolem">h''</span> <span class="skolem">u</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹success <span class="main">(</span>shiftr_p <span class="free">a</span> <span class="free">key</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">h'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹cond <span class="main">(</span>shiftr_p <span class="free">a</span> <span class="free">key</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">h'</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?i</span> <span class="skolem">h'</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    key<span class="main">:</span> <span class="quoted"><span class="quoted">"Array.get <span class="skolem">h'</span> <span class="free">a</span> <span class="main">!</span> <span class="main">(</span><span class="var">?i</span> <span class="skolem">h'</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">&gt;</span> <span class="free">key</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ro_shiftr_p.success_cond_effect<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> shiftr_p_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">effect_elims</span></span> effect_ifE<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> effect_shiftr_f <span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹effect <span class="main">(</span>shiftr_f <span class="free">a</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">h'</span> <span class="skolem">h''</span> <span class="skolem">u</span>›</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?i</span> <span class="skolem">h''</span> <span class="main">=</span> <span class="var">?i</span> <span class="skolem">h'</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
    <span class="quoted"><span class="quoted">"Array.get <span class="skolem">h''</span> <span class="free">a</span> <span class="main">=</span> list_update <span class="main">(</span>Array.get <span class="skolem">h'</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span><span class="var">?i</span> <span class="skolem">h'</span><span class="main">)</span> <span class="main">(</span>Array.get <span class="skolem">h'</span> <span class="free">a</span> <span class="main">!</span> <span class="main">(</span><span class="var">?i</span> <span class="skolem">h'</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> step <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?i</span> <span class="skolem">h'</span> <span class="main">&lt;</span> length <span class="main">(</span>Array.get <span class="skolem">h'</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?i</span> <span class="skolem">h'</span> <span class="main">-</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">≤</span> <span class="var">?i</span> <span class="skolem">h'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?i</span> <span class="skolem">h'</span> <span class="main">≤</span> length <span class="main">(</span>Array.get <span class="skolem">h'</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?i</span> <span class="skolem">h'</span> <span class="main">≤</span> <span class="free">j</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?i</span> <span class="skolem">h'</span> <span class="main">&lt;</span> Suc <span class="free">j</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"ini <span class="free">h</span> <span class="free">a</span> <span class="free">j</span> <span class="main">=</span> both <span class="skolem">h'</span> <span class="free">a</span> <span class="free">j</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Array.length_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Array.length <span class="free">h</span> <span class="free">a</span> <span class="main">=</span> Array.length <span class="skolem">h''</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> step <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Array.length_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?i</span> <span class="skolem">h''</span> <span class="main">≤</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> step <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mset <span class="main">(</span>list_update <span class="main">(</span>Array.get <span class="free">h</span> <span class="free">a</span><span class="main">)</span> <span class="free">j</span> <span class="free">key</span><span class="main">)</span> <span class="main">=</span>
    mset <span class="main">(</span>list_update <span class="main">(</span>Array.get <span class="skolem">h''</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span><span class="var">?i</span> <span class="skolem">h''</span><span class="main">)</span> <span class="free">key</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?i</span> <span class="skolem">h'</span> <span class="main">&lt;</span> length <span class="main">(</span>Array.get <span class="skolem">h'</span> <span class="free">a</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?i</span> <span class="skolem">h'</span> <span class="main">-</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="main">(</span>Array.get <span class="skolem">h'</span> <span class="free">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> step <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mset_update <span class="dynamic"><span class="dynamic">ac_simps</span></span> nth_list_update<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ini <span class="free">h</span> <span class="free">a</span> <span class="free">j</span> <span class="main">=</span> both <span class="skolem">h''</span> <span class="free">a</span> <span class="free">j</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="var">?i</span> <span class="skolem">h'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?i</span> <span class="skolem">h'</span> <span class="main">≤</span> <span class="free">j</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?i</span> <span class="skolem">h'</span> <span class="main">&lt;</span> length <span class="main">(</span>Array.get <span class="skolem">h'</span> <span class="free">a</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> ** <span class="keyword2"><span class="keyword">and</span></span> IH
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> upd_conv_take_nth_drop Suc_diff_le min_absorb1<span class="main">)</span>
       <span class="main">(</span><span class="operator">metis</span> Suc_lessD Suc_pred take_Suc_conv_app_nth<span class="main">)</span>

  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>both <span class="skolem">h''</span> <span class="free">a</span> <span class="free">j</span> <span class="free">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> step <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="var">?i</span> <span class="skolem">h'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?i</span> <span class="skolem">h'</span> <span class="main">≤</span> <span class="free">j</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?i</span> <span class="skolem">h'</span> <span class="main">&lt;</span> length <span class="main">(</span>Array.get <span class="skolem">h'</span> <span class="free">a</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> **
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> IH upd_conv_take_nth_drop Suc_diff_le min_absorb1<span class="main">)</span>
       <span class="main">(</span><span class="operator">metis</span> Suc_lessD Suc_pred append.simps append_assoc take_Suc_conv_app_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>right <span class="skolem">h''</span> <span class="free">a</span> <span class="free">j</span> <span class="free">i</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="free">key</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> step <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="var">?i</span> <span class="skolem">h'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?i</span> <span class="skolem">h'</span> <span class="main">&lt;</span> length <span class="main">(</span>Array.get <span class="skolem">h'</span> <span class="free">a</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> key
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> upd_conv_take_nth_drop Suc_diff_le<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Imperative_Insertion_Sort-sorted_take_nth"><span class="command">lemma</span></span> sorted_take_nth<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">!</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">≤</span> <span class="free">y</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>take <span class="free">i</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>take <span class="free">i</span> <span class="free">xs</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="free">i</span> <span class="free">xs</span> <span class="main">=</span> take <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">xs</span> <span class="main">!</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="free">i</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_diff_1 less_imp_diff_less take_Suc_conv_app_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹sorted <span class="main">(</span>take <span class="free">i</span> <span class="free">xs</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">xs</span> <span class="main">!</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">≤</span><span class="free">y</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sorted_append<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Imperative_Insertion_Sort-effect_for_insert_elt"><span class="command">lemma</span></span> effect_for_insert_elt<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≤</span> Array.length <span class="free">h</span> <span class="free">a</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> <span class="free">l</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"effect <span class="main">(</span>for <span class="main">[</span><span class="main">1</span> <span class="main">..&lt;</span> <span class="free">l</span><span class="main">]</span> <span class="main">(</span>insert_elt <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="free">h</span> <span class="free">h'</span> <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Array.length <span class="free">h</span> <span class="free">a</span> <span class="main">=</span> Array.length <span class="free">h'</span> <span class="free">a</span> <span class="main">∧</span>
    sorted <span class="main">(</span>take <span class="free">l</span> <span class="main">(</span>Array.get <span class="free">h'</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    mset <span class="main">(</span>Array.get <span class="free">h</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> mset <span class="main">(</span>Array.get <span class="free">h'</span> <span class="free">a</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2-<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">h'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> effect_for_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> base
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"Array.get <span class="free">h</span> <span class="free">a</span>"</span></span><span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">j</span> <span class="skolem">h'</span> <span class="skolem">h''</span> <span class="skolem">u</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> Array.length <span class="skolem">h'</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> step <span class="keyword1"><span class="command">have</span></span> sorted<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>take <span class="skolem">j</span> <span class="main">(</span>Array.get <span class="skolem">h'</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> step<span class="main">(</span>3<span class="main">)</span> <span class="main">[</span><span class="operator">unfolded</span> insert_elt_def<span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">key</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">h<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">h<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">i'</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> key<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">key</span> <span class="main">=</span> Array.get <span class="skolem">h'</span> <span class="free">a</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"effect <span class="main">(</span>ref <span class="skolem">j</span><span class="main">)</span> <span class="skolem">h'</span> <span class="skolem">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">i</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> ref<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"Ref.get <span class="skolem">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> shiftr'<span class="main">:</span> <span class="quoted"><span class="quoted">"effect <span class="main">(</span>shiftr <span class="free">a</span> <span class="skolem">key</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">h<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">()</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Ref.get <span class="skolem">h<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">i'</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h''</span> <span class="main">=</span> Array.update <span class="free">a</span> <span class="skolem">i'</span> <span class="skolem">key</span> <span class="skolem">h<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">&lt;</span> Array.length <span class="skolem">h<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">a</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> effect_bindE effect_nthE effect_lookupE effect_updE<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">effect_intros</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> effect_refE<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹effect <span class="main">(</span>ref <span class="skolem">j</span><span class="main">)</span> <span class="skolem">h'</span> <span class="skolem">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">i</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Array.get <span class="skolem">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">a</span> <span class="main">=</span> Array.get <span class="skolem">h'</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> array_get_alloc effectE execute_ref option.sel<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Array.length <span class="skolem">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">a</span> <span class="main">=</span> Array.length <span class="skolem">h'</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Array.length_def<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> step <span class="keyword2"><span class="keyword">and</span></span> assms<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> Array.length <span class="skolem">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>take <span class="skolem">j</span> <span class="main">(</span>Array.get <span class="skolem">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> shiftr <span class="main">=</span> effect_shiftr <span class="main">[</span><span class="operator">OF</span> ref<span class="hidden">⇩</span><sub>1</sub> this shiftr' <span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> shiftr_def<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">≤</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> shiftr <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">&lt;</span> length <span class="main">(</span>Array.get <span class="skolem">h<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">&lt;</span> Array.length <span class="skolem">h<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">a</span>›</span></span> length_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"min <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> <span class="skolem">i'</span> <span class="main">=</span> <span class="skolem">i'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">≤</span> <span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"min <span class="main">(</span>length <span class="main">(</span>Array.get <span class="skolem">h<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="skolem">i'</span> <span class="main">=</span> <span class="skolem">i'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">&lt;</span> length <span class="main">(</span>Array.get <span class="skolem">h<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">a</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> take_Suc_j<span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> <span class="main">(</span>list_update <span class="main">(</span>Array.get <span class="skolem">h<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">a</span><span class="main">)</span> <span class="skolem">i'</span> <span class="skolem">key</span><span class="main">)</span> <span class="main">=</span>
    take <span class="skolem">i'</span> <span class="main">(</span>Array.get <span class="skolem">h<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">a</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">key</span> <span class="main">#</span> take <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="skolem">i'</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span>Suc <span class="skolem">i'</span><span class="main">)</span> <span class="main">(</span>Array.get <span class="skolem">h<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> upd_conv_take_nth_drop <span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">&lt;</span> length <span class="main">(</span>Array.get <span class="skolem">h<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">a</span><span class="main">)</span>›</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> Suc_diff_le <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">≤</span> <span class="skolem">j</span>›</span></span> take_Suc_Cons<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Array.length <span class="free">h</span> <span class="free">a</span> <span class="main">=</span> Array.length <span class="skolem">h''</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> shiftr <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> step.IH<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mset <span class="main">(</span>Array.get <span class="free">h</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> mset <span class="main">(</span>Array.get <span class="skolem">h''</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> shiftr <span class="keyword2"><span class="keyword">and</span></span> step <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> key<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>take <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> <span class="main">(</span>Array.get <span class="skolem">h''</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> ro_shiftr_p.effect_while_post <span class="main">[</span><span class="operator">OF</span> shiftr' <span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> shiftr_def<span class="main"><span class="main">]</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="main">(</span><span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">i'</span> <span class="main">∧</span> <span class="skolem">key</span> <span class="main">≥</span> Array.get <span class="skolem">h<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">a</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">i'</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ro_shiftr_p.success_not_cond_effect<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">effect_elims</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> shiftr_p_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> <span class="main">(</span>list_update <span class="main">(</span>Array.get <span class="skolem">h<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">a</span><span class="main">)</span> <span class="main">0</span> <span class="skolem">key</span><span class="main">)</span> <span class="main">=</span>
        <span class="skolem">key</span> <span class="main">#</span> take <span class="skolem">j</span> <span class="main">(</span>drop <span class="main">1</span> <span class="main">(</span>Array.get <span class="skolem">h<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">=</span> <span class="main">0</span>›</span></span> append_Nil take_Suc_j diff_zero take_0<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> sorted <span class="keyword2"><span class="keyword">and</span></span> shiftr
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>take <span class="skolem">j</span> <span class="main">(</span>drop <span class="main">1</span> <span class="main">(</span>Array.get <span class="skolem">h<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>take <span class="skolem">j</span> <span class="main">(</span>drop <span class="main">1</span> <span class="main">(</span>Array.get <span class="skolem">h<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="skolem">key</span> <span class="main">&lt;</span> <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span><span class="skolem">key</span> <span class="main">#</span> take <span class="skolem">j</span> <span class="main">(</span>drop <span class="main">1</span> <span class="main">(</span>Array.get <span class="skolem">h<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> less_imp_le sorted.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> *<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">i'</span> <span class="main">∧</span> <span class="skolem">key</span> <span class="main">≥</span> Array.get <span class="skolem">h<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">a</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">i'</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>take <span class="skolem">i'</span> <span class="main">(</span>Array.get <span class="skolem">h<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">a</span><span class="main">)</span> <span class="main">@</span> take <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="skolem">i'</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span>Suc <span class="skolem">i'</span><span class="main">)</span> <span class="main">(</span>Array.get <span class="skolem">h<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>take <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="skolem">i'</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span>Suc <span class="skolem">i'</span><span class="main">)</span> <span class="main">(</span>Array.get <span class="skolem">h<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="skolem">key</span> <span class="main">&lt;</span> <span class="bound">x</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> shiftr <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>take <span class="skolem">i'</span> <span class="main">(</span>Array.get <span class="skolem">h<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">a</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≤</span> <span class="skolem">key</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> sorted_take_nth <span class="main">[</span><span class="operator">OF</span> _ <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">&lt;</span> length <span class="main">(</span>Array.get <span class="skolem">h<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">a</span><span class="main">)</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">key</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_append<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> shiftr <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> take_Suc_j sorted_append less_imp_le<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Imperative_Insertion_Sort-effect_insertion_sort"><span class="command">lemma</span></span> effect_insertion_sort<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"effect <span class="main">(</span>insertion_sort <span class="free">a</span><span class="main">)</span> <span class="free">h</span> <span class="free">h'</span> <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mset <span class="main">(</span>Array.get <span class="free">h</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> mset <span class="main">(</span>Array.get <span class="free">h'</span> <span class="free">a</span><span class="main">)</span> <span class="main">∧</span> sorted <span class="main">(</span>Array.get <span class="free">h'</span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"Array.length <span class="free">h</span> <span class="free">a</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">effect_elims</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> insertion_sort_def Array.length_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> insertion_sort_def
  <span class="keyword1"><span class="command">unfolding</span></span> shiftr_p_def <span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> shiftr_f_def <span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> shiftr_def <span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> insert_elt_def <span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> <span class="dynamic"><span class="dynamic">effect_elims</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"Suc <span class="improper">nat</span> <span class="main">≤</span> Array.length <span class="free">h</span> <span class="free">a</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> effect_for_insert_elt<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Array.length_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Total Correctness›</span></span>

<span class="keyword1" id="Imperative_Insertion_Sort-success_shiftr_f"><span class="command">lemma</span></span> success_shiftr_f<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Ref.get <span class="free">h</span> <span class="free">i</span> <span class="main">&lt;</span> Array.length <span class="free">h</span> <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"success <span class="main">(</span>shiftr_f <span class="free">a</span> <span class="free">i</span><span class="main">)</span> <span class="free">h</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> success_def shiftr_f_def <span class="dynamic"><span class="dynamic">execute_simps</span></span><span class="main">)</span>

<span class="keyword1" id="Imperative_Insertion_Sort-success_shiftr"><span class="command">lemma</span></span> success_shiftr<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Ref.get <span class="free">h</span> <span class="free">i</span> <span class="main">&lt;</span> Array.length <span class="free">h</span> <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"success <span class="main">(</span>while <span class="main">(</span>shiftr_p <span class="free">a</span> <span class="free">key</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span>shiftr_f <span class="free">a</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="free">h</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf <span class="main">(</span>measure <span class="main">(</span><span class="main">λ</span><span class="bound">h</span><span class="main">.</span> Ref.get <span class="bound">h</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> wf_measure<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">taking</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">h</span><span class="main">.</span> Ref.get <span class="bound">h</span> <span class="free">i</span> <span class="main">&lt;</span> Array.length <span class="bound">h</span> <span class="free">a</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ro_shiftr_p.success_while_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>success_cond <span class="skolem">h</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> success_shiftr_p<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>success_body <span class="skolem">h</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> success_shiftr_f<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">h</span> <span class="skolem">h'</span> <span class="skolem">r</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> effect_shiftr_f ro_shiftr_p.success_cond_effect <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> length_def<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> shiftr_p_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">effect_elims</span></span> effect_ifE<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">fact</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Imperative_Insertion_Sort-effect_shiftr_index"><span class="command">lemma</span></span> effect_shiftr_index<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"effect <span class="main">(</span>shiftr <span class="free">a</span> <span class="free">key</span> <span class="free">i</span><span class="main">)</span> <span class="free">h</span> <span class="free">h'</span> <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Ref.get <span class="free">h'</span> <span class="free">i</span> <span class="main">≤</span> Ref.get <span class="free">h</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> shiftr_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">h'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ro_shiftr_p.effect_while_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> effect_shiftr_f<span class="main">)</span>

<span class="keyword1" id="Imperative_Insertion_Sort-effect_shiftr_length"><span class="command">lemma</span></span> effect_shiftr_length<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"effect <span class="main">(</span>shiftr <span class="free">a</span> <span class="free">key</span> <span class="free">i</span><span class="main">)</span> <span class="free">h</span> <span class="free">h'</span> <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Array.length <span class="free">h'</span> <span class="free">a</span> <span class="main">=</span> Array.length <span class="free">h</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> shiftr_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">h'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ro_shiftr_p.effect_while_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> length_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> effect_shiftr_f<span class="main">)</span>

<span class="keyword1" id="Imperative_Insertion_Sort-success_insert_elt"><span class="command">lemma</span></span> success_insert_elt<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> Array.length <span class="free">h</span> <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"success <span class="main">(</span>insert_elt <span class="free">a</span> <span class="free">k</span><span class="main">)</span> <span class="free">h</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">key</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"effect <span class="main">(</span><span class="free">a</span><span class="main">.(</span><span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="free">h</span> <span class="free">h</span> <span class="skolem">key</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">effect_intros</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">h<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"effect <span class="main">(</span>ref <span class="free">k</span><span class="main">)</span> <span class="free">h</span> <span class="skolem">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">i</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Ref.get <span class="skolem">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">i</span> <span class="main">=</span> <span class="free">k</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Array.length <span class="skolem">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">a</span> <span class="main">=</span> Array.length <span class="free">h</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ref_def length_def<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> Ref.get_alloc array_get_alloc effect_heapI<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">h<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"effect <span class="main">(</span>shiftr <span class="free">a</span> <span class="skolem">key</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">h<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">()</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> success_shiftr <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">h<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="skolem">key</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> success_def effect_def shiftr_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"effect <span class="main">(</span><span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">h<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">h<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span>Ref.get <span class="skolem">h<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Ref.get <span class="skolem">h<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">i</span> <span class="main">≤</span> Ref.get <span class="skolem">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">i</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Ref.get <span class="skolem">h<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">i</span> <span class="main">&lt;</span> Array.length <span class="skolem">h<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> effect_shiftr_index <span class="main">[</span><span class="operator">OF</span> *<span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> effect_shiftr_length <span class="main">[</span><span class="operator">OF</span> *<span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">effect_intros</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">h<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"effect <span class="main">(</span><span class="free">a</span><span class="main">.(</span>Ref.get <span class="skolem">h<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">i</span><span class="main">)</span> <span class="main">←</span> <span class="skolem">key</span><span class="main">)</span> <span class="skolem">h<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">h<span class="hidden">⇩</span><sub>3</sub></span> <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> effect_def <span class="dynamic"><span class="dynamic">execute_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"effect <span class="main">(</span>insert_elt <span class="free">a</span> <span class="free">k</span><span class="main">)</span> <span class="free">h</span> <span class="skolem">h<span class="hidden">⇩</span><sub>3</sub></span> <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> insert_elt_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">effect_intros</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> effectE<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Imperative_Insertion_Sort-for_insert_elt_correct"><span class="command">lemma</span></span> for_insert_elt_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≤</span> Array.length <span class="free">h</span> <span class="free">a</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">h'</span><span class="main">.</span> effect <span class="main">(</span>for <span class="main">[</span><span class="main">1</span> <span class="main">..&lt;</span> <span class="free">l</span><span class="main">]</span> <span class="main">(</span>insert_elt <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="free">h</span> <span class="bound">h'</span> <span class="main">()</span> <span class="main">∧</span>
    Array.length <span class="free">h</span> <span class="free">a</span> <span class="main">=</span> Array.length <span class="bound">h'</span> <span class="free">a</span> <span class="main">∧</span>
    sorted <span class="main">(</span>take <span class="free">l</span> <span class="main">(</span>Array.get <span class="bound">h'</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    mset <span class="main">(</span>Array.get <span class="free">h</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> mset <span class="main">(</span>Array.get <span class="bound">h'</span> <span class="free">a</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> for_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>succeed <span class="skolem">k</span> <span class="skolem">h</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword2"><span class="keyword">and</span></span> success_insert_elt <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">k</span></span> <span class="quoted"><span class="skolem">h</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> base
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"Array.get <span class="free">h</span> <span class="free">a</span>"</span></span><span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">j</span> <span class="skolem">h'</span> <span class="skolem">h''</span> <span class="skolem">u</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> Array.length <span class="skolem">h'</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> step <span class="keyword1"><span class="command">have</span></span> sorted<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>take <span class="skolem">j</span> <span class="main">(</span>Array.get <span class="skolem">h'</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> step<span class="main">(</span>4<span class="main">)</span> <span class="main">[</span><span class="operator">unfolded</span> insert_elt_def<span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">key</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">h<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">h<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">i'</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> key<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">key</span> <span class="main">=</span> Array.get <span class="skolem">h'</span> <span class="free">a</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"effect <span class="main">(</span>ref <span class="skolem">j</span><span class="main">)</span> <span class="skolem">h'</span> <span class="skolem">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">i</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> ref<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"Ref.get <span class="skolem">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> shiftr'<span class="main">:</span> <span class="quoted"><span class="quoted">"effect <span class="main">(</span>shiftr <span class="free">a</span> <span class="skolem">key</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">h<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">()</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Ref.get <span class="skolem">h<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">i'</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h''</span> <span class="main">=</span> Array.update <span class="free">a</span> <span class="skolem">i'</span> <span class="skolem">key</span> <span class="skolem">h<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">&lt;</span> Array.length <span class="skolem">h<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">a</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> effect_bindE effect_nthE effect_lookupE effect_updE<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">effect_intros</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> effect_refE<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹effect <span class="main">(</span>ref <span class="skolem">j</span><span class="main">)</span> <span class="skolem">h'</span> <span class="skolem">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">i</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Array.get <span class="skolem">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">a</span> <span class="main">=</span> Array.get <span class="skolem">h'</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> array_get_alloc effectE execute_ref option.sel<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Array.length <span class="skolem">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">a</span> <span class="main">=</span> Array.length <span class="skolem">h'</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Array.length_def<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> step <span class="keyword2"><span class="keyword">and</span></span> assms<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> Array.length <span class="skolem">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>take <span class="skolem">j</span> <span class="main">(</span>Array.get <span class="skolem">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> shiftr <span class="main">=</span> effect_shiftr <span class="main">[</span><span class="operator">OF</span> ref<span class="hidden">⇩</span><sub>1</sub> this shiftr' <span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> shiftr_def<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">≤</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> shiftr <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">&lt;</span> length <span class="main">(</span>Array.get <span class="skolem">h<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">&lt;</span> Array.length <span class="skolem">h<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">a</span>›</span></span> length_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"min <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> <span class="skolem">i'</span> <span class="main">=</span> <span class="skolem">i'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">≤</span> <span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"min <span class="main">(</span>length <span class="main">(</span>Array.get <span class="skolem">h<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="skolem">i'</span> <span class="main">=</span> <span class="skolem">i'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">&lt;</span> length <span class="main">(</span>Array.get <span class="skolem">h<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">a</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> take_Suc_j<span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> <span class="main">(</span>list_update <span class="main">(</span>Array.get <span class="skolem">h<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">a</span><span class="main">)</span> <span class="skolem">i'</span> <span class="skolem">key</span><span class="main">)</span> <span class="main">=</span>
    take <span class="skolem">i'</span> <span class="main">(</span>Array.get <span class="skolem">h<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">a</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">key</span> <span class="main">#</span> take <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="skolem">i'</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span>Suc <span class="skolem">i'</span><span class="main">)</span> <span class="main">(</span>Array.get <span class="skolem">h<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> upd_conv_take_nth_drop <span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">&lt;</span> length <span class="main">(</span>Array.get <span class="skolem">h<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">a</span><span class="main">)</span>›</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> Suc_diff_le <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">≤</span> <span class="skolem">j</span>›</span></span> take_Suc_Cons<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Array.length <span class="free">h</span> <span class="free">a</span> <span class="main">=</span> Array.length <span class="skolem">h''</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> shiftr <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> step.hyps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mset <span class="main">(</span>Array.get <span class="free">h</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> mset <span class="main">(</span>Array.get <span class="skolem">h''</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> shiftr <span class="keyword2"><span class="keyword">and</span></span> step <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> key<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>take <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> <span class="main">(</span>Array.get <span class="skolem">h''</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> ro_shiftr_p.effect_while_post <span class="main">[</span><span class="operator">OF</span> shiftr' <span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> shiftr_def<span class="main"><span class="main">]</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="main">(</span><span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">i'</span> <span class="main">∧</span> <span class="skolem">key</span> <span class="main">≥</span> Array.get <span class="skolem">h<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">a</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">i'</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ro_shiftr_p.success_not_cond_effect<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">effect_elims</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> shiftr_p_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> <span class="main">(</span>list_update <span class="main">(</span>Array.get <span class="skolem">h<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">a</span><span class="main">)</span> <span class="main">0</span> <span class="skolem">key</span><span class="main">)</span> <span class="main">=</span>
        <span class="skolem">key</span> <span class="main">#</span> take <span class="skolem">j</span> <span class="main">(</span>drop <span class="main">1</span> <span class="main">(</span>Array.get <span class="skolem">h<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">=</span> <span class="main">0</span>›</span></span> append_Nil take_Suc_j diff_zero take_0<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> sorted <span class="keyword2"><span class="keyword">and</span></span> shiftr
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>take <span class="skolem">j</span> <span class="main">(</span>drop <span class="main">1</span> <span class="main">(</span>Array.get <span class="skolem">h<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>take <span class="skolem">j</span> <span class="main">(</span>drop <span class="main">1</span> <span class="main">(</span>Array.get <span class="skolem">h<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="skolem">key</span> <span class="main">&lt;</span> <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span><span class="skolem">key</span> <span class="main">#</span> take <span class="skolem">j</span> <span class="main">(</span>drop <span class="main">1</span> <span class="main">(</span>Array.get <span class="skolem">h<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> less_imp_le sorted.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> *<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">i'</span> <span class="main">∧</span> <span class="skolem">key</span> <span class="main">≥</span> Array.get <span class="skolem">h<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">a</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">i'</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>take <span class="skolem">i'</span> <span class="main">(</span>Array.get <span class="skolem">h<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">a</span><span class="main">)</span> <span class="main">@</span> take <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="skolem">i'</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span>Suc <span class="skolem">i'</span><span class="main">)</span> <span class="main">(</span>Array.get <span class="skolem">h<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>take <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="skolem">i'</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span>Suc <span class="skolem">i'</span><span class="main">)</span> <span class="main">(</span>Array.get <span class="skolem">h<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="skolem">key</span> <span class="main">&lt;</span> <span class="bound">x</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> shiftr <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>take <span class="skolem">i'</span> <span class="main">(</span>Array.get <span class="skolem">h<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">a</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≤</span> <span class="skolem">key</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> sorted_take_nth <span class="main">[</span><span class="operator">OF</span> _ <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">&lt;</span> length <span class="main">(</span>Array.get <span class="skolem">h<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">a</span><span class="main">)</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">key</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_append<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> shiftr <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> take_Suc_j sorted_append less_imp_le<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Imperative_Insertion_Sort-insertion_sort_correct"><span class="command">lemma</span></span> insertion_sort_correct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">h'</span><span class="main">.</span> effect <span class="main">(</span>insertion_sort <span class="free">a</span><span class="main">)</span> <span class="free">h</span> <span class="bound">h'</span> <span class="free">u</span> <span class="main">∧</span>
    mset <span class="main">(</span>Array.get <span class="free">h</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> mset <span class="main">(</span>Array.get <span class="bound">h'</span> <span class="free">a</span><span class="main">)</span> <span class="main">∧</span>
    sorted <span class="main">(</span>Array.get <span class="bound">h'</span> <span class="free">a</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"Array.length <span class="free">h</span> <span class="free">a</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Array.length <span class="free">h</span> <span class="free">a</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"effect <span class="main">(</span>insertion_sort <span class="free">a</span><span class="main">)</span> <span class="free">h</span> <span class="free">h</span> <span class="main">()</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"mset <span class="main">(</span>Array.get <span class="free">h</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> mset <span class="main">(</span>Array.get <span class="free">h</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>Array.get <span class="free">h</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> insertion_sort_def length_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">effect_intros</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Array.length <span class="free">h</span> <span class="free">a</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> Array.length <span class="free">h</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> for_insert_elt_correct <span class="main">[</span><span class="operator">OF</span> le_refl this<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> insertion_sort_alt_def sort_upto_def<span class="main">)</span>
       <span class="main">(</span><span class="operator">metis</span> One_nat_def effect_bindI effect_insertion_sort effect_lengthI insertion_sort_alt_def sort_upto_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">export_code</span></span> <span class="quoted"><span class="quoted">insertion_sort</span></span> <span class="keyword2"><span class="keyword">in</span></span> Haskell

<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div>